---
title: "02-ä»0.5å®ç°CURP"
date: 2024-06-03T09:31:59Z

---

## Intro

### ä»€ä¹ˆæ˜¯CURP

Curpæ˜¯ä¸€ç§æ–°çš„åˆ†å¸ƒå¼å…±è¯†ç®—æ³•ï¼Œcurpçš„æå‡ºæ˜¯é’ˆå¯¹äºè·¨åŸŸç­‰é«˜ç½‘ç»œå»¶è¿Ÿåœºæ™¯ï¼Œä¼ ç»Ÿçš„raftå’Œpaxosç­‰å…±è¯†ç®—æ³•éœ€è¦ä¸¤ä¸ªRTTï¼Œåœ¨é«˜ç½‘ç»œå»¶è¿Ÿçš„åœºæ™¯ä¸‹ï¼Œä¸¤ä¸ªRTTå¯¹ç³»ç»Ÿæ¥è¯´æ˜¯éš¾ä»¥å¿å—çš„ï¼Œç½‘ç»œé€šä¿¡ä¼šæˆä¸ºç³»ç»Ÿçš„ç“¶é¢ˆã€‚

ä¸ºäº†è§£å†³è¯¥é—®é¢˜ï¼ŒCURPæœŸæœ›åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œé€šè¿‡ä¸€ä¸ªRTTæ¥å®Œæˆï¼Œè¿™ä¸»è¦åŸºäºä¸¤ç‚¹èƒŒæ™¯ï¼š

- åœ¨è¯·æ±‚ä¸­ï¼Œå„ä¸ªè¯·æ±‚ä¹‹é—´é€šå¸¸æ˜¯äº’ä¸å†²çªçš„ï¼Œä¾‹å¦‚ set a =1 å’Œ set b = 2, å¯¹äºåŒä¸€ä¸ªkeyçš„é‡å¤æ€§è¯»å†™æ˜¯æ¯”è¾ƒå°‘è§çš„
- ç³»ç»Ÿå¹¶ä¸éœ€è¦å¯¹æ‰€æœ‰è¯·æ±‚å»ºç«‹ä¸€ä¸ªå…¨å±€çš„é¡ºåºï¼Œç›¸å¯¹çš„ï¼Œåªéœ€è¦å¯¹äºäº’ç›¸å†²çªçš„keyå»ºç«‹èµ·ä¸€ä¸ªå±€éƒ¨é¡ºåºå³å¯
å¦‚æœæƒ³è¿›ä¸€æ­¥äº†è§£CURPï¼Œæ¬¢è¿é˜…è¯»ç¬”è€…çš„å¦ä¸€ç¯‡æ–‡ç« ï¼š
[zhuanlan.zhihu.com/p/692464275](https://zhuanlan.zhihu.com/p/692464275)

### ä¸ºä»€ä¹ˆæ˜¯ä» 0.5 åˆ° 1

CURPæ˜¯éä¾µå…¥æ€§çš„ï¼Œå³curpåªæ˜¯åœ¨åŸæœ¬çš„å…±è¯†ç³»ç»Ÿçš„åŸºç¡€ä¸Šï¼Œæä¾›ä¸€å¥—é¢å¤–çš„é€»è¾‘ï¼Œæ¥åŠ é€ŸåŸæœ¬çš„å…±è¯†ç®—æ³•ï¼Œåœ¨curpåŸæ–‡ä¸­ï¼Œé€‰æ‹©çš„æ˜¯ä½¿ç”¨primary-backupæ¶æ„æ¥ä½œä¸ºåŸºç¡€ï¼Œè€Œåœ¨CURPä½œè€…åœ¨phDè®ºæ–‡ä¸­ï¼Œæ‰©å±•äº†CURPï¼Œæå‡ºäº†CURP-Qï¼Œå…¶æ„å»ºäºå¦‚Raftï¼ŒPaxosç­‰Leader-Followerå…±è¯†ç®—æ³•ä¸Šã€‚

è€Œetcd/raftæ˜¯ç›®å‰å·¥ä¸šç•Œæ¯”è¾ƒæˆç†Ÿçš„raftå®ç°ï¼Œå…¶å°†raftæŠ½è±¡æˆçŠ¶æ€æœºï¼Œéå¸¸åœ°ç®€å•æ˜“ç”¨ã€‚åŒæ—¶ï¼Œå…¶å®ç°äº†å¦‚check quorum, leader lease prevote æ‰¹å¤„ç†ï¼Œæµæ°´çº¿å‘é€äº†ç­‰ä¼˜åŒ–ï¼Œæ€§èƒ½æœ‰åŸºç¡€ä¿è¯ã€‚å› æ­¤ï¼Œåœ¨æœ¬æ–‡ä¸­ï¼Œç¬”è€…é€‰æ‹©äº†etcd/raftï¼Œå……å½“CURPçš„slow pathï¼Œå†æ¬¡åŸºç¡€ä¸Šï¼Œæ„å»ºäº†CURPã€‚


## CURP Server

ectd/raftä»¥åŠå¦‚ä½•ä¸raftäº¤äº’å·²ç»åœ¨ä¸Šä¸€ç« é˜è¿°ï¼Œå› æ­¤åœ¨è¿™é‡Œå°†é‡ç‚¹æ”¾åœ¨CURP Serverçš„çŠ¶æ€æœºä¸Šã€‚CURPçŠ¶æ€æœºçš„è®¾è®¡å‚è€ƒäº† 6.824 å’Œ Xlineã€‚çŠ¶æ€æœºè´Ÿè´£æ¥æ”¶ç½‘ç»œè¯·æ±‚ï¼Œä¸clientå®Œæˆäº¤äº’ã€‚éšåå°†å…¶å‘é€ç»™raftå®Œæˆproposeï¼ŒåŒæ—¶CURPçŠ¶æ€æœºè¿˜è¦ç»´æŠ¤ä¸€ä¸ªkv storeï¼Œå­˜å‚¨å·²ç»commitçš„å†…å®¹ã€‚

çŠ¶æ€æœºå®šä¹‰å¦‚ä¸‹ï¼Œä¸»è¦åŒ…æ‹¬ï¼š

- KVStoreï¼šå­˜å‚¨å·²ç»commitçš„å†…å®¹ï¼Œè¿™é‡Œé€‰æ‹©äº†boltdbä½œä¸ºæŒä¹…åŒ–å®ç°
- Witnessï¼šCURPçš„é‡è¦æœºåˆ¶ï¼Œåœ¨followerä¸Šè¿ä½œï¼Œç”¨äºæš‚å­˜æœªæäº¤çš„è¯·æ±‚ä»¥è¿›è¡Œå†²çªæ£€æµ‹ï¼Œç”±äºæ²¡æœ‰å®ç°recoveryï¼Œå› æ­¤è¿™é‡Œç›´æ¥ä½¿ç”¨mapå­˜å‚¨
- CommandBoardï¼šè®°å½•ç›®å‰æ¥æ”¶åˆ°çš„è¯·æ±‚ï¼Œå¹¶åœ¨é€‚å½“çš„æ—¶æœºå“åº”Clientç»“æœ

```go
type StateMachine struct {
	NodeId   int
	proposeC chan<- string // channel for proposing updates
	mu       sync.RWMutex
	// kvStore      map[string]string // current committed key-value pairs
	KVStore      *xkv.KVStore
	commandBoard *command.CommandBoard
	snapshotter  *snap.Snapshotter
	raftState    raft.StateType
	fastPath     chan *curp_proto.CurpClientCommand
	slowPath     chan *curp_proto.CurpClientCommand
	// both fast and slow path will execute commands,this set is used to avoid executing the same command twice
	commandSet   map[command.ProposeId]struct{}
	witness      witness.Witness
	stateChangeC chan raft.StateType
}
```

### Witness

Witnessæœºåˆ¶æ˜¯CURPçš„æ ¸å¿ƒï¼Œç”¨äºæä¾›å†²çªæ£€æµ‹åŠŸèƒ½ï¼Œè¿™é‡Œçš„å®ç°éå¸¸ç®€å•ï¼Œä»…ä»…åªä½¿ç”¨mapå­˜å‚¨+Mutexå¹¶å‘æ§åˆ¶ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š

```go
type Witness struct {
	mu         sync.Mutex
	commandMap map[string]map[command.ProposeId]*curp_proto.CurpClientCommand
}
```

ç›®å‰å®ç°çš„å†²çªæ£€æµ‹çš„ç­–ç•¥éå¸¸ç®€å•ï¼Œä»…æ”¯æŒkvå±‚é¢ï¼Œå³å¯¹äºåŒä¸€æ¡keyï¼Œå†™-å†™å’Œè¯»-å†™è¿™ä¸¤ç§æƒ…å†µæ˜¯å†²çªçš„ï¼Œåœ¨æ’å…¥ä¸€æ¡è®°å½•æ—¶ï¼Œå¦‚æœæ£€æµ‹åˆ°å†²çªï¼Œé‚£ä¹ˆå°±ç›´æ¥è¿”å›falseï¼Œå¦åˆ™å°†å…¶ä¿å­˜åˆ°mapå½“ä¸­ã€‚

Witnessä¸­çš„æ•°æ®åº”å½“è¿›è¡ŒæŒä¹…åŒ–ä¿å­˜ï¼Œä»¥ç”¨äºåœ¨å®•æœºåæ¢å¤æ•°æ®ï¼Œç”±äºWitnessä¸­æ•°æ®æ˜¯æš‚å­˜çš„ï¼Œåœ¨commitä¹‹åå°±ä¼šåˆ é™¤ï¼Œå› æ­¤curpåŸæ–‡ä¸­æå‡ºäº†å­˜å‚¨åœ¨NVMç­‰ç¡¬ä»¶ä¸Šä¼šæ›´åˆé€‚ã€‚è¿™é‡Œç”±äºæš‚æ—¶æ²¡æœ‰å®ç°recoveryæœºåˆ¶ï¼Œæ‰€ä»¥ç›®å‰æ˜¯ç›´æ¥ä½¿ç”¨mapå­˜å‚¨ã€‚


### CommandBoard

CmdBoardçš„ä½œç”¨ä¸ºè®°å½•æ¥æ”¶åˆ°çš„è¯·æ±‚ï¼Œç­‰å¾…è¯·æ±‚æ‰§è¡Œå®Œæˆï¼Œè€Œå…·ä½“çš„æ‰§è¡Œåˆ™äº¤ç»™ `CommandWorker` æ¥å®Œæˆï¼Œå‰å°æ¥æ”¶è¯·æ±‚çš„çº¿ç¨‹åªéœ€è¦é€šè¿‡CommandBoardæ¥è·å–ç»“æœï¼Œå¹¶ç»“æœå“åº”ç»™å®¢æˆ·ç«¯ã€‚ä¸è¿‡ç”±äºCURPå­˜åœ¨fast pathå’Œslow pathçš„æ¦‚å¿µï¼Œå› æ­¤ä¼šç¨å¾®å¤æ‚ä¸€äº›ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š

```go
type CommandBoard struct {
	mu sync.Mutex
	// store all notifiers for execution results
	erNotifiers map[ProposeId]chan string
	// store all notifiers for after sync results
	asrNotifiers map[ProposeId]chan struct{}

	erBuffer map[ProposeId]string

	asrBuffer map[ProposeId]struct{}
}
```
`er` ä¸º `execution result`ï¼Œ`asr` å³ä¸º `async execution result`ï¼Œåˆ†åˆ«ä»£è¡¨fast pathå’Œslow pathçš„æ‰§è¡Œç»“æœã€‚
è¯·æ±‚é€šè¿‡ `ProposeId` æ¥æ ‡è¯†ï¼Œ`ProposeId` ä¸º `ClientId` å’Œ `SeqId` çš„ç»„åˆï¼Œä»¥åŒºåˆ†ä¸åŒClientçš„ä¸åŒè¯·æ±‚ï¼š

```go
type ProposeId struct {
	ClientId uint64
	SeqId    uint64
}
```


leaderåœ¨é€šè¿‡fast pathæ‰§è¡Œè¯·æ±‚ï¼Œåœ¨æ¥æ”¶åˆ°è¯·æ±‚åï¼Œä¼šé€šè¿‡ `WaitForEr()` æ¥ç­‰å¾…fast pathçš„æ‰§è¡Œç»“æœï¼Œåœ¨ `WaitForEr()` ä¸­ï¼Œæ¶‰åŠåˆ°erBufferå’ŒerNotifiersã€‚erBufferç”¨äºç¼“å­˜å‘½ä»¤çš„æ‰§è¡Œç»“æœï¼Œç»fast pathå®Œæˆæ‰§è¡Œçš„å†…å®¹éƒ½ä¼šå­˜å‚¨åˆ°å…¶ä¸­ï¼Œè€ŒerNotifiersåˆ™å­˜å‚¨ä¸€ä¸ªchannelï¼Œå‰å°ç›‘å¬è¯¥channelï¼Œç­‰å¾…æ‰§è¡Œç»“æœã€‚

```go
func (c *CommandBoard) WaitForEr(id ProposeId) string {

	c.mu.Lock()
	if result, ok := c.erBuffer[id]; ok {

		c.mu.Unlock()
		return result
	}
	if _, ok := c.erNotifiers[id]; !ok {
		c.erNotifiers[id] = make(chan string, 1)
	}
	notifyChan := c.erNotifiers[id]
	c.mu.Unlock()
	result := <-notifyChan
	c.erBuffer[id] = result
	return result

}
```

`WaitForAsr` ç”¨äºç­‰å¾…commandåœ¨slow pathä¸­å®Œæˆå…±è¯†ï¼Œè¿”å›æ‰§è¡Œçš„ç»“æœã€‚

```go
func (c *CommandBoard) WaitForAsr(id ProposeId) string {
	c.mu.Lock()
	defer c.mu.Unlock()
	//trace.Trace(trace.Client, "Wait Synced [clientId: %d,seqId: %d]", id.ClientId, id.SeqId)
	_, asrOk := c.asrBuffer[id]
	result, erOk := c.erBuffer[id]

	defer delete(c.asrBuffer, id)
	defer delete(c.erBuffer, id)

	// command has already been executed in both fast path and slow path
	if asrOk && erOk {
		return result
	}

	if _, ok := c.asrNotifiers[id]; !ok {
		c.asrNotifiers[id] = make(chan struct{}, 1)
	}
	notifyChan := c.asrNotifiers[id]
	// release lock and wait
	c.mu.Unlock()
	<-notifyChan
	c.mu.Lock()
	if result, ok := c.erBuffer[id]; ok {
		return result
	}
	// UNREACHABLE
	return "NOT FOUND IN BUFFER"
}
```



#### Why Buffer

åœ¨ 6.824 ä¸­ï¼Œæ‰§è¡Œç»“æœé€šè¿‡ä¸€ä¸ªchannelå³å¯ä¼ é€’ï¼Œä½†æ˜¯è¿™é‡Œé¢å¤–ä½¿ç”¨ä¸€ä¸ªBufferä¸»è¦æ˜¯ç”¨äºå…¼å®¹slow pathï¼Œæ¥ä¿è¯çº¿æ€§ä¸€è‡´æ€§ã€‚erå’Œasréƒ½å¼•å…¥äº†bufferï¼ŒäºŒè€…éœ€è¦åˆ†å¼€è®¨è®º


é¦–å…ˆè¯´æ˜ä¸€ä¸‹ä¸ºä»€ä¹ˆéœ€è¦ `erBuffer` ã€‚è®¾æƒ³è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼šclient1 å…ˆ cmd1 ` set a = 1 `ï¼Œéšåclient 1 å‘é€ cmd 2 ` get a `ï¼Œæ­¤æ—¶è¢«witnessæ£€æµ‹åˆ°å†²çªï¼Œéœ€ç­‰å¾…slow pathæ‰§è¡Œå®Œæ¯•ï¼Œæ­¤æ—¶ï¼Œclient 1 åˆå‘é€äº† cmd 3 ` set a = 3 `ï¼Œç”±äºleaderä¸ŠWitnessæ˜¯å…³é—­çš„ï¼Œset a = 3 å¯ä»¥ç›´æ¥æ‰§è¡Œï¼Œè¿™ä¼šå¯¼è‡´cmd3 åœ¨cmd2 ä¹‹å‰è¢«æ‰§è¡Œï¼Œå¯¹äºclientè€Œè¨€ï¼Œè§‚æµ‹åˆ°çš„ç»“æœä¸å‘é€é¡ºåºä¸ä¸€è‡´ã€‚

![image.png](https://pic-bed-1309931445.cos.ap-nanjing.myqcloud.com/blog/20240607003628.png)


å› æ­¤ï¼Œcmd2 ä¸èƒ½ç­‰å¾…ä»slow pathä¸­commitæ‰æ‰§è¡Œï¼Œè€Œæ˜¯åº”å½“åœ¨fast pathä¸­æ‰§è¡Œå®Œæˆï¼Œä¿å­˜ç»“æœï¼Œç­‰åˆ°å¯¹åº”çš„æ—¥å¿—commitä¹‹åï¼Œå†å°†è¯¥ç»“æœè¿”å›ç»™clientã€‚

å¯¹äºä¸åŒçš„clientæ¥è¯´ï¼Œå³cmd1 cmd3 ç”±client 1 å‘é€ï¼Œcmd2 ç”±client 2 å‘é€ï¼Œæ­¤æ—¶cmd2 å’Œcmd3 å¤„äºä¸€ç§å¹¶å‘çš„çŠ¶æ€ï¼Œæ˜¯å…è®¸ä»¥ä»»æ„çš„ç»“æœå®Œæˆæ‰§è¡Œçš„ï¼Œä½†æ˜¯å¦‚æœåªæœ‰ä¸€ä¸ªclientï¼Œåˆ™ä¼šè¿èƒŒçº¿æ€§ä¸€è‡´æ€§ã€‚

è€Œ `AsrBuffer` ä¸»è¦æ˜¯ç”¨äºè§£å†³slow pathçš„å¼‚æ­¥æ‰§è¡Œé—®é¢˜ï¼Œå¦‚æœåå°raft commitçš„æ•ˆç‡æ¯”è¾ƒé«˜ï¼Œé‚£ä¹ˆä¼šå¯¼è‡´åœ¨clientè°ƒç”¨WaitSyncedä¹‹å‰å°±å·²ç»commitå®Œæ¯•ï¼Œæ­¤æ—¶å¦‚æœåˆ›å»ºä¸€ä¸ªchannelå¹¶ç›‘å¬ï¼Œé‚£ä¹ˆåç»­å°±ä¼šæ°¸è¿œæ— æ³•æ¥æ”¶åˆ°ç»“æœã€‚

å¯¹äºè¿™ä¸ªé—®é¢˜ï¼Œæœ‰ä¸¤ä¸ªè§£å†³æ–¹æ¡ˆï¼Œä¸€æ˜¯éå†å½“å‰commit idå‰æ‰€æœ‰å¯¹åº”çš„channelï¼Œå…¨éƒ¨é€šçŸ¥ä¸€éï¼ŒäºŒå°±æ˜¯æ·»åŠ ä¸€ä¸ªç¼“å­˜ï¼Œå¯ä»¥é€šè¿‡å…ˆæŸ¥è¯¢bufferæ¥åˆ¤æ–­æ˜¯å¦æ‰§è¡Œå®Œæˆï¼Œå¦‚æœæ²¡æœ‰ï¼Œåç»­å†é€šè¿‡channelç›‘å¬ç»“æœã€‚bufferå½“ä¸­åªéœ€è¦å­˜å‚¨ä¸€ä¸ªç©ºstruct{}ï¼Œèµ·åˆ°é€šçŸ¥ä½œç”¨å³å¯ã€‚ä¸ªäººè®¤ä¸ºç¬¬ä¸€ç§å®ç°æ–¹å¼ä¼˜é›…ä¸€äº›ï¼Œå› æ­¤å°±å¼•å…¥äº†bufferã€‚

### Command Worker

ä¸Command Boardç›¸å¯¹åº”çš„æ˜¯Command Workerï¼ŒCommand Boardè®°å½•è¯·æ±‚ï¼ŒWorkerè´Ÿè´£å…·ä½“çš„æ‰§è¡Œã€‚

Command Workerä¸­ä¼šåˆ†åˆ«ä»fast pathå’Œslow pathä¸­æ¥æ”¶è¯·æ±‚ï¼š

- leaderåœ¨æ¥æ”¶åˆ°è¯·æ±‚ä¹‹åï¼Œä¼šç›´æ¥å°†å…¶é€šè¿‡fast path channelå‘é€è‡³cmd workerå¤„ï¼Œfolloweråªè¿›è¡Œwitnessä¸æ‰§è¡Œï¼Œå› æ­¤ä¸ä¼šä»fast pathä¸­æ¥æ”¶ä»»ä½•å†…å®¹ã€‚leaderæ‰§è¡Œå®Œæˆä¹‹åå°±å¯ä»¥é€šè¿‡ `InsertEr` å°†ç»“æœæ·»åŠ åˆ°Command Boardå½“ä¸­ï¼Œé€šçŸ¥å‰å°è¿”å›ç»“æœç»™client
- raftä¼šå°†å·²ç»commitäº†çš„è¯·æ±‚é€šè¿‡slow pathå‘é€è‡³cmd workerã€‚ç”±äºleaderå·²ç»é€šè¿‡fast pathæ‰§è¡Œè¿‡ä¸€æ¬¡äº†ï¼Œå› æ­¤leaderåœ¨è¿™é‡Œåº”å½“å¿½ç•¥æ‰è¯¥è¯·æ±‚ï¼Œè€Œfolloweråº”å½“æ‰§è¡Œæ¥è·Ÿéšleaderçš„çŠ¶æ€ã€‚
è¿™ä¸€éƒ¨åˆ†ä¸ä¼ ç»Ÿraftæœ€å¤§çš„ä¸åŒå°±æ˜¯ï¼šleaderä¼šé€šè¿‡fast pathè¿›è¡Œâ€œæŠ¢è·‘â€ï¼Œä»è€Œç»™ç³»ç»Ÿå¼•å…¥äº†é¢å¤–çš„å¤æ‚åº¦ï¼š

- Leaderé€šè¿‡fast pathæå‰æ‰§è¡Œï¼Œä¿®æ”¹äº†çŠ¶æ€æœºï¼Œä½†æ˜¯ç”±äºwitnessæœºåˆ¶çš„å­˜åœ¨ï¼Œè¿™ä¸ªæ‰§è¡Œç»“æœåœ¨commitä¹‹å‰æ˜¯ä¸ä¼šæš´éœ²ç»™clientçš„ã€‚
- Leaderæå‰ä¿®æ”¹äº†çŠ¶æ€æœºï¼Œé‚£ä¹ˆslow pathä¸­çš„å†…å®¹å°±æ— éœ€å†æ‰§è¡Œä¸€éï¼Œé¢å¤–å†™ä¸€ékv storeçš„å¼€é”€æ¯”è¾ƒé«˜ã€‚å¦‚æœslow pathä¼šå†æ‰§è¡Œä¸€éï¼Œè™½ç„¶å¯èƒ½ä¼šå¯¼è‡´fast pathå’Œslow pathçš„å†…å®¹ç›¸äº’è¦†ç›–ï¼Œä½†æ˜¯ç”±äºå†²çªæ£€æµ‹çš„æœºåˆ¶å­˜åœ¨ï¼Œç›¸äº’è¦†ç›–çš„ä¸­é—´æ€ä¸ä¼šå¯¹å¤–æš´éœ²ï¼Œå› æ­¤æ‰§è¡Œä¸€éslowä¹Ÿä¸ä¼šå½±å“æ­£ç¡®æ€§ï¼Œç­‰åˆ°commitåï¼ŒçŠ¶æ€æœºä¸åªæ‰§è¡Œfastæ— å¼‚ã€‚Leaderé€šè¿‡fast pathå·²ç»å®Œæˆäº†æŒä¹…åŒ–ï¼Œå› æ­¤Leaderä¹Ÿä¸ä¼šä¾èµ–raft logæ¥å®Œæˆrecoveryã€‚
- Followeræ²¡æœ‰é¢å¤–çš„åŠ¨ä½œï¼Œåªéœ€è¦witnessåˆ¤æ–­å†²çªï¼Œå¹¶ä¸”é€šè¿‡slow pathæ¥è·Ÿéšleaderçš„çŠ¶æ€å³å¯ã€‚ 

æ­¤å¤–è¿˜æœ‰ä¸€ä¸ªCommandSetï¼Œç”¨äºå¯¹å‘½ä»¤è¿›è¡Œå»é‡ï¼Œé˜²æ­¢å·²ç»æ‰§è¡Œè¿‡ä¸€éï¼Œä½†æ˜¯æ²¡æ¥åŠå“åº”clientï¼Œå®•æœºï¼Œéšåclientåˆé‡è¯•ï¼Œå¯¼è‡´å‘½ä»¤è¢«é‡å¤æ‰§è¡Œã€‚åœ¨ 6.824 çš„lab3 ä¸­ï¼Œéœ€è¦è¿™æ ·ä¸€ä¸ªè®¾è®¡æ˜¯å› ä¸ºå…¶ä¸­çš„appendå‘½ä»¤æ˜¯ä¸å¹‚ç­‰çš„ï¼Œå³ä¼šåœ¨åŸæœ‰valueçš„åŸºç¡€ä¸Šè¿½åŠ æ•°æ®ï¼Œè€Œå¦‚æœå°†å‘½ä»¤è®¾è®¡æˆå¹‚ç­‰çš„ï¼Œå°±ä¸éœ€è¦è¿™ä¸ªCommandSetäº†ï¼Œå‘½ä»¤é‡å¤æ‰§è¡Œä¹Ÿä¸ä¼šäº§ç”Ÿè´Ÿé¢å½±å“ã€‚

Command Workeræ˜¯å•çº¿ç¨‹æ‰§è¡Œçš„ï¼Œä»¥ç¡®ä¿çº¿æ€§ä¸€è‡´æ€§ã€‚ä½†å®é™…ä¸Šï¼Œæ­£å¦‚CURPæœ¬èº«çš„æ€æƒ³â€”â€”å…¨å±€é¡ºåºæ˜¯ä¸å¿…è¦çš„ï¼Œå¯ä»¥å°†å…¨å±€é¡ºåºç¼©å°èŒƒå›´åˆ°å­˜åœ¨å†²çªçš„keyä¹‹é—´ç»´æŠ¤ä¸€ä¸ªé¡ºåºã€‚åœ¨å®ç°ä¸Šå¯ä»¥ç»´æŠ¤å¤šä¸ªworkerï¼Œå°†å­˜åœ¨å†²çªçš„keyåˆ†é…è‡³åŒä¸€ä¸ªworkerå¤„ï¼Œç¡®ä¿èƒ½å¤ŸæŒ‰ç…§é¡ºåºæ¥æ‰§è¡Œã€‚ä¸åŒworkerä¹‹é—´ç”±äºä¸å­˜åœ¨å†²çªï¼Œå¯ä»¥å¹¶è¡Œæ‰§è¡Œã€‚

æ­¤å¤–ï¼Œç”±äºkvstoreå’ŒcommandSetåªä¼šåœ¨è¿™é‡Œä¿®æ”¹ï¼ŒåŠ ä¸Šå…¶ä¸ºå•çº¿ç¨‹ï¼Œå› æ­¤è¿™é‡Œå®Œå…¨å¯ä»¥ä¸åŠ é”æ‰§è¡Œï¼Œä¸´ç•ŒåŒºä»…ä»…åªæœ‰åˆ¤æ–­å½“å‰èŠ‚ç‚¹çŠ¶æ€

è¿™é‡Œçš„å®ç°å¯ä»¥å‚è€ƒXlineï¼Œå…¶ä¸­å®ç°äº†ä¸€ä¸ªéå¸¸å®Œå¤‡çš„å†²çªæ£€æµ‹é˜Ÿåˆ— + workerï¼š[zhuanlan.zhihu.com/p/662504235](https://zhuanlan.zhihu.com/p/662504235)

```go
func (s *StateMachine) cmdWorker() {
	for {
		select {
		case cmd := <-s.fastPath:
			trace.Trace(trace.Fast, s.NodeId, "got cmd from fast path %v", cmd)
			proposeId := command.ProposeId{
				ClientId: cmd.ClientId,
				SeqId:    cmd.SeqId,
			}
			if _, ok := s.commandSet[proposeId]; ok {
				// command executed before,nothing to do
				trace.Trace(trace.Fast, s.NodeId, "cmd already executed %v", cmd)
			} else {
				s.commandSet[proposeId] = struct{}{}
				result := s.execute(cmd)
				trace.Trace(trace.Fast, s.NodeId, "cmd %v executed,result is %v", cmd, result)
				s.commandBoard.InsertEr(proposeId, result)
			}

		case cmd := <-s.slowPath:
			s.mu.Lock()
			isLeader := s.raftState == raft.StateLeader
			s.mu.Unlock()
			trace.Trace(trace.Slow, s.NodeId, "got cmd from slow path %v", cmd)
			if _, ok := s.commandSet[cmd.ProposeId()]; ok || isLeader {
				// command executed before,nothing to do
				trace.Trace(trace.Slow, s.NodeId, "cmd already executed %v", cmd)
			} else {
				s.commandSet[cmd.ProposeId()] = struct{}{}
				s.execute(cmd)
			}
			trace.Trace(trace.Slow, s.NodeId, "WAIT Notify result in slow path,proposeId:[clientId: %d,seqId: %d]", cmd.ClientId, cmd.SeqId)
			s.commandBoard.NotifyAsr(cmd.ProposeId())
			trace.Trace(trace.Slow, s.NodeId, "Notify result in slow path,proposeId:[clientId: %d,seqId: %d]", cmd.ClientId, cmd.SeqId)
			// when command is committed, it can be remove from witness and command set safely
			s.removeRecord(cmd.ProposeId())
		}
	}
}


// we don't need to lock this function,because it's the only func which modifies KVStore
func (s *StateMachine) execute(cmd *curp_proto.CurpClientCommand) string {
	if cmd.Op == command.PUT {
		s.KVStore.Put(cmd.Key, cmd.Value)
	} else if cmd.Op == command.DELETE {
		s.KVStore.Delete(cmd.Key)
	} else if cmd.Op == command.GET {
		result, err := s.KVStore.Get(cmd.Key)
		if err != nil {
			return "NOT FOUND IN STATE"
		} else {
			return result
		}
	}
	// unreachable!
	return ""
}
```



### Fast Path
åœ¨åˆ†æå®ŒCommand Boardå’ŒCommand Workerä¹‹åï¼Œå°±å¯ä»¥ä¸²é€šCURPçš„fast pathå’Œslow pathçš„å…¨æµç¨‹äº†ã€‚
fast pathé€šè¿‡ `Propose ()` å®Œæˆï¼Œæ— è®ºè¯»å†™è¯·æ±‚éƒ½ä¼šè¢«å°è£…æˆä¸€ä¸ªClientCommandï¼Œéšåè°ƒç”¨ `Propose()` ï¼Œæµç¨‹å¦‚ä¸‹ï¼š

1. é¦–å…ˆè¿›è¡Œå†²çªæ£€æµ‹ï¼Œå°†è¯·æ±‚æ·»åŠ åˆ°Witnesså½“ä¸­ï¼Œå¹¶ä¸”è¿”å›æ˜¯å¦å†²çª
2. followeråœ¨fast pathä¸­åªèµ·åˆ°witnessä½œç”¨ã€‚å¦‚æœå½“å‰èŠ‚ç‚¹éLeaderï¼Œé‚£ä¹ˆæ­¤æ—¶å°±å¯ä»¥è¿”å›äº†ï¼Œå“åº”CONFLICTæˆ–è€…ACCEPT
3. å¯¹äºLeaderåç»­åº”å½“ç›´æ¥ç»§ç»­æ‰§è¡Œï¼Œé€šè¿‡fast pathçš„channelå°†cmdäº¤ç»™ cmd workerï¼Œå¹¶é€šè¿‡proposeCå°†cmdä¼ é€’ç»™raft
4. é€šè¿‡CommandBoardç­‰å¾…ç»“æœï¼Œå“åº”ç»™Client

```go
func (s *StateMachine) Propose(cmd *curp_proto.CurpClientCommand) *curp_proto.CurpReply {

	isConflict := s.witness.InsertIfNotConflict(cmd)
	s.mu.Lock()
	if s.raftState == raft.StateLeader {
		trace.Trace(trace.Leader, s.NodeId, "propose command %s,type: %s,conflict: %v", cmd.Key, command.OpFmt[cmd.Op], isConflict)
	} else {
		trace.Trace(trace.Follower, s.NodeId, "propose command %s,type: %s,conflict: %v", cmd.Key, command.OpFmt[cmd.Op], isConflict)
	}
	reply := &curp_proto.CurpReply{
		Content: "",
	}
	if s.raftState != raft.StateLeader {
		if isConflict {
			s.mu.Unlock()
			reply.StatusCode = curp_proto.CONFLICT
			return reply
		} else {
			s.mu.Unlock()
			reply.StatusCode = curp_proto.ACCEPTED
			return reply
		}
	}
	buf := cmd.Encode()
	go func() {
		s.fastPath <- cmd
	}()

	// command will update the state machine or get command is conflict
	trace.Trace(trace.Leader, s.NodeId, "send propose[clientId:%d seqId: %d] msg to raft node", cmd.ClientId, cmd.SeqId)
	go func() {
		s.proposeC <- buf
	}()

	s.mu.Unlock()
	proposeId := command.ProposeId{
		ClientId: cmd.ClientId,
		SeqId:    cmd.SeqId,
	}
	result := s.commandBoard.WaitForEr(proposeId)
	reply.Content = result
	if isConflict {
		reply.StatusCode = curp_proto.CONFLICT
	} else {
		reply.StatusCode = curp_proto.ACCEPTED
	}
	return reply
}
```

è¿™é‡Œæœ‰ä¸€ä¸ªç»†èŠ‚ï¼Œåœ¨CURP-Qçš„è®ºæ–‡å½“ä¸­æè¿°ï¼šLeaderçš„witnessåº”å½“æ˜¯å…³é—­çš„ï¼Œå³Leaderå¹¶ä¸è¿›è¡Œå†²çªæ£€æµ‹ï¼Œå¯¹äºæ‰€æœ‰è¯·æ±‚éƒ½ç›´æ¥æ‰§è¡Œï¼Œä½†æ˜¯åœ¨Xlineçš„å®ç°ä¸­ï¼ŒLeaderæ˜¯å¯åŠ¨äº†Witnesså¹¶è¿›è¡Œå†²çªæ£€æµ‹çš„ã€‚å¯¹äºè¿™ä¸ªç»†èŠ‚ï¼Œä¸ªäººè®¤ä¸ºå¹¶ä¸ä¼šå¯¹å¹¶ä¸ä¼šå¯¹ç³»ç»Ÿæ­£ç¡®æ€§äº§ç”Ÿå½±å“ï¼Œæš‚æ—¶æ²¡æœ‰æ·±ç©¶ã€‚

>Witnesses in leaders are inactive, and all client requests are serialized and logged in their command logs directly.


![image.png](https://pic-bed-1309931445.cos.ap-nanjing.myqcloud.com/blog/20240607000134.png)
### Slow Path

Slow Pathçš„å…¥å£å¾ˆç®€å•ï¼Œåªéœ€è¦è°ƒç”¨ `WaitForAsr()` æ¥ç­‰å¾…commitå³å¯ï¼Œé€šè¿‡ `WaitSynced()` æ¥å®ç°
```go
func (s *StateMachine) WaitSynced(id command.ProposeId) *curp_proto.CurpReply {
	// only send wait synced message to leader
	trace.Trace(trace.Leader, s.NodeId, "got wait synced message: %v", id)
	result := s.commandBoard.WaitForAsr(id)
	reply := &curp_proto.CurpReply{
		Content:    result,
		StatusCode: curp_proto.ACCEPTED,
	}
	trace.Trace(trace.Leader, s.NodeId, "wait synced finished,id: %v,result: %v", id, result)
	return reply
}

```


åœ¨Fast Pathä¸­ï¼ŒLeaderä¼šé€šè¿‡proposeCå‘é€ç»™Raftï¼Œæ­¤æ—¶å°±ç›¸å½“äºè¿›å…¥äº†Slow Pathï¼Œåœ¨Raftä¸­ï¼Œå®Œæˆå…±è¯†çš„cmdä¼šé€šè¿‡Readyè¿”å›ï¼Œç»RaftNodeè½¬æ‰‹åˆé€šè¿‡commitCå‘é€ä¼šäº†çŠ¶æ€æœºï¼ŒçŠ¶æ€æœºæ”¶åˆ°ä¹‹åï¼Œå¯¹cmdè¿›è¡Œdecodeï¼Œéšæœºé€šè¿‡slow path channelåˆå°†è¯·æ±‚å‘é€ç»™äº†cmd worker

```go
func (s *StateMachine) readCommits(commitC <-chan *commit, errorC <-chan error) {
	for commit := range commitC {
		if commit == nil {
			// signaled to load snapshot
			snapshot, err := s.loadSnapshot()
			if err != nil {
				log.Panic(err)
			}
			if snapshot != nil {
				log.Printf("loading snapshot at term %d and index %d", snapshot.Metadata.Term, snapshot.Metadata.Index)
				if err := s.recoverFromSnapshot(snapshot.Data); err != nil {
					log.Panic(err)
				}
			}
			continue
		}
		for _, data := range commit.data {
			var cmd curp_proto.CurpClientCommand
			dec := gob.NewDecoder(bytes.NewBufferString(data))
			if err := dec.Decode(&cmd); err != nil {
				log.Fatalf("raftexample: could not decode message (%v)", err)
			}
			s.slowPath <- &cmd

		}
		close(commit.applyDoneC)
	}
	if err, ok := <-errorC; ok {
		log.Fatal(err)
	}
}
```

ä¹‹åå°±æ˜¯cmd workerçš„é€»è¾‘äº†ï¼Œåœ¨ä¸Šé¢å·²ç»åˆ†æè¿‡äº†ï¼Œè¿™é‡Œç®€è¦æ•´åˆä¸€ä¸‹ã€‚å¯¹äºleaderè€Œè¨€ï¼Œç›´æ¥å¿½ç•¥slow pathä¸­çš„å†…å®¹ï¼Œä»¥å…å†…å®¹è¦†ç›–å½±å“çº¿æ€§ä¸€è‡´æ€§ã€‚è€Œå¯¹äºfollowerè€Œè¨€ï¼Œç›´æ¥åº”ç”¨ä»¥è·ŸéšLeaderã€‚slow pathæ‰§è¡Œå®Œæˆï¼Œå³å¯è®¤å®šå…¶ä¸ºcommitï¼Œæ­¤æ—¶å¯ä»¥é€šè¿‡ `NotifyAsr` è·å–æ‰§è¡Œç»“æœï¼Œå¹¶é€šçŸ¥ `WaitSynced` ç»“æŸé˜»å¡ã€‚


![image.png](https://pic-bed-1309931445.cos.ap-nanjing.myqcloud.com/blog/20240607000719.png)


## CURP Client

å¯¹åº”åœ°ï¼Œåœ¨CURP Clientç«¯ä¹Ÿåˆ†ä¸ºäº†fast pathå’Œslow pathï¼Œå‡é€šè¿‡grpcå®ç°ï¼Œæ­¤å¤–ï¼Œè¿˜éœ€è¦ä¸€ä¸ªisLeaderæ¥ç¡®å®šserverä¸­çš„leaderï¼Œä»¥ç¡®å®šåº”å½“å‘è°å‘é€ `WaitSynced()`ã€‚

### Fast path

åœ¨fast pathä¸­ï¼Œclientéœ€è¦åšçš„å°±æ˜¯å°†è¯·æ±‚å¹¿æ’­ç»™æ‰€æœ‰çš„serverï¼Œç„¶åç›‘å¬ç»Ÿè®¡ç»“æœï¼š
- å¦‚æœå“åº”ç»“æœä¸­å­˜åœ¨å†²çªï¼Œé‚£ä¹ˆå°±è¿”å›å†²çªï¼Œåç»­è½¬å‘slow round
- å¦‚æœè¾¾åˆ°äº†superquorum (fä¸ªèŠ‚ç‚¹ï¼Œå¯¹åº”ä¸ºf + f / 2 + 1ï¼Œå³ 4 èŠ‚ç‚¹éœ€è¦ 3 ä¸ªï¼Œ3 èŠ‚ç‚¹éœ€è¦ 3ä¸ª )ï¼Œå°±è¿”å›è¯·æ±‚æˆåŠŸ
- è¶…æ—¶æ£€æµ‹



![image.png](https://pic-bed-1309931445.cos.ap-nanjing.myqcloud.com/blog/20240527235816.png)


```go
func (c *GrpcClient) fastRound(cmd *curp_proto.CurpClientCommand, notifyC []chan *curp_proto.CurpReply) (*curp_proto.CurpReply, error) {

	timeout := time.NewTicker(time.Second * 5)
	fastPathChan := make(chan *curp_proto.CurpReply)
	for i := 0; i < len(c.grpc_servers); i++ {
		go func(i int) {
			c.sendC[i] <- cmd

			result := <-notifyC[i]
			fastPathChan <- result
		}(i)
	}
	acceptedCount := 0

	result := &curp_proto.CurpReply{
		StatusCode: curp_proto.TIMEOUT,
		Content:    "",
	}

	for {
		select {
		case fastResult := <-fastPathChan:
			trace.Trace(trace.Client, -1, "client receive fast path result: %v", fastResult)
			if fastResult.StatusCode == curp_proto.ACCEPTED {
				acceptedCount++
				if fastResult.Content != "" {
					result = fastResult
				}
			} else {
				return fastResult, nil
			}

			if acceptedCount == c.superQuorum() {
				return result, nil
			}
		case <-timeout.C:
			fmt.Printf("timeout !!\n")
			return result, fmt.Errorf("fast path time out")
		}
	}

}
```

### slow path

slow pathæ¯”è¾ƒç®€å•ï¼Œåªéœ€è¦å°†è¯·æ±‚å‘é€ç»™Leaderå³å¯

```go
func (c *GrpcClient) slowRound(cmd *curp_proto.CurpClientCommand, notifyC []chan *curp_proto.CurpReply) (string, error) {
	sync_cmd := &curp_proto.CurpClientCommand{ClientId: cmd.ClientId, SeqId: cmd.SeqId, Sync: 1}
	c.sendC[c.LeaderId] <- sync_cmd
	reply := <-notifyC[c.LeaderId]

	trace.Trace(trace.Client, -1, "client wait synced finished, id: %v", cmd.ProposeId)
	if reply.StatusCode == curp_proto.CONFLICT {
		return "", fmt.Errorf("command is still conflict after wait synced")
	}
	return reply.Content, nil
}

```

éšåï¼Œå°†fast pathå’Œslow pathåšä¸€ä¸ªæ•´åˆï¼Œå°è£…æˆ `Propose()` ï¼Œåœ¨ `Propose()` ä¸­ï¼š

1. é¦–å…ˆè°ƒç”¨ `fast_round()` ï¼Œå°†è¯·æ±‚è¿›è¡Œå¹¿æ’­ï¼Œå¦‚æœä¸å­˜åœ¨å†²çªï¼Œé‚£ä¹ˆå°±å¯ä»¥ç›´æ¥è¿”å›ï¼Œä»£è¡¨æ­¤æ¬¡è¯·æ±‚åœ¨ 1 ä¸ªRTTå†…ç»“æŸ
2. å¦‚æœ `fast_round()` ä¸­å­˜åœ¨å†²çªï¼Œé‚£ä¹ˆå†è°ƒç”¨ `slow_round()`ï¼Œé€šè¿‡ serverå¯¹ `Waitsynced()` æ¥ç­‰å¾…commitï¼Œè§£å†³å†²çª



![image.png](https://pic-bed-1309931445.cos.ap-nanjing.myqcloud.com/blog/20240606230028.png)



```go
func (c *GrpcClient) Propose(cmd *curp_proto.CurpClientCommand) (string, error) {

	ntfC := c.NewNotifyC(cmd.SeqId)
	defer c.DeleteNotifyC(cmd.SeqId)

	reply, err := c.fastRound(cmd, ntfC)

	if err != nil {
		return "", err
	}

	if reply.StatusCode == curp_proto.ACCEPTED {
		c.static.fast++
		return reply.Content, nil
	}
	c.static.slow++
	trace.Trace(trace.Client, -1, "client receive conflict result, turn to slow path: %v", reply)
	resultStr, err := c.slowRound(cmd, ntfC)

	return resultStr, err
}
```


è¿™é‡Œæœ‰ä¸€ä¸ªå°çš„ä¼˜åŒ–ï¼Œå³å¯ä»¥åŒæ—¶å‘é€fast roundå’Œslow roundè¯·æ±‚ï¼Œè¿™æ ·å¯ä»¥æ›´å¿«åœ°è·å–WaitSyncedçš„ç»“æœã€‚
## benchmark

è¿™é‡Œä½¿ç”¨benchmarkå¯¹curpçš„æ€§èƒ½åšäº†ä¸€ä¸ªç®€å•çš„æµ‹è¯•ï¼Œé€‰æ‹©çš„æ˜¯æ¯”è¾ƒé€šç”¨çš„go-ycsbï¼Œå€Ÿç”¨äº†ä¸€ä¸‹go-ycsbçš„åŠ è½½æ•°æ®å’Œç»Ÿè®¡ç»“æœçš„åŠŸèƒ½ï¼Œç„¶åè‡ªå·±é€šè¿‡tcpä¸ºcurpå®ç°äº†ä¸€ä¸ªserverï¼Œç„¶ååœ¨ycsbä¸­å®ç°äº†ä¸€ä¸ªclientï¼Œè¿™æ ·å°±å¯ä»¥æŠŠè¯·æ±‚ä»ycsbæˆåŠŸå‘é€åˆ°curpäº†ã€‚

è¿™é‡Œå®ç°çš„ç¡®å®æ˜¯æ¯”è¾ƒè‰ç‡ï¼Œä½†æ˜¯ä½ å°±è¯´èƒ½ä¸èƒ½ç”¨å§ğŸ˜€

```go
type GetResponse struct {
	Count int64
	Kvs   []*Command
}

func (r *GetResponse) Encode() []byte {
	buf := &bytes.Buffer{}
	enc := gob.NewEncoder(buf)
	err := enc.Encode(r)
	if err != nil {
		fmt.Println("encode error:", err)
	}
	return buf.Bytes()
}

const (
	GET uint8 = iota
	PUT
	DELETE
)

type Command struct {
	Op    uint8
	Key   string
	Value string
}

func bench_server(port string, client *curp.GrpcClient) {

	listener, err := net.Listen("tcp", port)
	if err != nil {
		fmt.Println("Error listening:", err.Error())
		os.Exit(1)
	}
	defer listener.Close()
	fmt.Printf("Server is listening on :%v\n", port)

	for {
		conn, err := listener.Accept()
		if err != nil {
			fmt.Println("Error accepting: ", err.Error())
			os.Exit(1)
		}
		go handleRequest(conn, client)
	}
}
func handleRequest(conn net.Conn, client *curp.GrpcClient) {

	buf := make([]byte, 4096)
	n, _ := conn.Read(buf)

	aCmd := &Command{}
	dec := gob.NewDecoder(bytes.NewReader(buf[:n]))
	err := dec.Decode(aCmd)
	if err != nil {
		fmt.Println(err)
		return
	}
	// fmt.Printf("Received: %+v\n", aCmd)

	if aCmd.Op == GET {
		// call client.get
		key := aCmd.Key
		// value := "myValue"
		value, _ := client.Get(aCmd.Key)
		cmd := Command{
			Op:    GET,
			Key:   key,
			Value: value,
		}
		cmds := []*Command{&cmd}
		resp := GetResponse{
			Count: 1,
			Kvs:   cmds,
		}
		buf := resp.Encode()
		conn.Write(buf)
	} else if aCmd.Op == PUT {
		// call client.put
		client.Put(aCmd.Key, aCmd.Value)
		conn.Write([]byte("Received PUT Response!"))
	} else if aCmd.Op == DELETE {
		// call client.delete
		client.Del(aCmd.Key)
		conn.Write([]byte("Received DELETE Response!"))
	}
}

```

è·‘äº†ä¸€ä¸ªç®€å•çš„benchmarkï¼Œç”±äºæ²¡æœ‰å®ç°scanæ“ä½œï¼Œå› æ­¤å°±åªé€‰æ‹©äº†ycsbä¸­çš„workload a-b-cï¼Œå…¶ä¸­workloadaä¸º 50%read 50%writeï¼Œworkloadbä¸º 95%read 5% writeï¼Œworkloadc 100% read,ã€‚

å¯ä»¥çœ‹åˆ°æ— è®ºæ˜¯å“ªä¸ªworkloadï¼Œcurpçš„æ€§èƒ½å‡å¥½äºraftï¼Œå¯¹äºaï¼Œå¤§çº¦æ˜¯ä¸ª 20-30%çš„æå‡ï¼Œb, cç”±äºä¸»è¦æ˜¯è¯»è¯·æ±‚ä¸ºä¸»ï¼Œcurpä¸­åªéœ€è¦ä¸€è½®rttåŠ æŸ¥è¯¢çŠ¶æ€æœºå³å¯ï¼Œè€Œraftéœ€è¦èµ°ä¸€éæ—¥å¿—å¤åˆ¶+æŸ¥è¯¢çŠ¶æ€æœºï¼Œå› æ­¤å·®è·è¢«è¿›ä¸€æ­¥æ‹‰å¤§ï¼ˆè¿™é‡ŒäºŒè€…éƒ½æ²¡æœ‰å¼€å¯çº¿æ€§ä¸€è‡´æ€§è¯»ä¼˜åŒ–çš„ï¼Œå³lease readæˆ–read indexï¼‰

è¿™ä¸ªbenchmarkæ˜¯åœ¨å•æœºä¸Šè·‘çš„ï¼Œå¦‚æœçœŸæ­£åˆ°äº†è·¨åŸŸçš„é«˜ç½‘ç»œå»¶è¿Ÿçš„åœºæ™¯ä¸‹ï¼Œå·®è·ä¼šè¢«è¿›ä¸€æ­¥çš„æ‹‰å¤§

|            | curp | raft     |
| ---------- | ---- | -------- |
| workload a | 5.2s | 6.7s     |
| workload b | 1.2s | 4.4s     |
| wrokload c | 0.6s | 4.1s<br> |

go-ycsbçš„è¯¦ç»†ç»“æœå¦‚ä¸‹ï¼š

**CURP**

```
workloada
READ   - Takes(s): 5.2, Count: 488, OPS: 94.2, Avg(us): 600, Min(us): 433, Max(us): 25103, 50th(us): 534, 90th(us): 612, 95th(us): 652, 99th(us): 948, 99.9th(us): 25103, 99.99th(us): 25103
TOTAL  - Takes(s): 5.2, Count: 1000, OPS: 192.8, Avg(us): 5185, Min(us): 433, Max(us): 52991, 50th(us): 6859, 90th(us): 11503, 95th(us): 12847, 99th(us): 16559, 99.9th(us): 27471, 99.99th(us): 52991
UPDATE - Takes(s): 5.2, Count: 512, OPS: 98.7, Avg(us): 9556, Min(us): 5396, Max(us): 52991, 50th(us): 8703, 90th(us): 12823, 95th(us): 14599, 99th(us): 18991, 99.9th(us): 27471, 99.99th(us): 52991


workloadb
Run finished, takes 1.198906187s
READ   - Takes(s): 1.2, Count: 950, OPS: 793.1, Avg(us): 567, Min(us): 304, Max(us): 43807, 50th(us): 507, 90th(us): 582, 95th(us): 640, 99th(us): 1156, 99.9th(us): 1788, 99.99th(us): 43807
TOTAL  - Takes(s): 1.2, Count: 1000, OPS: 834.4, Avg(us): 1192, Min(us): 304, Max(us): 43807, 50th(us): 511, 90th(us): 631, 95th(us): 6403, 99th(us): 15151, 99.9th(us): 20879, 99.99th(us): 43807
UPDATE - Takes(s): 1.1, Count: 50, OPS: 43.9, Avg(us): 13067, Min(us): 6400, Max(us): 20879, 50th(us): 13175, 90th(us): 15527, 95th(us): 16767, 99th(us): 20879, 99.9th(us): 20879, 99.99th(us): 20879

workloadc
Run finished, takes 596.022766ms
READ   - Takes(s): 0.6, Count: 1000, OPS: 1680.6, Avg(us): 590, Min(us): 313, Max(us): 60863, 50th(us): 511, 90th(us): 614, 95th(us): 682, 99th(us): 1099, 99.9th(us): 1634, 99.99th(us): 60863
TOTAL  - Takes(s): 0.6, Count: 1000, OPS: 1680.0, Avg(us): 590, Min(us): 313, Max(us): 60863, 50th(us): 511, 90th(us): 614, 95th(us): 682, 99th(us): 1099, 99.9th(us): 1634, 99.99th(us): 60863
```

**Raft**

```
workloada
Run finished, takes 6.741194029s
READ   - Takes(s): 6.7, Count: 490, OPS: 72.8, Avg(us): 4182, Min(us): 3188, Max(us): 25279, 50th(us): 3571, 90th(us): 4787, 95th(us): 7699, 99th(us): 12015, 99.9th(us): 25279, 99.99th(us): 25279
TOTAL  - Takes(s): 6.7, Count: 1000, OPS: 148.7, Avg(us): 6733, Min(us): 3188, Max(us): 42047, 50th(us): 7979, 90th(us): 9599, 95th(us): 12111, 99th(us): 17407, 99.9th(us): 25279, 99.99th(us): 42047
UPDATE - Takes(s): 6.7, Count: 510, OPS: 76.0, Avg(us): 9183, Min(us): 6908, Max(us): 42047, 50th(us): 8295, 90th(us): 11175, 95th(us): 15455, 99th(us): 18591, 99.9th(us): 20079, 99.99th(us): 42047

workloadb
Run finished, takes 4.386455138s
READ   - Takes(s): 4.4, Count: 952, OPS: 217.6, Avg(us): 4152, Min(us): 3196, Max(us): 27407, 50th(us): 3553, 90th(us): 5947, 95th(us): 10591, 99th(us): 11487, 99.9th(us): 18127, 99.99th(us): 27407
TOTAL  - Takes(s): 4.4, Count: 1000, OPS: 228.6, Avg(us): 4380, Min(us): 3196, Max(us): 27407, 50th(us): 3559, 90th(us): 7479, 95th(us): 10799, 99th(us): 11599, 99.9th(us): 18127, 99.99th(us): 27407
UPDATE - Takes(s): 4.3, Count: 48, OPS: 11.1, Avg(us): 8898, Min(us): 7096, Max(us): 15031, 50th(us): 8271, 90th(us): 10735, 95th(us): 14975, 99th(us): 15031, 99.9th(us): 15031, 99.99th(us): 15031

workloadc
Run finished, takes 4.143589849s
READ   - Takes(s): 4.1, Count: 1000, OPS: 242.1, Avg(us): 4138, Min(us): 3272, Max(us): 44351, 50th(us): 3575, 90th(us): 5939, 95th(us): 7511, 99th(us): 11207, 99.9th(us): 13191, 99.99th(us): 44351
TOTAL  - Takes(s): 4.1, Count: 1000, OPS: 242.1, Avg(us): 4138, Min(us): 3272, Max(us): 44351, 50th(us): 3575, 90th(us): 5939, 95th(us): 7511, 99th(us): 11207, 99.9th(us): 13191, 99.99th(us): 44351
```
## TODO

ç›®å‰çš„CURPåªå®ç°äº†åŸºç¡€çš„è¿è¡Œï¼Œå¹¶æ²¡æœ‰è€ƒè™‘crash-recoveryï¼Œè¿™å¯¹äºä¸€ä¸ªå…±è¯†æ¥è¯´æ˜¾ç„¶æ˜¯ä¸è¶³çš„ï¼Œä¸è¿‡ç¢äºæ—¶é—´å’Œç²¾åŠ›ï¼ŒçŸ­æ—¶é—´ç¬”è€…æ˜¯æ— æ³•è¡¥å…¨è¿™ä¸€éƒ¨åˆ†äº†ï¼Œåœ¨è¿™é‡Œç®€å•è¯´ä¸€ä¸‹æ€è·¯ã€‚

### Version

é¦–å…ˆï¼Œå¯¹äºæŒ‚æ‰å’Œå›å¤çš„èŠ‚ç‚¹ï¼Œæ•´ä¸ªé›†ç¾¤åº”å½“èƒ½å¤Ÿæ„ŸçŸ¥ï¼Œè®ºæ–‡ä¸­ä¸­ç»™å‡ºçš„æ–¹æ¡ˆæ˜¯ç»´æŠ¤ä¸€ä¸ªé›†ç¾¤åˆ—è¡¨+versionï¼Œclienté¦–æ¬¡ä»é…ç½®ä¸­å¿ƒå¤„æŒæœ‰è¯¥åˆ—è¡¨å’Œversionï¼Œä¹‹åæ¯æ¬¡è¯·æ±‚æ˜¯æºå¸¦ä¸Šversionï¼Œéšåé…ç½®ä¸­å¿ƒæ¥æ”¶åˆ°è¯·æ±‚åä¼šæ ¡éªŒversionï¼Œæ¥åˆ¤æ–­clientæŒæœ‰çš„é…ç½®æ˜¯å¦è¿‡æœŸ, å¦‚æœè¿‡æœŸå°±æ‹’ç»æ‰æ­¤æ¬¡è¯·æ±‚ï¼Œå¹¶å‘ŠçŸ¥Client

åœ¨å®ç°ä¸Šï¼Œé…ç½®ä¸­å¿ƒå¯ä»¥å®ç°åœ¨Leaderä¸Šï¼ŒClientåœ¨è°ƒç”¨ `isLeader ()` ç¡®å®šé›†ç¾¤Leaderæ—¶é¡ºä¾¿è·å–åˆ°versionå’Œé…ç½®ï¼Œå¹¶åœ¨clientç«¯ç»´æŠ¤ï¼Œéšåæ‰©å±•ä¸€ä¸‹protobufçš„ç»“æ„ä½“ï¼Œæ¯æ¬¡è¯·æ±‚æºå¸¦ä¸Šversionã€‚serverç«¯ï¼Œserverç«¯åœ¨ä»raftå¤„æ£€æµ‹åˆ°èº«ä»½å˜æ›´æ—¶ï¼Œå°±åº”å½“ç”±æ–°çš„leaderå»ç”Ÿæˆä¸€ä»½æ–°çš„é…ç½®+versionã€‚å°†å…¶è¿”å›ç»™client

```go
func (s *StateMachine) listenRaftState() {

	for state := range s.stateChangeC {
		s.mu.Lock()
		trace.Trace(trace.Vote, s.NodeId, "raft state update: before: %s,current: %s", stmap[s.raftState], stmap[state])
		// å¦‚æœæ˜¯Leaderï¼Œé‚£ä¹ˆå°±ç”Ÿæˆæ–°é…ç½®
		s.raftState = state
		s.mu.Unlock()
	}
}
```

### Witness

ç”±äºLeaderè¿›è¡Œäº†æŠ¢è·‘ï¼Œå› æ­¤ä¼šæœ‰ä¸€äº›è¯·æ±‚è¿˜æœªcommitï¼Œä½†ä¹Ÿå·²ç»è¿”å›ç»™clientäº†ï¼Œè¿™äº›è¯·æ±‚çš„ç»“æœï¼Œæˆ–è€…è¯´è¿™äº›è¯·æ±‚å¯¹çŠ¶æ€æœºçš„å½±å“æš‚æ—¶ä¸ä¼šæš´éœ²å‡ºæ¥ï¼ˆåç»­å¦‚æœæƒ³è¦è·å–ç»“æœï¼Œæˆ–è€…è¯´å¯¹å…¶ä¿®æ”¹ï¼Œéƒ½ä¼šå› å†²çªè€Œè¢«æ‹’ç»ï¼‰ä½†æ˜¯è¯·æ±‚æˆåŠŸä¹Ÿç¡®å®æ˜¯å®æ‰“å®çš„å“åº”ç»™clientäº†ã€‚å› æ­¤è¿™ä¸€éƒ¨åˆ†çš„è¯·æ±‚ç»“æœä¸èƒ½ä¸¢å¤±ï¼Œä½†æ˜¯åˆæ²¡æœ‰é€šè¿‡logå‘é€ç»™followerï¼Œå› æ­¤å°±éœ€è¦é€šè¿‡Witnessä¸­çš„å­˜å‚¨æ¥å®Œæˆæ¢å¤ã€‚

å…·ä½“æ¥è¯´ï¼Œéœ€è¦æ·»åŠ ä¸€æ¡rpcï¼Œä½¿å¾—æ–°çš„Leaderèƒ½å¤Ÿè·å–åˆ°followerçš„witnessä¸­çš„æ•°æ®ï¼Œç„¶åå†leaderå¤„æŒ‰ç…§é¡ºåºæ‰§è¡Œå¹¶å†™å…¥logã€‚ä»è€Œè§£å†³å†²çªå¹¶ç¡®å®šé¡ºåºã€‚å½“log commitæ—¶ï¼Œå³å¯è‡ªåŠ¨åˆ é™¤æ‰witnessä¸­çš„å†…å®¹ã€‚


## Summary

æœ¬æ–‡åŸºäºetcd/raftï¼Œå®ç°äº†ä¸€ä¸ªç®€æ˜“çš„CURPï¼Œæä¾›äº†fast path + slow pathçš„é€»è¾‘ï¼Œä½¿å¾—ä¸å†²çªçš„è¯·æ±‚å¯ä»¥åœ¨ä¸€ä¸ªRTTå®Œæˆã€‚ç›®å‰è¿˜æ¬ ç¼ºrecoveryçš„é€»è¾‘ï¼Œä½†ä¸´è¿‘æ¯•ä¸šï¼Œç¬”è€…ç²¾åŠ›å®åœ¨æœ‰é™ï¼ŒçŸ­æ—¶é—´å†…åº”è¯¥æ˜¯æ²¡æœ‰ç²¾åŠ›å»è¡¥å®Œäº†ã€‚å¦‚æœæƒ³å­¦ä¹ å·¥ä¸šçº§CURPçš„å®ç°ï¼Œå¯ä»¥å»çœ‹Xlineï¼š[GitHub - xline-kv/Xline: A geo-distributed KV store for metadata management](https://github.com/xline-kv/Xline.git)

ç›®å‰çš„curpå’Œç»„é‡Œçš„ä¸€ä¸ªé¡¹ç›®ä»£ç æ··åœ¨ä¸€èµ·ï¼Œä¸å¤ªæ–¹ä¾¿å…¨éƒ¨å¼€æºï¼Œç­‰åç»­æœ‰ç©ºäº†ç»™åˆ†ç¦»å‡ºæ¥æ‰”åˆ°githubä¸Šã€‚

å¯¹äºCURPè€Œè¨€ï¼Œè™½ç„¶å…¶åœ¨æ€§èƒ½ä¸Šé¢†å…ˆRaftä¸å°‘ï¼Œä½†æ˜¯åœ¨ç¬”è€…æµ‹è¯•çš„è¿‡ç¨‹ä¸­ï¼Œå‘ç°slow pathå¯¹äºç³»ç»Ÿæ€§èƒ½å½±å“è¾ƒå¤§ï¼Œectd/raftä¸­ï¼Œlogæ˜¯ç”±wal + å†…å­˜å®ç°å­˜å‚¨çš„ï¼Œå…³é—­walä¹‹åï¼Œworkloadaå¯ä»¥ä» 5sç¼©çŸ­è‡³ 3så·¦å³ï¼Œé‚£ä¹ˆæ˜¯å¦æœ‰ä¸€ç§åŠæ³•åœ¨ä¸å­˜åœ¨å†²çªæ—¶å½»åº•ç»•è¿‡slow pathå‘¢ï¼Ÿ