<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>04-Raft State Machine | Fischer&#39;s Blog</title>
<meta name="keywords" content="">
<meta name="description" content="在正式写这一篇文章之前，原本的规划是在这一部分介绍sql执行引擎，即如何将Raft，Raft状态机，存储引擎组合起来，为SQL的执行去提供支">
<meta name="author" content="Sulv">
<link rel="canonical" href="http://itfischer.space/en/posts/tech/toydb/04-raft-state-machine/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css" integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z&#43;V9&#43;cO1A=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://itfischer.space/img/Navigation.svg">
<link rel="icon" type="image/png" sizes="16x16" href="http://itfischer.space/img/Q.gif">
<link rel="icon" type="image/png" sizes="32x32" href="http://itfischer.space/img/Q.gif">
<link rel="apple-touch-icon" href="http://itfischer.space/Q.gif">
<link rel="mask-icon" href="http://itfischer.space/Q.gif">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="04-Raft State Machine" />
<meta property="og:description" content="在正式写这一篇文章之前，原本的规划是在这一部分介绍sql执行引擎，即如何将Raft，Raft状态机，存储引擎组合起来，为SQL的执行去提供支" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://itfischer.space/en/posts/tech/toydb/04-raft-state-machine/" /><meta property="article:section" content="posts" />



<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="04-Raft State Machine"/>
<meta name="twitter:description" content="在正式写这一篇文章之前，原本的规划是在这一部分介绍sql执行引擎，即如何将Raft，Raft状态机，存储引擎组合起来，为SQL的执行去提供支"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Blog",
      "item": "http://itfischer.space/en/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Tech",
      "item": "http://itfischer.space/en/posts/tech/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "toydb",
      "item": "http://itfischer.space/en/posts/tech/toydb/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "04-Raft State Machine",
      "item": "http://itfischer.space/en/posts/tech/toydb/04-raft-state-machine/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "04-Raft State Machine",
  "name": "04-Raft State Machine",
  "description": "在正式写这一篇文章之前，原本的规划是在这一部分介绍sql执行引擎，即如何将Raft，Raft状态机，存储引擎组合起来，为SQL的执行去提供支",
  "keywords": [
    
  ],
  "articleBody": "在正式写这一篇文章之前，原本的规划是在这一部分介绍sql执行引擎，即如何将Raft，Raft状态机，存储引擎组合起来，为SQL的执行去提供支持，但是这一部分又不可避免的牵扯到SQL执行过程，如果全部展示出来，内容将会非常多，思来想去，还是Raft状态机这一部分比较独立，使用了一个Trait屏蔽掉了底层的存储实现，因此就先将这一模块单独拆出来。\n在toydb当中，Raft状态机的实现定义于src/raft/state.rs当中。在etcd，对于Raft Package也可以理解成一个状态机，因此，为了方便进行区分，在开头首先声明，在这一章出现的所有状态机的概念都是指构建于Raft上层的状态机，上一章分析的Raft会以Raft模块(Raft Package)来指代。 这里与MIT-6.824有一个非常大的不同是：\n在MIT-6.824当中，client是与上层状态机进行通信的，命令会先输入给状态机，之后状态机向下创建一条日志，发送给Raft模块去进行共识，当达到quorum共识之后，状态机再给client以回应，告知此次请求执行完成 在toydb当中，Client的请求是直接发送给Raft模块的，在上一章当中，我们可以看到，server从client_rx当中获取到了消息之后，直接调用step交给了Raft模块去处理，Raft模块处理完之后会发送给状态机，状态机进行一些逻辑校验，之后再发送Message给Raft模块，之后由Raft模块将消息回复给Client，所以在Raft模块当中，能够看到很多和ClientRequest，ClientResponse相关的内容。 1 2 3 4 5 6 7 8 9 10 11 12 // 获取client发送的消息，交给Raft模块去处理，这里的client并不是用户的client，而是要执行命令的sql端 Some((request, response_tx)) = client_rx.next() =\u003e { let id = Uuid::new_v4().as_bytes().to_vec(); let msg = Message{ from: Address::Client, to: Address::Node(node.id()), term: 0, event: Event::ClientRequest{id: id.clone(), request}, }; node = node.step(msg)?; requests.insert(id, response_tx); } Driver 在这里，toydb当中的Raft状态机更像是一个比较存粹的状态机，从Raft模块当中接收输入(Instruction)，更新自身状态之后，再给Raft模块输出(Messsage)，不会涉及到网络通信部分的内容，不会与Client进行交互，所以状态机基本上就是起到了一个记录的作用，比如，记录当前接收到了那些请求，各个请求的apply的情况，从而确定什么时候该让Raft模块去回应Client，在这一部分定义了一个Driver，用于驱动状态机的执行：\nstate_rx用于从Raft模块当中接收信息 node_tx用于向Raft模块发送信息 notify：用于当某条日志apply之后，通知Raft模块，让其给Client回应，Raft Leader在收到Mutate类型的ClientRequest之后，会进行propose来复制日志，并且向状态机当中发送一条notify：保存在状态机当中 queries：将只读请求保存到上层状态机，达到quorum时会再告知Leader进行读取，实现了ReadIndex的效果。 1 2 3 4 5 6 7 8 9 10 /// Drives a state machine, taking operations from state_rx and sending results via node_tx. pub struct Driver { node_id: NodeID, state_rx: UnboundedReceiverStream, node_tx: mpsc::UnboundedSender, /// Notify clients when their mutation is applied. notify: HashMap",
  "wordCount" : "7582",
  "inLanguage": "en",
  "datePublished": "0001-01-01T00:00:00Z",
  "dateModified": "0001-01-01T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "Sulv"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://itfischer.space/en/posts/tech/toydb/04-raft-state-machine/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Fischer's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "http://itfischer.space/img/Navigation.svg"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://itfischer.space/en/" accesskey="h" title="Fischer&#39;s Blog (Alt + H)">
                <img src="http://itfischer.space/img/Navigation.svg" alt="" aria-label="logo"
                    height="35">Fischer&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://itfischer.space/en/search" title="Search">
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="http://itfischer.space/en/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="http://itfischer.space/en/posts" title="Posts">
                    <span>Posts</span>
                </a>
            </li>
            <li>
                <a href="http://itfischer.space/en/archives/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="http://itfischer.space/en/tags" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="http://itfischer.space/en/about" title="About">
                    <span>About</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://itfischer.space/en/">Home</a>&nbsp;»&nbsp;<a href="http://itfischer.space/en/posts/">Blog</a>&nbsp;»&nbsp;<a href="http://itfischer.space/en/posts/tech/">Tech</a>&nbsp;»&nbsp;<a href="http://itfischer.space/en/posts/tech/toydb/">toydb</a></div>
    <h1 class="post-title entry-hint-parent">
      04-Raft State Machine
    </h1>
    <div class="post-meta">16 min&nbsp;·&nbsp;Sulv

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#driver" aria-label="Driver">Driver</a></li>
                <li>
                    <a href="#state-trait" aria-label="State Trait">State Trait</a></li>
                <li>
                    <a href="#instruction" aria-label="Instruction">Instruction</a><ul>
                        
                <li>
                    <a href="#%e5%86%99%e8%af%b7%e6%b1%82%e6%89%a7%e8%a1%8c" aria-label="写请求执行">写请求执行</a></li>
                <li>
                    <a href="#%e5%8f%aa%e8%af%bb%e8%af%b7%e6%b1%82%e4%bc%98%e5%8c%96" aria-label="只读请求优化">只读请求优化</a></li>
                <li>
                    <a href="#abort" aria-label="Abort">Abort</a></li>
                <li>
                    <a href="#apply" aria-label="Apply">Apply</a></li></ul>
                </li>
                <li>
                    <a href="#others" aria-label="Others">Others</a><ul>
                        
                <li>
                    <a href="#driver%e5%90%af%e5%8a%a8" aria-label="Driver启动">Driver启动</a></li>
                <li>
                    <a href="#%e4%bf%a1%e6%81%af%e4%bc%a0%e9%80%92" aria-label="信息传递">信息传递</a></li>
                <li>
                    <a href="#follower" aria-label="Follower">Follower</a></li></ul>
                </li>
                <li>
                    <a href="#summary" aria-label="Summary">Summary</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>在正式写这一篇文章之前，原本的规划是在这一部分介绍sql执行引擎，即如何将Raft，Raft状态机，存储引擎组合起来，为SQL的执行去提供支持，但是这一部分又不可避免的牵扯到SQL执行过程，如果全部展示出来，内容将会非常多，思来想去，还是Raft状态机这一部分比较独立，使用了一个Trait屏蔽掉了底层的存储实现，因此就先将这一模块单独拆出来。</p>
<p>在toydb当中，Raft状态机的实现定义于<code>src/raft/state.rs</code>当中。在etcd，对于Raft Package也可以理解成一个状态机，因此，为了方便进行区分，在开头首先声明，在这一章出现的所有状态机的概念都是指构建于Raft上层的状态机，上一章分析的Raft会以Raft模块(Raft Package)来指代。
这里与MIT-6.824有一个非常大的不同是：</p>
<ul>
<li>在MIT-6.824当中，client是与上层状态机进行通信的，命令会先输入给状态机，之后状态机向下创建一条日志，发送给Raft模块去进行共识，当达到quorum共识之后，状态机再给client以回应，告知此次请求执行完成</li>
<li>在toydb当中，Client的请求是直接发送给Raft模块的，在上一章当中，我们可以看到，server从client_rx当中获取到了消息之后，直接调用step交给了Raft模块去处理，Raft模块处理完之后会发送给状态机，状态机进行一些逻辑校验，之后再发送Message给Raft模块，之后由Raft模块将消息回复给Client，所以在Raft模块当中，能够看到很多和ClientRequest，ClientResponse相关的内容。</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>	<span style="color:#007f7f">// 获取client发送的消息，交给Raft模块去处理，这里的client并不是用户的client，而是要执行命令的sql端
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	<span style="color:#fff;font-weight:bold">Some</span>((request, response_tx)) = client_rx.next() =&gt; {
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">let</span> id = Uuid::new_v4().as_bytes().to_vec();
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">let</span> msg = Message{
</span></span><span style="display:flex;"><span>			from: Address::Client,
</span></span><span style="display:flex;"><span>			to: Address::Node(node.id()),
</span></span><span style="display:flex;"><span>			term: <span style="color:#ff0;font-weight:bold">0</span>,
</span></span><span style="display:flex;"><span>			event: Event::ClientRequest{id: id.clone(), request},
</span></span><span style="display:flex;"><span>		};
</span></span><span style="display:flex;"><span>		node = node.step(msg)?;
</span></span><span style="display:flex;"><span>		requests.insert(id, response_tx);
</span></span><span style="display:flex;"><span>	}
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="https://pic-bed-1309931445.cos.ap-nanjing.myqcloud.com/blog/20231228140251.png" alt="channel"  />
</p>
<h2 id="driver">Driver<a hidden class="anchor" aria-hidden="true" href="#driver">#</a></h2>
<p>在这里，toydb当中的Raft状态机更像是一个比较存粹的状态机，从Raft模块当中接收输入(Instruction)，更新自身状态之后，再给Raft模块输出(Messsage)，不会涉及到网络通信部分的内容，不会与Client进行交互，所以状态机基本上就是起到了一个记录的作用，比如，记录当前接收到了那些请求，各个请求的apply的情况，从而确定什么时候该让Raft模块去回应Client，在这一部分定义了一个<code>Driver</code>，用于驱动状态机的执行：</p>
<ul>
<li><code>state_rx</code>用于从Raft模块当中接收信息</li>
<li><code>node_tx</code>用于向Raft模块发送信息</li>
<li><code>notify</code>：用于当某条日志apply之后，通知Raft模块，让其给Client回应，Raft Leader在收到Mutate类型的ClientRequest之后，会进行propose来复制日志，并且向状态机当中发送一条notify：保存在状态机当中</li>
<li><code>queries</code>：将只读请求保存到上层状态机，达到quorum时会再告知Leader进行读取，实现了ReadIndex的效果。</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">/// Drives a state machine, taking operations from state_rx and sending results via node_tx.
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span><span style="color:#fff;font-weight:bold">pub</span> <span style="color:#fff;font-weight:bold">struct</span> Driver {
</span></span><span style="display:flex;"><span>    node_id: NodeID,
</span></span><span style="display:flex;"><span>    state_rx: UnboundedReceiverStream&lt;Instruction&gt;,
</span></span><span style="display:flex;"><span>    node_tx: mpsc::UnboundedSender&lt;Message&gt;,
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">/// Notify clients when their mutation is applied. &lt;index, (client, id)&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    notify: HashMap&lt;Index, (Address, <span style="color:#fff;font-weight:bold">Vec</span>&lt;<span style="color:#fff;font-weight:bold">u8</span>&gt;)&gt;,
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">/// Execute client queries when they receive a quorum. &lt;index, &lt;id, query&gt;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    queries: BTreeMap&lt;Index, BTreeMap&lt;<span style="color:#fff;font-weight:bold">Vec</span>&lt;<span style="color:#fff;font-weight:bold">u8</span>&gt;, Query&gt;&gt;,
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>入口为drive函数，drive函数会不断的从<code>state.rx</code>当中不断获取Instuction，然后调用<code>self.execute</code>来执行：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">pub</span> <span style="color:#fff;font-weight:bold">async</span> <span style="color:#fff;font-weight:bold">fn</span> drive(<span style="color:#fff;font-weight:bold">mut</span> self, <span style="color:#fff;font-weight:bold">mut</span> state: <span style="color:#fff;font-weight:bold">Box</span>&lt;<span style="color:#fff;font-weight:bold">dyn</span> State&gt;) -&gt; <span style="color:#fff;font-weight:bold">Result</span>&lt;()&gt; {
</span></span><span style="display:flex;"><span>        debug!(<span style="color:#0ff;font-weight:bold">&#34;Starting state machine driver at applied index {}&#34;</span>, state.get_applied_index());
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">while</span> <span style="color:#fff;font-weight:bold">let</span> <span style="color:#fff;font-weight:bold">Some</span>(instruction) = self.state_rx.next().<span style="color:#fff;font-weight:bold">await</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> <span style="color:#fff;font-weight:bold">let</span> <span style="color:#fff;font-weight:bold">Err</span>(error) = self.execute(instruction, &amp;<span style="color:#fff;font-weight:bold">mut</span> *state) {
</span></span><span style="display:flex;"><span>                error!(<span style="color:#0ff;font-weight:bold">&#34;Halting state machine due to error: {}&#34;</span>, error);
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">Err</span>(error);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        debug!(<span style="color:#0ff;font-weight:bold">&#34;Stopping state machine driver&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">Ok</span>(())
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></td></tr></table>
</div>
</div><p>在<code>execute()</code>当中，就是根据instruction的类型，去调用不同的函数，那我们只需要弄明白每种Instruction的类型和功能，以及对应的发送位置和响应方式即可：</p>
<h2 id="state-trait">State Trait<a hidden class="anchor" aria-hidden="true" href="#state-trait">#</a></h2>
<p>在介绍Raft模块与Raft状态机交互之前，先来看一下Raft状态机的Trait和实现，Raft状态机是以Trait的形式定义的。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">/// A Raft-managed state machine.
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span><span style="color:#fff;font-weight:bold">pub</span> <span style="color:#fff;font-weight:bold">trait</span> State: <span style="color:#fff;font-weight:bold">Send</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">/// Returns the last applied index from the state machine.
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    <span style="color:#fff;font-weight:bold">fn</span> get_applied_index(&amp;self) -&gt; Index;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">/// Applies a log entry to the state machine. If it returns Error::Internal,
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    <span style="color:#0ff;font-weight:bold">/// the Raft node halts. Any other error is considered applied and returned
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    <span style="color:#0ff;font-weight:bold">/// to the caller.
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    <span style="color:#0ff;font-weight:bold">///
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    <span style="color:#0ff;font-weight:bold">/// The entry may contain a noop command, which is committed by Raft during
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    <span style="color:#0ff;font-weight:bold">/// leader changes. This still needs to be applied to the state machine to
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    <span style="color:#0ff;font-weight:bold">/// properly track the applied index, and returns an empty result.
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    <span style="color:#0ff;font-weight:bold">///
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    <span style="color:#0ff;font-weight:bold">/// TODO: consider using runtime assertions instead of Error::Internal.
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    <span style="color:#fff;font-weight:bold">fn</span> apply(&amp;<span style="color:#fff;font-weight:bold">mut</span> self, entry: Entry) -&gt; <span style="color:#fff;font-weight:bold">Result</span>&lt;<span style="color:#fff;font-weight:bold">Vec</span>&lt;<span style="color:#fff;font-weight:bold">u8</span>&gt;&gt;;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">/// Queries the state machine. All errors are propagated to the caller.
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    <span style="color:#fff;font-weight:bold">fn</span> query(&amp;self, command: <span style="color:#fff;font-weight:bold">Vec</span>&lt;<span style="color:#fff;font-weight:bold">u8</span>&gt;) -&gt; <span style="color:#fff;font-weight:bold">Result</span>&lt;<span style="color:#fff;font-weight:bold">Vec</span>&lt;<span style="color:#fff;font-weight:bold">u8</span>&gt;&gt;;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>而真正的实现在<code>src/sql/engine/raft.rs</code>当中，定义了一个<code>struct State&lt;E&gt;</code>来作为Raft状态机的实现，在其中，只有两个变量：</p>
<ul>
<li><code>last_applied_index</code>用于记录当前应用的最后的日志</li>
<li><code>super::KV&lt;E&gt;</code>是一个MVCC Storage的Wrapper(这一部分在02-MVCC当中已经介绍过)，提供了存储元数据和开启事务的功能。
但是这个struct是具体怎么实现这些功能的，由于牵扯到sql执行的一些内容，并且不进行展开也不会影响到后续的内容，就留到下一章了。</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">/// The Raft state machine for the Raft-based SQL engine, using a KV SQL engine
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span><span style="color:#fff;font-weight:bold">pub</span> <span style="color:#fff;font-weight:bold">struct</span> State&lt;E: storage::engine::Engine&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">/// The underlying KV SQL engine
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    engine: super::KV&lt;E&gt;,
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">/// The last applied index
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    applied_index: <span style="color:#fff;font-weight:bold">u64</span>,
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="instruction">Instruction<a hidden class="anchor" aria-hidden="true" href="#instruction">#</a></h2>
<p>在Raft State Machine当中，Instruction的地位相当于Raft模块当中Message的地位。在这一部分，主要会分析Raft状态机是如何与Raft模块进行交互的，按照Instruction的类型，理顺各类Instruction的发送和处理的方式与时机。功能实现如下：</p>
<ul>
<li>写请求：Notify</li>
<li>只读请求：Query + Vote</li>
<li>应用日志：Apply</li>
<li>终止请求：Abort</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">pub</span> <span style="color:#fff;font-weight:bold">enum</span> Instruction {
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">/// Abort all pending operations, e.g. due to leader change.
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    Abort,
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">/// Apply a log entry.
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    Apply { entry: Entry },
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">/// Notify the given address with the result of applying the entry at the given index.
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    Notify { id: <span style="color:#fff;font-weight:bold">Vec</span>&lt;<span style="color:#fff;font-weight:bold">u8</span>&gt;, address: Address, index: Index },
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">/// Query the state machine when the given term and index has been confirmed by vote.
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    Query { id: <span style="color:#fff;font-weight:bold">Vec</span>&lt;<span style="color:#fff;font-weight:bold">u8</span>&gt;, address: Address, command: <span style="color:#fff;font-weight:bold">Vec</span>&lt;<span style="color:#fff;font-weight:bold">u8</span>&gt;, term: Term, index: Index, quorum: <span style="color:#fff;font-weight:bold">u64</span> },
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">/// Extend the given server status and return it to the given address.
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    Status { id: <span style="color:#fff;font-weight:bold">Vec</span>&lt;<span style="color:#fff;font-weight:bold">u8</span>&gt;, address: Address, status: <span style="color:#fff;font-weight:bold">Box</span>&lt;Status&gt; },
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">/// Votes for queries at the given term and commit index.
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    Vote { term: Term, index: Index, address: Address },
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="写请求执行">写请求执行<a hidden class="anchor" aria-hidden="true" href="#写请求执行">#</a></h3>
<p><code>Driver.notify</code>用于记录客户端的一次写请求，在leader接收到客户端的写请求时(类型为 Mutate)，就会向Raft状态机发送一条<code>Instruction::Notify</code>，将请求记录到状态机当中，等待之后该请求对应的日志Apply了，再告知Leader，让Leader去响应客户端，返回执行结果:</p>
<p><strong>发送</strong></p>
<p>Leader接收到Client发送而来的类型为<code>Request::Mutate</code>的<code>ClientRequest</code>，在Raft模块层面，会调用<code>self.propose()</code>来进行日志复制，在Raft状态机层面，Leader会向Raft状态机发送一条<code>Instruction::Notify</code>来记录请求。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>	<span style="color:#007f7f">// Leader.step()
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	<span style="color:#fff;font-weight:bold">pub</span> <span style="color:#fff;font-weight:bold">fn</span> step(<span style="color:#fff;font-weight:bold">mut</span> self, msg: Message) -&gt; <span style="color:#fff;font-weight:bold">Result</span>&lt;Node&gt; {
</span></span><span style="display:flex;"><span>		Event::ClientRequest { id, request: Request::Mutate(command) } =&gt; {
</span></span><span style="display:flex;"><span>			<span style="color:#fff;font-weight:bold">let</span> index = self.propose(<span style="color:#fff;font-weight:bold">Some</span>(command))?;
</span></span><span style="display:flex;"><span>			self.state_tx.send(Instruction::Notify { id, address: msg.from, index })?;
</span></span><span style="display:flex;"><span>			<span style="color:#fff;font-weight:bold">if</span> self.peers.is_empty() {
</span></span><span style="display:flex;"><span>				self.maybe_commit()?;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span></code></pre></td></tr></table>
</div>
</div><p>在<code>Driver.execute()</code>当中，如果高于目前的appled_index，那么就插入保存，等待之后该条日志apply，否则为出现错误，让Leader告知客户端。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">/// Executes a state machine instruction. 
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    <span style="color:#fff;font-weight:bold">fn</span> execute(&amp;<span style="color:#fff;font-weight:bold">mut</span> self, i: Instruction, state: <span style="color:#fff;font-weight:bold">&amp;</span>mut <span style="color:#fff;font-weight:bold">dyn</span> State) -&gt; <span style="color:#fff;font-weight:bold">Result</span>&lt;()&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">match</span> i {
</span></span><span style="display:flex;"><span>            Instruction::Notify { id, address, index } =&gt; {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span> index &gt; state.get_applied_index() {
</span></span><span style="display:flex;"><span>                    self.notify.insert(index, (address, id));
</span></span><span style="display:flex;"><span>                } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>                    self.send(address, Event::ClientResponse { id, response: <span style="color:#fff;font-weight:bold">Err</span>(Error::Abort) })?;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">Ok</span>(())
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></td></tr></table>
</div>
</div><p>在<code>Leader.step()</code>当中，会处理由Raft状态机发来的<code>Message::ClientResponse</code>，Leader不会做什么处理，直接发送给Client就好，对于其他的Instruction，处理类型也是相同，后面不会再提及。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>	Event::ClientResponse { id, <span style="color:#fff;font-weight:bold">mut</span> response } =&gt; {
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">if</span> <span style="color:#fff;font-weight:bold">let</span> <span style="color:#fff;font-weight:bold">Ok</span>(Response::Status(<span style="color:#fff;font-weight:bold">ref</span> <span style="color:#fff;font-weight:bold">mut</span> status)) = response {
</span></span><span style="display:flex;"><span>			status.server = self.id;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		self.send(Address::Client, Event::ClientResponse { id, response })?;
</span></span><span style="display:flex;"><span>	}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="只读请求优化">只读请求优化<a hidden class="anchor" aria-hidden="true" href="#只读请求优化">#</a></h3>
<p>在Raft的基础实现当中，无论是写请求还是读请求，都需要创建一条日志进行写入，之后执行时按照日志commit的顺序进行执行，从而提供线性一致性。但这样的问题就在于，即便是读请求也需要创建日志并写入，带来了额外的磁盘IO，从而提高系统延迟。</p>
<p>在Raft当中，为了保证线性一致性，需要保证能够读到目前最新的commit_index。如果想对Log Read进行优化，那么就需要想办法绕过写入Log对这个过程，比较常见的两种优化方式是ReadIndex和Lease Read。由于Raft的读写都经过Leader(不考虑Follower Read的优化)，那么只要能够确认当前的Leader身份有效，就可以直接从Leader本地进行读取，为了确认Leader的有效身份，ReadIndex和Lease Read采用了两种不同的方式：</p>
<ul>
<li>ReadIndex:ReadIndex记录收到请求时的commit index，然后通过发送一轮心跳的方式来确认Leader的合法身份，如果能确认收到Quorum数量的响应，那么当前的Leader身份就是合法的，当Leader的apply index &gt;= 之前保存的commit index时，就可以根据commit index去读取。</li>
<li>Lease Read:Lease Read的核心思想是利用了一个选举时间差，当收到Leader心跳信息之后，follower就会重置选举超时时间，那么直到下一次选举超时之前，目前Leader的身份一定是合法的，不会有其他的节点通过选举成为Leader，因此就可以直接读取Leader的commit index。不过Lease Read会受到时钟偏移的影响，一种比较简单的解决方法是将Lease时间设置为比超时时间短一点。(有那么点TrueTime的意思)
如果想进一步了解只读请求优化，可以看这一篇：<a href="http://blog.mrcroxx.com/posts/code-reading/etcdraft-made-simple/6-readonly/#11-log-read">深入浅出etcd/raft —— 0x06 只读请求优化 - 叉鸽 MrCroxx 的博客</a></li>
</ul>
<p>在toydb当中，只读请求的优化采用的是ReadIndex，在<code>Leader.step()</code>当中，会处理Client发送来的<code>Event::ClientRequest</code>类型的请求，其中request类型为<code>Request::Query</code>代表只读请求：</p>
<ol>
<li>Leader首先创建一条<code>Instruction::Query</code>将只读请求记录到状态机当中</li>
<li>之后再发送一条<code>Instruction::Vote</code>来表示记录当前节点确认了Leader的身份</li>
<li>发送Heartbeat，来尝试证明自身为合法的Leader</li>
</ol>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">pub</span> <span style="color:#fff;font-weight:bold">fn</span> step(<span style="color:#fff;font-weight:bold">mut</span> self, msg: Message) -&gt; <span style="color:#fff;font-weight:bold">Result</span>&lt;Node&gt; {
</span></span><span style="display:flex;"><span>		Event::ClientRequest { id, request: Request::Query(command) } =&gt; {
</span></span><span style="display:flex;"><span>			<span style="color:#fff;font-weight:bold">let</span> (commit_index, _) = self.log.get_commit_index();
</span></span><span style="display:flex;"><span>			self.state_tx.send(Instruction::Query {
</span></span><span style="display:flex;"><span>				id,
</span></span><span style="display:flex;"><span>				address: msg.from,
</span></span><span style="display:flex;"><span>				command,
</span></span><span style="display:flex;"><span>				term: self.term,
</span></span><span style="display:flex;"><span>				index: commit_index,
</span></span><span style="display:flex;"><span>				quorum: self.quorum(),
</span></span><span style="display:flex;"><span>			})?;
</span></span><span style="display:flex;"><span>			self.state_tx.send(Instruction::Vote {
</span></span><span style="display:flex;"><span>				term: self.term,
</span></span><span style="display:flex;"><span>				index: commit_index,
</span></span><span style="display:flex;"><span>				address: Address::Node(self.id),
</span></span><span style="display:flex;"><span>			})?;
</span></span><span style="display:flex;"><span>			self.heartbeat()?;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Follower收到了Heartbeat信息之后，先更新自身的commit进度和进行apply，之后会发送一条<code>Message::ConfirmLeader</code>来认可Leader的身份，发送给Leader,<code>Message::ConfirmLeader</code>当中会携带Follower的commit进度，用于给状态机来计算quorum，相当于原本Leader计算commit index。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>    <span style="color:#007f7f">// Follower.step()
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">pub</span> <span style="color:#fff;font-weight:bold">fn</span> step(<span style="color:#fff;font-weight:bold">mut</span> self, msg: Message) -&gt; <span style="color:#fff;font-weight:bold">Result</span>&lt;Node&gt; {
</span></span><span style="display:flex;"><span>		<span style="color:#007f7f">// 先处理commit和apply
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>		<span style="color:#007f7f">// ....
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>		<span style="color:#007f7f">// 确认Leader身份
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>		self.send(msg.from, Event::ConfirmLeader { commit_index, has_committed })?;
</span></span><span style="display:flex;"><span>	}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Leader会统计<code>Message::ConfirmLeader</code>信息，每收到一条就会向状态机发送<code>Message::Vote</code>，状态机会进行记录和计算是否达到quorum。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">pub</span> <span style="color:#fff;font-weight:bold">fn</span> step(<span style="color:#fff;font-weight:bold">mut</span> self, msg: Message) -&gt; <span style="color:#fff;font-weight:bold">Result</span>&lt;Node&gt; {	
</span></span><span style="display:flex;"><span>		<span style="color:#007f7f">// A follower received one of our heartbeats and confirms that we
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>		<span style="color:#007f7f">// are its leader. If it doesn&#39;t have the commit index in its local
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>		<span style="color:#007f7f">// log, replicate the log to it.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>		Event::ConfirmLeader { commit_index, has_committed } =&gt; {
</span></span><span style="display:flex;"><span>			<span style="color:#fff;font-weight:bold">let</span> from = msg.from.unwrap();
</span></span><span style="display:flex;"><span>			<span style="color:#007f7f">// 与上层状态机进行交互
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>			self.state_tx.send(Instruction::Vote {
</span></span><span style="display:flex;"><span>				term: msg.term,
</span></span><span style="display:flex;"><span>				index: commit_index,
</span></span><span style="display:flex;"><span>				address: msg.from,
</span></span><span style="display:flex;"><span>			})?;
</span></span><span style="display:flex;"><span>			<span style="color:#fff;font-weight:bold">if</span> !has_committed {
</span></span><span style="display:flex;"><span>				self.send_log(from)?;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span></code></pre></td></tr></table>
</div>
</div><p>在状态机当中，只读请求使用的是一个嵌套的BTreeMap管理的，对应<code>&lt;index, &lt;id, query&gt;&gt;</code>,表示在当前的commit index下，都有哪些请求，这里的id是由Client发送而来的，表示请求的唯一性ID，而不是NodeID。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">struct</span> Query {
</span></span><span style="display:flex;"><span>    id: <span style="color:#fff;font-weight:bold">Vec</span>&lt;<span style="color:#fff;font-weight:bold">u8</span>&gt;,
</span></span><span style="display:flex;"><span>    term: Term,
</span></span><span style="display:flex;"><span>    address: Address,
</span></span><span style="display:flex;"><span>    command: <span style="color:#fff;font-weight:bold">Vec</span>&lt;<span style="color:#fff;font-weight:bold">u8</span>&gt;,
</span></span><span style="display:flex;"><span>    quorum: <span style="color:#fff;font-weight:bold">u64</span>,
</span></span><span style="display:flex;"><span>    votes: HashSet&lt;Address&gt;,
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">pub</span> <span style="color:#fff;font-weight:bold">struct</span> Driver {
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#0ff;font-weight:bold">/// Execute client queries when they receive a quorum. &lt;index, &lt;id, query&gt;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    queries: BTreeMap&lt;Index, BTreeMap&lt;<span style="color:#fff;font-weight:bold">Vec</span>&lt;<span style="color:#fff;font-weight:bold">u8</span>&gt;, Query&gt;&gt;,
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">fn</span> execute(&amp;<span style="color:#fff;font-weight:bold">mut</span> self, i: Instruction, state: <span style="color:#fff;font-weight:bold">&amp;</span>mut <span style="color:#fff;font-weight:bold">dyn</span> State) -&gt; <span style="color:#fff;font-weight:bold">Result</span>&lt;()&gt; {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		Instruction::Query { id, address, command, index, term, quorum } =&gt; {
</span></span><span style="display:flex;"><span>			self.queries.entry(index).or_default().insert(
</span></span><span style="display:flex;"><span>				id.clone(),
</span></span><span style="display:flex;"><span>				Query { id, term, address, command, quorum, votes: HashSet::new() },
</span></span><span style="display:flex;"><span>			);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span></code></pre></td></tr></table>
</div>
</div><p>在状态机收到了<code>Instruction::Vote</code>之后，分别调用了两个函数：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">/// Executes a state machine instruction. 
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    <span style="color:#fff;font-weight:bold">fn</span> execute(&amp;<span style="color:#fff;font-weight:bold">mut</span> self, i: Instruction, state: <span style="color:#fff;font-weight:bold">&amp;</span>mut <span style="color:#fff;font-weight:bold">dyn</span> State) -&gt; <span style="color:#fff;font-weight:bold">Result</span>&lt;()&gt; {
</span></span><span style="display:flex;"><span>        debug!(<span style="color:#0ff;font-weight:bold">&#34;Executing {:?}&#34;</span>, i);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">match</span> i {
</span></span><span style="display:flex;"><span>            Instruction::Vote { term, index, address } =&gt; {
</span></span><span style="display:flex;"><span>                self.query_vote(term, index, address);
</span></span><span style="display:flex;"><span>                self.query_execute(state)?;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">Ok</span>(())
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></td></tr></table>
</div>
</div><p>在<code>self.query_vote</code>当中会根据<code>Instruction::Vote</code>当中的commit index去记录投票，只能对<code>commit_index &lt;= Vote.commit_index</code>的Query进行投票。这样，只有Leader的apply_index &gt;= commit_index之后才能过通过quorum检查。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">/// Votes for queries up to and including a given commit index for a term by an address.
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    <span style="color:#fff;font-weight:bold">fn</span> query_vote(&amp;<span style="color:#fff;font-weight:bold">mut</span> self, term: Term, commit_index: Index, address: Address) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> (_, queries) <span style="color:#fff;font-weight:bold">in</span> self.queries.range_mut(..=commit_index) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">for</span> (_, query) <span style="color:#fff;font-weight:bold">in</span> queries.iter_mut() {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span> term &gt;= query.term {
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// 使用HashSet记录保证同一个节点(使用Address表示)，只能对同一个commit_index投票一次
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                    query.votes.insert(address);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></td></tr></table>
</div>
</div><p>在<code>self.query_execute</code>当中，会获取出所有<code>index &lt;= applied_index</code>的只读请求，然后调用状态机的实现来执行只读请求，然后告知Raft模块的Leader去响应Client：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">/// Executes any queries that are ready.
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    <span style="color:#fff;font-weight:bold">fn</span> query_execute(&amp;<span style="color:#fff;font-weight:bold">mut</span> self, state: <span style="color:#fff;font-weight:bold">&amp;</span>mut <span style="color:#fff;font-weight:bold">dyn</span> State) -&gt; <span style="color:#fff;font-weight:bold">Result</span>&lt;()&gt; {
</span></span><span style="display:flex;"><span>	    <span style="color:#007f7f">// self.query_ready()会获取出所有的达到quorum并且index &lt;= applied_index的Query，并且从self.queries当中移除
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">for</span> query <span style="color:#fff;font-weight:bold">in</span> self.query_ready(state.get_applied_index()) {
</span></span><span style="display:flex;"><span>            debug!(<span style="color:#0ff;font-weight:bold">&#34;Executing query {:?}&#34;</span>, query.command);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">let</span> result = state.query(query.command);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> <span style="color:#fff;font-weight:bold">let</span> <span style="color:#fff;font-weight:bold">Err</span>(error @ Error::Internal(_)) = result {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">Err</span>(error);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            self.send(
</span></span><span style="display:flex;"><span>                query.address,
</span></span><span style="display:flex;"><span>                Event::ClientResponse { id: query.id, response: result.map(Response::Query) },
</span></span><span style="display:flex;"><span>            )?
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">Ok</span>(())
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="abort">Abort<a hidden class="anchor" aria-hidden="true" href="#abort">#</a></h3>
<p>当Client发送了一条请求之后，Raft模块就会将请求保存到Raft状态机当中，之后等待日志commit并apply了，再给Client响应。</p>
<p>如果当前的Leader收到了更高的Term，那么就会退位，不是Leader自然就不能够处理请求，因此存在状态机当中还未处理完的请求就需要全部放弃，这一部分逻辑定义在<code>leader.become_follower()</code>当中：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>		<span style="color:#007f7f">// If we receive a message for a future term, become a leaderless
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	<span style="color:#007f7f">// follower in it and step the message. If the message is a Heartbeat or
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	<span style="color:#007f7f">// AppendEntries from the leader, stepping it will follow the leader.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	<span style="color:#fff;font-weight:bold">if</span> msg.term &gt; self.term {
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">return</span> self.become_follower(msg.term)?.step(msg);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">/// Transforms the leader into a follower. This can only happen if we find a
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    <span style="color:#0ff;font-weight:bold">/// new term, so we become a leaderless follower.
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    <span style="color:#fff;font-weight:bold">fn</span> become_follower(<span style="color:#fff;font-weight:bold">mut</span> self, term: Term) -&gt; <span style="color:#fff;font-weight:bold">Result</span>&lt;RoleNode&lt;Follower&gt;&gt; {
</span></span><span style="display:flex;"><span>        assert!(term &gt;= self.term, <span style="color:#0ff;font-weight:bold">&#34;Term regression {} -&gt; {}&#34;</span>, self.term, term);
</span></span><span style="display:flex;"><span>        assert!(term &gt; self.term, <span style="color:#0ff;font-weight:bold">&#34;Can only become follower in later term&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        info!(<span style="color:#0ff;font-weight:bold">&#34;Discovered new term {}&#34;</span>, term);
</span></span><span style="display:flex;"><span>        self.term = term;
</span></span><span style="display:flex;"><span>        self.log.set_term(term, <span style="color:#fff;font-weight:bold">None</span>)?;
</span></span><span style="display:flex;"><span>        self.state_tx.send(Instruction::Abort)?;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">Ok</span>(self.become_role(Follower::new(<span style="color:#fff;font-weight:bold">None</span>, <span style="color:#fff;font-weight:bold">None</span>)))
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></td></tr></table>
</div>
</div><p>在Raft状态机当中，收到了旧Leader发送的<code>Instruction::Abort</code>之后，在<code>execute()</code>当中就会调用<code>notify_abort()</code>和<code>query_abort()</code>，将原本用于存储请求的notify重置，同时清除用于保存只读请求的Query，并且再封装一条Message发送回已经退位的Leader，让其告知Client请求已经被取消执行。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">fn</span> execute(&amp;<span style="color:#fff;font-weight:bold">mut</span> self, i: Instruction, state: <span style="color:#fff;font-weight:bold">&amp;</span>mut <span style="color:#fff;font-weight:bold">dyn</span> State) -&gt; <span style="color:#fff;font-weight:bold">Result</span>&lt;()&gt; {
</span></span><span style="display:flex;"><span>        debug!(<span style="color:#0ff;font-weight:bold">&#34;Executing {:?}&#34;</span>, i);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">match</span> i {
</span></span><span style="display:flex;"><span>            Instruction::Abort =&gt; {
</span></span><span style="display:flex;"><span>                self.notify_abort()?;
</span></span><span style="display:flex;"><span>                self.query_abort()?;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#007f7f">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">/// Aborts all pending notifications.
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    <span style="color:#fff;font-weight:bold">fn</span> notify_abort(&amp;<span style="color:#fff;font-weight:bold">mut</span> self) -&gt; <span style="color:#fff;font-weight:bold">Result</span>&lt;()&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> (_, (address, id)) <span style="color:#fff;font-weight:bold">in</span> std::mem::take(&amp;<span style="color:#fff;font-weight:bold">mut</span> self.notify) {
</span></span><span style="display:flex;"><span>            self.send(address, Event::ClientResponse { id, response: <span style="color:#fff;font-weight:bold">Err</span>(Error::Abort) })?;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">Ok</span>(())
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">/// Aborts all pending queries.
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    <span style="color:#fff;font-weight:bold">fn</span> query_abort(&amp;<span style="color:#fff;font-weight:bold">mut</span> self) -&gt; <span style="color:#fff;font-weight:bold">Result</span>&lt;()&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> (_, queries) <span style="color:#fff;font-weight:bold">in</span> std::mem::take(&amp;<span style="color:#fff;font-weight:bold">mut</span> self.queries) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">for</span> (id, query) <span style="color:#fff;font-weight:bold">in</span> queries {
</span></span><span style="display:flex;"><span>                self.send(
</span></span><span style="display:flex;"><span>                    query.address,
</span></span><span style="display:flex;"><span>                    Event::ClientResponse { id, response: <span style="color:#fff;font-weight:bold">Err</span>(Error::Abort) },
</span></span><span style="display:flex;"><span>                )?;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">Ok</span>(())
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="apply">Apply<a hidden class="anchor" aria-hidden="true" href="#apply">#</a></h3>
<p>当一条日志在Raft模块当中得到了大多数的共识之后，就视其为<code>commit</code>，而<code>commit</code>了的日志会<code>Apply</code>到Raft状态机，此时代表完成了一次写入，写入结果对外可见。在toydb当中，<code>Commit</code>和<code>Apply</code>的动作是连贯的，一旦获取到了新的commit_index，就会立即向状态机发送进行apply的commit entry:</p>
<ul>
<li>Leader通过自身进行计算</li>
<li>Follower通过Heartbeat得知当前的commit进度，再结合自身的日志复制进度得出一个commit_index</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>	<span style="color:#007f7f">// Leader
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">if</span> commit_index &gt; prev_commit_index {
</span></span><span style="display:flex;"><span>		self.log.commit(commit_index)?;
</span></span><span style="display:flex;"><span>		<span style="color:#007f7f">// TODO: Move application elsewhere, but needs access to applied index.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>		<span style="color:#fff;font-weight:bold">let</span> <span style="color:#fff;font-weight:bold">mut</span> scan = self.log.scan((prev_commit_index + <span style="color:#ff0;font-weight:bold">1</span>)..=commit_index)?;
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">while</span> <span style="color:#fff;font-weight:bold">let</span> <span style="color:#fff;font-weight:bold">Some</span>(entry) = scan.next().transpose()? {
</span></span><span style="display:flex;"><span>			self.state_tx.send(Instruction::Apply { entry })?;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">// Follower
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	Event::Heartbeat { commit_index, commit_term } =&gt; {
</span></span><span style="display:flex;"><span>		<span style="color:#007f7f">// ....
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#007f7f">// Advance commit index and apply entries if possible.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>		<span style="color:#fff;font-weight:bold">let</span> has_committed = self.log.has(commit_index, commit_term)?;
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">let</span> (old_commit_index, _) = self.log.get_commit_index();
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">if</span> has_committed &amp;&amp; commit_index &gt; old_commit_index {
</span></span><span style="display:flex;"><span>			self.log.commit(commit_index)?;
</span></span><span style="display:flex;"><span>			<span style="color:#fff;font-weight:bold">let</span> <span style="color:#fff;font-weight:bold">mut</span> scan = self.log.scan((old_commit_index + <span style="color:#ff0;font-weight:bold">1</span>)..=commit_index)?;
</span></span><span style="display:flex;"><span>			<span style="color:#fff;font-weight:bold">while</span> <span style="color:#fff;font-weight:bold">let</span> <span style="color:#fff;font-weight:bold">Some</span>(entry) = scan.next().transpose()? {
</span></span><span style="display:flex;"><span>				self.state_tx.send(Instruction::Apply { entry })?;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		self.send(msg.from, Event::ConfirmLeader { commit_index, has_committed })?;
</span></span><span style="display:flex;"><span>	}
</span></span></code></pre></td></tr></table>
</div>
</div><p>当Raft状态机接收到了<code>Instruction::Apply</code>之后，调用定义在<code>sql/engine/raft</code>当中Raft状态机的实现来进行Apply，然后调用<code>self.notify_applyed()</code>，将Apply的情况通知给下层的Raft模块，此时Raft模块就可以给Client回应了。</p>
<p>并且某些只读请求也可能因为apply_index的推进，从而可以执行了，调用<code>query_execute</code>尝试执行。<code>query_execute()</code>在上文已经介绍过了，会获取所有达到index &lt;= apply_index的Query尝试执行。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">fn</span> execute(&amp;<span style="color:#fff;font-weight:bold">mut</span> self, i: Instruction, state: <span style="color:#fff;font-weight:bold">&amp;</span>mut <span style="color:#fff;font-weight:bold">dyn</span> State) -&gt; <span style="color:#fff;font-weight:bold">Result</span>&lt;()&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">match</span> i {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            Instruction::Apply { entry } =&gt; {
</span></span><span style="display:flex;"><span>                self.apply(state, entry)?;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        <span style="color:#0ff;font-weight:bold">/// ...
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">/// Applies an entry to the state machine.
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    <span style="color:#fff;font-weight:bold">pub</span> <span style="color:#fff;font-weight:bold">fn</span> apply(&amp;<span style="color:#fff;font-weight:bold">mut</span> self, state: <span style="color:#fff;font-weight:bold">&amp;</span>mut <span style="color:#fff;font-weight:bold">dyn</span> State, entry: Entry) -&gt; <span style="color:#fff;font-weight:bold">Result</span>&lt;Index&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// Apply the command.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        debug!(<span style="color:#0ff;font-weight:bold">&#34;Applying {:?}&#34;</span>, entry);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">match</span> state.apply(entry) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">Err</span>(error @ Error::Internal(_)) =&gt; <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">Err</span>(error),
</span></span><span style="display:flex;"><span>            result =&gt; self.notify_applied(state.get_applied_index(), result)?,
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// Try to execute any pending queries, since they may have been submitted for a
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#007f7f">// commit_index which hadn&#39;t been applied yet.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        self.query_execute(state)?;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">Ok</span>(state.get_applied_index())
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">/// Notifies a client about an applied log entry, if any.
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    <span style="color:#fff;font-weight:bold">fn</span> notify_applied(&amp;<span style="color:#fff;font-weight:bold">mut</span> self, index: Index, result: <span style="color:#fff;font-weight:bold">Result</span>&lt;<span style="color:#fff;font-weight:bold">Vec</span>&lt;<span style="color:#fff;font-weight:bold">u8</span>&gt;&gt;) -&gt; <span style="color:#fff;font-weight:bold">Result</span>&lt;()&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> <span style="color:#fff;font-weight:bold">let</span> <span style="color:#fff;font-weight:bold">Some</span>((to, id)) = self.notify.remove(&amp;index) {
</span></span><span style="display:flex;"><span>            self.send(to, Event::ClientResponse { id, response: result.map(Response::Mutate) })?;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">Ok</span>(())
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="others">Others<a hidden class="anchor" aria-hidden="true" href="#others">#</a></h2>
<p>在文章的最后，再补充一些零散的内容</p>
<h3 id="driver启动">Driver启动<a hidden class="anchor" aria-hidden="true" href="#driver启动">#</a></h3>
<p>Driver用于驱动状态机，调用<code>Driver.drive()</code>之后，就会不断处理由Raft模块发送而来的<code>Instruction</code>，<code>Driver.drive()</code>会在<code>Node.new()</code>当中调用，随着Node的创建一同启动</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">impl</span> Node {
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">/// Creates a new Raft node, starting as a follower, or leader if no peers.
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    <span style="color:#fff;font-weight:bold">pub</span> <span style="color:#fff;font-weight:bold">async</span> <span style="color:#fff;font-weight:bold">fn</span> new(
</span></span><span style="display:flex;"><span>        id: NodeID,
</span></span><span style="display:flex;"><span>        peers: HashSet&lt;NodeID&gt;,
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">mut</span> log: Log,
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">mut</span> state: <span style="color:#fff;font-weight:bold">Box</span>&lt;<span style="color:#fff;font-weight:bold">dyn</span> State&gt;,
</span></span><span style="display:flex;"><span>        node_tx: mpsc::UnboundedSender&lt;Message&gt;,
</span></span><span style="display:flex;"><span>    ) -&gt; <span style="color:#fff;font-weight:bold">Result</span>&lt;Self&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">let</span> (state_tx, state_rx) = mpsc::unbounded_channel();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// Driver用于和Raft状态机进行交互，启动状态机运行
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">let</span> <span style="color:#fff;font-weight:bold">mut</span> driver = Driver::new(id, state_rx, node_tx.clone());
</span></span><span style="display:flex;"><span>        driver.apply_log(&amp;<span style="color:#fff;font-weight:bold">mut</span> *state, &amp;<span style="color:#fff;font-weight:bold">mut</span> log)?;
</span></span><span style="display:flex;"><span>        tokio::spawn(driver.drive(state));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">let</span> (term, voted_for) = log.get_term()?;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">let</span> <span style="color:#fff;font-weight:bold">mut</span> node = RoleNode {
</span></span><span style="display:flex;"><span>            id,
</span></span><span style="display:flex;"><span>            peers,
</span></span><span style="display:flex;"><span>            term,
</span></span><span style="display:flex;"><span>            log,
</span></span><span style="display:flex;"><span>            node_tx,
</span></span><span style="display:flex;"><span>            state_tx,
</span></span><span style="display:flex;"><span>            role: Follower::new(<span style="color:#fff;font-weight:bold">None</span>, voted_for),
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> node.peers.is_empty() {
</span></span><span style="display:flex;"><span>            info!(<span style="color:#0ff;font-weight:bold">&#34;No peers specified, starting as leader&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// If we didn&#39;t vote for ourself in the persisted term, bump the
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#007f7f">// term and vote for ourself to ensure we have a valid leader term.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">if</span> voted_for != <span style="color:#fff;font-weight:bold">Some</span>(id) {
</span></span><span style="display:flex;"><span>                node.term += <span style="color:#ff0;font-weight:bold">1</span>;
</span></span><span style="display:flex;"><span>                node.log.set_term(node.term, <span style="color:#fff;font-weight:bold">Some</span>(id))?;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">let</span> (last_index, _) = node.log.get_last_index();
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">Ok</span>(node.become_role(Leader::new(HashSet::new(), last_index)).into())
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">Ok</span>(node.into())
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="信息传递">信息传递<a hidden class="anchor" aria-hidden="true" href="#信息传递">#</a></h3>
<p>Raft状态机和Raft模块之间使用<code>Message</code>和<code>Instruction</code>进行交互，Raft模块向Raft状态机发送<code>Instruction</code>，Raft状态机回应<code>Message</code>给Raft模块，Message的发送定义如下：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">/// Sends a message.
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    <span style="color:#0ff;font-weight:bold">/// 状态机使用node_tx进行消息发送，那么对应的接收端就是node_rx
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    <span style="color:#fff;font-weight:bold">fn</span> send(&amp;self, to: Address, event: Event) -&gt; <span style="color:#fff;font-weight:bold">Result</span>&lt;()&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// TODO: This needs to use the correct term.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">let</span> msg = Message { from: Address::Node(self.node_id), to, term: <span style="color:#ff0;font-weight:bold">0</span>, event };
</span></span><span style="display:flex;"><span>        debug!(<span style="color:#0ff;font-weight:bold">&#34;Sending {:?}&#34;</span>, msg);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">Ok</span>(self.node_tx.send(msg)?)
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="follower">Follower<a hidden class="anchor" aria-hidden="true" href="#follower">#</a></h3>
<p>如6.824一样，Follower当然也是有状态机的，只不过当中的逻辑非常简单，就没有额外介绍，Follower只需要不断的接受日志，然后更新commit_index然后向状态机发送<code>Instruction::Apply</code>就好，代码在上文也有展示。</p>
<h2 id="summary">Summary<a hidden class="anchor" aria-hidden="true" href="#summary">#</a></h2>
<p>在toydb当中，相比于MIT-6.824实现了一个比较纯粹的状态机，只需要以Raft模块发送的<code>Instruction</code>作为输入，内部进行状态更新，之后以<code>Message</code>为输出即可，主要起到了一个记录和逻辑判断，通知的作用，不会进行对外的网络交互。Leader在状态机的指示下去回应Client，完成一条请求的执行。</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="http://itfischer.space/en/posts/tech/toydb/03-raft/">
    <span class="title">« Prev</span>
    <br>
    <span>03-Raft</span>
  </a>
  <a class="next" href="http://itfischer.space/en/posts/tech/toydb/05-sql-engine/">
    <span class="title">Next »</span>
    <br>
    <span>05-SQL Engine</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 04-Raft State Machine on x"
            href="https://x.com/intent/tweet/?text=04-Raft%20State%20Machine&amp;url=http%3a%2f%2fitfischer.space%2fen%2fposts%2ftech%2ftoydb%2f04-raft-state-machine%2f&amp;hashtags=">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 04-Raft State Machine on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http%3a%2f%2fitfischer.space%2fen%2fposts%2ftech%2ftoydb%2f04-raft-state-machine%2f&amp;title=04-Raft%20State%20Machine&amp;summary=04-Raft%20State%20Machine&amp;source=http%3a%2f%2fitfischer.space%2fen%2fposts%2ftech%2ftoydb%2f04-raft-state-machine%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 04-Raft State Machine on reddit"
            href="https://reddit.com/submit?url=http%3a%2f%2fitfischer.space%2fen%2fposts%2ftech%2ftoydb%2f04-raft-state-machine%2f&title=04-Raft%20State%20Machine">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 04-Raft State Machine on facebook"
            href="https://facebook.com/sharer/sharer.php?u=http%3a%2f%2fitfischer.space%2fen%2fposts%2ftech%2ftoydb%2f04-raft-state-machine%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 04-Raft State Machine on whatsapp"
            href="https://api.whatsapp.com/send?text=04-Raft%20State%20Machine%20-%20http%3a%2f%2fitfischer.space%2fen%2fposts%2ftech%2ftoydb%2f04-raft-state-machine%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 04-Raft State Machine on telegram"
            href="https://telegram.me/share/url?text=04-Raft%20State%20Machine&amp;url=http%3a%2f%2fitfischer.space%2fen%2fposts%2ftech%2ftoydb%2f04-raft-state-machine%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 04-Raft State Machine on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=04-Raft%20State%20Machine&u=http%3a%2f%2fitfischer.space%2fen%2fposts%2ftech%2ftoydb%2f04-raft-state-machine%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2024 <a href="http://itfischer.space/en/">Fischer&#39;s Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
