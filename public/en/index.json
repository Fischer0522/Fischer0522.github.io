[{"content":"Intro ä»€ä¹ˆæ˜¯CURP Curpæ˜¯ä¸€ç§æ–°çš„åˆ†å¸ƒå¼å…±è¯†ç®—æ³•ï¼Œcurpçš„æå‡ºæ˜¯é’ˆå¯¹äºè·¨åŸŸç­‰é«˜ç½‘ç»œå»¶è¿Ÿåœºæ™¯ï¼Œä¼ ç»Ÿçš„raftå’Œpaxosç­‰å…±è¯†ç®—æ³•éœ€è¦ä¸¤ä¸ªRTTï¼Œåœ¨é«˜ç½‘ç»œå»¶è¿Ÿçš„åœºæ™¯ä¸‹ï¼Œä¸¤ä¸ªRTTå¯¹ç³»ç»Ÿæ¥è¯´æ˜¯éš¾ä»¥å¿å—çš„ï¼Œç½‘ç»œé€šä¿¡ä¼šæˆä¸ºç³»ç»Ÿçš„ç“¶é¢ˆã€‚\nä¸ºäº†è§£å†³è¯¥é—®é¢˜ï¼ŒCURPæœŸæœ›åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œé€šè¿‡ä¸€ä¸ªRTTæ¥å®Œæˆï¼Œè¿™ä¸»è¦åŸºäºä¸¤ç‚¹èƒŒæ™¯ï¼š\nåœ¨è¯·æ±‚ä¸­ï¼Œå„ä¸ªè¯·æ±‚ä¹‹é—´é€šå¸¸æ˜¯äº’ä¸å†²çªçš„ï¼Œä¾‹å¦‚ set a =1 å’Œ set b = 2, å¯¹äºåŒä¸€ä¸ªkeyçš„é‡å¤æ€§è¯»å†™æ˜¯æ¯”è¾ƒå°‘è§çš„ ç³»ç»Ÿå¹¶ä¸éœ€è¦å¯¹æ‰€æœ‰è¯·æ±‚å»ºç«‹ä¸€ä¸ªå…¨å±€çš„é¡ºåºï¼Œç›¸å¯¹çš„ï¼Œåªéœ€è¦å¯¹äºäº’ç›¸å†²çªçš„keyå»ºç«‹èµ·ä¸€ä¸ªå±€éƒ¨é¡ºåºå³å¯ å¦‚æœæƒ³è¿›ä¸€æ­¥äº†è§£CURPï¼Œæ¬¢è¿é˜…è¯»ç¬”è€…çš„å¦ä¸€ç¯‡æ–‡ç« ï¼š zhuanlan.zhihu.com/p/692464275 ä¸ºä»€ä¹ˆæ˜¯ä» 0.5 åˆ° 1 CURPæ˜¯éä¾µå…¥æ€§çš„ï¼Œå³curpåªæ˜¯åœ¨åŸæœ¬çš„å…±è¯†ç³»ç»Ÿçš„åŸºç¡€ä¸Šï¼Œæä¾›ä¸€å¥—é¢å¤–çš„é€»è¾‘ï¼Œæ¥åŠ é€ŸåŸæœ¬çš„å…±è¯†ç®—æ³•ï¼Œåœ¨curpåŸæ–‡ä¸­ï¼Œé€‰æ‹©çš„æ˜¯ä½¿ç”¨primary-backupæ¶æ„æ¥ä½œä¸ºåŸºç¡€ï¼Œè€Œåœ¨CURPä½œè€…åœ¨phDè®ºæ–‡ä¸­ï¼Œæ‰©å±•äº†CURPï¼Œæå‡ºäº†CURP-Qï¼Œå…¶æ„å»ºäºå¦‚Raftï¼ŒPaxosç­‰Leader-Followerå…±è¯†ç®—æ³•ä¸Šã€‚\nè€Œetcd/raftæ˜¯ç›®å‰å·¥ä¸šç•Œæ¯”è¾ƒæˆç†Ÿçš„raftå®ç°ï¼Œå…¶å°†raftæŠ½è±¡æˆçŠ¶æ€æœºï¼Œéå¸¸åœ°ç®€å•æ˜“ç”¨ã€‚åŒæ—¶ï¼Œå…¶å®ç°äº†å¦‚check quorum, leader lease prevote æ‰¹å¤„ç†ï¼Œæµæ°´çº¿å‘é€äº†ç­‰ä¼˜åŒ–ï¼Œæ€§èƒ½æœ‰åŸºç¡€ä¿è¯ã€‚å› æ­¤ï¼Œåœ¨æœ¬æ–‡ä¸­ï¼Œç¬”è€…é€‰æ‹©äº†etcd/raftï¼Œå……å½“CURPçš„slow pathï¼Œå†æ¬¡åŸºç¡€ä¸Šï¼Œæ„å»ºäº†CURPã€‚\nCURP Server ectd/raftä»¥åŠå¦‚ä½•ä¸raftäº¤äº’å·²ç»åœ¨ä¸Šä¸€ç« é˜è¿°ï¼Œå› æ­¤åœ¨è¿™é‡Œå°†é‡ç‚¹æ”¾åœ¨CURP Serverçš„çŠ¶æ€æœºä¸Šã€‚CURPçŠ¶æ€æœºçš„è®¾è®¡å‚è€ƒäº† 6.824 å’Œ Xlineã€‚çŠ¶æ€æœºè´Ÿè´£æ¥æ”¶ç½‘ç»œè¯·æ±‚ï¼Œä¸clientå®Œæˆäº¤äº’ã€‚éšåå°†å…¶å‘é€ç»™raftå®Œæˆproposeï¼ŒåŒæ—¶CURPçŠ¶æ€æœºè¿˜è¦ç»´æŠ¤ä¸€ä¸ªkv storeï¼Œå­˜å‚¨å·²ç»commitçš„å†…å®¹ã€‚\nçŠ¶æ€æœºå®šä¹‰å¦‚ä¸‹ï¼Œä¸»è¦åŒ…æ‹¬ï¼š\nKVStoreï¼šå­˜å‚¨å·²ç»commitçš„å†…å®¹ï¼Œè¿™é‡Œé€‰æ‹©äº†boltdbä½œä¸ºæŒä¹…åŒ–å®ç° Witnessï¼šCURPçš„é‡è¦æœºåˆ¶ï¼Œåœ¨followerä¸Šè¿ä½œï¼Œç”¨äºæš‚å­˜æœªæäº¤çš„è¯·æ±‚ä»¥è¿›è¡Œå†²çªæ£€æµ‹ï¼Œç”±äºæ²¡æœ‰å®ç°recoveryï¼Œå› æ­¤è¿™é‡Œç›´æ¥ä½¿ç”¨mapå­˜å‚¨ CommandBoardï¼šè®°å½•ç›®å‰æ¥æ”¶åˆ°çš„è¯·æ±‚ï¼Œå¹¶åœ¨é€‚å½“çš„æ—¶æœºå“åº”Clientç»“æœ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 type StateMachine struct { NodeId int proposeC chan\u0026lt;- string // channel for proposing updates mu sync.RWMutex // kvStore map[string]string // current committed key-value pairs KVStore *xkv.KVStore commandBoard *command.CommandBoard snapshotter *snap.Snapshotter raftState raft.StateType fastPath chan *curp_proto.CurpClientCommand slowPath chan *curp_proto.CurpClientCommand // both fast and slow path will execute commands,this set is used to avoid executing the same command twice commandSet map[command.ProposeId]struct{} witness witness.Witness stateChangeC chan raft.StateType } Witness Witnessæœºåˆ¶æ˜¯CURPçš„æ ¸å¿ƒï¼Œç”¨äºæä¾›å†²çªæ£€æµ‹åŠŸèƒ½ï¼Œè¿™é‡Œçš„å®ç°éå¸¸ç®€å•ï¼Œä»…ä»…åªä½¿ç”¨mapå­˜å‚¨+Mutexå¹¶å‘æ§åˆ¶ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š\n1 2 3 4 type Witness struct { mu sync.Mutex commandMap map[string]map[command.ProposeId]*curp_proto.CurpClientCommand } ç›®å‰å®ç°çš„å†²çªæ£€æµ‹çš„ç­–ç•¥éå¸¸ç®€å•ï¼Œä»…æ”¯æŒkvå±‚é¢ï¼Œå³å¯¹äºåŒä¸€æ¡keyï¼Œå†™-å†™å’Œè¯»-å†™è¿™ä¸¤ç§æƒ…å†µæ˜¯å†²çªçš„ï¼Œåœ¨æ’å…¥ä¸€æ¡è®°å½•æ—¶ï¼Œå¦‚æœæ£€æµ‹åˆ°å†²çªï¼Œé‚£ä¹ˆå°±ç›´æ¥è¿”å›falseï¼Œå¦åˆ™å°†å…¶ä¿å­˜åˆ°mapå½“ä¸­ã€‚\nWitnessä¸­çš„æ•°æ®åº”å½“è¿›è¡ŒæŒä¹…åŒ–ä¿å­˜ï¼Œä»¥ç”¨äºåœ¨å®•æœºåæ¢å¤æ•°æ®ï¼Œç”±äºWitnessä¸­æ•°æ®æ˜¯æš‚å­˜çš„ï¼Œåœ¨commitä¹‹åå°±ä¼šåˆ é™¤ï¼Œå› æ­¤curpåŸæ–‡ä¸­æå‡ºäº†å­˜å‚¨åœ¨NVMç­‰ç¡¬ä»¶ä¸Šä¼šæ›´åˆé€‚ã€‚è¿™é‡Œç”±äºæš‚æ—¶æ²¡æœ‰å®ç°recoveryæœºåˆ¶ï¼Œæ‰€ä»¥ç›®å‰æ˜¯ç›´æ¥ä½¿ç”¨mapå­˜å‚¨ã€‚\nCommandBoard CmdBoardçš„ä½œç”¨ä¸ºè®°å½•æ¥æ”¶åˆ°çš„è¯·æ±‚ï¼Œç­‰å¾…è¯·æ±‚æ‰§è¡Œå®Œæˆï¼Œè€Œå…·ä½“çš„æ‰§è¡Œåˆ™äº¤ç»™ CommandWorker æ¥å®Œæˆï¼Œå‰å°æ¥æ”¶è¯·æ±‚çš„çº¿ç¨‹åªéœ€è¦é€šè¿‡CommandBoardæ¥è·å–ç»“æœï¼Œå¹¶ç»“æœå“åº”ç»™å®¢æˆ·ç«¯ã€‚ä¸è¿‡ç”±äºCURPå­˜åœ¨fast pathå’Œslow pathçš„æ¦‚å¿µï¼Œå› æ­¤ä¼šç¨å¾®å¤æ‚ä¸€äº›ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 type CommandBoard struct { mu sync.Mutex // store all notifiers for execution results erNotifiers map[ProposeId]chan string // store all notifiers for after sync results asrNotifiers map[ProposeId]chan struct{} erBuffer map[ProposeId]string asrBuffer map[ProposeId]struct{} } er ä¸º execution resultï¼Œasr å³ä¸º async execution resultï¼Œåˆ†åˆ«ä»£è¡¨fast pathå’Œslow pathçš„æ‰§è¡Œç»“æœã€‚ è¯·æ±‚é€šè¿‡ ProposeId æ¥æ ‡è¯†ï¼ŒProposeId ä¸º ClientId å’Œ SeqId çš„ç»„åˆï¼Œä»¥åŒºåˆ†ä¸åŒClientçš„ä¸åŒè¯·æ±‚ï¼š\n1 2 3 4 type ProposeId struct { ClientId uint64 SeqId uint64 } leaderåœ¨é€šè¿‡fast pathæ‰§è¡Œè¯·æ±‚ï¼Œåœ¨æ¥æ”¶åˆ°è¯·æ±‚åï¼Œä¼šé€šè¿‡ WaitForEr() æ¥ç­‰å¾…fast pathçš„æ‰§è¡Œç»“æœï¼Œåœ¨ WaitForEr() ä¸­ï¼Œæ¶‰åŠåˆ°erBufferå’ŒerNotifiersã€‚erBufferç”¨äºç¼“å­˜å‘½ä»¤çš„æ‰§è¡Œç»“æœï¼Œç»fast pathå®Œæˆæ‰§è¡Œçš„å†…å®¹éƒ½ä¼šå­˜å‚¨åˆ°å…¶ä¸­ï¼Œè€ŒerNotifiersåˆ™å­˜å‚¨ä¸€ä¸ªchannelï¼Œå‰å°ç›‘å¬è¯¥channelï¼Œç­‰å¾…æ‰§è¡Œç»“æœã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 func (c *CommandBoard) WaitForEr(id ProposeId) string { c.mu.Lock() if result, ok := c.erBuffer[id]; ok { c.mu.Unlock() return result } if _, ok := c.erNotifiers[id]; !ok { c.erNotifiers[id] = make(chan string, 1) } notifyChan := c.erNotifiers[id] c.mu.Unlock() result := \u0026lt;-notifyChan c.erBuffer[id] = result return result } WaitForAsr ç”¨äºç­‰å¾…commandåœ¨slow pathä¸­å®Œæˆå…±è¯†ï¼Œè¿”å›æ‰§è¡Œçš„ç»“æœã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 func (c *CommandBoard) WaitForAsr(id ProposeId) string { c.mu.Lock() defer c.mu.Unlock() //trace.Trace(trace.Client, \u0026#34;Wait Synced [clientId: %d,seqId: %d]\u0026#34;, id.ClientId, id.SeqId) _, asrOk := c.asrBuffer[id] result, erOk := c.erBuffer[id] defer delete(c.asrBuffer, id) defer delete(c.erBuffer, id) // command has already been executed in both fast path and slow path if asrOk \u0026amp;\u0026amp; erOk { return result } if _, ok := c.asrNotifiers[id]; !ok { c.asrNotifiers[id] = make(chan struct{}, 1) } notifyChan := c.asrNotifiers[id] // release lock and wait c.mu.Unlock() \u0026lt;-notifyChan c.mu.Lock() if result, ok := c.erBuffer[id]; ok { return result } // UNREACHABLE return \u0026#34;NOT FOUND IN BUFFER\u0026#34; } Why Buffer åœ¨ 6.824 ä¸­ï¼Œæ‰§è¡Œç»“æœé€šè¿‡ä¸€ä¸ªchannelå³å¯ä¼ é€’ï¼Œä½†æ˜¯è¿™é‡Œé¢å¤–ä½¿ç”¨ä¸€ä¸ªBufferä¸»è¦æ˜¯ç”¨äºå…¼å®¹slow pathï¼Œæ¥ä¿è¯çº¿æ€§ä¸€è‡´æ€§ã€‚erå’Œasréƒ½å¼•å…¥äº†bufferï¼ŒäºŒè€…éœ€è¦åˆ†å¼€è®¨è®º\né¦–å…ˆè¯´æ˜ä¸€ä¸‹ä¸ºä»€ä¹ˆéœ€è¦ erBuffer ã€‚è®¾æƒ³è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼šclient1 å…ˆ cmd1 set a = 1ï¼Œéšåclient 1 å‘é€ cmd 2 get aï¼Œæ­¤æ—¶è¢«witnessæ£€æµ‹åˆ°å†²çªï¼Œéœ€ç­‰å¾…slow pathæ‰§è¡Œå®Œæ¯•ï¼Œæ­¤æ—¶ï¼Œclient 1 åˆå‘é€äº† cmd 3 set a = 3ï¼Œç”±äºleaderä¸ŠWitnessæ˜¯å…³é—­çš„ï¼Œset a = 3 å¯ä»¥ç›´æ¥æ‰§è¡Œï¼Œè¿™ä¼šå¯¼è‡´cmd3 åœ¨cmd2 ä¹‹å‰è¢«æ‰§è¡Œï¼Œå¯¹äºclientè€Œè¨€ï¼Œè§‚æµ‹åˆ°çš„ç»“æœä¸å‘é€é¡ºåºä¸ä¸€è‡´ã€‚\nå› æ­¤ï¼Œcmd2 ä¸èƒ½ç­‰å¾…ä»slow pathä¸­commitæ‰æ‰§è¡Œï¼Œè€Œæ˜¯åº”å½“åœ¨fast pathä¸­æ‰§è¡Œå®Œæˆï¼Œä¿å­˜ç»“æœï¼Œç­‰åˆ°å¯¹åº”çš„æ—¥å¿—commitä¹‹åï¼Œå†å°†è¯¥ç»“æœè¿”å›ç»™clientã€‚\nå¯¹äºä¸åŒçš„clientæ¥è¯´ï¼Œå³cmd1 cmd3 ç”±client 1 å‘é€ï¼Œcmd2 ç”±client 2 å‘é€ï¼Œæ­¤æ—¶cmd2 å’Œcmd3 å¤„äºä¸€ç§å¹¶å‘çš„çŠ¶æ€ï¼Œæ˜¯å…è®¸ä»¥ä»»æ„çš„ç»“æœå®Œæˆæ‰§è¡Œçš„ï¼Œä½†æ˜¯å¦‚æœåªæœ‰ä¸€ä¸ªclientï¼Œåˆ™ä¼šè¿èƒŒçº¿æ€§ä¸€è‡´æ€§ã€‚\nè€Œ AsrBuffer ä¸»è¦æ˜¯ç”¨äºè§£å†³slow pathçš„å¼‚æ­¥æ‰§è¡Œé—®é¢˜ï¼Œå¦‚æœåå°raft commitçš„æ•ˆç‡æ¯”è¾ƒé«˜ï¼Œé‚£ä¹ˆä¼šå¯¼è‡´åœ¨clientè°ƒç”¨WaitSyncedä¹‹å‰å°±å·²ç»commitå®Œæ¯•ï¼Œæ­¤æ—¶å¦‚æœåˆ›å»ºä¸€ä¸ªchannelå¹¶ç›‘å¬ï¼Œé‚£ä¹ˆåç»­å°±ä¼šæ°¸è¿œæ— æ³•æ¥æ”¶åˆ°ç»“æœã€‚\nå¯¹äºè¿™ä¸ªé—®é¢˜ï¼Œæœ‰ä¸¤ä¸ªè§£å†³æ–¹æ¡ˆï¼Œä¸€æ˜¯éå†å½“å‰commit idå‰æ‰€æœ‰å¯¹åº”çš„channelï¼Œå…¨éƒ¨é€šçŸ¥ä¸€éï¼ŒäºŒå°±æ˜¯æ·»åŠ ä¸€ä¸ªç¼“å­˜ï¼Œå¯ä»¥é€šè¿‡å…ˆæŸ¥è¯¢bufferæ¥åˆ¤æ–­æ˜¯å¦æ‰§è¡Œå®Œæˆï¼Œå¦‚æœæ²¡æœ‰ï¼Œåç»­å†é€šè¿‡channelç›‘å¬ç»“æœã€‚bufferå½“ä¸­åªéœ€è¦å­˜å‚¨ä¸€ä¸ªç©ºstruct{}ï¼Œèµ·åˆ°é€šçŸ¥ä½œç”¨å³å¯ã€‚ä¸ªäººè®¤ä¸ºç¬¬ä¸€ç§å®ç°æ–¹å¼ä¼˜é›…ä¸€äº›ï¼Œå› æ­¤å°±å¼•å…¥äº†bufferã€‚\nCommand Worker ä¸Command Boardç›¸å¯¹åº”çš„æ˜¯Command Workerï¼ŒCommand Boardè®°å½•è¯·æ±‚ï¼ŒWorkerè´Ÿè´£å…·ä½“çš„æ‰§è¡Œã€‚\nCommand Workerä¸­ä¼šåˆ†åˆ«ä»fast pathå’Œslow pathä¸­æ¥æ”¶è¯·æ±‚ï¼š\nleaderåœ¨æ¥æ”¶åˆ°è¯·æ±‚ä¹‹åï¼Œä¼šç›´æ¥å°†å…¶é€šè¿‡fast path channelå‘é€è‡³cmd workerå¤„ï¼Œfolloweråªè¿›è¡Œwitnessä¸æ‰§è¡Œï¼Œå› æ­¤ä¸ä¼šä»fast pathä¸­æ¥æ”¶ä»»ä½•å†…å®¹ã€‚leaderæ‰§è¡Œå®Œæˆä¹‹åå°±å¯ä»¥é€šè¿‡ InsertEr å°†ç»“æœæ·»åŠ åˆ°Command Boardå½“ä¸­ï¼Œé€šçŸ¥å‰å°è¿”å›ç»“æœç»™client\nraftä¼šå°†å·²ç»commitäº†çš„è¯·æ±‚é€šè¿‡slow pathå‘é€è‡³cmd workerã€‚ç”±äºleaderå·²ç»é€šè¿‡fast pathæ‰§è¡Œè¿‡ä¸€æ¬¡äº†ï¼Œå› æ­¤leaderåœ¨è¿™é‡Œåº”å½“å¿½ç•¥æ‰è¯¥è¯·æ±‚ï¼Œè€Œfolloweråº”å½“æ‰§è¡Œæ¥è·Ÿéšleaderçš„çŠ¶æ€ã€‚ è¿™ä¸€éƒ¨åˆ†ä¸ä¼ ç»Ÿraftæœ€å¤§çš„ä¸åŒå°±æ˜¯ï¼šleaderä¼šé€šè¿‡fast pathè¿›è¡Œâ€œæŠ¢è·‘â€ï¼Œä»è€Œç»™ç³»ç»Ÿå¼•å…¥äº†é¢å¤–çš„å¤æ‚åº¦ï¼š\nLeaderé€šè¿‡fast pathæå‰æ‰§è¡Œï¼Œä¿®æ”¹äº†çŠ¶æ€æœºï¼Œä½†æ˜¯ç”±äºwitnessæœºåˆ¶çš„å­˜åœ¨ï¼Œè¿™ä¸ªæ‰§è¡Œç»“æœåœ¨commitä¹‹å‰æ˜¯ä¸ä¼šæš´éœ²ç»™clientçš„ã€‚\nLeaderæå‰ä¿®æ”¹äº†çŠ¶æ€æœºï¼Œé‚£ä¹ˆslow pathä¸­çš„å†…å®¹å°±æ— éœ€å†æ‰§è¡Œä¸€éï¼Œé¢å¤–å†™ä¸€ékv storeçš„å¼€é”€æ¯”è¾ƒé«˜ã€‚å¦‚æœslow pathä¼šå†æ‰§è¡Œä¸€éï¼Œè™½ç„¶å¯èƒ½ä¼šå¯¼è‡´fast pathå’Œslow pathçš„å†…å®¹ç›¸äº’è¦†ç›–ï¼Œä½†æ˜¯ç”±äºå†²çªæ£€æµ‹çš„æœºåˆ¶å­˜åœ¨ï¼Œç›¸äº’è¦†ç›–çš„ä¸­é—´æ€ä¸ä¼šå¯¹å¤–æš´éœ²ï¼Œå› æ­¤æ‰§è¡Œä¸€éslowä¹Ÿä¸ä¼šå½±å“æ­£ç¡®æ€§ï¼Œç­‰åˆ°commitåï¼ŒçŠ¶æ€æœºä¸åªæ‰§è¡Œfastæ— å¼‚ã€‚Leaderé€šè¿‡fast pathå·²ç»å®Œæˆäº†æŒä¹…åŒ–ï¼Œå› æ­¤Leaderä¹Ÿä¸ä¼šä¾èµ–raft logæ¥å®Œæˆrecoveryã€‚\nFolloweræ²¡æœ‰é¢å¤–çš„åŠ¨ä½œï¼Œåªéœ€è¦witnessåˆ¤æ–­å†²çªï¼Œå¹¶ä¸”é€šè¿‡slow pathæ¥è·Ÿéšleaderçš„çŠ¶æ€å³å¯ã€‚\næ­¤å¤–è¿˜æœ‰ä¸€ä¸ªCommandSetï¼Œç”¨äºå¯¹å‘½ä»¤è¿›è¡Œå»é‡ï¼Œé˜²æ­¢å·²ç»æ‰§è¡Œè¿‡ä¸€éï¼Œä½†æ˜¯æ²¡æ¥åŠå“åº”clientï¼Œå®•æœºï¼Œéšåclientåˆé‡è¯•ï¼Œå¯¼è‡´å‘½ä»¤è¢«é‡å¤æ‰§è¡Œã€‚åœ¨ 6.824 çš„lab3 ä¸­ï¼Œéœ€è¦è¿™æ ·ä¸€ä¸ªè®¾è®¡æ˜¯å› ä¸ºå…¶ä¸­çš„appendå‘½ä»¤æ˜¯ä¸å¹‚ç­‰çš„ï¼Œå³ä¼šåœ¨åŸæœ‰valueçš„åŸºç¡€ä¸Šè¿½åŠ æ•°æ®ï¼Œè€Œå¦‚æœå°†å‘½ä»¤è®¾è®¡æˆå¹‚ç­‰çš„ï¼Œå°±ä¸éœ€è¦è¿™ä¸ªCommandSetäº†ï¼Œå‘½ä»¤é‡å¤æ‰§è¡Œä¹Ÿä¸ä¼šäº§ç”Ÿè´Ÿé¢å½±å“ã€‚\nCommand Workeræ˜¯å•çº¿ç¨‹æ‰§è¡Œçš„ï¼Œä»¥ç¡®ä¿çº¿æ€§ä¸€è‡´æ€§ã€‚ä½†å®é™…ä¸Šï¼Œæ­£å¦‚CURPæœ¬èº«çš„æ€æƒ³â€”â€”å…¨å±€é¡ºåºæ˜¯ä¸å¿…è¦çš„ï¼Œå¯ä»¥å°†å…¨å±€é¡ºåºç¼©å°èŒƒå›´åˆ°å­˜åœ¨å†²çªçš„keyä¹‹é—´ç»´æŠ¤ä¸€ä¸ªé¡ºåºã€‚åœ¨å®ç°ä¸Šå¯ä»¥ç»´æŠ¤å¤šä¸ªworkerï¼Œå°†å­˜åœ¨å†²çªçš„keyåˆ†é…è‡³åŒä¸€ä¸ªworkerå¤„ï¼Œç¡®ä¿èƒ½å¤ŸæŒ‰ç…§é¡ºåºæ¥æ‰§è¡Œã€‚ä¸åŒworkerä¹‹é—´ç”±äºä¸å­˜åœ¨å†²çªï¼Œå¯ä»¥å¹¶è¡Œæ‰§è¡Œã€‚\næ­¤å¤–ï¼Œç”±äºkvstoreå’ŒcommandSetåªä¼šåœ¨è¿™é‡Œä¿®æ”¹ï¼ŒåŠ ä¸Šå…¶ä¸ºå•çº¿ç¨‹ï¼Œå› æ­¤è¿™é‡Œå®Œå…¨å¯ä»¥ä¸åŠ é”æ‰§è¡Œï¼Œä¸´ç•ŒåŒºä»…ä»…åªæœ‰åˆ¤æ–­å½“å‰èŠ‚ç‚¹çŠ¶æ€\nè¿™é‡Œçš„å®ç°å¯ä»¥å‚è€ƒXlineï¼Œå…¶ä¸­å®ç°äº†ä¸€ä¸ªéå¸¸å®Œå¤‡çš„å†²çªæ£€æµ‹é˜Ÿåˆ— + workerï¼šzhuanlan.zhihu.com/p/662504235\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 func (s *StateMachine) cmdWorker() { for { select { case cmd := \u0026lt;-s.fastPath: trace.Trace(trace.Fast, s.NodeId, \u0026#34;got cmd from fast path %v\u0026#34;, cmd) proposeId := command.ProposeId{ ClientId: cmd.ClientId, SeqId: cmd.SeqId, } if _, ok := s.commandSet[proposeId]; ok { // command executed before,nothing to do trace.Trace(trace.Fast, s.NodeId, \u0026#34;cmd already executed %v\u0026#34;, cmd) } else { s.commandSet[proposeId] = struct{}{} result := s.execute(cmd) trace.Trace(trace.Fast, s.NodeId, \u0026#34;cmd %v executed,result is %v\u0026#34;, cmd, result) s.commandBoard.InsertEr(proposeId, result) } case cmd := \u0026lt;-s.slowPath: s.mu.Lock() isLeader := s.raftState == raft.StateLeader s.mu.Unlock() trace.Trace(trace.Slow, s.NodeId, \u0026#34;got cmd from slow path %v\u0026#34;, cmd) if _, ok := s.commandSet[cmd.ProposeId()]; ok || isLeader { // command executed before,nothing to do trace.Trace(trace.Slow, s.NodeId, \u0026#34;cmd already executed %v\u0026#34;, cmd) } else { s.commandSet[cmd.ProposeId()] = struct{}{} s.execute(cmd) } trace.Trace(trace.Slow, s.NodeId, \u0026#34;WAIT Notify result in slow path,proposeId:[clientId: %d,seqId: %d]\u0026#34;, cmd.ClientId, cmd.SeqId) s.commandBoard.NotifyAsr(cmd.ProposeId()) trace.Trace(trace.Slow, s.NodeId, \u0026#34;Notify result in slow path,proposeId:[clientId: %d,seqId: %d]\u0026#34;, cmd.ClientId, cmd.SeqId) // when command is committed, it can be remove from witness and command set safely s.removeRecord(cmd.ProposeId()) } } } // we don\u0026#39;t need to lock this function,because it\u0026#39;s the only func which modifies KVStore func (s *StateMachine) execute(cmd *curp_proto.CurpClientCommand) string { if cmd.Op == command.PUT { s.KVStore.Put(cmd.Key, cmd.Value) } else if cmd.Op == command.DELETE { s.KVStore.Delete(cmd.Key) } else if cmd.Op == command.GET { result, err := s.KVStore.Get(cmd.Key) if err != nil { return \u0026#34;NOT FOUND IN STATE\u0026#34; } else { return result } } // unreachable! return \u0026#34;\u0026#34; } Fast Path åœ¨åˆ†æå®ŒCommand Boardå’ŒCommand Workerä¹‹åï¼Œå°±å¯ä»¥ä¸²é€šCURPçš„fast pathå’Œslow pathçš„å…¨æµç¨‹äº†ã€‚ fast pathé€šè¿‡ Propose () å®Œæˆï¼Œæ— è®ºè¯»å†™è¯·æ±‚éƒ½ä¼šè¢«å°è£…æˆä¸€ä¸ªClientCommandï¼Œéšåè°ƒç”¨ Propose() ï¼Œæµç¨‹å¦‚ä¸‹ï¼š\né¦–å…ˆè¿›è¡Œå†²çªæ£€æµ‹ï¼Œå°†è¯·æ±‚æ·»åŠ åˆ°Witnesså½“ä¸­ï¼Œå¹¶ä¸”è¿”å›æ˜¯å¦å†²çª followeråœ¨fast pathä¸­åªèµ·åˆ°witnessä½œç”¨ã€‚å¦‚æœå½“å‰èŠ‚ç‚¹éLeaderï¼Œé‚£ä¹ˆæ­¤æ—¶å°±å¯ä»¥è¿”å›äº†ï¼Œå“åº”CONFLICTæˆ–è€…ACCEPT å¯¹äºLeaderåç»­åº”å½“ç›´æ¥ç»§ç»­æ‰§è¡Œï¼Œé€šè¿‡fast pathçš„channelå°†cmdäº¤ç»™ cmd workerï¼Œå¹¶é€šè¿‡proposeCå°†cmdä¼ é€’ç»™raft é€šè¿‡CommandBoardç­‰å¾…ç»“æœï¼Œå“åº”ç»™Client 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 func (s *StateMachine) Propose(cmd *curp_proto.CurpClientCommand) *curp_proto.CurpReply { isConflict := s.witness.InsertIfNotConflict(cmd) s.mu.Lock() if s.raftState == raft.StateLeader { trace.Trace(trace.Leader, s.NodeId, \u0026#34;propose command %s,type: %s,conflict: %v\u0026#34;, cmd.Key, command.OpFmt[cmd.Op], isConflict) } else { trace.Trace(trace.Follower, s.NodeId, \u0026#34;propose command %s,type: %s,conflict: %v\u0026#34;, cmd.Key, command.OpFmt[cmd.Op], isConflict) } reply := \u0026amp;curp_proto.CurpReply{ Content: \u0026#34;\u0026#34;, } if s.raftState != raft.StateLeader { if isConflict { s.mu.Unlock() reply.StatusCode = curp_proto.CONFLICT return reply } else { s.mu.Unlock() reply.StatusCode = curp_proto.ACCEPTED return reply } } buf := cmd.Encode() go func() { s.fastPath \u0026lt;- cmd }() // command will update the state machine or get command is conflict trace.Trace(trace.Leader, s.NodeId, \u0026#34;send propose[clientId:%d seqId: %d] msg to raft node\u0026#34;, cmd.ClientId, cmd.SeqId) go func() { s.proposeC \u0026lt;- buf }() s.mu.Unlock() proposeId := command.ProposeId{ ClientId: cmd.ClientId, SeqId: cmd.SeqId, } result := s.commandBoard.WaitForEr(proposeId) reply.Content = result if isConflict { reply.StatusCode = curp_proto.CONFLICT } else { reply.StatusCode = curp_proto.ACCEPTED } return reply } è¿™é‡Œæœ‰ä¸€ä¸ªç»†èŠ‚ï¼Œåœ¨CURP-Qçš„è®ºæ–‡å½“ä¸­æè¿°ï¼šLeaderçš„witnessåº”å½“æ˜¯å…³é—­çš„ï¼Œå³Leaderå¹¶ä¸è¿›è¡Œå†²çªæ£€æµ‹ï¼Œå¯¹äºæ‰€æœ‰è¯·æ±‚éƒ½ç›´æ¥æ‰§è¡Œï¼Œä½†æ˜¯åœ¨Xlineçš„å®ç°ä¸­ï¼ŒLeaderæ˜¯å¯åŠ¨äº†Witnesså¹¶è¿›è¡Œå†²çªæ£€æµ‹çš„ã€‚å¯¹äºè¿™ä¸ªç»†èŠ‚ï¼Œä¸ªäººè®¤ä¸ºå¹¶ä¸ä¼šå¯¹å¹¶ä¸ä¼šå¯¹ç³»ç»Ÿæ­£ç¡®æ€§äº§ç”Ÿå½±å“ï¼Œæš‚æ—¶æ²¡æœ‰æ·±ç©¶ã€‚\nWitnesses in leaders are inactive, and all client requests are serialized and logged in their command logs directly.\nSlow Path Slow Pathçš„å…¥å£å¾ˆç®€å•ï¼Œåªéœ€è¦è°ƒç”¨ WaitForAsr() æ¥ç­‰å¾…commitå³å¯ï¼Œé€šè¿‡ WaitSynced() æ¥å®ç°\n1 2 3 4 5 6 7 8 9 10 11 func (s *StateMachine) WaitSynced(id command.ProposeId) *curp_proto.CurpReply { // only send wait synced message to leader trace.Trace(trace.Leader, s.NodeId, \u0026#34;got wait synced message: %v\u0026#34;, id) result := s.commandBoard.WaitForAsr(id) reply := \u0026amp;curp_proto.CurpReply{ Content: result, StatusCode: curp_proto.ACCEPTED, } trace.Trace(trace.Leader, s.NodeId, \u0026#34;wait synced finished,id: %v,result: %v\u0026#34;, id, result) return reply } åœ¨Fast Pathä¸­ï¼ŒLeaderä¼šé€šè¿‡proposeCå‘é€ç»™Raftï¼Œæ­¤æ—¶å°±ç›¸å½“äºè¿›å…¥äº†Slow Pathï¼Œåœ¨Raftä¸­ï¼Œå®Œæˆå…±è¯†çš„cmdä¼šé€šè¿‡Readyè¿”å›ï¼Œç»RaftNodeè½¬æ‰‹åˆé€šè¿‡commitCå‘é€ä¼šäº†çŠ¶æ€æœºï¼ŒçŠ¶æ€æœºæ”¶åˆ°ä¹‹åï¼Œå¯¹cmdè¿›è¡Œdecodeï¼Œéšæœºé€šè¿‡slow path channelåˆå°†è¯·æ±‚å‘é€ç»™äº†cmd worker\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 func (s *StateMachine) readCommits(commitC \u0026lt;-chan *commit, errorC \u0026lt;-chan error) { for commit := range commitC { if commit == nil { // signaled to load snapshot snapshot, err := s.loadSnapshot() if err != nil { log.Panic(err) } if snapshot != nil { log.Printf(\u0026#34;loading snapshot at term %d and index %d\u0026#34;, snapshot.Metadata.Term, snapshot.Metadata.Index) if err := s.recoverFromSnapshot(snapshot.Data); err != nil { log.Panic(err) } } continue } for _, data := range commit.data { var cmd curp_proto.CurpClientCommand dec := gob.NewDecoder(bytes.NewBufferString(data)) if err := dec.Decode(\u0026amp;cmd); err != nil { log.Fatalf(\u0026#34;raftexample: could not decode message (%v)\u0026#34;, err) } s.slowPath \u0026lt;- \u0026amp;cmd } close(commit.applyDoneC) } if err, ok := \u0026lt;-errorC; ok { log.Fatal(err) } } ä¹‹åå°±æ˜¯cmd workerçš„é€»è¾‘äº†ï¼Œåœ¨ä¸Šé¢å·²ç»åˆ†æè¿‡äº†ï¼Œè¿™é‡Œç®€è¦æ•´åˆä¸€ä¸‹ã€‚å¯¹äºleaderè€Œè¨€ï¼Œç›´æ¥å¿½ç•¥slow pathä¸­çš„å†…å®¹ï¼Œä»¥å…å†…å®¹è¦†ç›–å½±å“çº¿æ€§ä¸€è‡´æ€§ã€‚è€Œå¯¹äºfollowerè€Œè¨€ï¼Œç›´æ¥åº”ç”¨ä»¥è·ŸéšLeaderã€‚slow pathæ‰§è¡Œå®Œæˆï¼Œå³å¯è®¤å®šå…¶ä¸ºcommitï¼Œæ­¤æ—¶å¯ä»¥é€šè¿‡ NotifyAsr è·å–æ‰§è¡Œç»“æœï¼Œå¹¶é€šçŸ¥ WaitSynced ç»“æŸé˜»å¡ã€‚\nCURP Client å¯¹åº”åœ°ï¼Œåœ¨CURP Clientç«¯ä¹Ÿåˆ†ä¸ºäº†fast pathå’Œslow pathï¼Œå‡é€šè¿‡grpcå®ç°ï¼Œæ­¤å¤–ï¼Œè¿˜éœ€è¦ä¸€ä¸ªisLeaderæ¥ç¡®å®šserverä¸­çš„leaderï¼Œä»¥ç¡®å®šåº”å½“å‘è°å‘é€ WaitSynced()ã€‚\nFast path åœ¨fast pathä¸­ï¼Œclientéœ€è¦åšçš„å°±æ˜¯å°†è¯·æ±‚å¹¿æ’­ç»™æ‰€æœ‰çš„serverï¼Œç„¶åç›‘å¬ç»Ÿè®¡ç»“æœï¼š\nå¦‚æœå“åº”ç»“æœä¸­å­˜åœ¨å†²çªï¼Œé‚£ä¹ˆå°±è¿”å›å†²çªï¼Œåç»­è½¬å‘slow round å¦‚æœè¾¾åˆ°äº†superquorum (fä¸ªèŠ‚ç‚¹ï¼Œå¯¹åº”ä¸ºf + f / 2 + 1ï¼Œå³ 4 èŠ‚ç‚¹éœ€è¦ 3 ä¸ªï¼Œ3 èŠ‚ç‚¹éœ€è¦ 3ä¸ª )ï¼Œå°±è¿”å›è¯·æ±‚æˆåŠŸ è¶…æ—¶æ£€æµ‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 func (c *GrpcClient) fastRound(cmd *curp_proto.CurpClientCommand, notifyC []chan *curp_proto.CurpReply) (*curp_proto.CurpReply, error) { timeout := time.NewTicker(time.Second * 5) fastPathChan := make(chan *curp_proto.CurpReply) for i := 0; i \u0026lt; len(c.grpc_servers); i++ { go func(i int) { c.sendC[i] \u0026lt;- cmd result := \u0026lt;-notifyC[i] fastPathChan \u0026lt;- result }(i) } acceptedCount := 0 result := \u0026amp;curp_proto.CurpReply{ StatusCode: curp_proto.TIMEOUT, Content: \u0026#34;\u0026#34;, } for { select { case fastResult := \u0026lt;-fastPathChan: trace.Trace(trace.Client, -1, \u0026#34;client receive fast path result: %v\u0026#34;, fastResult) if fastResult.StatusCode == curp_proto.ACCEPTED { acceptedCount++ if fastResult.Content != \u0026#34;\u0026#34; { result = fastResult } } else { return fastResult, nil } if acceptedCount == c.superQuorum() { return result, nil } case \u0026lt;-timeout.C: fmt.Printf(\u0026#34;timeout !!\\n\u0026#34;) return result, fmt.Errorf(\u0026#34;fast path time out\u0026#34;) } } } slow path slow pathæ¯”è¾ƒç®€å•ï¼Œåªéœ€è¦å°†è¯·æ±‚å‘é€ç»™Leaderå³å¯\n1 2 3 4 5 6 7 8 9 10 11 func (c *GrpcClient) slowRound(cmd *curp_proto.CurpClientCommand, notifyC []chan *curp_proto.CurpReply) (string, error) { sync_cmd := \u0026amp;curp_proto.CurpClientCommand{ClientId: cmd.ClientId, SeqId: cmd.SeqId, Sync: 1} c.sendC[c.LeaderId] \u0026lt;- sync_cmd reply := \u0026lt;-notifyC[c.LeaderId] trace.Trace(trace.Client, -1, \u0026#34;client wait synced finished, id: %v\u0026#34;, cmd.ProposeId) if reply.StatusCode == curp_proto.CONFLICT { return \u0026#34;\u0026#34;, fmt.Errorf(\u0026#34;command is still conflict after wait synced\u0026#34;) } return reply.Content, nil } éšåï¼Œå°†fast pathå’Œslow pathåšä¸€ä¸ªæ•´åˆï¼Œå°è£…æˆ Propose() ï¼Œåœ¨ Propose() ä¸­ï¼š\né¦–å…ˆè°ƒç”¨ fast_round() ï¼Œå°†è¯·æ±‚è¿›è¡Œå¹¿æ’­ï¼Œå¦‚æœä¸å­˜åœ¨å†²çªï¼Œé‚£ä¹ˆå°±å¯ä»¥ç›´æ¥è¿”å›ï¼Œä»£è¡¨æ­¤æ¬¡è¯·æ±‚åœ¨ 1 ä¸ªRTTå†…ç»“æŸ å¦‚æœ fast_round() ä¸­å­˜åœ¨å†²çªï¼Œé‚£ä¹ˆå†è°ƒç”¨ slow_round()ï¼Œé€šè¿‡ serverå¯¹ Waitsynced() æ¥ç­‰å¾…commitï¼Œè§£å†³å†²çª 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 func (c *GrpcClient) Propose(cmd *curp_proto.CurpClientCommand) (string, error) { ntfC := c.NewNotifyC(cmd.SeqId) defer c.DeleteNotifyC(cmd.SeqId) reply, err := c.fastRound(cmd, ntfC) if err != nil { return \u0026#34;\u0026#34;, err } if reply.StatusCode == curp_proto.ACCEPTED { c.static.fast++ return reply.Content, nil } c.static.slow++ trace.Trace(trace.Client, -1, \u0026#34;client receive conflict result, turn to slow path: %v\u0026#34;, reply) resultStr, err := c.slowRound(cmd, ntfC) return resultStr, err } è¿™é‡Œæœ‰ä¸€ä¸ªå°çš„ä¼˜åŒ–ï¼Œå³å¯ä»¥åŒæ—¶å‘é€fast roundå’Œslow roundè¯·æ±‚ï¼Œè¿™æ ·å¯ä»¥æ›´å¿«åœ°è·å–WaitSyncedçš„ç»“æœã€‚\nbenchmark è¿™é‡Œä½¿ç”¨benchmarkå¯¹curpçš„æ€§èƒ½åšäº†ä¸€ä¸ªç®€å•çš„æµ‹è¯•ï¼Œé€‰æ‹©çš„æ˜¯æ¯”è¾ƒé€šç”¨çš„go-ycsbï¼Œå€Ÿç”¨äº†ä¸€ä¸‹go-ycsbçš„åŠ è½½æ•°æ®å’Œç»Ÿè®¡ç»“æœçš„åŠŸèƒ½ï¼Œç„¶åè‡ªå·±é€šè¿‡tcpä¸ºcurpå®ç°äº†ä¸€ä¸ªserverï¼Œç„¶ååœ¨ycsbä¸­å®ç°äº†ä¸€ä¸ªclientï¼Œè¿™æ ·å°±å¯ä»¥æŠŠè¯·æ±‚ä»ycsbæˆåŠŸå‘é€åˆ°curpäº†ã€‚\nè¿™é‡Œå®ç°çš„ç¡®å®æ˜¯æ¯”è¾ƒè‰ç‡ï¼Œä½†æ˜¯ä½ å°±è¯´èƒ½ä¸èƒ½ç”¨å§ğŸ˜€\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 type GetResponse struct { Count int64 Kvs []*Command } func (r *GetResponse) Encode() []byte { buf := \u0026amp;bytes.Buffer{} enc := gob.NewEncoder(buf) err := enc.Encode(r) if err != nil { fmt.Println(\u0026#34;encode error:\u0026#34;, err) } return buf.Bytes() } const ( GET uint8 = iota PUT DELETE ) type Command struct { Op uint8 Key string Value string } func bench_server(port string, client *curp.GrpcClient) { listener, err := net.Listen(\u0026#34;tcp\u0026#34;, port) if err != nil { fmt.Println(\u0026#34;Error listening:\u0026#34;, err.Error()) os.Exit(1) } defer listener.Close() fmt.Printf(\u0026#34;Server is listening on :%v\\n\u0026#34;, port) for { conn, err := listener.Accept() if err != nil { fmt.Println(\u0026#34;Error accepting: \u0026#34;, err.Error()) os.Exit(1) } go handleRequest(conn, client) } } func handleRequest(conn net.Conn, client *curp.GrpcClient) { buf := make([]byte, 4096) n, _ := conn.Read(buf) aCmd := \u0026amp;Command{} dec := gob.NewDecoder(bytes.NewReader(buf[:n])) err := dec.Decode(aCmd) if err != nil { fmt.Println(err) return } // fmt.Printf(\u0026#34;Received: %+v\\n\u0026#34;, aCmd) if aCmd.Op == GET { // call client.get key := aCmd.Key // value := \u0026#34;myValue\u0026#34; value, _ := client.Get(aCmd.Key) cmd := Command{ Op: GET, Key: key, Value: value, } cmds := []*Command{\u0026amp;cmd} resp := GetResponse{ Count: 1, Kvs: cmds, } buf := resp.Encode() conn.Write(buf) } else if aCmd.Op == PUT { // call client.put client.Put(aCmd.Key, aCmd.Value) conn.Write([]byte(\u0026#34;Received PUT Response!\u0026#34;)) } else if aCmd.Op == DELETE { // call client.delete client.Del(aCmd.Key) conn.Write([]byte(\u0026#34;Received DELETE Response!\u0026#34;)) } } è·‘äº†ä¸€ä¸ªç®€å•çš„benchmarkï¼Œç”±äºæ²¡æœ‰å®ç°scanæ“ä½œï¼Œå› æ­¤å°±åªé€‰æ‹©äº†ycsbä¸­çš„workload a-b-cï¼Œå…¶ä¸­workloadaä¸º 50%read 50%writeï¼Œworkloadbä¸º 95%read 5% writeï¼Œworkloadc 100% read,ã€‚\nå¯ä»¥çœ‹åˆ°æ— è®ºæ˜¯å“ªä¸ªworkloadï¼Œcurpçš„æ€§èƒ½å‡å¥½äºraftï¼Œå¯¹äºaï¼Œå¤§çº¦æ˜¯ä¸ª 20-30%çš„æå‡ï¼Œb, cç”±äºä¸»è¦æ˜¯è¯»è¯·æ±‚ä¸ºä¸»ï¼Œcurpä¸­åªéœ€è¦ä¸€è½®rttåŠ æŸ¥è¯¢çŠ¶æ€æœºå³å¯ï¼Œè€Œraftéœ€è¦èµ°ä¸€éæ—¥å¿—å¤åˆ¶+æŸ¥è¯¢çŠ¶æ€æœºï¼Œå› æ­¤å·®è·è¢«è¿›ä¸€æ­¥æ‹‰å¤§ï¼ˆè¿™é‡ŒäºŒè€…éƒ½æ²¡æœ‰å¼€å¯çº¿æ€§ä¸€è‡´æ€§è¯»ä¼˜åŒ–çš„ï¼Œå³lease readæˆ–read indexï¼‰\nè¿™ä¸ªbenchmarkæ˜¯åœ¨å•æœºä¸Šè·‘çš„ï¼Œå¦‚æœçœŸæ­£åˆ°äº†è·¨åŸŸçš„é«˜ç½‘ç»œå»¶è¿Ÿçš„åœºæ™¯ä¸‹ï¼Œå·®è·ä¼šè¢«è¿›ä¸€æ­¥çš„æ‹‰å¤§\ncurp raft workload a 5.2s 6.7s workload b 1.2s 4.4s wrokload c 0.6s 4.1s\ngo-ycsbçš„è¯¦ç»†ç»“æœå¦‚ä¸‹ï¼š\nCURP\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 workloada READ - Takes(s): 5.2, Count: 488, OPS: 94.2, Avg(us): 600, Min(us): 433, Max(us): 25103, 50th(us): 534, 90th(us): 612, 95th(us): 652, 99th(us): 948, 99.9th(us): 25103, 99.99th(us): 25103 TOTAL - Takes(s): 5.2, Count: 1000, OPS: 192.8, Avg(us): 5185, Min(us): 433, Max(us): 52991, 50th(us): 6859, 90th(us): 11503, 95th(us): 12847, 99th(us): 16559, 99.9th(us): 27471, 99.99th(us): 52991 UPDATE - Takes(s): 5.2, Count: 512, OPS: 98.7, Avg(us): 9556, Min(us): 5396, Max(us): 52991, 50th(us): 8703, 90th(us): 12823, 95th(us): 14599, 99th(us): 18991, 99.9th(us): 27471, 99.99th(us): 52991 workloadb Run finished, takes 1.198906187s READ - Takes(s): 1.2, Count: 950, OPS: 793.1, Avg(us): 567, Min(us): 304, Max(us): 43807, 50th(us): 507, 90th(us): 582, 95th(us): 640, 99th(us): 1156, 99.9th(us): 1788, 99.99th(us): 43807 TOTAL - Takes(s): 1.2, Count: 1000, OPS: 834.4, Avg(us): 1192, Min(us): 304, Max(us): 43807, 50th(us): 511, 90th(us): 631, 95th(us): 6403, 99th(us): 15151, 99.9th(us): 20879, 99.99th(us): 43807 UPDATE - Takes(s): 1.1, Count: 50, OPS: 43.9, Avg(us): 13067, Min(us): 6400, Max(us): 20879, 50th(us): 13175, 90th(us): 15527, 95th(us): 16767, 99th(us): 20879, 99.9th(us): 20879, 99.99th(us): 20879 workloadc Run finished, takes 596.022766ms READ - Takes(s): 0.6, Count: 1000, OPS: 1680.6, Avg(us): 590, Min(us): 313, Max(us): 60863, 50th(us): 511, 90th(us): 614, 95th(us): 682, 99th(us): 1099, 99.9th(us): 1634, 99.99th(us): 60863 TOTAL - Takes(s): 0.6, Count: 1000, OPS: 1680.0, Avg(us): 590, Min(us): 313, Max(us): 60863, 50th(us): 511, 90th(us): 614, 95th(us): 682, 99th(us): 1099, 99.9th(us): 1634, 99.99th(us): 60863 Raft\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 workloada Run finished, takes 6.741194029s READ - Takes(s): 6.7, Count: 490, OPS: 72.8, Avg(us): 4182, Min(us): 3188, Max(us): 25279, 50th(us): 3571, 90th(us): 4787, 95th(us): 7699, 99th(us): 12015, 99.9th(us): 25279, 99.99th(us): 25279 TOTAL - Takes(s): 6.7, Count: 1000, OPS: 148.7, Avg(us): 6733, Min(us): 3188, Max(us): 42047, 50th(us): 7979, 90th(us): 9599, 95th(us): 12111, 99th(us): 17407, 99.9th(us): 25279, 99.99th(us): 42047 UPDATE - Takes(s): 6.7, Count: 510, OPS: 76.0, Avg(us): 9183, Min(us): 6908, Max(us): 42047, 50th(us): 8295, 90th(us): 11175, 95th(us): 15455, 99th(us): 18591, 99.9th(us): 20079, 99.99th(us): 42047 workloadb Run finished, takes 4.386455138s READ - Takes(s): 4.4, Count: 952, OPS: 217.6, Avg(us): 4152, Min(us): 3196, Max(us): 27407, 50th(us): 3553, 90th(us): 5947, 95th(us): 10591, 99th(us): 11487, 99.9th(us): 18127, 99.99th(us): 27407 TOTAL - Takes(s): 4.4, Count: 1000, OPS: 228.6, Avg(us): 4380, Min(us): 3196, Max(us): 27407, 50th(us): 3559, 90th(us): 7479, 95th(us): 10799, 99th(us): 11599, 99.9th(us): 18127, 99.99th(us): 27407 UPDATE - Takes(s): 4.3, Count: 48, OPS: 11.1, Avg(us): 8898, Min(us): 7096, Max(us): 15031, 50th(us): 8271, 90th(us): 10735, 95th(us): 14975, 99th(us): 15031, 99.9th(us): 15031, 99.99th(us): 15031 workloadc Run finished, takes 4.143589849s READ - Takes(s): 4.1, Count: 1000, OPS: 242.1, Avg(us): 4138, Min(us): 3272, Max(us): 44351, 50th(us): 3575, 90th(us): 5939, 95th(us): 7511, 99th(us): 11207, 99.9th(us): 13191, 99.99th(us): 44351 TOTAL - Takes(s): 4.1, Count: 1000, OPS: 242.1, Avg(us): 4138, Min(us): 3272, Max(us): 44351, 50th(us): 3575, 90th(us): 5939, 95th(us): 7511, 99th(us): 11207, 99.9th(us): 13191, 99.99th(us): 44351 TODO ç›®å‰çš„CURPåªå®ç°äº†åŸºç¡€çš„è¿è¡Œï¼Œå¹¶æ²¡æœ‰è€ƒè™‘crash-recoveryï¼Œè¿™å¯¹äºä¸€ä¸ªå…±è¯†æ¥è¯´æ˜¾ç„¶æ˜¯ä¸è¶³çš„ï¼Œä¸è¿‡ç¢äºæ—¶é—´å’Œç²¾åŠ›ï¼ŒçŸ­æ—¶é—´ç¬”è€…æ˜¯æ— æ³•è¡¥å…¨è¿™ä¸€éƒ¨åˆ†äº†ï¼Œåœ¨è¿™é‡Œç®€å•è¯´ä¸€ä¸‹æ€è·¯ã€‚\nVersion é¦–å…ˆï¼Œå¯¹äºæŒ‚æ‰å’Œå›å¤çš„èŠ‚ç‚¹ï¼Œæ•´ä¸ªé›†ç¾¤åº”å½“èƒ½å¤Ÿæ„ŸçŸ¥ï¼Œè®ºæ–‡ä¸­ä¸­ç»™å‡ºçš„æ–¹æ¡ˆæ˜¯ç»´æŠ¤ä¸€ä¸ªé›†ç¾¤åˆ—è¡¨+versionï¼Œclienté¦–æ¬¡ä»é…ç½®ä¸­å¿ƒå¤„æŒæœ‰è¯¥åˆ—è¡¨å’Œversionï¼Œä¹‹åæ¯æ¬¡è¯·æ±‚æ˜¯æºå¸¦ä¸Šversionï¼Œéšåé…ç½®ä¸­å¿ƒæ¥æ”¶åˆ°è¯·æ±‚åä¼šæ ¡éªŒversionï¼Œæ¥åˆ¤æ–­clientæŒæœ‰çš„é…ç½®æ˜¯å¦è¿‡æœŸ, å¦‚æœè¿‡æœŸå°±æ‹’ç»æ‰æ­¤æ¬¡è¯·æ±‚ï¼Œå¹¶å‘ŠçŸ¥Client\nåœ¨å®ç°ä¸Šï¼Œé…ç½®ä¸­å¿ƒå¯ä»¥å®ç°åœ¨Leaderä¸Šï¼ŒClientåœ¨è°ƒç”¨ isLeader () ç¡®å®šé›†ç¾¤Leaderæ—¶é¡ºä¾¿è·å–åˆ°versionå’Œé…ç½®ï¼Œå¹¶åœ¨clientç«¯ç»´æŠ¤ï¼Œéšåæ‰©å±•ä¸€ä¸‹protobufçš„ç»“æ„ä½“ï¼Œæ¯æ¬¡è¯·æ±‚æºå¸¦ä¸Šversionã€‚serverç«¯ï¼Œserverç«¯åœ¨ä»raftå¤„æ£€æµ‹åˆ°èº«ä»½å˜æ›´æ—¶ï¼Œå°±åº”å½“ç”±æ–°çš„leaderå»ç”Ÿæˆä¸€ä»½æ–°çš„é…ç½®+versionã€‚å°†å…¶è¿”å›ç»™client\n1 2 3 4 5 6 7 8 9 10 func (s *StateMachine) listenRaftState() { for state := range s.stateChangeC { s.mu.Lock() trace.Trace(trace.Vote, s.NodeId, \u0026#34;raft state update: before: %s,current: %s\u0026#34;, stmap[s.raftState], stmap[state]) // å¦‚æœæ˜¯Leaderï¼Œé‚£ä¹ˆå°±ç”Ÿæˆæ–°é…ç½® s.raftState = state s.mu.Unlock() } } Witness ç”±äºLeaderè¿›è¡Œäº†æŠ¢è·‘ï¼Œå› æ­¤ä¼šæœ‰ä¸€äº›è¯·æ±‚è¿˜æœªcommitï¼Œä½†ä¹Ÿå·²ç»è¿”å›ç»™clientäº†ï¼Œè¿™äº›è¯·æ±‚çš„ç»“æœï¼Œæˆ–è€…è¯´è¿™äº›è¯·æ±‚å¯¹çŠ¶æ€æœºçš„å½±å“æš‚æ—¶ä¸ä¼šæš´éœ²å‡ºæ¥ï¼ˆåç»­å¦‚æœæƒ³è¦è·å–ç»“æœï¼Œæˆ–è€…è¯´å¯¹å…¶ä¿®æ”¹ï¼Œéƒ½ä¼šå› å†²çªè€Œè¢«æ‹’ç»ï¼‰ä½†æ˜¯è¯·æ±‚æˆåŠŸä¹Ÿç¡®å®æ˜¯å®æ‰“å®çš„å“åº”ç»™clientäº†ã€‚å› æ­¤è¿™ä¸€éƒ¨åˆ†çš„è¯·æ±‚ç»“æœä¸èƒ½ä¸¢å¤±ï¼Œä½†æ˜¯åˆæ²¡æœ‰é€šè¿‡logå‘é€ç»™followerï¼Œå› æ­¤å°±éœ€è¦é€šè¿‡Witnessä¸­çš„å­˜å‚¨æ¥å®Œæˆæ¢å¤ã€‚\nå…·ä½“æ¥è¯´ï¼Œéœ€è¦æ·»åŠ ä¸€æ¡rpcï¼Œä½¿å¾—æ–°çš„Leaderèƒ½å¤Ÿè·å–åˆ°followerçš„witnessä¸­çš„æ•°æ®ï¼Œç„¶åå†leaderå¤„æŒ‰ç…§é¡ºåºæ‰§è¡Œå¹¶å†™å…¥logã€‚ä»è€Œè§£å†³å†²çªå¹¶ç¡®å®šé¡ºåºã€‚å½“log commitæ—¶ï¼Œå³å¯è‡ªåŠ¨åˆ é™¤æ‰witnessä¸­çš„å†…å®¹ã€‚\nSummary æœ¬æ–‡åŸºäºetcd/raftï¼Œå®ç°äº†ä¸€ä¸ªç®€æ˜“çš„CURPï¼Œæä¾›äº†fast path + slow pathçš„é€»è¾‘ï¼Œä½¿å¾—ä¸å†²çªçš„è¯·æ±‚å¯ä»¥åœ¨ä¸€ä¸ªRTTå®Œæˆã€‚ç›®å‰è¿˜æ¬ ç¼ºrecoveryçš„é€»è¾‘ï¼Œä½†ä¸´è¿‘æ¯•ä¸šï¼Œç¬”è€…ç²¾åŠ›å®åœ¨æœ‰é™ï¼ŒçŸ­æ—¶é—´å†…åº”è¯¥æ˜¯æ²¡æœ‰ç²¾åŠ›å»è¡¥å®Œäº†ã€‚å¦‚æœæƒ³å­¦ä¹ å·¥ä¸šçº§CURPçš„å®ç°ï¼Œå¯ä»¥å»çœ‹Xlineï¼šGitHub - xline-kv/Xline: A geo-distributed KV store for metadata management\nç›®å‰çš„curpå’Œç»„é‡Œçš„ä¸€ä¸ªé¡¹ç›®ä»£ç æ··åœ¨ä¸€èµ·ï¼Œä¸å¤ªæ–¹ä¾¿å…¨éƒ¨å¼€æºï¼Œç­‰åç»­æœ‰ç©ºäº†ç»™åˆ†ç¦»å‡ºæ¥æ‰”åˆ°githubä¸Šã€‚\nå¯¹äºCURPè€Œè¨€ï¼Œè™½ç„¶å…¶åœ¨æ€§èƒ½ä¸Šé¢†å…ˆRaftä¸å°‘ï¼Œä½†æ˜¯åœ¨ç¬”è€…æµ‹è¯•çš„è¿‡ç¨‹ä¸­ï¼Œå‘ç°slow pathå¯¹äºç³»ç»Ÿæ€§èƒ½å½±å“è¾ƒå¤§ï¼Œectd/raftä¸­ï¼Œlogæ˜¯ç”±wal + å†…å­˜å®ç°å­˜å‚¨çš„ï¼Œå…³é—­walä¹‹åï¼Œworkloadaå¯ä»¥ä» 5sç¼©çŸ­è‡³ 3så·¦å³ï¼Œé‚£ä¹ˆæ˜¯å¦æœ‰ä¸€ç§åŠæ³•åœ¨ä¸å­˜åœ¨å†²çªæ—¶å½»åº•ç»•è¿‡slow pathå‘¢ï¼Ÿ\n","permalink":"https://fischer0522.github.io/en/posts/tech/curp/%E4%BB%8E0.5%E5%88%B01%E5%AE%9E%E7%8E%B0curp/","summary":"Intro ä»€ä¹ˆæ˜¯CURP Curpæ˜¯ä¸€ç§æ–°çš„åˆ†å¸ƒå¼å…±è¯†ç®—æ³•ï¼Œcurpçš„æå‡ºæ˜¯é’ˆå¯¹äºè·¨åŸŸç­‰é«˜ç½‘ç»œå»¶è¿Ÿåœºæ™¯ï¼Œä¼ ç»Ÿçš„raftå’Œpaxosç­‰å…±è¯†ç®—æ³•éœ€è¦ä¸¤ä¸ªR","title":"02-ä»0.5å®ç°CURP"},{"content":"èƒŒæ™¯ åŠ¨æœºï¼šç›®å‰çš„ä¸€äº›å®¹é”™ç®—æ³•æˆ–è€…è¯´å…±è¯†ç®—æ³•ï¼Œæ— è®ºæ˜¯ç®€å•çš„ä¸»ä»ç»“æ„è¿˜æ˜¯Raft Paxosç­‰ï¼Œéƒ½éœ€è¦ä¸¤ä¸ªRTTæ¥å®Œæˆï¼Œç¬¬ä¸€ä¸ªRTTç”±Clientåˆ°Primary (Leader)ï¼Œç¬¬äºŒä¸ªRTTç”±Primaryåˆ°Backup (Follower)ã€‚åœ¨åŒä¸€ä¸ªæ•°æ®ä¸­å¿ƒä¸­ï¼Œä¸¤ä¸ªRTTå¹¶ä¸ä¼šå‡ºç°ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ˜¯åœ¨è·¨æ•°æ®ä¸­å¿ƒæˆ–è€…è¯´è·¨äº‘çš„æƒ…å†µä¸‹ï¼Œå¤šå‡ºçš„ä¸€ä¸ªRTTå°±æ˜¾å¾—æœ‰ç‚¹éš¾ä»¥æ¥å—ã€‚\nåƒæ˜¯CockRoachDBé‚£æ ·é¢å¯¹geo-distributedçš„æƒ…å†µå¯¹Raftçš„é…ç½®åšå‡ºä¸€äº›é¢å¤–çš„ä¼˜åŒ–ï¼Œä½†æ˜¯æœ¬è´¨ä¸Šä¾æ—§é€ƒç¦»ä¸äº†ä¸¤ä¸ªRTTçš„æ—¶é—´å¼€é”€ï¼Œquoromå¯ä»¥åœ¨ä¸€ä¸ªRTTæ¥å®Œæˆå…±è¯†ï¼Œä½†æ˜¯æ— æ³•æä¾›çº¿æ€§ä¸€è‡´æ€§ï¼ˆåœ¨å­˜åœ¨ä¸ç¡®å®šç½‘ç»œå»¶è¿Ÿæ—¶å°±ä¼šå‡ºç°ï¼Œå¦‚ä¸‹å›¾ï¼‰ã€‚è¿˜æœ‰ä¸€äº›å…±è¯†ç®—æ³•éœ€è¦ä¾é ç‰¹æ®Šçš„ç½‘ç»œç¡¬ä»¶æ¥åŠ é€Ÿï¼Œä½†æ˜¯å¹¶ä¸å…·æœ‰æ™®é€‚æ€§ã€‚å› æ­¤æå‡ºäº†CURPæ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚\nå…ˆè¯´å‡ ä¸ªCURPçš„ç‰¹æ€§ï¼š\nCURPæ˜¯éä¾µå…¥æ€§çš„ï¼Œå¯ä»¥ç®—æ˜¯åœ¨ä¸»ä»å¤‡ä»½çš„æ¶æ„ä¸Šå¤–æŒ‚äº†ä¸€éƒ¨åˆ†é€»è¾‘ï¼Œå› æ­¤åœ¨æ–‡ä¸­å¹¶æ²¡æœ‰å¹¶æ²¡æœ‰å¦‚ä½•ä»‹ç»ä¸»ä»è¿™ä¸€éƒ¨åˆ†çš„é€»è¾‘\nCURPçš„æå‡ºåŸºäºè¿™æ ·çš„ä¸€ä¸ªè§‚ç‚¹ï¼šé¦–å…ˆï¼Œå„ä¸ªæ“ä½œä¹‹é—´å¹¶ä¸éœ€è¦ä¸€ä¸ªå…¨å±€çš„é¡ºåºï¼Œæˆ‘ä»¬åªéœ€è¦å¯¹å­˜åœ¨å†²çªæˆ–è€…è¯´äº’ä¸å…¼å®¹çš„å†…å®¹ä¹‹é—´å»ºç«‹ä¸€ä¸ªååº (è¿™é‡Œä»¥kvè¿›è¡Œè®¨è®º)ï¼Œå³ set x =5 å’Œ set x=7 ä¹‹é—´æ˜¯å†²çªçš„ï¼Œè¿™æ—¶å€™å°±éœ€è¦å»ºç«‹ä¸€ä¸ªé’ˆå¯¹è¯¥keyçš„æ‰§è¡Œé¡ºåºï¼Œå…¶ä»–æƒ…å†µä¸‹ï¼Œå„ä¸ªå‘½ä»¤å¯ä»¥ä»¥ä»»æ„é¡ºåºæ‰§è¡Œï¼Œåƒæ˜¯set x = 5, set y =3 ä»»æ„é¡ºåºæ‰§è¡Œï¼Œäº’ä¸å¹²æ‰°ã€‚(ç”±äºç½‘ç»œå»¶è¿Ÿé—®é¢˜ï¼Œkeyå¯èƒ½ä»¥ä¸åŒé¡ºåºåˆ°è¾¾ä¸åŒèŠ‚ç‚¹ï¼Œå¦‚æœç›´æ¥æ‰§è¡Œåˆ™ä¼šå¾—åˆ°ä¸åŒçš„ç»“æœ)\næŒä¹…åŒ–ä¸é¡ºåºåˆ†ç¦»ï¼šä¼ ç»Ÿç®—æ³•ä¸€èˆ¬é€šè¿‡Primary/Leaderç¡®å®šä¸€ä¸ªå…¨å±€çš„é¡ºåºï¼Œç„¶åå¹¿æ’­ç»™Followerï¼Œä¹‹åFollowerå›åº”ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å®Œæˆäº†æŒä¹…åŒ–ï¼Œä¿è¯å´©æºƒä¹‹åä¾æ—§èƒ½å¤Ÿæ¢å¤å‡ºæ¥ï¼Œåœ¨CURPå½“ä¸­å°†äºŒè€…åˆ†ç¦»ï¼Œåœ¨Witnessä¸­å®Œæˆä¸€ä¸ªä¸´æ—¶çš„å­˜å‚¨ï¼ˆä¸´æ—¶ä½†æŒä¹…åŒ–)ï¼Œä½†å¹¶ä¸ä¼šè®°å½•ä»»ä½•çš„é¡ºåºä¿¡æ¯ï¼Œå½“å†²çªçš„æ—¶å†ä¾èµ–Primaryç¡®å®šå†²çªkeyä¹‹é—´çš„ååºï¼Œå†ç”±Primaryå¹¿æ’­ç»™backupå»æ‰§è¡Œï¼Œè¿™æ ·å¯ä»¥ä¿è¯ä¸€è‡´æ€§é¡ºåºï¼Œä½†æ˜¯ä»£ä»·æ˜¯éœ€è¦ä¸¤ä¸ªRTTï¼Œæœ€å·®æƒ…å†µä¸‹éœ€è¦ä¸‰ä¸ªRTT (Client -\u0026gt; Witnessæ£€æµ‹åˆ°å†²çªï¼ŒClient-\u0026gt;Primaryç”Ÿæˆé¡ºåºï¼ŒPrimary-\u0026gt;BackupæŒ‰åºæ‰§è¡Œ)\nCURP éä¾µå…¥å¼æ¶æ„ CURPæœ¬èº«æ˜¯åŸºäºPrimary-Backupæ¶æ„çš„æ‹“å±•(f+1 ä¸ªèŠ‚ç‚¹å…¶ä¸­ä¸€ä¸ªä¸ºPrimaryå‰©ä¸‹ä¸ºBackup)ã€‚éä¾µå…¥å¼çš„æ„å»ºäºæ™®é€šçš„Primary-Backupæ¶æ„ä¹‹ä¸Šï¼Œåœ¨æ­¤ä¹‹ä¸ŠWitnessï¼ŒPrimaryå’ŒBackupæŒ‰ç…§åŸæœ¬çš„é€»è¾‘ç»§ç»­æ‰§è¡Œï¼Œå³Primaryæ‰§è¡Œåå‘é€ç»™Backupè¿›è¡Œå¤‡ä»½ï¼ŒWitnessç”¨äºè¿›è¡Œå†²çªæ£€æµ‹ï¼Œä¼šè®°å½•å½“å‰è¿˜æœªcommitçš„è¯·æ±‚ã€‚Witnesså’ŒBackupæ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„é€»è¾‘æ¦‚å¿µï¼ŒBackupç”¨äºæ‰§è¡Œï¼ŒWitnessç”¨äºè®°å½•å’Œæ£€æµ‹ï¼Œä½†æ˜¯äºŒè€…åœ¨æ„å»ºç³»ç»Ÿæ—¶ï¼Œå¯ä»¥æ„å»ºäºåŒä¸€å°ä¸»æœºä¹‹ä¸Š\nCURPæä¾›äº†çº¿æ€§ä¸€è‡´æ€§å’Œfail-stopæ¨¡å‹ï¼Œä¸ä¼šå¤„ç†æ‹œå åº­é”™è¯¯\nClient Clientçš„è¡Œä¸ºé€»è¾‘åœ¨åŸæœ¬ä¸Primaryé€šä¿¡çš„åŸºç¡€ä¸Šï¼Œä¼šå¹¶è¡Œçš„å‘Witnesså‘é€ä¿¡æ¯ï¼ŒPrimaryå‘Backupå¤‡ä»½ï¼ŒWitnessåšè®°å½•ï¼Œä½†æ˜¯Primaryåœ¨å¤‡ä»½å‰å°±ä¼šå‘Clientå›å¤, ä¸€æ—¦Clientæ¥å—åˆ°äº†fä¸ªå“åº”ï¼Œé‚£ä¹ˆå°±å¯ä»¥è®¤ä¸ºæ­¤æ¬¡è¯·æ±‚å®Œæˆï¼Œä¸»å¤‡åŒæ­¥åç»­å¼‚æ­¥çš„å®Œæˆã€‚æ­¤æ¬¡è¯·æ±‚å¯ä»¥åœ¨ä¸€æ¬¡RTTå†…å®Œæˆã€‚\nå¦‚æœæ— æ³•æ”¶åˆ°fä¸ªæ­£ç¡®çš„å“åº” (èŠ‚ç‚¹å´©æºƒæˆ–è€…äº§ç”Ÿå†²çªè¢«æ‹’ç»)ï¼Œåˆ™æ— æ³•åœ¨ä¸€ä¸ªRTTå†…å®Œæˆè¯·æ±‚ï¼Œæ­¤æ—¶éœ€è¦Primaryä»‹å…¥, clienté€šè¿‡sync rpcæ¥é€šçŸ¥Primaryï¼Œä»¥Primaryçš„é¡ºåºå®Œæˆæ‰§è¡Œå¹¶å¤‡ä»½ï¼Œæ­¤æ—¶éœ€è¦ 2 ä¸ª-3 ä¸ªRTTæ‰èƒ½å¤Ÿå®Œæˆè¯·æ±‚ã€‚(client-\u0026gt;primary, primary-\u0026gt;backupä¸ºä¸¤ä¸ªï¼Œclient-\u0026gt;witnessï¼Œclientæ¥æ”¶åˆ°å†²çªä¹‹åprimaryè¿˜æœªå¼€å§‹è¿›è¡ŒåŒæ­¥ï¼Œé‚£ä¹ˆé™¤äº†client-\u0026gt;witnessï¼Œè¿˜éœ€è¦é¢å¤–çš„client-\u0026gt;primary, primary-\u0026gt;backupå…±ä¸‰ä¸ªRTT)ã€‚ åœ¨å®é™…çš„å®ç°ä¸Šï¼Œå¯ä»¥é€‰æ‹©åŒæ—¶å¼€å¯fast pathå’Œslow pathï¼Œå³åŒæ—¶è¿›è¡Œproposeå’Œwait_syncedï¼Œè¿™æ ·çš„å¥½å¤„æ˜¯å¯ä»¥ä¿è¯åœ¨æœ€å·®çš„æƒ…å†µä¸‹ï¼Œ 2RTTä¹Ÿå¯ä»¥è§£å†³ï¼Œå³å¯ä»¥çœç•¥æ‰clientå‘primaryå‘é€ sync rpcçš„è¿™ä¸ªæ­¥éª¤ï¼Œæœ€å·®çš„æƒ…å†µä¸‹ï¼Œåªéœ€è¦clientåŒæ—¶å‘é€proposeå’Œwait_syncedï¼Œclientä¸wait_syncedä¹‹é—´å­˜åœ¨ä¸€ä¸ªRTTï¼Œprimaryå’Œbackupè¿›è¡ŒåŒæ­¥æ—¶å­˜åœ¨ä¸€ä¸ªRTTï¼Œwait_syncedç­‰åˆ°ä¸»ä»åŒæ­¥å®Œæˆå³å¯è¿”å›ï¼Œä½†æ˜¯ä»£ä»·æ˜¯clientéœ€è¦æ—¶åˆ»å‘serverå‘é€ä¸¤ä¸ªè¯·æ±‚ (wait_syncedçš„ç»“æœåœ¨fast pathå¯ä»¥å¾—åˆ°ç»“æœæ—¶å¯ä»¥å¿½ç•¥)ã€‚\nWitness Witness æ”¯æŒ 3 ä¸ªåŸºæœ¬æ“ä½œï¼šè®°å½•å“åº”å®¢æˆ·ç«¯è¯·æ±‚ï¼Œä¿å­˜ç›´åˆ°è¢«å‘ŠçŸ¥ä¸¢å¼ƒï¼Œä»¥åŠåœ¨recoveryæ—¶æä¾›å­˜å‚¨çš„æ•°æ®ã€‚å¹¶ä¸”å„ä¸ªWitnessä¹‹é—´ç‹¬ç«‹å·¥ä½œæ— éœ€è¿›è¡Œé€šä¿¡ã€‚\nWitnessçš„è®°å½•å¹¶ä¸æä¾›é¡ºåºï¼Œä»…è®°å½•è¯·æ±‚æœ¬èº«ï¼Œç„¶ååšå†²çªæ£€æµ‹ï¼ŒWitnessä¸­çš„å†…å®¹éœ€è¦æŒä¹…åŒ–ä¿å­˜ï¼Œä»¥ç”¨äºè¿›è¡Œrecoveryï¼Œä½†æ˜¯åˆä»…éœ€è¦ä¸´æ—¶ä¿å­˜ï¼Œå› æ­¤å¯èƒ½åƒæ˜¯NVMä¼šæ›´åˆé€‚ä¸€äº›ã€‚\nå¯¹äºå†²çªæ£€æµ‹ï¼Œç±»ä¼¼äºsqlæˆ–è€…å…¶ä»–çš„åŸç”Ÿè¯·æ±‚å¾ˆéš¾åˆ¤æ–­å‡ºæ¶‰åŠåˆ°çš„æ•°æ®çš„å†²çªï¼Œå› æ­¤ï¼Œå°†è¿™ä¸ªè¿‡ç¨‹ä¸‹æ¨åˆ°å­˜å‚¨å±‚ä»¥kvçš„å½¢å¼æ¥å¤„ç†æ›´åŠ åˆç†ï¼Œä»¥kvä¸ºå•ä½è¿›è¡ŒåŒæ­¥å’Œå†²çªæ£€æµ‹ï¼ˆå³SQLæ„å»ºäºKVä¹‹ä¸Šï¼Œç±»ä¼¼CockroachDBæˆ–è€…TiDBï¼‰ã€‚\nMaster CURP ä¸­çš„Masteræ¥æ”¶ã€åºåˆ—åŒ–å¹¶æ‰§è¡Œæ¥è‡ªå®¢æˆ·ç«¯çš„æ‰€æœ‰æ›´æ–° RPC è¯·æ±‚ã€‚å¯¹äºéåªè¯»è¯·æ±‚ï¼Œä¼šå‘Backupè¿›è¡ŒåŒæ­¥ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯å¼‚æ­¥çš„ï¼Œåœ¨é€šè¿‡logåŒæ­¥æ•°æ®ä¹‹å‰ä¼šå…ˆå“åº”Clientä»¥ä¿è¯ä¸€ä¸ªRTTå®Œæˆè¯·æ±‚ã€‚è€Œå¦‚æœmasteræ£€æµ‹åˆ°äº†å†²çªï¼Œåˆ™å¿…é¡»åœ¨å›å¤ClientæˆåŠŸä¹‹å‰å®ŒæˆåŒæ­¥ï¼Œæ­¤æ—¶å°±æ˜¯ 2 ä¸ªRTTï¼Œæ­¤æ—¶ä»¥Syncedä½œä¸ºç»“æœå“åº”Clientï¼ŒClientæ”¶åˆ°ä¹‹åï¼Œå°±å¯ä»¥é¿å…Clientå»å†æ¬¡å‘é€sync rpc\nRecovery recoveryæ¯”è¾ƒçš„ç›´è§‚ï¼Œç”±äºæ•°æ®å­˜å‚¨åœ¨ä¸¤éƒ¨åˆ†ä¸Šï¼Œé‚£ä¹ˆæ¢å¤åŒæ ·ä¹Ÿæ˜¯ä»ä¸¤éƒ¨åˆ†æ¢å¤ï¼Œå³é¦–å…ˆä»backupï¼Œç„¶åæ˜¯witnessï¼Œåœ¨è¿›è¡Œwitnessæ¢å¤æ—¶ï¼Œéœ€è¦ä¿è¯è‡³å°‘fä¸ªwitnessåœ¨çº¿ã€‚åœ¨æ•´ä¸ªæ¢å¤è¿‡ç¨‹ä¸­ï¼Œéœ€è¦åœæ­¢æ¥å—å‰å°æ–°çš„è¯·æ±‚ (masterå’Œwitness)ã€‚\nGC Witnessä»…ä½œä¸´æ—¶å­˜å‚¨ç”¨äºåˆ¤æ–­å†²çªï¼Œå› æ­¤å½“masteræˆåŠŸå°†æ•°æ®åŒæ­¥åˆ°backupä¸Šä¹‹åï¼Œæ•°æ®å³å¯å®‰å…¨åˆ é™¤ï¼Œè¿™ä¸ªåŠ¨ä½œç”±masteré€šçŸ¥witnessæ¥å®Œæˆã€‚\né›†ç¾¤ä¿¡æ¯æ›´æ–° å¯¹äºé›†ç¾¤ä¿¡æ¯æ›´æ–°ï¼Œä¸»è¦æ¶‰åŠåˆ°ä¸‰éƒ¨åˆ†ï¼Œä¸»åŠ¨çš„æˆ–è¢«åŠ¨çš„ï¼Œåˆ†åˆ«æ˜¯backupå®•æœºï¼Œwitnesså®•æœºï¼Œå’ŒPrimaryè¿ç§»ï¼š\nå¯¹äºbackupå®•æœºï¼Œcurpæ˜¯éä¾µå…¥å¼çš„ï¼Œå› æ­¤è¿™ä¸€éƒ¨åˆ†äº¤ç»™åŸæœ¬çš„primary-backupåè®®æ¥å¤„ç† witnesså®•æœºï¼šconfiguration mangerä¼šå°†å®•æœºçš„witnessä»é…ç½®ä¸­ä¸‹çº¿ï¼Œç„¶ååˆ†é…ä¸€ä¸ªæ–°çš„witnessç»™manager (è¿™é‡Œå¼•å‡ºäº†ä¸€ä¸ªæ–°çš„æ¦‚å¿µå³configuration managerï¼Œä½†æ˜¯å¹¶æ²¡æœ‰å…·ä½“è¯´æ˜å®ç°æ–¹å¼ï¼Œä»…ä»…ç”¨\u0026quot;the owner of all cluster configurations\u0026quot;ï¼Œç©¶ç«Ÿæ˜¯å•ç‹¬çš„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè¿˜æ˜¯ç”±masteræ‹…å½“æ²¡æœ‰è¯¦ç»†ä»‹ç»)ã€‚æ­¤æ—¶ï¼Œclientä¾æ—§ä¼šå°†ä¿¡æ¯å‘é€åˆ°æ—§é…ç½®ä¸­å·²ç»ä¸‹çº¿çš„èŠ‚ç‚¹ï¼Œä¸ºäº†è§£å†³è¯¥é—®é¢˜ï¼Œcurpå¼•å…¥äº†ç‰ˆæœ¬æœºåˆ¶ï¼Œå³clientåœ¨ä»configuration managerå¤„è·å–åˆ°witness listæ—¶ä¼šè·å–åˆ°ä¸€ä¸ªversionï¼Œä¹‹åè¯·æ±‚æ—¶æºå¸¦ä¸Šè¿™ä¸ªversionï¼Œmatsterå¤„åŒæ ·ä¼šä¿å­˜witness listå’Œversionï¼Œversionä¼šéšç€æ¯æ¬¡é…ç½®æ›´æ–°è‡ªå¢ã€‚masterå¦‚æœå‘ç°clientæºå¸¦äº†æ—§çš„versionï¼Œå°±ä¼šæ‹’ç»ï¼Œå¹¶ä¸”è¿”å›æœ€æ–°çš„witness listç»™clientï¼Œä¹‹åclientå†æ ¹æ®æœ€æ–°çš„é…ç½®å»è¯·æ±‚ã€‚ æ•°æ®è¿ç§»ï¼šæ•°æ®è¿ç§»åˆ†ä¸ºä¸¤é˜¶æ®µï¼š åœ¨ç¬¬ä¸€é˜¶æ®µä¼šç»§ç»­æä¾›æœåŠ¡ï¼Œå¹¶ä¸”è¿›è¡Œæ•°æ®è¿ç§» åœ¨ç¬¬äºŒé˜¶æ®µè¿›è¡Œæ”¶å°¾å·¥ä½œï¼Œç»ˆæ­¢æ‰æœåŠ¡ä»¥ä¾¿è¿ç§»æ‰€æœ‰æ•°æ®ï¼Œæœ€åæ›´æ–°é…ç½® ä¸ºäº†è¿›è¡Œç®€åŒ–ï¼Œåœ¨ç¬¬äºŒé˜¶æ®µå‰ä¼šå°†å½“å‰masterçš„æ•°æ®åŒæ­¥åˆ°backupä¸Šï¼Œç„¶åé‡ç½®witnessï¼Œä¹‹ååœæ­¢æœåŠ¡ï¼Œå› æ­¤ï¼Œåœ¨æ•´ä¸ªè¿ç§»è¿‡ç¨‹ä¸­ï¼Œwitnesså®Œå…¨ä¸å‚ä¸ (ä»…åœ¨ç¬¬ä¸€é˜¶æ®µç”¨äºæä¾›æœåŠ¡æ£€æµ‹å†²çª)ï¼Œä¹‹åclientä¹Ÿä¼šè¢«æ‹’ç»ç„¶åé‡æ–°æ‹‰å–é…ç½® (è¿™ä¸€éƒ¨åˆ†ä¾æ—§æœ‰åŸºç¡€çš„primary-backupæ¥è´Ÿè´£) Backup Read ä¸ºäº†å®ç°ä»æœºè¯»ï¼Œcurpåˆ©ç”¨witnessæ¥é¿å…è¯»å–åˆ°é™ˆæ—§çš„æ•°æ®ï¼Œcurpä¼šé€‰æ‹©ä¸€ä¸ªå°±è¿‘çš„witness (æˆ–è€…åŒä¸€ä¸»æœºä¸Šçš„)ï¼Œè¿›è¡Œå†²çªæ£€æµ‹ï¼Œå¦‚æœä¸å­˜åœ¨å†²çªï¼Œé‚£ä¹ˆå°±å¯ä»¥è®¤ä¸ºå½“å‰backupä¸Šçš„æ•°æ®æ˜¯æœ€æ–°çš„ï¼Œå¯ä»¥è¿›è¡Œè¯»å–ï¼Œå¦åˆ™åˆ™ä¼šå­˜åœ¨é™ˆæ—§æ•°æ®ï¼Œéœ€è¦ä»masterå¤„è¯»å–ã€‚\nç”±äºwitnessä¸Šçš„gcä¾èµ–äºbackupçš„syncï¼Œå› æ­¤å¦‚æœåœ¨witnessä¸Šèƒ½æ‰¾åˆ°ä¸€ä¸ªå†²çªçš„keyï¼Œé‚£ä¹ˆå°±è¯æ˜å½“å‰keyæœ‰æ­£åœ¨å†™å…¥çš„å…¶ä»–è¯·æ±‚ï¼Œç”±äºå†™backupä¹‹é—´å­˜åœ¨å»¶è¿Ÿï¼Œç›´æ¥ä»æœºè¯»å°±ä¼šç ´åé’ˆå¯¹è¯¥keyçš„é¡ºåºï¼Œå› æ­¤ä¼šè¿åçº¿æ€§ä¸€è‡´æ€§ (å¦‚æœå‘ç°å†²çªï¼Œé‚£ä¹ˆè¯»å–çš„æµç¨‹å°±å¦‚ä¸‹å›¾ï¼š\nç”±äºprimary-backupæ¶æ„ä¸‹ä¸å­˜åœ¨ï¼ˆn +1ï¼‰/2 è¿™æ ·çš„commitï¼Œéœ€è¦å†™åˆ°æ‰€æœ‰çš„backupä¸Šæ‰èƒ½å¤Ÿè®¤å®šä¸ºcommitï¼Œåªæœ‰å®Œå…¨åŒæ­¥ä¹‹åï¼Œæ‰èƒ½å¤Ÿå…è®¸ä»æœºè¯»ï¼Œè¿™ç§è®¾ç½®æ˜¯å¿…è¦çš„ï¼Œé€šè¿‡witnessè¿›è¡Œå†²çªæ£€æµ‹ä¹Ÿæ˜¯ä¸ºäº†ä¿è¯è¿™ä¸ªï¼Œå¦‚æœè¿åï¼Œåœ¨ä¸¤ç§æƒ…å†µä¸‹ä¼šå‡ºç°é—®é¢˜ï¼š\né¦–å…ˆä»backup1 ä¸Šè¯»å–åˆ°äº†x =1ï¼Œç¬¬äºŒæ¬¡è¯·æ±‚å‘é€åˆ°äº†backup2ï¼Œbackup2 åŒæ­¥é€Ÿåº¦æ…¢äºbackup1ï¼Œä¼šè¯»å–åˆ°x=0ï¼Œè¯»å–åˆ°äº†é™ˆæ—§çš„æ•°æ®ï¼Œå› æ­¤éœ€è¦æ‹’ç»æ‰ç¬¬ä¸€æ¬¡çš„è¯»å– masterå®•æœºæ¢å¤æ—¶åŒæ ·ä¼šå‡ºç°é—®é¢˜ï¼Œclientä»ä¸€ä¸ªè¿›åº¦æ¯”è¾ƒæ–°çš„backupä¸Šè¯»å–äº†æ•°æ®ï¼Œä½†æ˜¯masteré€‰æ‹©ä»ä¸€ä¸ªè¿›åº¦æ¯”è¾ƒè½åçš„backupæ¢å¤æ•°æ®ï¼Œæ­¤æ—¶å†ä»masterè¯»å–ï¼Œå°±ä¼šè¯»å–åˆ°é™ˆæ—§çš„æ•°æ® CURP-Q CURP-Qä½œä¸ºCURPçš„æ‰©å±•ï¼Œåœ¨CURPä½œè€…çš„phdè®ºæ–‡ä¸­è¿›è¡Œäº†ä»‹ç»ï¼Œè¿™é‡Œç®€å•æä¸€ä¸‹ã€‚ç”±äºcurpæœ¬èº«æ˜¯éä¾µå…¥å¼çš„ï¼Œå³ç„¶å¯ä»¥æ„å»ºäºä¸»ä»æ¶æ„ä¸Šï¼Œé‚£ä¹ˆæ„å»ºäºé€‰ä¸¾å…±è¯†ç®—æ³• (è¿™é‡Œä»¥Raftä¸ºä¾‹)è‡ªç„¶ä¹Ÿæ˜¯æ²¡ä»€ä¹ˆé—®é¢˜ã€‚\nåœ¨ç½‘ç»œæ­£å¸¸çš„æƒ…å†µä¸‹ï¼Œå°±èµ°fast pathï¼Œé€šè¿‡ witnesså¿«é€Ÿåœ¨ä¸€ä¸ªRTTå®Œæˆï¼Œå¦‚æœå­˜åœ¨å†²çªï¼Œé‚£ä¹ˆèµ°slow pathï¼Œå€ŸåŠ©Raftçš„æ—¥å¿—æ¥è§£å†³å†²çªç¡®å®šé¡ºåºã€‚å„ä¸ªèŠ‚ç‚¹çš„èº«ä»½ç”±Raftæœ¬èº«é€‰ä¸¾å®Œæˆï¼Œæ—¥å¿—å¤åˆ¶åŒæ ·å¯ä»¥äº¤ç»™Raftæ¥å®Œæˆã€‚Witnessä¸Followeræ­¤æ—¶æ„å»ºäºåŒä¸€ä¸ªç‰©ç†ä¸»æœºä¸Šã€‚\nç®€è€Œè¨€ä¹‹ï¼ŒRaftæ— éœ€åšä»»ä½•ä¿®æ”¹ï¼Œåªéœ€è¦æŒ‰ç…§å…¶åŸæœ¬çš„é€»è¾‘è¿è¡Œï¼ŒCURP-Qæ„å»ºäºRaftä¹‹ä¸Šï¼Œæ ¹æ®å†²çªæ¥é€‰æ‹©æ˜¯å¦å°†å‘½ä»¤äº¤ç»™Raftæ¥æ‰§è¡Œï¼ŒCURP-Qçš„æ¶æ„å¦‚ä¸‹ï¼›\nSummary CURPä¸ºåˆ†å¸ƒå¼å…±è¯†ç®—æ³•å¸¦æ¥äº†æ–°çš„æ€è€ƒï¼Œå³ä¸ºäº†å®ç°çº¿æ€§ä¸€è‡´æ€§ï¼Œæˆ‘ä»¬å¹¶ä¸æ˜¯åœ¨æ‰€æœ‰æƒ…å†µéƒ½éœ€è¦ç¡®å®šä¸€ä¸ªå…¨å±€é¡ºåºï¼Œå¯¹äºä¸å­˜åœ¨å†²çªçš„keyï¼Œå¯ä»¥æŒ‰ç…§ä»»æ„é¡ºåºæ‰§è¡Œã€‚å¯¹äºå†²çªçš„keyï¼Œå†é€‰æ‹©ä¸€ä¸ªå¯ä»¥æä¾›çº¿æ€§ä¸€è‡´æ€§çš„ç®—æ³•æ¥å®Œæˆæ‰§è¡Œã€‚\nå› æ­¤ï¼ŒæŒ‰ç…§è¿™ç§æ€è·¯ï¼Œå¯ä»¥åšä¸€ä¸ªç»„åˆï¼Œå³fast pathé‡‡ç”¨ä¸€ä¸ªRTTèƒ½å®Œæˆçš„ç®—æ³• (2pc, quorum)ç­‰å‡å¯ï¼Œslow pathé€‰æ‹©ä¸€ä¸ªå¯ä»¥æä¾›çº¿æ€§ä¸€ç§çº¿æ€§ä¸€è‡´æ€§ä¿è¯çš„ç®—æ³• (Primary-backup, Raft, paxos)ã€‚\nå®ç°ï¼šcurpçš„è®ºæ–‡ä»£ç æ²¡æœ‰å¼€æºï¼Œç›®å‰èƒ½å¤Ÿæ‰¾åˆ°çš„æ¯”è¾ƒå¥½çš„å®ç°å°±æ˜¯Datenlordçš„Xlineï¼šGitHub - xline-kv/Xline: A geo-distributed KV store for metadata management\nXlineå®é™…é€‰æ‹©ä»¥Raftä½œä¸ºçº¿æ€§ä¸€è‡´æ€§çš„åˆ†å¸ƒå¼å…±è¯†ç®—æ³•ï¼Œå®ç°äº†ä¸€ä¸ªCURP-Qï¼Œç»†èŠ‚ä¸Šå¯èƒ½å’Œè®ºæ–‡æœ‰å‡ºå…¥ï¼Œä¸è¿‡æ¶æ„ä¸Šéµå¾ªäº†è®ºæ–‡ä¸­çš„è®¾è®¡ï¼Œrustå¼‚æ­¥æ¥å®ç°åˆ†å¸ƒå¼ï¼Œè¿˜æ˜¯å¾ˆå€¼å¾—ä¸€è¯»çš„ã€‚\nDiscussions æ­£ç¡®æ€§è¯æ˜ (éæ­£å¼) åœ¨æ­£ç¡®æ€§è¯æ˜è¿™ä¸€éƒ¨åˆ†ï¼Œä¸»è¦å…³æ³¨åœ¨å®•æœºæ¢å¤æ–¹é¢çš„ä¸‰ä¸ªé—®é¢˜ï¼š\næŒä¹…æ€§ï¼šå¦‚æœClientå®Œæˆäº†ä¸€æ¬¡è¯·æ±‚ï¼Œé‚£ä¹ˆè¯·æ±‚çš„ç»“æœåœ¨æ¢å¤ååº”å½“å­˜åœ¨ ä¸€è‡´æ€§ï¼šClientå®Œæˆäº†ä¸€æ¬¡è¯·æ±‚ï¼Œå¹¶ä¸”å¾—åˆ°äº†ç»“æœï¼Œé‚£ä¹ˆåœ¨æ¢å¤åç»“æœä¾æ—§æ˜¯ä¸€è‡´çš„ çº¿æ€§ä¸€è‡´æ€§ï¼šå®•æœºæ¢å¤åº”å½“ä¿è¯çº¿æ€§ä¸€è‡´æ€§ åœ¨è¯æ˜å‰ï¼Œé‡è¿°ä¸€éåœ¨å‰æ–‡ä¸­æåŠçš„è§„åˆ™ï¼š\nRule1: åªæœ‰è¯·æ±‚è¢«æ‰€æœ‰çš„witnessè®°å½•æˆ–è€…åŒæ­¥åˆ°æ‰€æœ‰çš„backupä¸Šé¢æ‰èƒ½å¤Ÿè®¤å®šä¸ºæˆåŠŸ Rule2ï¼šä¸€ä¸ªå®Œæˆäº†å¹¶ä¸”æœªåŒæ­¥çš„è¯·æ±‚ä¸€å®šä¸å…¶ä»–æœªåŒæ­¥çš„è¯·æ±‚ä¹‹é—´æ˜¯ä¸å†²çªçš„ æŒä¹…æ€§ åœ¨æ¢å¤è¿‡ç¨‹ä¸­ï¼Œmasterä¼šä»ä¸€ä¸ªbackupå’Œä¸€ä¸ªwitnessæ¥è¯»å–æ•°æ®ï¼Œæ ¹æ®ä¸Šè¿°è§„åˆ™ï¼Œè¦ä¹ˆå®ƒå·²ç»è¢«åŒæ­¥ï¼Œå¯ä»¥ä»backupä¸­è¯»å–åˆ°ï¼Œè¦ä¹ˆæœªåŒæ­¥ï¼Œä½†æ˜¯è®°å½•åœ¨witnesså½“ä¸­\nä¸€è‡´æ€§ è¿™é‡Œçš„ä¸€è‡´æ€§æŒ‡çš„æ˜¯æ¢å¤å‰åèƒ½å¤Ÿè¯»å–åˆ°çš„ç»“æœæ˜¯å¦ä¸€è‡´ï¼Œè€Œéçº¿å½¢ä¸€è‡´æ€§ã€‚æˆ‘ä»¬å°†è¯·æ±‚ç§°ä¸º $a$ï¼Œè€Œå¯¹äºkey aä¹‹å‰çš„ç»“æœç§°ä¸º $H_a$ã€‚åœ¨è¿›è¡Œå®•æœºæ¢å¤æ—¶ï¼Œå…±æœ‰ 2 ç§æƒ…å†µï¼š\n$a$ å·²ç»è¢«åŒæ­¥åˆ°backupï¼šé‚£ä¹ˆå°±å¯ç›´æ¥é€šè¿‡backupè¿›è¡Œæ¢å¤ï¼Œå¹¶ä¸”ç”±äºå»é‡æœºåˆ¶RIFLçš„å­˜åœ¨ï¼Œwitnessä¸­è¿˜æœªæ¥å¾—åŠgcçš„å†…å®¹ä¹Ÿä¸ä¼šå½±å“ç»“æœ $a$ è¿˜æœªè¿›è¡ŒåŒæ­¥ï¼šæ ¹æ®è§„åˆ™ 2ï¼Œè¿˜æœªåŒæ­¥å¹¶ä¸”è¯·æ±‚æˆåŠŸï¼Œé‚£ä¹ˆä¸€å®šè®°å½•åœ¨witnessä¸­ï¼Œå¹¶ä¸”æ˜¯ä¸å†²çªçš„ï¼Œç›´æ¥æ¢å¤å³å¯ï¼Œè€Œæ¢å¤è¿‡ç¨‹å…ˆæ¢å¤backupä¸­çš„å†…å®¹ï¼Œå› æ­¤backupä¸­çš„ $H_a$ ä¼šè¢«witnessä¸­çš„å†…å®¹è¦†ç›–ï¼Œå› æ­¤ä¸ä¼šå§æ›¾ç»çš„å†å²è®°å½•æš´éœ²å‡ºæ¥ çº¿æ€§ä¸€è‡´æ€§ è¿™é‡Œä¾æ—§åˆ†ä¸ºä¸‰ç§æƒ…å†µè®¨è®ºï¼š\nå®•æœºå‰ $a$ çš„ç»“æœè¢«å…¶ä»–ä¾èµ– (dependent)çš„æ“ä½œè§‚æµ‹åˆ°ï¼Œå¦‚ read aï¼Œé‚£ä¹ˆæ ¹æ® rule 2ï¼Œ$a$ ä¸€å®šå·²ç»åŒæ­¥åˆ° backup ä¸Š é€šè¿‡è¯·æ±‚ $a$ çš„å®Œæˆè§‚æµ‹åˆ°ç»“æœï¼Œåœ¨å´©æºƒä¹‹å‰å¯¹ $a$ çš„å”¯ä¸€è§‚å¯Ÿæ˜¯è¿”å›çš„æ‰§è¡Œç»“æœï¼Œå¹¶ä¸”ç”±äºä¸€è‡´æ€§å±æ€§ï¼Œå³ä½¿åœ¨æ¢å¤ä¹‹åå®ƒä¹Ÿå¿…é¡»ä»ç„¶ä¸€è‡´ã€‚å³æ²¡æœ‰ä»»ä½•å…¶ä»–çš„ç›¸å…³æ“ä½œ å®•æœºå‰å¯¹äº a çš„ç»“æœæ²¡æœ‰ä»»ä½•çš„è§‚æµ‹ï¼Œå³ a æ‰§è¡Œå¤±è´¥ï¼Œé‚£ä¹ˆ client å°±ä¼šåœ¨æ¢å¤åè¿›è¡Œé‡è¯•ï¼Œç”±äº RIFL çš„å­˜åœ¨ï¼Œæ— è®ºæ˜¯ a æ²¡æœ‰è¢«æ‰§è¡Œï¼Œè¿˜æ˜¯æ‰§è¡ŒæˆåŠŸï¼Œæ²¡èƒ½å¤Ÿè¿”å› clientï¼Œç»“æœéƒ½æ˜¯ä¸€æ ·ä¸”ç¬¦åˆçº¿æ€§ä¸€è‡´æ€§çš„ã€‚ Witnesses ä¸ Backup åˆ†ç¦» è¿™æ ·å®ç°çš„å¥½å¤„æ˜¯å¯ä»¥ä¿è¯ä»£ç çš„éä¾µå…¥æ€§ï¼Œå³å®Œå…¨ä¸éœ€è¦ä¿®æ”¹åŸæœ¬ backup çš„ä»£ç ï¼Œå¯ä»¥å¾ˆè½»æ˜“çš„æ„å»ºåœ¨ç°æœ‰çš„ç³»ç»Ÿä¸Šã€‚\nè€Œåœ¨ backup ä¸Šå®ç° witness åŒæ ·ä¹Ÿæœ‰å¥½å¤„ï¼Œå³åŒæ­¥è¿‡ç¨‹ä¼šæ–¹ä¾¿å¾ˆå¤šï¼Œmaster å¯ä»¥åªå‘é€ä¸€ä¸ª log Idï¼Œè€Œä¸æ˜¯å®Œæ•´çš„è¯·æ±‚ï¼Œä¹‹å backup å°±å¯ä»¥æ ¹æ® id ä» witness ä¸­è·å–æ•°æ®ï¼Œå‡å°‘ç½‘ç»œå‘é€çš„æ•°æ®é‡ï¼Œå¹¶ä¸”å¯ä»¥ç›´æ¥å°† witness ä¸­çš„æ•°æ®ç›´æ¥ç§»åŠ¨åˆ° backup ä¸­ï¼Œå‡å°‘äº†ä¸€æ¬¡ gc è¯·æ±‚ã€‚\nè¿™ä¸ªå®ç°åœ¨ CURP çš„ PhD è®ºæ–‡ä¸­ä¹Ÿæœ‰æåŠï¼Œç§°ä¸º CURP-Hï¼ˆHybridsï¼‰\næ‰©å±• CURP è‡³å…±è¯†ç®—æ³• å³ CURP-Qï¼ˆQuorumï¼‰åœ¨ PhD è®ºæ–‡ä¸­åŒæ ·æœ‰æ‰€æåŠã€‚è¿™é‡Œç®€å•è¯´å‡ ä¸ªç‚¹\né€šå¸¸å…±è¯†ç®—æ³•ä½¿ç”¨ 2 f+1 ä¸ªå‰¯æœ¬ï¼Œä»¥å®¹å¿ f ä¸ªå®•æœº (failed)çš„å‰¯æœ¬ï¼Œåœ¨ CURP-Q ä¸­åŒæ ·é€‚ç”¨ 2 f+1 å®¹å¿ f ä¸ªå‰¯æœ¬ï¼Œä½†è¿™åªæ˜¯æœ€ä½è¦æ±‚ï¼Œå³å¯ä»¥é€šè¿‡ slow path æ¥å®Œæˆå…±è¯†ï¼Œå¦‚æœæƒ³è¦é€šè¿‡ fast pathï¼Œé‚£ä¹ˆä¾æ—§éœ€è¦ superquorumã€‚å¦‚æœåªæ˜¯ç®€å•çš„å¤§å¤šæ•°ï¼Œå³å°† f+1 ä¸ªï¼Œåœ¨äº§ç”Ÿ f ä¸ªå®•æœºå (åŒ…æ‹¬ Leader)ï¼Œé‚£ä¹ˆå°±åªæœ‰ä¸€ä¸ª Witness ä¸­ä¼šè®°å½•è¯·æ±‚ã€‚åœ¨è¿›è¡Œæ¢å¤æ—¶ï¼Œè€Œå¦‚æœå…¶ä»– f ä¸ªæ¥å—äº†ä¸ä¹‹å†²çªçš„è¯·æ±‚ï¼Œé‚£ä¹ˆåœ¨æ¢å¤è¿‡ç¨‹ä¸­å°±æ— æ³•åˆ†è¾¨å’Œç¡®å®šé¡ºåºã€‚ï¼ˆä»…ä»…åªæ˜¯æ¥å—æˆ–è€…è®°å½•è¿‡ï¼Œè¿™ f ä¸ª witness ä¸­çš„å†…å®¹ä¸éœ€è¦ commitï¼Œå°±ä¼šäº§ç”Ÿå½±å“ï¼‰ åœ¨å‘ç”Ÿ Leader èº«ä»½åˆ‡æ¢æ—¶ï¼Œç”±äº Leader çš„å·è·‘è¡Œä¸ºï¼ˆLeader ä¸è¿›è¡Œå†²çªæ£€æµ‹ï¼Œè¿™é‡ŒæŒ‡ Leader æ‰§è¡ŒæˆåŠŸä½† Wintess æ²¡æœ‰è®°å½•æˆåŠŸçš„å†…å®¹ï¼Œæ­¤æ—¶è¯¥è¯·æ±‚å¹¶æœªæˆåŠŸæ‰§è¡Œï¼Œä½†æ˜¯ç»“æœå·²ç»å†™å…¥åˆ°çŠ¶æ€æœºï¼‰ä¼šå¯¼è‡´ Leader çš„çŠ¶æ€æœºä¸å…¶ä»–å‰¯æœ¬æœ‰æ‰€åˆ†æ­§ï¼Œå³æ—§ Leader åœ¨è¿›åº¦ä¸Šä¼šé¢†å…ˆå…¶ä»–å‰¯æœ¬ï¼Œä¸€ä¸ªæ¯”è¾ƒç®€å•çš„æ–¹æ³•å°±æ˜¯å¼•å…¥ checkpointï¼Œå¯¹æ•°æ®è¿›è¡Œé‡æ–°åŠ è½½ã€‚ä½†å¦‚æœåŸæœ¬çš„æ—§ Leader å¹¶ä¸æ˜¯å› ä¸ºå®•æœºè€Œä¸‹çº¿ï¼Œå¯ä»¥è¯»å–æ—§ Leader çš„ uncommitted logï¼Œåº”ç”¨è‡³æ–°çš„ Leaderã€‚ï¼ˆè¿™æ ·è™½ç„¶å¯ä»¥åŒæ­¥çŠ¶æ€ï¼Œä½†æ˜¯ä¼šå°†ä¸€äº›è¢«è§†ä¸ºå¤±è´¥çš„ç»“æœè¿›è¡ŒæˆåŠŸå†™å…¥ï¼Ÿï¼‰ æœ€åä¸€ä¸ªé—®é¢˜æ˜¯ Client å¦‚ä½•è¯†åˆ«å‡ºé‚£äº›é™ˆæ—§çš„ï¼Œä½†æ˜¯ä¾æ—§è§†è‡ªå·±ä¸ºæœ‰æ•ˆçš„ Leaderï¼ˆZombie Leaderï¼‰ã€‚åœ¨ Raft å’Œ Paxos ä¸­æ˜¯ä¸å­˜åœ¨è¿™ä¸ªé—®é¢˜çš„ï¼Œå› ä¸º Leader çš„è¯·æ±‚éœ€è¦ Follower çš„ç¡®è®¤ï¼Œåœ¨ CURP ä¸­ï¼Œè™½ç„¶ slow path ä¸­åŒæ ·å­˜åœ¨è¿™ä¸ªè¿‡ç¨‹ï¼ŒLeader æœ€ç»ˆä¹Ÿä¼šé€€ä½ï¼Œä½†æ˜¯ Fast path æ˜¯å¹¿æ’­å½¢å¼ï¼ŒLeader ä¸ Witness ç›¸äº’ç‹¬ç«‹ï¼Œæ— æ³•è¿›è¡Œæ£€æµ‹ã€‚å› æ­¤ï¼Œéœ€è¦å¼•å…¥ä¸€ä¸ª Term æœºåˆ¶ï¼Œé€šè¿‡ Witness çš„å›å¤ RPCï¼ŒClient å¯ä»¥åˆ¤æ–­å½“å‰çš„ Leader æ˜¯å¦ä¸ºæœ‰æ•ˆ Leader ","permalink":"https://fischer0522.github.io/en/posts/tech/curp/curp-exploiting-commutativity-for-practical-fast-replication/","summary":"èƒŒæ™¯ åŠ¨æœºï¼šç›®å‰çš„ä¸€äº›å®¹é”™ç®—æ³•æˆ–è€…è¯´å…±è¯†ç®—æ³•ï¼Œæ— è®ºæ˜¯ç®€å•çš„ä¸»ä»ç»“æ„è¿˜æ˜¯Raft Paxosç­‰ï¼Œéƒ½éœ€è¦ä¸¤ä¸ªRTTæ¥å®Œæˆï¼Œç¬¬ä¸€ä¸ªRTTç”±Client","title":"01-CURP: å…±è¯†ç®—æ³•çš„é‡æ–°æ€è€ƒ"},{"content":"åœ¨etcdä¸­ï¼Œraftä½œä¸ºä¸€ä¸ªå•ç‹¬çš„æ¨¡å—è¢«æ‹†åˆ†å‡ºæ¥ï¼Œä½äºetcdçš„ç›®å½•ä¸‹ï¼Œåœ¨æ–°ç‰ˆæœ¬å½“ä¸­, etcd/raftè¢«æ‹†åˆ†å‡ºæ¥ï¼Œå¤„äºä¸€ä¸ªå•ç‹¬çš„ä»“åº“è¢«etcdå¼•ç”¨:GitHub - etcd-io/raft: Raft library for maintaining a replicated state machine\netcd/raftä½œä¸ºä¸€ä¸ªæŠ•å…¥ç”Ÿäº§ç¯å¢ƒçš„raft packageï¼Œectd/raftåœ¨æ¶æ„ä¸Šçš„æœ€å¤§çš„é­…åŠ›å°±æ˜¯å°†æ•´ä¸ªç³»ç»Ÿè§†ä¸ºä¸€ä¸ªçŠ¶æ€æœºï¼Œå¹¶ä¸”å°†å„éƒ¨åˆ†è¿›è¡Œè§£è€¦ï¼š\nåœ¨åŸºç¡€ç»“æ„ä¸Šï¼Œetcd/raftå°†raftè§†ä¸ºä¸€ä¸ªçŠ¶æ€æœºï¼Œä¸Šå±‚ç»™äºˆRaftä¸€äº›è¾“å…¥ï¼Œå¦‚tickæˆ–è€…messageï¼ŒRaftå°±ä¼šæ ¹æ®è¾“å…¥ä½œå‡ºä¸€äº›å“åº”ï¼Œæ›´æ”¹è‡ªèº«çŠ¶æ€ï¼Œæœ€åæä¾›ä¸€äº›è¾“å‡ºï¼Œä¸Šå±‚å¤„ç†å®Œè¾“å‡ºä¹‹åå†è°ƒç”¨Advanceæ¥ç»§ç»­æ¨è¿›Raftå»æ›´æ–°çŠ¶æ€ã€‚\nåœ¨etcdå½“ä¸­ï¼Œraft packageä»…æä¾›raftçš„é€»è¾‘ï¼Œå¦‚å¦‚ä½•è¿›è¡Œé€‰ä¸¾å’Œå‘é€æ—¥å¿—ï¼Œä½†æ˜¯å¦‚æŒä¹…åŒ–å­˜å‚¨ï¼Œç½‘ç»œé€šä¿¡éƒ½ç”±ä¸Šå±‚åº”ç”¨è´Ÿè´£ï¼Œraft packageé€šè¿‡ Ready å°†éœ€è¦å­˜å‚¨çš„æ—¥å¿—ï¼Œå¿«ç…§ï¼Œä»¥åŠéœ€è¦å‘é€çš„æ¶ˆæ¯äº¤ç»™ä¸Šå±‚ã€‚\nåœ¨ç»“æ„ä¸Šï¼Œetcd/raftä»¥Messageä¸ºä¸»ä½“å’Œé©±åŠ¨ï¼Œæ•´ä¸ªRaftçš„æ‰§è¡Œæµç¨‹å°±æ˜¯åœ¨tickçš„é©±åŠ¨ä¸‹ï¼Œä¸æ–­çš„æ‰§è¡Œå’Œå‘é€Messageçš„è¿‡ç¨‹ï¼Œå¹¶ä¸ä¼šåƒMIT6.824 å½“ä¸­é‚£æ ·åœ¨ä¸€ä¸ªå‡½æ•°å½“ä¸­èƒ½çœ‹åˆ°å®Œæ•´çš„rpcè°ƒç”¨å’Œå¤„ç†æµç¨‹ï¼Œæ¯ä¸ªMessageåªä¼šè´Ÿè´£æ•´ä½“é€»è¾‘çš„ä¸€éƒ¨åˆ†ï¼Œæ‰§è¡Œå®Œè‡ªå·±çš„å†…å®¹å°±ç”Ÿæˆä¸€ä¸ªæ–°çš„Messageå‘é€ï¼Œå…¶ä»–æ‹¿åˆ°è¿™æ¡Messageçš„æ¥å®Œæˆè¿™ä¸ªäº‹ä»¶çš„å‰©ä½™é€»è¾‘ï¼Œä¸¾ä¸ªä¾‹å­ï¼Œåœ¨è¿›è¡Œé€‰ä¸¾æ—¶ï¼š\ncandidateé¦–å…ˆä¼šå‘å…¶ä»–èŠ‚ç‚¹å‘é€ä¸€ä¸ªè¯·æ±‚æŠ•ç¥¨çš„Messageï¼Œæ­¤æ—¶candidateç›®å‰è´Ÿè´£çš„é€»è¾‘å·²ç»æ‰§è¡Œç»“æŸï¼Œcandidateå¯ä»¥å»æ‰§è¡Œå…¶ä»–å†…å®¹ followerå—åˆ°candidateå‘é€çš„Messageå°±ä¼šè¿›è¡Œå¤„ç†ï¼ŒæŠ•ç¥¨æˆ–è€…å¿½ç•¥ï¼ŒåŒæ ·å°†ç»“æœå°è£…æˆä¸€æ¡Messageå†å‘é€ç»™candidate Candidate å†æ”¶åˆ° Message ä¹‹åç»§ç»­å®Œæˆå‰©ä½™çš„é€»è¾‘ï¼Œç»Ÿè®¡æŠ•ç¥¨ï¼Œå†³å®šæ˜¯å¦å½“é€‰ æ•´ä¸ªæ‰§è¡Œè¿‡ç¨‹æ˜¯æ¾æ•£ã€éè¿ç»­çš„ã€‚ä½†æ˜¯ä¸»ä½“é€»è¾‘å…¨éƒ¨ä½¿ç”¨ Message æ¥æ‰¿è½½çš„è¯ï¼Œæ•´ä½“ç»“æ„å°±ä¼šéå¸¸æ¸…æ™°ï¼Œraft åªéœ€è¦ä¸æ–­çš„å¤„ç† Message å³å¯ï¼Œå¹¶åœ¨é€‚å½“çš„æ—¶å€™äº§ç”Ÿæ–°çš„ Messageï¼Œè¿™ä¹Ÿç¬¦åˆçŠ¶æ€æœºçš„å®šä¹‰ï¼Œå³Messageå’ŒCommandä½œä¸ºç³»ç»Ÿçš„è¾“å…¥ï¼Œè°ƒç”¨Readyäº§ç”Ÿçš„Log, Message, Snapshotä½œä¸ºç³»ç»Ÿçš„è¾“å‡ºã€‚\næ­£å¦‚ä¸Šé¢æ‰€è¯´ï¼Œå•ç‹¬çš„etcd/raftæ˜¯æ— æ³•è¿è¡Œçš„ï¼Œéœ€è¦è¡¥å……é¢å¤–çš„é€»è¾‘ï¼Œç”¨äºè°ƒç”¨é©±etcd/raftï¼Œè¿™ä¸€éƒ¨åˆ†åœ¨etcdå½“ä¸­ä¹Ÿæœ‰å®ç°ï¼Œä½äºraftexampleç›®å½•ä¸‹ã€‚æä¾›äº†ä¸€ä¸ªä½¿ç”¨raftæ¥æä¾›http kvå­˜å‚¨çš„æœ€å°å®ç°ã€‚å› æ­¤ï¼Œåœ¨æœ¬æ–‡ä¸­ï¼Œç¬”è€…ä¹Ÿä¼šåˆ†ä¸ºraft example å’Œ raft packageä¸¤éƒ¨åˆ†ä»‹ç»etcd/raftã€‚åç»­ä¸ºäº†ä¾¿äºåŒºåˆ†ï¼Œç¬”è€…ä¼šå°†ä¸Šå±‚é©±åŠ¨æ€§è´¨çš„ç§°ä¸º RaftNode ï¼Œè€Œä¸‹å±‚åˆ™ç§°ä¸ºRaft packageæˆ–è€…åº•å±‚Raftï¼Œè€Œæœ€ä¸Šå±‚æ¥æ”¶è¯·æ±‚çš„éƒ¨åˆ†åˆ™ç§°ä¸ºçŠ¶æ€æœºã€‚\nRaft example è¿™ä¸€éƒ¨åˆ†ä»£ç ä½äº contrib/raftexample å½“ä¸­ï¼Œé™¤å»httpå°è£…ï¼Œå‰©ä¸‹çš„é€»è¾‘å¯ä»¥åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š\nKVStoreï¼šå……å½“çŠ¶æ€æœºï¼Œæ¥æ”¶httpå±‚ä¼ æ¥çš„è¯·æ±‚ï¼Œå°†è¯·æ±‚å°è£…ï¼Œé€šè¿‡proposeå‘ä¸‹ä¼ é€’ï¼ŒåŒæ—¶è¯»å–commitçš„æ—¥å¿—ï¼Œåº”ç”¨åˆ°è‡ªèº« RaftNodeï¼šé©±åŠ¨åº•å±‚Raftï¼Œå®Œæˆé€šä¿¡ï¼Œå­˜å‚¨ç­‰é¢å¤–åŠŸèƒ½ State machine kvstoreï¼Œå³çŠ¶æ€æœºï¼Œå®ç°çš„éå¸¸ç®€å•ï¼Œç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 type kvstore struct { proposeC chan\u0026lt;- string // channel for proposing updates mu sync.RWMutex kvStore map[string]string // current committed key-value pairs snapshotter *snap.Snapshotter } åœ¨åˆå§‹åŒ–æ—¶ï¼Œé€šè¿‡ä¼ å…¥çš„å‚æ•°ï¼Œå»ºç«‹èµ·äº†çŠ¶æ€æœºå’ŒRaftNodeçš„è¿æ¥ï¼š\nsnapshotterï¼šç”¨äºé€šçŸ¥ï¼ŒåŠ è½½æ—¥å¿—ï¼Œé€šè¿‡æ—¥å¿—å®Œæˆç³»ç»Ÿçš„æ¢å¤ proposeCï¼šchannelå‘é€æ–¹ï¼Œå°†æ¥æ”¶åˆ°çš„è¯·æ±‚è¿›è¡Œå°è£…ï¼Œé€šè¿‡è¯¥channelå‘é€ç»™raft commitCï¼šæ¥æ”¶ä¸‹å±‚raftç¡®è®¤æäº¤çš„å†…å®¹ï¼Œåº”ç”¨åˆ°çŠ¶æ€æœº errorCï¼šå¤„ç†error åœ¨çŠ¶æ€æœºåˆå§‹åŒ–å®Œæˆåï¼Œå¼€å¯ä¸€ä¸ªåç¨‹ï¼Œç”¨äºä»ä¸‹å±‚è¯»å–æäº¤çš„æ—¥å¿—ï¼ŒçŠ¶æ€æœºæœ¬èº«æä¾›proposeå’Œlookupæ¥å¤„ç†è¯»å†™è¯·æ±‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 func newKVStore(snapshotter *snap.Snapshotter, proposeC chan\u0026lt;- string, commitC \u0026lt;-chan *commit, errorC \u0026lt;-chan error) *kvstore { s := \u0026amp;kvstore{proposeC: proposeC, kvStore: make(map[string]string), snapshotter: snapshotter} snapshot, err := s.loadSnapshot() if err != nil { log.Panic(err) } if snapshot != nil { log.Printf(\u0026#34;loading snapshot at term %d and index %d\u0026#34;, snapshot.Metadata.Term, snapshot.Metadata.Index) if err := s.recoverFromSnapshot(snapshot.Data); err != nil { log.Panic(err) } } // read commits from raft into kvStore map until error go s.readCommits(commitC, errorC) return s } ä¸è¿‡ï¼Œåœ¨raft exampleå½“ä¸­ï¼Œä»…ä»…åªæ˜¯åšäº†ç®€å•çš„æ¼”ç¤ºï¼Œå¹¶æ²¡æœ‰æä¾›çº¿æ€§ä¸€è‡´æ€§è¯»çš„ä¿è¯ï¼Œlookupä»…ä»…ä¼šç›´æ¥æœç´¢å½“å‰å·²ç»commitçš„å†…å®¹ï¼Œå¯¹äºåœ¨æ­¤æ¬¡è¯»å–å‰å‘é€ï¼Œä½†è¿˜æ²¡æœ‰åº”ç”¨çš„å†…å®¹æ— æ³•è¯»å–ã€‚å¦‚æœæƒ³æ»¡è¶³çº¿æ€§ä¸€è‡´æ€§ä¹Ÿå¾ˆç®€å•ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨log readï¼Œå¯¹äºè¯»è¯·æ±‚ä¹Ÿå°è£…æˆæ—¥å¿—å»å…±è¯†ï¼Œæˆ–è€…ä½¿ç”¨readIndex/lease readæ¥å®Œæˆä¼˜åŒ–\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 func (s *kvstore) Lookup(key string) (string, bool) { s.mu.RLock() defer s.mu.RUnlock() v, ok := s.kvStore[key] return v, ok } func (s *kvstore) Propose(k string, v string) { var buf strings.Builder if err := gob.NewEncoder(\u0026amp;buf).Encode(kv{k, v}); err != nil { log.Fatal(err) } s.proposeC \u0026lt;- buf.String() } RaftNode åœ¨raft exampleä¸­ï¼Œé€šè¿‡RaftNodeå®Œæˆå¯¹Raft Packageçš„è°ƒç”¨ï¼Œé©±åŠ¨ä¸‹å±‚Raftè¿è¡Œï¼Œå¹¶ä¸”å¤„ç†æ‰å­˜å‚¨ï¼Œæ¶ˆæ¯å‘é€ï¼Œæäº¤æ—¥å¿—åº”ç”¨ç­‰æ“ä½œã€‚\nä¸ºäº†ç ”ç©¶RaftNodeå¦‚ä½•é©±åŠ¨åº•å±‚Raftçš„è¿è¡Œï¼Œæˆ‘ä»¬ä¸å¦¨å…ˆçœ‹çœ‹ä¸‹å±‚æä¾›æˆ–è€…è¯´æš´éœ²äº†ä»€ä¹ˆæ¥å£ï¼Œè¿™é‡Œå°è£…æˆäº†ä¸€ä¸ªinterfaceçš„å½¢å¼,ã€‚å¯¹äºRaftNodeè€Œè¨€ï¼Œåªéœ€è¦é€šè¿‡é…ç½®ä¿¡æ¯æ¥åˆå§‹åŒ–è¯¥Interfaceçš„å®ç°ï¼Œç„¶ååœ¨åˆé€‚çš„æ—¶æœºè°ƒç”¨å¯¹åº”çš„æ–¹æ³•å³å¯ã€‚ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 // Node represents a node in a raft cluster. type Node interface { // Tick increments the internal logical clock for the Node by a single tick. Election // timeouts and heartbeat timeouts are in units of ticks. Tick() // Campaign causes the Node to transition to candidate state and start campaigning to become leader. Campaign(ctx context.Context) error // Propose proposes that data be appended to the log. Note that proposals can be lost without // notice, therefore it is user\u0026#39;s job to ensure proposal retries. Propose(ctx context.Context, data []byte) error // ProposeConfChange proposes a configuration change. Like any proposal, the // configuration change may be dropped with or without an error being // returned. In particular, configuration changes are dropped unless the // leader has certainty that there is no prior unapplied configuration // change in its log. // // The method accepts either a pb.ConfChange (deprecated) or pb.ConfChangeV2 // message. The latter allows arbitrary configuration changes via joint // consensus, notably including replacing a voter. Passing a ConfChangeV2 // message is only allowed if all Nodes participating in the cluster run a // version of this library aware of the V2 API. See pb.ConfChangeV2 for // usage details and semantics. ProposeConfChange(ctx context.Context, cc pb.ConfChangeI) error // Step advances the state machine using the given message. ctx.Err() will be returned, if any. Step(ctx context.Context, msg pb.Message) error // Ready returns a channel that returns the current point-in-time state. // Users of the Node must call Advance after retrieving the state returned by Ready (unless // async storage writes is enabled, in which case it should never be called). // // NOTE: No committed entries from the next Ready may be applied until all committed entries // and snapshots from the previous one have finished. Ready() \u0026lt;-chan Ready // Advance notifies the Node that the application has saved progress up to the last Ready. // It prepares the node to return the next available Ready. // // The application should generally call Advance after it applies the entries in last Ready. // // However, as an optimization, the application may call Advance while it is applying the // commands. For example. when the last Ready contains a snapshot, the application might take // a long time to apply the snapshot data. To continue receiving Ready without blocking raft // progress, it can call Advance before finishing applying the last ready. // // NOTE: Advance must not be called when using AsyncStorageWrites. Response messages from the // local append and apply threads take its place. Advance() // ApplyConfChange applies a config change (previously passed to // ProposeConfChange) to the node. This must be called whenever a config // change is observed in Ready.CommittedEntries, except when the app decides // to reject the configuration change (i.e. treats it as a noop instead), in // which case it must not be called. // // Returns an opaque non-nil ConfState protobuf which must be recorded in // snapshots. ApplyConfChange(cc pb.ConfChangeI) *pb.ConfState // TransferLeadership attempts to transfer leadership to the given transferee. TransferLeadership(ctx context.Context, lead, transferee uint64) // ForgetLeader forgets a follower\u0026#39;s current leader, changing it to None. It // remains a leaderless follower in the current term, without campaigning. // // This is useful with PreVote+CheckQuorum, where followers will normally not // grant pre-votes if they\u0026#39;ve heard from the leader in the past election // timeout interval. Leaderless followers can grant pre-votes immediately, so // if a quorum of followers have strong reason to believe the leader is dead // (for example via a side-channel or external failure detector) and forget it // then they can elect a new leader immediately, without waiting out the // election timeout. They will also revert to normal followers if they hear // from the leader again, or transition to candidates on an election timeout. // // For example, consider a three-node cluster where 1 is the leader and 2+3 // have just received a heartbeat from it. If 2 and 3 believe the leader has // now died (maybe they know that an orchestration system shut down 1\u0026#39;s VM), // we can instruct 2 to forget the leader and 3 to campaign. 2 will then be // able to grant 3\u0026#39;s pre-vote and elect 3 as leader immediately (normally 2 // would reject the vote until an election timeout passes because it has heard // from the leader recently). However, 3 can not campaign unilaterally, a // quorum have to agree that the leader is dead, which avoids disrupting the // leader if individual nodes are wrong about it being dead. // // This does nothing with ReadOnlyLeaseBased, since it would allow a new // leader to be elected without the old leader knowing. ForgetLeader(ctx context.Context) error // ReadIndex request a read state. The read state will be set in the ready. // Read state has a read index. Once the application advances further than the read // index, any linearizable read requests issued before the read request can be // processed safely. The read state will have the same rctx attached. // Note that request can be lost without notice, therefore it is user\u0026#39;s job // to ensure read index retries. ReadIndex(ctx context.Context, rctx []byte) error // Status returns the current status of the raft state machine. Status() Status // ReportUnreachable reports the given node is not reachable for the last send. ReportUnreachable(id uint64) // ReportSnapshot reports the status of the sent snapshot. The id is the raft ID of the follower // who is meant to receive the snapshot, and the status is SnapshotFinish or SnapshotFailure. // Calling ReportSnapshot with SnapshotFinish is a no-op. But, any failure in applying a // snapshot (for e.g., while streaming it from leader to follower), should be reported to the // leader with SnapshotFailure. When leader sends a snapshot to a follower, it pauses any raft // log probes until the follower can apply the snapshot and advance its state. If the follower // can\u0026#39;t do that, for e.g., due to a crash, it could end up in a limbo, never getting any // updates from the leader. Therefore, it is crucial that the application ensures that any // failure in snapshot sending is caught and reported back to the leader; so it can resume raft // log probing in the follower. ReportSnapshot(id uint64, status SnapshotStatus) // Stop performs any necessary termination of the Node. Stop() } å¯åŠ¨æµç¨‹ åœ¨ newRaftNode å½“ä¸­ï¼Œé€»è¾‘åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼š\nåˆå§‹åŒ–åº•å±‚raftèŠ‚ç‚¹ï¼Œå¹¶å»ºç«‹èµ·å„ä¸ªèŠ‚ç‚¹é—´çš„é€šä¿¡ å¼€å¯ä¸€ä¸ªchannelï¼Œé©±åŠ¨åº•å±‚Raftï¼Œå¹¶ä»åº•å±‚Raftè·å–å·²ç»å¤„ç†å¥½çš„ä¿¡æ¯ é…ç½®channelï¼Œå®ŒæˆRaftNodeå’ŒçŠ¶æ€æœºä¹‹é—´çš„åŒå‘è¿é€š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 // newRaftNode initiates a raft instance and returns a committed log entry // channel and error channel. Proposals for log updates are sent over the // provided the proposal channel. All log entries are replayed over the // commit channel, followed by a nil message (to indicate the channel is // current), then new log entries. To shutdown, close proposeC and read errorC. func newRaftNode(id int, peers []string, join bool, getSnapshot func() ([]byte, error), proposeC \u0026lt;-chan string, confChangeC \u0026lt;-chan raftpb.ConfChange) (\u0026lt;-chan *commit, \u0026lt;-chan error, \u0026lt;-chan *snap.Snapshotter) { commitC := make(chan *commit) errorC := make(chan error) rc := \u0026amp;raftNode{ proposeC: proposeC, confChangeC: confChangeC, commitC: commitC, errorC: errorC, id: id, peers: peers, join: join, waldir: fmt.Sprintf(\u0026#34;raftexample-%d\u0026#34;, id), snapdir: fmt.Sprintf(\u0026#34;raftexample-%d-snap\u0026#34;, id), getSnapshot: getSnapshot, snapCount: defaultSnapshotCount, stopc: make(chan struct{}), httpstopc: make(chan struct{}), httpdonec: make(chan struct{}), logger: zap.NewExample(), snapshotterReady: make(chan *snap.Snapshotter, 1), // rest of structure populated after WAL replay } go rc.startRaft() return commitC, errorC, rc.snapshotterReady } Raft Packageåˆå§‹åŒ– Raft packageçš„åˆå§‹åŒ–å°è£…åœ¨ startRaft() å½“ä¸­ï¼Œä¸»è¦é€»è¾‘ä¸ºï¼š\nè¯»å–åŸæœ¬çš„æŒä¹…åŒ–æ–‡ä»¶ï¼Œè·å–snapshotå’Œwalä¸­çš„å†…å®¹ï¼Œæ¢å¤çŠ¶æ€ã€‚è¿™é‡Œçš„walæ˜¯log entryçš„walï¼Œå› ä¸ºraft packageå¹¶ä¸ä¼šå¯¹logè¿›è¡ŒæŒä¹…åŒ–å­˜å‚¨ï¼Œå› æ­¤åœ¨raft exampleå½“ä¸­æä¾›äº†ä¸€ä¸ªwal + memoryçš„å­˜å‚¨æ–¹å¼ï¼Œå¯¹åº”ç»“æ„ä½“ä¸ºMemoryStorage ç”Ÿæˆä¸€ä»½é…ç½®ï¼Œåˆå§‹åŒ–ä¸‹å±‚çš„Raft packageä¸­çš„èŠ‚ç‚¹ åˆå§‹åŒ–ç½‘ç»œï¼Œè¿é€šå„ä¸ªèŠ‚ç‚¹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 func (rc *raftNode) startRaft() { if !fileutil.Exist(rc.snapdir) { if err := os.Mkdir(rc.snapdir, 0750); err != nil { log.Fatalf(\u0026#34;raftexample: cannot create dir for snapshot (%v)\u0026#34;, err) } } rc.snapshotter = snap.New(zap.NewExample(), rc.snapdir) oldwal := wal.Exist(rc.waldir) rc.wal = rc.replayWAL() // signal replay has finished rc.snapshotterReady \u0026lt;- rc.snapshotter rpeers := make([]raft.Peer, len(rc.peers)) for i := range rpeers { rpeers[i] = raft.Peer{ID: uint64(i + 1)} } c := \u0026amp;raft.Config{ ID: uint64(rc.id), ElectionTick: 10, HeartbeatTick: 1, Storage: rc.raftStorage, MaxSizePerMsg: 1024 * 1024, MaxInflightMsgs: 256, MaxUncommittedEntriesSize: 1 \u0026lt;\u0026lt; 30, } if oldwal || rc.join { rc.node = raft.RestartNode(c) } else { rc.node = raft.StartNode(c, rpeers) } rc.transport = \u0026amp;rafthttp.Transport{ Logger: rc.logger, ID: types.ID(rc.id), ClusterID: 0x1000, Raft: rc, ServerStats: stats.NewServerStats(\u0026#34;\u0026#34;, \u0026#34;\u0026#34;), LeaderStats: stats.NewLeaderStats(zap.NewExample(), strconv.Itoa(rc.id)), ErrorC: make(chan error), } rc.transport.Start() for i := range rc.peers { if i+1 != rc.id { rc.transport.AddPeer(types.ID(i+1), []string{rc.peers[i]}) } } go rc.serveRaft() go rc.serveChannels() } serveChannels å®ŒæˆRaft Packageçš„åˆå§‹åŒ–ä¹‹åï¼Œé€šè¿‡ serveChannls ï¼ˆåœ¨startRaftå½“ä¸­è¢«è°ƒç”¨ï¼‰ä¼šå»ºç«‹raft nodeå’Œraft packageä¹‹é—´çš„è¿æ¥ï¼Œå³å°†proposeçš„è¯·æ±‚å‘ä¸‹ä¼ é€’ï¼Œå¹¶ä¸”ä»ä¸‹å±‚è·å–å¤„ç†å®Œçš„å†…å®¹ã€‚\nä»raft nodeè‡³ raft packageè‡ªä¸Šå‘ä¸‹çš„è¿‡ç¨‹æ¯”è¾ƒç®€å•ï¼Œåªéœ€è¦æŠŠproposeå’ŒconfChangeè°ƒç”¨å¯¹åº”çš„æ–¹æ³•å°±å¯ä»¥ä¼ é€’ä¸‹å»ï¼Œè€Œè¿™ä¸¤ä¸ªè¯·æ±‚æ¥è‡ªäºçŠ¶æ€æœºï¼Œå³raft nodeåªæ˜¯é€šè¿‡channelåšäº†ä¸€æ¬¡è½¬å‘\nè‡ªä¸‹å‘ä¸Šé€šè¿‡Readyç»“æ„ä½“è¿›è¡Œä¼ é€’ï¼Œä¸»è¦å†…å®¹ä¸ºï¼š\nSoftStateï¼šä¸éœ€è¦æŒä¹…åŒ–å­˜å‚¨çš„çŠ¶æ€ï¼Œå…¶ä¸­åŒ…å«çš„å½“å‰èŠ‚ç‚¹çš„èº«ä»½å’ŒLeader Id HardStateï¼šæŒä¹…åŒ–å­˜å‚¨çš„çŠ¶æ€ï¼Œå¦‚Raftè®ºæ–‡ä¸­æ‰€è¿°ï¼Œå…¶ä¸­åŒ…å«äº†VoteFor Termå’ŒCommitè¿›åº¦ ReadStateï¼šReadIndexçº¿æ€§ä¸€è‡´æ€§è¯»ä¼˜åŒ– Entry: Log Entryï¼Œäº¤ç»™ä¸Šå±‚å­˜å‚¨ Snapshotï¼ŒåŒï¼Œä¸Šå±‚è¿›è¡Œå­˜å‚¨ CommitEntriesï¼šç¡®å®šæäº¤çš„æ—¥å¿—ï¼Œå¯ä»¥äº¤ç»™ä¸Šå±‚æ¥å®ŒæˆApply Messageï¼šå‘é€ç»™å…¶ä»–çš„èŠ‚ç‚¹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 // Ready encapsulates the entries and messages that are ready to read, // be saved to stable storage, committed or sent to other peers. // All fields in Ready are read-only. type Ready struct { // The current volatile state of a Node. // SoftState will be nil if there is no update. // It is not required to consume or store SoftState. *SoftState // The current state of a Node to be saved to stable storage BEFORE // Messages are sent. // // HardState will be equal to empty state if there is no update. // // If async storage writes are enabled, this field does not need to be acted // on immediately. It will be reflected in a MsgStorageAppend message in the // Messages slice. pb.HardState // ReadStates can be used for node to serve linearizable read requests locally // when its applied index is greater than the index in ReadState. // Note that the readState will be returned when raft receives msgReadIndex. // The returned is only valid for the request that requested to read. ReadStates []ReadState // Entries specifies entries to be saved to stable storage BEFORE // Messages are sent. // // If async storage writes are enabled, this field does not need to be acted // on immediately. It will be reflected in a MsgStorageAppend message in the // Messages slice. Entries []pb.Entry // Snapshot specifies the snapshot to be saved to stable storage. // // If async storage writes are enabled, this field does not need to be acted // on immediately. It will be reflected in a MsgStorageAppend message in the // Messages slice. Snapshot pb.Snapshot // CommittedEntries specifies entries to be committed to a // store/state-machine. These have previously been appended to stable // storage. // // If async storage writes are enabled, this field does not need to be acted // on immediately. It will be reflected in a MsgStorageApply message in the // Messages slice. CommittedEntries []pb.Entry // Messages specifies outbound messages. // // If async storage writes are not enabled, these messages must be sent // AFTER Entries are appended to stable storage. // // If async storage writes are enabled, these messages can be sent // immediately as the messages that have the completion of the async writes // as a precondition are attached to the individual MsgStorage{Append,Apply} // messages instead. // // If it contains a MsgSnap message, the application MUST report back to raft // when the snapshot has been received or has failed by calling ReportSnapshot. Messages []pb.Message // MustSync indicates whether the HardState and Entries must be durably // written to disk or if a non-durable write is permissible. MustSync bool } etcd/raftæ‰¹å¤„ç†çš„å½¢å¼ä¸€æ¬¡æ€§è¿”å›ä¸€ä¸ªReadyï¼Œå…¶ä¸­å°è£…äº†ç»Raft packageå¤„ç†å¥½çš„å„ç±»ä¿¡æ¯ï¼Œä¸Šå±‚æ‹¿åˆ°ä¹‹åï¼Œè¯¥å­˜å‚¨çš„å­˜å‚¨ï¼Œè¯¥æ‰§è¡Œçš„æ‰§è¡Œï¼Œè¯¥å‘é€çš„å‘é€ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 for { select { case \u0026lt;-ticker.C: rc.node.Tick() // store raft entries to wal, then publish over commit channel case rd := \u0026lt;-rc.node.Ready(): // Must save the snapshot file and WAL snapshot entry before saving any other entries // or hardstate to ensure that recovery after a snapshot restore is possible. if !raft.IsEmptySnap(rd.Snapshot) { rc.saveSnap(rd.Snapshot) } rc.wal.Save(rd.HardState, rd.Entries) if !raft.IsEmptySnap(rd.Snapshot) { rc.raftStorage.ApplySnapshot(rd.Snapshot) rc.publishSnapshot(rd.Snapshot) } rc.raftStorage.Append(rd.Entries) rc.transport.Send(rc.processMessages(rd.Messages)) applyDoneC, ok := rc.publishEntries(rc.entriesToApply(rd.CommittedEntries)) if !ok { rc.stop() return } rc.maybeTriggerSnapshot(applyDoneC) rc.node.Advance() case err := \u0026lt;-rc.transport.ErrorC: rc.writeError(err) return case \u0026lt;-rc.stopc: rc.stop() return } } çŠ¶æ€æœºè¿æ¥ RaftNodeçš„å¯åŠ¨æ—¶ï¼Œè°ƒç”¨å¤„ä¼šåˆ›å»ºå¥½èŠ‚ç‚¹idï¼Œé›†ç¾¤çš„ä¿¡æ¯ï¼Œä»¥åŠproposeC, confChagneCã€‚\nproposeCç”±çŠ¶æ€æœºå’ŒRaftNodeå…±äº«ï¼ŒçŠ¶æ€æœºé‚£ä¸€ç«¯æŒæœ‰senderï¼Œå°†è¯·æ±‚å‘é€ç»™RaftNodeï¼ŒRaftNodeçš„receiverè·å–ä¹‹åå°±ä¼šè°ƒç”¨Proposeæ–¹æ³•å°†è¯·æ±‚è½¬å‘ç»™ä¸‹å±‚å»å®Œæˆå…±è¯†ï¼Œåœ¨ newRaftNode å½“ä¸­ï¼Œä¼šåˆ›å»ºä¸€ä¸ªcommitCï¼Œæ¥ä»ä¸‹å±‚è·å–æäº¤çš„æ—¥å¿—ï¼Œä¹‹åè¿™ä¸ªchannelä¹Ÿä¼šè¿”å›ç»™çŠ¶æ€æœºï¼Œæ­¤æ—¶å®Œæˆäº†RaftNodeå’ŒçŠ¶æ€æœºçš„åŒå‘è¿é€šã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 func newRaftNode(id int, peers []string, join bool, getSnapshot func() ([]byte, error), proposeC \u0026lt;-chan string, confChangeC \u0026lt;-chan raftpb.ConfChange) (\u0026lt;-chan *commit, \u0026lt;-chan error, \u0026lt;-chan *snap.Snapshotter) { commitC := make(chan *commit) errorC := make(chan error) rc := \u0026amp;raftNode{ proposeC: proposeC, confChangeC: confChangeC, commitC: commitC, errorC: errorC, id: id, peers: peers, join: join, waldir: fmt.Sprintf(\u0026#34;raftexample-%d\u0026#34;, id), snapdir: fmt.Sprintf(\u0026#34;raftexample-%d-snap\u0026#34;, id), getSnapshot: getSnapshot, snapCount: defaultSnapshotCount, stopc: make(chan struct{}), httpstopc: make(chan struct{}), httpdonec: make(chan struct{}), logger: zap.NewExample(), snapshotterReady: make(chan *snap.Snapshotter, 1), // rest of structure populated after WAL replay } go rc.startRaft() return commitC, errorC, rc.snapshotterReady } è¿™ä¸€éƒ¨åˆ†ç»“åˆtestä¸­çš„å†…å®¹ä¼šæ›´åŠ æ¸…æ™°:\nçŠ¶æ€æœºæŒæœ‰proposeCçš„senderï¼ŒraftNodeä¸­æŒæœ‰proposeCçš„receiverï¼Œå»ºç«‹èµ·äº†State Machine -\u0026gt; RaftNodeçš„è¿æ¥ commitCç”±raftNodeåˆ›å»ºï¼Œä¹‹åä¼ å…¥ç»™çŠ¶æ€æœºï¼Œå®Œæˆäº†RaftNode -\u0026gt; State Machineçš„è¿æ¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 func TestPutAndGetKeyValue(t *testing.T) { clusters := []string{\u0026#34;http://127.0.0.1:9021\u0026#34;} proposeC := make(chan string) defer close(proposeC) confChangeC := make(chan raftpb.ConfChange) defer close(confChangeC) var kvs *kvstore getSnapshot := func() ([]byte, error) { return kvs.getSnapshot() } commitC, errorC, snapshotterReady := newRaftNode(1, clusters, false, getSnapshot, proposeC, confChangeC) kvs = newKVStore(\u0026lt;-snapshotterReady, proposeC, commitC, errorC) } Summary åœ¨æœ¬ç« ä¸­ï¼Œç¬”è€…ä»‹ç»äº†etcd/raftçš„è®¾è®¡æ€æƒ³å’Œæ•´ä½“æ¶æ„ï¼Œå¤§è‡´å±•ç°äº†etcd/raftä½œä¸ºä¸€ä¸ªæä¾›rafté€»è¾‘çš„åº“ï¼Œæ˜¯å¦‚ä½•è¿è¡Œçš„ï¼Œä½†æ˜¯å¯¹äºetcd/raftå†…éƒ¨çš„ç»†èŠ‚å¹¶æœªå±•å¼€ï¼Œä¸€æ–¹é¢æ˜¯å…³äºetcd/raftï¼Œå·²ç»æœ‰äº†ç›¸å½“ä¼˜ç§€çš„æ–‡ç« ï¼šæ·±å…¥æµ…å‡ºetcd/raft â€”â€” 0x00 å¼•è¨€ - å‰é¸½ MrCroxx çš„åšå®¢ã€‚\nå¦ä¸€æ–¹é¢æ˜¯ï¼Œç¬”è€…å†™æœ¬ç¯‡æ–‡ç« ä¸»è¦ç›®çš„æ˜¯ä»‹ç»ä¸€ä¸‹å¦‚ä½•åŸºäºetcd/raftæ¥å®ç°ä¸€ä¸ªç®€å•çš„curpç®—æ³•ã€‚ä¸è¿‡ä¸´è¿‘æ¯•ä¸šï¼ŒåŠ ä¸Šç›®å‰è¿˜åœ¨å®ä¹ ï¼ŒçŸ­æ—¶é—´å†…å¤§æ¦‚æ²¡æœ‰æ—¶é—´å®Œæˆæ›´æ–°ï¼Œå› æ­¤ç›®å‰æ–‡ç« çš„é¢˜ç›®å®šä¸ºäº†Etcd/raftæ•´ä½“æ¶æ„ï¼Œåç»­å¦‚æœæ›´æ–°ï¼Œå¤§æ¦‚ä¼šæ”¹æˆä»ã€Šä» 0.5 åˆ° 1 å®ç°curp-qã€‹\nå¦‚æœæƒ³çœ‹ä¸€ä¸ªæ¶æ„ä¸Šä¸etcd/raftç›¸åŒï¼Œä½†ç¨å¾®ç®€åŒ–ä¸€ç‚¹çš„Raftï¼Œä¹Ÿå¯ä»¥çœ‹ç¬”è€…çš„å¦ä¸€ç¯‡æ–‡ç« ï¼š\ntoydbæºç é˜…è¯»03-Raft - çŸ¥ä¹\ntoydbæºç é˜…è¯»04-Raft State Machine - çŸ¥ä¹\n","permalink":"https://fischer0522.github.io/en/posts/tech/curp/etcd-raft%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84/","summary":"åœ¨etcdä¸­ï¼Œraftä½œä¸ºä¸€ä¸ªå•ç‹¬çš„æ¨¡å—è¢«æ‹†åˆ†å‡ºæ¥ï¼Œä½äºetcdçš„ç›®å½•ä¸‹ï¼Œåœ¨æ–°ç‰ˆæœ¬å½“ä¸­, etcd/raftè¢«æ‹†åˆ†å‡ºæ¥ï¼Œå¤„äºä¸€ä¸ªå•ç‹¬çš„ä»“åº“è¢«e","title":"00-Etcd-Raftæ•´ä½“æ¶æ„"},{"content":"æœ¬ç³»åˆ—çš„ç¬¬ä¸€ç« 00-Architectureä»¥SQLæ‰§è¡Œæµç¨‹ä¸ºæ•´ä¸ªç³»åˆ—åšäº†ä¸€ä¸ªå¼•å­ï¼Œç›®å‰æœ¬ç³»åˆ—é€šè¿‡å…­ç¯‡æ–‡ç« ï¼Œå·²ç»å°†toydbçš„å„ä¸ªæ¨¡å—éƒ½åˆ†æå®Œæ¯•ï¼Œåœ¨æœ¬ç« ä¸­ï¼Œä¸å¦¨åœ¨äº†è§£äº†å„ä¸ªæ¨¡å—çš„åŸºç¡€ä¸Šï¼Œè¡¥å…¨SQLæ‰§è¡Œçš„å…¨æµç¨‹ï¼Œä¸ºæ•´ä¸ªç³»åˆ—æ”¶å°¾ã€‚\nç¬”è€…ä¼šå…ˆè¡¥å…¨Schemaéƒ¨åˆ†ï¼Œä»‹ç»ä¸€ä¸‹åœ¨toydbä¸­å¦‚ä½•æ„å»ºèµ·å…³ç³»æ¨¡å‹ï¼Œä¹‹åæ˜¯SQLæ‰§è¡Œçš„å…¨æµç¨‹ï¼Œå¤§è‡´å¯ä»¥åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š\nä¸€æ˜¯åœ¨SQLå±‚ä¸­ï¼Œå®ŒæˆParse -\u0026gt; Optimize -\u0026gt; Executeçš„è¿‡ç¨‹ äºŒæ˜¯åœ¨SQL Engineä¸­ï¼Œå®Œæˆåˆ†å¸ƒå¼ + å­˜å‚¨çš„è¿‡ç¨‹ ç”±äºè°ƒç”¨é“¾æ¯”è¾ƒé•¿ï¼Œå¹¶ä¸”æ¯ä¸€æ­¥éƒ½ä¼šå¤„ç†å¤šç§ç±»å‹ï¼Œä»è€Œä»£ç é‡éå¸¸åºå¤§ï¼Œå¦‚æœä¸€å‘³å…¨éƒ¨å¤åˆ¶ç²˜è´´çš„è¯ä¼šå¯¼è‡´é€»è¾‘éå¸¸ä¸è¿è´¯ï¼Œè§‚æ„Ÿéå¸¸ä¸å¥½ï¼Œå› æ­¤åœ¨è¿™ä¸€ç« å½“ä¸­ï¼Œå¯¹äºè¿‘ä¼¼ç±»å‹çš„å¤„ç†ï¼Œç¬”è€…åªä¼šä¿ç•™å…¶ä¸­çš„å‡ ä¸ªï¼Œå¦‚æœæƒ³äº†è§£å…¨éƒ¨å®ç°çš„è¯ï¼Œè¿˜è¯·è¯»è€…è‡ªè¡Œæ‹‰å–æºç é˜…è¯»ã€‚\nSchema æ•°æ®ç±»å‹ toydbä¸­æä¾›äº†å››ç§æ•°æ®ç±»å‹çš„æ”¯æŒï¼Œåˆ†åˆ«æ˜¯Booleanã€Integerã€Floatã€Stringï¼Œå®šä¹‰åœ¨src/sql/types/mod.rsä¸­ï¼š\n1 2 3 4 5 6 7 8 /// A datatype #[derive(Clone, Debug, Hash, PartialEq, Serialize, Deserialize)] pub enum DataType { Boolean, Integer, Float, String, } Valueä½¿ç”¨ä¸€ä¸ªenumæ¥å®ç°ï¼Œè¡¨ç¤ºä¸åŒç±»å‹çš„å€¼ï¼Œé™¤äº†ä¸Šé¢çš„å››ç§æ•°æ®ç±»å‹ï¼Œè¿˜å…è®¸å€¼ä¸ºNullï¼Œç„¶åæä¾›äº†ä¸€äº›hashå’Œæ•°æ®ç±»å‹è½¬æ¢çš„æ”¯æŒï¼š\n1 2 3 4 5 6 7 8 9 /// A specific value of a data type #[derive(Clone, Debug, PartialEq, Serialize, Deserialize)] pub enum Value { Null, Boolean(bool), Integer(i64), Float(f64), String(String), } toydbçš„Schemaéå¸¸ç®€å•ï¼Œåªæœ‰ä¸¤çº§ï¼Œåˆ†åˆ«æ˜¯tableå’Œcolumnï¼Œå®šä¹‰åœ¨src/schema.rså½“ä¸­ï¼Œè€ŒRowåªæ˜¯ä¸€ä¸ªVec\u0026lt;Value\u0026gt;,æ²¡æœ‰å°è£…å…¶ä»–é€»è¾‘ã€‚\nTable ç”±äºåº•å±‚toydbé‡‡ç”¨çš„æ˜¯kvå­˜å‚¨ï¼Œä¸éœ€è¦åœ¨Tableå½“ä¸­å®šä¹‰å­˜å‚¨çš„è¡Œä¸ºï¼ŒTableçš„ç»“æ„å’Œå®ç° éƒ½éå¸¸ç®€æ´ï¼Œç»“æ„ä½“ä¸­åªæœ‰ä¸¤ä¸ªå­—æ®µï¼Œåˆ†åˆ«ç”¨äºè¡¨ç¤ºè¡¨åå’ŒåŒ…å«çš„å­—æ®µï¼Œç„¶åå®šä¹‰äº†ä¸€ä¸ªè¿­ä»£å™¨ï¼Œè¡¨ç¤ºå¤šä¸ªTableï¼Œç”¨äºæ‰«æå½“å‰æ‰€æœ‰çš„Tableï¼š\n1 2 3 4 5 6 7 8 9 /// A table scan iterator pub type Tables = Box\u0026lt;dyn DoubleEndedIterator\u0026lt;Item = Table\u0026gt; + Send\u0026gt;; /// A table schema #[derive(Clone, Debug, PartialEq, Deserialize, Serialize)] pub struct Table { pub name: String, pub columns: Vec\u0026lt;Column\u0026gt;, } æ–¹æ³• åŠŸèƒ½ pub fn get_column(\u0026amp;self, name: \u0026amp;str) æ ¹æ®åç§°è·å–åˆ— pub fn get_column_index(\u0026amp;self, name: \u0026amp;str) æ ¹æ®åç§°è·å–åˆ—ç´¢å¼• pub fn get_primary_key(\u0026amp;self) è·å–ä¸»é”®çš„åˆ— pub fn get_row_key(\u0026amp;self, row: \u0026amp;[Value]) è·å–ä¸€è¡Œä¸­ä¸»é”®çš„å€¼ pub fn validate(\u0026amp;self, txn: \u0026amp;mut dyn Transaction) éªŒè¯è¡¨ç»“æ„ pub fn validate_row(\u0026amp;self, row: \u0026amp;[Value], txn: \u0026amp;mut dyn Transaction) éªŒè¯è¡Œç»“æ„ å„ä¸ªæ–¹æ³•çš„å®ç°é€»è¾‘éƒ½å¾ˆç®€å•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 impl Table { /// Creates a new table schema pub fn new(name: String, columns: Vec\u0026lt;Column\u0026gt;) -\u0026gt; Result\u0026lt;Self\u0026gt; { let table = Self { name, columns }; Ok(table) } /// Fetches a column by name pub fn get_column(\u0026amp;self, name: \u0026amp;str) -\u0026gt; Result\u0026lt;\u0026amp;Column\u0026gt; { self.columns.iter().find(|c| c.name == name).ok_or_else(|| { Error::Value(format!(\u0026#34;Column {} not found in table {}\u0026#34;, name, self.name)) }) } /// Fetches a column index by name pub fn get_column_index(\u0026amp;self, name: \u0026amp;str) -\u0026gt; Result\u0026lt;usize\u0026gt; { self.columns.iter().position(|c| c.name == name).ok_or_else(|| { Error::Value(format!(\u0026#34;Column {} not found in table {}\u0026#34;, name, self.name)) }) } /// Returns the primary key column of the table pub fn get_primary_key(\u0026amp;self) -\u0026gt; Result\u0026lt;\u0026amp;Column\u0026gt; { self.columns .iter() .find(|c| c.primary_key) .ok_or_else(|| Error::Value(format!(\u0026#34;Primary key not found in table {}\u0026#34;, self.name))) } /// Returns the primary key value of a row pub fn get_row_key(\u0026amp;self, row: \u0026amp;[Value]) -\u0026gt; Result\u0026lt;Value\u0026gt; { row.get( self.columns .iter() .position(|c| c.primary_key) .ok_or_else(|| Error::Value(\u0026#34;Primary key not found\u0026#34;.into()))?, ) .cloned() .ok_or_else(|| Error::Value(\u0026#34;Primary key value not found for row\u0026#34;.into())) } /// Validates the table schema pub fn validate(\u0026amp;self, txn: \u0026amp;mut dyn Transaction) -\u0026gt; Result\u0026lt;()\u0026gt; { if self.columns.is_empty() { return Err(Error::Value(format!(\u0026#34;Table {} has no columns\u0026#34;, self.name))); } match self.columns.iter().filter(|c| c.primary_key).count() { 1 =\u0026gt; {} 0 =\u0026gt; return Err(Error::Value(format!(\u0026#34;No primary key in table {}\u0026#34;, self.name))), _ =\u0026gt; return Err(Error::Value(format!(\u0026#34;Multiple primary keys in table {}\u0026#34;, self.name))), }; for column in \u0026amp;self.columns { column.validate(self, txn)?; } Ok(()) } /// Validates a row pub fn validate_row(\u0026amp;self, row: \u0026amp;[Value], txn: \u0026amp;mut dyn Transaction) -\u0026gt; Result\u0026lt;()\u0026gt; { if row.len() != self.columns.len() { return Err(Error::Value(format!(\u0026#34;Invalid row size for table {}\u0026#34;, self.name))); } let pk = self.get_row_key(row)?; for (column, value) in self.columns.iter().zip(row.iter()) { column.validate_value(self, \u0026amp;pk, value, txn)?; } Ok(()) } } Column ColumnåŒæ ·å¾ˆç®€æ´ï¼Œå®šä¹‰å¦‚ä¸‹ï¼Œå‡ä»¥ç»™å‡ºæ³¨é‡Šï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 /// A table column schema #[derive(Clone, Debug, PartialEq, Deserialize, Serialize)] pub struct Column { /// Column name pub name: String, /// Column datatype pub datatype: DataType, /// Whether the column is a primary key pub primary_key: bool, /// Whether the column allows null values pub nullable: bool, /// The default value of the column pub default: Option\u0026lt;Value\u0026gt;, /// Whether the column should only take unique values pub unique: bool, /// The table which is referenced by this foreign key pub references: Option\u0026lt;String\u0026gt;, /// Whether the column should be indexed pub index: bool, } åœ¨columnå½“ä¸­ï¼Œå®šä¹‰äº†validateå’Œvalidate_columnåˆ†åˆ«éªŒè¯åˆ—å’Œåˆ—å½“ä¸­çš„å€¼æ˜¯å¦åˆæ³•ï¼š åœ¨validateä¸­åšäº†å¦‚ä¸‹æ£€æŸ¥ï¼š\nä¸»é”®ä¸èƒ½è®¾ç½®ä¸ºnull ä¸»é”®å¿…é¡»æ˜¯å”¯ä¸€çš„ï¼Œå…¶ä¸­çš„å€¼ä¸å…è®¸é‡å¤ï¼Œå› ä¸ºè¦ç”¨äºç”Ÿæˆkeyæ¥å­˜å‚¨ éªŒè¯é»˜è®¤å€¼ï¼šé»˜è®¤å€¼çš„ç±»å‹å¿…é¡»ä¸columnçš„ç±»å‹ç›¸åŒï¼›ä¸å…è®¸å°†nullè®¾ç½®ä¸ºénull columnçš„é»˜è®¤å€¼ï¼›å…è®¸ä¸ºnullçš„columnå¿…é¡»è®¾ç½®é»˜è®¤å€¼ã€‚ æ£€æŸ¥å¤–é”®å¼•ç”¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 /// Validates the column schema pub fn validate(\u0026amp;self, table: \u0026amp;Table, txn: \u0026amp;mut dyn Transaction) -\u0026gt; Result\u0026lt;()\u0026gt; { // Validate primary key if self.primary_key \u0026amp;\u0026amp; self.nullable { return Err(Error::Value(format!(\u0026#34;Primary key {} cannot be nullable\u0026#34;, self.name))); } if self.primary_key \u0026amp;\u0026amp; !self.unique { return Err(Error::Value(format!(\u0026#34;Primary key {} must be unique\u0026#34;, self.name))); } // Validate default value if let Some(default) = \u0026amp;self.default { if let Some(datatype) = default.datatype() { if datatype != self.datatype { return Err(Error::Value(format!( \u0026#34;Default value for column {} has datatype {}, must be {}\u0026#34;, self.name, datatype, self.datatype ))); } } else if !self.nullable { return Err(Error::Value(format!( \u0026#34;Can\u0026#39;t use NULL as default value for non-nullable column {}\u0026#34;, self.name ))); } } else if self.nullable { return Err(Error::Value(format!( \u0026#34;Nullable column {} must have a default value\u0026#34;, self.name ))); } // Validate references if let Some(reference) = \u0026amp;self.references { let target = if reference == \u0026amp;table.name { table.clone() } else if let Some(table) = txn.read_table(reference)? { table } else { return Err(Error::Value(format!( \u0026#34;Table {} referenced by column {} does not exist\u0026#34;, reference, self.name ))); }; if self.datatype != target.get_primary_key()?.datatype { return Err(Error::Value(format!( \u0026#34;Can\u0026#39;t reference {} primary key of table {} from {} column {}\u0026#34;, target.get_primary_key()?.datatype, target.name, self.datatype, self.name ))); } } Ok(()) } åœ¨validate_valueä¸­åšäº†å¦‚ä¸‹æ£€æŸ¥ï¼š\næ£€éªŒæ•°æ®ç±»å‹æ˜¯å¦ä¸columnçš„æ•°æ®ç±»å‹åŒ¹é… Stringç±»å‹ä¸èƒ½è¿‡é•¿ï¼Œæœ€å¤§ä¸º1024ä¸ªå­—èŠ‚ æ£€æŸ¥å¤–é”® æ£€æŸ¥uniqueï¼Œå¤„ç†æ–¹æ³•æ˜¯å…¨è¡¨éå†æ£€æµ‹æ˜¯å¦æœ‰ç›¸åŒçš„å€¼ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 /// Validates a column value pub fn validate_value( \u0026amp;self, table: \u0026amp;Table, pk: \u0026amp;Value, value: \u0026amp;Value, txn: \u0026amp;mut dyn Transaction, ) -\u0026gt; Result\u0026lt;()\u0026gt; { // Validate datatype match value.datatype() { None if self.nullable =\u0026gt; Ok(()), None =\u0026gt; Err(Error::Value(format!(\u0026#34;NULL value not allowed for column {}\u0026#34;, self.name))), Some(ref datatype) if datatype != \u0026amp;self.datatype =\u0026gt; Err(Error::Value(format!( \u0026#34;Invalid datatype {} for {} column {}\u0026#34;, datatype, self.datatype, self.name ))), _ =\u0026gt; Ok(()), }?; // Validate value match value { Value::String(s) if s.len() \u0026gt; 1024 =\u0026gt; { Err(Error::Value(\u0026#34;Strings cannot be more than 1024 bytes\u0026#34;.into())) } _ =\u0026gt; Ok(()), }?; // Validate outgoing references if let Some(target) = \u0026amp;self.references { match value { Value::Null =\u0026gt; Ok(()), Value::Float(f) if f.is_nan() =\u0026gt; Ok(()), v if target == \u0026amp;table.name \u0026amp;\u0026amp; v == pk =\u0026gt; Ok(()), v if txn.read(target, v)?.is_none() =\u0026gt; Err(Error::Value(format!( \u0026#34;Referenced primary key {} in table {} does not exist\u0026#34;, v, target, ))), _ =\u0026gt; Ok(()), }?; } // Validate uniqueness constraints if self.unique \u0026amp;\u0026amp; !self.primary_key \u0026amp;\u0026amp; value != \u0026amp;Value::Null { let index = table.get_column_index(\u0026amp;self.name)?; let mut scan = txn.scan(\u0026amp;table.name, None)?; while let Some(row) = scan.next().transpose()? { if row.get(index).unwrap_or(\u0026amp;Value::Null) == value \u0026amp;\u0026amp; \u0026amp;table.get_row_key(\u0026amp;row)? != pk { return Err(Error::Value(format!( \u0026#34;Unique value {} already exists for column {}\u0026#34;, value, self.name ))); } } } Ok(()) } åˆå§‹åŒ– åœ¨mainå‡½æ•°å½“ä¸­ï¼Œä¼šè°ƒç”¨serveå¯åŠ¨æœåŠ¡ï¼š\nåœ¨serveå½“ä¸­ä¼šé¦–å…ˆåˆ›å»ºä¸€ä¸ªsql_engineï¼Œè¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œsql_engineå¯¹åº”çš„æ˜¯sql::engine::Raft,è¿™ä¹Ÿæ˜¯SQL Engineçš„å…¥å£ï¼Œexecutorä¼šé¦–å…ˆå°†å‘½ä»¤å‘é€ç»™Raft è°ƒç”¨raft.serve()å¯åŠ¨Raftï¼Œåˆ›å»ºç”¨äºèŠ‚ç‚¹ä¹‹é—´äº¤äº’çš„tcp senderå’Œreceiverï¼Œåˆ›å»ºä¸€ä¸ªeventloopå¤„ç†Messageï¼Œeventloopå¦‚ä½•å¤„ç†Messageï¼Œåœ¨ä¸Šä¸€ç« ä¸­å·²ç»ä»‹ç»è¿‡ã€‚ è°ƒç”¨serve_sql()å¯åŠ¨serverï¼Œå¤„ç†clientå‘é€è€Œæ¥çš„è¯·æ±‚ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 /// Serves Raft and SQL requests until the returned future is dropped. Consumes the server. pub async fn serve(self) -\u0026gt; Result\u0026lt;()\u0026gt; { let sql_listener = self .sql_listener .ok_or_else(|| Error::Internal(\u0026#34;Must listen before serving\u0026#34;.into()))?; let raft_listener = self .raft_listener .ok_or_else(|| Error::Internal(\u0026#34;Must listen before serving\u0026#34;.into()))?; let (raft_tx, raft_rx) = mpsc::unbounded_channel(); let sql_engine = sql::engine::Raft::new(raft_tx); // åˆ†åˆ«å¯åŠ¨Raft serverå’ŒSql server tokio::try_join!( self.raft.serve(raft_listener, raft_rx), Self::serve_sql(sql_listener, sql_engine), )?; Ok(()) } pub async fn serve( self, listener: TcpListener, client_rx: mpsc::UnboundedReceiver\u0026lt;(Request, oneshot::Sender\u0026lt;Result\u0026lt;Response\u0026gt;\u0026gt;)\u0026gt;, ) -\u0026gt; Result\u0026lt;()\u0026gt; { let (tcp_in_tx, tcp_in_rx) = mpsc::unbounded_channel::\u0026lt;Message\u0026gt;(); let (tcp_out_tx, tcp_out_rx) = mpsc::unbounded_channel::\u0026lt;Message\u0026gt;(); let (task, tcp_receiver) = Self::tcp_receive(listener, tcp_in_tx).remote_handle(); tokio::spawn(task); let (task, tcp_sender) = Self::tcp_send(self.peers, tcp_out_rx).remote_handle(); tokio::spawn(task); let (task, eventloop) = Self::eventloop(self.node, self.node_rx, client_rx, tcp_in_rx, tcp_out_tx) .remote_handle(); tokio::spawn(task); tokio::try_join!(tcp_receiver, tcp_sender, eventloop)?; Ok(()) } /// Serves SQL clients. async fn serve_sql(listener: TcpListener, engine: sql::engine::Raft) -\u0026gt; Result\u0026lt;()\u0026gt; { let mut listener = TcpListenerStream::new(listener); while let Some(socket) = listener.try_next().await? { // å¤„ç†å•ä¸ªè¯·æ±‚ let peer = socket.peer_addr()?; let session = Session::new(engine.clone())?; tokio::spawn(async move { info!(\u0026#34;Client {} connected\u0026#34;, peer); match session.handle(socket).await { Ok(()) =\u0026gt; info!(\u0026#34;Client {} disconnected\u0026#34;, peer), Err(err) =\u0026gt; error!(\u0026#34;Client {} error: {}\u0026#34;, peer, err), } }); } Ok(()) } æ‰§è¡Œæµç¨‹ SQLæ‰§è¡Œ SQLæ‰§è¡Œçš„å…¥å£åœ¨serve_sql()å½“ä¸­ï¼Œä»listenerå½“ä¸­è·å–åˆ°å•ä¸ªè¯·æ±‚ä¹‹åï¼Œå°±ä¼šåˆ›å»ºä¸€ä¸ªSessionï¼Œç„¶åæŠŠä¼ ä¸‹æ¥çš„raft engineäº¤ç»™Sessionï¼Œä¸€ä¸ªSessionç”¨äºè´Ÿè´£ä¸€æ¡SQLï¼Œåœ¨å¤„ç†å®Œç½‘ç»œè¿æ¥ä¹‹åï¼Œä¼šè°ƒç”¨åˆ°Session.execute()æ¥ä»è§£æSQLçš„è¿‡ç¨‹å¼€å§‹ï¼Œæ‰§è¡Œä¸€æ¡SQLã€‚\nåœ¨executeä¸­ï¼Œä¼šå…ˆä½¿ç”¨Parserè¿›è¡Œsqlè§£æï¼Œç„¶åæ ¹æ®ç”Ÿæˆçš„AST Statementå»ç”Ÿæˆä¸€ä¸ªæ‰§è¡Œè®¡åˆ’ï¼Œç„¶åå†é€šè¿‡Optimizerè¿›è¡Œä¼˜åŒ–ï¼Œå¾—åˆ°ä¸€ä¸ªæœ€ç»ˆçš„æ‰§è¡Œè®¡åˆ’ï¼Œæœ€åæ ¹æ®æ‰§è¡Œè®¡åˆ’æ„å»ºä¸€ä¸ªExecutorï¼Œè°ƒç”¨Executorçš„executeå¼€å§‹æ‰§è¡Œã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 /// Executes a query, managing transaction status for the session pub fn execute(\u0026amp;mut self, query: \u0026amp;str) -\u0026gt; Result\u0026lt;ResultSet\u0026gt; { // FIXME We should match on self.txn as well, but get this error: // error[E0009]: cannot bind by-move and by-ref in the same pattern // ...which seems like an arbitrary compiler limitation match Parser::new(query).parse()? { ast::Statement::Begin { .. } if self.txn.is_some() =\u0026gt; { Err(Error::Value(\u0026#34;Already in a transaction\u0026#34;.into())) } // ... // ... statement =\u0026gt; { let mut txn = self.engine.begin()?; match Plan::build(statement, \u0026amp;mut txn)?.optimize(\u0026amp;mut txn)?.execute(\u0026amp;mut txn) { Ok(result) =\u0026gt; { txn.commit()?; Ok(result) } Err(error) =\u0026gt; { txn.rollback()?; Err(error) } } } } } Parser åœ¨toydbå½“ä¸­ï¼Œé€šè¿‡Parserä¼šç”Ÿæˆä¸€ä¸ªStatementï¼Œå¯¹äºparserå¦‚ä½•è§£æsqlçš„è¿‡ç¨‹ï¼Œç”±äºç¬”è€…æ²¡æœ‰ç³»ç»Ÿå­¦è¿‡ç¼–è¯‘åŸç†ï¼Œä¹Ÿå‡ ä¹ä¸æ‡‚ç¼–è¯‘åŸç†ï¼Œè¿™é‡Œå°±ä¸åˆ†æäº†ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯è‡ªè¡Œé˜…è¯»ï¼Œè¿™ä¸€éƒ¨åˆ†å®šä¹‰åœ¨src/parserä¸‹ã€‚\nåœ¨Statementå½“ä¸­ï¼ŒåŒ…å«äº†SQLæ‰§è¡Œæ‰€éœ€è¦çš„æ‰€æœ‰ä¿¡æ¯ï¼Œä½¿ç”¨enumè¿›è¡Œè¡¨ç¤ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 pub enum Statement { Begin { read_only: bool, as_of: Option\u0026lt;u64\u0026gt;, }, Commit, Rollback, Select { select: Vec\u0026lt;(Expression, Option\u0026lt;String\u0026gt;)\u0026gt;, from: Vec\u0026lt;FromItem\u0026gt;, r#where: Option\u0026lt;Expression\u0026gt;, group_by: Vec\u0026lt;Expression\u0026gt;, having: Option\u0026lt;Expression\u0026gt;, order: Vec\u0026lt;(Expression, Order)\u0026gt;, offset: Option\u0026lt;Expression\u0026gt;, limit: Option\u0026lt;Expression\u0026gt;, }, } Plan åœ¨æ‹¿åˆ°äº†Statementä¹‹åï¼Œå°±å¯ä»¥æ ¹æ®Statementå»ç”Ÿæˆä¸€ä¸ªåŸºç¡€çš„æ‰§è¡Œè®¡åˆ’äº†ï¼Œtoydbä¸­æ²¡æœ‰åŒºåˆ†é€»è¾‘è®¡åˆ’å’Œç‰©ç†è®¡åˆ’ï¼Œåªå®šä¹‰äº†planå’Œå¯¹åº”çš„plan nodeã€‚Plan nodeæ˜¯ä½¿ç”¨enumè¿›è¡Œå®šä¹‰çš„ï¼Œç»“æ„ä¸Šä¸Executoræ˜¯ä¸€ä¸€å¯¹åº”çš„ã€‚\nPlanä½œä¸ºPlan Nodeçš„Wrapperï¼Œä¸ºå…¶å°è£…äº†ä¸€äº›æ–¹æ³•ï¼š\nbuild:æ ¹æ®Statementçš„ç±»å‹ï¼Œæ„å»ºä¸€ä¸ªPlan Node optimize:å¯¹planè¿›è¡Œä¼˜åŒ–ç”Ÿæˆä¸€ä¸ªæœ€ç»ˆçš„æ‰§è¡Œè®¡åˆ’ï¼Œ execute:æ‰§è¡Œä¸€ä¸ªplanï¼Œä¼šå…ˆæ ¹æ®è‡ªèº«çš„Plan Nodeå»åˆ›å»ºä¸€ä¸ªExecutorï¼Œç„¶åä¼šè°ƒç”¨åˆ°Executorçš„execute åœ¨optimizeå½“ä¸­ï¼Œå…±æ¶‰åŠåˆ°äº†äº”ç§ç±»å‹çš„ä¼˜åŒ–ï¼š\nConstantFolder:æå‰è®¡ç®—ä¸€äº›å¸¸é‡è¡¨è¾¾å¼ï¼Œå¦‚ where a \u0026gt; 5 - 3ä¼˜åŒ–ä¸ºwhere a \u0026gt; 2ã€‚ FilterPushdown:è°“è¯ä¸‹æ¨ï¼Œä¸ºäº†è®©åº•å±‚ç®—å­å°½å¯èƒ½å¤šçš„è¿‡æ»¤æ•°æ®ï¼Œä»è€Œå‡å°‘ä¸Šå±‚çš„è®¡ç®—é‡ IndexLookup:å¦‚æœå½“å‰Tableä¸Šè¦æŸ¥è¯¢çš„columnå­˜åœ¨ç´¢å¼•ï¼Œå°±å°†TableScanè½¬æ¢ä¸ºIndexScan NoopCleaner:Noopæ„å‘³No Operationï¼Œåœ¨è¿™ä¸€éƒ¨åˆ†æ¸…é™¤æ‰ä¸€äº›æ²¡æœ‰æ„ä¹‰çš„Nodeå’ŒFilterï¼Œä¾‹å¦‚where 1 = 1è¿™ç±»æ’ä¸ºtrueçš„ JoinType:ä¼˜åŒ–Joinç±»å‹ï¼Œç›®å‰ä¼šå°†NestedLoopJoinä¼˜åŒ–ä¸ºHashJoinã€‚ buildå’Œexecuteéƒ½ä¼šè¿”å›ä¸€ä¸ªSelfï¼Œä»è€Œè¿›è¡Œé“¾å¼è°ƒç”¨ï¼ŒæŒ‰ç…§build -\u0026gt; optimize -\u0026gt; executeçš„æµç¨‹æ¥æ‰§è¡Œã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 /// A plan node #[derive(Debug, PartialEq, Serialize, Deserialize)] pub enum Node { Aggregation { source: Box\u0026lt;Node\u0026gt;, aggregates: Vec\u0026lt;Aggregate\u0026gt;, }, HashJoin { left: Box\u0026lt;Node\u0026gt;, left_field: (usize, Option\u0026lt;(Option\u0026lt;String\u0026gt;, String)\u0026gt;), right: Box\u0026lt;Node\u0026gt;, right_field: (usize, Option\u0026lt;(Option\u0026lt;String\u0026gt;, String)\u0026gt;), outer: bool, }, // ... // ... NestedLoopJoin { left: Box\u0026lt;Node\u0026gt;, left_size: usize, right: Box\u0026lt;Node\u0026gt;, predicate: Option\u0026lt;Expression\u0026gt;, outer: bool, Update { table: String, source: Box\u0026lt;Node\u0026gt;, expressions: Vec\u0026lt;(usize, Option\u0026lt;String\u0026gt;, Expression)\u0026gt;, }, } pub struct Plan(pub Node); impl Plan { /// Builds a plan from an AST statement. pub fn build\u0026lt;C: Catalog\u0026gt;(statement: ast::Statement, catalog: \u0026amp;mut C) -\u0026gt; Result\u0026lt;Self\u0026gt; { Planner::new(catalog).build(statement) } /// Executes the plan, consuming it. pub fn execute\u0026lt;T: Transaction + \u0026#39;static\u0026gt;(self, txn: \u0026amp;mut T) -\u0026gt; Result\u0026lt;ResultSet\u0026gt; { \u0026lt;dyn Executor\u0026lt;T\u0026gt;\u0026gt;::build(self.0).execute(txn) } /// Optimizes the plan, consuming it. pub fn optimize\u0026lt;C: Catalog\u0026gt;(self, catalog: \u0026amp;mut C) -\u0026gt; Result\u0026lt;Self\u0026gt; { let mut root = self.0; root = optimizer::ConstantFolder.optimize(root)?; root = optimizer::FilterPushdown.optimize(root)?; root = optimizer::IndexLookup::new(catalog).optimize(root)?; root = optimizer::NoopCleaner.optimize(root)?; root = optimizer::JoinType.optimize(root)?; Ok(Plan(root)) } } Executor åœ¨æ‰§è¡Œè¿™ä¸€éƒ¨åˆ†ï¼Œtoydbå®šä¹‰äº†ä¸€ä¸ªtraitï¼Œå…¶ä¸­åªæœ‰executeä¸€ä¸ªæ–¹æ³•ï¼Œåªè¦å®ç°äº†è¿™ä¸ªtraitï¼Œå°±å¯ä»¥ä½œä¸ºExecutorè¢«è°ƒç”¨ã€‚\n1 2 3 4 pub trait Executor\u0026lt;T: Transaction\u0026gt; { /// Executes the executor, consuming it and returning a result set fn execute(self: Box\u0026lt;Self\u0026gt;, txn: \u0026amp;mut T) -\u0026gt; Result\u0026lt;ResultSet\u0026gt;; } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 pub struct Insert { table: String, columns: Vec\u0026lt;String\u0026gt;, rows: Vec\u0026lt;Vec\u0026lt;Expression\u0026gt;\u0026gt;, } impl\u0026lt;T: Transaction\u0026gt; Executor\u0026lt;T\u0026gt; for Insert { fn execute(self: Box\u0026lt;Self\u0026gt;, txn: \u0026amp;mut T) -\u0026gt; Result\u0026lt;ResultSet\u0026gt; { let table = txn.must_read_table(\u0026amp;self.table)?; let mut count = 0; for expressions in self.rows { let mut row = expressions.into_iter().map(|expr| expr.evaluate(None)).collect::\u0026lt;Result\u0026lt;_\u0026gt;\u0026gt;()?; if self.columns.is_empty() { row = Self::pad_row(\u0026amp;table, row)?; } else { row = Self::make_row(\u0026amp;table, \u0026amp;self.columns, row)?; } txn.create(\u0026amp;table.name, row)?; count += 1; } Ok(ResultSet::Create { count }) } } ä»¥Insertä¸ºä¾‹ï¼Œé¦–å…ˆå®šä¹‰ä¸€ä¸ªInsertç»“æ„ä½“ï¼Œç„¶åä¸ºInsertå®ç°Executor traitã€‚åç»­å°±æ˜¯åˆ©ç”¨SQL Engineæ¥å…ˆå…±è¯†åå­˜å‚¨äº†ã€‚\nSQL Engine Read è¿™é‡Œç»§ç»­ä»¥Insertä¸ºä¾‹ï¼Œèµ°å®ŒSQL Engineçš„æ•´ä¸ªæµç¨‹ã€‚Insertä¸­éœ€è¦å…ˆè¯»å–åˆ°å¯¹åº”çš„Tableï¼Œä¹‹åå†æ·»åŠ å¤šæ¡Rowï¼Œåˆ†ä¸ºä¸€æ¬¡è¯»è¯·æ±‚å’Œå¤šæ¬¡å†™è¯·æ±‚ï¼Œåˆšå¥½å¯ä»¥ç”¨æ¥åˆ†æè¯»å†™è¯·æ±‚çš„æ‰§è¡Œæµç¨‹ã€‚ Insertæ—¶éœ€è¦é¦–å…ˆè¯»å–åˆ°å¯¹åº”çš„Tableï¼Œè¿™é‡Œå°±ä¼šè°ƒç”¨SQL Engineçš„txn.must_read_table()ï¼Œåœ¨è¯¥å‡½æ•°å†…ï¼Œæœ€ç»ˆä¼šè°ƒç”¨åˆ°sql::engine::raft::Transactionçš„read_table()ï¼Œåœ¨è¿™é‡Œï¼Œä¼šé€šè¿‡Raft Clientå‘Raft Serverå»å‘é€ä¸€æ¡ç±»å‹ä¸ºQuery::ReadTableçš„è¯·æ±‚ã€‚\nself.client.query()ï¼Œä¼šè°ƒç”¨åˆ°execute()ã€‚åœ¨execute()å½“ä¸­ï¼Œä¼šè°ƒç”¨oneshot::channel()åˆ›å»ºä¸€ä¸ªä¸€æ¬¡æ€§çš„channelï¼Œå°†channelçš„æ¶ˆæ¯å‘é€ç«¯response_txå’Œrequestä¸€åŒå‘é€ç»™Raft Serverã€‚\nä¹‹åï¼ŒClientå°±ä¼šç›‘å¬è¿™ä¸ªchannelï¼Œè·å–Serverç«¯å‘é€å›æ¥äº†æ‰§è¡Œç»“æœ,Serveræ¥æ”¶å¹¶æ‰§è¡Œå®Œä¹‹åï¼Œä¼šä½¿ç”¨ä¼ è¿‡å»çš„å‘é€ç«¯å†å°†å“åº”å‘é€å›æ¥ï¼ŒClientç­‰å¾…ä»æ¥æ”¶ç«¯è·å–æ¶ˆæ¯ï¼Œæ‹¿åˆ°Raft Serverå¯¹requestçš„æ‰§è¡Œç»“æœå‘ä¸Šè¿”å›ã€‚æ­¤æ—¶ï¼Œåˆ›å»ºçš„oneshot channelå°±å¯ä»¥é”€æ¯äº†ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 // (1) fn read_table(\u0026amp;self, table: \u0026amp;str) -\u0026gt; Result\u0026lt;Option\u0026lt;Table\u0026gt;\u0026gt; { self.client.query(Query::ReadTable { txn: self.state.clone(), table: table.to_string() }) } // (2) /// Queries the Raft state machine, deserializing the response into the /// return type. fn query\u0026lt;V: DeserializeOwned\u0026gt;(\u0026amp;self, query: Query) -\u0026gt; Result\u0026lt;V\u0026gt; { match self.execute(raft::Request::Query(bincode::serialize(\u0026amp;query)?))? { raft::Response::Query(response) =\u0026gt; Ok(bincode::deserialize(\u0026amp;response)?), resp =\u0026gt; Err(Error::Internal(format!(\u0026#34;Unexpected Raft query response {:?}\u0026#34;, resp))), } } // (3) fn execute(\u0026amp;self, request: raft::Request) -\u0026gt; Result\u0026lt;raft::Response\u0026gt; { let (response_tx, response_rx) = oneshot::channel(); self.tx.send((request, response_tx))?; futures::executor::block_on(response_rx)? } Serverç«¯çš„æ¥æ”¶é€»è¾‘å°±åœ¨serverçš„eventloopå½“ä¸­ï¼Œä»client_rx(ä¸Šé¢ä¼ æ¥çš„raft_rx)æ¥æ”¶åˆ°Clientå‘é€çš„requestå’Œresponse_txã€‚\nè¯·æ±‚éœ€è¦å…ˆé€šè¿‡Raftå®Œæˆå…±è¯†ï¼Œé€šè¿‡step()å°†Messageäº¤ç»™Leader(é€šå¸¸æ˜¯Leaderï¼Œå¦‚æœä¸æ˜¯Leaderä¹Ÿä¼šè½¬å‘ç»™Leaderï¼Œåé¢å…¨éƒ¨å‡è®¾è¯·æ±‚å‘é€ç»™äº†Leader)ï¼Œä¹‹åApplyäº†æ‰èƒ½å¤Ÿæ‰§è¡Œï¼Œè¿™é‡Œå…ˆä½¿ç”¨ä¸€ä¸ªHashMapä¿å­˜è¯·æ±‚ï¼Œç­‰åˆ°Applyå¹¶æ‰§è¡Œå®Œä¹‹åå†ä»HashMapä¸­è·å–å‡ºæš‚å­˜çš„response_rxï¼Œå“åº”Clientã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 // è·å–clientå‘é€çš„æ¶ˆæ¯ï¼Œäº¤ç»™Raftæ¨¡å—å»å¤„ç†ï¼Œè¿™é‡Œçš„clientå¹¶ä¸æ˜¯ç”¨æˆ·çš„clientï¼Œè€Œæ˜¯è¦æ‰§è¡Œå‘½ä»¤çš„sqlç«¯ // æš‚å­˜å‘½ä»¤ï¼Œç­‰åˆ°æ—¥å¿—Applyå¹¶æ‰§è¡Œå®Œä¹‹åå†å“åº”å®¢æˆ·ç«¯ Some((request, response_tx)) = client_rx.next() =\u0026gt; { let id = Uuid::new_v4().as_bytes().to_vec(); let msg = Message{ from: Address::Client, to: Address::Node(node.id()), term: 0, event: Event::ClientRequest{id: id.clone(), request}, }; node = node.step(msg)?; requests.insert(id, response_tx); } Leader\nåœ¨toydbä¸­ï¼Œåªè¯»è¯·æ±‚ä¼šé€šè¿‡ReadIndexæ¥ä¼˜åŒ–ï¼Œå› æ­¤ä¸ä¼šåˆ›å»ºæ—¥å¿—ã€‚\nè°ƒç”¨äº†step()ä¹‹åä¼šå†è°ƒç”¨åˆ°Leader.step()ï¼Œåœ¨è¿™å…¶ä¸­ä¼šå®Œæˆå¯¹Message::ClientRequestçš„å¤„ç†ï¼Œè¿™é‡Œçš„requestç±»å‹ä¸ºrequest::Queryï¼Œå› æ­¤Leaderå°±ä¼šå…ˆå‘çŠ¶æ€æœºå‘é€ä¸€æ¡Instruction::Queryï¼Œè®©çŠ¶æ€æœºå…ˆè®°å½•è¿™ä¸€æ¬¡åªè¯»è¯·æ±‚ï¼Œä¹‹åå†å‘é€ä¸€æ¡Instruction::Voteï¼Œè¡¨ç¤ºLeaderå¯¹æ­¤æ¬¡çš„åªè¯»è¯·æ±‚æŠ•ç¥¨ï¼Œè®©çŠ¶æ€æœºè®°å½•ã€‚\nåŒæ—¶ï¼ŒLeaderä¼šå‘é€ä¸€æ¬¡heartbeatï¼Œè¯·æ±‚å…¶ä»–èŠ‚ç‚¹ä¹Ÿå¯¹å…¶æŠ•ç¥¨ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 Event::ClientRequest { id, request: Request::Query(command) } =\u0026gt; { let (commit_index, _) = self.log.get_commit_index(); self.state_tx.send(Instruction::Query { id, address: msg.from, command, term: self.term, index: commit_index, quorum: self.quorum(), })?; self.state_tx.send(Instruction::Vote { term: self.term, index: commit_index, address: Address::Node(self.id), })?; self.heartbeat()?; } Follower\nFolloweråœ¨æ¥æ”¶åˆ°äº†Leaderå‘é€çš„Message::Heartbeatä¹‹åï¼Œé¦–å…ˆä¼šæ ¹æ®Leaderçš„è¿›åº¦å’Œè‡ªèº«æ‹¥æœ‰çš„æ—¥å¿—æ¥æ›´æ–°commitè¿›åº¦ï¼Œå›åº”Leaderä¸€æ¡Message::ConfirmLeaderï¼Œè¡¨ç¤ºæ¥æ”¶åˆ°äº†Leaderçš„å¿ƒè·³ä¿¡æ¯ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 Event::Heartbeat { commit_index, commit_term } =\u0026gt; { // Check that the heartbeat is from our leader. let from = msg.from.unwrap(); match self.role.leader { Some(leader) =\u0026gt; assert_eq!(from, leader, \u0026#34;Multiple leaders in term\u0026#34;), None =\u0026gt; self = self.become_follower(Some(from), msg.term)?, } // Advance commit index and apply entries if possible. let has_committed = self.log.has(commit_index, commit_term)?; let (old_commit_index, _) = self.log.get_commit_index(); if has_committed \u0026amp;\u0026amp; commit_index \u0026gt; old_commit_index { self.log.commit(commit_index)?; let mut scan = self.log.scan((old_commit_index + 1)..=commit_index)?; while let Some(entry) = scan.next().transpose()? { self.state_tx.send(Instruction::Apply { entry })?; } } self.send(msg.from, Event::ConfirmLeader { commit_index, has_committed })?; } Leader\nLeaderåœ¨æ¥æ”¶åˆ°Followerå“åº”çš„Message::ConfirmLeaderä¹‹åï¼ŒLeaderå†å°†Followerçš„commitè¿›åº¦å°è£…æˆä¸€æ¡Instruction::Voteå‘é€ç»™çŠ¶æ€æœºã€‚æ­¤å¤–ï¼Œå¦‚æœfollowerå‘ç°è‡ªèº«è¿›åº¦è½åäºLeaderï¼Œæ­¤æ—¶Leaderè¿˜ä¼šå‘Followerå»å‘é€Logï¼Œè¡¥é½è¿›åº¦ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 // A follower received one of our heartbeats and confirms that we // are its leader. If it doesn\u0026#39;t have the commit index in its local // log, replicate the log to it. Event::ConfirmLeader { commit_index, has_committed } =\u0026gt; { let from = msg.from.unwrap(); // ä¸ä¸Šå±‚çŠ¶æ€æœºè¿›è¡Œäº¤äº’ self.state_tx.send(Instruction::Vote { term: msg.term, index: commit_index, address: msg.from, })?; if !has_committed { self.send_log(from)?; } } çŠ¶æ€æœº\nçŠ¶æ€æœºæ˜¯é€šè¿‡Driver.drive()æ¥é©±åŠ¨çš„ï¼Œåœ¨å…¶ä¸­ä¸æ–­å¤„ç†ç”±ä¸‹å±‚Raftæ¨¡å—çš„å‘é€è€Œæ¥çš„Instructionæ‰§è¡Œï¼ŒçŠ¶æ€æœºè¿™ä¸€éƒ¨åˆ†æ˜¯å’Œä¸Šä¸€éƒ¨åˆ†åŒæ—¶æ‰§è¡Œçš„ã€‚\nå¯¹äºä¸Šé¢å‘é€è€Œæ¥çš„Instruction::Queryï¼ŒçŠ¶æ€æœºä¼šå°†å…¶è®°å½•ï¼Œè€Œå‘é€è€Œæ¥çš„Instrcution::Voteï¼Œä¼šå…ˆè°ƒç”¨self.query_vote()ï¼Œç„¶åè°ƒç”¨self.query_execute()\nåœ¨self.query_vote()ä¸­ï¼Œç®€å•è®°å½•æŠ•ç¥¨ åœ¨self.query_execute()ä¸­,ä¼šéå†è¿˜æœªæ‰§è¡Œçš„ï¼Œå¹¶ä¸”index \u0026lt;= last_apply_indexçš„æ‰€æœ‰è¯·æ±‚ï¼Œè·å–å‡ºå½“å‰çš„æŠ•ç¥¨æ•°ï¼Œå¦‚æœè¾¾åˆ°äº†quorumï¼Œå°±äº¤ç»™çŠ¶æ€æœºçš„å®ç°å»æ‰§è¡Œï¼Œç„¶åå‘Leaderå‘é€ä¸€æ¡Message::ClientResponseï¼Œå‘ŠçŸ¥LeaderçŠ¶æ€æœºå·²ç»æ‰§è¡Œç»“æŸã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 /// Votes for queries up to and including a given commit index for a term by an address. fn query_vote(\u0026amp;mut self, term: Term, commit_index: Index, address: Address) { for (_, queries) in self.queries.range_mut(..=commit_index) { for (_, query) in queries.iter_mut() { if term \u0026gt;= query.term { query.votes.insert(address); } } } } /// Executes any queries that are ready. fn query_execute(\u0026amp;mut self, state: \u0026amp;mut dyn State) -\u0026gt; Result\u0026lt;()\u0026gt; { for query in self.query_ready(state.get_applied_index()) { debug!(\u0026#34;Executing query {:?}\u0026#34;, query.command); let result = state.query(query.command); if let Err(error @ Error::Internal(_)) = result { return Err(error); } self.send( query.address, Event::ClientResponse { id: query.id, response: result.map(Response::Query) }, )? } Ok(()) } å•æœºå­˜å‚¨\nåœ¨state.query()ä¸­ï¼Œå°±ä¼šæ‰¾åˆ°çŠ¶æ€æœºçš„å®ç°ï¼Œè€ŒçŠ¶æ€æœºçš„å®ç°æ˜¯ä¸€ä¸ªMVCCçš„Wrapper,åœ¨queryå½“ä¸­ï¼Œæ ¹æ®è¯·æ±‚ç±»å‹è¿›è¡Œåˆ†ç±»ï¼Œæ¢å¤å½“å‰äº‹åŠ¡çš„çŠ¶æ€ï¼Œç„¶åä¼šè°ƒç”¨åˆ°\nTransaction\u0026lt;storage::engine::Engine\u0026gt;.read_table(),åœ¨è¿™é‡Œï¼Œç»ˆäºè„±ç¦»äº†åˆ†å¸ƒå¼çš„éƒ¨åˆ†ï¼Œè½¬ä¸ºå•æœºæ‰§è¡Œäº†ã€‚æ„å»ºä¸€ä¸ªtable.nameçš„keyå»å­˜å‚¨å¼•æ“ä¸­æŸ¥è¯¢ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 // çŠ¶æ€æœºä¸­çš„query fn query(\u0026amp;self, command: Vec\u0026lt;u8\u0026gt;) -\u0026gt; Result\u0026lt;Vec\u0026lt;u8\u0026gt;\u0026gt; { match bincode::deserialize(\u0026amp;command)? { // ... Query::ReadTable { txn, table } =\u0026gt; { bincode::serialize(\u0026amp;self.engine.resume(txn)?.read_table(\u0026amp;table)?) } // ... } } // å•æœºå­˜å‚¨å¼•æ“çš„è¯»å–æ“ä½œ fn read_table(\u0026amp;self, table: \u0026amp;str) -\u0026gt; Result\u0026lt;Option\u0026lt;Table\u0026gt;\u0026gt; { self.txn.get(\u0026amp;Key::Table(table.into()).encode()?)?.map(|v| deserialize(\u0026amp;v)).transpose() } å†å¾€ä¸‹èµ°å°±æ˜¯MVCCäº†ï¼ŒMVCCåˆå°è£…äº†storage trait(Bitcaskæˆ–è€…Memory),MVCCè°ƒç”¨äº†storage çš„scanï¼Œå¯¹ä»¥user_keyä¸ºå‰ç¼€çš„keyè¿›è¡Œæ‰«æï¼Œæ‰¾åˆ°å¯¹å½“å‰äº‹åŠ¡èƒ½è§çš„ç‰ˆæœ¬ï¼Œä»ç£ç›˜ä¸­è¯»å–åˆ°æ•°æ®ï¼Œå®Œæˆäº†æ‰§è¡Œï¼Œå‰©ä¸‹çš„å°±æ˜¯è¿”å›ç»“æœäº†\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 // MVCC pub fn get(\u0026amp;self, key: \u0026amp;[u8]) -\u0026gt; Result\u0026lt;Option\u0026lt;Vec\u0026lt;u8\u0026gt;\u0026gt;\u0026gt; { let mut session = self.engine.lock()?; let from = Key::Version(key.into(), 0).encode()?; let to = Key::Version(key.into(), self.st.version).encode()?; let mut scan = session.scan(from..=to).rev(); while let Some((key, value)) = scan.next().transpose()? { match Key::decode(\u0026amp;key)? { Key::Version(_, version) =\u0026gt; { if self.st.is_visible(version) { return bincode::deserialize(\u0026amp;value); } } key =\u0026gt; return Err(Error::Internal(format!(\u0026#34;Expected Key::Version got {:?}\u0026#34;, key))), }; } Ok(None) } Leaderå›åº”\nå½“å•æœºå­˜å‚¨æ‰§è¡Œå®Œï¼Œå¹¶ä¸”çŠ¶æ€æœºä¹Ÿå‘Leaderå‘é€äº†Message::ClientResponseä¹‹åï¼ŒLeaderå°±ä¼šå°†Message::ClientResponseé€šè¿‡æ¥æ”¶è¯·æ±‚æ—¶ä¸€åŒæ¥å—çš„oneshot channelçš„å‘é€ç«¯ï¼Œå“åº”ç»™Clientï¼ŒClientæ¥æ”¶åˆ°å“åº”ï¼Œå®Œæˆæ‰§è¡Œï¼Œç»§ç»­Executorçš„æ‰§è¡Œã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 Event::ClientResponse { id, mut response } =\u0026gt; { if let Ok(Response::Status(ref mut status)) = response { status.server = self.id; } self.send(Address::Client, Event::ClientResponse { id, response })?; } Some(msg) = node_rx.next() =\u0026gt; { match msg { Message{to: Address::Node(_), ..} =\u0026gt; tcp_tx.send(msg)?, Message{to: Address::Broadcast, ..} =\u0026gt; tcp_tx.send(msg)?, // å“åº”Raft Client Message{to: Address::Client, event: Event::ClientResponse{ id, response }, ..} =\u0026gt; { if let Some(response_tx) = requests.remove(\u0026amp;id) { response_tx .send(response) .map_err(|e| Error::Internal(format!(\u0026#34;Failed to send response {:?}\u0026#34;, e)))?; } } _ =\u0026gt; return Err(Error::Internal(format!(\u0026#34;Unexpected message {:?}\u0026#34;, msg))), } } Write å†åé¢ï¼Œä¼šè°ƒç”¨txn.createå‘é€å†™è¯·æ±‚ï¼Œå¤§è‡´é€»è¾‘å’Œæµç¨‹éƒ½æ˜¯ä¸€æ ·çš„ï¼Œåªä¸è¿‡ç”±äºæ˜¯å†™è¯·æ±‚ï¼Œéœ€è¦é€šè¿‡æ—¥å¿—æ¥è¿›è¡Œå…±è¯†(è¯»è¯·æ±‚çš„ReadIndexä¼˜åŒ–å¯ä»¥ä¸åˆ›å»ºæ—¥å¿—)ï¼Œåœ¨Raftè¡Œä¸ºå’Œä¸çŠ¶æ€æœºä¸Šçš„äº¤äº’ä¼šç•¥æœ‰ä¸åŒï¼Œä½†æ˜¯æ•´ä½“ä¸Šæ˜¯ä¸€è‡´çš„ï¼Œè¿™é‡Œåªç®€å•å†™ä¸€ä¸‹ä¸åŒçš„éƒ¨åˆ†ï¼Œè¯»è€…å¯ä»¥æŒ‰ç…§è¿™ä¸ªæµç¨‹ï¼Œå»è‡ªè¡Œåˆ†æã€‚\nLeader\nåœ¨Leader.step()ä¸­ï¼Œå¦‚æœæ˜¯Request::Mutateç±»å‹çš„è¯·æ±‚ï¼Œå°±ä¼šè°ƒç”¨propose()æ¥åˆ›å»ºæ—¥å¿—å¹¶å‘Followerå»å‘é€æ—¥å¿—ã€‚å¹¶ä¸”å‘çŠ¶æ€æœºä¸­å‘é€ä¸€æ¡Instruction::Notifyç±»å‹çš„ä¿¡æ¯ï¼Œç”¨äºè®°å½•ä¸€æ¬¡å†™è¯·æ±‚çš„å¼€å§‹ï¼š\nFollower\nFolloweræ¥æ”¶åˆ°çš„ä¸ºMessage::AppendEntriesï¼ŒFollowerä¼šæ ¹æ®è‡ªèº«çš„æƒ…å†µï¼Œå†³å®šæ˜¯æ‹’ç»è¿˜æ˜¯å°†æ—¥å¿—è¿½åŠ åˆ°è‡ªèº«ï¼ŒåŒæ—¶å“åº”Leaderã€‚\nLeader\nLeaderæ¥æ”¶åˆ°Followerå“åº”çš„Message::AcceptEntriesæ—¶ï¼Œå°±ä¼šè®¡ç®—æ˜¯å¦æœ‰æ—¥å¿—åœ¨å¤§å¤šæ•°èŠ‚ç‚¹ä¸Šè¾¾åˆ°äº†å¤§å¤šæ•°ï¼Œå°è¯•è¿›è¡Œcommitä¸applyï¼Œå¦‚æœè¾¾åˆ°äº†å¤§å¤šæ•°å°±ä¼šæ›´æ–°commit_indexï¼Œå¹¶ä¸”å‘çŠ¶æ€æœºå‘é€commitäº†çš„log entryã€‚\nçŠ¶æ€æœº\nçŠ¶æ€æœºæ‹¿åˆ°äº†commitäº†çš„log entryï¼Œé¦–å…ˆä¼šé€šè¿‡çŠ¶æ€æœºçš„å®ç°(KV Engine)å»æ‰§è¡Œè¯¥æ¡æ—¥å¿—ï¼Œæ—¥å¿—è¢«æ‰§è¡Œä¼šå¯¼è‡´last_applied_indexè¢«æ›´æ–°ï¼Œä»è€Œä¸€äº›è¯»è¯·æ±‚ä¹Ÿæœ‰å¯èƒ½è¾¾åˆ°æ‰§è¡Œçš„æ¡ä»¶ï¼Œå› æ­¤è°ƒç”¨self.query_execute()æ¥æ‰§è¡Œè¯»è¯·æ±‚ã€‚\næœ€åç§»é™¤è¯·æ±‚è®°å½•ï¼Œé€šçŸ¥Leaderå·²ç»æ‰§è¡Œå®Œæˆã€‚\nLeader\nLeaderå°†ç”±çŠ¶æ€æœºå‘é€è€Œæ¥çš„ClientResponseç»è¿‡å‡ æ¬¡channelé€šä¿¡ï¼Œè½¬å‘ç»™Clientã€‚å›åˆ°Executorä¸­ç»§ç»­æ‰§è¡Œã€‚\nåè®° è‡³æ­¤ï¼Œtoydbçš„æºç åˆ†æå·²ç»å…¨éƒ¨ç»“æŸã€‚èµ·åˆå¼€è¿™ä¸ªç³»åˆ—çš„ä¸»è¦åŸå› æ˜¯è‡ªå·±æƒ³å°è¯•ä½¿ç”¨Rustä½œä¸ºæ¯•ä¸šè®¾è®¡çš„æŠ€æœ¯æ ˆï¼Œç”¨æ¥æ¶è¡¥ä¸€ä¸‹è‡ªå·±çš„Rustã€‚å°±ç›®å‰è€Œè¨€æ„Ÿè§‰æ˜¯å¯ä»¥ç”¨Rustå†™ä¸‹æ¥çš„ï¼Œä¸è‡³äºä¸­é€”é€ƒè·‘åˆ°c++å»ã€‚\ntoydbä»£ç è§„æ¨¡å¾ˆå°ï¼Œå¹¶ä¸”ç»“æ„å¾ˆå®Œå–„ï¼Œå¯ä»¥ä½œä¸ºä¸€ä¸ªå¾ˆå¥½çš„åˆ†å¸ƒå¼æ•°æ®åº“çš„å­¦ä¹ é¡¹ç›®ï¼Œè¾ƒä¸ºç›´è§‚çš„å±•ç¤ºäº†å¦‚ä½•å°†SQLã€åˆ†å¸ƒå¼ã€å­˜å‚¨å¼•æ“ç›¸ç»“åˆï¼Œä»¥åŠå¦‚ä½•ä½¿ç”¨kvå­˜å‚¨å¼•æ“æ¥æ„å»ºå…³ç³»æ¨¡å‹ï¼Œè¿™ä¹Ÿæ˜¯åƒBustubï¼ŒMiniobæ²¡æœ‰èƒ½å¤Ÿåšåˆ°çš„(äºŒè€…å‡æ˜¯heap file)ã€‚\ntoydbä½œä¸ºä¸€ä¸ªå­¦ä¹ é¡¹ç›®ï¼Œæ€§èƒ½ä¸æ˜¯å¾ˆå¥½ï¼Œåç»­å¦‚æœæœ‰æ—¶é—´çš„è¯ï¼Œå¯èƒ½è€ƒè™‘å†è¡¥ä¸€æœŸtoydbçš„æ€§èƒ½åˆ†æçš„æ–‡ç« ï¼Œå¦‚æœæ‡’æˆ–è€…æ²¡æ—¶é—´çš„è¯å°±æ‘¸äº†ã€‚\nåç»­ä¸€æ®µæ—¶é—´å†…ä¼°è®¡åº”è¯¥æ˜¯ä¸ä¼šå†æ›´æ–°è¿™ç§æºç é˜…è¯»ç±»å‹çš„æ–‡ç« äº†ï¼Œå¤§æ¦‚ä¼šå‘ä¸€äº›çœ‹è¿‡çš„paperã€‚å¦‚æœåé¢æ¯•è®¾å†™çš„æ¯”è¾ƒæœ‰æ„æ€çš„è¯ï¼Œä¹Ÿä¼šè€ƒè™‘æŠŠæ¯•è®¾ç»™åˆ†äº«å‡ºæ¥ã€‚\næœ€åï¼Œå¸Œæœ›è¯¥ç³»åˆ—æ–‡ç« èƒ½å¤Ÿå¯¹æƒ³å­¦ä¹ Rustå’Œå…¥é—¨åˆ†å¸ƒå¼æ•°æ®åº“çš„è¯»è€…æœ‰æ‰€å¸®åŠ©ï¼Œç¬”è€…æ°´å¹³æœ‰é™ï¼Œå¦‚æœå‡ºç°é”™è¯¯ï¼Œä¹Ÿå¸Œæœ›è¯»è€…èƒ½å¤Ÿè¿›è¡Œæ‰¹è¯„æŒ‡æ­£ã€‚\n","permalink":"https://fischer0522.github.io/en/posts/tech/toydb/06-sql-execution/","summary":"æœ¬ç³»åˆ—çš„ç¬¬ä¸€ç« 00-Architectureä»¥SQLæ‰§è¡Œæµç¨‹ä¸ºæ•´ä¸ªç³»åˆ—åšäº†ä¸€ä¸ªå¼•å­ï¼Œç›®å‰æœ¬ç³»åˆ—é€šè¿‡å…­ç¯‡æ–‡ç« ï¼Œå·²ç»å°†toydbçš„å„ä¸ªæ¨¡å—éƒ½åˆ†æ","title":"06-SQL Execution"},{"content":"åœ¨å‰é¢çš„å‡ ç« ï¼Œåˆ†åˆ«åˆ†æäº†Bitcaskï¼Œæ„å»ºäºBitcaskä¹‹ä¸Šçš„MVCCï¼ŒRaftï¼Œä»¥åŠRaftçŠ¶æ€æœºã€‚åœ¨æœ¬ç« ä¸­ï¼Œç¬”è€…ä¼šå°†è¿™å‡ ä¸ªæ¨¡å—ç»„åˆèµ·æ¥ï¼Œåˆ†æMVCCæŒä¹…åŒ–å­˜å‚¨ï¼ŒRaftï¼ŒRaftçŠ¶æ€æœºä¹‹é—´å¦‚ä½•äº¤äº’ï¼Œæ¥ä¸ºSQLç®—å­æä¾›æ”¯æŒï¼Œå¤„ç†ä¸€æ¬¡è¯·æ±‚ã€‚\nåœ¨æœ¬ç« ï¼Œç¬”è€…ä¼šé‡ç‚¹ä»‹ç»ä¸¤æ–¹é¢ï¼š\nä¸€æ˜¯SQL Engineçš„ç»„æˆï¼Œä¸ºä¸Šå±‚çš„ç®—å­æä¾›æ”¯æŒäº‹åŠ¡çš„è¯»å†™æ“ä½œ äºŒæ˜¯ Raft é€šä¿¡éƒ¨åˆ†ï¼Œä½œä¸ºåˆ†å¸ƒå¼æ•°æ®åº“ï¼Œæ¶‰åŠåˆ°å„ä¸ªæ¨¡å—ä¹‹é—´çš„é€šä¿¡ï¼Œå…¶ä¸­ä¸€éƒ¨åˆ†æ˜¯åœ¨åŒä¸€èŠ‚ç‚¹ä¸Šä½¿ç”¨ channel å®ç°çš„ï¼Œå¦ä¸€éƒ¨åˆ†æ˜¯è·¨èŠ‚ç‚¹é€šä¿¡ï¼Œé€šè¿‡ tcp å®Œæˆ SQL Engineçš„é€»è¾‘å®šä¹‰åœ¨src/sql/engineå½“ä¸­ã€‚åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼š\nåœ¨mod.rså½“ä¸­ï¼Œå®šä¹‰äº†ä¸€äº›é€šç”¨çš„Traitï¼Œå³å¯¹ä¸Šå±‚æä¾›çš„æ¥å£ã€‚ åœ¨kv.rså½“ä¸­ï¼Œå®šä¹‰äº†ä¸€ä¸ªkv engineï¼Œå¯¹åº•å±‚MVCCè¿›è¡Œå°è£…ï¼Œæ¥æ”¯æŒSQLçš„åŸºç¡€CRUDå’Œäº‹åŠ¡æ“ä½œã€‚ åœ¨raft.rså½“ä¸­ï¼Œå®šä¹‰äº†Raftçš„Clientå’ŒçŠ¶æ€æœºçš„å®ç°ï¼Œä»¥åŠä¸ºRaftå®ç°äº†Transaction Trait åœ¨bustubå’Œminiobå½“ä¸­ï¼Œè¿™ä¸€éƒ¨åˆ†çš„æ¦‚å¿µå¹¶æ²¡æœ‰å¾ˆå‡¸æ˜¾ï¼Œåœ¨SQLç®—å­å½“ä¸­ï¼Œåªéœ€è¦å¯¹heap_fileè¿›è¡Œç®€å•çš„å°è£…ï¼Œå‘ä¸Šæä¾›ä¸€ä¸ªtable_iteratorç”¨äºéå†ï¼Œå’ŒåŸºäºheap_fileçš„æ’å…¥å’Œåˆ é™¤æ¥å£å³å¯ã€‚\ntoydbæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼çš„å…³ç³»å‹æ•°æ®åº“ï¼Œå‘½ä»¤éœ€è¦å…ˆç»è¿‡Raftè¾¾æˆå…±è¯†ï¼Œä¹‹åæ‰èƒ½å¤Ÿæ‰§è¡Œå’Œå­˜å‚¨ã€‚è¿™é‡Œå®šä¹‰çš„SQL Engineï¼Œå°±æ˜¯å±è”½æ‰åº•å±‚çš„æ‰€æœ‰å®ç°ç»†èŠ‚ï¼Œä½¿ä¸Šå±‚ç®—å­èƒ½å¤Ÿåƒæ˜¯ä½¿ç”¨å•æœºçš„å…³ç³»å‹æ•°æ®åº“é‚£ç§å®Œæˆè‡ªèº«çš„é€»è¾‘ã€‚\nExecutorè°ƒç”¨Transaction Traitï¼ŒExecutorå¹¶ä¸ä¼šå»å…³æ³¨å®ç°æ˜¯ä»€ä¹ˆï¼Œä½†æ˜¯è¿™é‡Œçš„å®é™…è°ƒç”¨æ˜¯Raftå¯¹Transaction Traitçš„å®ç°ï¼Œè°ƒç”¨ä¹‹åå°±ä¼šæƒ³ä¸Šé¢æè¿°çš„é‚£æ ·ï¼Œèµ°Raft Clientçš„æµç¨‹ï¼Œå…ˆå…±è¯†åæ‰§è¡Œã€‚ äº‹åŠ¡ä¸æ‰§è¡Œ è¿™ä¸€éƒ¨åˆ†å…±æœ‰ä¸‰ä¸ªtraitï¼ŒEngineç”¨äºå¼€å¯äº‹åŠ¡ï¼ŒTransactionå’ŒCatalogç”¨äºæ‰§è¡Œã€‚ åœ¨src/sql/engine/mod.rså½“ä¸­ï¼Œå®šä¹‰äº†ä¸€ä¸ªTransaction Traitï¼Œåœ¨toydbå½“ä¸­ï¼Œäº‹åŠ¡æ˜¯sqlæ‰§è¡Œçš„åŸºæœ¬å•ä½ã€‚å› æ­¤åœ¨æ•´ä¸ªæ‰§è¡Œæµç¨‹ä¸Šéƒ½éœ€è¦æŒ‰ç…§äº‹åŠ¡çš„æ–¹å¼æ¥æ‰§è¡Œ,Raftå’Œkv engineéƒ½å®ç°äº†Transaction Trait\nTransactionç»§æ‰¿è‡ªCatalog,Catalogå½“ä¸­å°è£…çš„æ˜¯ä¸è¡¨ç»“æ„ç›¸å…³çš„æ“ä½œï¼Œå³DDLï¼ŒTransactionè¡¥å……æ™®é€šçš„æ“ä½œç±»å‹ï¼Œå³DMLã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 pub trait Catalog { /// Creates a new table fn create_table(\u0026amp;mut self, table: Table) -\u0026gt; Result\u0026lt;()\u0026gt;; /// Deletes an existing table, or errors if it does not exist fn delete_table(\u0026amp;mut self, table: \u0026amp;str) -\u0026gt; Result\u0026lt;()\u0026gt;; /// Reads a table, if it exists fn read_table(\u0026amp;self, table: \u0026amp;str) -\u0026gt; Result\u0026lt;Option\u0026lt;Table\u0026gt;\u0026gt;; /// Iterates over all tables fn scan_tables(\u0026amp;self) -\u0026gt; Result\u0026lt;Tables\u0026gt;; /// Reads a table, and errors if it does not exist fn must_read_table(\u0026amp;self, table: \u0026amp;str) -\u0026gt; Result\u0026lt;Table\u0026gt; { self.read_table(table)? .ok_or_else(|| Error::Value(format!(\u0026#34;Table {} does not exist\u0026#34;, table))) } /// Returns all references to a table, as table,column pairs. fn table_references(\u0026amp;self, table: \u0026amp;str, with_self: bool) -\u0026gt; Result\u0026lt;Vec\u0026lt;(String, Vec\u0026lt;String\u0026gt;)\u0026gt;\u0026gt; { Ok(self .scan_tables()? .filter(|t| with_self || t.name != table) .map(|t| { ( t.name, t.columns .iter() .filter(|c| c.references.as_deref() == Some(table)) .map(|c| c.name.clone()) .collect::\u0026lt;Vec\u0026lt;_\u0026gt;\u0026gt;(), ) }) .filter(|(_, cs)| !cs.is_empty()) .collect()) } } pub trait Transaction: Catalog { /// The transaction\u0026#39;s version fn version(\u0026amp;self) -\u0026gt; u64; /// Whether the transaction is read-only fn read_only(\u0026amp;self) -\u0026gt; bool; /// Commits the transaction fn commit(self) -\u0026gt; Result\u0026lt;()\u0026gt;; /// Rolls back the transaction fn rollback(self) -\u0026gt; Result\u0026lt;()\u0026gt;; /// Creates a new table row fn create(\u0026amp;mut self, table: \u0026amp;str, row: Row) -\u0026gt; Result\u0026lt;()\u0026gt;; /// Deletes a table row fn delete(\u0026amp;mut self, table: \u0026amp;str, id: \u0026amp;Value) -\u0026gt; Result\u0026lt;()\u0026gt;; /// Reads a table row, if it exists fn read(\u0026amp;self, table: \u0026amp;str, id: \u0026amp;Value) -\u0026gt; Result\u0026lt;Option\u0026lt;Row\u0026gt;\u0026gt;; /// Reads an index entry, if it exists fn read_index(\u0026amp;self, table: \u0026amp;str, column: \u0026amp;str, value: \u0026amp;Value) -\u0026gt; Result\u0026lt;HashSet\u0026lt;Value\u0026gt;\u0026gt;; /// Scans a table\u0026#39;s rows fn scan(\u0026amp;self, table: \u0026amp;str, filter: Option\u0026lt;Expression\u0026gt;) -\u0026gt; Result\u0026lt;Scan\u0026gt;; /// Scans a column\u0026#39;s index entries fn scan_index(\u0026amp;self, table: \u0026amp;str, column: \u0026amp;str) -\u0026gt; Result\u0026lt;IndexScan\u0026gt;; /// Updates a table row fn update(\u0026amp;mut self, table: \u0026amp;str, id: \u0026amp;Value, row: Row) -\u0026gt; Result\u0026lt;()\u0026gt;; } Engine è¿™é‡Œçš„Engineä¸ä¹‹å‰åœ¨Bitcaskå’ŒMVCCå½“ä¸­æ‰€è¯´çš„engineä¸æ˜¯ä¸€ä¸ªæ¦‚å¿µï¼Œåœ¨å­˜å‚¨æ–¹é¢ï¼ŒengineæŒ‡çš„æ˜¯å­˜å‚¨å¼•æ“ï¼Œè€Œè¿™é‡Œçš„Engineæ˜¯ä¸€ä¸ªSQLå¼•æ“ï¼ŒEngineçš„æœ¬è´¨ä¸Šä¸ºä¸€ä¸ªWrapperï¼Œå¯¹Transactionè¿›è¡ŒåŒ…è£¹ï¼Œæä¾›äº†ä¸‰ç§ç±»å‹çš„beginç”¨äºå¼€å¯äº‹åŠ¡ï¼Œä¸ºåˆ«å¯¹åº”æ™®é€šçš„è¯»å†™äº‹åŠ¡ï¼Œåªè¯»äº‹åŠ¡å’Œtime-travelç±»å‹çš„åªè¯»äº‹åŠ¡ã€‚å¦‚æœæ²¡æœ‰å¼€å¯äº‹åŠ¡ï¼Œå°±è°ƒç”¨Engineå½“ä¸­å®šä¹‰çš„æ–¹æ³•å¼€å¯ä¸€ä¸ªäº‹åŠ¡ï¼Œå½“äº‹åŠ¡å¼€å¯ä¹‹åï¼Œå°±å¯ä»¥è°ƒç”¨Transaction Traitå½“ä¸­çš„å†…å®¹æ¥æ‰§è¡Œäº‹åŠ¡ã€‚\næ­¤å¤–è¿˜æœ‰ä¸€ä¸ªsessionå‡½æ•°ï¼Œç”¨äºè¿”å›ä¸€ä¸ªSessionï¼Œä¸€ä¸ªSessionç”¨äºæ‰§è¡Œä¸€ä¸ªç‹¬ç«‹çš„statements(å³ä¸€æ¡SQLï¼ŒSQLè§£æä¼šç”Ÿæˆä¸€ä¸ªStatement)ã€‚\nEngineä¸ºä¸€ä¸ªTraitï¼Œkvä¸Raftåˆ†åˆ«ç»™å‡ºäº†è‡ªå·±çš„å®ç°\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 pub trait Engine: Clone { /// The transaction type type Transaction: Transaction; /// Begins a read-write transaction. fn begin(\u0026amp;self) -\u0026gt; Result\u0026lt;Self::Transaction\u0026gt;; /// Begins a read-only transaction. fn begin_read_only(\u0026amp;self) -\u0026gt; Result\u0026lt;Self::Transaction\u0026gt;; /// Begins a read-only transaction as of a historical version. fn begin_as_of(\u0026amp;self, version: u64) -\u0026gt; Result\u0026lt;Self::Transaction\u0026gt;; /// Begins a session for executing individual statements fn session(\u0026amp;self) -\u0026gt; Result\u0026lt;Session\u0026lt;Self\u0026gt;\u0026gt; { Ok(Session { engine: self.clone(), txn: None }) } } Session ä¸€ä¸ªSessionå¯¹åº”ä¸€æ¡SQLçš„æ‰§è¡Œï¼Œåœ¨å…¶ä¸­åªæœ‰ä¸¤ä¸ªå­—æ®µï¼Œengineç”¨äºçœŸæ­£æ‰§è¡Œsqlï¼Œtxnä¿å­˜å½“å‰çš„äº‹åŠ¡ï¼š\n1 2 3 4 5 6 pub struct Session\u0026lt;E: Engine\u0026gt; { /// The underlying engine engine: E, /// The current session transaction, if any txn: Option\u0026lt;E::Transaction\u0026gt;, } Sessionåªæœ‰ä¸€ä¸ªæ–¹æ³•execute()ï¼Œè¿™æ˜¯ä¸€æ¡SQLæ‰§è¡Œçš„èµ·å§‹ç‚¹ï¼Œåœ¨å®Œæˆäº†ç½‘ç»œè¿æ¥éƒ¨åˆ†ä¹‹åï¼Œå°±ä¼šè°ƒç”¨åˆ°è¿™é‡Œï¼Œä¼ å…¥æœªè§£æçš„SQLï¼Œåœ¨å…¶ä¸­é¦–å…ˆè¿›è¡Œè§£æï¼Œç”Ÿæˆå¯¹åº”çš„Statementï¼Œä¹‹åæ ¹æ®Statementçš„ç±»å‹å†³å®šå¦‚ä½•æ‰§è¡Œï¼Œå¤§è‡´åˆ†ä¸ºå„ç§ç±»å‹çš„Beginï¼ŒCommit,Rollback,å’Œæ­£å¸¸SQLè¿™å››ç§ç±»å‹ã€‚\nç„¶ååœ¨è¿™å…¶ä¸­ï¼Œä¼šå®ŒæˆÂ Planner â†’ Optimizer â†’ Executorçš„è¿™ä¸ªè¿‡ç¨‹ï¼Œå®ŒæˆSQLæ‰§è¡Œçš„è¿‡ç¨‹,è¿™é‡Œç®€å•åˆ—ä¸¾å‡ ä¸ªï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 pub fn execute(\u0026amp;mut self, query: \u0026amp;str) -\u0026gt; Result\u0026lt;ResultSet\u0026gt; { // FIXME We should match on self.txn as well, but get this error: // error[E0009]: cannot bind by-move and by-ref in the same pattern // ...which seems like an arbitrary compiler limitation match Parser::new(query).parse()? { ast::Statement::Begin { read_only: false, as_of: None } =\u0026gt; { let txn = self.engine.begin()?; let result = ResultSet::Begin { version: txn.version(), read_only: false }; self.txn = Some(txn); Ok(result) } ast::Statement::Commit =\u0026gt; { let txn = self.txn.take().unwrap(); let version = txn.version(); txn.commit()?; Ok(ResultSet::Commit { version }) } ast::Statement::Rollback =\u0026gt; { let txn = self.txn.take().unwrap(); let version = txn.version(); txn.rollback()?; Ok(ResultSet::Rollback { version }) } ast::Statement::Explain(statement) =\u0026gt; self.read_with_txn(|txn| { Ok(ResultSet::Explain(Plan::build(*statement, txn)?.optimize(txn)?.0)) }), statement @ ast::Statement::Select { .. } =\u0026gt; { let mut txn = self.engine.begin_read_only()?; let result = Plan::build(statement, \u0026amp;mut txn)?.optimize(\u0026amp;mut txn)?.execute(\u0026amp;mut txn); txn.rollback()?; result } statement =\u0026gt; { let mut txn = self.engine.begin()?; match Plan::build(statement, \u0026amp;mut txn)?.optimize(\u0026amp;mut txn)?.execute(\u0026amp;mut txn) { Ok(result) =\u0026gt; { txn.commit()?; Ok(result) } Err(error) =\u0026gt; { txn.rollback()?; Err(error) } } } } äº‹åŠ¡å®ç° åœ¨toydbå½“ä¸­ï¼ŒSQLçš„æ‰§è¡Œå•ä½ä¸ºäº‹åŠ¡ï¼Œå³ä¾¿æ˜¯ä¸€æ¡SQLï¼Œä¹Ÿä¼šé»˜è®¤å¼€å¯ä¸€ä¸ªäº‹åŠ¡ï¼ŒSQLçš„æ‰§è¡Œé¦–å…ˆä¼šå»Raftå±‚è¿›è¡Œå…±è¯†ï¼Œè¾¾æˆquorumä¹‹åå†äº¤ç»™åº•å±‚çš„MVCCå»æ‰§è¡Œå’Œå­˜å‚¨ï¼Œå› æ­¤å¯¹äºä¸€ä¸ªäº‹åŠ¡ï¼Œå…¶æ— è®ºæ˜¯beginï¼Œcommitè¿˜æ˜¯æ­£å¸¸çš„sqlæ‰§è¡Œï¼Œéƒ½éœ€è¦å…ˆèµ°raftï¼Œç„¶åå†èµ°MVCCã€‚\né‚£ä¹ˆå¯¹äºäºŒè€…äº‹åŠ¡çš„åŠ¨ä½œï¼Œå°±ä¼šè¿›è¡Œç»Ÿä¸€çš„å®šä¹‰ï¼Œå³ä¸Šé¢ä»‹ç»çš„ä¸‰ä¸ªtraitï¼šTransacionã€Catalogã€Engineã€‚MVCCå’ŒRaftéƒ½ç»™å‡ºäº†è‡ªå·±çš„å®ç°ã€‚\nä»¥beginä¸ºä¾‹ï¼Œè°ƒç”¨beginæ—¶ä¼šå…ˆè°ƒç”¨åˆ°Raftå½“ä¸­å¯¹Transactionä¸­beginçš„å®ç°ï¼Œä¹‹åApplyæ—¶è°ƒç”¨åˆ°MVCCä¸­å¯¹beginçš„å®ç°ï¼Œå®Œæˆä¸€æ¬¡å®Œæ•´çš„è¯·æ±‚ã€‚\nåœ¨æœ¬æ®µä¸­ï¼Œç”±äºRaftä¼šä¾èµ–MVCCï¼Œå› æ­¤ä»¥ä¸€ç§è‡ªåº•å‘ä¸Šçš„æ¨¡å¼ï¼Œå…ˆä»‹ç»MVCCéƒ¨åˆ†ï¼Œä¹‹åå†åˆ†æRaftã€‚åœ¨Raftå½“ä¸­ï¼Œé™¤äº†äº‹åŠ¡ç›¸å…³çš„éƒ¨åˆ†ï¼Œè¿˜æœ‰ä¸Šä¸€ç« é—ç•™çš„çŠ¶æ€æœºå®ç°ï¼Œä¹Ÿä¸€å¹¶åœ¨è¿™é‡Œåˆ†æã€‚\nKV Engine åœ¨kv.rså½“ä¸­ï¼Œä¸»è¦å®šä¹‰äº†ä¸¤éƒ¨åˆ†å†…å®¹ï¼Œé¦–å…ˆæ˜¯ä¸€ä¸ªKVç»“æ„ä½“ï¼Œä¸ºä¸€ä¸ªstorage::mvcc::MVCCçš„Wrapperã€‚è€Œå¦ä¸€éƒ¨åˆ†å°±æ˜¯Transaction Traitçš„å®ç°ã€‚\nKV åœ¨KVå½“ä¸­ï¼Œä¸»è¦åˆ©ç”¨å¸¦æœ‰MVCCé€»è¾‘çš„kvå­˜å‚¨å¼•æ“æ¥å®ç°äº‹åŠ¡çš„åŠŸèƒ½å’Œå­˜å‚¨å…ƒæ•°æ®ï¼Œä¾›raft.rså½“ä¸­çš„æŸäº›å®ç°è°ƒç”¨ï¼Œä¸ºå…¶æä¾›æ”¯æŒã€‚ KVæœ¬èº«æœ‰ä¸‰ä¸ªæ–¹æ³•ï¼š\nresume():é€šè¿‡ä¼ å…¥çš„Stateï¼Œæ¢å¤å‡ºäº‹åŠ¡çš„çŠ¶æ€ï¼Œè¿™é‡Œçš„stateå°±æ˜¯åœ¨02-MVCCå½“ä¸­ä»‹ç»çš„TransactionState get_metadata():å­˜å‚¨å…ƒæ•°æ®ï¼Œä¾›RaftçŠ¶æ€æœºä½¿ç”¨ï¼Œå­˜å‚¨last_applied_index,è°ƒç”¨çš„æ˜¯åº•å±‚çš„ä¸å¸¦ç‰ˆæœ¬çš„kvå­˜å‚¨ set_metadata():å­˜å‚¨å…ƒæ•°æ®ï¼ŒåŒä¸Š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 /// A SQL engine based on an underlying MVCC key/value store. pub struct KV\u0026lt;E: storage::engine::Engine\u0026gt; { /// The underlying key/value store. pub(super) kv: storage::mvcc::MVCC\u0026lt;E\u0026gt;, } impl\u0026lt;E: storage::engine::Engine\u0026gt; KV\u0026lt;E\u0026gt; { /// Creates a new key/value-based SQL engine pub fn new(engine: E) -\u0026gt; Self { Self { kv: storage::mvcc::MVCC::new(engine) } } /// Resumes a transaction from the given state pub fn resume( \u0026amp;self, state: storage::mvcc::TransactionState, ) -\u0026gt; Result\u0026lt;\u0026lt;Self as super::Engine\u0026gt;::Transaction\u0026gt; { Ok(\u0026lt;Self as super::Engine\u0026gt;::Transaction::new(self.kv.resume(state)?)) } /// Fetches an unversioned metadata value pub fn get_metadata(\u0026amp;self, key: \u0026amp;[u8]) -\u0026gt; Result\u0026lt;Option\u0026lt;Vec\u0026lt;u8\u0026gt;\u0026gt;\u0026gt; { self.kv.get_unversioned(key) } /// Sets an unversioned metadata value pub fn set_metadata(\u0026amp;self, key: \u0026amp;[u8], value: Vec\u0026lt;u8\u0026gt;) -\u0026gt; Result\u0026lt;()\u0026gt; { self.kv.set_unversioned(key, value) } } æ­¤å¤–KVè¿˜å®ç°äº†å®šä¹‰åœ¨mod.rså½“ä¸­çš„Engine Traitï¼ŒåŒæ ·ä¹Ÿæ˜¯ç›´æ¥è°ƒç”¨åº•å±‚çš„å¯¹åº”çš„æ–¹æ³•å³å¯ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 impl\u0026lt;E: storage::engine::Engine\u0026gt; super::Engine for KV\u0026lt;E\u0026gt; { type Transaction = Transaction\u0026lt;E\u0026gt;; fn begin(\u0026amp;self) -\u0026gt; Result\u0026lt;Self::Transaction\u0026gt; { Ok(Self::Transaction::new(self.kv.begin()?)) } fn begin_read_only(\u0026amp;self) -\u0026gt; Result\u0026lt;Self::Transaction\u0026gt; { Ok(Self::Transaction::new(self.kv.begin_read_only()?)) } fn begin_as_of(\u0026amp;self, version: u64) -\u0026gt; Result\u0026lt;Self::Transaction\u0026gt; { Ok(Self::Transaction::new(self.kv.begin_as_of(version)?)) } } Transaction å’ŒKVä¸€æ ·ï¼ŒTransactionä¹Ÿæ˜¯ä¸€ä¸ªWrapperï¼Œå…¶ä¸­åªæœ‰ä¸€ä¸ªå­—æ®µï¼Œå°±æ˜¯mvccå½“ä¸­çš„Transactionã€‚ è¿™ä¸€éƒ¨åˆ†çš„é€»è¾‘å°±æ˜¯å…ˆåšä¸€äº›é¢„å¤„ç†ï¼Œå°†åŸæœ¬åªæœ‰get setå’Œbeginç­‰æ–¹æ³•çš„MVCC kvå­˜å‚¨å¼•æ“ï¼Œæ‰©å±•ä¸ºMVCCçš„SQLå­˜å‚¨å¼•æ“ï¼Œæ”¯æŒå»ºè¡¨ï¼Œæ’å…¥åˆ é™¤ä¸€è¡Œæ•°æ®ï¼Œå…¨è¡¨æ‰«æç­‰SQLåŠŸèƒ½\n1 2 3 pub struct Transaction\u0026lt;E: storage::engine::Engine\u0026gt; { txn: storage::mvcc::Transaction\u0026lt;E\u0026gt;, } Transactionçš„å®ç°åˆ†æˆäº†ä¸‰éƒ¨åˆ†ï¼š\nè‡ªèº«å®šä¹‰äº†ä¸€äº›å­˜å‚¨å’ŒåŠ è½½ç´¢å¼•çš„æ“ä½œ å®ç°Transaction traitå’Œ å®ç°Catalog traitã€‚ Index é¦–å…ˆï¼Œtoydbå½“ä¸­çš„ç´¢å¼•æ˜¯éèšç°‡ç´¢å¼• ç”±äºtoydbçš„åº•å±‚æ˜¯KVå­˜å‚¨ï¼Œå› æ­¤å¹¶ä¸èƒ½åƒbustubé‚£æ ·å»åˆ†æ–‡ä»¶å­˜å‚¨ï¼Œtoydbçš„ç´¢å¼•æ ¼å¼ä¸ºï¼š\u0026lt;table + column + key,HashSet\u0026lt;primary_key\u0026gt;\u0026gt;çš„å¤åˆkey-valueã€‚è¿™æ ·ä¾¿å¯ä»¥ä½¿ç”¨kvå­˜å‚¨å¼•æ“æ¥ä¿å­˜ã€‚åœ¨å®ç°ä¸Švalueä½¿ç”¨HashSetä¿å­˜ä¸€ä¸ªè¡¨ä¸­åŒä¸€åˆ—æ‰€æœ‰å€¼ç›¸åŒçš„ä¸»é”®id\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 fn index_save( \u0026amp;mut self, table: \u0026amp;str, column: \u0026amp;str, value: \u0026amp;Value, index: HashSet\u0026lt;Value\u0026gt;, ) -\u0026gt; Result\u0026lt;()\u0026gt; { let key = Key::Index(table.into(), column.into(), value.into()).encode()?; if index.is_empty() { self.txn.delete(\u0026amp;key) } else { self.txn.set(\u0026amp;key, serialize(\u0026amp;index)?) } } Transaction åˆ°å¤„éƒ½æ˜¯Transactionï¼Œè¿™é‡Œçš„Transactionæ˜¯æ„å»ºåœ¨storage::mvccä¹‹ä¸Šï¼Œæ¥å®ç°mod.rså½“ä¸­çš„Transaction Traitã€‚å°†kvé€ ä½œè½¬æ¢ä¸ºåŸºç¡€çš„sqlæ“ä½œï¼Œå¦‚Insertã€Deleteã€SeqScanã€IndexScanç­‰ã€‚æŒ‘å‡ ä¸ªçœ‹ä¸€ä¸‹ï¼š\ncreate\ncreateç”¨äºåœ¨å·²ç»å­˜åœ¨çš„è¡¨å½“ä¸­æ’å…¥ä¸€æ¡æ•°æ®ï¼š\næ ¹æ®table nameè¯»å–å‡ºtableçš„metadata æ ¹æ®metadataæ ¡éªŒæ’å…¥çš„rowï¼Œæ£€éªŒå…¶åœ¨columnä¸Šä¸tableæ˜¯å¦ç¬¦åˆ æ ¹æ®ä¸»é”®idè¿›è¡Œè¯»å–ï¼Œå¦‚æœå­˜åœ¨åˆ™æ”¾å¼ƒæ’å…¥ï¼Œä¸å…è®¸æœ‰primary_keyé‡å¤çš„row è°ƒç”¨åº•å±‚storage::mvccå­˜å‚¨rowï¼Œkeyä¸ºtable + primary_keyï¼Œvalä¸ºrow è°ƒç”¨ä¸Šé¢çš„index_saveï¼Œindex_loadæ›´æ–°ç´¢å¼• 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 fn create(\u0026amp;mut self, table: \u0026amp;str, row: Row) -\u0026gt; Result\u0026lt;()\u0026gt; { // (1) let table = self.must_read_table(table)?; // (2) table.validate_row(\u0026amp;row, self)?; let id = table.get_row_key(\u0026amp;row)?; // (3) if self.read(\u0026amp;table.name, \u0026amp;id)?.is_some() { return Err(Error::Value(format!( \u0026#34;Primary key {} already exists for table {}\u0026#34;, id, table.name ))); } // (4) self.txn.set(\u0026amp;Key::Row((\u0026amp;table.name).into(), (\u0026amp;id).into()).encode()?, serialize(\u0026amp;row)?)?; // (5) Update indexes for (i, column) in table.columns.iter().enumerate().filter(|(_, c)| c.index) { let mut index = self.index_load(\u0026amp;table.name, \u0026amp;column.name, \u0026amp;row[i])?; index.insert(id.clone()); self.index_save(\u0026amp;table.name, \u0026amp;column.name, \u0026amp;row[i], index)?; } Ok(()) } scan\nscanç”¨äºå®ç°ä¸€ä¸ªSeqScan + Filterçš„åŠŸèƒ½(å‡½æ•°å¼ç¼–ç¨‹é­…åŠ›æ—¶åˆ»)ï¼š\né¦–å…ˆæ ¹æ®table nameè¯»å–å‡ºtable metadata åˆ›å»ºä¸€ä¸ªKeyPrefixï¼Œä¼ å…¥table.nameï¼Œè¿™æ ·è¿›è¡Œå‰ç¼€æ‰«æä¼šä»å­˜å‚¨å¼•æ“å½“ä¸­è·å–å‡ºè¯¥tableçš„æ‰€æœ‰çš„keyï¼Œè½¬æ¢ä¸ºè¿­ä»£å™¨ ä½¿ç”¨ä¸€ä¸ªmapæ¥å¤„ç†è¯»å–ç»“æœï¼Œiteréå†è¿”å›çš„æ˜¯ä¸€ä¸ªResult\u0026lt;(Vec\u0026lt;u8\u0026gt;,Vec\u0026lt;u8\u0026gt;),Error\u0026gt;çš„key-valå¯¹ï¼Œå¦‚æœOk()ï¼Œå°±è¯»å–å‡ºvalè¿›è¡Œååºåˆ—åŒ– å¯¹ååºåˆ—åŒ–å¾—åˆ°çš„valueè¿›è¡Œè°“è¯åŒ¹é…ï¼Œæ ¹æ®åŒ¹é…ç»“æœè¿›è¡Œè¿›ä¸€æ­¥çš„å°è£… collectæˆVecï¼Œè½¬æ¢ä¸ºiterå‘ä¸Šè¿”å› 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 fn scan(\u0026amp;self, table: \u0026amp;str, filter: Option\u0026lt;Expression\u0026gt;) -\u0026gt; Result\u0026lt;super::Scan\u0026gt; { let table = self.must_read_table(table)?; Ok(Box::new( self.txn .scan_prefix(\u0026amp;KeyPrefix::Row((\u0026amp;table.name).into()).encode()?)? .iter() .map(|r| r.and_then(|(_, v)| deserialize(\u0026amp;v))) .filter_map(move |r| match r { Ok(row) =\u0026gt; match \u0026amp;filter { Some(filter) =\u0026gt; match filter.evaluate(Some(\u0026amp;row)) { Ok(Value::Boolean(b)) if b =\u0026gt; Some(Ok(row)), Ok(Value::Boolean(_)) | Ok(Value::Null) =\u0026gt; None, Ok(v) =\u0026gt; Some(Err(Error::Value(format!( \u0026#34;Filter returned {}, expected boolean\u0026#34;, v )))), Err(err) =\u0026gt; Some(Err(err)), }, None =\u0026gt; Some(Ok(row)), }, err =\u0026gt; Some(err), }) .collect::\u0026lt;Vec\u0026lt;_\u0026gt;\u0026gt;() .into_iter(), )) } read \u0026amp; read_index\nè¿™ä¸¤ä¸ªçš„å®ç°å·®ä¸å¤šï¼Œéƒ½æ˜¯æ„å»ºå‡ºä¸€ä¸ªkeyï¼Œç„¶åå»å­˜å‚¨å¼•æ“å½“ä¸­è¯»å–ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 fn read(\u0026amp;self, table: \u0026amp;str, id: \u0026amp;Value) -\u0026gt; Result\u0026lt;Option\u0026lt;Row\u0026gt;\u0026gt; { self.txn .get(\u0026amp;Key::Row(table.into(), id.into()).encode()?)? .map(|v| deserialize(\u0026amp;v)) .transpose() } fn read_index(\u0026amp;self, table: \u0026amp;str, column: \u0026amp;str, value: \u0026amp;Value) -\u0026gt; Result\u0026lt;HashSet\u0026lt;Value\u0026gt;\u0026gt; { if !self.must_read_table(table)?.get_column(column)?.index { return Err(Error::Value(format!(\u0026#34;No index on {}.{}\u0026#34;, table, column))); } self.index_load(table, column, value) } å…¶ä»–çš„å—é™äºç¯‡å¹…ï¼Œå°±ä¸åœ¨æœ¬æ–‡å±•å¼€äº†ï¼Œè¯»è€…å¯è‡ªè¡Œé˜…è¯»\nCatalog\nåœ¨Catalogå½“ä¸­ï¼Œå®ç°çš„æ–¹æ³•éƒ½æ˜¯å’Œè¡¨ç»“æ„ç›¸å…³çš„ï¼Œå³DDLï¼Œå¦‚åˆ›å»ºåˆ é™¤è¡¨ç­‰ã€‚æ€»ä½“æ¥è¯´å’ŒTransactioné€»è¾‘å·®ä¸å¤š\ncreate_table\nå’Œcreateå·®ä¸å¤šï¼Œåˆ›å»ºä¸€ä¸ªtableçš„keyï¼Œå­˜åˆ°å­˜å‚¨å¼•æ“å½“ä¸­ï¼Œkeyä¸ºtable.nameï¼Œvalä¸ºtable.metadataã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 pub struct Table { pub name: String, pub columns: Vec\u0026lt;Column\u0026gt;, } fn create_table(\u0026amp;mut self, table: Table) -\u0026gt; Result\u0026lt;()\u0026gt; { if self.read_table(\u0026amp;table.name)?.is_some() { return Err(Error::Value(format!(\u0026#34;Table {} already exists\u0026#34;, table.name))); } table.validate(self)?; self.txn.set(\u0026amp;Key::Table((\u0026amp;table.name).into()).encode()?, serialize(\u0026amp;table)?) } å…¶ä»–çš„éƒ½å·®ä¸å¤šï¼Œå°±ä¸å±•ç¤ºäº†ã€‚\nRaft é™¤äº†Raft Packageä¹‹å¤–ï¼Œå…¶ä»–çš„ä¸Raftç›¸å…³çš„é€»è¾‘éƒ½å®šä¹‰åœ¨src/sql/engine/raft.rså½“ä¸­ï¼Œå¤§è‡´åˆ†ä¸ºï¼š\nRaftçŠ¶æ€æœºçš„å®ç° Raftå¯¹äº‹åŠ¡çš„æ”¯æŒï¼Œä¸ä¸Šé¢KVç›¸å¯¹åº”ï¼ŒåŒ…æ‹¬Transactionã€Catalogå’ŒEngine Raft Clientï¼Œè´Ÿè´£ä¸Raft Serverè¿›è¡Œé€šä¿¡ï¼Œå°†éœ€è¦æ‰§è¡Œçš„å‘½ä»¤å‘é€ç»™Server çŠ¶æ€æœºå®ç° åœ¨ä»‹ç»å®ŒKV Engineçš„å®ç°ä¹‹åï¼Œå¯ä»¥è¡¥å…¨ä¸Šä¸€ç« ç•™ä¸‹çš„RaftçŠ¶æ€æœºçš„å®ç°äº†ã€‚åœ¨ä¸Šä¸€ç« ä¸­ï¼Œè¯´æ˜äº†RaftçŠ¶æ€æœºä¼šä½¿ç”¨Notifyå’ŒQuerysæ¥åˆ†åˆ«ç®¡ç†å†™è¯·æ±‚å’Œåªè¯»è¯·æ±‚ï¼ŒäºŒè€…çš„å¤„ç†æ–¹å¼ä¸ä¸€æ ·ï¼Œå†™è¯·æ±‚éœ€è¦èµ°æ—¥å¿—è¾¾æˆå…±è¯†ï¼Œè€Œè¯»è¯·æ±‚å¯ä»¥ä½¿ç”¨ReadIndexæ¥è¿›è¡Œä¼˜åŒ–ã€‚\nè¯·æ±‚ç±»å‹\nä¸ºäº†åŒºåˆ†è¯»å†™è¯·æ±‚ï¼Œä½¿ç”¨æšä¸¾è¿›è¡Œå®šä¹‰ï¼š é¦–å…ˆåœ¨src/raft/message.rså½“ä¸­ï¼Œå®šä¹‰äº†ä¸€ä¸ªæšä¸¾ï¼Œç”¨äºç¡®å®šRequestçš„ç±»å‹ï¼Œæ˜¯è¯»(Query)è¿˜æ˜¯å†™(Mutate):\n1 2 3 4 5 6 7 /// A client request. #[derive(Clone, Debug, PartialEq, Serialize, Deserialize)] pub enum Request { Query(Vec\u0026lt;u8\u0026gt;), Mutate(Vec\u0026lt;u8\u0026gt;), Status, } åœ¨src/sql/engine/raft.rså½“ä¸­å°†è¯·æ±‚ç±»å‹è¿›è¡Œçš„ç»†åŒ–ï¼Œä½¿ç”¨æšä¸¾æ ¹æ®sqlç®—å­çš„ç±»å‹è¿›è¡Œåˆ†ç±»(ä¹Ÿå¹¶ä¸æ˜¯ä¸SQLç®—å­ä¸€ä¸€å¯¹åº”çš„ï¼Œåªä¸è¿‡æ˜¯ç®—å­æ‰§è¡Œè¿‡ç¨‹ä¸­éœ€è¦çš„æ“ä½œï¼Œä½†æ€»ä½“ä¸Šè¿˜æ˜¯å’ŒSQLè¿˜æ˜¯èƒ½å¯¹çš„ä¸Šå·çš„)ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 enum Query { /// Fetches engine status Status, /// Reads a row Read { txn: TransactionState, table: String, id: Value }, /// Reads an index entry ReadIndex { txn: TransactionState, table: String, column: String, value: Value }, /// Scans a table\u0026#39;s rows Scan { txn: TransactionState, table: String, filter: Option\u0026lt;Expression\u0026gt; }, /// Scans an index ScanIndex { txn: TransactionState, table: String, column: String }, /// Scans the tables ScanTables { txn: TransactionState }, /// Reads a table ReadTable { txn: TransactionState, table: String }, } enum Mutation { /// Begins a transaction Begin { read_only: bool, as_of: Option\u0026lt;u64\u0026gt; }, /// Commits the given transaction Commit(TransactionState), /// Rolls back the given transaction Rollback(TransactionState), /// Creates a new row Create { txn: TransactionState, table: String, row: Row }, /// Deletes a row Delete { txn: TransactionState, table: String, id: Value }, /// Updates a row Update { txn: TransactionState, table: String, id: Value, row: Row }, /// Creates a table CreateTable { txn: TransactionState, schema: Table }, /// Deletes a table DeleteTable { txn: TransactionState, table: String }, } çŠ¶æ€æœº\nçŠ¶æ€æœºå®ç°å®šä¹‰å¦‚ä¸‹ï¼Œå…¶ä¸­æœ‰ä¸¤ä¸ªå­—æ®µï¼Œä¸€ä¸ªæ˜¯åœ¨ä¸Šæ–‡å½“ä¸­ä»‹ç»çš„KV Engineï¼Œç”¨äºæŒä¹…åŒ–å­˜å‚¨æ•°æ®ï¼Œå¦å¤–ä¸€ä¸ªæ˜¯applied_indexï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 pub struct State\u0026lt;E: storage::engine::Engine\u0026gt; { /// The underlying KV SQL engine engine: super::KV\u0026lt;E\u0026gt;, /// The last applied index applied_index: u64, } pub trait State: Send { /// Returns the last applied index from the state machine. fn get_applied_index(\u0026amp;self) -\u0026gt; Index; /// Applies a log entry to the state machine. If it returns Error::Internal, /// the Raft node halts. Any other error is considered applied and returned /// to the caller. /// /// The entry may contain a noop command, which is committed by Raft during /// leader changes. This still needs to be applied to the state machine to /// properly track the applied index, and returns an empty result. /// /// TODO: consider using runtime assertions instead of Error::Internal. fn apply(\u0026amp;mut self, entry: Entry) -\u0026gt; Result\u0026lt;Vec\u0026lt;u8\u0026gt;\u0026gt;; /// Queries the state machine. All errors are propagated to the caller. fn query(\u0026amp;self, command: Vec\u0026lt;u8\u0026gt;) -\u0026gt; Result\u0026lt;Vec\u0026lt;u8\u0026gt;\u0026gt;; } get_applied_indexå®ç°å¾ˆç®€å•ï¼Œç›´æ¥è¿”å›å³å¯\napplyå°†Raftå½“ä¸­commitçš„æ—¥å¿—äº¤ç»™RaftçŠ¶æ€æœºæ¥æ‰§è¡Œï¼Œè¿™é‡Œéœ€è¦Applyçš„ä¸€å®šæ˜¯Mutateç±»å‹çš„ï¼Œåœ¨RaftçŠ¶æ€æœºå½“ä¸­ï¼Œè§£æå‡ºå¯¹åº”çš„å‘½ä»¤ä¹‹åï¼Œæ ¹æ®Mutateçš„å…·ä½“ç±»å‹ï¼Œè°ƒç”¨mutate(\u0026amp;mut self, mutation: Mutation)æ¥æ‰§è¡Œå‘½ä»¤ï¼Œåœ¨è¯¥å‡½æ•°å½“ä¸­ï¼Œæ ¹æ®å‘½ä»¤ç±»å‹æ¥è°ƒç”¨åº•å±‚KV Engineå¯¹åº”çš„å®ç°æ¥æ‰§è¡Œï¼Œä¹‹åä½¿ç”¨set_metadata()æ¥æ›´æ–°last_applied_indexã€‚\nåœ¨02-MVCCå½“ä¸­ï¼Œç•™ä¸‹äº†ä¸€ä¸ªä¼ç¬”ï¼š\nåœ¨æ³¨é‡Šå½“ä¸­ï¼Œå¯¹äºTransactionStateçš„è®¾è®¡ç†å¿µåšäº†æ¯”è¾ƒè¯¦ç»†çš„è¯´æ˜ï¼Œç®€è€Œè¨€ä¹‹å°±æ˜¯ï¼Œäº‹åŠ¡çŠ¶æ€çš„è®¾è®¡ä½¿å¾—äº‹åŠ¡å¯ä»¥åœ¨ä¸åŒçš„ç»„ä»¶ä¹‹é—´å®‰å…¨åœ°ä¼ é€’ï¼Œå¹¶ä¸”å¯ä»¥åœ¨ä¸ç›´æ¥å¼•ç”¨äº‹åŠ¡æœ¬èº«çš„æƒ…å†µä¸‹è¢«å¼•ç”¨ï¼Œæœ‰åŠ©äºç®€åŒ–äº‹åŠ¡ç®¡ç†ã€‚ A Transaction\u0026rsquo;s state, which determines its write version and isolation. It is separate from Transaction to allow it to be passed around independently of the engine. There are two main motivations for this:\nIt can be exported via Transaction.state(), (de)serialized, and later used to instantiate a new functionally equivalent Transaction via Transaction::resume(). This allows passing the transaction between the storage engine and SQL engine (potentially running on a different node) across the Raft state machine boundary. It can be borrowed independently of Engine, allowing references to it in VisibleIterator, which would otherwise result in self-references. åœ¨enum Mutateå½“ä¸­ï¼Œä¼šæºå¸¦ä¸€ä¸ªTransactionStateï¼Œè¿™ä¸ªStateä¼šéšç€å‘½ä»¤è¢«ä¼ é€’ï¼Œåœ¨mutate()å½“ä¸­ï¼Œè·å–åˆ°TransactionStateå°±å¯ä»¥æ¢å¤å‡ºäº‹åŠ¡çš„çŠ¶æ€ï¼Œç„¶åå°±å¯ä»¥ç»§ç»­æ‰§è¡Œè¯¥äº‹åŠ¡ï¼Œå®ç°å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 fn apply(\u0026amp;mut self, entry: Entry) -\u0026gt; Result\u0026lt;Vec\u0026lt;u8\u0026gt;\u0026gt; { assert_eq!(entry.index, self.applied_index + 1, \u0026#34;entry index not after applied index\u0026#34;); let result = match \u0026amp;entry.command { Some(command) =\u0026gt; match self.mutate(bincode::deserialize(command)?) { error @ Err(Error::Internal(_)) =\u0026gt; return error, // don\u0026#39;t record as applied result =\u0026gt; result, }, None =\u0026gt; Ok(Vec::new()), }; self.applied_index = entry.index; self.engine.set_metadata(b\u0026#34;applied_index\u0026#34;, bincode::serialize(\u0026amp;entry.index)?)?; result } fn mutate(\u0026amp;mut self, mutation: Mutation) -\u0026gt; Result\u0026lt;Vec\u0026lt;u8\u0026gt;\u0026gt; { match mutation { // ... // ... // ä½¿ç”¨resumeæ¢å¤å‡ºäº‹åŠ¡çŠ¶æ€ï¼Œç»§ç»­äº‹åŠ¡çš„æ‰§è¡Œ Mutation::CreateTable { txn, schema } =\u0026gt; { bincode::serialize(\u0026amp;self.engine.resume(txn)?.create_table(schema)?) } Mutation::DeleteTable { txn, table } =\u0026gt; { bincode::serialize(\u0026amp;self.engine.resume(txn)?.delete_table(\u0026amp;table)?) } } } Queryä¹Ÿå·®ä¸å¤šï¼Œååºåˆ—åŒ–åè°ƒç”¨KV Engineå½“ä¸­å¯¹åº”çš„å®ç°å³å¯ï¼Œå®Œæˆä¸€æ¡åªè¯»è¯·æ±‚ã€‚\nRaft Client Raft Clientå¹¶ä¸æ˜¯ä¸€ä¸ªç‹¬ç«‹è¿è¡Œçš„Clientï¼Œåªæ˜¯ç”¨äºåœ¨SQLæ‰§è¡Œå‰ï¼Œå°†å¯¹åº”çš„å‘½ä»¤å…ˆå‘é€ç»™Serverå»å…±è¯†ï¼Œä¹‹åå†çœŸå®æ‰§è¡Œï¼Œä¸€æ¬¡å®Œæ•´çš„è¯·æ±‚è¿‡ç¨‹å¦‚ä¸‹ï¼š\nè§£æsqlï¼Œè°ƒç”¨å¯¹åº”çš„sqlç®—å­å¼€å§‹æ‰§è¡Œï¼Œå°†éœ€è¦æ‰§è¡Œçš„å‘½ä»¤é€šè¿‡clientå‘é€ç»™server serverçš„Leaderæ‹¿åˆ°å‘½ä»¤ä¹‹åå¼€å§‹è¿›è¡Œæ—¥å¿—å¤åˆ¶ï¼Œå°è¯•è¾¾æˆå…±è¯† è¾¾æˆå…±è¯†ä¹‹åï¼Œåœ¨RaftçŠ¶æ€æœºè°ƒç”¨Applyæˆ–è€…Queryæ‰§è¡Œå¯¹åº”çš„å‘½ä»¤ Leaderä»çŠ¶æ€æœºå½“ä¸­æ¥æ”¶åˆ°å¯¹åº”çš„æ‰§è¡Œç»“æœï¼Œè¿”å›ç»™Client Client å¤„ç†æ‰§è¡Œç»“æœï¼Œå‘ä¸Šè¿”å›å®Œæˆ SQL çš„æ‰§è¡Œã€‚ åœ¨raft.rså½“ä¸­ï¼Œå®šä¹‰äº†ä¸€ä¸ªClientçš„ç»“æ„ä½“ï¼Œå…¶ä¸­åªæœ‰ä¸€ä¸ªå­—æ®µï¼Œå°±æ˜¯ç”¨æ¥å‘é€è¯·æ±‚çš„channel,é€šè¿‡è¯¥channelï¼Œä¼šå°†è¯·æ±‚å‘é€åˆ°Server Leaderå¤„ï¼Œclient-serverä¹‹é—´æ€æ ·è¿›è¡Œé€šä¿¡çš„ï¼Œä¼šç•™åˆ°åé¢å•ç‹¬åˆ†æã€‚\n1 2 3 4 5 6 7 /// A client for the local Raft node. #[derive(Clone)] struct Client { // è¿™é‡Œçš„txä¸ºraft_txï¼Œraft_serveré‚£è¾¹æ‹¿åˆ°çš„ä¸ºraft_rxï¼Œraft_rxåœ¨Raftæ¨¡å—å½“ä¸­è¢«é‡å‘½åä¸ºclient_tx // æ‰€ä»¥è¿™é‡Œçš„txå¯¹åº”çš„æ˜¯client_tx tx: mpsc::UnboundedSender\u0026lt;(raft::Request, oneshot::Sender\u0026lt;Result\u0026lt;raft::Response\u0026gt;\u0026gt;)\u0026gt;, } åœ¨å®ç°ä¸Šï¼Œå®šä¹‰ä¸€ä¸ªexecute()ç”¨äºæ‰¿æ‹…å‘é€å‘½ä»¤çš„åŠŸèƒ½ï¼Œåœ¨æ­¤ä¹‹ä¸Šåˆ†åˆ«å°è£…mutateå’Œqueryç”¨äºå‘é€è¯»å†™è¯·æ±‚:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 impl Client { /// Creates a new Raft client. fn new( tx: mpsc::UnboundedSender\u0026lt;(raft::Request, oneshot::Sender\u0026lt;Result\u0026lt;raft::Response\u0026gt;\u0026gt;)\u0026gt;, ) -\u0026gt; Self { Self { tx } } /// Executes a request against the Raft cluster. /// æ‰§è¡Œä¸€ä¸ªè¯·æ±‚ï¼Œåˆ›å»ºä¸€ä¸ªä¸€æ¬¡æ€§çš„channelï¼Œå°†channelçš„å‘é€ç«¯äº¤ç»™raft.serverï¼Œraft serverå†å°†request /// å‘é€åˆ°channeldå½“ä¸­ï¼ŒRaft nodeå°±ä¼šå—åˆ°å¯¹åº”çš„Requestï¼Œç„¶ååœ¨æ­¤å¤„é˜»å¡ï¼Œç­‰å¾…Leaderçš„å›åº” fn execute(\u0026amp;self, request: raft::Request) -\u0026gt; Result\u0026lt;raft::Response\u0026gt; { let (response_tx, response_rx) = oneshot::channel(); self.tx.send((request, response_tx))?; futures::executor::block_on(response_rx)? } /// Mutates the Raft state machine, deserializing the response into the /// return type. fn mutate\u0026lt;V: DeserializeOwned\u0026gt;(\u0026amp;self, mutation: Mutation) -\u0026gt; Result\u0026lt;V\u0026gt; { match self.execute(raft::Request::Mutate(bincode::serialize(\u0026amp;mutation)?))? { raft::Response::Mutate(response) =\u0026gt; Ok(bincode::deserialize(\u0026amp;response)?), resp =\u0026gt; Err(Error::Internal(format!(\u0026#34;Unexpected Raft mutation response {:?}\u0026#34;, resp))), } } /// Queries the Raft state machine, deserializing the response into the /// return type. fn query\u0026lt;V: DeserializeOwned\u0026gt;(\u0026amp;self, query: Query) -\u0026gt; Result\u0026lt;V\u0026gt; { match self.execute(raft::Request::Query(bincode::serialize(\u0026amp;query)?))? { raft::Response::Query(response) =\u0026gt; Ok(bincode::deserialize(\u0026amp;response)?), resp =\u0026gt; Err(Error::Internal(format!(\u0026#34;Unexpected Raft query response {:?}\u0026#34;, resp))), } } /// Fetches Raft node status. fn status(\u0026amp;self) -\u0026gt; Result\u0026lt;raft::Status\u0026gt; { match self.execute(raft::Request::Status)? { raft::Response::Status(status) =\u0026gt; Ok(status), resp =\u0026gt; Err(Error::Internal(format!(\u0026#34;Unexpected Raft status response {:?}\u0026#34;, resp))), } } } åœ¨è¿™ä¸€éƒ¨åˆ†ï¼Œå®šä¹‰äº†ä¸€ä¸ªRaftç»“æ„ä½“ï¼Œä½œä¸ºClientçš„Wrapperï¼Œå¹¶ä¸”ä¸ºRaftå®ç°äº†engine traitï¼Œåœ¨åœ°ä½ä¸Šä¸ä¸Šæ–‡çš„KV Engineç›¸åŒï¼Œç”¨äºå¼€å¯ä¸€ä¸ªäº‹åŠ¡ã€‚\n1 2 3 pub struct Raft { client: Client, } Transaction è¿™ä¸€éƒ¨åˆ†å’ŒKV Engineå½“ä¸­çš„Transactionä¸€æ ·ï¼Œéƒ½æ˜¯ä¸€ä¸ªWrapperï¼Œåœ¨KV Engineä¸­ï¼ŒTransactionä½œä¸ºWrapperè°ƒç”¨äº†åº•å±‚MVCCçš„äº‹åŠ¡å®ç°ï¼Œå°†SQLæ“ä½œè½¬æ¢æˆäº†KVæ“ä½œã€‚\nåœ¨Raft Transactionå½“ä¸­ï¼ŒåŒæ ·æ˜¯ä¸€ä¸ªWrapperï¼Œå°è£…æˆå„ç§ç»†åŒ–çš„è¯·æ±‚ç±»å‹é€šè¿‡Clientè¿›è¡Œå‘é€,ç±»å‹å¾ˆå¤šï¼Œä¸ä¸€ä¸€åˆ—ä¸¾äº†ï¼ŒCatalogåŒç†ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 pub struct Transaction { client: Client, state: TransactionState, } impl super::Transaction for Transaction { fn create(\u0026amp;mut self, table: \u0026amp;str, row: Row) -\u0026gt; Result\u0026lt;()\u0026gt; { self.client.mutate(Mutation::Create { txn: self.state.clone(), table: table.to_string(), row, }) } fn delete(\u0026amp;mut self, table: \u0026amp;str, id: \u0026amp;Value) -\u0026gt; Result\u0026lt;()\u0026gt; { self.client.mutate(Mutation::Delete { txn: self.state.clone(), table: table.to_string(), id: id.clone(), }) } fn read(\u0026amp;self, table: \u0026amp;str, id: \u0026amp;Value) -\u0026gt; Result\u0026lt;Option\u0026lt;Row\u0026gt;\u0026gt; { self.client.query(Query::Read { txn: self.state.clone(), table: table.to_string(), id: id.clone(), }) } // ... } è‡³æ­¤ï¼Œsql engineéƒ¨åˆ†çš„å†…å®¹å…¨éƒ¨ä»‹ç»å®Œæ¯•ï¼Œå•è®ºæŸä¸€éƒ¨åˆ†éƒ½å¾ˆç®€å•ï¼Œæ²¡æœ‰ä»€ä¹ˆå¤æ‚çš„é€»è¾‘ï¼Œæ— éæ˜¯å®šä¹‰äº†ä¸€äº›traitï¼Œå’Œä¸¤ä¸ªwrapperï¼Œå°†MVCCå­˜å‚¨å’ŒRaft Clientå°è£…æˆSQLäº‹åŠ¡çš„æ¨¡å¼ã€‚è¿™ä¸€éƒ¨åˆ†æ¯”è¾ƒå¤æ‚çš„æ˜¯å„ä¸ªæ¨¡å—ä¹‹é—´çš„äº¤äº’ï¼Œå’Œä¿¡æ¯ä¼ é€’ã€‚åœ¨æœ¬ç« çš„å‰©ä½™éƒ¨åˆ†ï¼Œç¬”è€…ä¼šé‡ç‚¹ä»‹ç»å„éƒ¨åˆ†ä¹‹é—´æ˜¯å¦‚ä½•è¿›è¡Œé€šä¿¡çš„ã€‚\nå…±è¯†ç²’åº¦ åœ¨toydbå½“ä¸­ï¼Œsql engineçš„åŸºæœ¬å•ä½ä¸ºä¸€æ¡äº‹åŠ¡å‘½ä»¤ï¼Œè¿™é‡Œçš„äº‹åŠ¡å‘½ä»¤æŒ‡çš„æ˜¯åœ¨src/sql/engine/mod.rså½“ä¸­å®šä¹‰çš„Transaction Traitå½“ä¸­çš„å‘½ä»¤ï¼Œå¦‚create,delete,scanç­‰ï¼Œæˆ–è€…è¯´ï¼Œå…±è¯†çš„ç²’åº¦æ˜¯å¯¹å­˜å‚¨å¼•æ“çš„ä¸€æ¬¡æ“ä½œã€‚\nåˆ°äº†sql engineè¿™é‡Œï¼Œå®é™…ä¸Šæ˜¯å·²ç»æ²¡æœ‰çš„SQLçš„æ¦‚å¿µçš„ï¼Œsql engineåªå®ç°äº†Transaction Traitå¹¶å¯¹å¤–æä¾›ï¼Œå› æ­¤å¹¶æ²¡æœ‰é‡‡ç”¨ä¸€æ¡SQLæ¥ä½œä¸ºå…±è¯†çš„å•ä½ã€‚\næ›´é‡è¦çš„æ˜¯ï¼Œç›¸åŒçš„SQLåœ¨ä¸åŒçš„æ—¶åˆ»ï¼Œä¸åŒçš„èŠ‚ç‚¹ä¸Šæ‰§è¡Œï¼Œå¾—åˆ°çš„æ‰§è¡Œè®¡åˆ’ï¼Œæ‰§è¡Œç»“æœéƒ½æœ‰å¯èƒ½æ˜¯ä¸ä¸€æ ·çš„ï¼Œå³æ— æ³•ä¿è¯å¹‚ç­‰æ€§ï¼Œæœ€ç®€å•æ˜¯SELECT NOW()ã€‚ç»è¿‡RaftåŒæ­¥åˆ°ä»èŠ‚ç‚¹ä¸Šæ‰§è¡Œä¼šäº§ç”Ÿæ—¶é—´å·®ï¼Œä»è€Œå¯¼è‡´æ‰§è¡Œç»“æœä¸ä¸€è‡´ã€‚æ­¤å¤–ï¼ŒSQLæœ¬èº«ä¹Ÿå……æ»¡äº†å¤æ‚æ€§åŒ…æ‹¬å¤šè¡¨æŸ¥è¯¢ã€å­æŸ¥è¯¢ã€äº‹åŠ¡åµŒå¥—ç­‰ï¼Œä½¿ç”¨SQLè¿›è¡ŒåŒæ­¥ä¹Ÿä¼šä¸ºç³»ç»Ÿå¼•å…¥é¢å¤–çš„å¤æ‚æ€§ã€‚\nè™½ç„¶æœ¬ç³»åˆ—è¿˜æ²¡æœ‰åˆ†æSQLæ˜¯å¦‚ä½•æ‰§è¡Œçš„ï¼Œè¿™é‡ŒæŒ‘ä¸€ä¸ªæ¯”è¾ƒç®€å•çš„Insertä¸ºä¾‹ï¼Œè¯´æ˜ä¸€ä¸‹toydbå½“ä¸­å…±è¯†çš„ç²’åº¦ï¼š\næ‰§è¡Œinsertæ—¶ï¼Œé¦–å…ˆéœ€è¦è¯»å–å‡ºå½“å‰çš„tableï¼Œè¿™é‡Œè°ƒç”¨äº†txn.must_read_table()ï¼Œä½œä¸ºä¸€æ¡åªè¯»è¯·æ±‚äº¤ç»™Raftå»å½¢æˆå…±è¯† ä¹‹åæ¯æ’å…¥ä¸€è¡Œï¼Œéƒ½ä¼šè°ƒç”¨txn.create()ï¼Œä½œä¸ºä¸€æ¡å†™è¯·æ±‚å‘é€ç»™Raft 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 impl\u0026lt;T: Transaction\u0026gt; Executor\u0026lt;T\u0026gt; for Insert { fn execute(self: Box\u0026lt;Self\u0026gt;, txn: \u0026amp;mut T) -\u0026gt; Result\u0026lt;ResultSet\u0026gt; { let table = txn.must_read_table(\u0026amp;self.table)?; let mut count = 0; for expressions in self.rows { let mut row = expressions.into_iter().map(|expr| expr.evaluate(None)).collect::\u0026lt;Result\u0026lt;_\u0026gt;\u0026gt;()?; if self.columns.is_empty() { row = Self::pad_row(\u0026amp;table, row)?; } else { row = Self::make_row(\u0026amp;table, \u0026amp;self.columns, row)?; } txn.create(\u0026amp;table.name, row)?; count += 1; } Ok(ResultSet::Create { count }) } } é€šä¿¡æ–¹å¼ toydbä½œä¸ºä¸€ä¸ªåˆ†å¸ƒå¼çš„å…³ç³»å‹æ•°æ®åº“ï¼Œç”±äºå¼•å…¥äº†Raftï¼Œä»è€Œå¯¼è‡´å­˜åœ¨å¾ˆå¤šç½‘ç»œé€šä¿¡å’Œä¿¡æ¯äº¤æ¢çš„æ–¹å¼ï¼Œå¤§è‡´ç±»å‹æœ‰ï¼š\næœ€åŸºç¡€çš„Client-Serverä¹‹é—´çš„é€šä¿¡ï¼Œå‘é€sqlä¸æ‰§è¡Œsql Raft Clientä¸Raft Serverä¹‹é—´çš„é€šä¿¡ Raft NodeèŠ‚ç‚¹ä¹‹é—´çš„é€šä¿¡ Raft Nodeä¸RaftçŠ¶æ€æœºä¹‹é—´çš„é€šä¿¡ SQL Client-Server ä½œä¸ºä¸€ä¸ªClient-Serverç»“æ„çš„æ•°æ®åº“ï¼Œæœ€åŸºç¡€çš„é€šä¿¡å°±æ˜¯Clientä¸Serverä¹‹é—´çš„ï¼ŒClientå‘é€sqlï¼ŒServeræ‰§è¡Œsqlã€‚Clientä¸Serveræ˜¾ç„¶ä¸ä¼šåœ¨åŒä¸€å°è®¡ç®—æœºä¸Šè¿è¡Œï¼ŒäºŒè€…ä¹‹é—´æ˜¯ä½¿ç”¨tcpè¿›è¡Œè¿æ¥çš„ã€‚ Clientç«¯ä¸æ˜¯ä¸»è¦çš„å†…å®¹ï¼ŒServerç«¯å°±æ˜¯ç›‘å¬ç«¯å£ï¼Œä¸æ–­è·å–è¯·æ±‚ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªSessionæ¥æ‰§è¡ŒSQL,ä¹‹åå°†ç»“æœè¿”å›ç»™Clientã€‚\nè¿™ä¸€éƒ¨åˆ†çš„é€»è¾‘å®šä¹‰åœ¨src/server.rså½“ä¸­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 /// Serves SQL clients. async fn serve_sql(listener: TcpListener, engine: sql::engine::Raft) -\u0026gt; Result\u0026lt;()\u0026gt; { let mut listener = TcpListenerStream::new(listener); while let Some(socket) = listener.try_next().await? { let peer = socket.peer_addr()?; let session = Session::new(engine.clone())?; tokio::spawn(async move { info!(\u0026#34;Client {} connected\u0026#34;, peer); match session.handle(socket).await { Ok(()) =\u0026gt; info!(\u0026#34;Client {} disconnected\u0026#34;, peer), Err(err) =\u0026gt; error!(\u0026#34;Client {} error: {}\u0026#34;, peer, err), } }); } Ok(()) } Server å‰©ä½™ä¸‰ç§é€šä¿¡éƒ½æ˜¯å±äºServerç«¯çš„å†…éƒ¨é€šä¿¡ï¼Œåœ¨toydbå½“ä¸­ï¼Œé€šè¿‡ä¸€ä¸ªeventloopå¤„ç†äº†æ‰€æœ‰çš„é€šä¿¡ï¼Œåœ¨åˆ›å»ºeventloopæ—¶ï¼Œä¼ å…¥äº†å››ä¸ªchannelï¼š\ntcp_tx:raftèŠ‚ç‚¹ä¹‹é—´ç›¸äº’äº¤æµçš„å‘é€ç«¯ï¼Œç”¨äºå°†åº•å±‚nodeå¡å…¥ä¿¡ç®±å½“ä¸­çš„Messageå‘é€ç»™å…¶ä»–çš„èŠ‚ç‚¹ node_rx:node Messageæ¶ˆæ¯çš„æ¥æ”¶ç«¯ï¼Œç”¨äºä»raftæ¨¡å—å½“ä¸­æ¥æ”¶Messageï¼Œç„¶åäº¤ç»™tcp_txå»å‘é€ï¼ŒåŒæ—¶ä¹Ÿä¼šå¤„ç†çŠ¶æ€æœºå‘é€ç»™Raftæ¨¡å—çš„Messaga tcp_rx:raftèŠ‚ç‚¹ä¹‹é—´ç›¸äº’äº¤æµçš„æ¥æ”¶ç«¯ï¼Œæ¥æ”¶å…¶ä»–èŠ‚ç‚¹ä¼ æ¥çš„Messageï¼Œç„¶åäº¤ç»™è‡ªèº«çš„Raftå»æ‰§è¡Œ client_rx:æ¥æ”¶Raft clientå‘é€çš„Requestï¼Œäº¤ç»™è‡ªèº«çš„Raftå»æ‰§è¡Œï¼Œè¾¾æˆå…±è¯† è¿™ä¸€éƒ¨åˆ†çš„é€»è¾‘ä¸»ä½“æ˜¯é€šè¿‡tokio::select!æ¥å®ç°çš„ï¼Œåœ¨é€»è¾‘ä¸Šä¸goå½“ä¸­çš„selectæ˜¯å·®ä¸å¤šçš„ï¼Œåªä¸è¿‡goçš„selectæ˜¯ç›‘å¬åŒæ­¥channelï¼Œè€Œtokio::select!æ˜¯ç­‰å¾…å¼‚æ­¥ä»»åŠ¡çš„æ‰§è¡Œå®Œæˆï¼Œåˆ†åˆ«ä»ä¸Šè¿°çš„ä¸‰ä¸ªchannelå½“ä¸­è·å–Messageï¼Œæ¨åŠ¨RaftèŠ‚ç‚¹ï¼Œåç»­å…¶ä»–ä¸‰ç§ç±»å‹çš„é€šä¿¡éƒ½ä¼šä¾èµ–äºè¿™ä¸€éƒ¨åˆ†çš„é€»è¾‘ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 loop { tokio::select! { // ç›‘å¬tickerï¼Œé©±åŠ¨ä¸‹å±‚Raftï¼Œé—´éš”ä¸º100ms _ = ticker.tick() =\u0026gt; node = node.tick()?, // è·å–ä»å…¶ä»–raftèŠ‚ç‚¹å‘é€è€Œæ¥çš„Messageï¼Œäº¤ç»™ä¸‹å±‚çš„Raftå»å¤„ç† Some(msg) = tcp_rx.next() =\u0026gt; node = node.step(msg)?, // è·å–ä¸‹å±‚Raftæ”¾å…¥ä¿¡ç®±çš„Messageï¼Œå‘é€ç»™å¯¹åº”çš„èŠ‚ç‚¹ Some(msg) = node_rx.next() =\u0026gt; { match msg { Message{to: Address::Node(_), ..} =\u0026gt; tcp_tx.send(msg)?, Message{to: Address::Broadcast, ..} =\u0026gt; tcp_tx.send(msg)?, Message{to: Address::Client, event: Event::ClientResponse{ id, response }, ..} =\u0026gt; { if let Some(response_tx) = requests.remove(\u0026amp;id) { response_tx .send(response) .map_err(|e| Error::Internal(format!(\u0026#34;Failed to send response {:?}\u0026#34;, e)))?; } } _ =\u0026gt; return Err(Error::Internal(format!(\u0026#34;Unexpected message {:?}\u0026#34;, msg))), } } // è·å–clientå‘é€çš„æ¶ˆæ¯ï¼Œäº¤ç»™Raftæ¨¡å—å»å¤„ç†ï¼Œè¿™é‡Œçš„clientå¹¶ä¸æ˜¯ç”¨æˆ·çš„clientï¼Œè€Œæ˜¯è¦æ‰§è¡Œå‘½ä»¤çš„sqlç«¯ Some((request, response_tx)) = client_rx.next() =\u0026gt; { let id = Uuid::new_v4().as_bytes().to_vec(); let msg = Message{ from: Address::Client, to: Address::Node(node.id()), term: 0, event: Event::ClientRequest{id: id.clone(), request}, }; node = node.step(msg)?; requests.insert(id, response_tx); } } } Raft Client-Server Client Raft Clientçš„å®šä¹‰åœ¨src/sql/engine/raft.rså½“ä¸­Clientå½“ä¸­åªæœ‰ä¸€ä¸ªå­—æ®µtxï¼Œä¸ºä¸€ä¸ªæ¶ˆæ¯ç±»å‹ä¸º(raft::Request, oneshot::Sender\u0026lt;Result\u0026lt;raft::Response\u0026gt;)çš„channelå‘é€ç«¯ï¼Œä½¿ç”¨è¿™ä¸ªç»™Raft Serverå‘é€æ¶ˆæ¯ã€‚\ntxçš„æ¥æºä¸ºåœ¨Server.serve()ä¸­åˆ›å»º:\nraft_txä¸ºraft client-serverä¹‹é—´æ¶ˆæ¯çš„å‘é€ç«¯ï¼Œäº¤ç»™sql engineå»å‘é€ raft_rxä¸ºraft client-serverä¹‹é—´æ¶ˆæ¯çš„æ¥æ”¶ç«¯ï¼Œäº¤ç»™raft serverå»æ¥æ”¶,raft_rxåœ¨serverç«¯è¢«é‡å‘½åä¸ºclient_rxã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 struct Client { // è¿™é‡Œçš„txä¸ºraft_txï¼Œraft_serveré‚£è¾¹æ‹¿åˆ°çš„ä¸ºraft_rxï¼Œraft_rxåœ¨Raftæ¨¡å—å½“ä¸­è¢«é‡å‘½åä¸ºclient_rx // æ‰€ä»¥è¿™é‡Œçš„txå¯¹åº”çš„æ˜¯client_tx tx: mpsc::UnboundedSender\u0026lt;(raft::Request, oneshot::Sender\u0026lt;Result\u0026lt;raft::Response\u0026gt;\u0026gt;)\u0026gt;, } pub async fn serve(self) -\u0026gt; Result\u0026lt;()\u0026gt; { // listener // ... // raft_txä¸ºraft client-serverä¹‹é—´æ¶ˆæ¯çš„å‘é€ç«¯ï¼Œäº¤ç»™sql_engineå»å‘é€ // raft_rxä¸ºraft client-serverä¹‹é—´æ¶ˆæ¯çš„æ¥æ”¶ç«¯ï¼Œäº¤ç»™raft serverå»æ”¶ let (raft_tx, raft_rx) = mpsc::unbounded_channel(); let sql_engine = sql::engine::Raft::new(raft_tx); tokio::try_join!( self.raft.serve(raft_listener, raft_rx), Self::serve_sql(sql_listener, sql_engine), )?; Ok(()) } è¯»å†™è¯·æ±‚éƒ½ä¼šè°ƒç”¨execute()æ¥å‘Raft Serverå»é€šä¿¡ã€‚åœ¨execute()å½“ä¸­ï¼Œä¼šè°ƒç”¨oneshot::channel()åˆ›å»ºä¸€ä¸ªä¸€æ¬¡æ€§çš„channelï¼Œå°†channelçš„æ¶ˆæ¯å‘é€ç«¯response_txå’Œrequestä¸€åŒå‘é€ç»™Raft Serverã€‚\nServeræ¥æ”¶å¹¶æ‰§è¡Œå®Œä¹‹åï¼Œä¼šä½¿ç”¨ä¼ è¿‡å»çš„å‘é€ç«¯å†å°†å“åº”å‘é€å›æ¥ï¼ŒClientç­‰å¾…ä»æ¥æ”¶ç«¯è·å–æ¶ˆæ¯ï¼Œæ‹¿åˆ°Raft Serverå¯¹requestçš„æ‰§è¡Œç»“æœå‘ä¸Šè¿”å›ã€‚æ­¤æ—¶ï¼Œåˆ›å»ºçš„oneshot channelå°±å¯ä»¥é”€æ¯äº†ã€‚\nServer\næ¥æ”¶ï¼š\nServerç«¯çš„æ¥æ”¶é€»è¾‘å°±åœ¨ä¸Šé¢æ‰€è¯´çš„eventloopå½“ä¸­ï¼Œä»client_rx(ä¸Šé¢ä¼ æ¥çš„raft_rx)æ¥æ”¶åˆ°Clientå‘é€çš„requestå’Œresponse_txã€‚\nç”±äºè¯·æ±‚éœ€è¦å…ˆé€šè¿‡Raftå®Œæˆå…±è¯†ï¼Œä¹‹åApplyäº†æ‰èƒ½å¤Ÿæ‰§è¡Œï¼Œè¿™é‡Œå…ˆä½¿ç”¨ä¸€ä¸ªHashMapä¿å­˜è¯·æ±‚ï¼Œç­‰åˆ°Applyå¹¶æ‰§è¡Œå®Œä¹‹åå†ä»HashMapä¸­è·å–å‡ºæš‚å­˜çš„response_rxï¼Œå†å“åº”Clientã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 // è·å–clientå‘é€çš„æ¶ˆæ¯ï¼Œäº¤ç»™Raftæ¨¡å—å»å¤„ç†ï¼Œè¿™é‡Œçš„clientå¹¶ä¸æ˜¯ç”¨æˆ·çš„clientï¼Œè€Œæ˜¯è¦æ‰§è¡Œå‘½ä»¤çš„sqlç«¯ // æš‚å­˜å‘½ä»¤ï¼Œç­‰åˆ°æ—¥å¿—Applyå¹¶æ‰§è¡Œå®Œä¹‹åå†å“åº”å®¢æˆ·ç«¯ Some((request, response_tx)) = client_rx.next() =\u0026gt; { let id = Uuid::new_v4().as_bytes().to_vec(); let msg = Message{ from: Address::Client, to: Address::Node(node.id()), term: 0, event: Event::ClientRequest{id: id.clone(), request}, }; node = node.step(msg)?; requests.insert(id, response_tx); } å‘é€ï¼š\nåœ¨RaftçŠ¶æ€æœºå½“ä¸­ï¼Œå½“è¯·æ±‚Applyæ—¶ï¼Œå°±ä¼šå‘é€ä¸€æ¡æ¶ˆæ¯ç»™Raft Leader Nodeï¼Œå†™è¯·æ±‚é€šè¿‡notify_applied()ï¼Œè¯»è¯·æ±‚é€šè¿‡query_execute()ï¼Œé€šçŸ¥Leaderç›®å‰è¯¥å‘½ä»¤å·²ç»Applyï¼Œå¹¶ä¸”æ‰§è¡Œå®Œæˆï¼Œå¯ä»¥å“åº”Clientäº†,è¿™ä¸€éƒ¨åˆ†çš„é€»è¾‘å®šä¹‰åœ¨src/raft/state.rsä¸­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 pub fn apply(\u0026amp;mut self, state: \u0026amp;mut dyn State, entry: Entry) -\u0026gt; Result\u0026lt;Index\u0026gt; { // Apply the command. debug!(\u0026#34;Applying {:?}\u0026#34;, entry); match state.apply(entry) { Err(error @ Error::Internal(_)) =\u0026gt; return Err(error), result =\u0026gt; self.notify_applied(state.get_applied_index(), result)?, }; // Try to execute any pending queries, since they may have been submitted for a // commit_index which hadn\u0026#39;t been applied yet. self.query_execute(state)?; Ok(state.get_applied_index()) } /// Notifies a client about an applied log entry, if any. fn notify_applied(\u0026amp;mut self, index: Index, result: Result\u0026lt;Vec\u0026lt;u8\u0026gt;\u0026gt;) -\u0026gt; Result\u0026lt;()\u0026gt; { if let Some((to, id)) = self.notify.remove(\u0026amp;index) { self.send(to, Event::ClientResponse { id, response: result.map(Response::Mutate) })?; } Ok(()) } /// Executes any queries that are ready. fn query_execute(\u0026amp;mut self, state: \u0026amp;mut dyn State) -\u0026gt; Result\u0026lt;()\u0026gt; { for query in self.query_ready(state.get_applied_index()) { debug!(\u0026#34;Executing query {:?}\u0026#34;, query.command); let result = state.query(query.command); if let Err(error @ Error::Internal(_)) = result { return Err(error); } self.send( query.address, Event::ClientResponse { id: query.id, response: result.map(Response::Query) }, )? } Ok(()) } å½“Leaderæ¥æ”¶åˆ°äº†Event::ClientResponseä¹‹åï¼Œä¸ä¼šåšé¢å¤–å¤„ç†ï¼Œè®¾ç½®æ¥æ”¶ç«¯çš„åœ°å€ä¸ºClientï¼Œç›´æ¥å‘é€å¡å…¥åˆ°ä¿¡ç®±(node_tx)ï¼Œäº¤ç»™ä¸Šå±‚Serverå»å‘é€ï¼Œè¿™ä¸€éƒ¨åˆ†çš„é€»è¾‘å®šä¹‰åœ¨src/raft/leader.rsä¸­ï¼š\n1 2 3 4 5 6 Event::ClientResponse { id, mut response } =\u0026gt; { if let Ok(Response::Status(ref mut status)) = response { status.server = self.id; } self.send(Address::Client, Event::ClientResponse { id, response })?; } Messageå¡å…¥åˆ°node_txä¸­ï¼Œè‡ªç„¶å°±ä¼šåœ¨Serverä¸­è¢«node_rxæ¥æ”¶åˆ°ï¼Œæ ¹æ®å‘é€ç«¯åˆ°åœ°å€åŒ¹é…å¤„ç†ï¼Œå¦‚æœæ˜¯Address::Client,é‚£ä¹ˆå°±è·å–å¹¶åˆ é™¤å½“æ—¶å­˜å…¥çš„é‚£ä¸ªresponse_txï¼Œé€šè¿‡response_txå°†æ‰§è¡Œç»“æœå‘é€ç»™Raft Clientã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 // è·å–ä¸‹å±‚Raftæ”¾å…¥ä¿¡ç®±çš„Messageï¼Œå‘é€ç»™å¯¹åº”çš„èŠ‚ç‚¹ Some(msg) = node_rx.next() =\u0026gt; { match msg { Message{to: Address::Node(_), ..} =\u0026gt; tcp_tx.send(msg)?, Message{to: Address::Broadcast, ..} =\u0026gt; tcp_tx.send(msg)?, Message{to: Address::Client, event: Event::ClientResponse{ id, response }, ..} =\u0026gt; { if let Some(response_tx) = requests.remove(\u0026amp;id) { response_tx .send(response) .map_err(|e| Error::Internal(format!(\u0026#34;Failed to send response {:?}\u0026#34;, e)))?; } } _ =\u0026gt; return Err(Error::Internal(format!(\u0026#34;Unexpected message {:?}\u0026#34;, msg))), } } è‡³æ­¤ï¼ŒRaft Client-Serverå®Œæˆäº†ä¸€æ¬¡å®Œæ•´çš„é€šä¿¡è¿‡ç¨‹ã€‚\nRaft Node è¿™ä¸€éƒ¨åˆ†æ˜¯Raftæ¨¡å—ä¸­å„ä¸ªèŠ‚ç‚¹ä¹‹é—´çš„é€šä¿¡ï¼Œå¯¹åº”6.824å½“ä¸­çš„ç›´æ¥è°ƒç”¨AppendEntries,RequsetVoteRPCçš„è¿‡ç¨‹ï¼Œåªä¸è¿‡åœ¨toydbä¸­ä½¿ç”¨Messageå¤„ç†ä¿¡æ¯äº¤æ¢ï¼Œå› æ­¤å°±æ˜¯å‘é€Messageã€‚\nRaftèŠ‚ç‚¹å¦‚æœéœ€è¦å‘é€ä¸€æ¡Messageï¼Œé‚£ä¹ˆå°±è°ƒç”¨sendï¼Œå°†å…¶å¡å…¥åˆ°node_txå½“ä¸­ï¼Œäº¤ç»™Serverå»å‘é€ï¼Œæ¯”å¦‚è¿›è¡Œheartbeatæ—¶ï¼Œå°±ä¼ å…¥ä¸€ä¸ªæ¥æ”¶åœ°å€ä¸ºAddress::Broadcastï¼Œæ¶ˆæ¯ç±»å‹ä¸ºEvent::Heartbeatçš„Messageï¼Œè¡¨ç¤ºè¦å°†å¿ƒè·³ä¿¡æ¯è¿›è¡Œå¹¿æ’­\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 /// Broadcasts a heartbeat to all peers. pub(super) fn heartbeat(\u0026amp;mut self) -\u0026gt; Result\u0026lt;()\u0026gt; { let (commit_index, commit_term) = self.log.get_commit_index(); self.send(Address::Broadcast, Event::Heartbeat { commit_index, commit_term })?; // NB: We don\u0026#39;t reset self.since_heartbeat here, because we want to send // periodic heartbeats regardless of any on-demand heartbeats. Ok(()) } /// Sends an event fn send(\u0026amp;self, to: Address, event: Event) -\u0026gt; Result\u0026lt;()\u0026gt; { let msg = Message { term: self.term, from: Address::Node(self.id), to, event }; debug!(\u0026#34;Sending {:?}\u0026#34;, msg); Ok(self.node_tx.send(msg)?) } è¿™ä¸€éƒ¨åˆ†çš„å‘é€é€»è¾‘å’Œä¸Šé¢æœ‰äº›é‡åˆï¼ŒåŒæ ·æ˜¯åœ¨eventloopä¸­ä»node_rxè·å–Messageï¼Œå†æŠŠMessageä¼ å…¥åˆ°tcp_txä¸­ï¼Œå‡†å¤‡è¿›è¡Œå‘é€ã€‚\nå’Œeventloopä¸€åŒå¯åŠ¨çš„è¿˜æœ‰ä¸€ä¸ªtcp_senderçš„task,åœ¨å…¶ä¸­ï¼Œåˆå°†Messageç»å†äº†ä¸€æ¬¡åœ¨channelä¸­çš„å‘é€å’Œæ¥æ”¶ï¼Œæœ€ç»ˆè°ƒç”¨åˆ°tcp_send_peer(),å°†Messageé€šè¿‡tcpå‘é€ç»™å¯¹åº”çš„Raft Node\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 async fn tcp_send( peers: HashMap\u0026lt;NodeID, String\u0026gt;, out_rx: mpsc::UnboundedReceiver\u0026lt;Message\u0026gt;, ) -\u0026gt; Result\u0026lt;()\u0026gt; { let mut out_rx = UnboundedReceiverStream::new(out_rx); let mut peer_txs: HashMap\u0026lt;NodeID, mpsc::Sender\u0026lt;Message\u0026gt;\u0026gt; = HashMap::new(); for (id, addr) in peers.into_iter() { let (tx, rx) = mpsc::channel::\u0026lt;Message\u0026gt;(1000); peer_txs.insert(id, tx); tokio::spawn(Self::tcp_send_peer(addr, rx)); } while let Some(message) = out_rx.next().await { let to = match message.to { Address::Broadcast =\u0026gt; peer_txs.keys().copied().collect(), Address::Node(peer) =\u0026gt; vec![peer], addr =\u0026gt; { error!(\u0026#34;Received outbound message for non-TCP address {:?}\u0026#34;, addr); continue; } }; for id in to { match peer_txs.get_mut(\u0026amp;id) { Some(tx) =\u0026gt; match tx.try_send(message.clone()) { Ok(()) =\u0026gt; {} Err(mpsc::error::TrySendError::Full(_)) =\u0026gt; { debug!(\u0026#34;Full send buffer for peer {}, discarding message\u0026#34;, id) } Err(error) =\u0026gt; return Err(error.into()), }, None =\u0026gt; error!(\u0026#34;Received outbound message for unknown peer {}\u0026#34;, id), } } } Ok(()) } /// Sends outbound messages to a peer, continuously reconnecting. async fn tcp_send_peer(addr: String, out_rx: mpsc::Receiver\u0026lt;Message\u0026gt;) { let mut out_rx = ReceiverStream::new(out_rx); loop { match TcpStream::connect(\u0026amp;addr).await { Ok(socket) =\u0026gt; { debug!(\u0026#34;Connected to Raft peer {}\u0026#34;, addr); match Self::tcp_send_peer_session(socket, \u0026amp;mut out_rx).await { Ok(()) =\u0026gt; break, Err(err) =\u0026gt; error!(\u0026#34;Failed sending to Raft peer {}: {}\u0026#34;, addr, err), } } Err(err) =\u0026gt; error!(\u0026#34;Failed connecting to Raft peer {}: {}\u0026#34;, addr, err), } tokio::time::sleep(Duration::from_millis(1000)).await; } debug!(\u0026#34;Disconnected from Raft peer {}\u0026#34;, addr); } Raft Node \u0026amp; State Machine RaftèŠ‚ç‚¹ä¸çŠ¶æ€æœºä¹‹é—´æ˜¯é€šè¿‡state_rxï¼Œstate_txï¼Œnode_tx,node_rxè¿›è¡Œäº¤äº’çš„:\nRaftèŠ‚ç‚¹é€šè¿‡state_txä¸­å‘çŠ¶æ€æœºå‘é€Instructionï¼Œä»node_rxä¸­æ¥æ”¶çŠ¶æ€æœºå‘é€çš„Message RaftçŠ¶æ€æœºä»state_rxä¸­æ¥æ”¶RaftèŠ‚ç‚¹å‘é€çš„Instructionï¼Œé€šè¿‡node_txå‘RaftèŠ‚ç‚¹å‘é€Messageï¼ŒçŠ¶æ€æœºã€‚é€šè¿‡node_txå‘é€çš„æ¶ˆæ¯æœ€åä¼šå’Œå…¶ä»–çš„Messageä¸€æ ·ï¼Œèµ°ä¸€étcpçš„æµç¨‹ï¼Œæœ€ååˆä¼ åˆ°çš„å½“å‰çš„èŠ‚ç‚¹ï¼Œç„¶åè°ƒç”¨step()äº¤ç»™Leader RaftèŠ‚ç‚¹å‘é€ä¸æ¥æ”¶ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 // RaftèŠ‚ç‚¹å‘é€ï¼šcommitæ—¶é€šè¿‡state_txå‘çŠ¶æ€æœºå‘é€Instruction fn maybe_commit(\u0026amp;mut self) -\u0026gt; Result\u0026lt;Index\u0026gt; { // ... // ... if commit_index \u0026gt; prev_commit_index { self.log.commit(commit_index)?; // TODO: Move application elsewhere, but needs access to applied index. let mut scan = self.log.scan((prev_commit_index + 1)..=commit_index)?; while let Some(entry) = scan.next().transpose()? { self.state_tx.send(Instruction::Apply { entry })?; } } } // RaftèŠ‚ç‚¹æ¥æ”¶ï¼šæ¥æ”¶çŠ¶æ€æœºå‘é€çš„Messageï¼Œèµ°ä¸€étcpå‘é€å›å½“å‰èŠ‚ç‚¹ï¼Œè°ƒç”¨stepå»å¤„ç† Some(msg) = node_rx.next() =\u0026gt; { match msg { Message{to: Address::Node(_), ..} =\u0026gt; tcp_tx.send(msg)?, Message{to: Address::Broadcast, ..} =\u0026gt; tcp_tx.send(msg)?, Message{to: Address::Client, event: Event::ClientResponse{ id, response }, ..} =\u0026gt; { if let Some(response_tx) = requests.remove(\u0026amp;id) { response_tx .send(response) .map_err(|e| Error::Internal(format!(\u0026#34;Failed to send response {:?}\u0026#34;, e)))?; } } _ =\u0026gt; return Err(Error::Internal(format!(\u0026#34;Unexpected message {:?}\u0026#34;, msg))), } } çŠ¶æ€æœºå‘é€ä¸æ¥æ”¶ï¼š\nçŠ¶æ€æœºæ˜¯é€šè¿‡Driver.drive()è¿›è¡Œé©±åŠ¨çš„ï¼Œä¼šä¸æ–­åœ°ä»state_rxä¸­è·å–RaftèŠ‚ç‚¹å‘é€è€Œæ¥çš„Instructionï¼Œç„¶åè¿›è¡Œæ‰§è¡Œ,å‘é€é€»è¾‘åœ¨ä¹‹å‰ä»‹ç»è¿‡äº†ï¼Œä¼ å…¥åˆ°node_txä¸­å³å¯ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 // çŠ¶æ€æœºæ¥æ”¶ï¼š /// Drives a state machine. pub async fn drive(mut self, mut state: Box\u0026lt;dyn State\u0026gt;) -\u0026gt; Result\u0026lt;()\u0026gt; { debug!(\u0026#34;Starting state machine driver at applied index {}\u0026#34;, state.get_applied_index()); while let Some(instruction) = self.state_rx.next().await { if let Err(error) = self.execute(instruction, \u0026amp;mut *state) { error!(\u0026#34;Halting state machine due to error: {}\u0026#34;, error); return Err(error); } } debug!(\u0026#34;Stopping state machine driver\u0026#34;); Ok(()) } // çŠ¶æ€æœºå‘é€ï¼š fn send(\u0026amp;self, to: Address, event: Event) -\u0026gt; Result\u0026lt;()\u0026gt; { // TODO: This needs to use the correct term. let msg = Message { from: Address::Node(self.node_id), to, term: 0, event }; debug!(\u0026#34;Sending {:?}\u0026#34;, msg); Ok(self.node_tx.send(msg)?) } å°ç»“ åœ¨è¿™ä¸€éƒ¨åˆ†ï¼Œä¸»è¦å®Œæˆäº†ä¸€ä¸ªç»„è£…çš„è¿‡ç¨‹ï¼Œå°†MVCCå­˜å‚¨å¼•æ“ä¸Raftç»“åˆï¼Œä¸ºSQLçš„æ‰§è¡Œæä¾›æ”¯æŒã€‚åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œåœ¨ç®—å­ä¸­è°ƒç”¨æä¾›çš„Transactionæ¥å£ï¼Œå°±ä¼šå…ˆé€šè¿‡Raft Clientå°†è¯·æ±‚å‘é€ç»™Raft Serverï¼Œç­‰å¾…Applyä¹‹åå†è°ƒç”¨MVCCå­˜å‚¨å¼•æ“å»æ‰§è¡Œï¼Œæœ€åä¾æ¬¡å“åº”ï¼Œè¿”å›åˆ°ç®—å­å½“ä¸­ã€‚ç»“æŸä¸€æ¬¡æ‰§è¡Œã€‚\né™¤æ­¤ä¹‹å¤–ï¼Œè¡¥å…¨äº†RaftçŠ¶æ€æœºçš„å®ç°å’ŒèŠ‚ç‚¹é—´çš„é€šä¿¡è¿™ä¸€éƒ¨åˆ†æ¶‰åŠåˆ°å¤šä¸ªchannelå’Œtcpé€šä¿¡ï¼ŒåŒä¸€èŠ‚ç‚¹ä¸Šçš„å‘½ä»¤å¯ä»¥ä½¿ç”¨channelå‘é€ï¼Œä¸åŒèŠ‚ç‚¹ä¹‹é—´ä½¿ç”¨tcpå‘é€ï¼Œè™½ç„¶æ²¡æœ‰ç›´æ¥è°ƒç”¨rpcç›´è§‚ï¼Œä½†æ˜¯ç»“æ„ä¸Šæ›´åŠ æ¸…æ™°ï¼Œæ˜“äºç®¡ç†ã€‚\n","permalink":"https://fischer0522.github.io/en/posts/tech/toydb/05-sql-engine/","summary":"åœ¨å‰é¢çš„å‡ ç« ï¼Œåˆ†åˆ«åˆ†æäº†Bitcaskï¼Œæ„å»ºäºBitcaskä¹‹ä¸Šçš„MVCCï¼ŒRaftï¼Œä»¥åŠRaftçŠ¶æ€æœºã€‚åœ¨æœ¬ç« ä¸­ï¼Œç¬”è€…ä¼šå°†è¿™å‡ ä¸ªæ¨¡å—ç»„åˆèµ·","title":"05-SQL Engine"},{"content":"ä»Šå¤©æ˜¯2023å¹´çš„æœ€åä¸€å¤©ï¼Œå¤§æ¦‚åŠä¸ªæœˆå‰å°±èŒç”Ÿäº†å†™ä¸€ç¯‡å¹´åº¦æ€»ç»“çš„æƒ³æ³•ï¼Œä¸è¿‡ä¸€ç›´å› ä¸ºä¸€äº›å…¶ä»–çš„äº‹æƒ…æ‹–åˆ°äº†æœ€åä¸€å¤©ï¼Œç°åœ¨çœ‹å¤§æ¦‚æ˜¯å†™ä¸å®Œäº†ã€‚é‰´äºæˆ‘çš„æœ¬ç§‘ä¹Ÿè¿›å…¥äº†æœ€åçš„å€’è®¡æ—¶ï¼Œå› æ­¤ä¸€å¹¶å›é¡¾ä¸€ä¸‹è¿™å¿™å¿™ç¢Œç¢Œçš„ä¸‰å¹´ã€‚å¸Œæœ›åœ¨å®Œæˆå¯¹2023çš„æ€»ç»“åï¼Œèƒ½å¯¹å³å°†åˆ°æ¥çš„2024æœ‰ä¸€ç‚¹å¤´ç»ªã€‚\nè¿·èŒ«ï¼Œä»¥åŠè‡ªæ•‘ä¹‹è·¯ é«˜è€ƒç»“æŸä¹‹æ—¶ï¼Œå¸¦ç€ä¸€ç§è€ƒè´¥æ¥çŸ¿çš„å¿ƒæ€ï¼Œå¼€å¯äº†æˆ‘çš„å¤§å­¦ç”Ÿæ´»ï¼Œè‡ªè¸å…¥æ ¡é—¨çš„é‚£ä¸€åˆ»å¼€å§‹ï¼Œå°±æƒ³ç€é€šè¿‡ä¿ç ”æ¥æ´—åˆ·é«˜è€ƒçš„å¤±è´¥ã€‚æŠ±ç€è¿™æ ·çš„æƒ³æ³•ï¼Œå¤§å­¦æœ€åˆè‡ªç„¶æ˜¯è¿‡å¾—æµ‘æµ‘å™©å™©ä¸”å¤±è´¥çš„ã€‚\nä¸¥æ ¼æ¥è¯´ï¼Œæˆ‘æ˜¯æ²¡æœ‰å¤§ä¸€è¿™ä¸ªè¯´æ³•çš„ï¼Œå……å…¶é‡å°±æ˜¯é«˜å››ç½¢äº†ï¼Œåœ¨è¿™ä¸€å¹´ä¸­ï¼Œæˆ‘ç»§ç»­äº«å—ç€åšä¼˜ç­‰ç”Ÿçš„å¿«æ„Ÿï¼Œæ´»åœ¨ä»–äººçš„ç›®å…‰é‡Œã€‚ä¸€æ–¹é¢æ˜¯æ»¡ç»©æ‹¿åˆ°æ‰‹è½¯ï¼Œå¦ä¸€æ–¹é¢åˆ™æ˜¯å®Œå…¨æ²¡æœ‰æ€è€ƒè¿‡è¿™ä¸ªä¸“ä¸šè¯¥å­¦ä»€ä¹ˆï¼Œè‡ªå·±æ„Ÿå…´è¶£çš„åˆæ˜¯ä»€ä¹ˆã€‚åŒå­¦ä»¬æ™šä¸Šå‡ºå»ç©æˆ‘å—¤ä¹‹ä»¥é¼»ï¼Œå‘è§‰æœºå™¨äººå®éªŒå®¤å¯èƒ½å½±å“ä¿ç ”å°±ç«‹åˆ»é€€å‡ºã€‚åœ¨å¤§ä¸€ç»“æŸæ—¶ï¼Œå¸¦ç€â€œå·®ä¸å¤šâ€ï¼Œâ€œå­¦çš„éƒ½ä¸€æ ·â€ï¼Œä»¥åŠæœ¬ä¸“ä¸šä¿ç ”ç‡æ›´é«˜çš„æƒ³æ³•ï¼Œæˆ‘ä¹Ÿæ˜¯æ”¾å¼ƒäº†æœ¬ç§‘å”¯ä¸€ä¸€æ¬¡çš„è½¬ä¸“ä¸šæœºä¼šã€‚\nè¿™æ ·åæ¿€çš„ï¼Œå½»åº•å”¯ç»“æœè®ºçš„åšæ³•å¾ˆå¿«å°±å¸¦æ¥äº†ä¸å¯é€†çš„åæœï¼Œåœ¨å¤§äºŒä¸Šå­¦æœŸæ—¶ï¼Œæˆ‘æ‰æ„è¯†åˆ°è‡ªå·±å¯¹äºAIï¼Œå¯¹äºç®—æ³•å®Œå…¨ä¸æ„Ÿå†’ï¼Œå’Œæˆ‘æ‰€æƒ³çš„è®¡ç®—æœºå®Œå…¨ä¸åŒã€‚æ‰æ„è¯†åˆ°ï¼Œæ•´ä¸ªå¤§ä¸€åªæ˜¯äº«å—é‚£ç§åœ¨æˆç»©ä¸Šé«˜äººä¸€ç­‰çš„å¿«æ„Ÿï¼Œéšå³è€Œæ¥çš„åˆ™æ˜¯å½»å¤œéš¾çœ ï¼Œåœ¨å¤±çœ çš„é‚£äº›æ™šä¸Šï¼Œæˆ‘å‡ ä¹ç¿»çœ‹å®Œäº†çŸ¥ä¹ä¸Šæ‰€æœ‰è·¨ä¿è®¡ç®—æœºçš„å¸–å­ï¼Œé‚£äº›ä¸ºæ•°ä¸å¤šçš„æˆåŠŸæ¡ˆä¾‹ä¹Ÿç®—æ˜¯ç»™æˆ‘å¸¦æ¥äº†ä¸€äº›å®½æ…°ï¼Œè®©æˆ‘ä¸è‡³äºå½»åº•å¤±å»å­¦ä¹ çš„åŠ¨åŠ›ã€‚è‡ªé‚£ä¸€åˆ»èµ·ï¼Œä¾¿å¼€å§‹äº†æˆ‘çš„è‡ªæ•‘ä¹‹è·¯ï¼Œå¦‚ä½•é€ƒç¦»AIï¼Œåšè‡ªå·±çœŸæ­£æ„Ÿå…´è¶£çš„æ–¹å‘ã€‚\nä¸ºäº†é€ƒç¦»AIï¼Œæœ€åˆåŠ å…¥äº†å­¦æ ¡çš„å·¥ä½œå®¤å¹¶å¼€å§‹å­¦ä¹ åç«¯ï¼Œåœ¨å­¦ä¹ æ•°æ®åº“çš„ç›¸å…³çŸ¥è¯†æ—¶ï¼Œæœºç¼˜å·§åˆçš„æ¥è§¦åˆ°äº†csdiyå’ŒCMU15-445ï¼Œä¹Ÿæ˜¯åœ¨è¿™ä¸ªæ—¶å€™å¼€å§‹äº†è§£åˆ°è®¡ç®—æœºå¹¶éç®—æ³•ä¸å¼€å‘äºŒå…ƒå¯¹ç«‹ï¼ŒAndyè®²è¯¾çš„å¹½é»˜é£è¶£å’Œæ•°æ®åº“æœ¬èº«çš„ç³»ç»Ÿå¤æ‚æ€§æ·±æ·±çš„å¸å¼•äº†æˆ‘ã€‚å¦‚æœè¯´åç«¯æ˜¯å› ä¸ºæˆ‘ä¸æƒ³åšAIçš„é€‰æ‹©ï¼Œé‚£ä¹ˆæ•°æ®åº“æ‰æ˜¯æˆ‘çœŸæ­£å‘è‡ªå†…å¿ƒçš„å¯¹å…¶äº§ç”Ÿäº†æµ“åšçš„å…´è¶£ï¼Œç»è¿‡ä¸€æ®µæ—¶é—´åºŸå¯å¿˜é£Ÿçš„å­¦ä¹ ï¼Œä¹Ÿæ˜¯å†³å®šäº†å°†æ•°æ®åº“æˆ–è€…sysä½œä¸ºæˆ‘ä»Šåçš„æ–¹å‘ã€‚åé¢çš„ä¸€åˆ‡å°±æ¯”è¾ƒçš„æ°´åˆ°æ¸ æˆäº†ï¼Œåˆ·è¯¾ï¼Œåšlabï¼Œè¯»paperçœ‹å¼€æºé¡¹ç›®éƒ½æŒ‰éƒ¨å°±ç­çš„è¿›è¡Œã€‚\næˆ‘çš„æ„æ€åªæ˜¯ï¼Œæˆ‘å¹¶ä¸è®¤ä¸ºå¹¸ç¦å¯ä»¥æŒ‡ä»£ä¸€ç§ä»¤äººæ»¡æ„çš„æ™®é€‚æ€§çš„ç”Ÿæ´»æ–¹å¼ã€‚ä½ ä¸èƒ½é€šè¿‡ç›´æ¥æŠŠå®ƒè®¾å®šä¸ºç›®æ ‡æ¥å¾—åˆ°å®ƒã€‚åœ¨æˆ‘å’Œå½¼å¾—æ£®çš„è¾©è®ºä¸­ï¼Œæˆ‘æå‡ºå¹¸ç¦æ˜¯ä¸€ä¸ªå¿…è¦çš„å‰¯äº§å“ã€‚å‡å¦‚ä½ ä¸ºå…¶å®ƒæŸäº›ä¸œè¥¿è€Œå¥‹æ–—ï¼Œå®ƒå°±ä¼šéšä¹‹åˆ°æ¥ã€‚å®ƒåªä»¥å‰¯äº§å“çš„å½¢å¼å‡ºç°ã€‚å¦‚æœä½ åªæŠŠå¹¸ç¦å½“åšç›®æ ‡ï¼Œé‚£æ€»æ˜¯ä¼šå¯¼å‘è‡ªæˆ‘æ¯ç­çš„ã€‚ â€”â€”é½æ³½å…‹\nä½œè€…ï¼šKagarino Kirie\né“¾æ¥ï¼šhttps://www.zhihu.com/question/392634078/answer/2323699160\næ¥æºï¼šçŸ¥ä¹\nè‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚\nå°±åƒè¿™æ®µè¯ä¸€æ ·ï¼Œæˆ‘æƒ³è¯´çš„æ˜¯ï¼Œå¦‚æœåªæŠŠä¿ç ”å½“ä½œç›®æ ‡ï¼Œé‚£æ€»æ˜¯ä¼šå¯¼å‘è‡ªæˆ‘æ¯ç­çš„ã€‚ç›¯ç€ä¿ç ”ï¼Œç„¶åä¸ºäº†ä¿ç ”å»è´¹åŠ²æ‰‹æ®µçš„æƒ³å‡ºæˆæœï¼Œè¿™æ ·å¤§æ¦‚ç‡ä¼šåƒæ— å¤´è‹è‡ä¸€æ ·åˆ°å¤„åšæ— ç”¨åŠŸï¼Œæˆ–è€…æ˜¯ç›´æ¥å½“â€œç»©ç‚¹å“¥â€ï¼Œç»©ç‚¹å¤§æ€å››æ–¹ï¼ŒæŠ€æœ¯ä¸Šè¿æ’åºéƒ½å†™ä¸å‡ºã€‚ä»Šå¹´è®¤è¯†ä¸€ä½åŒå­¦ï¼Œä¹Ÿæ²¡æœ‰ä»€ä¹ˆå‡ºè‰²çš„ç§‘ç ”ç»å†ï¼Œç¡¬æ˜¯é è‡ªå·±æ‰å®çš„åŸºç¡€å’Œå†…åŠŸï¼Œè¿ç»­æ‹¿ä¸‹rucä¿¡é™¢å’Œsjtu ipadsçš„ä¼˜è¥ã€‚æ‰€ä»¥è¿™å…¶å®ä¸Šå°±æ˜¯ä¸€ä¸ªå› æœå…³ç³»ï¼Œæ˜¯ä¸ºäº†æ›´å¥½çš„å­¦ä¹ è€Œå»ä¿ç ”ï¼Œè¿˜æ˜¯è¯´ä¸ºäº†ä¿ç ”è€Œå»â€œå‡ºæˆæœâ€ã€‚\nå®ƒæ›´åƒæ˜¯ä¸€ä¸ªå­¦ä¹ é€”å¾„ï¼Œå¦‚æœæˆ‘æƒ³å­¦db/systemï¼Œè€Œä¿ç ”å¯ä»¥ç»™æˆ‘æä¾›ä¸€ä¸ªå¾ˆå¥½å¹³å°ï¼Œé‚£ä¹ˆæˆ‘å°±å»ä¿ç ”ã€‚æœ€ç»ˆè®©æˆ‘æ”¶è·é¢‡ä¸°çš„ä¸æ˜¯æ¥æ”¶åˆ°æ¢¦æ ¡offerçš„é‚®ä»¶ï¼Œä¸æ˜¯929å½“å¤©åœ¨ç³»ç»Ÿä¸­ç‚¹ä¸‹ç¡®è®¤æ¥å—çš„é‚£ä¸€åˆ»ï¼Œè€Œæ˜¯ä½ è‡ªå·±ä¸€æ­¥ä¸€æ­¥å‘ä¿ç ”èµ°å»ï¼Œä¸€è·¯ä¸Šçš„ä¿®ç‚¼çš„å†…åŠŸæˆå°±äº†è‡ªå·±ã€‚ç‚¹ä¸‹ç¡®è®¤çš„é‚£ä¸€åˆ»ï¼Œå¹¶ä¸ä¼šåƒæ¸¸æˆä¸­çš„è£…å¤‡é‚£æ ·ï¼Œç»™æˆ‘å¸¦æ¥å¼ºåŠ›çš„å±æ€§åŠ æˆï¼Œå®ƒæœ€å¤šå°±æ˜¯ç»™æˆ‘æä¾›äº†ä¸€ä¸ªåŠ é€Ÿåº¦ï¼Œè®©æˆ‘ä»Šåå¯ä»¥èµ°å¾—æ›´å¿«ï¼Œèµ°çš„æ›´è¿œã€‚\nå½“ç„¶å®Œå…¨é¿å…åŠŸåˆ©æ˜¯å¾ˆéš¾åšåˆ°çš„ï¼Œäººæ€»æ˜¯éœ€è¦åˆ©å·±çš„ï¼Œæ— è®ºæ˜¯åè¿˜æ˜¯åˆ©ï¼Œåªè¦ä¸æåå› æœé¡ºåºå°±å¥½ã€‚\nä¿ç ”ï¼Œç»ˆç‚¹äº¦æ˜¯èµ·ç‚¹ å¦‚æœè¯´2023æœ‰ä»€ä¹ˆè¶³ä»¥æ”¹å˜äººç”Ÿè½¨è¿¹çš„å¤§äº‹çš„è¯ï¼Œé‚£ä¹ˆå¤§æ¦‚å°±æ˜¯æœ€ç»ˆå¦‚æ„¿ä»¥å¿çš„è·å¾—äº†æ¨å…èµ„æ ¼ï¼Œä¹Ÿæ”¶è·äº†å¿ƒä»ªçš„offerã€‚\nå¸¦ç€éç§‘ç­ + érk1çš„debuffï¼Œå¤ä»¤è¥è§£å†³åŸºæœ¬ä¸Šè¢«ä¸­ä¹å…¨æ‹’å¾·ï¼Œå¥½åœ¨äººå¤§ã€å¦å¤§æ”¶ç•™äº†å¿ƒç¢é¼ é¼ ï¼Œä»¥åŠæµ·ç‹å¤©å¤§æŠŠæˆ‘æµ·è¿›å»äº†ï¼Œè®©æˆ‘ä¸è‡³äºé¢å¯¹å¤0è¥çš„æƒ¨å‰§ã€‚å¾—ç›Šäºç–«æƒ…ç»“æŸï¼Œä»Šå¹´çš„å¤ä»¤è¥ç»ˆäºæ˜¯è½¬å‘äº†çº¿ä¸‹ï¼Œå‚ä¸æ„Ÿå¤§å¤§æå‡ï¼Œé¢è¯•ä½“éªŒæ‹‰æ»¡ï¼Œä¹Ÿæ”¶åˆ°äº†äººå¤§çš„Tæ¤å’Œå¦å¤§çš„å¸†å¸ƒåŒ…ï¼Œå’Œä¸€äº›è€æœ‹å‹è§é¢äº†ï¼Œä¹Ÿè®¤è¯†äº†å¾ˆå¤šæ–°æœ‹å‹ã€‚è™½ç„¶æœ‰ç‚¹æ›²æŠ˜ï¼Œä¸è¿‡æœ€åæ‰€æœ‰å‚åŠ çš„å¤ä»¤è¥/é¢„æ¨å…éƒ½æ”¶è·äº†offerã€‚\nåœ¨æµ©æµ©è¡è¡çš„AIå¤§å†›ä¸­ï¼Œå‡ºäºsysäººæŠ±å›¢å–æš–çš„ç›®çš„ï¼Œå»ºäº†ä¸€ä¸ªsysä¿ç ”çš„å°ç¾¤ï¼Œè¿™ä¸€è·¯èµ°æ¥ä¹Ÿå°‘ä¸äº†ç¾¤å‹ä»¬çš„æ”¯æŒä¸é¼“åŠ±ï¼Œæ¯æ¬¡å¤ä»¤è¥éƒ½æœ‰æœºä¼šå’Œå’Œç¾¤å‹ä»¬çº¿ä¸‹é¢åŸºèšä¸€èšå’Œç¾¤å‹ä»¬é€›äº†åŒ—äº¬ã€å—äº¬ã€å¦é—¨å’Œæ­¦æ±‰ï¼Œå¯æƒœçš„æ˜¯æœ€ç»ˆè¿˜æ˜¯æ²¡èƒ½å’Œæ‰€æœ‰ç¾¤å‹éƒ½è§ä¸Šä¸€é¢ã€‚ç¾¤å‹ä»¬æœ€åä¹Ÿéƒ½å»äº†å¾ˆå¥½çš„å­¦æ ¡ï¼Œä¹Ÿç¥ä»–ä»¬éƒ½èƒ½å¤Ÿåœ¨ç¡•å£«é˜¶æ®µç»§ç»­å‘å…‰å‘çƒ­ï¼Œè¿½æ±‚è‡ªå·±æ‰€çƒ­çˆ±çš„ã€‚\n929å½“å¤©ï¼Œè™½ç„¶è·Ÿç€ç»¿è£™æ˜¥æ™šä¹å‘µäº†ä¸€ä¸‹ï¼Œä¹Ÿåœ¨è‡ªå·±çš„å°ç¾¤é‡Œé¢åº†ç¥äº†ä¸€ä¸‹ï¼Œä½†æ˜¯æ„Ÿè§‰å…¶å®å¹¶æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„ï¼Œç­‰å¾…offerå’Œç‚¹ä¸‹ç¡®è®¤éƒ½æ˜¯æ°´åˆ°æ¸ æˆçš„äº‹æƒ…ã€‚åç»­è‡ªç„¶ä¹Ÿæ²¡æœ‰ä»€ä¹ˆæ‰€è°“çš„gap yearäº†ã€‚åé¢å°±æŒ‰éƒ¨å°±ç­çš„æ‰“äº†obï¼Œçœ‹äº†leveldbï¼Œå¯åŠ¨äº†ä¸€ä¸‹rustï¼Œè¡¥äº†ä¸€äº›åŸºç¡€ã€‚è¦è¯´æœ€å¤§çš„åŒºåˆ«çš„è¯ï¼Œå¤§æ¦‚å°±æ˜¯å†ä¹Ÿä¸éœ€è¦å»å­¦é‚£äº›æ²¡æ„ä¹‰çš„è¯¾ç¨‹ï¼Œåˆ·é‚£äº›æ²¡æœ‰ç”¨çš„ç»©ç‚¹äº†ã€‚å¯èƒ½æ¯”è¾ƒé—æ†¾çš„æ˜¯å†³å®šobå†³èµ›å¼ƒèµ›æ—¶å·²ç»åäºŒæœˆåˆäº†ï¼Œè¿™æ—¶å€™å‡ ä¹å·²ç»æ²¡æœ‰å®ä¹ äº†ï¼ŒæŠ•äº†ä¸€åœˆå‡ ä¹æ²¡äººç†æˆ‘ï¼Œå¹¶ä¸”åˆšæŠ•äº†ä¸€ä»½å°±ç”²æµä¸­æ‹›äº†ï¼Œåœ¨åºŠä¸Šåˆèººäº†å¥½å‡ å¤©ã€‚å”¯ä¸€çš„ä¸€å®¶åˆåˆ›ä¹Ÿå› ä¸ºæˆ‘æ²¡èƒŒå…«è‚¡åœ¨äºŒé¢æŒ‚æ‰äº†ï¼Œå…¶å®ä¹Ÿä¸èƒ½ç®—èƒŒå…«è‚¡ï¼Œé—®çš„éƒ½æ¯”è¾ƒåŸºç¡€ï¼Œåœ¨OSTEPï¼Œç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»é‡Œé¢éƒ½çœ‹åˆ°è¿‡ï¼Œé•¿æ—¶é—´æ²¡å¤ä¹ é—å¿˜äº†ã€‚ç®—æ˜¯ä¸€ä¸ªé—æ†¾äº†ã€‚\næŠ€æœ¯ï¼Œè·¯åœ¨ä½•æ–¹ ä»Šå¹´æŠ€æœ¯çš„æœ€å¤§æˆé•¿ï¼Œæˆ–è®¸æ˜¯çŸ¥é“äº†è‡ªå·±åº”è¯¥åŠªåŠ›çš„æ–¹å‘ã€‚å¦‚æœè¯´ä»ç³»ç»Ÿæ€§å­¦ä¹ å¼€å§‹è®¡ç®—çš„è¯ï¼Œä»Šå¹´å¤§æ¦‚æ˜¯æˆ‘çš„systemå…ƒå¹´ã€‚æ¥ä¸‹æ¥æˆ‘è¦ä½œä¸€äº›æ¯ç‡¥æ— å‘³çš„æœºæ¢°åˆ—ä¸¾äº†â€”â€”å¸Œæœ›è¯»è€…èƒ½å¤ŸåŒ…å®¹è¿™ç‚¹ã€‚\nLab \u0026amp;\u0026amp; é¡¹ç›®\nè¦è¯´ç¬¬ä¸€æ¬¡æ¥è§¦systemï¼Œè¿˜æ˜¯å¤§äºŒæš‘å‡äº†è§£åˆ°çš„MIT-6.824ï¼Œä¸è¿‡å½“æ—¶çš„ä»£ç æ°´å¹³å®åœ¨æ˜¯ä¸å ªå…¥ç›®ï¼ŒMapReduceä¹Ÿæ²¡å†™å‡ºæ¥å°±è¢«åŠé€€äº†ã€‚å¹´åˆç»ˆäºæœ‰æœºä¼šé‡æ–°å†æ¬¡æŒ‘æˆ˜ä¸€ä¸‹6.824äº†ï¼Œå³ä¾¿æ˜¯æœ‰äº†ä¸€äº›systemåŸºç¡€ä¹‹åï¼Œæ•´ä¸ªè¿‡ç¨‹è¿˜æ˜¯éå¸¸é…¸çˆ½çš„ï¼Œè¢«å„ç§trickyçš„bugè™çš„æ­»å»æ´»æ¥ï¼Œå¯¹ç€å‡ ä¸‡è¡Œçš„æ—¥å¿—æ¬²å“­æ— æ³ªã€‚ç®—ä¸Šçœ‹è¯¾ + çœ‹paperï¼Œæœ€åè€—æ—¶ä¸¤ä¸ªå¤šæœˆçš„ç»ˆäºæ˜¯å®ç°äº†è‡ªå·±ä¸€ä¸ªæ¯”è¾ƒæ»¡æ„çš„ç‰ˆæœ¬ã€‚ç›¸æ¯”äºRaftï¼Œ6.824æ›´å¤šçš„æ˜¯æ„å¿—ä¸Šçš„ä¸€ä¸ªç£¨ç»ƒã€‚ ä¹‹å‰çœ‹445æ—¶cppå¹¶ä¸å¤ªç†Ÿç»ƒï¼Œlabé€‰æ‹©äº†Javaå®ç°çš„MIT 6.830ï¼Œä»Šå¹´ç»ˆäºæ˜¯æœ‰æœºä¼šè¡¥ä¸Šäº†ï¼Œæœ‰äº†6.824çš„åŸºç¡€ï¼Œ445å†™èµ·æ¥å°±å¾ˆå¾—å¿ƒåº”æ‰‹äº†ï¼Œè™½ç„¶å™©æ¢¦B+æ ‘è€—è´¹äº†æˆ‘ä¸å°‘æ—¶é—´ï¼Œä¸è¿‡å…¶ä»–ä¸‰ä¸ªå¾ˆå¿«å°±Aæ‰äº†ï¼Œè¿™ä¹Ÿç®—æ˜¯æˆ‘çœŸæ­£æ„ä¹‰ä¸Šçš„ç¬¬ä¸€ä¸ªmodern cppé¡¹ç›®ï¼Œæ€»çš„æ¥è¯´æ”¶è·å¾ˆå¤šï¼Œå­¦åˆ°äº†å¾ˆå¤šå·¥ç¨‹æ€§çš„ä¸œè¥¿ Miniob/Oceanbaseï¼šå‚åŠ  ob æ¯”èµ›æ—¶å·²ç»æ˜¯ä¿ç ”ç»“æŸäº†ï¼Œè¿™æ—¶å€™å°±æ˜¯çº¯å…´è¶£äº†ï¼ŒåŠ ä¸Šç”±äºå‡†å¤‡å¤ä»¤è¥/é¢„æ¨å…å¾ˆä¹…æ²¡å†™ä»£ç äº†æœ‰ç‚¹æ‰‹ç—’ (ç‘Ÿææ‰‹ç—’éš¾è€ï¼Œæ¸´æœ›å†™ä»£ç )ã€‚Miniob å’Œ Bustub çš„ä¾§é‡ç‚¹ä¸åŒï¼Œæ›´æ³¨é‡åŠŸèƒ½ä¸Šçš„å®ç°å’Œé—®é¢˜çš„è§£å†³ï¼Œåˆèµ›ä¸­ä¹Ÿå†™äº†å‡ ä¸ªæ¯”è¾ƒå¥½ç©çš„ä¸œè¥¿ï¼Œåƒæ˜¯ null å­—æ®µï¼Œæ”¯æŒ text å’Œ mvccï¼Œæœ€åéå¸¸æœ‰å¹¸å‘ç°äº†ç³»ç»Ÿä¸­çš„ä¸€äº› bugï¼Œæçš„ pr ä¹Ÿè¢«æ¥å“¥åˆåˆ°äº†ä¸»åˆ†æ”¯ï¼Œä¹Ÿç®—æ˜¯ä¸ºå¼€æºåšè´¡çŒ®äº†ã€‚å†³èµ›å°±æ¯”è¾ƒåç‰¢äº†ï¼Œåœ¨ç›¸ç»§æå‡ºå‡ ä¸ªä¼˜åŒ–ç‚¹ä¹‹åç»ˆäºæ˜¯é‡ä¸Šäº†ç“¶é¢ˆï¼Œæ„Ÿå—åˆ°äº†è‡ªå·±èƒ½åŠ›ä¸è¶³å¸¦æ¥çš„æ— åŠ›æ„Ÿï¼Œæœ€åæ— å¥ˆå¼ƒèµ›ï¼Œæˆç»©ä» 15 æœ€åæ‰åˆ°äº† 30 å¤šã€‚ ä¹¦ç±\nè¯»å®Œäº†DDIAï¼Œä¸ªäººæ„Ÿè§‰è¿™æœ¬ä¹¦ä½œä¸ºåˆ†å¸ƒå¼çš„å…¥é—¨æˆ–è€…åˆå­¦å¹¶ä¸åˆé€‚ï¼ŒDDIAä¸­æè¿°çš„éƒ½æ¯”è¾ƒçš„å®½æ³›ï¼Œå¦‚æœæ˜¯åˆšæ¥è§¦åˆ†å¸ƒå¼çš„è¯éš¾ä»¥æœ‰ä»€ä¹ˆæ·±åˆ»çš„ä½“ä¼šã€‚æœ€å¥½æ˜¯å¯¹åˆ†å¸ƒå¼ã€å­˜å‚¨ã€æ•°æ®åº“å„ä¸ªæ–¹å‘éƒ½æœ‰æ‰€æ¶‰çŒä¹‹åï¼Œå†çœ‹ä¼šæœ‰ä¸€ç§é›†å¤§æˆçš„æ„Ÿè§‰ï¼Œèƒ½å¤Ÿç†è§£å…¶ä¸­çš„å„ç±»è®¾è®¡æ‰€è§£å†³çš„é—®é¢˜ï¼Œæ­£å¦‚ä¹¦åä¸€æ ·ï¼Œèƒ½å¤Ÿä½“ä¼šåˆ°æ„å»ºä¸€ä¸ªæ•°æ®å¯†é›†å‹çš„å¤§å‹åˆ†å¸ƒå¼ç³»ç»Ÿéƒ½éœ€è¦ä»€ä¹ˆã€‚ è¡¥äº†è¡¥cppï¼Œè·³ç€çœ‹äº†çœ‹ã€ŠC++ Primerã€‹ï¼Œè¿‡äº†ä¸€éã€ŠEffective c++ã€‹å’Œã€ŠEffective modern c++ã€‹ï¼Œæ„è¯†åˆ°äº†è‡ªå·±åŸæœ¬å†™äº†å¤šå°‘å±å±±å‡ºæ¥ï¼Œä¸è¿‡å³ä¾¿çœ‹å®Œï¼Œæˆ‘ä¹Ÿå¹¶ä¸è®¤ä¸ºæˆ‘æ˜¯ä¸€ä¸ªåˆæ ¼çš„cppç¨‹åºå‘˜ã€‚ çœ‹äº†ä¸€æœ¬å«åšã€Šæ·±å…¥ç†è§£åˆ†å¸ƒå¼ç³»ç»Ÿã€‹çš„ä¹¦ï¼Œå¬åå­—æ„Ÿè§‰æœ‰äº›å™±å¤´ï¼Œä½†æ˜¯ç›¸æ¯”DDIAæ›´é€‚åˆåˆå­¦è€…ï¼Œé‡Œé¢å¯¹å„ç±»ä¸€è‡´æ€§æ¨¡å‹ï¼ŒCAPï¼ŒPaxosï¼ŒRaftéƒ½æœ‰å¾ˆè¯¦ç»†çš„è¯´æ˜ï¼Œä»¥åŠå„ç±»åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œå¦‚Spannerï¼ŒGFSï¼ŒAuroraçš„ä¾‹å­ã€‚å¦‚æœå¤ä»¤è¥å‰è®¤çœŸçœ‹äº†è¿™æœ¬ä¹¦ï¼Œäººå¤§å¤§æ¦‚å°±ç›´æ¥ä¼˜è¥äº†ï¼ˆæ‚² ç³»ç»Ÿæ€§çš„è¿‡äº†ä¸€éã€Šæ•°æ®åº“ç³»ç»Ÿæ¦‚å¿µã€‹çš„é‡ç‚¹ç« èŠ‚ï¼Œä¹‹å‰ä¸€ç›´æ˜¯å½“å­—å…¸æ¥ç”¨ï¼Œéœ€è¦ä»€ä¹ˆçœ‹ä»€ä¹ˆï¼Œç³»ç»Ÿæ€§çœ‹ä¸€éç¡®å®æœ‰æ–°çš„æ”¶è·ï¼Œå¥‰ä¸ºæ•°æ®åº“åœ£ç»ä¸ä¸ºè¿‡ï¼Œä¸è¿‡ç¿»è¯‘è´¨é‡å®åœ¨ä¸å¯¹æˆ‘èƒƒå£ï¼Œå°†keyç¿»è¯‘æˆâ€œç â€ç­‰å¯¹æˆ‘æ¥è¯´å®åœ¨éš¾ä»¥æ¥å—ã€‚å¦‚æœå¤ä»¤è¥å‰è®¤çœŸçœ‹äº†è¿™æœ¬ä¹¦ï¼Œäººå¤§å¤§æ¦‚å°±ç›´æ¥ä¼˜è¥äº†ï¼ˆæ‚² æ¥è§¦ä¸€ä¸‹ Rustï¼Œçœ‹äº†ã€ŠRust åœ£ç»ã€‹ï¼Œä¹‹åæŒç»­æ€§çš„è¢«ç¼–è¯‘å™¨æ‹·æ‰“ï¼Œæœ¬æ¥æƒ³åšä¸€ä¸‹ rcore çš„ï¼Œç»“æœå’Œ ob æ’è½¦äº†æ— å¥ˆæ”¾å¼ƒï¼Œå†™å®Œ rustlings å°±æºœäº†ã€‚å¹´åº•åˆæ¡èµ·æ¥äº†ï¼Œä¹‹å‰åœ¨çŸ¥ä¹ä¸Šçœ‹åˆ°ä¸€ä¸ªç”¨ rust ç§‘ç ”çš„æ–‡ç« ï¼Œâ€œå³ç„¶æˆ‘ä»¬æŒ‰ç…§ rust çš„æ–¹å¼å»å†™ c++ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸ºä»€ä¹ˆä¸ç›´æ¥å†™ rust å‘¢ï¼Ÿâ€ çœ‹è¿‡çš„å¼€æºé¡¹ç›®\nå››æœˆé‚£é˜µè”ç³»äº†ecnuçš„è€å¸ˆï¼Œä¸»è¦æ˜¯åšrocksdbç›¸å…³å·¥ä½œçš„ï¼Œå› æ­¤å°±å…ˆçœ‹äº†çœ‹leveldbçš„æºç ï¼Œå¤§è‡´äº†è§£äº†lsmçš„åŸç†ä¸å®ç°ï¼Œåœ¨ä»Šå¹´åä¸€æœˆæ—¶åˆé‡æ–°åˆ†æå¹¶è°ƒè¯•äº†ä¸€ä¸‹leveldbã€‚â€œè·Ÿleveldbå­¦LSM-Treeâ€ï¼Œâ€œC++98çš„æœ€ä½³å®è·µâ€ï¼Œä¸ªäººæ·±ä»¥ä¸ºç„¶ã€‚ äº”æœˆé‚£é˜µåˆè”ç³»äº†äººå¤§ï¼Œå¼€å§‹åšä¸€äº›è·¨åŸŸRaftçš„å†…å®¹ï¼Œå®éªŒæ˜¯åŸºäºectd/raftè·‘çš„ï¼Œäºæ˜¯å°±å¼€å§‹çœ‹ectd/raftçš„ç›¸å…³å†…å®¹ï¼Œè¿™ä¹Ÿæ˜¯ç¬¬ä¸€æ¬¡æ¥è§¦åˆ°äº†å·¥ä¸šçº§çš„Raftï¼Œå­¦åˆ°äº†ä¸€äº›æ¶æ„è®¾è®¡å’Œå·¥ä¸šç•Œçš„ä¼˜åŒ–ã€‚ å¹´åº•ä¸ºäº†è¡¥ä¸€ä¸‹ Rustï¼Œçœ‹äº† toydb çš„æºç ï¼Œtoydb ä»¥å¾ˆå°çš„ä»£ç è§„æ¨¡ï¼Œå®ç°äº†ä¸€ä¸ªç»“æ„å®Œå–„ï¼Œä»£ç æ¸…çˆ½çš„åˆ†å¸ƒå¼å…³ç³»å‹æ•°æ®åº“ï¼Œå†™çš„ä¹Ÿå¾ˆæœ‰ Rust çš„å‘³é“ï¼Œçœ‹çš„ç›´å‘¼è¿‡ç˜¾ã€‚ Paper\nå‡†å¤‡å¤ä»¤è¥å’Œæ‰“obåˆ†åˆ«åœ¨ä¸Šä¸‹åŠå¹´èŠ±è´¹äº†æˆ‘ä¸€äº›æ—¶é—´ï¼ŒåŠ ä¸Šç›®å‰å¤„äºå…¥é—¨çš„é˜¶æ®µï¼Œpaperç§¯ç´¯ç¡®å®ä¸å¤šï¼Œåˆ—ä¸¾å‡ ä¸ªè‡ªå·±å°è±¡æ¯”è¾ƒæ·±åˆ»çš„ï¼Œå¤§æ¦‚çœ‹äº†è¿™æ ·å‡ ä¸ªæ–¹å‘çš„ï¼š\nåˆ†å¸ƒå¼ï¼šè°·ä¸‰ç¯‡ï¼Œä»¥åŠä¸€äº›6.824ä¸­çš„ç»å…¸åˆ†å¸ƒå¼è®ºæ–‡ï¼Œå¤§æ¦‚äº†è§£äº†åˆ†å¸ƒå¼æ˜¯ä¸ºäº†è§£å†³ä»€ä¹ˆæ ·çš„é—®é¢˜ï¼Œå’Œå¯¹åº”çš„è§£å†³æ–¹æ¡ˆã€‚Raftå¤§è®ºæ–‡éƒ¨åˆ†ç« èŠ‚ï¼Œè·Ÿç€etcdä¸€èµ·çœ‹çš„ï¼Œäº†è§£äº†Raftçš„å¸¸è§„ä¼˜åŒ–ï¼›é€»è¾‘æ—¶é’Ÿï¼ŒHLCï¼ŒCRDBï¼Œåœ¨äººå¤§ç»„é‡Œè·Ÿç€å­¦äº†ä¸€ç‚¹ï¼Œä»Šå¹´åç»­é¢è¯•å‡ æ¬¡è«åå°±æ‰¯åˆ°CRDBä¸Šé¢äº†ï¼Œæ„Ÿè§‰èƒ½æ‹¿ä¸‹åç§‘å…¨å½’åŠŸäºCRDB å­˜å‚¨ï¼šä¸»è¦æ˜¯ä¸€äº›lsmç›¸å…³å†…å®¹ï¼Œåƒæ˜¯Wisckeyï¼ŒpebblesDB,HashKVè¿™äº›ç»å…¸ä¼˜åŒ–ï¼›è¿˜æœ‰ç¯‡ç›˜å¤2.0å‘åœ¨ä»Šå¹´fastä¸Šé¢çš„ï¼Œä¹ŸæŒºæœ‰æ„æ€çš„ã€‚ Dbï¼šä¹æœˆé‚£é˜µçœ‹äº†ä¸€äº› 721 ä¸­åˆ—å­˜çš„ç›¸å…³å†…å®¹ï¼Œåç»­è¢«é¢„æ¨å…æ‰“æ–­äº†ï¼Œé‰´äºåç»­ä¸»æ–¹å‘ä¹Ÿä¸æ˜¯ dbï¼Œä¹Ÿæ²¡å†æ¡èµ·æ¥ã€‚è¿½äº†ä¸€ä¸‹çƒ­ç‚¹ï¼Œçœ‹äº†äº› vector db çš„ç›¸å…³å†…å®¹ï¼ŒManuï¼ŒSPFresh ä¹‹ç±»ã€‚ ç®—æ³•\nä»è‰å±¥è™«è¿›åŒ–åˆ°èš¯èš“ï¼Œå¤ä»¤è¥å‰è¿‡äº†å‡ éacwingåŸºç¡€è¯¾ï¼Œè¿™é‡Œä¸è¯„ä»·yxcè¿™ä¸ªäººæ€ä¹ˆæ ·ï¼Œå•è®ºacwingåŸºç¡€è¯¾çš„è¯ï¼Œç¡®å®æ˜¯å¾ˆé€‚åˆæˆ‘è¿™ç§ç®—æ³•è‰å±¥è™«å»å…¥é—¨äº†ã€‚\nç”Ÿæ´» æ€»çš„æ¥è¯´æ˜¯éå¸¸æ— è¶£çš„ï¼ŒåŸºæœ¬ä¸Šæ¯å¤©éƒ½æ˜¯çƒ‚åœ¨å®¿èˆå†™ä»£ç ï¼Œå¤§æ¦‚åªæœ‰è§…é£Ÿçš„æ—¶å€™æ‰ä¼šç¦»å¼€å®¿èˆã€‚äººé™…äº¤å¾€é™¤äº†æ°´ç¾¤å‡ ä¹ä¸º0ï¼Œè€Œä¸”ä½œæ¯æ˜¯å½»åº•çš„çƒ‚æ‰äº†ã€‚\nä¸è¿‡ä¾ç„¶æœ‰å€¼å¾—åº†ç¥çš„ï¼Œä»å›½åº†ç»“æŸå›åˆ°å­¦æ ¡å¼€å§‹ï¼Œåˆ°åäºŒæœˆåº•å›å®¶ï¼Œå¤§æ¦‚ç˜¦äº†æ¥è¿‘20æ–¤ï¼Œè·ç¦»è„±ç¦»è‚¥å®…åˆè¿‘äº†ä¸€æ­¥ï¼Œèƒ½æ˜æ˜¾æ„Ÿå—åˆ°èº«ä½“è´Ÿæ‹…å‡è½»äº†ã€‚\næ¸¸æˆï¼š\nè’é‡å¤§é•–å®¢ æ•‘èµ2:å”¯ä¸€çœŸç¥ï¼Œæ— ä¸ä¼¦æ¯”çš„æ²‰æµ¸æ„Ÿï¼Œä¸æƒ³å­¦çš„æ—¶å€™å°±è·‘åˆ°è¥¿éƒ¨ï¼Œä»Šå¹´100å¤šä¸ªå°æ—¶ç©ä¸‹æ¥æ„Ÿè§‰äºšç‘Ÿæ›´åƒæ˜¯æˆ‘çš„ä¸€ä¸ªè€æœ‹å‹ï¼Œé›ªå±±å¤ä»‡å›åˆ°æ¯”å½»ä¹‹æ„¿æ—¶ï¼Œå¬ç€ã€ŠCome Live By My Sideã€‹æœ‰ä¸€ç§æ€…ç„¶è‹¥å¤±çš„æ„Ÿè§‰ 2077å¾€æ—¥ä¹‹å½±ï¼šä¸ªäººå¿ƒç›®ä¸­çš„å¹´åº¦æœ€ä½³å‰§æƒ…ï¼ŒåŠ ä¸Š2.0ç³»ç»Ÿå¤§æ”¹ï¼Œç©èµ·æ¥æ ¹æœ¬åœä¸ä¸‹æ¥ æ½œæ°´å‘˜æˆ´å¤«ï¼šå‰æœŸæ–°é²œæ„Ÿæ‰‘é¢è€Œæ¥ï¼Œå¯ä»¥ç»™9åˆ†ï¼ŒåæœŸåªèƒ½1åˆ† å¤å¢“ä¸½å½±ä¸‰éƒ¨æ›²ï¼šEå®ä¹‹å‰é€çš„ï¼Œä¸€ç›´æ²¡æ—¶é—´ç©ï¼Œè§£å¯†å’Œæ”€çˆ¬ä½“éªŒéƒ½å¾ˆä¸é”™ï¼Œæƒ³å°è¯•åŒç±»å‹çš„ç›—è´¼ä¹‹æµ·äº† æ§åˆ¶ï¼šå…‰æ•æ€§ç™«ç—«å·®ç‚¹ç»™æˆ‘å¹²å‡ºæ¥äº†ï¼Œé‚é€€æ¸¸ æˆ˜åœ°ï¼šå¶å°”å»ææè–¯æ¡ çœŸäººå¿«æ‰“ 11: b ç«™çœ‹åˆ°è§†é¢‘å…¥å‘ï¼Œç»“æœä¸Šæ‰‹ç©å‘ç°æ ¹æœ¬æ“ä½œä¸è¿‡æ¥ å·®ç”Ÿæ–‡å…·å¤š\næ¯æ¬¡å£å£å£°å£°è¯´è¿™æ˜¯æœ€åä¸€æŠŠé”®ç›˜ï¼Œä»Šå¹´å¤§æ¦‚æ˜¯çœŸçš„é€€çƒ§äº†ï¼Œåœ¨åˆ†åˆ«ä½“éªŒè¿‡hhkbå’Œnizä¹‹åï¼Œæœ€åè¿˜æ˜¯æ„Ÿè§‰nizæ¥è¿‘çº¿æ€§è½´æ‰‹æ„Ÿçš„é™ç”µå®¹æ›´é€‚åˆæˆ‘ï¼Œç„¶åå°†å…¶æ”¹æˆäº†hhkbä½©åˆ—çš„é”®ä½ã€‚åŸæœ¬çš„æœºæ¢°é”®ç›˜å½»åº•æ‰“å…¥äº†å†·å®«ï¼Œä»Šå¹´å›å®¶ä¹Ÿåªå¸¦äº†ä¸€æŠŠnizå›æ¥ã€‚\nèµ›åšç½—å®¾æ±‰\næ–°åŸ¹å…»æ–¹æ¡ˆä¸­ï¼Œæ·»åŠ äº†åŠ³åŠ¨è¯¾ä½œä¸ºå¿…ä¿®ï¼Œä½†æ˜¯æ•™åŠ¡å¼€å‡ºçš„è¯¾ç¨‹ä¾›ä¸åº”æ±‚ï¼Œä»¥è‡³äºå‡ºç°äº†å‡ ç™¾ï¼Œå‡ åƒä¸€é—¨è¯¾çš„æƒ…å†µï¼Œå­¦ç”Ÿå«è‹¦ä¸è¿­ã€‚é‚£æ—¶å°±åœ¨æƒ³ï¼Œæ˜¯ä¸æ˜¯å¯ä»¥åˆ©ç”¨ä¸€ä¸‹è‡ªå·±å­¦ä¹ çš„æŠ€æœ¯å‘¢ï¼Ÿäºæ˜¯æäº†ä¸€ä¸ªè„šæœ¬ï¼Œç®€å•å‘é€å‡ æ¬¡ç½‘ç»œè¯·æ±‚å°±å¯ä»¥äº†ã€‚é è¿™æ ·æ“ä½œï¼Œå¸®æˆ‘å®¤å‹æŠŠåŠ³åŠ¨è¯¾éƒ½é€‰ä¸Šäº†ã€‚åé¢ä¸€çœ‹åˆ°ç¾¤é‡Œé¢æœ‰äººè¯´è¦å–è¯¾å°±æŠŠè„šæœ¬æ‰“å¼€ï¼ŒåŠè·¯æ‹¦æˆªæ‰è¯¾ç¨‹ï¼Œå†éšä¾¿æ‰¾ä¸ªæ—¶é—´ç»™é‡Šæ”¾æ‰ï¼Œé¢‡æœ‰ç‚¹åŠ«å¯Œæµè´«çš„æ„Ÿè§‰ã€‚\næŠ€æœ¯ä¹‹å¤–\nä¸å¾—ä¸è¯´ï¼Œè¿™æ ·çš„ç”Ÿæ´»å¯¹æˆ‘æ¥è¯´ä¹Ÿè¿‡äºæ²‰é—·äº†ï¼Œæ¸¸æˆå›ºç„¶æŒºå¥½ç©ä¹Ÿå¯ä»¥æ¶ˆç£¨æ—¶é—´ï¼Œä½†æ˜¯å¯ä»¥ç§°ä¸ºçˆ±å¥½å—ï¼Œå¹¶è®©æˆ‘æŒç»­æ€§çš„å»æŠ•å…¥å¹¶ä»˜å‡ºå—ï¼Ÿæˆ‘æƒ³å¹¶ä¸æ˜¯çš„ã€‚\nå›½åº†é‚£æ—¶å°±æƒ³ç€è‡ªå·±æ˜¯ä¸æ˜¯åº”è¯¥å°è¯•æ¥è§¦ä¸€é—¨ä¹å™¨ã€‚ä¹‹åè¢«æœ‹å‹é—®åˆ°ï¼Œâ€œè¯»ç ”ä»¥åé™¤äº†æ—¥å¸¸å·¥ä½œï¼Œæœ‰æ²¡æœ‰ç‰¹åˆ«æƒ³å¹²çš„ï¼Ÿâ€ï¼Œæˆ‘ä¸‹æ„è¯†çš„è¯´å‡ºäº†æƒ³è‡ªå·±ä»å¤´å†™ä¸ªåˆ†å¸ƒå¼kvï¼Œé‚£ä¸€åˆ»æ‰å‘ç°ç”Ÿæ´»å·²ç»æ—¥æ¸æ¯ç‡¥ã€‚åç»­è¿™ä¸ªæƒ³æ³•æ— æ•°æ¬¡è¦ç»•åœ¨æˆ‘çš„è„‘æµ·ä¸­ï¼Œå¯ä»¥æ˜¯å‰ä»–ï¼Œä¹Ÿå¯ä»¥æ˜¯è´æ–¯ï¼Œæ›´é‡è¦çš„æ˜¯åº”è¯¥è¿ˆå‡ºç¬¬ä¸€æ­¥ã€‚å‰ä¸€é˜µå¾—äº†ç”²æµï¼Œåœ¨èººåœ¨åºŠä¸Šçœ‹å®Œå­¤ç‹¬æ‘‡æ»šä¹‹åï¼Œè¿™ç§æƒ³æ³•æ›´åŠ å¼ºçƒˆäº†ã€‚ä½†æ˜¯åé¢å¿™èµ·æ¥ä¹‹ååˆè®©æˆ‘ä¸¾æ£‹ä¸å®šï¼Œä¸å¾—ä¸è¯´è¿™æˆäº†æˆ‘2023ä¸­çš„æœ€å¤§é—æ†¾ã€‚å¸Œæœ›åœ¨æ–°çš„ä¸€å¹´èƒ½å¤Ÿåšå‡ºæ”¹å˜ï¼Œè¿ˆå‡ºç¬¬ä¸€æ­¥ã€‚\næ–°å¹´æœŸæœ› æŠ€æœ¯ä¸Šçš„è¯ï¼Œè¦å­¦çš„å¤§æ¦‚å¾ˆå¤šï¼Œç›®å‰æ„Ÿå—æ¯”è¾ƒå¼ºçƒˆçš„æ˜¯è¯¥è¡¥ä¸€è¡¥ä½“ç³»ç»“æ„äº†ï¼Œæ‰“ç®—çœ‹ä¸€çœ‹è½¯ç¡¬æ¥å£é‚£ä¸€æœ¬ä¹¦ã€‚å…¶ä»–çš„æš‚æ—¶æ²¡æœ‰æƒ³åˆ°ï¼ŒæŒ‰éƒ¨å°±ç­çš„å­¦å°±å¥½ã€‚\nå¯’å‡å…ˆäº‰å–æ¯”æ¯•è®¾çš„åŸºç¡€åŠŸèƒ½å†™å‡ºæ¥ï¼Œå¼€å­¦ä¹‹åå†æä¸€äº›æ¯”è¾ƒæ„æ€çš„ä¼˜åŒ–åŠ è¿›å»ã€‚æœ€åæ¯•è®¾æ˜¯æ‰“ç®—ç”¨rustè‡ªå·±ä»å¤´æï¼Œæœ€è¿‘ä¹Ÿæ¶è¡¥äº†ä¸€ä¸‹rustï¼Œå¸Œæœ›è‡ªå·±èƒ½åšæŒä¸‹æ¥ï¼Œä¸è¦é€ƒè·‘åˆ°c++ã€‚\nå‰©ä¸‹çš„å°±æ˜¯äº›ç”Ÿæ´»ä¸Šçš„äº†ï¼š\nå¸Œæœ›è‡ªå·±èƒ½å†ç˜¦20æ–¤å§ï¼Œå›½åº†çš„æ—¶å€™æ¯”é«˜ä¸­èƒ–äº†å¿«40æ–¤ï¼Œç›®å‰å‡è‚¥è¿›åº¦50%ï¼Œå¸Œæœ›ä¸‹å­¦æœŸèƒ½ç˜¦å›é«˜ä¸­æ—¶æœŸ å­¦ä¸€é—¨ä¹å™¨ï¼Œç›®å‰æ›´å–œæ¬¢è´æ–¯ä¸€ç‚¹ï¼Œå¾ˆå¸Œæœ›èƒ½è‡ªå·±å¼¹ä¸€ä¸‹çš‡åä¹é˜Ÿçš„ã€ŠAnother one bites the dustã€‹ å¯’å‡å­¦ä¸€å­¦åšé¥­ï¼Œç›®å‰ä½“é‡çš„ä½“é‡ä¸€åŠå¾—å½’åŠŸäºè‡ªå·±å—¯é€ å¤–å–(å¦ä¸€åŠæ˜¯å—¯é€ å®µå¤œ)ï¼Œå¸Œæœ›å¯’å‡èƒ½è‡ªç»™è‡ªè¶³ï¼Œåœ¨å®¶å°‘ç‚¹ç‚¹å¤–å– ","permalink":"https://fischer0522.github.io/en/posts/life/2023%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93%E8%AE%B0%E5%BF%86%E8%BF%B7%E8%8C%AB%E4%B8%8E%E6%88%90%E9%95%BF/","summary":"ä»Šå¤©æ˜¯2023å¹´çš„æœ€åä¸€å¤©ï¼Œå¤§æ¦‚åŠä¸ªæœˆå‰å°±èŒç”Ÿäº†å†™ä¸€ç¯‡å¹´åº¦æ€»ç»“çš„æƒ³æ³•ï¼Œä¸è¿‡ä¸€ç›´å› ä¸ºä¸€äº›å…¶ä»–çš„äº‹æƒ…æ‹–åˆ°äº†æœ€åä¸€å¤©ï¼Œç°åœ¨çœ‹å¤§æ¦‚æ˜¯å†™ä¸å®Œäº†ã€‚é‰´äºæˆ‘","title":"è®°å¿†ï¼Œè¿·èŒ«ä¸æˆé•¿ï¼šThe End Of 2023"},{"content":"åœ¨æ­£å¼å†™è¿™ä¸€ç¯‡æ–‡ç« ä¹‹å‰ï¼ŒåŸæœ¬çš„è§„åˆ’æ˜¯åœ¨è¿™ä¸€éƒ¨åˆ†ä»‹ç»sqlæ‰§è¡Œå¼•æ“ï¼Œå³å¦‚ä½•å°†Raftï¼ŒRaftçŠ¶æ€æœºï¼Œå­˜å‚¨å¼•æ“ç»„åˆèµ·æ¥ï¼Œä¸ºSQLçš„æ‰§è¡Œå»æä¾›æ”¯æŒï¼Œä½†æ˜¯è¿™ä¸€éƒ¨åˆ†åˆä¸å¯é¿å…çš„ç‰µæ‰¯åˆ°SQLæ‰§è¡Œè¿‡ç¨‹ï¼Œå¦‚æœå…¨éƒ¨å±•ç¤ºå‡ºæ¥ï¼Œå†…å®¹å°†ä¼šéå¸¸å¤šï¼Œæ€æ¥æƒ³å»ï¼Œè¿˜æ˜¯RaftçŠ¶æ€æœºè¿™ä¸€éƒ¨åˆ†æ¯”è¾ƒç‹¬ç«‹ï¼Œä½¿ç”¨äº†ä¸€ä¸ªTraitå±è”½æ‰äº†åº•å±‚çš„å­˜å‚¨å®ç°ï¼Œå› æ­¤å°±å…ˆå°†è¿™ä¸€æ¨¡å—å•ç‹¬æ‹†å‡ºæ¥ã€‚\nåœ¨toydbå½“ä¸­ï¼ŒRaftçŠ¶æ€æœºçš„å®ç°å®šä¹‰äºsrc/raft/state.rså½“ä¸­ã€‚åœ¨etcdï¼Œå¯¹äºRaft Packageä¹Ÿå¯ä»¥ç†è§£æˆä¸€ä¸ªçŠ¶æ€æœºï¼Œå› æ­¤ï¼Œä¸ºäº†æ–¹ä¾¿è¿›è¡ŒåŒºåˆ†ï¼Œåœ¨å¼€å¤´é¦–å…ˆå£°æ˜ï¼Œåœ¨è¿™ä¸€ç« å‡ºç°çš„æ‰€æœ‰çŠ¶æ€æœºçš„æ¦‚å¿µéƒ½æ˜¯æŒ‡æ„å»ºäºRaftä¸Šå±‚çš„çŠ¶æ€æœºï¼Œä¸Šä¸€ç« åˆ†æçš„Raftä¼šä»¥Raftæ¨¡å—(Raft Package)æ¥æŒ‡ä»£ã€‚ è¿™é‡Œä¸MIT-6.824æœ‰ä¸€ä¸ªéå¸¸å¤§çš„ä¸åŒæ˜¯ï¼š\nåœ¨MIT-6.824å½“ä¸­ï¼Œclientæ˜¯ä¸ä¸Šå±‚çŠ¶æ€æœºè¿›è¡Œé€šä¿¡çš„ï¼Œå‘½ä»¤ä¼šå…ˆè¾“å…¥ç»™çŠ¶æ€æœºï¼Œä¹‹åçŠ¶æ€æœºå‘ä¸‹åˆ›å»ºä¸€æ¡æ—¥å¿—ï¼Œå‘é€ç»™Raftæ¨¡å—å»è¿›è¡Œå…±è¯†ï¼Œå½“è¾¾åˆ°quorumå…±è¯†ä¹‹åï¼ŒçŠ¶æ€æœºå†ç»™clientä»¥å›åº”ï¼Œå‘ŠçŸ¥æ­¤æ¬¡è¯·æ±‚æ‰§è¡Œå®Œæˆ åœ¨toydbå½“ä¸­ï¼ŒClientçš„è¯·æ±‚æ˜¯ç›´æ¥å‘é€ç»™Raftæ¨¡å—çš„ï¼Œåœ¨ä¸Šä¸€ç« å½“ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œserverä»client_rxå½“ä¸­è·å–åˆ°äº†æ¶ˆæ¯ä¹‹åï¼Œç›´æ¥è°ƒç”¨stepäº¤ç»™äº†Raftæ¨¡å—å»å¤„ç†ï¼ŒRaftæ¨¡å—å¤„ç†å®Œä¹‹åä¼šå‘é€ç»™çŠ¶æ€æœºï¼ŒçŠ¶æ€æœºè¿›è¡Œä¸€äº›é€»è¾‘æ ¡éªŒï¼Œä¹‹åå†å‘é€Messageç»™Raftæ¨¡å—ï¼Œä¹‹åç”±Raftæ¨¡å—å°†æ¶ˆæ¯å›å¤ç»™Clientï¼Œæ‰€ä»¥åœ¨Raftæ¨¡å—å½“ä¸­ï¼Œèƒ½å¤Ÿçœ‹åˆ°å¾ˆå¤šå’ŒClientRequestï¼ŒClientResponseç›¸å…³çš„å†…å®¹ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 // è·å–clientå‘é€çš„æ¶ˆæ¯ï¼Œäº¤ç»™Raftæ¨¡å—å»å¤„ç†ï¼Œè¿™é‡Œçš„clientå¹¶ä¸æ˜¯ç”¨æˆ·çš„clientï¼Œè€Œæ˜¯è¦æ‰§è¡Œå‘½ä»¤çš„sqlç«¯ Some((request, response_tx)) = client_rx.next() =\u0026gt; { let id = Uuid::new_v4().as_bytes().to_vec(); let msg = Message{ from: Address::Client, to: Address::Node(node.id()), term: 0, event: Event::ClientRequest{id: id.clone(), request}, }; node = node.step(msg)?; requests.insert(id, response_tx); } Driver åœ¨è¿™é‡Œï¼Œtoydbå½“ä¸­çš„RaftçŠ¶æ€æœºæ›´åƒæ˜¯ä¸€ä¸ªæ¯”è¾ƒå­˜ç²¹çš„çŠ¶æ€æœºï¼Œä»Raftæ¨¡å—å½“ä¸­æ¥æ”¶è¾“å…¥(Instruction)ï¼Œæ›´æ–°è‡ªèº«çŠ¶æ€ä¹‹åï¼Œå†ç»™Raftæ¨¡å—è¾“å‡º(Messsage)ï¼Œä¸ä¼šæ¶‰åŠåˆ°ç½‘ç»œé€šä¿¡éƒ¨åˆ†çš„å†…å®¹ï¼Œä¸ä¼šä¸Clientè¿›è¡Œäº¤äº’ï¼Œæ‰€ä»¥çŠ¶æ€æœºåŸºæœ¬ä¸Šå°±æ˜¯èµ·åˆ°äº†ä¸€ä¸ªè®°å½•çš„ä½œç”¨ï¼Œæ¯”å¦‚ï¼Œè®°å½•å½“å‰æ¥æ”¶åˆ°äº†é‚£äº›è¯·æ±‚ï¼Œå„ä¸ªè¯·æ±‚çš„applyçš„æƒ…å†µï¼Œä»è€Œç¡®å®šä»€ä¹ˆæ—¶å€™è¯¥è®©Raftæ¨¡å—å»å›åº”Clientï¼Œåœ¨è¿™ä¸€éƒ¨åˆ†å®šä¹‰äº†ä¸€ä¸ªDriverï¼Œç”¨äºé©±åŠ¨çŠ¶æ€æœºçš„æ‰§è¡Œï¼š\nstate_rxç”¨äºä»Raftæ¨¡å—å½“ä¸­æ¥æ”¶ä¿¡æ¯ node_txç”¨äºå‘Raftæ¨¡å—å‘é€ä¿¡æ¯ notifyï¼šç”¨äºå½“æŸæ¡æ—¥å¿—applyä¹‹åï¼Œé€šçŸ¥Raftæ¨¡å—ï¼Œè®©å…¶ç»™Clientå›åº”ï¼ŒRaft Leaderåœ¨æ”¶åˆ°Mutateç±»å‹çš„ClientRequestä¹‹åï¼Œä¼šè¿›è¡Œproposeæ¥å¤åˆ¶æ—¥å¿—ï¼Œå¹¶ä¸”å‘çŠ¶æ€æœºå½“ä¸­å‘é€ä¸€æ¡notifyï¼šä¿å­˜åœ¨çŠ¶æ€æœºå½“ä¸­ queriesï¼šå°†åªè¯»è¯·æ±‚ä¿å­˜åˆ°ä¸Šå±‚çŠ¶æ€æœºï¼Œè¾¾åˆ°quorumæ—¶ä¼šå†å‘ŠçŸ¥Leaderè¿›è¡Œè¯»å–ï¼Œå®ç°äº†ReadIndexçš„æ•ˆæœã€‚ 1 2 3 4 5 6 7 8 9 10 /// Drives a state machine, taking operations from state_rx and sending results via node_tx. pub struct Driver { node_id: NodeID, state_rx: UnboundedReceiverStream\u0026lt;Instruction\u0026gt;, node_tx: mpsc::UnboundedSender\u0026lt;Message\u0026gt;, /// Notify clients when their mutation is applied. \u0026lt;index, (client, id)\u0026gt; notify: HashMap\u0026lt;Index, (Address, Vec\u0026lt;u8\u0026gt;)\u0026gt;, /// Execute client queries when they receive a quorum. \u0026lt;index, \u0026lt;id, query\u0026gt;\u0026gt; queries: BTreeMap\u0026lt;Index, BTreeMap\u0026lt;Vec\u0026lt;u8\u0026gt;, Query\u0026gt;\u0026gt;, } å…¥å£ä¸ºdriveå‡½æ•°ï¼Œdriveå‡½æ•°ä¼šä¸æ–­çš„ä»state.rxå½“ä¸­ä¸æ–­è·å–Instuctionï¼Œç„¶åè°ƒç”¨self.executeæ¥æ‰§è¡Œï¼š\n1 2 3 4 5 6 7 8 9 10 11 pub async fn drive(mut self, mut state: Box\u0026lt;dyn State\u0026gt;) -\u0026gt; Result\u0026lt;()\u0026gt; { debug!(\u0026#34;Starting state machine driver at applied index {}\u0026#34;, state.get_applied_index()); while let Some(instruction) = self.state_rx.next().await { if let Err(error) = self.execute(instruction, \u0026amp;mut *state) { error!(\u0026#34;Halting state machine due to error: {}\u0026#34;, error); return Err(error); } } debug!(\u0026#34;Stopping state machine driver\u0026#34;); Ok(()) } åœ¨execute()å½“ä¸­ï¼Œå°±æ˜¯æ ¹æ®instructionçš„ç±»å‹ï¼Œå»è°ƒç”¨ä¸åŒçš„å‡½æ•°ï¼Œé‚£æˆ‘ä»¬åªéœ€è¦å¼„æ˜ç™½æ¯ç§Instructionçš„ç±»å‹å’ŒåŠŸèƒ½ï¼Œä»¥åŠå¯¹åº”çš„å‘é€ä½ç½®å’Œå“åº”æ–¹å¼å³å¯ï¼š\nState Trait åœ¨ä»‹ç»Raftæ¨¡å—ä¸RaftçŠ¶æ€æœºäº¤äº’ä¹‹å‰ï¼Œå…ˆæ¥çœ‹ä¸€ä¸‹RaftçŠ¶æ€æœºçš„Traitå’Œå®ç°ï¼ŒRaftçŠ¶æ€æœºæ˜¯ä»¥Traitçš„å½¢å¼å®šä¹‰çš„ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 /// A Raft-managed state machine. pub trait State: Send { /// Returns the last applied index from the state machine. fn get_applied_index(\u0026amp;self) -\u0026gt; Index; /// Applies a log entry to the state machine. If it returns Error::Internal, /// the Raft node halts. Any other error is considered applied and returned /// to the caller. /// /// The entry may contain a noop command, which is committed by Raft during /// leader changes. This still needs to be applied to the state machine to /// properly track the applied index, and returns an empty result. /// /// TODO: consider using runtime assertions instead of Error::Internal. fn apply(\u0026amp;mut self, entry: Entry) -\u0026gt; Result\u0026lt;Vec\u0026lt;u8\u0026gt;\u0026gt;; /// Queries the state machine. All errors are propagated to the caller. fn query(\u0026amp;self, command: Vec\u0026lt;u8\u0026gt;) -\u0026gt; Result\u0026lt;Vec\u0026lt;u8\u0026gt;\u0026gt;; } è€ŒçœŸæ­£çš„å®ç°åœ¨src/sql/engine/raft.rså½“ä¸­ï¼Œå®šä¹‰äº†ä¸€ä¸ªstruct State\u0026lt;E\u0026gt;æ¥ä½œä¸ºRaftçŠ¶æ€æœºçš„å®ç°ï¼Œåœ¨å…¶ä¸­ï¼Œåªæœ‰ä¸¤ä¸ªå˜é‡ï¼š\nlast_applied_indexç”¨äºè®°å½•å½“å‰åº”ç”¨çš„æœ€åçš„æ—¥å¿— super::KV\u0026lt;E\u0026gt;æ˜¯ä¸€ä¸ªMVCC Storageçš„Wrapper(è¿™ä¸€éƒ¨åˆ†åœ¨02-MVCCå½“ä¸­å·²ç»ä»‹ç»è¿‡)ï¼Œæä¾›äº†å­˜å‚¨å…ƒæ•°æ®å’Œå¼€å¯äº‹åŠ¡çš„åŠŸèƒ½ã€‚ ä½†æ˜¯è¿™ä¸ªstructæ˜¯å…·ä½“æ€ä¹ˆå®ç°è¿™äº›åŠŸèƒ½çš„ï¼Œç”±äºç‰µæ‰¯åˆ°sqlæ‰§è¡Œçš„ä¸€äº›å†…å®¹ï¼Œå¹¶ä¸”ä¸è¿›è¡Œå±•å¼€ä¹Ÿä¸ä¼šå½±å“åˆ°åç»­çš„å†…å®¹ï¼Œå°±ç•™åˆ°ä¸‹ä¸€ç« äº†ã€‚ 1 2 3 4 5 6 7 /// The Raft state machine for the Raft-based SQL engine, using a KV SQL engine pub struct State\u0026lt;E: storage::engine::Engine\u0026gt; { /// The underlying KV SQL engine engine: super::KV\u0026lt;E\u0026gt;, /// The last applied index applied_index: u64, } Instruction åœ¨Raft State Machineå½“ä¸­ï¼ŒInstructionçš„åœ°ä½ç›¸å½“äºRaftæ¨¡å—å½“ä¸­Messageçš„åœ°ä½ã€‚åœ¨è¿™ä¸€éƒ¨åˆ†ï¼Œä¸»è¦ä¼šåˆ†æRaftçŠ¶æ€æœºæ˜¯å¦‚ä½•ä¸Raftæ¨¡å—è¿›è¡Œäº¤äº’çš„ï¼ŒæŒ‰ç…§Instructionçš„ç±»å‹ï¼Œç†é¡ºå„ç±»Instructionçš„å‘é€å’Œå¤„ç†çš„æ–¹å¼ä¸æ—¶æœºã€‚åŠŸèƒ½å®ç°å¦‚ä¸‹ï¼š\nå†™è¯·æ±‚ï¼šNotify åªè¯»è¯·æ±‚ï¼šQuery + Vote åº”ç”¨æ—¥å¿—ï¼šApply ç»ˆæ­¢è¯·æ±‚ï¼šAbort 1 2 3 4 5 6 7 8 9 10 11 12 13 14 pub enum Instruction { /// Abort all pending operations, e.g. due to leader change. Abort, /// Apply a log entry. Apply { entry: Entry }, /// Notify the given address with the result of applying the entry at the given index. Notify { id: Vec\u0026lt;u8\u0026gt;, address: Address, index: Index }, /// Query the state machine when the given term and index has been confirmed by vote. Query { id: Vec\u0026lt;u8\u0026gt;, address: Address, command: Vec\u0026lt;u8\u0026gt;, term: Term, index: Index, quorum: u64 }, /// Extend the given server status and return it to the given address. Status { id: Vec\u0026lt;u8\u0026gt;, address: Address, status: Box\u0026lt;Status\u0026gt; }, /// Votes for queries at the given term and commit index. Vote { term: Term, index: Index, address: Address }, } å†™è¯·æ±‚æ‰§è¡Œ Driver.notifyç”¨äºè®°å½•å®¢æˆ·ç«¯çš„ä¸€æ¬¡å†™è¯·æ±‚ï¼Œåœ¨leaderæ¥æ”¶åˆ°å®¢æˆ·ç«¯çš„å†™è¯·æ±‚æ—¶(ç±»å‹ä¸º Mutate)ï¼Œå°±ä¼šå‘RaftçŠ¶æ€æœºå‘é€ä¸€æ¡Instruction::Notifyï¼Œå°†è¯·æ±‚è®°å½•åˆ°çŠ¶æ€æœºå½“ä¸­ï¼Œç­‰å¾…ä¹‹åè¯¥è¯·æ±‚å¯¹åº”çš„æ—¥å¿—Applyäº†ï¼Œå†å‘ŠçŸ¥Leaderï¼Œè®©Leaderå»å“åº”å®¢æˆ·ç«¯ï¼Œè¿”å›æ‰§è¡Œç»“æœ:\nå‘é€\nLeaderæ¥æ”¶åˆ°Clientå‘é€è€Œæ¥çš„ç±»å‹ä¸ºRequest::Mutateçš„ClientRequestï¼Œåœ¨Raftæ¨¡å—å±‚é¢ï¼Œä¼šè°ƒç”¨self.propose()æ¥è¿›è¡Œæ—¥å¿—å¤åˆ¶ï¼Œåœ¨RaftçŠ¶æ€æœºå±‚é¢ï¼ŒLeaderä¼šå‘RaftçŠ¶æ€æœºå‘é€ä¸€æ¡Instruction::Notifyæ¥è®°å½•è¯·æ±‚ã€‚\n1 2 3 4 5 6 7 8 9 10 // Leader.step() pub fn step(mut self, msg: Message) -\u0026gt; Result\u0026lt;Node\u0026gt; { Event::ClientRequest { id, request: Request::Mutate(command) } =\u0026gt; { let index = self.propose(Some(command))?; self.state_tx.send(Instruction::Notify { id, address: msg.from, index })?; if self.peers.is_empty() { self.maybe_commit()?; } } } åœ¨Driver.execute()å½“ä¸­ï¼Œå¦‚æœé«˜äºç›®å‰çš„appled_indexï¼Œé‚£ä¹ˆå°±æ’å…¥ä¿å­˜ï¼Œç­‰å¾…ä¹‹åè¯¥æ¡æ—¥å¿—applyï¼Œå¦åˆ™ä¸ºå‡ºç°é”™è¯¯ï¼Œè®©Leaderå‘ŠçŸ¥å®¢æˆ·ç«¯ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 /// Executes a state machine instruction. fn execute(\u0026amp;mut self, i: Instruction, state: \u0026amp;mut dyn State) -\u0026gt; Result\u0026lt;()\u0026gt; { match i { Instruction::Notify { id, address, index } =\u0026gt; { if index \u0026gt; state.get_applied_index() { self.notify.insert(index, (address, id)); } else { self.send(address, Event::ClientResponse { id, response: Err(Error::Abort) })?; } } } Ok(()) } åœ¨Leader.step()å½“ä¸­ï¼Œä¼šå¤„ç†ç”±RaftçŠ¶æ€æœºå‘æ¥çš„Message::ClientResponseï¼ŒLeaderä¸ä¼šåšä»€ä¹ˆå¤„ç†ï¼Œç›´æ¥å‘é€ç»™Clientå°±å¥½ï¼Œå¯¹äºå…¶ä»–çš„Instructionï¼Œå¤„ç†ç±»å‹ä¹Ÿæ˜¯ç›¸åŒï¼Œåé¢ä¸ä¼šå†æåŠã€‚\n1 2 3 4 5 6 Event::ClientResponse { id, mut response } =\u0026gt; { if let Ok(Response::Status(ref mut status)) = response { status.server = self.id; } self.send(Address::Client, Event::ClientResponse { id, response })?; } åªè¯»è¯·æ±‚ä¼˜åŒ– åœ¨Raftçš„åŸºç¡€å®ç°å½“ä¸­ï¼Œæ— è®ºæ˜¯å†™è¯·æ±‚è¿˜æ˜¯è¯»è¯·æ±‚ï¼Œéƒ½éœ€è¦åˆ›å»ºä¸€æ¡æ—¥å¿—è¿›è¡Œå†™å…¥ï¼Œä¹‹åæ‰§è¡Œæ—¶æŒ‰ç…§æ—¥å¿—commitçš„é¡ºåºè¿›è¡Œæ‰§è¡Œï¼Œä»è€Œæä¾›çº¿æ€§ä¸€è‡´æ€§ã€‚ä½†è¿™æ ·çš„é—®é¢˜å°±åœ¨äºï¼Œå³ä¾¿æ˜¯è¯»è¯·æ±‚ä¹Ÿéœ€è¦åˆ›å»ºæ—¥å¿—å¹¶å†™å…¥ï¼Œå¸¦æ¥äº†é¢å¤–çš„ç£ç›˜IOï¼Œä»è€Œæé«˜ç³»ç»Ÿå»¶è¿Ÿã€‚\nåœ¨Raftå½“ä¸­ï¼Œä¸ºäº†ä¿è¯çº¿æ€§ä¸€è‡´æ€§ï¼Œéœ€è¦ä¿è¯èƒ½å¤Ÿè¯»åˆ°ç›®å‰æœ€æ–°çš„commit_indexã€‚å¦‚æœæƒ³å¯¹Log Readè¿›è¡Œä¼˜åŒ–ï¼Œé‚£ä¹ˆå°±éœ€è¦æƒ³åŠæ³•ç»•è¿‡å†™å…¥Logå¯¹è¿™ä¸ªè¿‡ç¨‹ï¼Œæ¯”è¾ƒå¸¸è§çš„ä¸¤ç§ä¼˜åŒ–æ–¹å¼æ˜¯ReadIndexå’ŒLease Readã€‚ç”±äºRaftçš„è¯»å†™éƒ½ç»è¿‡Leader(ä¸è€ƒè™‘Follower Readçš„ä¼˜åŒ–)ï¼Œé‚£ä¹ˆåªè¦èƒ½å¤Ÿç¡®è®¤å½“å‰çš„Leaderèº«ä»½æœ‰æ•ˆï¼Œå°±å¯ä»¥ç›´æ¥ä»Leaderæœ¬åœ°è¿›è¡Œè¯»å–ï¼Œä¸ºäº†ç¡®è®¤Leaderçš„æœ‰æ•ˆèº«ä»½ï¼ŒReadIndexå’ŒLease Readé‡‡ç”¨äº†ä¸¤ç§ä¸åŒçš„æ–¹å¼ï¼š\nReadIndex:ReadIndexè®°å½•æ”¶åˆ°è¯·æ±‚æ—¶çš„commit indexï¼Œç„¶åé€šè¿‡å‘é€ä¸€è½®å¿ƒè·³çš„æ–¹å¼æ¥ç¡®è®¤Leaderçš„åˆæ³•èº«ä»½ï¼Œå¦‚æœèƒ½ç¡®è®¤æ”¶åˆ°Quorumæ•°é‡çš„å“åº”ï¼Œé‚£ä¹ˆå½“å‰çš„Leaderèº«ä»½å°±æ˜¯åˆæ³•çš„ï¼Œå½“Leaderçš„apply index \u0026gt;= ä¹‹å‰ä¿å­˜çš„commit indexæ—¶ï¼Œå°±å¯ä»¥æ ¹æ®commit indexå»è¯»å–ã€‚ Lease Read:Lease Readçš„æ ¸å¿ƒæ€æƒ³æ˜¯åˆ©ç”¨äº†ä¸€ä¸ªé€‰ä¸¾æ—¶é—´å·®ï¼Œå½“æ”¶åˆ°Leaderå¿ƒè·³ä¿¡æ¯ä¹‹åï¼Œfollowerå°±ä¼šé‡ç½®é€‰ä¸¾è¶…æ—¶æ—¶é—´ï¼Œé‚£ä¹ˆç›´åˆ°ä¸‹ä¸€æ¬¡é€‰ä¸¾è¶…æ—¶ä¹‹å‰ï¼Œç›®å‰Leaderçš„èº«ä»½ä¸€å®šæ˜¯åˆæ³•çš„ï¼Œä¸ä¼šæœ‰å…¶ä»–çš„èŠ‚ç‚¹é€šè¿‡é€‰ä¸¾æˆä¸ºLeaderï¼Œå› æ­¤å°±å¯ä»¥ç›´æ¥è¯»å–Leaderçš„commit indexã€‚ä¸è¿‡Lease Readä¼šå—åˆ°æ—¶é’Ÿåç§»çš„å½±å“ï¼Œä¸€ç§æ¯”è¾ƒç®€å•çš„è§£å†³æ–¹æ³•æ˜¯å°†Leaseæ—¶é—´è®¾ç½®ä¸ºæ¯”è¶…æ—¶æ—¶é—´çŸ­ä¸€ç‚¹ã€‚(æœ‰é‚£ä¹ˆç‚¹TrueTimeçš„æ„æ€) å¦‚æœæƒ³è¿›ä¸€æ­¥äº†è§£åªè¯»è¯·æ±‚ä¼˜åŒ–ï¼Œå¯ä»¥çœ‹è¿™ä¸€ç¯‡ï¼šæ·±å…¥æµ…å‡ºetcd/raft â€”â€” 0x06 åªè¯»è¯·æ±‚ä¼˜åŒ– - å‰é¸½ MrCroxx çš„åšå®¢ åœ¨toydbå½“ä¸­ï¼Œåªè¯»è¯·æ±‚çš„ä¼˜åŒ–é‡‡ç”¨çš„æ˜¯ReadIndexï¼Œåœ¨Leader.step()å½“ä¸­ï¼Œä¼šå¤„ç†Clientå‘é€æ¥çš„Event::ClientRequestç±»å‹çš„è¯·æ±‚ï¼Œå…¶ä¸­requestç±»å‹ä¸ºRequest::Queryä»£è¡¨åªè¯»è¯·æ±‚ï¼š\nLeaderé¦–å…ˆåˆ›å»ºä¸€æ¡Instruction::Queryå°†åªè¯»è¯·æ±‚è®°å½•åˆ°çŠ¶æ€æœºå½“ä¸­ ä¹‹åå†å‘é€ä¸€æ¡Instruction::Voteæ¥è¡¨ç¤ºè®°å½•å½“å‰èŠ‚ç‚¹ç¡®è®¤äº†Leaderçš„èº«ä»½ å‘é€Heartbeatï¼Œæ¥å°è¯•è¯æ˜è‡ªèº«ä¸ºåˆæ³•çš„Leader 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 pub fn step(mut self, msg: Message) -\u0026gt; Result\u0026lt;Node\u0026gt; { Event::ClientRequest { id, request: Request::Query(command) } =\u0026gt; { let (commit_index, _) = self.log.get_commit_index(); self.state_tx.send(Instruction::Query { id, address: msg.from, command, term: self.term, index: commit_index, quorum: self.quorum(), })?; self.state_tx.send(Instruction::Vote { term: self.term, index: commit_index, address: Address::Node(self.id), })?; self.heartbeat()?; } } Followeræ”¶åˆ°äº†Heartbeatä¿¡æ¯ä¹‹åï¼Œå…ˆæ›´æ–°è‡ªèº«çš„commitè¿›åº¦å’Œè¿›è¡Œapplyï¼Œä¹‹åä¼šå‘é€ä¸€æ¡Message::ConfirmLeaderæ¥è®¤å¯Leaderçš„èº«ä»½ï¼Œå‘é€ç»™Leader,Message::ConfirmLeaderå½“ä¸­ä¼šæºå¸¦Followerçš„commitè¿›åº¦ï¼Œç”¨äºç»™çŠ¶æ€æœºæ¥è®¡ç®—quorumï¼Œç›¸å½“äºåŸæœ¬Leaderè®¡ç®—commit indexã€‚\n1 2 3 4 5 6 7 // Follower.step() pub fn step(mut self, msg: Message) -\u0026gt; Result\u0026lt;Node\u0026gt; { // å…ˆå¤„ç†commitå’Œapply // .... // ç¡®è®¤Leaderèº«ä»½ self.send(msg.from, Event::ConfirmLeader { commit_index, has_committed })?; } Leaderä¼šç»Ÿè®¡Message::ConfirmLeaderä¿¡æ¯ï¼Œæ¯æ”¶åˆ°ä¸€æ¡å°±ä¼šå‘çŠ¶æ€æœºå‘é€Message::Voteï¼ŒçŠ¶æ€æœºä¼šè¿›è¡Œè®°å½•å’Œè®¡ç®—æ˜¯å¦è¾¾åˆ°quorumã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 pub fn step(mut self, msg: Message) -\u0026gt; Result\u0026lt;Node\u0026gt; {\t// A follower received one of our heartbeats and confirms that we // are its leader. If it doesn\u0026#39;t have the commit index in its local // log, replicate the log to it. Event::ConfirmLeader { commit_index, has_committed } =\u0026gt; { let from = msg.from.unwrap(); // ä¸ä¸Šå±‚çŠ¶æ€æœºè¿›è¡Œäº¤äº’ self.state_tx.send(Instruction::Vote { term: msg.term, index: commit_index, address: msg.from, })?; if !has_committed { self.send_log(from)?; } } } åœ¨çŠ¶æ€æœºå½“ä¸­ï¼Œåªè¯»è¯·æ±‚ä½¿ç”¨çš„æ˜¯ä¸€ä¸ªåµŒå¥—çš„BTreeMapç®¡ç†çš„ï¼Œå¯¹åº”\u0026lt;index, \u0026lt;id, query\u0026gt;\u0026gt;,è¡¨ç¤ºåœ¨å½“å‰çš„commit indexä¸‹ï¼Œéƒ½æœ‰å“ªäº›è¯·æ±‚ï¼Œè¿™é‡Œçš„idæ˜¯ç”±Clientå‘é€è€Œæ¥çš„ï¼Œè¡¨ç¤ºè¯·æ±‚çš„å”¯ä¸€æ€§IDï¼Œè€Œä¸æ˜¯NodeIDã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 struct Query { id: Vec\u0026lt;u8\u0026gt;, term: Term, address: Address, command: Vec\u0026lt;u8\u0026gt;, quorum: u64, votes: HashSet\u0026lt;Address\u0026gt;, } pub struct Driver { // ... /// Execute client queries when they receive a quorum. \u0026lt;index, \u0026lt;id, query\u0026gt;\u0026gt; queries: BTreeMap\u0026lt;Index, BTreeMap\u0026lt;Vec\u0026lt;u8\u0026gt;, Query\u0026gt;\u0026gt;, } fn execute(\u0026amp;mut self, i: Instruction, state: \u0026amp;mut dyn State) -\u0026gt; Result\u0026lt;()\u0026gt; { Instruction::Query { id, address, command, index, term, quorum } =\u0026gt; { self.queries.entry(index).or_default().insert( id.clone(), Query { id, term, address, command, quorum, votes: HashSet::new() }, ); } } åœ¨çŠ¶æ€æœºæ”¶åˆ°äº†Instruction::Voteä¹‹åï¼Œåˆ†åˆ«è°ƒç”¨äº†ä¸¤ä¸ªå‡½æ•°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 /// Executes a state machine instruction. fn execute(\u0026amp;mut self, i: Instruction, state: \u0026amp;mut dyn State) -\u0026gt; Result\u0026lt;()\u0026gt; { debug!(\u0026#34;Executing {:?}\u0026#34;, i); match i { Instruction::Vote { term, index, address } =\u0026gt; { self.query_vote(term, index, address); self.query_execute(state)?; } } Ok(()) } åœ¨self.query_voteå½“ä¸­ä¼šæ ¹æ®Instruction::Voteå½“ä¸­çš„commit indexå»è®°å½•æŠ•ç¥¨ï¼Œåªèƒ½å¯¹commit_index \u0026lt;= Vote.commit_indexçš„Queryè¿›è¡ŒæŠ•ç¥¨ã€‚è¿™æ ·ï¼Œåªæœ‰Leaderçš„apply_index \u0026gt;= commit_indexä¹‹åæ‰èƒ½è¿‡é€šè¿‡quorumæ£€æŸ¥ã€‚\n1 2 3 4 5 6 7 8 9 10 11 /// Votes for queries up to and including a given commit index for a term by an address. fn query_vote(\u0026amp;mut self, term: Term, commit_index: Index, address: Address) { for (_, queries) in self.queries.range_mut(..=commit_index) { for (_, query) in queries.iter_mut() { if term \u0026gt;= query.term { // ä½¿ç”¨HashSetè®°å½•ä¿è¯åŒä¸€ä¸ªèŠ‚ç‚¹(ä½¿ç”¨Addressè¡¨ç¤º)ï¼Œåªèƒ½å¯¹åŒä¸€ä¸ªcommit_indexæŠ•ç¥¨ä¸€æ¬¡ query.votes.insert(address); } } } } åœ¨self.query_executeå½“ä¸­ï¼Œä¼šè·å–å‡ºæ‰€æœ‰index \u0026lt;= applied_indexçš„åªè¯»è¯·æ±‚ï¼Œç„¶åè°ƒç”¨çŠ¶æ€æœºçš„å®ç°æ¥æ‰§è¡Œåªè¯»è¯·æ±‚ï¼Œç„¶åå‘ŠçŸ¥Raftæ¨¡å—çš„Leaderå»å“åº”Clientï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 /// Executes any queries that are ready. fn query_execute(\u0026amp;mut self, state: \u0026amp;mut dyn State) -\u0026gt; Result\u0026lt;()\u0026gt; { // self.query_ready()ä¼šè·å–å‡ºæ‰€æœ‰çš„è¾¾åˆ°quorumå¹¶ä¸”index \u0026lt;= applied_indexçš„Queryï¼Œå¹¶ä¸”ä»self.querieså½“ä¸­ç§»é™¤ for query in self.query_ready(state.get_applied_index()) { debug!(\u0026#34;Executing query {:?}\u0026#34;, query.command); let result = state.query(query.command); if let Err(error @ Error::Internal(_)) = result { return Err(error); } self.send( query.address, Event::ClientResponse { id: query.id, response: result.map(Response::Query) }, )? } Ok(()) } Abort å½“Clientå‘é€äº†ä¸€æ¡è¯·æ±‚ä¹‹åï¼ŒRaftæ¨¡å—å°±ä¼šå°†è¯·æ±‚ä¿å­˜åˆ°RaftçŠ¶æ€æœºå½“ä¸­ï¼Œä¹‹åç­‰å¾…æ—¥å¿—commitå¹¶applyäº†ï¼Œå†ç»™Clientå“åº”ã€‚\nå¦‚æœå½“å‰çš„Leaderæ”¶åˆ°äº†æ›´é«˜çš„Termï¼Œé‚£ä¹ˆå°±ä¼šé€€ä½ï¼Œä¸æ˜¯Leaderè‡ªç„¶å°±ä¸èƒ½å¤Ÿå¤„ç†è¯·æ±‚ï¼Œå› æ­¤å­˜åœ¨çŠ¶æ€æœºå½“ä¸­è¿˜æœªå¤„ç†å®Œçš„è¯·æ±‚å°±éœ€è¦å…¨éƒ¨æ”¾å¼ƒï¼Œè¿™ä¸€éƒ¨åˆ†é€»è¾‘å®šä¹‰åœ¨leader.become_follower()å½“ä¸­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 // If we receive a message for a future term, become a leaderless // follower in it and step the message. If the message is a Heartbeat or // AppendEntries from the leader, stepping it will follow the leader. if msg.term \u0026gt; self.term { return self.become_follower(msg.term)?.step(msg); } /// Transforms the leader into a follower. This can only happen if we find a /// new term, so we become a leaderless follower. fn become_follower(mut self, term: Term) -\u0026gt; Result\u0026lt;RoleNode\u0026lt;Follower\u0026gt;\u0026gt; { assert!(term \u0026gt;= self.term, \u0026#34;Term regression {} -\u0026gt; {}\u0026#34;, self.term, term); assert!(term \u0026gt; self.term, \u0026#34;Can only become follower in later term\u0026#34;); info!(\u0026#34;Discovered new term {}\u0026#34;, term); self.term = term; self.log.set_term(term, None)?; self.state_tx.send(Instruction::Abort)?; Ok(self.become_role(Follower::new(None, None))) } åœ¨RaftçŠ¶æ€æœºå½“ä¸­ï¼Œæ”¶åˆ°äº†æ—§Leaderå‘é€çš„Instruction::Abortä¹‹åï¼Œåœ¨execute()å½“ä¸­å°±ä¼šè°ƒç”¨notify_abort()å’Œquery_abort()ï¼Œå°†åŸæœ¬ç”¨äºå­˜å‚¨è¯·æ±‚çš„notifyé‡ç½®ï¼ŒåŒæ—¶æ¸…é™¤ç”¨äºä¿å­˜åªè¯»è¯·æ±‚çš„Queryï¼Œå¹¶ä¸”å†å°è£…ä¸€æ¡Messageå‘é€å›å·²ç»é€€ä½çš„Leaderï¼Œè®©å…¶å‘ŠçŸ¥Clientè¯·æ±‚å·²ç»è¢«å–æ¶ˆæ‰§è¡Œã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 fn execute(\u0026amp;mut self, i: Instruction, state: \u0026amp;mut dyn State) -\u0026gt; Result\u0026lt;()\u0026gt; { debug!(\u0026#34;Executing {:?}\u0026#34;, i); match i { Instruction::Abort =\u0026gt; { self.notify_abort()?; self.query_abort()?; } // ... // ... } } /// Aborts all pending notifications. fn notify_abort(\u0026amp;mut self) -\u0026gt; Result\u0026lt;()\u0026gt; { for (_, (address, id)) in std::mem::take(\u0026amp;mut self.notify) { self.send(address, Event::ClientResponse { id, response: Err(Error::Abort) })?; } Ok(()) } /// Aborts all pending queries. fn query_abort(\u0026amp;mut self) -\u0026gt; Result\u0026lt;()\u0026gt; { for (_, queries) in std::mem::take(\u0026amp;mut self.queries) { for (id, query) in queries { self.send( query.address, Event::ClientResponse { id, response: Err(Error::Abort) }, )?; } } Ok(()) } Apply å½“ä¸€æ¡æ—¥å¿—åœ¨Raftæ¨¡å—å½“ä¸­å¾—åˆ°äº†å¤§å¤šæ•°çš„å…±è¯†ä¹‹åï¼Œå°±è§†å…¶ä¸ºcommitï¼Œè€Œcommitäº†çš„æ—¥å¿—ä¼šApplyåˆ°RaftçŠ¶æ€æœºï¼Œæ­¤æ—¶ä»£è¡¨å®Œæˆäº†ä¸€æ¬¡å†™å…¥ï¼Œå†™å…¥ç»“æœå¯¹å¤–å¯è§ã€‚åœ¨toydbå½“ä¸­ï¼ŒCommitå’ŒApplyçš„åŠ¨ä½œæ˜¯è¿è´¯çš„ï¼Œä¸€æ—¦è·å–åˆ°äº†æ–°çš„commit_indexï¼Œå°±ä¼šç«‹å³å‘çŠ¶æ€æœºå‘é€è¿›è¡Œapplyçš„commit entry:\nLeaderé€šè¿‡è‡ªèº«è¿›è¡Œè®¡ç®— Followeré€šè¿‡Heartbeatå¾—çŸ¥å½“å‰çš„commitè¿›åº¦ï¼Œå†ç»“åˆè‡ªèº«çš„æ—¥å¿—å¤åˆ¶è¿›åº¦å¾—å‡ºä¸€ä¸ªcommit_index 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 // Leader if commit_index \u0026gt; prev_commit_index { self.log.commit(commit_index)?; // TODO: Move application elsewhere, but needs access to applied index. let mut scan = self.log.scan((prev_commit_index + 1)..=commit_index)?; while let Some(entry) = scan.next().transpose()? { self.state_tx.send(Instruction::Apply { entry })?; } } // Follower Event::Heartbeat { commit_index, commit_term } =\u0026gt; { // .... // Advance commit index and apply entries if possible. let has_committed = self.log.has(commit_index, commit_term)?; let (old_commit_index, _) = self.log.get_commit_index(); if has_committed \u0026amp;\u0026amp; commit_index \u0026gt; old_commit_index { self.log.commit(commit_index)?; let mut scan = self.log.scan((old_commit_index + 1)..=commit_index)?; while let Some(entry) = scan.next().transpose()? { self.state_tx.send(Instruction::Apply { entry })?; } } self.send(msg.from, Event::ConfirmLeader { commit_index, has_committed })?; } å½“RaftçŠ¶æ€æœºæ¥æ”¶åˆ°äº†Instruction::Applyä¹‹åï¼Œè°ƒç”¨å®šä¹‰åœ¨sql/engine/raftå½“ä¸­RaftçŠ¶æ€æœºçš„å®ç°æ¥è¿›è¡ŒApplyï¼Œç„¶åè°ƒç”¨self.notify_applyed()ï¼Œå°†Applyçš„æƒ…å†µé€šçŸ¥ç»™ä¸‹å±‚çš„Raftæ¨¡å—ï¼Œæ­¤æ—¶Raftæ¨¡å—å°±å¯ä»¥ç»™Clientå›åº”äº†ã€‚\nå¹¶ä¸”æŸäº›åªè¯»è¯·æ±‚ä¹Ÿå¯èƒ½å› ä¸ºapply_indexçš„æ¨è¿›ï¼Œä»è€Œå¯ä»¥æ‰§è¡Œäº†ï¼Œè°ƒç”¨query_executeå°è¯•æ‰§è¡Œã€‚query_execute()åœ¨ä¸Šæ–‡å·²ç»ä»‹ç»è¿‡äº†ï¼Œä¼šè·å–æ‰€æœ‰è¾¾åˆ°index \u0026lt;= apply_indexçš„Queryå°è¯•æ‰§è¡Œã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 fn execute(\u0026amp;mut self, i: Instruction, state: \u0026amp;mut dyn State) -\u0026gt; Result\u0026lt;()\u0026gt; { match i { // ... Instruction::Apply { entry } =\u0026gt; { self.apply(state, entry)?; } /// ... } } /// Applies an entry to the state machine. pub fn apply(\u0026amp;mut self, state: \u0026amp;mut dyn State, entry: Entry) -\u0026gt; Result\u0026lt;Index\u0026gt; { // Apply the command. debug!(\u0026#34;Applying {:?}\u0026#34;, entry); match state.apply(entry) { Err(error @ Error::Internal(_)) =\u0026gt; return Err(error), result =\u0026gt; self.notify_applied(state.get_applied_index(), result)?, }; // Try to execute any pending queries, since they may have been submitted for a // commit_index which hadn\u0026#39;t been applied yet. self.query_execute(state)?; Ok(state.get_applied_index()) } /// Notifies a client about an applied log entry, if any. fn notify_applied(\u0026amp;mut self, index: Index, result: Result\u0026lt;Vec\u0026lt;u8\u0026gt;\u0026gt;) -\u0026gt; Result\u0026lt;()\u0026gt; { if let Some((to, id)) = self.notify.remove(\u0026amp;index) { self.send(to, Event::ClientResponse { id, response: result.map(Response::Mutate) })?; } Ok(()) } Others åœ¨æ–‡ç« çš„æœ€åï¼Œå†è¡¥å……ä¸€äº›é›¶æ•£çš„å†…å®¹\nDriverå¯åŠ¨ Driverç”¨äºé©±åŠ¨çŠ¶æ€æœºï¼Œè°ƒç”¨Driver.drive()ä¹‹åï¼Œå°±ä¼šä¸æ–­å¤„ç†ç”±Raftæ¨¡å—å‘é€è€Œæ¥çš„Instructionï¼ŒDriver.drive()ä¼šåœ¨Node.new()å½“ä¸­è°ƒç”¨ï¼Œéšç€Nodeçš„åˆ›å»ºä¸€åŒå¯åŠ¨\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 impl Node { /// Creates a new Raft node, starting as a follower, or leader if no peers. pub async fn new( id: NodeID, peers: HashSet\u0026lt;NodeID\u0026gt;, mut log: Log, mut state: Box\u0026lt;dyn State\u0026gt;, node_tx: mpsc::UnboundedSender\u0026lt;Message\u0026gt;, ) -\u0026gt; Result\u0026lt;Self\u0026gt; { let (state_tx, state_rx) = mpsc::unbounded_channel(); // Driverç”¨äºå’ŒRaftçŠ¶æ€æœºè¿›è¡Œäº¤äº’ï¼Œå¯åŠ¨çŠ¶æ€æœºè¿è¡Œ let mut driver = Driver::new(id, state_rx, node_tx.clone()); driver.apply_log(\u0026amp;mut *state, \u0026amp;mut log)?; tokio::spawn(driver.drive(state)); let (term, voted_for) = log.get_term()?; let mut node = RoleNode { id, peers, term, log, node_tx, state_tx, role: Follower::new(None, voted_for), }; if node.peers.is_empty() { info!(\u0026#34;No peers specified, starting as leader\u0026#34;); // If we didn\u0026#39;t vote for ourself in the persisted term, bump the // term and vote for ourself to ensure we have a valid leader term. if voted_for != Some(id) { node.term += 1; node.log.set_term(node.term, Some(id))?; } let (last_index, _) = node.log.get_last_index(); Ok(node.become_role(Leader::new(HashSet::new(), last_index)).into()) } else { Ok(node.into()) } } } ä¿¡æ¯ä¼ é€’ RaftçŠ¶æ€æœºå’ŒRaftæ¨¡å—ä¹‹é—´ä½¿ç”¨Messageå’ŒInstructionè¿›è¡Œäº¤äº’ï¼ŒRaftæ¨¡å—å‘RaftçŠ¶æ€æœºå‘é€Instructionï¼ŒRaftçŠ¶æ€æœºå›åº”Messageç»™Raftæ¨¡å—ï¼ŒMessageçš„å‘é€å®šä¹‰å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 /// Sends a message. /// çŠ¶æ€æœºä½¿ç”¨node_txè¿›è¡Œæ¶ˆæ¯å‘é€ï¼Œé‚£ä¹ˆå¯¹åº”çš„æ¥æ”¶ç«¯å°±æ˜¯node_rx fn send(\u0026amp;self, to: Address, event: Event) -\u0026gt; Result\u0026lt;()\u0026gt; { // TODO: This needs to use the correct term. let msg = Message { from: Address::Node(self.node_id), to, term: 0, event }; debug!(\u0026#34;Sending {:?}\u0026#34;, msg); Ok(self.node_tx.send(msg)?) } Follower å¦‚6.824ä¸€æ ·ï¼ŒFollowerå½“ç„¶ä¹Ÿæ˜¯æœ‰çŠ¶æ€æœºçš„ï¼Œåªä¸è¿‡å½“ä¸­çš„é€»è¾‘éå¸¸ç®€å•ï¼Œå°±æ²¡æœ‰é¢å¤–ä»‹ç»ï¼ŒFolloweråªéœ€è¦ä¸æ–­çš„æ¥å—æ—¥å¿—ï¼Œç„¶åæ›´æ–°commit_indexç„¶åå‘çŠ¶æ€æœºå‘é€Instruction::Applyå°±å¥½ï¼Œä»£ç åœ¨ä¸Šæ–‡ä¹Ÿæœ‰å±•ç¤ºã€‚\nSummary åœ¨toydbå½“ä¸­ï¼Œç›¸æ¯”äºMIT-6.824å®ç°äº†ä¸€ä¸ªæ¯”è¾ƒçº¯ç²¹çš„çŠ¶æ€æœºï¼Œåªéœ€è¦ä»¥Raftæ¨¡å—å‘é€çš„Instructionä½œä¸ºè¾“å…¥ï¼Œå†…éƒ¨è¿›è¡ŒçŠ¶æ€æ›´æ–°ï¼Œä¹‹åä»¥Messageä¸ºè¾“å‡ºå³å¯ï¼Œä¸»è¦èµ·åˆ°äº†ä¸€ä¸ªè®°å½•å’Œé€»è¾‘åˆ¤æ–­ï¼Œé€šçŸ¥çš„ä½œç”¨ï¼Œä¸ä¼šè¿›è¡Œå¯¹å¤–çš„ç½‘ç»œäº¤äº’ã€‚Leaderåœ¨çŠ¶æ€æœºçš„æŒ‡ç¤ºä¸‹å»å›åº”Clientï¼Œå®Œæˆä¸€æ¡è¯·æ±‚çš„æ‰§è¡Œã€‚\n","permalink":"https://fischer0522.github.io/en/posts/tech/toydb/04-raft-state-machine/","summary":"åœ¨æ­£å¼å†™è¿™ä¸€ç¯‡æ–‡ç« ä¹‹å‰ï¼ŒåŸæœ¬çš„è§„åˆ’æ˜¯åœ¨è¿™ä¸€éƒ¨åˆ†ä»‹ç»sqlæ‰§è¡Œå¼•æ“ï¼Œå³å¦‚ä½•å°†Raftï¼ŒRaftçŠ¶æ€æœºï¼Œå­˜å‚¨å¼•æ“ç»„åˆèµ·æ¥ï¼Œä¸ºSQLçš„æ‰§è¡Œå»æä¾›æ”¯","title":"04-Raft State Machine"},{"content":"toydbçš„Raftå®ç°ï¼Œç›¸æ¯”äº6.824æ›´æ¥è¿‘äºç”Ÿäº§çº§åˆ«çš„ï¼Œå’Œetcd/raftåœ¨ç»“æ„ä¸Šæ¯”è¾ƒç›¸ä¼¼ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰å®ç°Raftå¤§è®ºæ–‡å½“ä¸­çš„ä¼˜åŒ–ï¼Œå¹¶ä¸”ç›¸æ¯”Raftå°è®ºæ–‡ä¹Ÿç æ‰äº†ä¸€äº›ä¼˜åŒ–ï¼Œæ¯”å¦‚fast backup,snapshotç­‰ã€‚ä¸è¿‡åœ¨å†™æ³•ä¸Šè¿˜æ˜¯å¾ˆæœ‰rustçš„å‘³é“çš„ã€‚å¯ä»¥åˆ†ä¸ºä¸€ä¸‹å‡ ä¸ªæ¨¡å—ï¼š\nNodeï¼šåˆ†åˆ«å®šä¹‰Leaderã€Candidateã€Followerå„è‡ªçš„è¡Œä¸ºå’Œé€šç”¨çš„è¡Œä¸º(å®šä¹‰åœ¨mod.rså½“ä¸­) logï¼šä»¥kv engineä½œä¸ºåº•å±‚ï¼ŒæŒä¹…åŒ–å­˜å‚¨Raftçš„logï¼ŒåŒæ—¶ä¹Ÿä¼šç”¨äºæŒä¹…åŒ–å­˜å‚¨å…ƒæ•°æ®ï¼Œæ‰€æœ‰éœ€è¦è¿›è¡ŒæŒä¹…åŒ–å­˜å‚¨çš„éƒ½ä¼šä½¿ç”¨logæ¨¡å— Stateï¼šRaftçŠ¶æ€æœºï¼Œæ„å»ºäºRaftä¹‹ä¸Šï¼Œç›¸å½“äº6.824å½“ä¸­çš„Lab3 Serverï¼šé€šä¿¡æ¨¡å—ï¼Œè´Ÿè´£ä¸å…¶ä»–RaftèŠ‚ç‚¹ä¹‹é—´è¿›è¡Œé€šä¿¡ï¼ŒåŸºäºtcpå®ç° åœ¨æœ¬ç« å½“ä¸­ï¼Œç¬”è€…ä¼šé¦–å…ˆåˆ†ætoydbå½“ä¸­çš„Raftçš„ä¸€äº›åŸºç¡€æ¨¡å—ï¼Œä¹‹åå†æŒ‰ç…§é€‰ä¸¾å’Œæ—¥å¿—å¤åˆ¶çš„é€»è¾‘æ¥è¿›è¡Œåˆ†æRaftçš„é€»è¾‘ã€‚å¯¹äºRaftæœ¬èº«ï¼Œç¬”è€…ä¸ä¼šåšè¿‡å¤šä»‹ç»ï¼Œå¦‚æœæƒ³äº†è§£Raftæœ¬èº«å»ºè®®çœ‹Raftå°è®ºæ–‡/å¤§è®ºæ–‡ï¼Œ6.824 raft.pdf web.stanford.edu/~ouster/cgi-bin/papers/OngaroPhD.pdf Message åœ¨toydbå½“ä¸­ï¼ŒRaftæ¨¡å—ä½¿ç”¨Eventä½œä¸ºäº‹ä»¶çš„è½½ä½“ï¼Œè€ŒMessageä¸ºEventçš„å°è£…ï¼Œæ•´ä¸ªRaftçš„æ‰§è¡Œè¿‡ç¨‹å°±æ˜¯ä¸æ–­å¤„ç†Messageçš„è¿‡ç¨‹ï¼Œè¿™ä¸etcdå½“ä¸­çš„è®¾è®¡éå¸¸ç›¸ä¼¼ï¼Œæ‰€ä»¥å…ˆæ¥çœ‹ä¸€ä¸‹Messageç›¸å…³å†…å®¹ï¼Œå®šä¹‰åœ¨src/raft/message.rså½“ä¸­ã€‚\nMessageçš„å‘é€ç›®æ ‡é‡‡ç”¨ä¸€ä¸ªæšä¸¾æ¥è¡¨ç¤º\nBroadcastï¼šä¸ºå¹¿æ’­ç±»å‹ï¼Œéœ€è¦å‘é€ç»™æ‰€æœ‰çš„èŠ‚ç‚¹ Nodeï¼šä¸ºå•ç‹¬å‘é€ï¼ŒæŒ‡å®šNodeIDï¼Œåœ¨ä¸Šå±‚ç½‘ç»œæ¨¡å—å†è½¬æ¢æˆipè¿›è¡Œå‘é€ Clientï¼šç”¨äºå›å¤Client 1 2 3 4 5 6 7 8 9 10 11 #[derive(Clone, Copy, Debug, Eq, Hash, PartialEq, Serialize, Deserialize)] pub enum Address { /// Broadcast to all peers. Only valid as an outbound recipient (to). Broadcast, /// A node with the specified node ID (local or remote). Valid both as /// sender and recipient. Node(NodeID), /// A local client. Can only send ClientRequest messages, and receive /// ClientResponse messages. Client, } Messageå®šä¹‰ä¸ºä¸€ä¸ªç»“æ„ä½“,å…¶ä¸­åŒ…å«å‘é€Messageæ—¶çš„Termï¼Œå‘é€æ–¹ä¸æ¥æ”¶æ–¹ï¼Œä»¥åŠEvent\n1 2 3 4 5 6 7 8 9 10 11 12 13 /// A message passed between Raft nodes. #[derive(Clone, Debug, PartialEq, Serialize, Deserialize)] pub struct Message { /// The current term of the sender. Must be set, unless the sender is /// Address::Client, in which case it must be 0. pub term: Term, /// The sender address. pub from: Address, /// The recipient address. pub to: Address, /// The message payload. pub event: Event, } Messageçš„ä¸»ä½“æ˜¯Eventï¼ŒEventå®šä¹‰ä¸ºä¸€ä¸ªæšä¸¾ç±»å‹ï¼Œåœ¨å…¶ä¸­è¡¨ç¤ºäº†Raftå½“ä¸­çš„æ‰€æœ‰äº‹ä»¶ï¼Œå¦‚æœéœ€è¦é¢å¤–çš„ä¿¡æ¯ï¼Œå°±å°è£…æˆä¸€ä¸ªç»“æ„ä½“ï¼Œå¦åˆ™è®¾ç½®æˆä¸€ä¸ªæšä¸¾å­—æ®µå³å¯ã€‚å¦‚å¿ƒè·³ä¿¡æ¯ï¼Œcandidateå¼€å¯é€‰ä¸¾ç­‰ç­‰ï¼Œåœ¨ä»£ç å½“ä¸­æ¯ä¸€ç§ç±»å‹éƒ½ç»™å‡ºäº†è¯¦ç»†çš„æ³¨é‡Šï¼Œè¯»è€…å¯è‡ªè¡Œé˜…è¯»\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 #[derive(Clone, Debug, PartialEq, Serialize, Deserialize)] pub enum Event { /// Leaders send periodic heartbeats to its followers. Heartbeat { /// The index of the leader\u0026#39;s last committed log entry. commit_index: Index, /// The term of the leader\u0026#39;s last committed log entry. commit_term: Term, }, /// Followers confirm loyalty to leader after heartbeats. ConfirmLeader { /// The commit_index of the original leader heartbeat, to confirm /// read requests. commit_index: Index, /// If false, the follower does not have the entry at commit_index /// and would like the leader to replicate it. has_committed: bool, }, /// Candidates solicit votes from all peers when campaigning for leadership. SolicitVote { // The index of the candidate\u0026#39;s last stored log entry last_index: Index, // The term of the candidate\u0026#39;s last stored log entry last_term: Term, }, /// Followers may grant a single vote to a candidate per term, on a /// first-come basis. Candidates implicitly vote for themselves. GrantVote, /// Leaders replicate log entries to followers by appending it to their log. AppendEntries { /// The index of the log entry immediately preceding the submitted commands. base_index: Index, /// The term of the log entry immediately preceding the submitted commands. base_term: Term, /// Commands to replicate. entries: Vec\u0026lt;Entry\u0026gt;, }, /// Followers may accept a set of log entries from a leader. AcceptEntries { /// The index of the last log entry. last_index: Index, }, /// Followers may also reject a set of log entries from a leader. RejectEntries, /// A client request. This can be submitted to the leader, or to a follower /// which will forward it to its leader. If there is no leader, or the /// leader or term changes, the request is aborted with an Error::Abort /// ClientResponse and the client must retry. ClientRequest { /// The request ID. This is arbitrary, but must be globally unique for /// the duration of the request. id: RequestID, /// The request. request: Request, }, /// A client response. ClientResponse { /// The response ID. This matches the ID of the ClientRequest. id: RequestID, /// The response, or an error. response: Result\u0026lt;Response\u0026gt;, }, } å¯¹æ¯”ä¸€ä¸‹etcdå½“ä¸­çš„Messageç±»å‹,åœ¨rustå½“ä¸­ä½¿ç”¨enum Eventè¿›è¡Œå°è£…æ˜¯ä¸æ˜¯ç®€æ´å¾ˆå¤šå‘¢ï¼ŒeventåŒä¸€äº‹ä»¶åªä¼šæœ‰ä¸€ç§ç±»å‹å’Œæ•°æ®ï¼Œé¿å…æºå¸¦ä¸å¿…è¦çš„æ•°æ®ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 type Message struct { Type MessageType `protobuf:\u0026#34;varint,1,opt,name=type,enum=raftpb.MessageType\u0026#34; json:\u0026#34;type\u0026#34;` To uint64 `protobuf:\u0026#34;varint,2,opt,name=to\u0026#34; json:\u0026#34;to\u0026#34;` From uint64 `protobuf:\u0026#34;varint,3,opt,name=from\u0026#34; json:\u0026#34;from\u0026#34;` Term uint64 `protobuf:\u0026#34;varint,4,opt,name=term\u0026#34; json:\u0026#34;term\u0026#34;` // logTerm is generally used for appending Raft logs to followers. For example, // (type=MsgApp,index=100,logTerm=5) means leader appends entries starting at // index=101, and the term of entry at index 100 is 5. // (type=MsgAppResp,reject=true,index=100,logTerm=5) means follower rejects some // entries from its leader as it already has an entry with term 5 at index 100. LogTerm uint64 `protobuf:\u0026#34;varint,5,opt,name=logTerm\u0026#34; json:\u0026#34;logTerm\u0026#34;` Index uint64 `protobuf:\u0026#34;varint,6,opt,name=index\u0026#34; json:\u0026#34;index\u0026#34;` Entries []Entry `protobuf:\u0026#34;bytes,7,rep,name=entries\u0026#34; json:\u0026#34;entries\u0026#34;` Commit uint64 `protobuf:\u0026#34;varint,8,opt,name=commit\u0026#34; json:\u0026#34;commit\u0026#34;` Snapshot Snapshot `protobuf:\u0026#34;bytes,9,opt,name=snapshot\u0026#34; json:\u0026#34;snapshot\u0026#34;` Reject bool `protobuf:\u0026#34;varint,10,opt,name=reject\u0026#34; json:\u0026#34;reject\u0026#34;` RejectHint uint64 `protobuf:\u0026#34;varint,11,opt,name=rejectHint\u0026#34; json:\u0026#34;rejectHint\u0026#34;` Context []byte `protobuf:\u0026#34;bytes,12,opt,name=context\u0026#34; json:\u0026#34;context,omitempty\u0026#34;` } Node Nodeè¿™ä¸€éƒ¨åˆ†è¡¨ç¤ºåœ¨Raftè¿è¡Œè¿‡ç¨‹ä¸­ï¼ŒRaftèŠ‚ç‚¹çš„è§’è‰²å’Œæ‰§è¡ŒåŠ¨ä½œï¼Œåœ¨è¿™ä¸€éƒ¨åˆ†ä»…ç®€å•ä»‹ç»æ¶‰åŠåˆ°çš„ç»“æ„ä½“ï¼Œè€Œæ‰§è¡Œé€»è¾‘åˆ†ä¸ºé€‰ä¸¾å’Œæ—¥å¿—å¤åˆ¶ä¸¤éƒ¨åˆ†è¿›è¡Œåˆ†æã€‚\ntoydbå½“ä¸­ä½¿ç”¨RoleNodeæ¥è¡¨ç¤ºèŠ‚ç‚¹çš„çŠ¶æ€å’Œè§’è‰²,å…¶ä¸­:\nlogä¸ºä¸€ä¸ªä¸kv engineäº¤äº’çš„æ¨¡å—ï¼Œè´Ÿè´£æ‰€æœ‰æŒä¹…åŒ–å­˜å‚¨çš„å·¥ä½œ node_txç”¨äºè¿›è¡ŒèŠ‚ç‚¹ä¹‹é—´çš„é€šä¿¡(èŠ‚ç‚¹ä¹‹é—´çœŸå®ä¼ è¾“ä½¿ç”¨çš„æ˜¯tcpï¼Œè¿™ä¸ªmpscæ›´åƒæ˜¯ä¸€ä¸ªä¿¡ç®±ï¼Œå°†Messageæ·»åŠ åˆ°å…¶ä¸­ï¼Œç­‰å¾…ä¹‹åå‘é€ï¼Œè¿™ä¸€éƒ¨åˆ†çš„è®¾è®¡ä¹Ÿä¸etcdç›¸åŒï¼Œä¸è¿‡etcdæ˜¯ä¸€ä¸ªæ‰¹å¤„ç†çš„å½¢å¼ï¼Œä¼šæ”’ä¸€æ³¢æ¶ˆæ¯ä¸€åŒå‘é€) state_txç”¨äºä¸ä¸Šå±‚çŠ¶æ€æœºè¿›è¡Œé€šä¿¡ 1 2 3 4 5 6 7 8 9 10 // A Raft node with role R pub struct RoleNode\u0026lt;R\u0026gt; { id: NodeID, peers: HashSet\u0026lt;NodeID\u0026gt;, term: Term, log: Log, node_tx: mpsc::UnboundedSender\u0026lt;Message\u0026gt;, state_tx: mpsc::UnboundedSender\u0026lt;Instruction\u0026gt;, role: R, } Roleä»£è¡¨å½“å‰èŠ‚ç‚¹çš„è§’è‰²ï¼Œåˆ†åˆ«æœ‰Leaderã€Candidateã€Followerï¼Œå°è£…äº†ä¸€äº›æ¯ç§ä¸åŒè§’è‰²ç‰¹æœ‰çš„å†…å®¹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 pub struct Leader { /// Peer replication progress. progress: HashMap\u0026lt;NodeID, Progress\u0026gt;, /// Number of ticks since last periodic heartbeat. since_heartbeat: Ticks, } pub struct Follower { /// The leader, or None if just initialized. leader: Option\u0026lt;NodeID\u0026gt;, /// The number of ticks since the last message from the leader. leader_seen: Ticks, /// The leader_seen timeout before triggering an election. election_timeout: Ticks, /// The node we voted for in the current term, if any. voted_for: Option\u0026lt;NodeID\u0026gt;, // Local client requests that have been forwarded to the leader. These are // aborted on leader/term changes. pub(super) forwarded: HashSet\u0026lt;RequestID\u0026gt;, } pub struct Candidate { /// Votes received (including ourself). votes: HashSet\u0026lt;NodeID\u0026gt;, /// Ticks elapsed since election start. election_duration: Ticks, /// Election timeout, in ticks. election_timeout: Ticks, } åœ¨RoleNodeå½“ä¸­ï¼Œé…å¤‡äº†å‡ ä¸ªåŸºç¡€çš„å‡½æ•°ï¼Œåé¢æµç¨‹ä¸­å¯èƒ½ç”¨åˆ°ï¼Œå…ˆæä¸€ä¸‹ï¼Œéƒ½æ¯”è¾ƒç®€å•ï¼š\nbecome_role():åˆ‡æ¢è§’è‰²ï¼Œæ›´æ–°role quorum():è®¡ç®—é›†ç¾¤â€œå¤§å¤šæ•°â€çš„æ•°é‡ send():å°†Messageå¡å…¥ä¿¡ç®±å½“ä¸­ï¼Œä¹‹åä¼šè¢«è¯»å–å¹¶å‘é€ assert_node():æ£€æŸ¥å½“å‰çš„termä¸æŒä¹…åŒ–å­˜å‚¨çš„termæ˜¯å¦ç›¸åŒ assert_step():åœ¨stepå‡½æ•°å¤„ç†Messageä¹‹å‰å…ˆå¯¹Messageè¿›è¡Œæ ¡éªŒ æ£€æŸ¥Messageçš„æ¥æ”¶æ–¹ï¼šåˆ¤æ–­æ˜¯å¦åº”è¯¥ç”±å½“å‰èŠ‚ç‚¹å¤„ç†ï¼Œstepå‡½æ•°ä¸åº”è¯¥å¤„ç†å‘é€ç»™clientçš„Messageå’Œä¸å±äºè‡ªå·±çš„Message æ£€æŸ¥Messageçš„å‘é€æ–¹ï¼šä¸åº”è¯¥æœ‰Broadcastç±»å‹çš„å‘é€æ–¹ï¼ŒBroadcaståªåº”è¯¥ä½œä¸ºæ¥æ”¶æ–¹å­˜åœ¨ï¼›å¯¹clientå‘é€çš„Messageè¿›è¡Œæ£€æŸ¥ï¼›æ£€æŸ¥ç”±å…¶ä»–èŠ‚ç‚¹å‘é€è€Œæ¥çš„æ¶ˆæ¯ï¼Œè¯¥èŠ‚ç‚¹æ˜¯å¦‡å¥³å­˜åœ¨äºé›†ç¾¤å½“ä¸­ï¼Œä»¥åŠéœ€è¦æºå¸¦term è§’è‰²åˆ‡æ¢ Leader\nLeaderåªæœ‰ä¸€ç§è§’è‰²åˆ‡æ¢ï¼Œå³æ¥æ”¶åˆ°æ›´é«˜çš„termä»è€Œé€€ä½ï¼Œè½¬æ¢æˆfollowerï¼Œå®šä¹‰åœ¨RoleNode\u0026lt;Leader\u0026gt;.become_follower()å½“ä¸­,ç”±äºå› ä¸ºæ£€æµ‹åˆ°æ›´é«˜çš„termï¼Œå› æ­¤éœ€è¦æ›´æ–°è‡ªèº«çš„termå¹¶è¿›è¡ŒæŒä¹…åŒ–çš„å·¥ä½œï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 /// Transforms the leader into a follower. This can only happen if we find a /// new term, so we become a leaderless follower. fn become_follower(mut self, term: Term) -\u0026gt; Result\u0026lt;RoleNode\u0026lt;Follower\u0026gt;\u0026gt; { assert!(term \u0026gt;= self.term, \u0026#34;Term regression {} -\u0026gt; {}\u0026#34;, self.term, term); assert!(term \u0026gt; self.term, \u0026#34;Can only become follower in later term\u0026#34;); info!(\u0026#34;Discovered new term {}\u0026#34;, term); self.term = term; self.log.set_term(term, None)?; self.state_tx.send(Instruction::Abort)?; Ok(self.become_role(Follower::new(None, None))) } Candidate\ncandidateåœ¨è¾“æ‰é€‰ä¸¾ä¹‹åæˆ–è€…æ¥æ”¶åˆ°æ›´é«˜çš„Termå°±ä¼šè½¬æ¢ä¸ºFollowerï¼š\nåœ¨è¾“æ‰é€‰ä¸¾æ—¶ï¼Œä¼šæ¥æ”¶åˆ°æ–°çš„Leaderçš„Heartbeatï¼Œå› æ­¤å¯ä»¥çŸ¥é“æ–°çš„Leaderæ˜¯è°ï¼Œæ›´æ–°è‡ªèº«çŠ¶æ€æ—¶å°†å½“å‰çš„Leaderä¿å­˜ æ¥æ”¶åˆ°æ›´é«˜Termæ—¶ï¼Œæœ‰å¯èƒ½åªæ˜¯å…¶ä»–è¿›åº¦æ›´æ–°çš„Followerç»™äºˆçš„å›åº”ï¼Œå› æ­¤æ— æ³•å¾—çŸ¥Leaderæ˜¯è° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 /// Transforms the node into a follower. We either lost the election /// and follow the winner, or we discovered a new term in which case /// we step into it as a leaderless follower. fn become_follower(mut self, term: Term, leader: Option\u0026lt;NodeID\u0026gt;) -\u0026gt; Result\u0026lt;RoleNode\u0026lt;Follower\u0026gt;\u0026gt; { assert!(term \u0026gt;= self.term, \u0026#34;Term regression {} -\u0026gt; {}\u0026#34;, self.term, term); if let Some(leader) = leader { // We lost the election, follow the winner. assert_eq!(term, self.term, \u0026#34;Can\u0026#39;t follow leader in different term\u0026#34;); info!(\u0026#34;Lost election, following leader {} in term {}\u0026#34;, leader, term); let voted_for = Some(self.id); // by definition Ok(self.become_role(Follower::new(Some(leader), voted_for))) } else { // We found a new term, but we don\u0026#39;t necessarily know who the leader // is yet. We\u0026#39;ll find out when we step a message from it. assert_ne!(term, self.term, \u0026#34;Can\u0026#39;t become leaderless follower in current term\u0026#34;); info!(\u0026#34;Discovered new term {}\u0026#34;, term); self.term = term; self.log.set_term(term, None)?; Ok(self.become_role(Follower::new(None, None))) } } candidateå¦‚æœèƒ½å¤ŸæˆåŠŸå½“é€‰ï¼Œé‚£ä¹ˆå°±å¯ä»¥è½¬æ¢ä¸ºLeaderï¼Œä¸Šçº¿ä¹‹åå‘é€å¿ƒè·³ä¿¡æ¯å¹¶ä¸”è¿½åŠ ä¸€æ¡non-opï¼Œï¼Œè¿½åŠ çš„non-opçš„åŸå› åœ¨raftè®ºæ–‡å½“ä¸­ä½œå‡ºäº†è§£é‡Šï¼Œè¿™é‡Œç®€å•æä¸€ä¸‹ï¼ŒRaftä¸èƒ½å¤Ÿæäº¤è‡ªå·±ä»»æœŸä»¥å¤–çš„æ—¥å¿—ï¼Œåªèƒ½å¤Ÿåœ¨æäº¤å½“å‰ä»»æœŸçš„æ—¥å¿—æ—¶é¡ºå¸¦æäº¤ä¹‹å‰çš„æ—¥å¿—ï¼Œå¦åˆ™ä¼šå‡ºç°æäº¤æ—¥å¿—è¢«è¦†ç›–çš„å®‰å…¨æ€§é—®é¢˜(å…·ä½“æ ·ä¾‹è§è®ºæ–‡figure 8)ï¼Œå¦‚æœå¼€å¯read indexçº¿æ€§ä¸€è‡´æ€§è¯»ä¼˜åŒ–çš„æƒ…å†µä¸‹ï¼Œç³»ç»Ÿå¦‚æœä¸æ”¶åˆ°å†™è¯·æ±‚å°±æ— æ³•æäº¤ä¹‹å‰çš„æ—¥å¿—ï¼Œä»è€Œé˜»å¡ç³»ç»ŸçŠ¶æ€(è¯»å†™éƒ½ä¼šè¢«é˜»å¡ï¼Œread index éœ€è¦Leaderåœ¨å½“å‰ä»»æœŸæäº¤è¿‡æ—¥å¿—ä¹‹åæ‰èƒ½æ‰§è¡Œ)ï¼Œnon-opå¯ä»¥å°½å¿«æ¢å¤ç³»ç»ŸçŠ¶æ€ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 /// Transition to leader role. fn become_leader(self) -\u0026gt; Result\u0026lt;RoleNode\u0026lt;Leader\u0026gt;\u0026gt; { info!(\u0026#34;Won election for term {}, becoming leader\u0026#34;, self.term); let peers = self.peers.clone(); let (last_index, _) = self.log.get_last_index(); let mut node = self.become_role(Leader::new(peers, last_index)); node.heartbeat()?; // Propose an empty command when assuming leadership, to disambiguate // previous entries in the log. See section 8 in the Raft paper. node.propose(None)?; Ok(node) } Follower\nFolloweråœ¨é€‰ä¸¾è¶…æ—¶æ—¶ä¼šè½¬æ¢ä¸ºCandidateï¼Œå¹¶ä¸”è°ƒç”¨compaign()å¼€å§‹é€‰ä¸¾ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 fn become_candidate(mut self) -\u0026gt; Result\u0026lt;RoleNode\u0026lt;Candidate\u0026gt;\u0026gt; { // Abort any forwarded requests. These must be retried with new leader. self.abort_forwarded()?; let mut node = self.become_role(Candidate::new()); node.campaign()?; Ok(node) } /// Processes a logical clock tick. pub fn tick(mut self) -\u0026gt; Result\u0026lt;Node\u0026gt; { self.assert()?; self.role.leader_seen += 1; if self.role.leader_seen \u0026gt;= self.role.election_timeout { return Ok(self.become_candidate()?.into()); } Ok(self.into()) } Followeråœ¨æ¥å—åˆ°Leaderçš„Heartbeatã€AppendEntriesæ—¶ï¼Œæˆ–è€…æ›´é«˜çš„Termçš„æ¶ˆæ¯æ—¶ï¼Œéƒ½ä¼šæ›´æ–°è‡ªèº«çŠ¶æ€è¿›è¡Œè·Ÿéš\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 /// Transforms the node into a follower, either a leaderless follower in a /// new term or following a leader in the current term. fn become_follower(mut self, leader: Option\u0026lt;NodeID\u0026gt;, term: Term) -\u0026gt; Result\u0026lt;RoleNode\u0026lt;Follower\u0026gt;\u0026gt; { assert!(term \u0026gt;= self.term, \u0026#34;Term regression {} -\u0026gt; {}\u0026#34;, self.term, term); // Abort any forwarded requests. These must be retried with new leader. self.abort_forwarded()?; if let Some(leader) = leader { // We found a leader in the current term. assert_eq!(self.role.leader, None, \u0026#34;Already have leader in term\u0026#34;); assert_eq!(term, self.term, \u0026#34;Can\u0026#39;t follow leader in different term\u0026#34;); info!(\u0026#34;Following leader {} in term {}\u0026#34;, leader, term); self.role = Follower::new(Some(leader), self.role.voted_for); } else { // We found a new term, but we don\u0026#39;t necessarily know who the leader // is yet. We\u0026#39;ll find out when we step a message from it. assert_ne!(term, self.term, \u0026#34;Can\u0026#39;t become leaderless follower in current term\u0026#34;); info!(\u0026#34;Discovered new term {}\u0026#34;, term); self.term = term; self.log.set_term(term, None)?; self.role = Follower::new(None, None); } Ok(self) } æ¶ˆæ¯è½¬å‘ åœ¨toydbå½“ä¸­ï¼ŒFolloweræ˜¯å…è®¸å’ŒClienté€šä¿¡çš„ï¼Œä½†æ˜¯ä¸èƒ½å¤Ÿå¤„ç†ä¿¡æ¯ï¼ŒFolloweréœ€è¦å°†æ¶ˆæ¯è½¬å‘ç»™Leaderï¼ŒLeaderå¤„ç†å®Œä¹‹åå†ç”±Followerå“åº”Client,è¿™ä¸€éƒ¨åˆ†çš„é€»è¾‘åœ¨follower.step()å½“ä¸­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 // Forward client requests to the leader, or abort them if there is // none (the client must retry). Event::ClientRequest { ref id, .. } =\u0026gt; { if msg.from != Address::Client { error!(\u0026#34;Received client request from non-client {:?}\u0026#34;, msg.from); return Ok(self.into()); } let id = id.clone(); if let Some(leader) = self.role.leader { debug!(\u0026#34;Forwarding request to leader {}: {:?}\u0026#34;, leader, msg); self.role.forwarded.insert(id); self.send(Address::Node(leader), msg.event)? } else { self.send(msg.from, Event::ClientResponse { id, response: Err(Error::Abort) })? } } // Returns client responses for forwarded requests. // æ¥æ”¶åˆ°clientçš„æ¶ˆæ¯ä¹‹åï¼Œè½¬å‘ç»™leaderï¼Œleaderå¤„ç†å®Œä¹‹åå†å›åº”follower // ä¹‹åç»§ç»­ç”±followerå»å“åº”ç»™clientï¼Œè¿™é‡Œä¸ºä»€ä¹ˆä¸å‘ŠçŸ¥client çœŸæ­£çš„Leaderæ˜¯ä»€ä¹ˆï¼Ÿ Event::ClientResponse { id, mut response } =\u0026gt; { if !self.is_leader(\u0026amp;msg.from) { error!(\u0026#34;Received client response from non-leader {:?}\u0026#34;, msg.from); return Ok(self.into()); } // TODO: Get rid of this field, it should be returned at the RPC // server level instead. if let Ok(Response::Status(ref mut status)) = response { status.server = self.id; } // å¤„ç†å®Œå°±å¯ä»¥ä»è¯·æ±‚é˜Ÿåˆ—å½“ä¸­ç§»é™¤ï¼Œå¹¶ä¸”å“åº”Client // è¯·æ±‚é˜Ÿåˆ—æ˜¯ç”¨äºè®°å½•Followeræ¥æ”¶åˆ°å¹¶ä¸”æœªå¤„ç†å®Œçš„ClientRequestï¼Œç”¨äºåœ¨é€šçŸ¥Leaderæ—¶ï¼Œå°±å¯ä»¥å°†è¿™äº›æœªå¤„ç†çš„è¯·æ±‚å…¨éƒ¨å‘ŠçŸ¥Client,è®©å…¶æ‰¾åˆ°Leaderå†å»é‡æ–°æ‰§è¡Œ if self.role.forwarded.remove(\u0026amp;id) { self.send(Address::Client, Event::ClientResponse { id, response })?; } } ä¸è¿‡Followeræ—¢ç„¶å·²ç»è½¬å‘ç»™Leaderå¹¶ä¸”æ­£ç¡®å¾—åˆ°å›åº”ï¼Œé‚£ä¹ˆå°±è¯´æ˜FollowerçŸ¥é“Leaderæ˜¯è°äº†ï¼Œæ­¤æ—¶å›å¤Clientæ—¶å¯ä»¥å‘ŠçŸ¥Clientå½“å‰èŠ‚ç‚¹ä¸æ˜¯Leaderï¼Œä¹‹åClientå°±å¯ä»¥æ‰¾Leaderå»é€šä¿¡ï¼Œä½†æ˜¯toydbå¹¶æ²¡æœ‰è¿™æ ·å®ç°ï¼Œå‘ŠçŸ¥Clientå½“å‰èº«ä»½è¿™ä¸ªè¿‡ç¨‹åœ¨toydbå½“ä¸­è¿›è¡Œäº†å•ç‹¬çš„å°è£…ï¼š\nåœ¨Followerèƒ½å¤Ÿç¡®è®¤Leaderæ—¶ï¼Œå¦‚ä»Leaderå¤„æ¥æ”¶åˆ°Heartbeatå’ŒAppendEntriesæ—¶ï¼Œå°±ä¼šè°ƒç”¨ä¸Šæ–‡çš„follower.become_follower()é‡ç½®çŠ¶æ€ï¼Œåœ¨è¿™ä¸ªå‡½æ•°é‡Œé¢ï¼Œä¼šè°ƒç”¨ä¸€ä¸ªabort_forwarded()ï¼Œåœ¨å…¶ä¸­ï¼Œä¼šä½¿ç”¨std::mem::takeå°†role.forwardedç»™é‡ç½®ï¼Œå¹¶ä¸”éå†å…¶ä¸­æœªå¤„ç†çš„æ¶ˆæ¯ï¼Œä¾æ¬¡å‘ŠçŸ¥Errorï¼Œä¹‹åClientå†è¿›è¡Œé‡è¯•ã€‚\n1 2 3 4 5 6 7 8 /// Aborts all forwarded requests. fn abort_forwarded(\u0026amp;mut self) -\u0026gt; Result\u0026lt;()\u0026gt; { for id in std::mem::take(\u0026amp;mut self.role.forwarded) { debug!(\u0026#34;Aborting forwarded request {:x?}\u0026#34;, id); self.send(Address::Client, Event::ClientResponse { id, response: Err(Error::Abort) })?; } Ok(()) } åˆå§‹åŒ– åœ¨toydbå¯åŠ¨æ—¶ï¼Œä¼šè°ƒç”¨Server::new()æ¥åˆ›å»ºä¸€ä¸ªserverèŠ‚ç‚¹ï¼Œåœ¨å…¶ä¸­ï¼Œä¸€éƒ¨åˆ†åˆå§‹åŒ–ä¸clientè¿›è¡Œé€šä¿¡ï¼Œè€Œå¦ä¸€éƒ¨åˆ†åˆ™æ˜¯åˆå§‹åŒ–raftèŠ‚ç‚¹,åˆå§‹åŒ–å®Œæˆä¹‹åå°±ä¼šè°ƒç”¨serveæ¥æä¾›ç½‘ç»œæœåŠ¡ï¼Œå…¶ä¸­ä¼šè°ƒç”¨åˆ°raft.serve()æ¥å¯åŠ¨raftèŠ‚ç‚¹ï¼š\n1 2 3 4 5 6 7 // toydb.rs main Server::new(cfg.id, cfg.peers, raft_log, raft_state) .await? .listen(\u0026amp;cfg.listen_sql, \u0026amp;cfg.listen_raft) .await? .serve() .await åœ¨raft.serve()å½“ä¸­ï¼Œå°±ä¼šè°ƒç”¨raft.eventloop()æ­£å¼å¯åŠ¨raftæ¥æ”¶å’Œå¤„ç†äº‹ä»¶ï¼Œåœ¨eventloopå½“ä¸­ï¼Œä¼ å…¥äº†ä¸€ä¸ªchannelçš„å‘é€ç«¯ï¼Œåˆ›å»ºäº†ä¸‰ä¸ªchannelï¼š\ntcp_tx:raftèŠ‚ç‚¹ä¹‹é—´ç›¸äº’äº¤æµçš„å‘é€ç«¯ï¼Œç”¨äºå°†åº•å±‚nodeå¡å…¥ä¿¡ç®±å½“ä¸­çš„Messageå‘é€ç»™å…¶ä»–çš„èŠ‚ç‚¹ node_rx:node Messageæ¶ˆæ¯çš„æ¥æ”¶ç«¯ï¼Œç”¨äºä»ä¸‹å±‚çš„raftå½“ä¸­æ¥æ”¶Messageï¼Œç„¶åäº¤ç»™tcp_txå»å‘é€ tcp_rx:raftèŠ‚ç‚¹ä¹‹é—´ç›¸äº’äº¤æµçš„æ¥æ”¶ç«¯ï¼Œæ¥æ”¶å…¶ä»–èŠ‚ç‚¹ä¼ æ¥çš„Messageï¼Œç„¶åäº¤ç»™è‡ªèº«çš„Raftå»æ‰§è¡Œ Client_rx: æ¥æ”¶ client å‘é€çš„ Messageï¼Œäº¤ç»™è‡ªèº«çš„ Raft å»æ‰§è¡Œï¼Œè¿™é‡Œçš„ client å¹¶ä¸æ˜¯ç”¨æˆ·çš„ clientï¼Œè€Œæ˜¯è¦æ‰§è¡Œå‘½ä»¤çš„ sql ç«¯ï¼Œsql ç«¯å¯¹äºè¦æ‰§è¡Œçš„å‘½ä»¤ï¼Œé¦–å…ˆä¼šäº¤ç»™ Raft æ¥è¿›è¡Œå…±è¯†ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯ä»¥ client-server ç»“æ„æ¥æ‰§è¡Œçš„ï¼Œsql ç«¯å……å½“ clientï¼Œraft-server å……å½“ serverã€‚ è¿™ä¸€éƒ¨åˆ†çš„é€»è¾‘ä¸»ä½“æ˜¯é€šè¿‡tokio::select!æ¥å®ç°çš„ï¼Œåœ¨é€»è¾‘ä¸Šä¸goå½“ä¸­çš„selectæ˜¯å·®ä¸å¤šçš„ï¼Œåªä¸è¿‡goçš„selectæ˜¯ç›‘å¬åŒæ­¥channelï¼Œè€Œtokio::select!æ˜¯ç­‰å¾…å¼‚æ­¥ä»»åŠ¡çš„æ‰§è¡Œå®Œæˆï¼Œåˆ†åˆ«ä»ä¸Šè¿°çš„ä¸‰ä¸ªchannelå½“ä¸­è·å–Messageï¼Œæ¨åŠ¨RaftèŠ‚ç‚¹ã€‚\né™¤äº†channelçš„é€šä¿¡ä¹‹å¤–ï¼Œselectå½“ä¸­è¿˜æœ‰ä¸€ä¸ªTickerï¼Œä»¥100msçš„é—´éš”è¿è¡Œï¼Œç”¨äºå°†ç‰©ç†æ—¶é’Ÿè½¬æ¢ä¸ºé€»è¾‘æ—¶é’Ÿï¼Œæä¾›ç»™ä¸‹å±‚ï¼Œé©±åŠ¨Raftã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 /// Runs the event loop. async fn eventloop( mut node: Node, node_rx: mpsc::UnboundedReceiver\u0026lt;Message\u0026gt;, client_rx: mpsc::UnboundedReceiver\u0026lt;(Request, oneshot::Sender\u0026lt;Result\u0026lt;Response\u0026gt;\u0026gt;)\u0026gt;, tcp_rx: mpsc::UnboundedReceiver\u0026lt;Message\u0026gt;, tcp_tx: mpsc::UnboundedSender\u0026lt;Message\u0026gt;, ) -\u0026gt; Result\u0026lt;()\u0026gt; { let mut node_rx = UnboundedReceiverStream::new(node_rx); let mut tcp_rx = UnboundedReceiverStream::new(tcp_rx); let mut client_rx = UnboundedReceiverStream::new(client_rx); let mut ticker = tokio::time::interval(TICK_INTERVAL); let mut requests = HashMap::\u0026lt;Vec\u0026lt;u8\u0026gt;, oneshot::Sender\u0026lt;Result\u0026lt;Response\u0026gt;\u0026gt;\u0026gt;::new(); loop { tokio::select! { // ç›‘å¬tickerï¼Œé©±åŠ¨ä¸‹å±‚Raftï¼Œé—´éš”ä¸º100ms _ = ticker.tick() =\u0026gt; node = node.tick()?, // è·å–ä»å…¶ä»–raftèŠ‚ç‚¹å‘é€è€Œæ¥çš„Messageï¼Œäº¤ç»™ä¸‹å±‚çš„Raftå»å¤„ç† Some(msg) = tcp_rx.next() =\u0026gt; node = node.step(msg)?, // è·å–ä¸‹å±‚Raftæ”¾å…¥ä¿¡ç®±çš„Messageï¼Œå‘é€ç»™å¯¹åº”çš„èŠ‚ç‚¹ Some(msg) = node_rx.next() =\u0026gt; { match msg { Message{to: Address::Node(_), ..} =\u0026gt; tcp_tx.send(msg)?, Message{to: Address::Broadcast, ..} =\u0026gt; tcp_tx.send(msg)?, Message{to: Address::Client, event: Event::ClientResponse{ id, response }, ..} =\u0026gt; { if let Some(response_tx) = requests.remove(\u0026amp;id) { response_tx .send(response) .map_err(|e| Error::Internal(format!(\u0026#34;Failed to send response {:?}\u0026#34;, e)))?; } } _ =\u0026gt; return Err(Error::Internal(format!(\u0026#34;Unexpected message {:?}\u0026#34;, msg))), } } // è·å–clientå‘é€çš„æ¶ˆæ¯ï¼Œäº¤ç»™ä¸‹å±‚å»å¤„ç†ï¼Œè¿™é‡Œçš„clientå¹¶ä¸æ˜¯ç”¨æˆ·çš„clientï¼Œè€Œæ˜¯è¦æ‰§è¡Œå‘½ä»¤çš„sqlç«¯ Some((request, response_tx)) = client_rx.next() =\u0026gt; { let id = Uuid::new_v4().as_bytes().to_vec(); let msg = Message{ from: Address::Client, to: Address::Node(node.id()), term: 0, event: Event::ClientRequest{id: id.clone(), request}, }; node = node.step(msg)?; requests.insert(id, response_tx); } } } } Leader Election Raftçš„é€‰ä¸¾è¿‡ç¨‹å—åˆ°Tickerçš„é©±åŠ¨ï¼Œå¦‚ä¸Šé¢æ‰€å±•ç¤ºçš„ï¼Œä¸Šå±‚serverå±‚ä¼šä»¥100msä¸ºé—´éš”å°†ç‰©ç†æ—¶é’Ÿè½¬æ¢ä¸ºé€»è¾‘æ—¶é’Ÿï¼Œä¸‹å±‚çš„tick()å®šä¹‰åœ¨mod.rså½“ä¸­,å¯¹äºä¸åŒè§’è‰²çš„èŠ‚ç‚¹ï¼Œåˆ†åˆ«è°ƒç”¨å¯¹åº”çš„tick()ï¼Œåœ¨é€‰ä¸¾å½“ä¸­ï¼Œå¯¹åº”çš„å°±æ˜¯Followerçš„tick()ï¼š\n1 2 3 4 5 6 7 8 9 /// Moves time forward by a tick. pub fn tick(self) -\u0026gt; Result\u0026lt;Self\u0026gt; { match self { Node::Candidate(n) =\u0026gt; n.tick(), Node::Follower(n) =\u0026gt; n.tick(), Node::Leader(n) =\u0026gt; n.tick(), } } åœ¨Followerçš„tick()å½“ä¸­,å¢å¤§election_durationï¼Œå¦‚æœè¶…å‡ºäº†é™åˆ¶ï¼Œå°±è½¬æ¢ä¸ºcandidateï¼Œå¼€å¯é€‰ä¸¾ï¼Œé€‰ä¸¾çš„å…¥å£ä¸ºself.compaign(),è¿™ä¸etcd/raftçš„å®ç°æ˜¯ä¸€è‡´çš„ã€‚\nåœ¨toydbå½“ä¸­è®¾ç½®çš„æ˜¯10-20ä¸ªé€»è¾‘æ—¶é’Ÿï¼Œå³1-2sçš„éšæœºæ—¶é—´ï¼Œè¿™é‡Œæ¯”è®ºæ–‡å½“ä¸­(150ms-300ms)è®¾ç½®çš„é•¿å¾ˆå¤šï¼Œå’Œetcdè®¾ç½®ä¸€è‡´ã€‚ä½†æ˜¯toydbçš„heartbeatä¸º3ä¸ªé€»è¾‘æ—¶é’Ÿï¼Œæ‰€ä»¥å…¶å®ä¹Ÿä¸ä¼šæœ‰å¤ªå¤§çš„é—®é¢˜\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 /// The interval between leader heartbeats, in ticks. const HEARTBEAT_INTERVAL: Ticks = 3; /// The randomized election timeout range (min-max), in ticks. This is /// randomized per node to avoid ties. const ELECTION_TIMEOUT_RANGE: std::ops::Range\u0026lt;u8\u0026gt; = 10..20; // Follower.tickï¼Œè½¬æ¢ä¸ºcandidate pub fn tick(mut self) -\u0026gt; Result\u0026lt;Node\u0026gt; { self.assert()?; self.role.leader_seen += 1; if self.role.leader_seen \u0026gt;= self.role.election_timeout { return Ok(self.become_candidate()?.into()); } Ok(self.into()) } // è½¬æ¢ä¸ºcandidateä¹‹åä¼šç«‹åˆ»å¼€å§‹é€‰ä¸¾ /// Transforms the node into a candidate, by campaigning for leadership in a /// new term. fn become_candidate(mut self) -\u0026gt; Result\u0026lt;RoleNode\u0026lt;Candidate\u0026gt;\u0026gt; { // Abort any forwarded requests. These must be retried with new leader. self.abort_forwarded()?; let mut node = self.become_role(Candidate::new()); node.campaign()?; Ok(node) } // Candidate.tickï¼Œåœ¨ç¬¬ä¸€æ¬¡é€‰ä¸¾å¤±è´¥ä¹‹åä¼šè°ƒç”¨åˆ° /// Processes a logical clock tick. pub fn tick(mut self) -\u0026gt; Result\u0026lt;Node\u0026gt; { self.assert()?; self.role.election_duration += 1; if self.role.election_duration \u0026gt;= self.role.election_timeout { self.campaign()?; } Ok(self.into()) } compaign\nåœ¨compaignå½“ä¸­ï¼Œé€»è¾‘æŒ‰ç…§å°è®ºæ–‡å½“ä¸­å®ç°ï¼š\nè‡ªå¢term ä¸ºè‡ªå·±æŠ•ä¸€ç¥¨ æŒä¹…åŒ–ä¿å­˜term å‘é€Messageï¼Œå‘å…¶ä»–çš„èŠ‚ç‚¹è¯·æ±‚æŠ•ç¥¨ï¼Œå‘é€ä¸€æ¡Eventç±»å‹ä¸ºSolicitVoteç±»å‹çš„Message 1 2 3 4 5 6 7 8 9 10 11 12 13 14 /// Campaign for leadership by increasing the term, voting for ourself, and /// soliciting votes from all peers. pub(super) fn campaign(\u0026amp;mut self) -\u0026gt; Result\u0026lt;()\u0026gt; { let term = self.term + 1; info!(\u0026#34;Starting new election for term {}\u0026#34;, term); self.role = Candidate::new(); self.role.votes.insert(self.id); // vote for ourself self.term = term; self.log.set_term(term, Some(self.id))?; let (last_index, last_term) = self.log.get_last_index(); self.send(Address::Broadcast, Event::SolicitVote { last_index, last_term })?; Ok(()) } SolicitVote\nSolicitVoteç±»å‹çš„Messageç”±å…¶ä»–çš„Followeræ¥å¤„ç†ï¼Œå¯¹äºæ‰€æœ‰Messageçš„å¤„ç†ï¼Œéƒ½å®šä¹‰åœ¨step()å½“ä¸­ï¼Œè¿™é‡Œé€»è¾‘å’Œä¸Šé¢ä¸€æ ·ï¼Œæ ¹æ®èŠ‚ç‚¹è§’è‰²å†å»è¿›è¡Œè°ƒç”¨ï¼ŒSolicitVoteåœ¨follower.step()å½“ä¸­:\nå¦‚æœå½“å‰termæŠ•è¿‡ç¥¨äº†å°±å¿½ç•¥ åšå®‰å…¨æ€§æ£€æŸ¥ï¼Œåªä¼šç»™æ—¥å¿—çŠ¶æ€æœ€æ–°çš„èŠ‚ç‚¹æŠ•ç¥¨ æ£€æŸ¥é€šè¿‡åˆ™æŠ•ç¥¨ï¼Œå¹¶åšæŒä¹…åŒ–è®°å½•ï¼Œå­˜å‚¨vote for 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 Event::SolicitVote { last_index, last_term } =\u0026gt; { let from = msg.from.unwrap(); // If we already voted for someone else in this term, ignore it. if let Some(voted_for) = self.role.voted_for { if from != voted_for { return Ok(self.into()); } } // Only vote if the candidate\u0026#39;s log is at least as up-to-date as // our log. let (log_index, log_term) = self.log.get_last_index(); if last_term \u0026gt; log_term || last_term == log_term \u0026amp;\u0026amp; last_index \u0026gt;= log_index { info!(\u0026#34;Voting for {} in term {} election\u0026#34;, from, self.term); self.send(Address::Node(from), Event::GrantVote)?; self.log.set_term(self.term, Some(from))?; self.role.voted_for = Some(from); } } /// å®šä¹‰åœ¨logå½“ä¸­ï¼Œç”¨äºå¯¹termå’Œvote_forè¿›è¡ŒæŒä¹…åŒ–å­˜å‚¨ /// Sets the most recent term, and cast vote (if any). pub fn set_term(\u0026amp;mut self, term: Term, voted_for: Option\u0026lt;NodeID\u0026gt;) -\u0026gt; Result\u0026lt;()\u0026gt; { self.engine.set(\u0026amp;Key::TermVote.encode()?, bincode::serialize(\u0026amp;(term, voted_for))?)?; self.maybe_flush() } BecomeLeader\nå½“candidateæ¥æ”¶åˆ°Followerçš„æŠ•ç¥¨å›å¤ä¹‹åï¼Œä¼šè®°å½•ç¥¨æ•°ï¼Œå¦‚æœè¾¾åˆ°äº†quorumï¼Œé‚£ä¹ˆå°±è½¬æ¢ä¸ºleaderï¼Œè¿™ä¸€éƒ¨åˆ†çš„é€»è¾‘åŒæ ·æ˜¯å®šä¹‰åœ¨stepå½“ä¸­\nå½“é€‰ä¸ºLeaderä¹‹åï¼Œæ›´æ–°ä¸€äº›ä¿¡æ¯ä¹‹åï¼Œä¼šå‘é€å¿ƒè·³ä¿¡æ¯å‘ŠçŸ¥å…¶ä»–çš„èŠ‚ç‚¹Leaderå·²ç»å½“é€‰ã€‚ ä¹‹åä¼šè¿½åŠ ä¸€æ¡no-opï¼Œnon-opçš„ä½œç”¨å·²ç»åœ¨ä¸Šæ–‡è§’è‰²åˆ‡æ¢éƒ¨åˆ†è§£é‡Šäº†ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 Event::GrantVote =\u0026gt; { self.role.votes.insert(msg.from.unwrap()); if self.role.votes.len() as u64 \u0026gt;= self.quorum() { return Ok(self.become_leader()?.into()); } } fn become_leader(self) -\u0026gt; Result\u0026lt;RoleNode\u0026lt;Leader\u0026gt;\u0026gt; { info!(\u0026#34;Won election for term {}, becoming leader\u0026#34;, self.term); let peers = self.peers.clone(); let (last_index, _) = self.log.get_last_index(); let mut node = self.become_role(Leader::new(peers, last_index)); node.heartbeat()?; // Propose an empty command when assuming leadership, to disambiguate // previous entries in the log. See section 8 in the Raft paper. node.propose(None)?; Ok(node) } toydbå½“ä¸­Leader Electionçš„å®ç°éå¸¸ç®€å•ï¼ŒåŸºæœ¬ä¸Šå®Œå…¨æŒ‰ç…§raftå°è®ºæ–‡å½“ä¸­çš„æè¿°ï¼Œåƒæ˜¯PreVoteï¼ŒCheck Quorumï¼ŒLeader Leaseä¸€æ¦‚æ²¡æœ‰ï¼Œä¸è¿‡è¿™ä¹Ÿå¾ˆç¬¦åˆå…¶toyçš„å®šä½ã€‚\nLog Replication Log åœ¨çœ‹æ—¥å¿—å¤åˆ¶ä¹‹å‰ï¼Œå…ˆçœ‹ä¸€ä¸‹Logçš„å®ç°ï¼š Logæ¨¡å—å¹¶ä¸åªå­˜å‚¨LogEntryï¼Œè¿™é‡Œå…¶å®æ˜¯å¯¹åº•å±‚kvå­˜å‚¨å¼•æ“çš„å°è£…ï¼Œæ‰€æœ‰éœ€è¦è¿›è¡ŒæŒä¹…åŒ–çš„æ•°æ®éƒ½ä¸¢åˆ°å­˜å‚¨å¼•æ“å½“ä¸­ï¼ŒåŒ…æ‹¬current_termå’Œvote_forï¼Œè¿™é‡Œè¿˜é¢å¤–å­˜å‚¨äº†ä¸€ä¸ªcommit_indexç”¨äºåœ¨commitæ—¶åšä¸€ä¸ªå®‰å…¨æ ¡éªŒ,Entryæ˜¯logçš„åŸºæœ¬å•ä½ï¼Œå®ç°åŒæ ·æ˜¯å€ŸåŠ©æšä¸¾æ¥å®ç°çš„ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 /// A log key, encoded using KeyCode. #[derive(Clone, Debug, PartialEq, Serialize, Deserialize)] pub enum Key { /// A log entry, storing the term and command. Entry(Index), /// Stores the current term and vote (if any). TermVote, /// Stores the current commit index (if any). CommitIndex, } /// A log entry. #[derive(Clone, Debug, PartialEq, Serialize, Deserialize)] pub struct Entry { /// The entry index. pub index: Index, /// The term in which the entry was added. pub term: Term, /// The state machine command. None is used to commit noops during leader election. pub command: Option\u0026lt;Vec\u0026lt;u8\u0026gt;\u0026gt;, } Logæœ¬ä½“å®šä¹‰å¦‚ä¸‹ï¼ŒåŒ…æ‹¬ä¸€ä¸ªengineç”¨äºè¿›è¡Œå­˜å‚¨ï¼Œå’Œä¸€äº›å…ƒæ•°æ®ï¼Œåœ¨åˆå§‹åŒ–æ—¶ï¼Œä¼šä»engineå½“ä¸­æŠŠå…ƒæ•°æ®ç»™åŠ è½½å‡ºæ¥ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 pub struct Log { /// The underlying storage engine. engine: Box\u0026lt;dyn Engine\u0026gt;, /// The index of the last stored entry. last_index: Index, /// The term of the last stored entry. last_term: Term, /// The index of the last committed entry. commit_index: Index, /// The term of the last committed entry. commit_term: Term, /// Whether to sync writes to disk. sync: bool, } å…¶ä¸­çš„å‡½æ•°å®ç°ï¼Œé€»è¾‘éƒ½æ¯”è¾ƒç®€å•ï¼Œå¹¶ä¸”ä¹Ÿéƒ½æä¾›äº†ä¸°å¯Œçš„æ³¨é‡Šï¼Œè¿™é‡Œå°±ä¸å±•å¼€ã€‚\nHeartbeat ä¸6.824å½“ä¸­ä½¿ç”¨heartbeatæ¥æºå¸¦æ—¥å¿—ä¸åŒï¼Œåœ¨toydbå½“ä¸­ï¼Œheartbeatå°±ä»…ä»…æ˜¯ç”¨äºç»´æŠ¤leaderèº«ä»½ï¼Œä»¥åŠæ¨åŠ¨followerçš„commit_indexï¼Œä¸ä¼šæºå¸¦log entryã€‚heartbeatçš„å‘é€é€»è¾‘åœ¨leader.tick()å½“ä¸­ï¼Œheartbeatçš„å¤„ç†åœ¨follower.step()å½“ä¸­ï¼š\næ¥æ”¶åˆ°äº†heartbeatå°±ä¸æ–­å°†è‡ªå·±è½¬æ¢ä¸ºfollower æ ¹æ®leaderä¼ æ¥åˆ°commit_indexå’Œè‡ªèº«logçš„æƒ…å†µï¼Œæ¨åŠ¨commitçš„è¿›åº¦ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 // leader.tick() /// Processes a logical clock tick. pub fn tick(mut self) -\u0026gt; Result\u0026lt;Node\u0026gt; { self.assert()?; self.role.since_heartbeat += 1; if self.role.since_heartbeat \u0026gt;= HEARTBEAT_INTERVAL { self.heartbeat()?; self.role.since_heartbeat = 0; } Ok(self.into()) } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 pub enum Event { /// Leaders send periodic heartbeats to its followers. Heartbeat { /// The index of the leader\u0026#39;s last committed log entry. commit_index: Index, /// The term of the leader\u0026#39;s last committed log entry. commit_term: Term, }, /// ...... /// ...... } // follower.step()å½“ä¸­å¤„ç†å¿ƒè·³ä¿¡æ¯ // The leader will send periodic heartbeats. If we don\u0026#39;t have a // leader in this term yet, follow it. If the commit_index advances, // apply state transitions. Event::Heartbeat { commit_index, commit_term } =\u0026gt; { // Check that the heartbeat is from our leader. let from = msg.from.unwrap(); match self.role.leader { Some(leader) =\u0026gt; assert_eq!(from, leader, \u0026#34;Multiple leaders in term\u0026#34;), None =\u0026gt; self = self.become_follower(Some(from), msg.term)?, } // Advance commit index and apply entries if possible. let has_committed = self.log.has(commit_index, commit_term)?; let (old_commit_index, _) = self.log.get_commit_index(); if has_committed \u0026amp;\u0026amp; commit_index \u0026gt; old_commit_index { self.log.commit(commit_index)?; let mut scan = self.log.scan((old_commit_index + 1)..=commit_index)?; // ä¸çŠ¶æ€æœºè¿›è¡Œäº¤äº’ while let Some(entry) = scan.next().transpose()? { self.state_tx.send(Instruction::Apply { entry })?; } } self.send(msg.from, Event::ConfirmLeader { commit_index, has_committed })?; } Log Replication Log Replicationçš„å…¥å£åœ¨Leader.step()å½“ä¸­ï¼ŒLeaderä¼šå¤„ç†ç”±Clientå‘é€è€Œæ¥çš„è¯·æ±‚ï¼Œåœ¨è¿™é‡Œä¼šè°ƒç”¨propose()ï¼Œåœ¨proposeå½“ä¸­ï¼ŒçœŸæ­£å¼€å§‹è¿›è¡Œæ—¥å¿—å¤åˆ¶ï¼Œå°†å‘½ä»¤è½¬æ¢ä¸ºæ—¥å¿—å­˜å‚¨åˆ°æœ¬åœ°ï¼Œä¹‹åå†å‘é€ç»™å…¶ä»–çš„èŠ‚ç‚¹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 // leader.step() æ¥å—å®¢æˆ·ç«¯è¯·æ±‚ Event::ClientRequest { id, request: Request::Mutate(command) } =\u0026gt; { let index = self.propose(Some(command))?; self.state_tx.send(Instruction::Notify { id, address: msg.from, index })?; if self.peers.is_empty() { self.maybe_commit()?; } } // proposeï¼ŒçœŸæ­£å¼€å§‹æ—¥å¿—å¤åˆ¶çš„é€»è¾‘ /// Proposes a command for consensus by appending it to our log and /// replicating it to peers. If successful, it will eventually be committed /// and applied to the state machine. pub(super) fn propose(\u0026amp;mut self, command: Option\u0026lt;Vec\u0026lt;u8\u0026gt;\u0026gt;) -\u0026gt; Result\u0026lt;Index\u0026gt; { let index = self.log.append(self.term, command)?; for peer in self.peers.clone() { self.send_log(peer)?; } Ok(index) } Progress Progressçš„å«ä¹‰æ˜¯ï¼Œç«™åœ¨Leaderçš„è§’åº¦ï¼Œè§‚å¯Ÿåˆ°çš„followerçš„å¤åˆ¶è¿›åº¦ï¼Œå®šä¹‰äº†next_indexå’Œmatch_indexï¼Œä¹‹åä½¿ç”¨ä¸€ä¸ªHashMapæ¥ç®¡ç†å„ä¸ªèŠ‚ç‚¹çš„è¿›åº¦,ç”±äºå’Œetcdç›¸æ¯”å°‘äº†æµæ°´çº¿å‘é€å’Œæ»‘åŠ¨çª—å£æµé‡æ§åˆ¶ç­‰ï¼ŒProgressçš„å®ç°ç®€å•äº†å¾ˆå¤šï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 struct Progress { /// The next index to replicate to the peer. next: Index, /// The last index known to be replicated to the peer. last: Index, } pub struct Leader { /// Peer replication progress. progress: HashMap\u0026lt;NodeID, Progress\u0026gt;, /// Number of ticks since last periodic heartbeat. since_heartbeat: Ticks, } propose åœ¨proposeå½“ä¸­ï¼Œä¼šé¦–å…ˆå°†æ—¥å¿—æŒä¹…åŒ–åˆ°æœ¬åœ°ï¼Œä¹‹åè°ƒç”¨send_log()è¿›è¡Œå‘é€ï¼Œåœ¨send_log()å½“ä¸­ï¼Œä¼šæ ¹æ®Progressæ‰¾åˆ°éœ€è¦å‘é€çš„æ—¥å¿—ï¼Œä¹‹åä»æœ¬åœ°è¿›è¡Œè¯»å–ã€‚\næ ¹æ®progressè·å–åˆ°nextä¹‹åï¼Œå…ˆä»æœ¬åœ°è¯»å–next - 1çš„Entryï¼Œnext - 1çš„Entryæ˜¯ç”¨äºæ£€æµ‹æ—¥å¿—å†²çªçš„ï¼Œç†åº”å­˜åœ¨äºLeaderæœ¬åœ° æ‰«æå‡ºnextä¹‹åçš„æ‰€æœ‰Entryï¼Œè¿åŒbase_indexå’Œbase_termå°è£…æˆä¸€æ¡AppendEntrieså‘é€ç»™follower 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 /// Sends pending log entries to a peer. fn send_log(\u0026amp;mut self, peer: NodeID) -\u0026gt; Result\u0026lt;()\u0026gt; { let (base_index, base_term) = match self.role.progress.get(\u0026amp;peer) { Some(Progress { next, .. }) if *next \u0026gt; 1 =\u0026gt; match self.log.get(next - 1)? { Some(entry) =\u0026gt; (entry.index, entry.term), None =\u0026gt; panic!(\u0026#34;Missing base entry {}\u0026#34;, next - 1), }, Some(_) =\u0026gt; (0, 0), None =\u0026gt; panic!(\u0026#34;Unknown peer {}\u0026#34;, peer), }; let entries = self.log.scan((base_index + 1)..)?.collect::\u0026lt;Result\u0026lt;Vec\u0026lt;_\u0026gt;\u0026gt;\u0026gt;()?; debug!(\u0026#34;Replicating {} entries at base {} to {}\u0026#34;, entries.len(), base_index, peer); self.send(Address::Node(peer), Event::AppendEntries { base_index, base_term, entries })?; Ok(()) } AppendEntries Leaderå°è£…äº†ä¸€æ¡AppendEntrieså‘é€ç»™Followerï¼Œç›¸å¯¹åº”çš„å°±åœ¨Follower.step()å½“ä¸­è¿›è¡Œå¤„ç†ï¼š\nèƒ½å¤Ÿæ¥æ”¶åˆ°AppendEntriesè¯æ˜èƒ½å¤Ÿç¡®è®¤Leaderï¼Œå› æ­¤å°±è°ƒç”¨become_follower()æ›´æ–°è‡ªèº«çŠ¶æ€ï¼Œå¯¹Leaderè¿›è¡Œè·Ÿéš å°è¯•åŒ¹é…æ—¥å¿—ï¼Œå¹¶å°†å…¶åº”ç”¨äºè‡ªèº«ï¼Œå¦‚æœä¸åŒ¹é…åˆ™è¿”å›ä¸€æ¡Rejectï¼Œè®©Leaderå†å»åšbackupï¼Œæ‰¾åˆ°æ­£ç¡®çš„æ—¥å¿— 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 // Replicate entries from the leader. If we don\u0026#39;t have a leader in // this term yet, follow it. Event::AppendEntries { base_index, base_term, entries } =\u0026gt; { // Check that the entries are from our leader. let from = msg.from.unwrap(); match self.role.leader { Some(leader) =\u0026gt; assert_eq!(from, leader, \u0026#34;Multiple leaders in term\u0026#34;), None =\u0026gt; self = self.become_follower(Some(from), msg.term)?, } // Append the entries, if possible. if base_index \u0026gt; 0 \u0026amp;\u0026amp; !self.log.has(base_index, base_term)? { debug!(\u0026#34;Rejecting log entries at base {}\u0026#34;, base_index); self.send(msg.from, Event::RejectEntries)? } else { let last_index = self.log.splice(entries)?; self.send(msg.from, Event::AcceptEntries { last_index })? } } åœ¨Leaderç«¯çš„å¤„ç†åˆ†ä¸ºä¸¤ç§ï¼Œåˆ†åˆ«æ˜¯æˆåŠŸå“åº”çš„Event::AppendEntrieså’ŒEventRejectEntriesï¼š\nå¦‚æœFollowerèƒ½å¤ŸæˆåŠŸåŒ¹é…æ—¥å¿—ï¼Œé‚£ä¹ˆLeaderå°±ä¼šå»æ›´æ–°è¿›åº¦ï¼Œå¹¶ä¸”è®¡ç®—quorumï¼Œå°è¯•è¿›è¡Œcommit å¦‚æœåŒ¹é…å¤±è´¥ï¼Œåœ¨Leaderç«¯progresså‘å‰å›é€€ä¸€ä¸ªï¼Œå†å°è¯•å‘é€æ—¥å¿—ï¼Œè¿›è¡Œæ¢æµ‹ï¼Œç›´è‡³æ‰¾åˆ°æ‰¾åˆ°æ­£ç¡®çš„ä½ç½®ï¼Œè¿™é‡Œæ˜¯æ²¡æœ‰å®ç°çš„fast backupçš„ï¼Œåœ¨æ•ˆç‡ä¸Šä¼šå­˜åœ¨ä¸€å®šçš„é—®é¢˜ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 Event::AcceptEntries { last_index } =\u0026gt; { assert!( last_index \u0026lt;= self.log.get_last_index().0, \u0026#34;Follower accepted entries after last index\u0026#34; ); let from = msg.from.unwrap(); self.role.progress.entry(from).and_modify(|p| { p.last = last_index; p.next = last_index + 1; }); self.maybe_commit()?; } // A follower rejected log entries we sent it, typically because it // does not have the base index in its log. Try to replicate from // the previous entry. // // This linear probing, as described in the Raft paper, can be very // slow with long divergent logs, but we keep it simple. Event::RejectEntries =\u0026gt; { let from = msg.from.unwrap(); self.role.progress.entry(from).and_modify(|p| { if p.next \u0026gt; 1 { p.next -= 1 } }); self.send_log(from)?; } Commit æ¯æ¬¡Leaderç¡®å®šäº†æœ‰followerä¿å­˜äº†æ—¥å¿—ä¹‹åå°±ä¼šå°è¯•è¿›è¡Œcommitï¼Œåœ¨rustå½“ä¸­ï¼Œå€ŸåŠ©å‡½æ•°å¼ç¼–ç¨‹ï¼Œèƒ½å°†è¿™ä¸ªè¿‡ç¨‹å†™çš„å¾ˆä¼˜é›…(æ²¡æ¥è§¦è¿‡å‡½æ•°å¼ç¼–ç¨‹çœ‹äº†æƒ³éª‚å¨˜)ï¼š\né¦–å…ˆè·å–åˆ°progressçš„HashMapï¼Œä¹‹åè·å–åˆ°HashMapçš„æ‰€æœ‰value(valueæ˜¯ä¸€ä¸ªnext_indexå’Œlast_indexç»„æˆçš„å…ƒç»„) å†åšä¸€ä¸ªè½¬æ¢ï¼Œè·å–last_indexï¼Œè¿™ä¸€æ­¥ä¼šå¾—åˆ°ä¸€ä¸ªç”±æ‰€æœ‰last_indexç»„æˆçš„è¿­ä»£å™¨ ä¹‹åä½¿ç”¨chainå°†leaderçš„last_indexè¿½åŠ è¿›å»ï¼Œæœ€åè½¬æ¢ä¸ºVec æ’åºå¹¶åè½¬ä¹‹åç¬¬quorumå¤§çš„last_indexå°±æ˜¯ä¸followerè¾¾æˆå…±è¯†çš„index åœ¨vscodeå½“ä¸­ï¼Œrust-analyzerèƒ½å¤Ÿå¾ˆæ¸…æ¥šçš„æ˜¾ç¤ºå‡ºæ¯ä¸€æ­¥éƒ½å¾—åˆ°äº†ä»€ä¹ˆï¼š è·å–åˆ°commit_indexä¹‹ååšä¸€äº›æ ¡éªŒï¼š\næ­¤æ¬¡è®¡ç®—å‡ºçš„commit_indexè¦å¤§äºä¸Šä¸€æ¬¡çš„commit_index è·å–å‡º commit_index å¯¹åº”çš„ entryï¼Œåˆ¤æ–­æ˜¯ä¸æ˜¯å½“å‰çš„ Termï¼ŒLeader åªèƒ½æäº¤å±äºè‡ªå·±ä»»æœŸçš„æ—¥å¿— (è§ raft å°è®ºæ–‡ figure 8) å¦‚æœæ˜¯æ–°çš„commit_indexï¼Œå°±åœ¨æœ¬åœ°è¿›è¡Œè®°å½•ï¼Œå¹¶ä¸”æ‰«æå‡ºä»ä¸Šä¸€æ¬¡commitåˆ°æ–°commit_indexä¹‹é—´çš„æ‰€æœ‰çš„æ—¥å¿—ï¼Œå‘ä¸Šå±‚çŠ¶æ€æœºè¿›è¡Œapplyï¼Œå³å‘state_tx channelå½“ä¸­å‘é€ä¸€æ¡ä¿¡æ¯\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 // Make sure the commit index does not regress. let (prev_commit_index, _) = self.log.get_commit_index(); assert!( commit_index \u0026gt;= prev_commit_index, \u0026#34;Commit index regression {} -\u0026gt; {}\u0026#34;, prev_commit_index, commit_index ); // We can only safely commit up to an entry from our own term, see // figure 8 in Raft paper. match self.log.get(commit_index)? { Some(entry) if entry.term == self.term =\u0026gt; {} Some(_) =\u0026gt; return Ok(prev_commit_index), None =\u0026gt; panic!(\u0026#34;Commit index {} missing\u0026#34;, commit_index), }; // Commit and apply the new entries. if commit_index \u0026gt; prev_commit_index { self.log.commit(commit_index)?; // TODO: Move application elsewhere, but needs access to applied index. let mut scan = self.log.scan((prev_commit_index + 1)..=commit_index)?; while let Some(entry) = scan.next().transpose()? { self.state_tx.send(Instruction::Apply { entry })?; } } Summary ä»¥ä¸Šå°±æ˜¯toydbå½“ä¸­Raftæ¨¡å—çš„å…¨éƒ¨å†…å®¹ï¼Œè¿™é‡Œçš„Raftæ¨¡å—æŒ‡çš„æ˜¯Raftæœ¬èº«çš„é€»è¾‘éƒ¨åˆ†ï¼Œä¸åŒ…æ‹¬ä¸Šå±‚çš„çŠ¶æ€æœºå’Œå‘é€å‘½ä»¤çš„Clientï¼Œè¿™ä¸€éƒ¨åˆ†ç¬”è€…ç•™åˆ°ä¸‹ä¸€ç« çš„sql engineå½“ä¸­è¿›è¡Œåˆ†æï¼Œæœ€åä»¥toydbä¸MIT6.824ä»¥åŠetcdè¿›è¡Œä¸€ä¸ªç®€å•çš„å¯¹æ¯”ï¼Œæ¥ç»“æŸè¿™ä¸€ç« \nMIT-6.824\nåœ¨MIT-6.824çš„Lab2å½“ä¸­ï¼Œå®ç°äº†ä¸€ä¸ªåŸºç¡€çš„Raftæ¨¡å—ï¼Œåœ¨å…¶ä¸­å‡ ä¹å®Œæ•´çš„å¤ç°äº†ã€ŠIn Search of an Understandable Consensus Algorithm (Extended Version)ã€‹ä¸€æ–‡ï¼Œä½†æ²¡æœ‰å®ç°é›†ç¾¤é…ç½®å˜æ›´ï¼Œå¹¶ä¸”åœ¨æŒä¹…åŒ–å’Œsnapshotä¸Šåšäº†ç®€åŒ–ã€‚\nä½†æ˜¯MIT6.824å½“ä¸­çš„å®ç°å¹¶ä¸æ˜¯é‚£ä¹ˆå·¥ç¨‹åŒ–ï¼Œæˆ–è€…è¯´æ¥è¿‘ç”Ÿäº§ç¯å¢ƒï¼Œè™½ç„¶æ¯ä¸ªäººçš„å®ç°æ–¹å¼ä¸åŒï¼Œä½†æ˜¯è‡³å°‘åˆå§‹æ¡†æ¶æ˜¯è¿™æ ·çš„ï¼Œç›¸æ¯”äºTinykvæ¥è¯´ã€‚åœ¨6.824å½“ä¸­ï¼Œåœ¨éœ€è¦é€šä¿¡çš„æ—¶å€™å°±ç›´æ¥å‘é€rpcè°ƒç”¨å¯¹åº”çš„å‡½æ•°ï¼Œä»¥ä¸€ç§å¾ˆç›´è§‚çš„æ–¹å¼å¤ç°äº†Raftï¼Œå½“ä¸­å®šä¹‰çš„å‡½æ•°ä¹Ÿéƒ½éµå¾ªè®ºæ–‡å½“ä¸­figure2ï¼ŒåŸºæœ¬ä¸ŠæŠŠfigure2ç¿»è¯‘æˆgolangå°±èƒ½å®ç°å‡ºæ¥ã€‚\netcd/raft\netcd/raftä½œä¸ºä¸€ä¸ªæŠ•å…¥ç”Ÿäº§ç¯å¢ƒçš„raft packageï¼Œä»£ç ç»“æ„è‡ªç„¶æ˜¯æ¸…æ™°ä¸¥è°¨çš„ã€‚\nåœ¨åŸºç¡€ç»“æ„ä¸Šï¼Œetcd/raftå°†raftè§†ä¸ºä¸€ä¸ªçŠ¶æ€æœºï¼Œä¸Šå±‚ç»™äºˆRaftä¸€äº›è¾“å…¥ï¼Œå¦‚tickæˆ–è€…messageï¼ŒRaftå°±ä¼šæ ¹æ®è¾“å…¥ä½œå‡ºä¸€äº›å“åº”ï¼Œæ›´æ”¹è‡ªèº«çŠ¶æ€ï¼Œæœ€åæä¾›ä¸€äº›è¾“å‡ºï¼Œä¸Šå±‚å¤„ç†å®Œè¾“å‡ºä¹‹åå†è°ƒç”¨Advanceæ¥ç»§ç»­æ¨è¿›Raftå»æ›´æ–°çŠ¶æ€ã€‚\nåœ¨etcdå½“ä¸­ï¼Œraft packageä»…æä¾›raftçš„é€»è¾‘ï¼Œå¦‚å¦‚ä½•è¿›è¡Œé€‰ä¸¾å’Œå‘é€æ—¥å¿—ï¼Œä½†æ˜¯å¦‚æŒä¹…åŒ–å­˜å‚¨ï¼Œç½‘ç»œé€šä¿¡éƒ½ç”±ä¸Šå±‚åº”ç”¨è´Ÿè´£ï¼Œraft packageé€šè¿‡Readyå°†éœ€è¦å­˜å‚¨çš„æ—¥å¿—ï¼Œå¿«ç…§ï¼Œä»¥åŠéœ€è¦å‘é€çš„æ¶ˆæ¯äº¤ç»™ä¸Šå±‚ã€‚\nåœ¨ç»“æ„ä¸Šï¼Œetcd/raftä»¥Messageä¸ºä¸»ä½“å’Œé©±åŠ¨ï¼Œæ•´ä¸ªRaftçš„æ‰§è¡Œæµç¨‹å°±æ˜¯åœ¨tickçš„é©±åŠ¨ä¸‹ï¼Œä¸æ–­çš„æ‰§è¡Œå’Œå‘é€Messageçš„è¿‡ç¨‹ï¼Œå¹¶ä¸ä¼šåƒMIT6.824å½“ä¸­é‚£æ ·åœ¨ä¸€ä¸ªå‡½æ•°å½“ä¸­èƒ½çœ‹åˆ°å®Œæ•´çš„rpcè°ƒç”¨å’Œå¤„ç†æµç¨‹ï¼Œæ¯ä¸ªMessageåªä¼šè´Ÿè´£æ•´ä½“é€»è¾‘çš„ä¸€éƒ¨åˆ†ï¼Œæ‰§è¡Œå®Œè‡ªå·±çš„å†…å®¹å°±ç”Ÿæˆä¸€ä¸ªæ–°çš„Messageå‘é€ï¼Œå…¶ä»–æ‹¿åˆ°è¿™æ¡Messageçš„æ¥å®Œæˆè¿™ä¸ªäº‹ä»¶çš„å‰©ä½™é€»è¾‘ï¼Œä¸¾ä¸ªä¾‹å­ï¼Œåœ¨è¿›è¡Œé€‰ä¸¾æ—¶ï¼š\ncandidateé¦–å…ˆä¼šå‘å…¶ä»–èŠ‚ç‚¹å‘é€ä¸€ä¸ªè¯·æ±‚æŠ•ç¥¨çš„Messageï¼Œæ­¤æ—¶candidateç›®å‰è´Ÿè´£çš„é€»è¾‘å·²ç»æ‰§è¡Œç»“æŸï¼Œcandidateå¯ä»¥å»æ‰§è¡Œå…¶ä»–å†…å®¹ followerå—åˆ°candidateå‘é€çš„Messageå°±ä¼šè¿›è¡Œå¤„ç†ï¼ŒæŠ•ç¥¨æˆ–è€…å¿½ç•¥ï¼ŒåŒæ ·å°†ç»“æœå°è£…æˆä¸€æ¡Messageå†å‘é€ç»™candidate Candidate å†æ”¶åˆ° Message ä¹‹åç»§ç»­å®Œæˆå‰©ä½™çš„é€»è¾‘ï¼Œç»Ÿè®¡æŠ•ç¥¨ï¼Œå†³å®šæ˜¯å¦å½“é€‰ æ•´ä¸ªæ‰§è¡Œè¿‡ç¨‹æ˜¯æ¾æ•£ã€éè¿ç»­çš„ã€‚ä½†æ˜¯ä¸»ä½“é€»è¾‘å…¨éƒ¨ä½¿ç”¨ Message æ¥æ‰¿è½½çš„è¯ï¼Œæ•´ä½“ç»“æ„å°±ä¼šéå¸¸æ¸…æ™°ï¼Œraft åªéœ€è¦ä¸æ–­çš„å¤„ç† Message å³å¯ï¼Œå¹¶åœ¨é€‚å½“çš„æ—¶å€™äº§ç”Ÿæ–°çš„ Message\nåœ¨å®ç°ä¸Šï¼Œetcd/raftå®Œæ•´çš„å®ç°äº†Raftå°è®ºæ–‡å½“ä¸­çš„å†…å®¹ï¼ŒåŒ…æ‹¬åœ¨MIT-6.824å½“ä¸­æ²¡æœ‰å®ç°çš„é›†ç¾¤å˜æ›´ï¼Œå¹¶ä¸”å¯¹äºRaftå¤§è®ºæ–‡ã€ŠCONSENSUS: BRIDGING THEORY AND PRACTICEã€‹å½“ä¸­çš„ä¼˜åŒ–ä¹Ÿè¿›è¡Œäº†å®ç°ï¼š\nåœ¨ç»“æ„ä¸Šï¼šé‡‡ç”¨äº†æ‰¹å¤„ç†çš„å½¢å¼ï¼Œå³Readyä¼šå‘ä¸Šå±‚è¿”å›ä¸€æ‰¹éœ€è¦å¤„ç†æ•°æ®ï¼Œä¸Šå±‚ç”¨æˆ·è¿›è¡Œé›†ä¸­å¤„ç†ï¼Œåœ¨Raftè¿è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œåªéœ€è¦æŠŠlogæ·»åŠ åˆ°å¯¹åº”çš„ä½ç½®ï¼Œå°†éœ€è¦å‘é€çš„Messageæ”¾å…¥â€œä¿¡ç®±â€ï¼Œå±Šæ—¶ä¸€å¹¶é€šè¿‡Readyè¿”å›(è¿™ä¸ªå…¶å®å’ŒRaftå¤§è®ºæ–‡æ²¡ä»€ä¹ˆå…³ç³»ï¼Œåªä¸è¿‡éƒ½æ˜¯ä¼˜åŒ–å°±ä¸€å¹¶æä¸€ä¸‹äº†) åœ¨é€‰ä¸¾éƒ¨åˆ†ï¼šectd/raftå®ç°äº†PreVoteã€Check Quorumã€Leader Leaseçš„ä¼˜åŒ– åœ¨æ—¥å¿—å¤åˆ¶ä¸Šï¼Œectd/rafté‡‡ç”¨äº†æµæ°´çº¿è®¾è®¡ï¼Œä¼šåœ¨é˜»å¡æ¢æµ‹æ¨¡å¼ï¼Œæµæ°´çº¿å‘é€ï¼Œå¿«ç…§å‘é€ä¸‰ç§æ¨¡å¼ä¸‹åˆ‡æ¢ï¼Œåœ¨æµæ°´çº¿æ¨¡å¼ä¸‹ï¼Œetcd/raftå¯ä»¥åœ¨æœªæ¥æ”¶åˆ°ä¸Šæ¬¡å‘é€æ—¥å¿—å“åº”çš„æƒ…å†µä¸‹ç»§ç»­å‘é€æ—¥å¿—ï¼Œå¹¶ä¸”ä½¿ç”¨æ»‘åŠ¨çª—å£æ¥è¿›è¡Œæµé‡æ§åˆ¶ã€‚å¹¶ä¸”åœ¨æ—¥å¿—å‘é€æ—¶ï¼Œé‡‡ç”¨å¹¶è¡Œå‘é€çš„æ–¹å¼ï¼Œå³å­˜å‚¨ä¸å‘é€å¹¶è¡Œï¼Œå¯ä»¥åœ¨æœ¬åœ°è¿˜æœªè¿›è¡ŒæŒä¹…åŒ–å­˜å‚¨çš„æƒ…å†µä¸‹å°±å‘é€ï¼ŒæŸäº›æƒ…å†µä¸‹ï¼Œfollowerå¯èƒ½åœ¨leaderå­˜å‚¨æ—¥å¿—ä¹‹å‰å°±æ¥æ”¶åˆ°æ—¥å¿—ã€‚åœ¨æ—¥å¿—ä¸åŒ¹é…æ—¶ï¼Œfollowerä¼šè¿”å›ä¸€ä¸ªhintï¼Œä»è€ŒLeaderå¯ä»¥å¿«é€Ÿè¿›è¡Œå›é€€ï¼Œæ‰¾åˆ°æ­£ç¡®çš„ä½ç½®ã€‚ åœ¨çº¿æ€§ä¸€è‡´æ€§è¯»ä¸Šï¼Œæä¾›äº† ReadIndex å’Œ Lease Read ä¸¤ç§æ–¹å¼ï¼Œä»¥ç»•è¿‡ Log Readï¼Œæé«˜ç³»ç»Ÿååé‡ å¦‚æœæƒ³è¿›ä¸€æ­¥äº†è§£etcd/raftçš„è¯ï¼Œæ¨èçœ‹è¿™ä¸€ç³»åˆ—ï¼Œå°±åƒå…¶åå­—ä¸€æ ·ï¼Œæ·±å…¥æµ…å‡ºï¼šæ·±å…¥æµ…å‡ºetcd/raft â€”â€” 0x00 å¼•è¨€ - å‰é¸½ MrCroxx çš„åšå®¢ toydb å†…å®¹ä¸Šï¼Œtoydbç›¸æ¯”äºRaftå°è®ºæ–‡å’ŒMIT-6.824æœ‰æ‰€åˆ å‡ï¼ŒåŒæ ·æ²¡æœ‰å®ç°é›†ç¾¤æˆå‘˜å˜æ›´ï¼Œæ­¤å¤–ï¼Œæ²¡æœ‰å®ç°æ—¥å¿—çš„å¿«é€Ÿå›é€€ï¼Œå’Œå¿«ç…§åŠŸèƒ½ã€‚è€Œetcdå½“ä¸­çš„ç§ç§ä¼˜åŒ–å°±æ›´æ²¡æœ‰äº†(toydbé€šè¿‡RaftçŠ¶æ€æœºå®ç°äº†ä¸€ä¸ªReadIndexçš„åŠŸèƒ½ï¼Œå…¶ä»–çš„å°±éƒ½æ²¡æœ‰äº†)\nåœ¨ç»“æ„ä¸ŠtoydbåŸºæœ¬ä¸Šä¸etcd/raftä¸€è‡´ï¼Œä½¿ç”¨é€»è¾‘æ—¶é’Ÿ+Messageè¿›è¡Œé©±åŠ¨ï¼Œä¸Šé¢å¯¹etcdçš„åˆ†æå¯¹toydbåŸºæœ¬ä¸Šéƒ½é€‚ç”¨ã€‚åªä¸è¿‡toydbçš„æŒä¹…åŒ–æ˜¯ç”±Raftè‡ªå·±è´Ÿè´£çš„ï¼Œæ‰€æœ‰ä¸æŒä¹…åŒ–ç›¸å…³çš„å†…å®¹éƒ½æ‰”è¿›kvå­˜å‚¨å¼•æ“å½“ä¸­ï¼Œæ— è®ºæ˜¯å…ƒæ•°æ®è¿˜æ˜¯æ—¥å¿—ã€‚ä½†æ˜¯ç½‘ç»œæ¨¡å—æ˜¯åœ¨ä¸Šå±‚å®ç°çš„ï¼Œåœ¨Raftå½“ä¸­ä¹Ÿæ˜¯å’Œetcdä¸€æ ·ï¼Œåªéœ€è¦æŠŠMessageå¡å…¥ä¿¡ç®±å³å¯ã€‚\næ€»çš„æ¥è¯´ï¼Œtoydbåšäº†ä¸€ä¸ªå¾ˆå¥½çš„å–èˆï¼Œç”¨éå¸¸å·¥ç¨‹åŒ–çš„ç»“æ„å®ç°äº†ä¸€ä¸ªå‡ ä¹æ²¡æœ‰ä»»ä½•ä¼˜åŒ–çš„ï¼Œç®€å•çš„Raftæ¨¡å—ï¼Œä»£ç é€»è¾‘éå¸¸çš„æ¸…æ™°ï¼Œå½“ç„¶ä»£ä»·å°±æ˜¯ä¼šæŸå¤±ä¸€å®šçš„æ€§èƒ½ï¼Œå¦‚åŒæ­¥è¿›è¡ŒæŒä¹…åŒ–ï¼Œå’Œæ—¥å¿—å‡ºç°ä¸åŒ¹é…æ—¶éœ€è¦ä¸€æ¡æ¡è¿›è¡Œå›é€€ã€‚ä¸è¿‡ä½œä¸ºä¸€ä¸ªLearning Projectï¼Œä¸ªäººè®¤ä¸ºè¿˜æ˜¯å®ç°çš„éå¸¸ä¼˜é›…çš„ï¼Œå¾ˆå€¼å¾—ç”¨æ¥å­¦ä¹ ã€‚\nå¯¹äºRaftä¸Šå±‚çŠ¶æ€æœºå’ŒClientçš„ç›¸å…³å†…å®¹ï¼Œæ¶‰åŠåˆ°æ¯”è¾ƒå¤æ‚çš„é€šä¿¡å’Œå¼‚æ­¥ç¼–ç¨‹ï¼Œé™äºç¯‡å¹…å°±ä¸å†æœ¬ç« å½“ä¸­è¿›è¡Œåˆ†æï¼Œä¼šç•™åœ¨ä¸‹ä¸€ç« çš„kv engineå½“ä¸­ä¸€å¹¶è¿›è¡Œåˆ†æã€‚\nç”±äºåˆ†å¸ƒå¼ç³»ç»Ÿæ¯”è¾ƒå¤æ‚ï¼Œåœ¨toydbå½“ä¸­ï¼Œåœ¨clientï¼ŒRaftï¼Œä»¥åŠRaftçŠ¶æ€æœºä¹‹é—´çš„é€»è¾‘æ¯”è¾ƒå¤æ‚ï¼Œæ¶‰åŠåˆ°å¤§é‡çš„å¼‚æ­¥ç¼–ç¨‹å’Œä¿¡æ¯äº¤æ¢ï¼Œç¬”è€…æ°´å¹³æœ‰é™ï¼Œéš¾å…ä¼šå‡ºç°é”™è¯¯ï¼Œæ¬¢è¿è¯»è€…è¿›è¡Œæ‰¹è¯„æŒ‡æ­£ï¼Œå†å®Œæˆäº†RaftçŠ¶æ€æœºéƒ¨åˆ†ï¼Œæˆ‘ä¹Ÿä¼šé‡æ–°æ ¡éªŒæ•´ç†è¿™ç¯‡æ–‡ç« ï¼Œä»¥æ±‚è¾¾åˆ°ä¸€ä¸ªæ›´å¥½çš„æ•ˆæœã€‚\n","permalink":"https://fischer0522.github.io/en/posts/tech/toydb/03-raft/","summary":"toydbçš„Raftå®ç°ï¼Œç›¸æ¯”äº6.824æ›´æ¥è¿‘äºç”Ÿäº§çº§åˆ«çš„ï¼Œå’Œetcd/raftåœ¨ç»“æ„ä¸Šæ¯”è¾ƒç›¸ä¼¼ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰å®ç°Raftå¤§è®ºæ–‡å½“ä¸­çš„ä¼˜åŒ–ï¼Œ","title":"03-Raft"},{"content":"åŸºç¡€ç†è®º ç®€è€Œè¨€ä¹‹ï¼Œå®ç°MVCCçš„DBMSåœ¨å†…éƒ¨ç»´æŒç€å•ä¸ªé€»è¾‘æ•°æ®çš„å¤šä¸ªç‰©ç†ç‰ˆæœ¬ï¼Œå½“äº‹åŠ¡ä¿®æ”¹æŸæ¡æ•°æ®æ—¶ï¼Œå°±åˆ›å»ºä¸€ä¸ªæ–°çš„ç‰ˆæœ¬ã€‚å½“äº‹åŠ¡è¯»å–æ—¶ï¼Œå°±æ ¹æ®äº‹åŠ¡çš„å¼€å§‹æ—¶é—´ï¼Œå»è¯»å–äº‹åŠ¡å¼€å§‹æ—¶åˆ»ä¹‹å‰çš„æœ€æ–°ç‰ˆæœ¬ã€‚\nMVCCæ¦‚æ‹¬èµ·æ¥å°±æ˜¯ä¸¤å¥è¯ï¼š\nWriters don\u0026rsquo;t block readers. Readers don\u0026rsquo;t block writers. åªè¯»äº‹åŠ¡æ— éœ€åŠ é”å°±å¯ä»¥è¯»å–æ•°æ®åº“æŸä¸€æ—¶åˆ»çš„å¿«ç…§ï¼Œå¦‚æœä¿ç•™æ•°æ®çš„æ‰€æœ‰å†å²ç‰ˆæœ¬ï¼ŒDBMSç”šè‡³èƒ½å¤Ÿæ”¯æŒè¯»å–ä»»æ„å†å²ç‰ˆæœ¬çš„æ•°æ®ï¼Œå³time-travel(è¿™ä¸€ç‚¹åœ¨toydbå½“ä¸­ä¹Ÿå¾—åˆ°äº†å®ç°ï¼Œå³ä¸å®ç°gcï¼Œä¿ç•™ä¹‹å‰æ‰€æœ‰çš„ç‰ˆæœ¬ï¼Œå¼€å‘è€…è¿˜ç‰¹æ„å¼ºè°ƒäº†è¿™æ˜¯ä¸€ä¸ªfeatureè€Œä¸æ˜¯bug)\nå¹¶å‘æ§åˆ¶ MVCC(Multi-Version Concurrency Control)çš„åå­—å…·æœ‰ä¸€å®šçš„è¯¯å¯¼æ€§ï¼Œè™½ç„¶å«åšå¹¶å‘æ§åˆ¶ï¼Œä½†æ˜¯æœ¬èº«å¹¶ä¸æ˜¯ä¸€ä¸ªå®Œæ•´çš„å¹¶å‘æ§åˆ¶åè®®ï¼Œæ­£å¦‚ä¸Šé¢æ‰€è¯´çš„ï¼ŒMVCCåªèƒ½è§£å†³R-Wä¹‹é—´çš„å†²çªé—®é¢˜ï¼Œä½†æ˜¯å¯¹äºW-Wï¼Œå•é MVCCæœ¬èº«æ˜¯æ— æ³•è§£å†³çš„ï¼Œéœ€è¦å¼•å…¥å…¶ä»–çš„å¹¶å‘åè®®ï¼Œæ ¹æ®å¹¶å‘åè®®çš„ç§ç±»ï¼Œåˆå¯ä»¥å¤§è‡´åˆ†ä¸ºï¼š\nMV2PLï¼šä½¿ç”¨2PLæ‚²è§‚é”çš„å½¢å¼æ¥è§£å†³W-Wå†²çªé—®é¢˜ MVOCCï¼šä½¿ç”¨åŸºç¡€çš„æ—¶é—´æˆ³æˆ–è€…åˆ›å»ºprivate workspaceçš„å½¢å¼(äº‹åŠ¡åˆ†ä¸ºread,write,validateä¸‰ä¸ªè¿‡ç¨‹)ï¼ŒäºŒè€…å…¶å®æœ‰ç»†å¾®çš„åŒºåˆ«çš„ï¼Œä½†æ˜¯æœ¬è´¨éƒ½æ˜¯ä¹è§‚çš„å½¢å¼ï¼Œå°±å½’åœ¨ä¸€èµ·äº† è¿˜æœ‰æœ€ç®€å•çš„å½¢å¼,å¦‚æœå‘ç°å½“å‰äº‹åŠ¡è¦ä¿®æ”¹çš„recordæ­£åœ¨è¢«å…¶ä»–äº‹åŠ¡ä¿®æ”¹ï¼Œå°±æ”¾å¼ƒå¹¶ä¹‹åé‡è¯•(åˆä¸æ˜¯ä¸èƒ½ç”¨ :) )ï¼Œä¹Ÿç®—æ˜¯ä¸€ç§ä¹è§‚çš„å®ç°æ–¹å¼å§ è¿™é‡Œå…ˆçœ‹ä¸€ä¸ªtoydbå½“ä¸­ç»™å‡ºçš„ä¾‹å­æ¥ç†è§£ä¸€ä¸‹ï¼Œ\n1 2 3 4 5 6 7 //! Time //! 5 //! 4 a4 //! 3 b3 x //! 2 //! 1 a1 c1 d1 //! a b c d Keys åœ¨t1æ—¶åˆ»ï¼ŒæŸä¸ªäº‹åŠ¡å†™å…¥äº†a=a1,c=c1,d=d1å¹¶æäº¤ åœ¨t3æ—¶åˆ»ï¼ŒæŸä¸ªäº‹åŠ¡å†™å…¥äº†b=b3,åˆ é™¤äº†d åœ¨t4æ—¶åˆ»ï¼ŒæŸä¸ªäº‹åŠ¡å†™å…¥äº†a=a4 åœ¨t2æ—¶åˆ»ï¼Œå¼€å¯äº†äº‹åŠ¡T1ï¼Œé‚£ä¹ˆä»–å°±èƒ½å¤Ÿè¯»å–åˆ°a=a1,c=c1,d=d1 åœ¨ t 5 æ—¶åˆ»ï¼Œå¼€å¯äº†äº‹åŠ¡ T 2, é‚£ä¹ˆä»–å°±èƒ½å¤Ÿè¯»å–åˆ° a=a 4, b=b 3,c=c1 äº‹åŠ¡çš„æ—¶é—´æˆ–è€…ç‰ˆæœ¬çš„æ¦‚å¿µæ˜¯æ ¹æ®äº‹åŠ¡beginå†³å®šçš„ï¼Œæ¯”å¦‚è¯´T2è¯»å–çš„ç‰©ç†æ—¶é—´å¯èƒ½è½åäºT5ï¼Œä½†æ˜¯ç”±äºT2äº‹åŠ¡beginæ—©äºT5ï¼Œæ‰€ä»¥ä»–å°±èƒ½å¤Ÿè¯»å–åˆ°çš„æ•°æ®çš„ç‰ˆæœ¬å°±æ—©äºT5(å…¶å®è¿™ä¸ªä¹Ÿæ˜¯æ ¹æ®å¹¶å‘æ§åˆ¶åè®®å†³å®šçš„ï¼Œå¦‚æœä½¿ç”¨OCCçš„è¯ï¼Œäº‹åŠ¡çš„æ—¶é—´å°±æ˜¯validateçš„æ—¶é—´)ã€‚\nè®°å½•çœŸæ­£å˜æˆå¯è§æ˜¯æ ¹æ®æäº¤çš„æ—¶åˆ»å†³å®šçš„ï¼Œåœ¨äº‹åŠ¡æœªæäº¤å‰ï¼Œè¯¥äº‹åŠ¡å†™å…¥çš„æ•°æ®å¯¹äºè‡ªå·±æ˜¯å¯è§çš„ï¼Œä½†æ˜¯å¯¹äºå…¶ä»–çš„äº‹åŠ¡ä¸å¯è§ï¼Œåœ¨çœ‹ä¸€ä¸ªä¾‹å­ï¼š\n1 2 3 4 5 6 7 8 9 //! Active set: [2, 5] //! //! Time //! 5 (a5) //! 4 a4 //! 3 b3 x //! 2 (x) (e2) //! 1 a1 c1 d1 //! a b c d e Keys äº‹åŠ¡T2å†™å…¥çš„æ•°æ®ï¼Œä½†æ˜¯å¹¶æœªæäº¤ï¼ŒT2ç»´æŠ¤åœ¨Active setå½“ä¸­,åˆ é™¤c1å’Œå†™å…¥e2å¯¹äºè‡ªèº«æ˜¯å¯è§çš„ï¼Œä½†æ˜¯å¯¹äºåé¢å¼€å¯çš„äº‹åŠ¡T5æ˜¯ä¸å¯è§çš„ã€‚\nMVCC in Miniob åœ¨ä»‹ç»toydbçš„MVCCçš„å®ç°ä¹‹å‰ï¼Œå…ˆçœ‹ä¸€ä¸‹Miniobçš„MVCCå®ç°,è™½ç„¶å­˜åœ¨å˜æ›´æ— æ³•ä¸€æ¬¡æ€§å¯¹å¤–æš´éœ²çš„é—®é¢˜ï¼Œä½†æ˜¯å®ç°çš„æ¯”è¾ƒç®€å•ï¼Œå¾ˆå¥½ç†è§£ï¼š\nMVCCå½“ä¸­çš„ç‰ˆæœ¬æ˜¯åŸºäºtidçš„ï¼Œåœ¨å¼€å¯äº†MVCCæ¨¡å¼ä¹‹åï¼Œæ¯ä¸€æ¡recordä¼šç”Ÿæˆä¸¤ä¸ªsys_fieldï¼Œåˆ†åˆ«å­˜å‚¨beginå’Œendï¼Œæ¥æ ‡è¯†ä¸€ä¸ªäº‹åŠ¡çš„å¯è§æ€§ï¼Œè¿™é‡Œä¼¼ä¹å¹¶æ²¡æœ‰ä¸€ä¸ªç»Ÿä¸€çš„æ ‡å‡†ï¼Œåªè¦èƒ½æ»¡è¶³MVCCåè®®æœ¬èº«çš„è¦æ±‚å³å¯ï¼Œåœ¨Miniobå½“ä¸­çš„è®¾ç½®å¦‚ä¸‹ï¼š\nrecordé€šè¿‡beginå’Œend ä¸¤ä¸ªidè¿›è¡ŒçŠ¶æ€ç®¡ç†ï¼Œbeginç”¨äºè¡¨ç¤ºäº‹åŠ¡å¼€å§‹çš„æ—¶é—´ï¼Œendä¸ºäº‹åŠ¡ç»“æŸçš„æ—¶é—´ï¼Œå¯¹äºä¸€æ¡recordï¼š\nå½“ä¸€ä¸ªäº‹åŠ¡å¼€å§‹æ—¶ï¼Œæ–°çš„recordçš„beginè®¾ç½®ä¸º-trx_idï¼Œendä¸ºmax_int32,è¡¨ç¤ºäº‹åŠ¡å†™å…¥ä½†æœªæäº¤ï¼Œè€Œåˆ é™¤æ—¶åˆ™å°†endè®¾ç½®ä¸º-trx_idï¼Œè¡¨ç¤ºåˆ é™¤ä½†æœªæäº¤ å†™å…¥æ“ä½œæäº¤æ—¶ï¼Œå°†beginè®¾ç½®ä¸ºtrx_idï¼Œåˆ é™¤æ“ä½œæäº¤æ—¶å°†endè®¾ç½®ä¸ºtrx_idï¼Œæœ€ç»ˆä¼šäº§ç”Ÿäº”ç§çŠ¶æ€ begin_xid end_xid è‡ªèº«å¯è§ å…¶ä»–äº‹åŠ¡å¯è§ è¯´æ˜ -trx_id MAX å¯è§ ä¸å¯è§ ç”±å½“å‰äº‹åŠ¡å†™å…¥ï¼Œä½†è¿˜æœªæäº¤ï¼Œå¯¹å…¶ä»–äº‹åŠ¡ä¸å¯è§ trx_id MAX å·²æäº¤ å¯¹æ–°äº‹åŠ¡å¯è§ å†™å…¥å¹¶ä¸”å·²ç»æäº¤ï¼Œå¯¹ä¹‹åçš„æ–°äº‹åŠ¡å¯è§ ä»»æ„æ­£æ•° trx_id å·²æäº¤ æ—§äº‹åŠ¡å¯è§ï¼Œæ–°äº‹åŠ¡ä¸å¯è§ åœ¨å½“å‰äº‹åŠ¡ä¸­è¿›è¡Œåˆ é™¤ï¼Œå¹¶äº‹åŠ¡æäº¤ ä»»æ„æ­£æ•° -trx_id ä¸å¯è§ å¯è§ åœ¨å½“å‰äº‹åŠ¡ä¸­è¿›è¡Œåˆ é™¤ï¼Œæœªæäº¤ -trx_id -trx_id ä¸å¯è§ ä¸å¯è§ ç”±å½“å‰äº‹åŠ¡è¿›è¡Œå†™å…¥ï¼Œå¹¶ä¸”åˆè¢«å½“å‰äº‹åŠ¡åˆ é™¤ï¼Œå¹¶ä¸”æœªæäº¤ å…¶ä¸­ï¼Œå·²æäº¤æŒ‡çš„å°±æ˜¯å½“å‰äº‹åŠ¡å·²ç»ç»“æŸï¼Œè‡ªç„¶ä¸å­˜åœ¨ä»€ä¹ˆå¯è§ä¸å¯è§çš„é—®é¢˜ã€‚è€ŒMiniobå½“ä¸­çš„éš”ç¦»çº§åˆ«åº”å½“æ˜¯å’Œtoydbä¸€æ ·çš„å¿«ç…§éš”ç¦»ï¼Œå› ä¸ºæœªæäº¤çš„äº‹åŠ¡çš„ begin \u0026lt; 0ï¼Œå› æ­¤æ˜¯æ°¸è¿œæ— æ³•è¯»å–åˆ°æ–°å†™å…¥çš„recordï¼Œå› æ­¤æ˜¯ä¸å­˜åœ¨å¹»è¯»æƒ…å†µçš„ã€‚\nå¯¹äºrecordæ˜¯å¦å¯è§çš„åˆ¤æ–­ï¼Œåœ¨visit_recordå½“ä¸­æä¾›äº†ä¸€æ®µä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 if (begin_xid \u0026gt; 0 \u0026amp;\u0026amp; end_xid \u0026gt; 0) { if (trx_id_ \u0026gt;= begin_xid \u0026amp;\u0026amp; trx_id_ \u0026lt;= end_xid) { rc = RC::SUCCESS; } else { rc = RC::RECORD_INVISIBLE; } } else if (begin_xid \u0026lt; 0) { // begin xid å°äº0è¯´æ˜æ˜¯åˆšæ’å…¥è€Œä¸”æ²¡æœ‰æäº¤çš„æ•°æ® rc = (-begin_xid == trx_id_) ? RC::SUCCESS : RC::RECORD_INVISIBLE; } else if (end_xid \u0026lt; 0) { // end xid å°äº0 è¯´æ˜æ˜¯æ­£åœ¨åˆ é™¤ä½†æ˜¯è¿˜æ²¡æœ‰æäº¤çš„æ•°æ® if (readonly) { // å¦‚æœ -end_xid å°±æ˜¯å½“å‰äº‹åŠ¡çš„äº‹åŠ¡å·ï¼Œè¯´æ˜æ˜¯å½“å‰äº‹åŠ¡åˆ é™¤çš„ rc = (-end_xid != trx_id_) ? RC::SUCCESS : RC::RECORD_INVISIBLE; } else { // å¦‚æœå½“å‰æƒ³è¦ä¿®æ”¹æ­¤æ¡æ•°æ®ï¼Œå¹¶ä¸”ä¸æ˜¯å½“å‰äº‹åŠ¡åˆ é™¤çš„ï¼Œç®€å•çš„æŠ¥é”™ // è¿™æ˜¯äº‹åŠ¡å¹¶å‘å¤„ç†çš„ä¸€ç§æ–¹å¼ï¼Œéå¸¸ç®€å•ç²—æš´ã€‚å…¶å®ƒçš„å¹¶å‘å¤„ç†æ–¹æ³•ï¼Œå¯ä»¥ç­‰å¾…ï¼Œæˆ–è€…è®©å®¢æˆ·ç«¯é‡è¯• // æˆ–è€…ç­‰äº‹åŠ¡ç»“æŸåï¼Œå†æ£€æµ‹ä¿®æ”¹çš„æ•°æ®æ˜¯å¦æœ‰å†²çª rc = (-end_xid != trx_id_) ? RC::LOCKED_CONCURRENCY_CONFLICT : RC::RECORD_INVISIBLE; } } å¦‚æœæƒ³è¿›ä¸€æ­¥äº†è§£Miniobçš„äº‹åŠ¡æ¨¡å—çš„è¯ï¼Œå¯ä»¥çœ‹è¿™ä¸ªï¼šminiob-transaction.md é™¤æ­¤ä¹‹å¤–ï¼Œ23fallçš„15-455åŒæ ·ä¹Ÿæä¾›äº†MVCCï¼ŒåŸºäºMVOCCå®ç°çš„ï¼Œä»¥å•ä¸ªFieldä¸ºå•ä½å®ç°çš„å¤šç‰ˆæœ¬ï¼Œç¬”è€…ç›®å‰å³æ²¡åšä¹Ÿæ²¡ç»†çœ‹ï¼Œè¯»è€…å¦‚æœæ„Ÿå…´è¶£çš„è¯å¯ä»¥çœ‹ä»¥ä¸‹é“¾æ¥ï¼šProject #4 - Concurrency Control | CMU 15-445/645 :: Intro to Database Systems (Fall 2023)\nå®ç° é¦–å…ˆè¡¥å……ç‚¹ç†è®ºï¼š\nåœ¨toydbå½“ä¸­ï¼ŒMVCCæ‰€æä¾›çš„éš”ç¦»çº§åˆ«ä¸ºå¿«ç…§éš”ç¦»ï¼Œäº‹åŠ¡åªèƒ½çœ‹åˆ°æ•°æ®åº“çš„ä¸€ä¸ªä¸€è‡´æ€§å¿«ç…§ï¼Œè€Œè¿™ä¸ªå¿«ç…§æ˜¯æ ¹æ®äº‹åŠ¡åˆ›å»ºçš„æ—¶é—´å†³å®šçš„ï¼Œå³äº‹åŠ¡åªèƒ½å¤Ÿçœ‹åˆ°äº‹åŠ¡åˆ›å»ºå‰çš„æœ€æ–°çš„æ•°æ®ï¼Œä»¥åŠç”±è‡ªå·±å†™å…¥çš„æ–°æ•°æ®ï¼Œç›®å‰è¿˜æœªæäº¤çš„æ´»è·ƒäº‹åŠ¡ä¹‹é—´ç›¸äº’éš”ç¦»äº’ä¸å½±å“ã€‚ Toydb å¹¶æ²¡æœ‰å®ç° GC åŠŸèƒ½ï¼Œä¼šä¿å­˜æ•°æ®çš„æ‰€æœ‰ç‰ˆæœ¬ï¼Œå› æ­¤å°±å¯ä»¥æ”¯æŒ time travel queryï¼Œå³ä¼ å…¥ä¸€ä¸ªæ—¶é—´æˆ³ï¼Œç„¶åè·å–ä¸€ä¸ªé‚£æ—¶çš„å¿«ç…§ï¼Œè¿›è¡Œåªè¯»è¯·æ±‚ (ç”±äºåŸºäºæ—§ç‰ˆæœ¬è¿›è¡Œå†™è¯·æ±‚ä¼šæ‰°ä¹±å½“å‰æ•°æ®åº“çš„çŠ¶æ€ï¼Œå¦‚è¿›è¡Œ set x = x + 1ï¼ŒåŸæœ¬ x = 3ï¼Œä½†æ˜¯ç›®å‰å·²ç»æ˜¯ x = 5 äº†ï¼Œå› æ­¤ time travel åªæ”¯æŒåªè¯»äº‹åŠ¡)ï¼Œå¼€å‘è€…ç‰¹æ„å¼ºè°ƒäº†è¿™æ˜¯ä¸€ä¸ª feature è€Œä¸æ˜¯ bugï¼Œä¸è¿‡æ„Ÿè§‰å¤šå°‘æœ‰ç‚¹æ¬²ç›–å¼¥å½°äº†ã€‚ å¥½äº†ï¼Œæ¥ä¸‹æ¥æ¥çœ‹ä¸€ä¸‹å…·ä½“çš„å®ç°ï¼Œåœ¨toydbå½“ä¸­ï¼Œäº‹åŠ¡çš„ç›¸å…³é€»è¾‘å…¨éƒ¨å®šä¹‰åœ¨src/storage/mvcc.rså½“ä¸­ï¼Œåªæœ‰ä¸€ä¸ªæ–‡ä»¶ï¼Œå…¶ä»–çš„åƒæ˜¯debug.rsï¼Œkeycode.rsåªæ˜¯æä¾›ä¸€äº›è¾…åŠ©æ”¯æŒï¼Œç”¨åˆ°çš„æ—¶å€™å†çœ‹çœ‹ã€‚\nåœ¨ä»‹ç»MVCCä»¥åŠäº‹åŠ¡æ˜¯å¦‚ä½•å®ç°ä¹‹å‰ï¼Œå…ˆæ¢³ç†ä¸€ä¸‹å®šä¹‰çš„ç»“æ„ä½“å’Œä¹‹é—´çš„å…³ç³»\nTransaction äº‹åŠ¡æœ€åŸºç¡€çš„ç»“æ„ä½“ä¸ºTransactionï¼š\nEngineä¸ºä¸€ä¸ªTraitï¼Œåœ¨å…¶ä¸­æä¾›äº†åŸºç¡€çš„CRUDåŠŸèƒ½ï¼Œè€Œä¸Šä¸€ç« ä»‹ç»çš„Bitcaskå’ŒMemoryéƒ½å®ç°äº†è¿™ä¸ªTraitï¼Œå…·ä½“ä½¿ç”¨çš„å“ªä¸ªä¸Šå±‚åº”ç”¨æ— éœ€å…³å¿ƒ TransactionStateç”¨äºè¡¨ç¤ºäº‹åŠ¡çš„çŠ¶æ€ 1 2 3 4 5 6 7 /// An MVCC transaction. pub struct Transaction\u0026lt;E: Engine\u0026gt; { /// The underlying engine, shared by all transactions. engine: Arc\u0026lt;Mutex\u0026lt;E\u0026gt;\u0026gt;, /// The transaction state. st: TransactionState, } TransactionState åœ¨æ³¨é‡Šå½“ä¸­ï¼Œå¯¹äºTransactionStateçš„è®¾è®¡ç†å¿µåšäº†æ¯”è¾ƒè¯¦ç»†çš„è¯´æ˜ï¼Œç®€è€Œè¨€ä¹‹å°±æ˜¯ï¼Œäº‹åŠ¡çŠ¶æ€çš„è®¾è®¡ä½¿å¾—äº‹åŠ¡å¯ä»¥åœ¨ä¸åŒçš„ç»„ä»¶ä¹‹é—´å®‰å…¨åœ°ä¼ é€’ï¼Œå¹¶ä¸”å¯ä»¥åœ¨ä¸ç›´æ¥å¼•ç”¨äº‹åŠ¡æœ¬èº«çš„æƒ…å†µä¸‹è¢«å¼•ç”¨ï¼Œæœ‰åŠ©äºç®€åŒ–äº‹åŠ¡ç®¡ç†ã€‚\nTransacationStateå½“ä¸­æä¾›äº†ä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºåˆ¤æ–­ç»™å®šçš„versionå¯¹äºå½“å‰äº‹åŠ¡æ˜¯å¦å¯è§ï¼Œé€»è¾‘å¦‚ä¸‹ï¼š\nå¦‚æœversionæ¥è‡ªæ´»è·ƒäº‹åŠ¡ï¼Œå³å¤„äºactive_setå½“ä¸­ï¼Œé‚£ä¹ˆä»£è¡¨ä¸ºæ–°å†™å…¥çš„ï¼Œä¸å¯è§ å¦‚æœä¸ºåªè¯»äº‹åŠ¡ï¼Œé‚£ä¹ˆèƒ½çœ‹åˆ°å°äºversionçš„(ä¹‹å‰äº‹åŠ¡åˆ›å»ºçš„) å¦‚æœæ˜¯æ™®é€šäº‹åŠ¡ï¼Œé‚£ä¹ˆå¯ä»¥çœ‹åˆ°ä¹‹å‰çš„å’Œè‡ªèº«å†™å…¥(\u0026lt;=) A Transaction\u0026rsquo;s state, which determines its write version and isolation. It is separate from Transaction to allow it to be passed around independently of the engine. There are two main motivations for this:\nIt can be exported via Transaction.state(), (de)serialized, and later used to instantiate a new functionally equivalent Transaction via Transaction::resume(). This allows passing the transaction between the storage engine and SQL engine (potentially running on a different node) across the Raft state machine boundary. It can be borrowed independently of Engine, allowing references to it in VisibleIterator, which would otherwise result in self-references. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 #[derive(Clone, Debug, PartialEq, Serialize, Deserialize)] pub struct TransactionState { /// The version this transaction is running at. Only one read-write /// transaction can run at a given version, since this identifies its /// writes. pub version: Version, /// If true, the transaction is read only. pub read_only: bool, /// The set of concurrent active (uncommitted) transactions, as of the start /// of this transaction. Their writes should be invisible to this /// transaction even if they\u0026#39;re writing at a lower version, since they\u0026#39;re /// not committed yet. pub active: HashSet\u0026lt;Version\u0026gt;, } impl TransactionState { /// Checks whether the given version is visible to this transaction. /// /// Future versions, and versions belonging to active transactions as of /// the start of this transaction, are never isible. /// /// Read-write transactions see their own writes at their version. /// /// Read-only queries only see versions below the transaction\u0026#39;s version, /// excluding the version itself. This is to ensure time-travel queries see /// a consistent version both before and after any active transaction at /// that version commits its writes. See the module documentation for /// details. fn is_visible(\u0026amp;self, version: Version) -\u0026gt; bool { if self.active.get(\u0026amp;version).is_some() { false } else if self.read_only { version \u0026lt; self.version } else { version \u0026lt;= self.version } } } MVCC MVCCå¯ä»¥è®¤ä¸ºæ˜¯ä¸€ä¸ªwrapperï¼Œå…·ä½“çš„é€»è¾‘æ˜¯ç”±ä¸Šé¢çš„Transactionæ¥å®ç°çš„ï¼Œè°ƒç”¨Transactionå½“ä¸­å¯¹åº”çš„å‡½æ•°ï¼Œåœ¨å…¶ä¸­å®šä¹‰äº†ä¸€ä¸ªå­˜å‚¨å¼•æ“çš„shared_ptrï¼Œåœ¨è°ƒç”¨æ—¶ä¼šä¼ é€’ç»™Transaction,ä¸ºä»€ä¹ˆéœ€è¦ä½¿ç”¨Mutexä¹Ÿåœ¨æ³¨é‡Šå½“ä¸­ç»™å‡ºã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 /// An MVCC-based transactional key-value engine. It wraps an underlying storage /// engine that\u0026#39;s used for raw key/value storage. /// /// While it supports any number of concurrent transactions, individual read or /// write operations are executed sequentially, serialized via a mutex. There /// are two reasons for this: the storage engine itself is not thread-safe, /// requiring serialized access, and the Raft state machine that manages the /// MVCC engine applies commands one at a time from the Raft log, which will /// serialize them anyway. pub struct MVCC\u0026lt;E: Engine\u0026gt; { engine: Arc\u0026lt;Mutex\u0026lt;E\u0026gt;\u0026gt;, } impl\u0026lt;E: Engine\u0026gt; MVCC\u0026lt;E\u0026gt; { /// Creates a new MVCC engine with the given storage engine. pub fn new(engine: E) -\u0026gt; Self { Self { engine: Arc::new(Mutex::new(engine)) } } /// Begins a new read-write transaction. pub fn begin(\u0026amp;self) -\u0026gt; Result\u0026lt;Transaction\u0026lt;E\u0026gt;\u0026gt; { Transaction::begin(self.engine.clone()) } /// Begins a new read-only transaction at the latest version. pub fn begin_read_only(\u0026amp;self) -\u0026gt; Result\u0026lt;Transaction\u0026lt;E\u0026gt;\u0026gt; { Transaction::begin_read_only(self.engine.clone(), None) } /// Begins a new read-only transaction as of the given version. pub fn begin_as_of(\u0026amp;self, version: Version) -\u0026gt; Result\u0026lt;Transaction\u0026lt;E\u0026gt;\u0026gt; { Transaction::begin_read_only(self.engine.clone(), Some(version)) } /// Resumes a transaction from the given transaction state. pub fn resume(\u0026amp;self, state: TransactionState) -\u0026gt; Result\u0026lt;Transaction\u0026lt;E\u0026gt;\u0026gt; { Transaction::resume(self.engine.clone(), state) } /// Fetches the value of an unversioned key. pub fn get_unversioned(\u0026amp;self, key: \u0026amp;[u8]) -\u0026gt; Result\u0026lt;Option\u0026lt;Vec\u0026lt;u8\u0026gt;\u0026gt;\u0026gt; { self.engine.lock()?.get(\u0026amp;Key::Unversioned(key.into()).encode()?) } /// Sets the value of an unversioned key. pub fn set_unversioned(\u0026amp;self, key: \u0026amp;[u8], value: Vec\u0026lt;u8\u0026gt;) -\u0026gt; Result\u0026lt;()\u0026gt; { self.engine.lock()?.set(\u0026amp;Key::Unversioned(key.into()).encode()?, value) } /// Returns the status of the MVCC and storage engines. pub fn status(\u0026amp;self) -\u0026gt; Result\u0026lt;Status\u0026gt; { let mut engine = self.engine.lock()?; let versions = match engine.get(\u0026amp;Key::NextVersion.encode()?)? { Some(ref v) =\u0026gt; bincode::deserialize::\u0026lt;u64\u0026gt;(v)? - 1, None =\u0026gt; 0, }; let active_txns = engine.scan_prefix(\u0026amp;KeyPrefix::TxnActive.encode()?).count() as u64; Ok(Status { versions, active_txns, storage: engine.status()? }) } } Status ä¸æ€ä¹ˆé‡è¦ï¼Œçœ‹ä¸€ä¸‹å°±å¥½ï¼Œä½œä¸ºå‡½æ•°è¿”å›å€¼æ¥è¡¨ç¤ºå½“å‰äº‹åŠ¡çš„çŠ¶æ€ï¼Œå…¶ä¸­çš„storageæ˜¯å­˜å‚¨å¼•æ“çš„storageï¼Œåœ¨ä¸Šä¸€ç« ä»‹ç»è¿‡äº†\n1 2 3 4 5 6 7 8 9 10 /// MVCC engine status. #[derive(Clone, Debug, PartialEq, Serialize, Deserialize)] pub struct Status { /// The total number of MVCC versions (i.e. read-write transactions). pub versions: u64, /// Number of currently active transactions. pub active_txns: u64, /// The storage engine. pub storage: super::engine::Status, } Key èƒ½å¤Ÿå€ŸåŠ©kvå­˜å‚¨å¼•æ“å®ç°MVCCçš„æ ¸å¿ƒï¼Œå®ç°ä¸Šé‡‡ç”¨enumï¼Œrustå½“ä¸­çš„æšä¸¾éå¸¸å¼ºå¤§ï¼Œåœ¨ Rust ä¸­ï¼Œæšä¸¾æ˜¯ä¸€ç§æ•°æ®ç±»å‹ï¼Œå®ƒå¯ä»¥æœ‰ä¸åŒçš„å€¼ï¼ˆç§°ä¸ºå˜ä½“ï¼‰ï¼Œä½†åœ¨ä»»ä½•ç»™å®šæ—¶åˆ»åªèƒ½æœ‰å…¶ä¸­ä¸€ä¸ªå€¼ã€‚æ¯ä¸ªæšä¸¾å˜ä½“å¯ä»¥å…³è”ä¸åŒç±»å‹å’Œæ•°é‡çš„æ•°æ®ã€‚\nå€ŸåŠ©rustçš„enumï¼Œå°±å¯ä»¥åœ¨åˆ›å»ºkeyæ—¶å‘å…¶ä¸­ä¼ é€’ä¸€ä¸ªå€¼ï¼Œæ—¢å¯ä»¥è¡¨ç¤ºå½“å‰çš„åŠ¨ä½œæˆ–è€…çŠ¶æ€ï¼Œåˆå¯ä»¥è·å¾—è¿™ä¸ªåŠ¨ä½œéœ€è¦çš„å€¼ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œåœ¨éœ€è¦å†™å…¥ä¸€ä¸ªkeyçš„æ–°çš„versionæ—¶ï¼Œé‚£ä¹ˆå°±éœ€è¦ä»¥å½“å‰çš„key + versionæ¥ä½œä¸ºkeyï¼Œé‚£ä¹ˆå°±å¯ä»¥å¾ˆè‡ªç„¶çš„ä½¿ç”¨enumæ¥è¡¨ç¤ºä¸€ä¸ªå¤åˆçš„keyï¼Œä¹‹åencodeè¿›è¡Œå­˜å‚¨ï¼š\n1 2 3 4 5 6 7 8 9 /// A versioned key/value pair. Version( #[serde(with = \u0026#34;serde_bytes\u0026#34;)] #[serde(borrow)] Cow\u0026lt;\u0026#39;a, [u8]\u0026gt;, Version, ), // æŸå¤„è°ƒç”¨ session.set(\u0026amp;Key::Version(key.into(),self.st.version).encode()?, bincode::serialize(\u0026amp;value)?) è€Œå¯¹äºnext_versionè€Œè¨€ï¼Œå¹¶ä¸éœ€è¦é¢å¤–çš„å€¼ï¼Œåªéœ€è¦keyä¸ºnext_versionï¼Œè€Œvalueä¸ºä¸€ä¸ªu64å³å¯ï¼Œé‚£ä¹ˆå°±ä¸å®šä¹‰é™„åŠ çš„å€¼ï¼š\n1 2 3 4 5 6 7 /// The next available version. NextVersion, // æŸå¤„è°ƒç”¨ let versions = match engine.get(\u0026amp;Key::NextVersion.encode()?)? { Some(ref v) =\u0026gt; bincode::deserialize::\u0026lt;u64\u0026gt;(v)? - 1, None =\u0026gt; 0, }; Keyçš„å®Œæ•´å®šä¹‰å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 /// MVCC keys, using the KeyCode encoding which preserves the ordering and /// grouping of keys. Cow byte slices allow encoding borrowed values and /// decoding into owned values. #[derive(Debug, Deserialize, Serialize)] pub enum Key\u0026lt;\u0026#39;a\u0026gt; { /// The next available version. NextVersion, /// Active (uncommitted) transactions by version. TxnActive(Version), /// A snapshot of the active set at each version. Only written for /// versions where the active set is non-empty (excluding itself). TxnActiveSnapshot(Version), /// Keeps track of all keys written to by an active transaction (identified /// by its version), in case it needs to roll back. TxnWrite( Version, #[serde(with = \u0026#34;serde_bytes\u0026#34;)] #[serde(borrow)] Cow\u0026lt;\u0026#39;a, [u8]\u0026gt;, ), /// A versioned key/value pair. Version( #[serde(with = \u0026#34;serde_bytes\u0026#34;)] #[serde(borrow)] Cow\u0026lt;\u0026#39;a, [u8]\u0026gt;, Version, ), /// Unversioned non-transactional key/value pairs. These exist separately /// from versioned keys, i.e. the unversioned key \u0026#34;foo\u0026#34; is entirely /// independent of the versioned key \u0026#34;foo@7\u0026#34;. These are mostly used /// for metadata. Unversioned( #[serde(with = \u0026#34;serde_bytes\u0026#34;)] #[serde(borrow)] Cow\u0026lt;\u0026#39;a, [u8]\u0026gt;, ), } æ­¤å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªKeyPrefixç”¨äºè¿›è¡Œå‰ç¼€åŒ¹é…ï¼Œå’ŒKeyå·®ä¸å¤šï¼Œè¿™é‡Œå°±ä¸åšä»‹ç»äº†ã€‚\nMVCC Impl ç»ˆäºï¼Œè¦å¼€å§‹åˆ†æMVCCçš„å®ç°äº†ï¼Œè¿™ä¸€éƒ¨åˆ†å…¶å®å°±æ˜¯Transactionçš„impl,åœ¨è¿™ä¸€éƒ¨åˆ†ï¼Œç¬”è€…ä¼šæŠŠé‡ç‚¹æ”¾åœ¨MVCCä¸å­˜å‚¨å¼•æ“çš„äº¤äº’ä¸Šï¼Œå³å¦‚ä½•ä½¿ç”¨KVå­˜å‚¨å¼•æ“æ¥å®ç°MVCCã€‚\nåƒå‰é¢è¯´çš„é‚£æ ·ï¼Œtoydbæ”¯æŒtime travelçš„åªè¯»äº‹åŠ¡ï¼Œå› æ­¤åœ¨å¼€å¯äº‹åŠ¡è¿™å—ï¼Œæä¾›äº†ä¸¤ä¸ªå‡½æ•°ï¼Œåˆ†åˆ«å¯¹åº”read-writeçš„äº‹åŠ¡å’Œread-onlyçš„äº‹åŠ¡\nBegin beginç”¨äºå¼€å¯ä¸€ä¸ªread-writeçš„äº‹åŠ¡ï¼Œå¤§è‡´å¹²äº†ä¸€ä¸‹å‡ ä»¶äº‹ï¼š\nè·å–ä¸€ä¸ªVersionä½œä¸ºå½“å‰äº‹åŠ¡çš„tid,æˆ–è€…å¯ä»¥è§†ä¸ºä¸€ä¸ªæ—¶é—´æˆ³ï¼Œä¹‹å+1å†™å›ï¼Œç”±äºtoydbå¹¶æ²¡æœ‰å®ç°buffer pool + walï¼Œå› æ­¤è¿™é‡Œçš„NextVersionæ˜¯å­˜å‚¨åœ¨å­˜å‚¨å¼•æ“å½“ä¸­çš„ï¼Œé‡‡ç”¨çš„æ˜¯åŒæ­¥å†™å…¥çš„æ–¹å¼(è¿™é‡Œå•æŒ‡bitcask,ä½¿ç”¨memoryçš„è¯å°±æ²¡æœ‰ä»€ä¹ˆæŒä¹…åŒ–å¯è¨€äº†ï¼Œä¸è¿‡åœ¨MVCCæ¨¡å—å½“ä¸­ï¼Œåªéœ€è¦åœ¨æ„engineçš„traitï¼Œé€šå¸¸ä¸å¤ªéœ€è¦è€ƒè™‘åº•å±‚) ä»å­˜å‚¨å¼•æ“å½“ä¸­æ‰«æï¼Œæ¢å¤å‡ºå½“å‰çš„active_setï¼Œè¿™é‡Œactive_seté‡‡ç”¨çš„æ˜¯åˆ†å¸ƒå­˜å‚¨çš„ï¼Œå³æ²¡å½“å¼€å¯ä¸€ä¸ªäº‹åŠ¡åï¼Œå°±å‘å­˜å‚¨å¼•æ“å½“ä¸­å†™å…¥ä¸€æ¡Key::TxnActiveï¼Œå¸¦ä¸Šè‡ªå·±çš„versionï¼Œä¹‹åæ‰«æå‡ºæ‰€æœ‰Key::TxnActiveçš„keyï¼Œæ¢å¤å‡ºactive_setï¼Œä¸ªäººè®¤ä¸ºè¿™æ ·è®¾è®¡çš„åŸå› æ˜¯bitcaskæœ¬èº«æ˜¯ä¸€ä¸ªappend-onlyçš„å­˜å‚¨å¼•æ“ï¼Œå°±ç®—æ˜¯å°†valueè®¾ç½®ä¸ºå®Œæ•´çš„active_setï¼Œé‚£ä¹ˆæ¯æ¬¡å†™å…¥ä¹Ÿæ˜¯è¿½åŠ å†™å…¥ï¼Œå¹¶ä¸”éœ€è¦å®Œæ•´çš„å†™å…¥æ•´ä¸ªactive_setï¼Œå†™å…¥é‡åè€Œå¢å¤§ï¼Œä¸å¦‚é‡‡ç”¨åˆ†å¸ƒå­˜å‚¨ï¼Œä»£ä»·æ˜¯è¯»å–æ—¶éœ€è¦è¿›è¡Œä¸€ä¸ªæ‰«æï¼Œä¸è¿‡active_setåªä¼šåœ¨äº‹åŠ¡beginçš„æ—¶å€™è¿›è¡Œè¯»å–ï¼Œä¹Ÿæ— ä¼¤å¤§é›… æ ¹æ®active_setæ¥ç”Ÿæˆä¸€ä¸ªsnapshotï¼Œç”¨äºè¿›è¡Œtime-travel readï¼Œtime traveléœ€è¦åšçš„æ˜¯è¯»å–åˆ°ç»™å®šæ—¶é—´æˆ³(version)æ—¶æ•°æ®åº“çš„å®Œæ•´çŠ¶æ€ï¼Œä¸èƒ½å¤Ÿç®€å•çš„é€šè¿‡ç‰ˆæœ¬è¿›è¡Œè¯»å–ï¼Œå› ä¸ºæœ‰äº›keyè™½ç„¶æ˜¯ç”±ç»™å®šversionä¹‹å‰çš„äº‹åŠ¡å†™å…¥çš„ï¼Œä½†æ˜¯äº‹åŠ¡æœªæäº¤ï¼Œé‚£ä¹ˆè¯¥keyå°±ä¸å¯è§ï¼Œè¿™ä¹Ÿæ˜¯snapshotå­˜åœ¨çš„æ„ä¹‰ï¼Œç”¨äºæ¢å¤æŸä¸€æ—¶é—´çš„äº‹åŠ¡éš”ç¦»æƒ…å†µï¼Œåˆ¤æ–­æ•°æ®çš„å¯è§æ€§ å°†è‡ªå·±çš„versionå†™å…¥ï¼Œè¡¥å……active_set 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 /// Begins a new transaction in read-write mode. This will allocate a new /// version that the transaction can write at, add it to the active set, and /// record its active snapshot for time-travel queries. fn begin(engine: Arc\u0026lt;Mutex\u0026lt;E\u0026gt;\u0026gt;) -\u0026gt; Result\u0026lt;Self\u0026gt; { let mut session = engine.lock()?; // Allocate a new version to write at. let version = match session.get(\u0026amp;Key::NextVersion.encode()?)? { Some(ref v) =\u0026gt; bincode::deserialize(v)?, None =\u0026gt; 1, }; session.set(\u0026amp;Key::NextVersion.encode()?, bincode::serialize(\u0026amp;(version + 1))?)?; // Fetch the current set of active transactions, persist it for // time-travel queries if non-empty, then add this txn to it. let active = Self::scan_active(\u0026amp;mut session)?; if !active.is_empty() { session.set(\u0026amp;Key::TxnActiveSnapshot(version).encode()?, bincode::serialize(\u0026amp;active)?)? } session.set(\u0026amp;Key::TxnActive(version).encode()?, vec![])?; drop(session); Ok(Self { engine, st: TransactionState { version, read_only: false, active } }) } Begin_read_only begin_read_onlyç”¨äºè¿›è¡Œread onlyçš„äº‹åŠ¡ï¼Œå¦‚æœä¼ å…¥äº†ä¸€ä¸ªversion,é‚£ä¹ˆå°±è¿›è¡Œtime-travelï¼Œå¦åˆ™æ ¹æ®æ•°æ®åº“æœ€æ–°çš„çŠ¶æ€è¿›è¡Œè¯»å–ï¼š\nè·å–æ•°æ®åº“æœ€æ–°çš„versionï¼Œå¦‚æœä¼ å…¥äº†as_ofå°±æ›¿æ¢æˆä¼ å…¥çš„versionï¼Œç”¨äºè¿›è¡Œtime travel(ä¼ å…¥çš„versionæ˜¯ä¸èƒ½å¤§äºæ•°æ®åº“æœ€æ–°çš„versionçš„) ä¹‹åå¦‚æœæ˜¯time travelï¼Œå°±æ ¹æ®versionå»è¯»å–snapshotï¼Œæ¥æ¢å¤active_setï¼Œå¦åˆ™å’Œbeginä¸€æ ·ï¼Œå»æ‰«æè·å–æœ€æ–°çš„active_set 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 /// Begins a new read-only transaction. If version is given it will see the /// state as of the beginning of that version (ignoring writes at that /// version). In other words, it sees the same state as the read-write /// transaction at that version saw when it began. fn begin_read_only(engine: Arc\u0026lt;Mutex\u0026lt;E\u0026gt;\u0026gt;, as_of: Option\u0026lt;Version\u0026gt;) -\u0026gt; Result\u0026lt;Self\u0026gt; { let mut session = engine.lock()?; // Fetch the latest version. let mut version = match session.get(\u0026amp;Key::NextVersion.encode()?)? { Some(ref v) =\u0026gt; bincode::deserialize(v)?, None =\u0026gt; 1, }; // If requested, create the transaction as of a past version, restoring // the active snapshot as of the beginning of that version. Otherwise, // use the latest version and get the current, real-time snapshot. let mut active = HashSet::new(); if let Some(as_of) = as_of { if as_of \u0026gt;= version { return Err(Error::Value(format!(\u0026#34;Version {} does not exist\u0026#34;, as_of))); } version = as_of; if let Some(value) = session.get(\u0026amp;Key::TxnActiveSnapshot(version).encode()?)? { active = bincode::deserialize(\u0026amp;value)?; } } else { active = Self::scan_active(\u0026amp;mut session)?; } drop(session); Ok(Self { engine, st: TransactionState { version, read_only: true, active } }) } Write \u0026amp;\u0026amp; Delete ç”±äºMVCCçš„append-onlyçš„ç‰¹æ€§(æ²¡æœ‰gc)ï¼Œå¯¹äºWriteå’ŒDeleteè¿›è¡Œç»Ÿä¸€å°è£…ï¼ŒDeleteè§†ä¸ºå†™å…¥ä¸€ä¸ªtombstone(MVCCå±‚é¢çš„tombstoneï¼Œè°ƒç”¨çš„å­˜å‚¨å¼•æ“è¿˜æ˜¯setæ¥å£ï¼Œä¸ä¼šåœ¨å­˜å‚¨å¼•æ“å½“ä¸­åˆ é™¤)ï¼Œåº•å±‚éƒ½æ˜¯é€šè¿‡write_versionæ¥å®ç°çš„:\n1 2 3 4 5 6 7 8 9 /// Deletes a key. pub fn delete(\u0026amp;self, key: \u0026amp;[u8]) -\u0026gt; Result\u0026lt;()\u0026gt; { self.write_version(key, None) } /// Sets a value for a key. pub fn set(\u0026amp;self, key: \u0026amp;[u8], value: Vec\u0026lt;u8\u0026gt;) -\u0026gt; Result\u0026lt;()\u0026gt; { self.write_version(key, Some(value)) } write_version\nåœ¨write_versionå½“ä¸­ï¼Œé¦–å…ˆè¿›è¡Œå†™å…¥å†²çªçš„æ£€æŸ¥ï¼Œå³æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–çš„äº‹åŠ¡æ­£åœ¨å¯¹å½“å‰çš„keyè¿›è¡Œå†™å…¥æ“ä½œï¼Œå®ç°æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œæ‰«æ(key,active.min)åˆ°(key,u64::MAX)èŒƒå›´å†…çš„keyï¼Œå¯¹äºæ‰«æå‡ºæ¥çš„keyå½“ä¸­æœ€æ–°çš„ç‰ˆæœ¬ï¼š\nå¦‚æœå¯¹äºå½“æ—¶äº‹åŠ¡å¯è§ï¼Œé‚£ä¹ˆå°±è¯æ˜ä¸ºè‡ªèº«å†™å…¥çš„ï¼Œæˆ–è€…æ˜¯æ¯”è‡ªå·±æ—©å¹¶ä¸”å·²ç»æäº¤çš„äº‹åŠ¡å†™å…¥çš„ï¼Œä¸å­˜åœ¨å†²çª å¦‚æœå¯¹å½“å‰äº‹åŠ¡ä¸å¯è§ï¼Œé‚£ä¹ˆå°±æ˜¯å…¶ä»–çš„æ´»è·ƒäº‹åŠ¡å†™å…¥çš„ï¼Œè¯æ˜æœ‰å…¶ä»–äº‹åŠ¡åœ¨å¹¶å‘å†™å…¥ï¼Œå­˜åœ¨å†²çª(åªè¦versionå­˜åœ¨äºactive_setå½“ä¸­å°±æ˜¯ä¸å¯è§çš„ï¼Œå¦åˆ™å†æ ¹æ®versionå¤§å°å»åˆ¤æ–­) åœ¨åˆ¤æ–­æ²¡æœ‰å†²çªä¹‹åï¼Œåˆ†åˆ«å†™å…¥ä¸€æ¡TrnWriteå’ŒVersionï¼ŒTxnWriteç”¨äºæ ‡å¿—å½“å‰çš„äº‹åŠ¡è¿›è¡Œå†™å…¥ï¼Œç”¨äºè¿›è¡Œå›æ»šï¼Œè€ŒVersionæ‰æ˜¯çœŸæ­£å­˜å‚¨æ•°æ®çš„key ä¸è¿‡æœ‰ä¸ªé—®é¢˜æ˜¯ï¼Œä¸ºäº†å®ç°MVCCï¼Œå³ä¾¿æ˜¯å½“å‰è¦åˆ é™¤çš„keyä¸å­˜åœ¨ï¼Œä¹Ÿä¼šå»å†™å…¥ä¸€æ¡versionï¼Œç»™å­˜å‚¨å¼•æ“å¸¦æ¥é¢å¤–çš„è´Ÿæ‹…\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 /// Writes a new version for a key at the transaction\u0026#39;s version. None writes /// a deletion tombstone. If a write conflict is found (either a newer or /// uncommitted version), a serialization error is returned. Replacing our /// own uncommitted write is fine. fn write_version(\u0026amp;self, key: \u0026amp;[u8], value: Option\u0026lt;Vec\u0026lt;u8\u0026gt;\u0026gt;) -\u0026gt; Result\u0026lt;()\u0026gt; { if self.st.read_only { return Err(Error::ReadOnly); } let mut session = self.engine.lock()?; // Check for write conflicts, i.e. if the latest key is invisible to us // (either a newer version, or an uncommitted version in our past). We // can only conflict with the latest key, since all transactions enforce // the same invariant. let from = Key::Version( key.into(), self.st.active.iter().min().copied().unwrap_or(self.st.version + 1), ) .encode()?; let to = Key::Version(key.into(), u64::MAX).encode()?; if let Some((key, _)) = session.scan(from..=to).last().transpose()? { match Key::decode(\u0026amp;key)? { Key::Version(_, version) =\u0026gt; { if !self.st.is_visible(version) { return Err(Error::Serialization); } } key =\u0026gt; return Err(Error::Internal(format!(\u0026#34;Expected Key::Version got {:?}\u0026#34;, key))), } } // Write the new version and its write record. // // NB: TxnWrite contains the provided user key, not the encoded engine // key, since we can construct the engine key using the version. session.set(\u0026amp;Key::TxnWrite(self.st.version, key.into()).encode()?, vec![])?; session .set(\u0026amp;Key::Version(key.into(), self.st.version).encode()?, bincode::serialize(\u0026amp;value)?) } Get Getçš„é€»è¾‘å°±å¾ˆç®€å•äº†ï¼Œæ‰¾åˆ°ä¸€ä¸ªkeyçš„å¯èƒ½çœ‹è§çš„ç‰ˆæœ¬(ä»0åˆ°è‡ªå·±å†™å…¥çš„ï¼ŒversionèŒƒå›´å¯¹åº”[0,self.version])ï¼Œä»æ–°åˆ°æ—§éå†ï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªè‡ªå·±èƒ½å¤Ÿçœ‹è§çš„ç‰ˆæœ¬ï¼Œè¿”å›ã€‚è¦æ˜¯å…¨éƒ¨éå†å®Œéƒ½æ²¡æœ‰é‚£å°±æ˜¯ä¸å­˜åœ¨èƒ½å¤Ÿè¯»å–åˆ°çš„ç‰ˆæœ¬\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 /// Fetches a key\u0026#39;s value, or None if it does not exist. pub fn get(\u0026amp;self, key: \u0026amp;[u8]) -\u0026gt; Result\u0026lt;Option\u0026lt;Vec\u0026lt;u8\u0026gt;\u0026gt;\u0026gt; { let mut session = self.engine.lock()?; let from = Key::Version(key.into(), 0).encode()?; let to = Key::Version(key.into(), self.st.version).encode()?; // è°ƒç”¨revä»æ–°çš„keyå¼€å§‹éå† let mut scan = session.scan(from..=to).rev(); while let Some((key, value)) = scan.next().transpose()? { match Key::decode(\u0026amp;key)? { Key::Version(_, version) =\u0026gt; { if self.st.is_visible(version) { return bincode::deserialize(\u0026amp;value); } } key =\u0026gt; return Err(Error::Internal(format!(\u0026#34;Expected Key::Version got {:?}\u0026#34;, key))), }; } Ok(None) } Commit \u0026amp;\u0026amp; Rollback å¯¹äºread onlyäº‹åŠ¡ï¼Œç”±äºå…¶å¯¹ç³»ç»Ÿä¸ä¼šäº§ç”Ÿä»»ä½•å½±å“ï¼Œä¹Ÿä¸ä¼šæŠŠè‡ªå·±æ·»åŠ åˆ°active_setå½“ä¸­ï¼Œå› æ­¤ç›´æ¥è¿”å›å³å¯ã€‚\ncommit\ncommitéœ€è¦åšçš„æœ‰ï¼š\næ‰«æå‡ºæ¥æ‰€æœ‰ç”±å½“å‰äº‹åŠ¡å†™å…¥çš„Key::TxnWriteï¼ŒTxnWriteæ˜¯ç”¨äºäº‹åŠ¡å›æ»šæ—¶æ’¤é”€å†™å…¥çš„ï¼Œæ—¢ç„¶äº‹åŠ¡æäº¤äº†å°±ä¸éœ€è¦äº†ï¼Œæ‰€ä»¥å…¨éƒ¨åˆ é™¤ å°†è‡ªå·±ä»active_setå½“ä¸­ç§»é™¤ï¼Œåˆ é™¤æ‰TxnActive(self.version)å³å¯ï¼Œè¿™ä¹Ÿæ˜¯active_setåˆ†å¸ƒå­˜å‚¨çš„å¥½å¤„ï¼Œæ›´æ”¹åªéœ€è¦æ“ä½œä¸€ä¸ªkey 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 /// Commits the transaction, by removing it from the active set. This will /// immediately make its writes visible to subsequent transactions. Also /// removes its TxnWrite records, which are no longer needed. pub fn commit(self) -\u0026gt; Result\u0026lt;()\u0026gt; { if self.st.read_only { return Ok(()); } let mut session = self.engine.lock()?; let remove = session .scan_prefix(\u0026amp;KeyPrefix::TxnWrite(self.st.version).encode()?) .map(|r| r.map(|(k, _)| k)) .collect::\u0026lt;Result\u0026lt;Vec\u0026lt;_\u0026gt;\u0026gt;\u0026gt;()?; for key in remove { session.delete(\u0026amp;key)? } session.delete(\u0026amp;Key::TxnActive(self.st.version).encode()?) } rollback\nåœ¨äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œæ— è®ºæ˜¯å†™å…¥è¿˜æ˜¯åˆ é™¤ï¼Œæ¯æ¬¡éƒ½æ˜¯å†™å…¥ä¸€ä¸ªversionï¼ŒåŒæ—¶å†™å…¥ä¸€ä¸ªKey::TxnWriteï¼Œç”¨äºæ ‡å¿—äº‹åŠ¡å¯¹æ•°æ®çš„æ›´æ”¹ï¼Œå› æ­¤åœ¨å›æ»šæ—¶ï¼Œåªéœ€è¦å½“å‰äº‹åŠ¡ä¹‹å‰å†™å…¥çš„Key::TxnWriteå…¨éƒ¨è¯»å–å‡ºæ¥ï¼Œè½¬æ¢ä¸ºKey::Versionï¼Œç„¶ååˆ é™¤è¿™ä¸ªkeyçš„å¯¹åº”versionï¼Œå°±å®Œæˆäº†undoçš„åŠ¨ä½œã€‚ä¹‹åå†å°†è‡ªå·±ä»active_setå½“ä¸­ç§»é™¤å³å¯ã€‚\nè¿˜æ˜¯è¦æä¸€ä¸‹ï¼Œè¿™é‡Œçš„åˆ é™¤æ˜¯mvccå±‚é¢çš„åˆ é™¤ï¼Œåªä¼šåˆ é™¤ç›¸åŒuser_keyç›¸åŒversionçš„Keyï¼Œä¸ä¼šåƒbitcaské‚£æ ·å†™å…¥ä¸€ä¸ªtombstoneå‰é¢æ‰€æœ‰çš„keyéƒ½ä¸å¯è¾¾ï¼Œåˆ†æmvccå°±è¦å±è”½æ‰åº•å±‚çš„å­˜å‚¨å¼•æ“ï¼Œåªå°†å…¶è§†ä¸ºä¸€ä¸ªç®€å•çš„kvå­˜å‚¨ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 /// Rolls back the transaction, by undoing all written versions and removing /// it from the active set. The active set snapshot is left behind, since /// this is needed for time travel queries at this version. pub fn rollback(self) -\u0026gt; Result\u0026lt;()\u0026gt; { if self.st.read_only { return Ok(()); } let mut session = self.engine.lock()?; let mut rollback = Vec::new(); let mut scan = session.scan_prefix(\u0026amp;KeyPrefix::TxnWrite(self.st.version).encode()?); while let Some((key, _)) = scan.next().transpose()? { match Key::decode(\u0026amp;key)? { Key::TxnWrite(_, key) =\u0026gt; { rollback.push(Key::Version(key, self.st.version).encode()?) // the version } key =\u0026gt; return Err(Error::Internal(format!(\u0026#34;Expected TxnWrite, got {:?}\u0026#34;, key))), }; rollback.push(key); // the TxnWrite record } drop(scan); for key in rollback.into_iter() { session.delete(\u0026amp;key)?; } session.delete(\u0026amp;Key::TxnActive(self.st.version).encode()?) // remove from active set } åŸå­æ€§å˜æ›´ åˆ°è¿™é‡Œï¼ŒMVCCçš„å®ç°æ–¹å¼åŸºæœ¬ä¸Šå·²ç»åˆ†æå®Œäº†ï¼Œç°åœ¨æ¥è¯´ä¸€ä¸‹Miniobå½“ä¸­é—ç•™çš„ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯äº‹åŠ¡åœ¨æäº¤æˆ–è€…å›æ»šæ—¶ä½œå‡ºçš„æ›´æ”¹æ²¡æœ‰åŠæ³•è¢«ä¸€æ¬¡æ€§è¯»åˆ°ã€‚\nå¯¹äºä¼ ç»Ÿçš„2PLï¼Œé€šè¿‡åŠ é”çš„æ–¹å¼ï¼Œé˜»æ­¢å…¶ä»–äº‹åŠ¡è¿›è¡Œè¯»å–ï¼Œä»è€Œä¿è¯åœ¨é‡Šæ”¾é”æ—¶ä¸€æ¬¡æ€§çš„å°†æ›´æ–°æš´éœ²ç»™å…¶ä»–çš„äº‹åŠ¡ï¼Œè€ŒMiniobå¼•å…¥MVCCå°±æ˜¯ä¸ºäº†é¿å…è¯»å†™å†²çªï¼Œå› æ­¤ä¸ä¼šåŠ é”ï¼Œåœ¨å†™å…¥çš„è¿‡ç¨‹ä¸­ï¼Œå…¶ä»–äº‹åŠ¡è‡ªç„¶å¯ä»¥è¿›è¡Œè¯»å–ï¼Œä»è€Œè¯»å–åˆ°ä¸åº”è¯¥å­˜åœ¨çš„ä¸­é—´æ€ã€‚\nå†æ¥è¯´ä¸€ä¸‹toydbæ˜¯æ€æ ·è§£å†³è¿™ä¸ªé—®é¢˜çš„ï¼ŒtoydbåŒæ ·æ²¡æœ‰å¼•å…¥å¤æ‚çš„å¹¶å‘æ§åˆ¶ï¼Œå¯¹äºW-Wå†²çªï¼Œè§£å†³æ–¹æ¡ˆä¹Ÿæ˜¯ç®€å•çš„è¿›è¡Œé‡è¯•ã€‚ä½†æ˜¯åœ¨å¯è§æ€§ä¸Šï¼Œtoydbå¼•å…¥äº†é¢å¤–çš„é™åˆ¶ï¼Œå³å¦‚æœå¯¹åº”çš„versionå­˜åœ¨äºactive_setå½“ä¸­ï¼Œé‚£ä¹ˆå°±æ˜¯ä¸å¯è§çš„(å¯¹å…¶ä»–äº‹åŠ¡).\nå› æ­¤å³ä¾¿æ˜¯å°†æ–°çš„keyéåŸå­æ€§çš„å†™å…¥åˆ°å­˜å‚¨å¼•æ“å½“ä¸­ï¼Œåªè¦ä¸ä»active_setå½“ä¸­åˆ é™¤ï¼Œé‚£ä¹ˆå°±æ˜¯ä¸å¯è§çš„ã€‚è€Œæ›´æ”¹active_setçš„è¿™ä¸ªåŠ¨ä½œæ˜¯åŸå­æ€§çš„ï¼Œå› æ­¤å°±å¯ä»¥ä¿è¯äº‹åŠ¡æäº¤æ—¶ä½œå‡ºçš„æ›´æ”¹ä¸€æ¬¡æ€§çš„å¯¹å¤–å¯è§ã€‚\nå¯é‡å¤è¯»\näº‹åŠ¡åœ¨beginæ—¶ï¼Œä¼šä»å­˜å‚¨å¼•æ“å½“ä¸­è¯»å–å¹¶å»ºç«‹å‡ºactive_setï¼Œå¹¶ä¸”ä¹‹ååœ¨äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹å½“ä¸­ï¼Œéƒ½ä»¥è¿™ä¸ªactive_setä¸ºå‡†ï¼Œå› æ­¤å³ä¾¿æ˜¯å…¶ä»–äº‹åŠ¡æäº¤äº†ï¼Œå†™å…¥çš„è®°å½•å¯¹å½“å‰äº‹åŠ¡è¿˜æ˜¯ä¸å¯è§çš„ï¼Œå°±ä¿è¯äº†å¯é‡å¤è¯»çš„é—®é¢˜ã€‚\nè¿™é‡Œçš„è®¾è®¡è¿˜æ˜¯éå¸¸å·§å¦™çš„ï¼Œç”¨ç®€å•çš„æ–¹æ³•è§£å†³äº†é—®é¢˜ï¼Œactive_setæ—¢ä¿è¯äº†åŸå­æ€§çš„æäº¤ï¼ŒåŒæ—¶æä¾›äº†å¯é‡å¤è¯»\nSummary toydbå€ŸåŠ©ä¸€ä¸ªkvå­˜å‚¨å®ç°äº†mvccï¼Œå¯¹äºMVCCè€Œè¨€ç¬”è€…è®¤ä¸ºæœ‰å‡ ä¸ªå…³é”®çš„é—®é¢˜ï¼Œtoydbä¹Ÿåˆ†åˆ«ç»™å‡ºäº†å¯¹åº”çš„è§£å†³æ–¹æ¡ˆï¼š\néš”ç¦»çº§åˆ«ï¼šåœ¨toydbå½“ä¸­æä¾›äº†å¿«ç…§éš”ç¦»ï¼Œåœ¨è¿™ç§éš”ç¦»çº§åˆ«ä¸‹ï¼Œä¿è¯äº†å¯é‡å¤è¯»ï¼Œå¹¶ä¸”é¿å…äº†å¹»è¯»çš„é—®é¢˜ï¼Œä½†æ˜¯ä»£ä»·æ˜¯å¯¹äºW-Wå†²çªï¼Œä¼šäº§ç”Ÿæ¯”è¾ƒé¢‘ç¹çš„é‡è¯•é—®é¢˜ å¹¶å‘æ§åˆ¶ï¼šè¿™é‡Œçš„å®ç°ä¸Miniobä¸€æ ·ï¼ŒW-Rå†²çªé€šè¿‡MVCCæœ¬èº«è§£å†³ï¼ŒW-Wå†²çªé‡‡ç”¨äº†æœ€ç®€å•çš„å†²çªé‡è¯• åŸå­æ€§æäº¤ï¼šè®°å½•å†™å…¥å¹¶ä¸æ˜¯åŸå­æ€§çš„ï¼Œä½†æ˜¯active_setçš„æ›´æ–°æ˜¯åŸå­æ€§çš„ï¼Œé€šè¿‡active_setçš„æ›´æ–°ä¿è¯è®°å½•èƒ½å¤Ÿä¸€æ¬¡æ€§å¯¹å¤–å…¨éƒ¨æš´éœ²å‡ºæ¥ åƒåœ¾å›æ”¶ï¼šæ²¡æœ‰åƒåœ¾å›æ”¶ï¼Œè¿™æ˜¯ feature è€Œä¸æ˜¯ bug:)ï¼Œå€ŸåŠ©æ­¤ç‰¹ç‚¹ï¼Œå®ç°äº†ä»»æ„æ—¶é—´çš„ time travel toydbå½“ä¸­Keyçš„è®¾è®¡ä¹Ÿæ˜¯MVCCçš„é‡è¦æ”¯æŒï¼Œé€šè¿‡å¤åˆç±»å‹Keyçš„å½¢å¼ï¼Œtoydbå®ç°äº†ç±»ä¼¼leveldbå½“ä¸­(user_key,sequence)çš„å½¢å¼ï¼Œä½†æ˜¯å¾—ç›Šäºrustå½“ä¸­æšä¸¾ç±»å‹çš„å¼ºå¤§ï¼Œä¸ä»…å¯ä»¥æºå¸¦ä¸Šç‰ˆæœ¬ä¿¡æ¯ï¼Œå¹¶ä¸”èƒ½å¤Ÿè¡¨ç¤ºkeyçš„ä¸åŒæ„ä¹‰ï¼Œå¦‚TxnWrite,TxnActiveç­‰ã€‚æœ‰äº†å¤åˆç±»å‹Keyï¼Œä¾¿å¯ä»¥å¾ˆè½»æ¾çš„å€ŸåŠ©kvå­˜å‚¨å¼•æ“æ¥å®ç°MVCCã€‚\nåœ¨æ•´ä¸ªMVCCæ¨¡å—å½“ä¸­ï¼ŒKVå­˜å‚¨æ—¢ç”¨äºå­˜å‚¨å®é™…çš„æ•°æ®ï¼Œå³ä¸€ä¸ªä¸ªversionï¼ŒåŒæ—¶è¿˜èµ·åˆ°äº†logçš„ä½œç”¨ï¼Œä¼šè®°å½•Txn::Writeç”¨äºè¿›è¡Œäº‹åŠ¡å›æ»šï¼Œå¹¶ä¸”è¿˜ä¼šå­˜å‚¨NextVersion,active setè¿™æ ·çš„å…ƒæ•°æ® ï¼Œå¯è°“æ˜¯ç”¨å¤„å¤šå¤šäº†ï¼Œå‡¡äº‹æ¶‰åŠåˆ°å­˜å‚¨æˆ–è€…æŒä¹…åŒ–çš„å†…å®¹ï¼Œéƒ½ä¸¢è¿›kv engine\ntoydbçš„MVCCå®ç°çš„éå¸¸ç®€æ´ï¼ŒçœŸæ­£ä¸MVCCç›¸å…³çš„é€»è¾‘åªæœ‰400ä½™è¡Œï¼Œé™¤äº†ä¸Šé¢åˆ†æçš„ï¼Œè¿˜æœ‰ä¸€ä¸ªIteratorçš„å®ç°ï¼Œç”¨äºæ”¯æŒèŒƒå›´æ‰«æå’Œå‰ç¼€æ‰«æï¼Œé€»è¾‘å¹¶ä¸æ˜¯å¾ˆå¤æ‚ï¼Œç¬”è€…å°±ä¸é¢å¤–å±•å¼€äº†ï¼Œæ­¤å¤–toydbå½“ä¸­ä¹Ÿæä¾›äº†è¾ƒä¸ºå®Œå–„çš„æµ‹è¯•ï¼Œé€šè¿‡æµ‹è¯•ä¹Ÿå¯ä»¥æ›´å¥½çš„ç†è§£MVCCï¼Œrustçš„è°ƒè¯•ä¹Ÿå¾ˆæ–¹ä¾¿ï¼Œæ— éœ€ä»»ä½•é…ç½®ï¼Œè¯»è€…å¯è‡ªè¡Œé˜…è¯»è°ƒè¯•ã€‚\n","permalink":"https://fischer0522.github.io/en/posts/tech/toydb/02-mvcc/","summary":"åŸºç¡€ç†è®º ç®€è€Œè¨€ä¹‹ï¼Œå®ç°MVCCçš„DBMSåœ¨å†…éƒ¨ç»´æŒç€å•ä¸ªé€»è¾‘æ•°æ®çš„å¤šä¸ªç‰©ç†ç‰ˆæœ¬ï¼Œå½“äº‹åŠ¡ä¿®æ”¹æŸæ¡æ•°æ®æ—¶ï¼Œå°±åˆ›å»ºä¸€ä¸ªæ–°çš„ç‰ˆæœ¬ã€‚å½“äº‹åŠ¡è¯»å–æ—¶ï¼Œå°±æ ¹","title":"02-MVCC"},{"content":"åŸºç¡€ç»“æ„ Bitcaskæœ¬èº«éå¸¸ç®€å•ï¼Œè¦æ˜¯æƒ³å®ç°ä¸€ä¸ªæœ€åŸºç¡€çš„bitcaskå­˜å‚¨å¼•æ“ï¼Œå¤§æ¦‚200-300è¡Œä»£ç å°±èƒ½å®ç°ï¼Œè¿™é‡Œå…ˆç®€å•ä»‹ç»ä¸€ä¸‹Bitcaskçš„åŸºç¡€ç»“æ„ï¼š\nBitcaskæ˜¯åŸºäºæ—¥å¿—çš„ï¼Œå³Log-Structured,å³é‡‡ç”¨é¡ºåºå†™å…¥çš„æ–¹å¼ï¼Œæ— è®ºæ˜¯åˆ é™¤è¿˜æ˜¯æ›´æ–°éƒ½æ˜¯å‘æ—¥å¿—æ–‡ä»¶å½“ä¸­è¿½åŠ ä¸€ä¸ªEntryï¼Œåˆ©ç”¨ç£ç›˜é¡ºåºå†™å…¥çš„æ€§èƒ½å¤§äºéšæœºå†™å…¥çš„ç‰¹ç‚¹ï¼Œä»¥è¾¾åˆ°é«˜æ€§èƒ½ï¼Œä½†æ˜¯åŒæ ·çš„ï¼Œåœ¨å­˜å‚¨ç©ºé—´ä¸Šä¼šåšå‡ºç‰ºç‰²(æ—¥å¿—æ–‡ä»¶å½“ä¸­ä¼šå­˜å‚¨ä¸€äº›æ— æ•ˆã€è¿‡æ—¶çš„Entry)\nç»“æ„ Bitcaskåœ¨æ•°æ®ç®¡ç†ä¸Šåˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œåˆ†åˆ«æ˜¯å†…å­˜å’Œç£ç›˜ï¼š\nåœ¨å†…å­˜å½“ä¸­ç»´æŠ¤ä¸€ä¸ªmapï¼Œkeyä¸ºå­˜å‚¨çš„keyï¼Œè€Œvalueä¸ºEntryçš„metadataï¼Œè®°å½•é•¿åº¦å’Œä½ç½®ï¼Œç”¨äºè¿›è¡Œåç§»è¯»å–ã€‚mapå½“ä¸­å§‹ç»ˆä¿å­˜å½“å‰keyçš„æœ€æ–°ç‰ˆæœ¬çš„ä½ç½® ç£ç›˜ä¸Šä½¿ç”¨Log-Structuredè¿›è¡Œç®¡ç†ï¼Œä»»ä½•æ“ä½œéƒ½æ˜¯å†™å…¥ä¸€ä¸ªEntryï¼Œè¿½åŠ åˆ°æ—¥å¿—æ–‡ä»¶çš„æœ«å°¾ï¼ŒLogå½“ä¸­çš„å­˜å‚¨å•å…ƒé€šå¸¸ä¸ºEntry,Entryçš„ç»“æ„å¤§è‡´å¦‚ä¸‹ï¼š æ¥å£ å¯¹äºæœ€åŸºç¡€çš„å­˜å‚¨å¼•æ“ï¼Œé€šå¸¸åªéœ€è¦æä¾›Getã€Putã€Deleteï¼Œå¤§è‡´é€»è¾‘å¦‚ä¸‹ï¼š\nGet:é¦–å…ˆæŸ¥è¯¢å†…å­˜å½“ä¸­çš„mapï¼Œå¦‚æœä¸å­˜åœ¨é‚£ä¹ˆå°±æ˜¯çœŸçš„ä¸å­˜åœ¨ï¼Œå¦‚æœèƒ½æŸ¥è¯¢åˆ°ï¼Œé‚£ä¹ˆå°±æ ¹æ®metadataå»ç£ç›˜å½“ä¸­è¯»å–å‡ºå¯¹åº”çš„value Putï¼šé¦–å…ˆå‘ç£ç›˜å½“ä¸­å†™å…¥ä¸€æ¡æ–°çš„Entryï¼Œå¦‚æœå¹¶ä¸”æ›´æ–°å†…å­˜çš„mapï¼Œä¿å­˜æ–°Entryçš„offset Deleteï¼šå’ŒPutçš„é€»è¾‘åŸºæœ¬ä¸€è‡´ï¼Œåªä¸è¿‡valueçš„ç±»å‹ä¸ä¸€æ ·ï¼Œå†™å…¥çš„å†…å®¹ä¸ºtombstoneï¼Œæ ‡å¿—valå·²ç»è¢«åˆ é™¤ï¼ŒåŒæ—¶åˆ é™¤å†…å­˜å½“ä¸­çš„kv Compaction å’ŒLSM-Treeä¸€æ ·ï¼ŒBitcaskåŒæ ·æœ‰Compactionçš„è¿‡ç¨‹ï¼Œå¦‚ä¸Šé¢æ‰€æè¿°çš„ï¼Œåœ¨å†™å…¥è¿‡ç¨‹å½“ä¸­ï¼Œä¼šæœ‰keyè¢«æ›´æ–°æˆ–è€…åˆ é™¤ï¼Œä½†æ˜¯æ—§ç‰ˆæœ¬çš„keyä¾æ—§ä¼šå­˜åœ¨äºæ—¥å¿—æ–‡ä»¶å½“ä¸­ï¼Œéšç€æ—¶é—´çš„å¢åŠ ï¼Œæ—¥å¿—æ–‡ä»¶å½“ä¸­çš„æ— æ•ˆæ•°æ®å°±ä¼šè¶Šæ¥è¶Šå¤šï¼Œå ç”¨é¢å¤–çš„å­˜å‚¨ç©ºé—´ã€‚å› æ­¤å°±éœ€è¦compactionå°†å…¶æ¸…é™¤ã€‚\nå¯¹æ¯”LSM-Treeæ¥è¯´ï¼ŒBitcaskçš„Compactionå°±ä¼šç®€å•éå¸¸å¤šï¼Œåªéœ€è¦éå†å½“å‰å†…å­˜å½“ä¸­å­˜åœ¨çš„keyï¼Œè¯»å–æ—§æ–‡ä»¶ï¼Œå†™å…¥åˆ°æ–°æ–‡ä»¶å½“ä¸­ï¼Œä¹‹åå°†æ–°æ—§æ–‡ä»¶è¿›è¡Œæ›¿æ¢å³å¯ã€‚\nå¦‚æœåƒå…·ä½“äº†è§£Bitcaskçš„è¯ï¼Œå¯ä»¥çœ‹ä¸€ä¸‹ï¼š\nddiaå½“ä¸­çš„å†…å®¹ï¼šç¬¬ä¸‰ç« ï¼šå­˜å‚¨ä¸æ£€ç´¢ paperï¼šriak.com/assets/bitcask-intro.pdf å®ç° å¦‚ä¸Šé¢æ‰€è¯´çš„ï¼Œåœ¨src/storage/engine/bitcask.rså½“ä¸­å®šä¹‰äº†å¯¹åº”çš„ç»“æ„ä½“ï¼Œå…¶ä¸­æœ‰ä¸¤ä¸ªæˆå‘˜å˜é‡ï¼Œåˆ†åˆ«å¯¹åº”å†…å­˜å½“ä¸­çš„mapå’Œç£ç›˜å½“ä¸­çš„æ—¥å¿—æ–‡ä»¶ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 pub struct BitCask { /// The active append-only log file. log: Log, /// Maps keys to a value position and length in the log file. keydir: KeyDir, } /// Maps keys to a value position and length in the log file. type KeyDir = std::collections::BTreeMap\u0026lt;Vec\u0026lt;u8\u0026gt;, (u64, u32)\u0026gt;; struct Log { /// Path to the log file. path: PathBuf, /// The opened file containing the log. file: std::fs::File, } Log KeyDiræ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œå°±æ˜¯ä¸€ä¸ªå†…å­˜å½“ä¸­çš„mapï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯BTreeMapçš„å®ç°æ–¹å¼ï¼Œä¾¿äºè¿›è¡Œé¡ºåºéå†è¿›è¡Œcompactionã€‚\nè¿™é‡Œçœ‹ä¸€ä¸‹Logçš„å®ç°ï¼Œåœ¨Logå½“ä¸­ï¼Œé™¤äº†åˆå§‹åŒ–çš„newå’Œç”¨äºdebugçš„printï¼Œå…±æœ‰ä¸‰ä¸ªå‡½æ•°ï¼Œåˆ†åˆ«ç”¨äºè¯»å–ã€å†™å…¥å’Œæ ¹æ®æ—¥å¿—é‡æ–°æ„å»ºBitcaskã€‚\nread_valueå’Œwrite_entryçš„å®ç°æ¯”è¾ƒç®€å•ï¼š\nread_valueå½“ä¸­åªéœ€è¦æ ¹æ®ä¼ å…¥çš„åç§»é‡å’Œé•¿åº¦ï¼Œå°†å¯¹åº”çš„valueè¯»å–å‡ºæ¥å³å¯ write_entryå½“ä¸­ï¼Œåˆ†åˆ«å†™å…¥key_lenï¼Œvalue_len(or tombstone)ï¼Œkey_bytesï¼Œvalue_bytes(å¦‚æœæ˜¯åˆ é™¤é‚£ä¹ˆä¹…ä¸å†™å…¥)ï¼Œæœ€åè°ƒç”¨flushæŒä¹…åŒ–åˆ°ç£ç›˜ï¼Œæœ€åè¿”å›ä¸€ä¸ªoffsetå’Œlenï¼Œç”¨äºä¿å­˜åˆ°BTreeMapå½“ä¸­ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 /// Reads a value from the log file. fn read_value(\u0026amp;mut self, value_pos: u64, value_len: u32) -\u0026gt; Result\u0026lt;Vec\u0026lt;u8\u0026gt;\u0026gt; { let mut value = vec![0; value_len as usize]; self.file.seek(SeekFrom::Start(value_pos))?; self.file.read_exact(\u0026amp;mut value)?; Ok(value) } /// Appends a key/value entry to the log file, using a None value for /// tombstones. It returns the position and length of the entry. fn write_entry(\u0026amp;mut self, key: \u0026amp;[u8], value: Option\u0026lt;\u0026amp;[u8]\u0026gt;) -\u0026gt; Result\u0026lt;(u64, u32)\u0026gt; { let key_len = key.len() as u32; let value_len = value.map_or(0, |v| v.len() as u32); let value_len_or_tombstone = value.map_or(-1, |v| v.len() as i32); let len = 4 + 4 + key_len + value_len; let pos = self.file.seek(SeekFrom::End(0))?; let mut w = BufWriter::with_capacity(len as usize, \u0026amp;mut self.file); w.write_all(\u0026amp;key_len.to_be_bytes())?; w.write_all(\u0026amp;value_len_or_tombstone.to_be_bytes())?; w.write_all(key)?; if let Some(value) = value { w.write_all(value)?; } w.flush()?; Ok((pos, len)) } è¿™é‡Œç¨å¾®éº»çƒ¦ä¸€ç‚¹çš„æ˜¯build_keydirï¼Œå³ç”¨äºåœ¨æ•°æ®åº“å¯åŠ¨æ—¶ï¼Œè¯»å–æ—¥å¿—æ–‡ä»¶ï¼Œæ¢å¤å‡ºå†…å­˜å½“ä¸­çš„BTreeMapï¼Œå¤§è‡´é€»è¾‘ä¸ºï¼š\nä»æ—¥å¿—æ–‡ä»¶çš„å¼€å¤´å¼€å§‹éå† å…ˆè¯»å–å‡ºkey_lenå’Œvalue_lenï¼Œå…¶ä¸­ï¼Œå¦‚æœvalue_lenä¸º-1åˆ™è¯æ˜å½“å‰ä¸ºtombstone å¦‚æœæ˜¯-1å°±å°è£…ä¸€ä¸ªnoneï¼Œå¦åˆ™è®¡ç®—å‡ºvalue_offset è¯»å–å‡ºkeyï¼Œä¹‹åæ ¹æ®æ˜¯å¦ä¸ºtombstoneæ¥å†³å®šå¯¹mapæ˜¯æ’å…¥è¿˜æ˜¯åˆ é™¤ é”™è¯¯å¤„ç† å¾ªç¯ç›´è‡³æ—¥å¿—æ–‡ä»¶æœ«å°¾ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 /// Builds a keydir by scanning the log file. If an incomplete entry is /// encountered, it is assumed to be caused by an incomplete write operation /// and the remainder of the file is truncated. fn build_keydir(\u0026amp;mut self) -\u0026gt; Result\u0026lt;KeyDir\u0026gt; { let mut len_buf = [0u8; 4]; let mut keydir = KeyDir::new(); let file_len = self.file.metadata()?.len(); let mut r = BufReader::new(\u0026amp;mut self.file); // ------(1)----- let mut pos = r.seek(SeekFrom::Start(0))?; while pos \u0026lt; file_len { // Read the next entry from the file, returning the key, value // position, and value length or None for tombstones. let result = || -\u0026gt; std::result::Result\u0026lt;(Vec\u0026lt;u8\u0026gt;, u64, Option\u0026lt;u32\u0026gt;), std::io::Error\u0026gt; { // ------(2)----- r.read_exact(\u0026amp;mut len_buf)?; let key_len = u32::from_be_bytes(len_buf); r.read_exact(\u0026amp;mut len_buf)?; let value_len_or_tombstone = match i32::from_be_bytes(len_buf) { l if l \u0026gt;= 0 =\u0026gt; Some(l as u32), _ =\u0026gt; None, // -1 for tombstones }; // ------(3)----- let value_pos = pos + 4 + 4 + key_len as u64; let mut key = vec![0; key_len as usize]; r.read_exact(\u0026amp;mut key)?; if let Some(value_len) = value_len_or_tombstone { if value_pos + value_len as u64 \u0026gt; file_len { return Err(std::io::Error::new( std::io::ErrorKind::UnexpectedEof, \u0026#34;value extends beyond end of file\u0026#34;, )); } r.seek_relative(value_len as i64)?; // avoids discarding buffer } Ok((key, value_pos, value_len_or_tombstone)) }(); // ------(4)----- match result { // Populate the keydir with the entry, or remove it on tombstones. Ok((key, value_pos, Some(value_len))) =\u0026gt; { keydir.insert(key, (value_pos, value_len)); pos = value_pos + value_len as u64; } Ok((key, value_pos, None)) =\u0026gt; { keydir.remove(\u0026amp;key); pos = value_pos; } // ------(5)----- // If an incomplete entry was found at the end of the file, assume an // incomplete write and truncate the file. Err(err) if err.kind() == std::io::ErrorKind::UnexpectedEof =\u0026gt; { log::error!(\u0026#34;Found incomplete entry at offset {}, truncating file\u0026#34;, pos); self.file.set_len(pos)?; break; } Err(err) =\u0026gt; return Err(err.into()), } } Ok(keydir) } Bitcask çœ‹å®Œäº†Logï¼Œå†æ¥çœ‹ä¸€ä¸‹Bitcaskæœ¬ä½“ï¼Œå¯ä»¥çœ‹åˆ°ï¼ŒBitCaskæœ‰äº”ä¸ªå¯¹åº”çš„å®ç°ï¼Œé™¤å»Displayå’ŒDropä»¥å¤–ï¼Œè¿˜æœ‰ä¸‰ä¸ªimplï¼Œåˆ†åˆ«æ¥çœ‹è¿™ä¸‰ä¸ªimpl\nç¬¬ä¸€ä¸ªå®ç°ä¸­å®šä¹‰äº†Bitcaskåˆå§‹åŒ–ç›¸å…³æ“ä½œï¼Œå¯¹åº”å‡½æ•°ä¸ºnewå’Œnew_compactï¼š\nnew:æ–°å»ºä¸€ä¸ªBitcaskï¼Œå¹¶è°ƒç”¨ä¸Šé¢åˆ†æè¿‡çš„log.build_keydiræ¥ä»æ—¥å¿—æ–‡ä»¶å½“ä¸­æ¢å¤å†…å­˜å½“ä¸­çš„map new_compact:toydbçš„å®šä¹‰ä¸ºlearning projectï¼Œå¯¹åº”çš„æ•°æ®ä¹Ÿä¸ºå°è§„æ¨¡çš„ï¼Œå› æ­¤åœ¨toydbçš„è®¾è®¡å½“ä¸­ï¼Œåªæœ‰åœ¨æ•°æ®åº“å¯åŠ¨æ—¶æ‰ä¼šè¿›è¡Œcompactæ“ä½œï¼Œå¹¶ä¸”è¿™ä¸ªè¿‡ç¨‹æ˜¯ä¼šé”ä½æ—¥å¿—æ–‡ä»¶çš„ï¼Œä½†æ˜¯ç”±äºè¿™ä¸ªè¿‡ç¨‹æ˜¯ç®—åœ¨å¯åŠ¨å½“ä¸­çš„ï¼Œä¹Ÿæ— ä¼¤å¤§é›…ã€‚åœ¨new_compactå½“ä¸­ï¼Œä¼šè®¡ç®—å½“å‰çš„garbage_ratioï¼Œå¦‚æœè¶…å‡ºé˜ˆå€¼ï¼Œå°±è¿›è¡Œcompact 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 pub fn new_compact(path: PathBuf, garbage_ratio_threshold: f64) -\u0026gt; Result\u0026lt;Self\u0026gt; { let mut s = Self::new(path)?; let status = s.status()?; let garbage_ratio = status.garbage_disk_size as f64 / status.total_disk_size as f64; if status.garbage_disk_size \u0026gt; 0 \u0026amp;\u0026amp; garbage_ratio \u0026gt;= garbage_ratio_threshold { log::info!( \u0026#34;Compacting {} to remove {:.3}MB garbage ({:.0}% of {:.3}MB)\u0026#34;, s.log.path.display(), status.garbage_disk_size / 1024 / 1024, garbage_ratio * 100.0, status.total_disk_size / 1024 / 1024 ); s.compact()?; log::info!( \u0026#34;Compacted {} to size {:.3}MB\u0026#34;, s.log.path.display(), (status.total_disk_size - status.garbage_disk_size) / 1024 / 1024 ); } Ok(s) } æ¥ä¸‹æ¥çœ‹ç¬¬äºŒéƒ¨åˆ†ï¼Œå°è£…äº†ä¸€äº›å†™å…¥æ“ä½œæ¥ä¸ºcompactæä¾›æ”¯æŒï¼Œå®šä¹‰äº†ä¸¤ä¸ªå‡½æ•°ï¼šcompactä¸write_logï¼ŒäºŒè€…çš„é€»è¾‘éƒ½å¾ˆç®€å•ï¼š\nåœ¨write_logå½“ä¸­ï¼Œä¼šéå†å½“å‰çš„mapï¼Œå»åŸæœ¬çš„æ—¥å¿—æ–‡ä»¶å½“ä¸­è¯»å–ï¼Œå†™å…¥åˆ°æ–°çš„æ—¥å¿—æ–‡ä»¶å½“ä¸­ï¼Œå¹¶ä¸”æ„å»ºæ–°çš„map åœ¨compactå½“ä¸­ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡ä»¶ï¼Œè°ƒç”¨write_logé‡å»ºæ—¥å¿—æ–‡ä»¶ï¼Œå¹¶ä¸”ä¿å­˜ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 impl BitCask { /// Compacts the current log file by writing out a new log file containing /// only live keys and replacing the current file with it. pub fn compact(\u0026amp;mut self) -\u0026gt; Result\u0026lt;()\u0026gt; { let mut tmp_path = self.log.path.clone(); tmp_path.set_extension(\u0026#34;new\u0026#34;); let (mut new_log, new_keydir) = self.write_log(tmp_path)?; std::fs::rename(\u0026amp;new_log.path, \u0026amp;self.log.path)?; new_log.path = self.log.path.clone(); self.log = new_log; self.keydir = new_keydir; Ok(()) } /// Writes out a new log file with the live entries of the current log file /// and returns it along with its keydir. Entries are written in key order. fn write_log(\u0026amp;mut self, path: PathBuf) -\u0026gt; Result\u0026lt;(Log, KeyDir)\u0026gt; { let mut new_keydir = KeyDir::new(); let mut new_log = Log::new(path)?; new_log.file.set_len(0)?; // truncate file if it exists for (key, (value_pos, value_len)) in self.keydir.iter() { let value = self.log.read_value(*value_pos, *value_len)?; let (pos, len) = new_log.write_entry(key, Some(\u0026amp;value))?; new_keydir.insert(key.clone(), (pos + len as u64 - *value_len as u64, *value_len)); } Ok((new_log, new_keydir)) } } ç¬¬ä¸‰éƒ¨åˆ†åˆ™æ˜¯engineçš„å®ç°ï¼Œåœ¨src/storage/modå½“ä¸­å®šä¹‰äº†ä¸€ä¸ªtraitï¼Œè€Œè¿™ä¸€éƒ¨åˆ†å°±æ˜¯å¯¹bitcaskè¿›è¡Œä¸€ä¸ªç®€å•çš„å°è£…ï¼Œæ¥å®ç°è¯¥traitï¼Œé€»è¾‘éƒ½æ¯”è¾ƒç®€å•ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 pub trait Engine: std::fmt::Display + Send + Sync { /// The iterator returned by scan(). Traits can\u0026#39;t return \u0026#34;impl Trait\u0026#34;, and /// we don\u0026#39;t want to use trait objects, so the type must be specified. type ScanIterator\u0026lt;\u0026#39;a\u0026gt;: DoubleEndedIterator\u0026lt;Item = Result\u0026lt;(Vec\u0026lt;u8\u0026gt;, Vec\u0026lt;u8\u0026gt;)\u0026gt;\u0026gt; + \u0026#39;a where Self: \u0026#39;a; /// Deletes a key, or does nothing if it does not exist. fn delete(\u0026amp;mut self, key: \u0026amp;[u8]) -\u0026gt; Result\u0026lt;()\u0026gt;; /// Flushes any buffered data to the underlying storage medium. fn flush(\u0026amp;mut self) -\u0026gt; Result\u0026lt;()\u0026gt;; /// Gets a value for a key, if it exists. fn get(\u0026amp;mut self, key: \u0026amp;[u8]) -\u0026gt; Result\u0026lt;Option\u0026lt;Vec\u0026lt;u8\u0026gt;\u0026gt;\u0026gt;; /// Iterates over an ordered range of key/value pairs. fn scan\u0026lt;R: std::ops::RangeBounds\u0026lt;Vec\u0026lt;u8\u0026gt;\u0026gt;\u0026gt;(\u0026amp;mut self, range: R) -\u0026gt; Self::ScanIterator\u0026lt;\u0026#39;_\u0026gt;; /// Sets a value for a key, replacing the existing value if any. fn set(\u0026amp;mut self, key: \u0026amp;[u8], value: Vec\u0026lt;u8\u0026gt;) -\u0026gt; Result\u0026lt;()\u0026gt;; /// Returns engine status. fn status(\u0026amp;mut self) -\u0026gt; Result\u0026lt;Status\u0026gt;; /// Iterates over all key/value pairs starting with prefix. fn scan_prefix(\u0026amp;mut self, prefix: \u0026amp;[u8]) -\u0026gt; Self::ScanIterator\u0026lt;\u0026#39;_\u0026gt; { let start = std::ops::Bound::Included(prefix.to_vec()); let end = match prefix.iter().rposition(|b| *b != 0xff) { Some(i) =\u0026gt; std::ops::Bound::Excluded( prefix.iter().take(i).copied().chain(std::iter::once(prefix[i] + 1)).collect(), ), None =\u0026gt; std::ops::Bound::Unbounded, }; self.scan((start, end)) } } Iterator æœ€åï¼Œå®šä¹‰äº†ä¸€ä¸ªScanIteratorï¼Œç”¨äºè¿›è¡ŒèŒƒå›´è¯»å–ï¼Œè¿™é‡Œçš„å†™æ³•è¿˜æ˜¯æ¯”è¾ƒçš„rustyçš„ã€‚é¢å¤–å®šä¹‰äº†ä¸€ä¸ªmapå‡½æ•°ï¼Œè°ƒç”¨self.log.read_value()å»ç£ç›˜å½“ä¸­è¿›è¡Œè¯»å–ï¼Œç”¨äºå°†BTreeMapå½“ä¸­çš„keyä¸offsetè½¬æ¢ä¸ºçœŸå®çš„kvã€‚\nç”±äºinnerå’Œlogéƒ½æ˜¯å¼•ç”¨ç±»å‹ï¼Œå› æ­¤æ ‡æ³¨äº†ç”Ÿå‘½å‘¨æœŸ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 pub struct ScanIterator\u0026lt;\u0026#39;a\u0026gt; { inner: std::collections::btree_map::Range\u0026lt;\u0026#39;a, Vec\u0026lt;u8\u0026gt;, (u64, u32)\u0026gt;, log: \u0026amp;\u0026#39;a mut Log, } impl\u0026lt;\u0026#39;a\u0026gt; ScanIterator\u0026lt;\u0026#39;a\u0026gt; { fn map(\u0026amp;mut self, item: (\u0026amp;Vec\u0026lt;u8\u0026gt;, \u0026amp;(u64, u32))) -\u0026gt; \u0026lt;Self as Iterator\u0026gt;::Item { let (key, (value_pos, value_len)) = item; Ok((key.clone(), self.log.read_value(*value_pos, *value_len)?)) } } impl\u0026lt;\u0026#39;a\u0026gt; Iterator for ScanIterator\u0026lt;\u0026#39;a\u0026gt; { type Item = Result\u0026lt;(Vec\u0026lt;u8\u0026gt;, Vec\u0026lt;u8\u0026gt;)\u0026gt;; fn next(\u0026amp;mut self) -\u0026gt; Option\u0026lt;Self::Item\u0026gt; { self.inner.next().map(|item| self.map(item)) } } impl\u0026lt;\u0026#39;a\u0026gt; DoubleEndedIterator for ScanIterator\u0026lt;\u0026#39;a\u0026gt; { fn next_back(\u0026amp;mut self) -\u0026gt; Option\u0026lt;Self::Item\u0026gt; { self.inner.next_back().map(|item| self.map(item)) } } memory æ­¤å¤–ï¼Œåœ¨åŒç›®å½•ä¸‹ï¼Œè¿˜å®šä¹‰äº†ä¸€ä¸ªmemoryï¼ŒåŒæ ·ä½œä¸ºEngineçš„ä¸€ä¸ªå®ç°ï¼Œè¡¨ç¤ºä¸€ä¸ªçº¯å†…å­˜çš„å­˜å‚¨å¼•æ“ï¼Œä½¿ç”¨çš„å°±æ˜¯BTreeMapï¼Œå°†keyå’Œvalueç›´æ¥å­˜å‚¨åœ¨å†…å­˜å½“ä¸­ï¼Œä¸ä¼šå¯¹æ•°æ®è¿›è¡ŒæŒä¹…åŒ–\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 pub struct Memory { data: std::collections::BTreeMap\u0026lt;Vec\u0026lt;u8\u0026gt;, Vec\u0026lt;u8\u0026gt;\u0026gt;, } impl Memory { /// Creates a new Memory key-value storage engine. pub fn new() -\u0026gt; Self { Self { data: std::collections::BTreeMap::new() } } } impl Engine for Memory { type ScanIterator\u0026lt;\u0026#39;a\u0026gt; = ScanIterator\u0026lt;\u0026#39;a\u0026gt;; // è‡ªæ¬ºæ¬ºäººäº†å±äºæ˜¯ fn flush(\u0026amp;mut self) -\u0026gt; Result\u0026lt;()\u0026gt; { Ok(()) } fn delete(\u0026amp;mut self, key: \u0026amp;[u8]) -\u0026gt; Result\u0026lt;()\u0026gt; { self.data.remove(key); Ok(()) } fn get(\u0026amp;mut self, key: \u0026amp;[u8]) -\u0026gt; Result\u0026lt;Option\u0026lt;Vec\u0026lt;u8\u0026gt;\u0026gt;\u0026gt; { Ok(self.data.get(key).cloned()) } fn scan\u0026lt;R: std::ops::RangeBounds\u0026lt;Vec\u0026lt;u8\u0026gt;\u0026gt;\u0026gt;(\u0026amp;mut self, range: R) -\u0026gt; Self::ScanIterator\u0026lt;\u0026#39;_\u0026gt; { ScanIterator { inner: self.data.range(range) } } fn set(\u0026amp;mut self, key: \u0026amp;[u8], value: Vec\u0026lt;u8\u0026gt;) -\u0026gt; Result\u0026lt;()\u0026gt; { self.data.insert(key.to_vec(), value); Ok(()) } fn status(\u0026amp;mut self) -\u0026gt; Result\u0026lt;Status\u0026gt; { Ok(Status { name: self.to_string(), keys: self.data.len() as u64, size: self.data.iter().fold(0, |size, (k, v)| size + k.len() as u64 + v.len() as u64), total_disk_size: 0, live_disk_size: 0, garbage_disk_size: 0, }) } } Status åœ¨src/storage/engine/mod.rså½“ä¸­ï¼Œå®šä¹‰äº†ä¸€ä¸ªStatusï¼Œç”¨äºè¡¨ç¤ºå½“å‰å­˜å‚¨å¼•æ“çš„çŠ¶æ€ï¼Œbitcaskå’Œmemoryåœ¨åˆ›å»ºæ—¶éƒ½æ˜¯è®¾ç½®ä¸€ä¸ªçŠ¶æ€ï¼Œçœ‹ä¸€çœ‹å°±å¥½\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 /// Engine status. #[derive(Clone, Debug, PartialEq, Serialize, Deserialize)] pub struct Status { /// The name of the storage engine. pub name: String, /// The number of live keys in the engine. pub keys: u64, /// The logical size of live key/value pairs. pub size: u64, /// The on-disk size of all data, live and garbage. pub total_disk_size: u64, /// The on-disk size of live data. pub live_disk_size: u64, /// The on-disk size of garbage data. pub garbage_disk_size: u64, } ","permalink":"https://fischer0522.github.io/en/posts/tech/toydb/01-bitcask/","summary":"åŸºç¡€ç»“æ„ Bitcaskæœ¬èº«éå¸¸ç®€å•ï¼Œè¦æ˜¯æƒ³å®ç°ä¸€ä¸ªæœ€åŸºç¡€çš„bitcaskå­˜å‚¨å¼•æ“ï¼Œå¤§æ¦‚200-300è¡Œä»£ç å°±èƒ½å®ç°ï¼Œè¿™é‡Œå…ˆç®€å•ä»‹ç»ä¸€ä¸‹Bit","title":"01-Bitcask"},{"content":"å¼•è¨€ toydbæ˜¯ä¸€ä¸ªå®Œå…¨ç”±rustç¼–å†™çš„åˆ†å¸ƒå¼å…³ç³»å‹æ•°æ®åº“ï¼Œç›¸å¯¹äºå…¶ä»£ç è§„æ¨¡ï¼Œå…¶åŠŸèƒ½å®ç°ä¸Šå¯ä»¥è¯´æ˜¯éå¸¸çš„å®Œå–„äº†ï¼Œä½¿ç”¨å¤§çº¦1.5wçš„rustä»£ç ï¼Œå®ç°äº†ï¼š\nSQLå¼•æ“ SQLè§£æï¼šè¯æ³•åˆ†æ + è¯­æ³•åˆ†æï¼Œæœ€åç”Ÿæˆä¸€ä¸ªæ£µAST SQLæ‰§è¡Œï¼šæ ¹æ®ASTç”Ÿæˆä¸€ä¸ªPlannerï¼Œä»¥åŠä½¿ç”¨Optimizerè¿›è¡Œä¼˜åŒ–ï¼Œæœ€åæ‰§è¡Œï¼ŒExecutorä¸Šä½¿ç”¨äº†ç«å±±æ¨¡å‹ Raftæ¨¡å—ï¼šæ•´ä½“è®¾è®¡ä¸Šé‡‡ç”¨äº†ç±»etcdçš„çŠ¶æ€æœºç»“æ„ï¼Œé€šè¿‡é€»è¾‘æ—¶é’Ÿ + message + stepæ¥é©±åŠ¨raftçŠ¶æ€æœºçš„å˜æ›´ å­˜å‚¨å¼•æ“ï¼šä½¿ç”¨äº†Log-Structuredå½“ä¸­æœ€ç®€å•çš„Bitcask äº‹åŠ¡ï¼šæä¾›æœ€åŸºæœ¬çš„ ACID å’Œ MVCC æ”¯æŒ é¡¹ç›®çš„æ•´ä½“æ¶æ„å›¾å¦‚ä¸‹ï¼š æ‰§è¡Œæµç¨‹ åœ¨æœ¬ç« å½“ä¸­ï¼Œä»¥ä¸€æ¬¡ç®€å•çš„SQLæ‰§è¡Œè¿‡ç¨‹ï¼Œæ¥äº†è§£ä¸€ä¸‹toydbçš„æ•´ä½“æ¶æ„å’Œè°ƒç”¨é“¾\nserver toydbæ•´ä½“æ˜¯é‡‡ç”¨client-serverç»“æ„çš„ï¼Œclientåœ¨è¿™é‡Œä¸åšåˆ†æï¼Œåœ¨srcç›®å½•ä¸‹å­˜åœ¨ä¸€ä¸ªserver.rsï¼Œå…¶ä¸­å®šä¹‰äº†serverçš„ä¸€äº›ç›¸å…³é€»è¾‘ï¼Œé‚£ä¹ˆç¨‹åºçš„å…¥å£è‡ªç„¶è€Œè¨€çš„å°±æ˜¯server.rsäº†,serverè´Ÿè´£ä¸å®¢æˆ·ç«¯ä»¥åŠå…¶ä»–çš„raftèŠ‚ç‚¹ä¹‹é—´çš„é€šä¿¡ï¼Œä¸»è¦çš„å°±æ˜¯ä¸‰ä¸ªå‡½æ•°ï¼šlistenã€serveã€serve_sql\nlistenï¼šä¼ å…¥ä¸¤ä¸ªaddrï¼Œåˆ†åˆ«ä»£è¡¨ç”¨äºæ¥æ”¶clientå‘é€çš„sqlçš„ipä»¥åŠç”¨äºrafté€šä¿¡çš„ipï¼Œåœ¨é€šä¿¡ä¸Šï¼Œä¸ºäº†åº”å¯¹é«˜å¹¶å‘ï¼Œé‡‡ç”¨äº†async/awaitå¼‚æ­¥ç¼–ç¨‹çš„æ–¹å¼(tokio)ï¼Œè¿™é‡Œä¸è¿‡å¤šåˆ†æ serveï¼šæ¥å—ç½‘ç»œè¯·æ±‚å¹¶è¿›è¡Œå¤„ç†ï¼Œåœ¨å…¶ä¸­åˆ†åˆ«è°ƒç”¨raft.serveå’Œserve_sqlï¼Œraft.serveç•™åˆ°raftæ¨¡å—å½“ä¸­è¿›è¡Œåˆ†æ serve_sqlï¼šsqlæ‰§è¡Œçš„å…¥å£ serve_sqlï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 /// Serves SQL clients. async fn serve_sql(listener: TcpListener, engine: sql::engine::Raft) -\u0026gt; Result\u0026lt;()\u0026gt; { let mut listener = TcpListenerStream::new(listener); while let Some(socket) = listener.try_next().await? { let peer = socket.peer_addr()?; let session = Session::new(engine.clone())?; tokio::spawn(async move { info!(\u0026#34;Client {} connected\u0026#34;, peer); match session.handle(socket).await { Ok(()) =\u0026gt; info!(\u0026#34;Client {} disconnected\u0026#34;, peer), Err(err) =\u0026gt; error!(\u0026#34;Client {} error: {}\u0026#34;, peer, err), } }); } Ok(()) } å¯ä»¥çœ‹åˆ°ï¼Œåœ¨å…¶ä¸­å¤„ç†å®Œç½‘ç»œé“¾æ¥ä¹‹åï¼Œè°ƒç”¨äº†session.handle(socket)ï¼Œåœ¨å…¶ä¸­ä»tcpæµå½“ä¸­è·å–äº†requestä¹‹åï¼Œå°±è°ƒç”¨äº†self.request(request)ã€‚åé¢å‰©ä¸‹çš„éƒ½æ˜¯äº›å¯¹äºæ‰§è¡Œç»“æœçš„å¤„ç†ï¼Œç”¨äºè¿›è¡Œè¿”å›ã€‚\nåœ¨requestå½“ä¸­ï¼Œä¼šæ ¹æ®requestçš„ç±»å‹ï¼Œæ¥å†³å®šå¦‚ä½•æ‰§è¡Œï¼Œrequestæœ¬èº«ä¸ºä¸€ä¸ªæšä¸¾ç±»å‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 #[derive(Debug, Serialize, Deserialize)] pub enum Request { Execute(String), GetTable(String), ListTables, Status, } /// Executes a request. pub fn request(\u0026amp;mut self, request: Request) -\u0026gt; Result\u0026lt;Response\u0026gt; { debug!(\u0026#34;Processing request {:?}\u0026#34;, request); let response = match request { Request::Execute(query) =\u0026gt; Response::Execute(self.sql.execute(\u0026amp;query)?), Request::GetTable(table) =\u0026gt; { Response::GetTable(self.sql.read_with_txn(|txn| txn.must_read_table(\u0026amp;table))?) } Request::ListTables =\u0026gt; Response::ListTables( self.sql.read_with_txn(|txn| Ok(txn.scan_tables()?.map(|t| t.name).collect()))?, ), Request::Status =\u0026gt; Response::Status(self.engine.status()?), }; debug!(\u0026#34;Returning response {:?}\u0026#34;, response); Ok(response) } SQLå¼•æ“ æ™®é€šçš„sqlçš„requestç±»å‹ä¸ºRequest::Executeï¼Œå› æ­¤å°±ä¼šè°ƒç”¨self.sql.execute(\u0026amp;query),åœ¨è¿™é‡Œé¢ï¼Œç»ˆäºåˆ°çœŸæ­£çš„sqlæ‰§è¡Œè¿‡ç¨‹äº†ï¼Œé¦–å…ˆä¼šåˆ›å»ºä¸€ä¸ªParseræ¥è§£æsqlï¼Œå¾—åˆ°ä¸€ä¸ªASTï¼Œä¹‹åæ ¹æ®ASTçš„statementç±»å‹ï¼Œå…¶ä¸­æœ‰ä¸€äº›äº‹åŠ¡ç›¸å…³çš„ï¼Œè€Œå¯¹äºæ™®é€šçš„sqlï¼Œåˆ™ä¼šèµ°æœ€åä¸€éƒ¨åˆ†ï¼Œè°ƒç”¨é“¾ä¸ºPlan::build -\u0026gt; optimize -\u0026gt; executeï¼Œç®—æ˜¯æ¯”è¾ƒæ ‡å‡†çš„sqlæ‰§è¡Œæµç¨‹äº†\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 // è¿™ä¸€éƒ¨åˆ†æ˜¯åŸæœ¬æ²¡æœ‰å¼€å¯äº‹åŠ¡çš„ï¼Œä¼šé»˜è®¤å¼€å¯ä¸€ä¸ªäº‹åŠ¡ statement =\u0026gt; { let mut txn = self.engine.begin()?; match Plan::build(statement, \u0026amp;mut txn)?.optimize(\u0026amp;mut txn)?.execute(\u0026amp;mut txn) { Ok(result) =\u0026gt; { txn.commit()?; Ok(result) } Err(error) =\u0026gt; { txn.rollback()?; Err(error) } } } ä¹‹åå°±æ˜¯å®šä¹‰äº†ä¸€ä¸ªExecutor traitï¼Œç„¶åå…¶ä¸­åŒ…å«ä¸€ä¸ªexecuteï¼Œä¹‹åæ¯æ·»åŠ ä¸€ä¸ªç®—å­å°±å®ç°è¿™ä¸ªç‰¹å¾å³å¯ï¼Œå¯ä»¥çœ‹åˆ°çš„æ˜¯ï¼Œç›®å‰è¯¥ç‰¹å¾æœ‰17ä¸ªå®ç°ï¼Œé‚£ä¹ˆå°±æ˜¯æ‰€æœ‰ç®—å­äº†ï¼Œå¯¹äºç®—å­æ€ä¹ˆå®ç°çš„ï¼Œè¿™é‡Œä¸åšå±•å¼€ 1 2 3 4 5 6 7 8 9 impl\u0026lt;T: Transaction\u0026gt; Executor\u0026lt;T\u0026gt; for Scan { fn execute(self: Box\u0026lt;Self\u0026gt;, txn: \u0026amp;mut T) -\u0026gt; Result\u0026lt;ResultSet\u0026gt; { let table = txn.must_read_table(\u0026amp;self.table)?; Ok(ResultSet::Query { columns: table.columns.iter().map(|c| Column { name: Some(c.name.clone()) }).collect(), rows: Box::new(txn.scan(\u0026amp;table.name, self.filter)?), }) } } è¿™é‡Œä»¥æœ€ç®€å•çš„Scanä¸ºä¾‹ï¼Œç»§ç»­æ‰§è¡Œæµç¨‹ï¼Œåœ¨å…¶ä¸­è°ƒç”¨äº†txn.scanï¼Œä¹‹åå°±æ¯”è¾ƒçš„å¤æ‚äº†ï¼Œè¿™é‡Œç®€å•è¯´ä¸€ä¸‹æµç¨‹ï¼Œç»†èŠ‚ç•™ç€åé¢å†å•ç‹¬è¿›è¡Œåˆ†æï¼Œå¤§è‡´æµç¨‹æ˜¯å…ˆæŸ¥è¯¢Raftçš„çŠ¶æ€æœºï¼Œå†èµ°åˆ°å­˜å‚¨å±‚è¿›è¡Œæ“ä½œï¼Œåœ¨å­˜å‚¨å±‚å½“ä¸­çš„æ‰§è¡Œé¡ºåºå¤§è‡´ä¸ºkv engine -\u0026gt; mvcc -\u0026gt; bitcaskã€‚\næ–½å·¥è·¯çº¿ bitcask storage engine raft sql engine mvcc ä¹‹æ‰€ä»¥å¼€è¿™ä¸ªç³»åˆ—ï¼Œä¸»è¦æ˜¯æœ€è¿‘å†™æ¯•è®¾ç”¨åˆ°äº†rustï¼Œè€Œè‡ªå·±ç›®å‰çš„ruståŸºæœ¬ä¸Šæ˜¯ä¸‰è„šçŒ«æ°´å¹³ï¼Œåˆšå¥½toydbè¶³å¤Ÿç²¾ç®€ï¼ŒåŠ ä¸ŠåŠŸèƒ½ååˆ†çš„é½å…¨ï¼Œå› æ­¤å°±ä»¥toydbä½œä¸ºrustå®è·µå­¦ä¹ ï¼ŒåŠ›å›¾åˆ†æå®Œä¸»è¦ä»£ç é€»è¾‘ï¼Œä½†æ˜¯ç”±äºç¬”è€…çš„rustæ°´å¹³ä¸ä½³ï¼ŒæœŸé—´éš¾å…å­˜åœ¨ç†è§£åå·®ä¸é”™è¯¯ï¼Œæ¬¢è¿è¯»è€…æ‰¹è¯„æŒ‡æ­£,æœ€åï¼Œå¸Œæœ›è¿™ä¸ªç³»åˆ—ä¸ä¼šçƒ‚å°¾:) ","permalink":"https://fischer0522.github.io/en/posts/tech/toydb/00-architecture/","summary":"å¼•è¨€ toydbæ˜¯ä¸€ä¸ªå®Œå…¨ç”±rustç¼–å†™çš„åˆ†å¸ƒå¼å…³ç³»å‹æ•°æ®åº“ï¼Œç›¸å¯¹äºå…¶ä»£ç è§„æ¨¡ï¼Œå…¶åŠŸèƒ½å®ç°ä¸Šå¯ä»¥è¯´æ˜¯éå¸¸çš„å®Œå–„äº†ï¼Œä½¿ç”¨å¤§çº¦1.5wçš„rustä»£","title":"00-Architecture"},{"content":"More Than Capacity: Performance-oriented Evolution of Pangu in Alibaba Introduction æœ¬æ–‡ä¸»è¦è®²è¿°äº†ç›˜å¤åˆ†å¸ƒå¼å­˜å‚¨åå¹´æ¥çš„ä¸€ä¸ªæ¼”å˜å†ç¨‹ï¼Œä¸»è¦åˆ†ä¸ºäº†ä¸‰ä¸ªé˜¶æ®µï¼Œåˆ†åˆ«æ˜¯1.0ï¼Œ2.0çš„é˜¶æ®µä¸€å’Œ2.0çš„é˜¶æ®µäºŒã€‚\nåœ¨ç›˜å¤1.0ï¼Œæ­¤æ—¶çš„ç›˜å¤ä¸»è¦æ˜¯æä¾›é¢å‘å·çš„å­˜å‚¨æœåŠ¡(volume-oriented storage service provision)ï¼Œåœ¨è¿™ä¸ªé˜¶æ®µåœ¨ç¡¬ä»¶ä¸Šä½¿ç”¨çš„æ˜¯ä¼ ç»Ÿçš„hddï¼Œæ“ä½œç³»ç»Ÿä¸Šä½¿ç”¨çš„æ˜¯å†…æ ¸ç©ºé—´çš„æ–‡ä»¶ç³»ç»Ÿï¼Œæœ€ç»ˆä¸»è¦çš„æ€§èƒ½ç“¶é¢ˆæ—¶HDDå’Œç½‘ç»œå¸¦å®½ã€‚è¿™ä¸ªé˜¶æ®µæœ‰ç‚¹åƒgoogleçš„GFS åœ¨ç›˜å¤2.0çš„ç¬¬ä¸€é˜¶æ®µï¼Œä¸»è¦å·¥ä½œå°±æ˜¯é€šè¿‡æ‹¥æŠ±æ–°ç¡¬ä»¶æ¥è§£å†³1.0æ—¶æœŸçš„æ€§èƒ½ç“¶é¢ˆé—®é¢˜ï¼Œé€šè¿‡å¼•å…¥SSDå’ŒRDMAæŠ€æœ¯ï¼Œä»¥æä¾›é«˜æ€§èƒ½ä½å»¶è¿Ÿçš„å­˜å‚¨æœåŠ¡ã€‚åœ¨è¿™ä¸ªé˜¶æ®µï¼Œ å­˜å‚¨æ¶æ„ä¸Šé‡‡ç”¨é€šç”¨çš„è¿½åŠ å‹æŒä¹…å±‚ï¼Œå¹¶ä¸”å°†chunkçš„è®¾è®¡ä¸ºç‹¬ç«‹ç±»å‹ã€‚ åœ¨oså±‚é¢å°†åŸæœ¬çš„å†…æ ¸ç©ºé—´æ–‡ä»¶ç³»ç»Ÿè½¬æ¢ä¸ºç”¨æˆ·ç©ºé—´ï¼ˆuser-space storage operatiing system USSOSï¼‰ï¼Œä½¿ç”¨run-to-completionçº¿ç¨‹æ¨¡å‹ æä¾›SLAä¿è¯ åœ¨ç›˜å¤2.0çš„ç¬¬äºŒé˜¶æ®µï¼Œå°†ä¸šåŠ¡æ¨¡å¼æ›´æ–°ä¸ºæ€§èƒ½å¯¼å‘ï¼Œå¹¶ä¸”å°è¯•æ‰“ç ´ç½‘ç»œï¼Œå†…å­˜ï¼ŒCPUä¸Šçš„æ€§èƒ½ç“¶é¢ˆï¼Œé‡‡ç”¨çš„è§£å†³æ–¹å¼åˆ†åˆ«ä¸ºï¼š å‡å°‘æµé‡æ”¾å¤§ç‡ ä½¿ç”¨RDCA(remote direct cache access) å‡å°‘åºåˆ—åŒ–å’Œååºåˆ—åŒ–è¿‡ç¨‹çš„è®¡ç®—è´Ÿæ‹…ï¼Œå°†éƒ¨åˆ†cpuçš„è®¡ç®—èŒèƒ½ç§»åŠ¨åˆ°FPGAä¸Šï¼Œå¼•å…¥ CPU ç­‰å¾…æŒ‡ä»¤æ¥åŒæ­¥è¶…çº¿ç¨‹ Background Overview of Pangu ä½œä¸ºå¤§è§„æ¨¡çš„åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿï¼Œä¸»è¦ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼šPangu Core,Pangu Service,Pangu Monitoring,è€Œæ ¸å¿ƒå°±æ˜¯ç›˜å¤Coreï¼Œæ¶æ„å›¾å¦‚ä¸‹ï¼Œä¹çœ¼ä¸€çœ‹å’ŒGFSå·®ä¸å¤šï¼š clientä¸»è¦è´Ÿè´£å’Œä¸Šå±‚çš„æœåŠ¡ï¼Œå¦‚OSS,NASè¿›è¡Œå¯¹æ¥ï¼Œæ¥å—è¯·æ±‚å¹¶å’Œmasterä¸chunkserverä¹‹é—´è¿›è¡Œé€šä¿¡ï¼Œæ¥å®Œæˆè¯·æ±‚ã€‚å¹¶ä¸”åœ¨å¤‡ä»½ç®¡ç†ï¼ŒSLAä¿è¯ï¼Œæ•°æ®ä¸€è‡´æ€§ä¸Šéƒ½èµ·åˆ°äº†é‡è¦ä½œç”¨ masterå’ŒGPSå½“ä¸­çš„masterä¸€æ ·ï¼Œä¸»è¦æ˜¯ç®¡ç†å…ƒæ•°æ®çš„ï¼Œåˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œnamespace serviceå’Œstream meta serviceï¼Œnamespaceè´Ÿè´£æ–‡ä»¶çš„ä¿¡æ¯ï¼Œç›®å½•æ ‘å’Œnamespaceï¼Œstreamåˆ™æ˜¯è´Ÿè´£æ–‡ä»¶åˆ°chunkçš„ä¸€ä¸ªæ˜ å°„ã€‚streamæ˜¯ä¸€ç»„chunkçš„æŠ½è±¡ï¼Œåœ¨åŒä¸€ä¸ªstreamå½“ä¸­çš„chunkå±äºåŒä¸€ä¸ªæ–‡ä»¶ï¼Œé€šè¿‡è¿™ç§æ–¹å¼æ¥å®Œæˆæ–‡ä»¶åˆ°chunkçš„ä¸€ä¸ªæ˜ å°„ã€‚ä¸è¿‡åœ¨è¿™ç‰‡æ–‡ä¸­å¹¶æ²¡æœ‰å…·ä½“å±•å¼€masterçš„å®ç°ç»†èŠ‚ï¼Œç›˜å¤å‘è¿‡å¾ˆå¤šç¯‡paperï¼Œå¯èƒ½åœ¨åˆ«çš„ä¸­æœ‰æ‰€æåŠ Chunkserver ä½œä¸ºçœŸæ­£å­˜å‚¨æ–‡ä»¶çš„æœåŠ¡å™¨ï¼Œä½¿ç”¨äº† user-space storage file systemï¼Œå’Œè¿½åŠ ç±»å‹çš„å­˜å‚¨å¼•æ“ (ç±» bitcask æˆ–è€… LSM-Tree ç±»å‹ï¼Œå…¶ä¸­ä¼šæœ‰ gc çš„è¿‡ç¨‹)ã€‚åœ¨å¤‡ä»½ä¸Šï¼Œæœ€åˆä½¿ç”¨ 3 å¤‡ä»½çš„æ–¹å¼ï¼Œä¸è¿‡åœ¨ 2.0 çš„è®¾è®¡è¿‡ç¨‹å½“ä¸­ï¼Œé€æ­¥ä½¿ç”¨çº åˆ ç æ¥ä»£æ›¿æ‰ 3 å¤‡ä»½ä»¥ç¼©å°æµé‡æ”¾å¤§ç‡ è®¾è®¡ç›®æ ‡\nä½å»¶è¿Ÿ é«˜åå å¯¹æ‰€æœ‰ä¸šåŠ¡æä¾›ç»Ÿä¸€çš„é«˜æ€§èƒ½æ”¯æŒ Phase One: Embracing SSD and RDMA Append-only File System åœ¨æŒä¹…åŒ–å­˜å‚¨ä¸Šï¼Œç›˜å¤æä¾›ç»Ÿä¸€çš„ï¼Œåªè¿½åŠ çš„æŒä¹…å±‚ï¼ŒåŸæœ¬å¯¹äºä¸åŒçš„æœåŠ¡ï¼Œç›˜å¤æä¾›ä¸åŒçš„æ¥å£ï¼Œè¿™æ ·é¢å¤–å¢åŠ äº†ç³»ç»Ÿçš„å¤æ‚æ€§ã€‚å¦‚ä»Šï¼Œç›˜å¤å¼•å…¥äº†ç»Ÿä¸€çš„æ–‡ä»¶ç±»å‹ FlatLogFileï¼Œæä¾›äº†åªè¿½åŠ çš„è¯­ä¹‰ï¼Œå¯¹äºä¸Šå±‚æœåŠ¡æ¥è¯´ï¼Œæä¾›çš„æ˜¯ä¸€ä¸ªkey-valueç±»å‹çš„æ¥å£ã€‚å¹¶ä¸”ä¼šæœ‰gcæœºåˆ¶æ¥å¤„ç†å†å²æ•°æ®ã€‚ é‡é‡çº§å®¢æˆ·ç«¯ï¼šå¦‚ä¸Šé¢æ‰€è¯´çš„ï¼Œå®¢æˆ·ç«¯è´Ÿè´£å’Œ chunkserver å’Œ master ä¹‹é—´è¿›è¡Œé€šä¿¡æ¥æä¾›æœåŠ¡ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œè¿˜ä¼šè´Ÿè´£å¤åˆ¶å’Œå¤‡ä»½çš„ç›¸å…³æ“ä½œï¼Œ(3 å¤‡ä»½æˆ–è€…çº åˆ ç ) chunkserver\nå®ç°äº†ç‹¬ç«‹çš„(self-contained)chunkå¸ƒå±€ï¼Œå³chunkå­˜å‚¨æ•°æ®å’Œå…ƒæ•°æ®ï¼Œè€Œä¸æ˜¯åƒç»å…¸çš„æ–‡ä»¶ç³»ç»Ÿå¦‚linux ext4é‚£æ ·åˆ†ä¸ºblockå’Œinodeï¼Œè¿™æ ·åšçš„å¥½å¤„æ˜¯å¯ä»¥ä¸€æ¬¡å†™å…¥æ‰€æœ‰çš„æ•°æ®ï¼Œè€Œä¸æ˜¯åŸæœ¬çš„ä¸¤æ¬¡ã€‚\nä¸€ä¸ªchunkå½“ä¸­å«æœ‰å¤šä¸ªåŸºç¡€å•ä½ï¼Œæ¯ä¸ªåŸºç¡€å•ä½åŒ…å«äº†æ•°æ®ï¼Œpaddingå¡«å……ï¼Œå’Œfooterä¸‰éƒ¨åˆ†ï¼Œè€Œfooterå½“ä¸­å­˜å‚¨chunkçš„å…ƒæ•°æ®ï¼Œå¦‚chunk idï¼Œchunk length CRCæ ¡éªŒç ï¼Œå¸ƒå±€å¦‚ä¸‹ï¼š Metadata Operation Optimization\nä¸»è¦æå‡ºäº†å…­ä¸ªæ–¹å‘ï¼š\nå¹¶è¡Œå…ƒæ•°æ®å¤„ç†ï¼Œå¦‚å®¢æˆ·ç«¯å¯ä»¥è¿›è¡Œå¹¶è¡Œçš„è·¯å¾„è§£æ å˜é•¿çš„å¤§å‹chunkï¼Œæœ‰ä¸‰ä¸ªå¥½å¤„ï¼šå‡å°‘å…ƒæ•°æ®çš„æ•°é‡ï¼Œé™ä½ç”±äºclienté¢‘ç¹è®¿é—®chunkså¸¦æ¥çš„IOå»¶è¿Ÿï¼Œæå‡SSDçš„å¯¿å‘½ã€‚è€Œè¿‡å¤§çš„chunkåˆ™ä¼šå¯¼è‡´ç¢ç‰‡åŒ–çš„ç©ºé—´æµªè´¹ï¼Œå› æ­¤é‡‡ç”¨äº†å˜é•¿çš„æ–¹å¼(1MB-2GB)ï¼Œä½†å®é™…ä¸Š95%çš„chunkå¤§å°éƒ½ä¸º64MB(å’ŒGFSç›´æ¥è®¾å®šä¸º64MBå·®ä¸å¤š) åœ¨clientç¼“å­˜chunkä¿¡æ¯ï¼Œåœ¨clientç«¯å»ºç«‹ä¸€ä¸ªå…³äºmetadataçš„ç¼“å†²æ± ï¼Œå½“ç¼“å­˜æœªå‘½ä¸­æˆ–è€…ç¼“å­˜äº†é™ˆæ—§æ•°æ®æ—¶(chunkserverç»™äºˆå›å¤æ—¶ä¸€å¹¶å‘ŠçŸ¥)ï¼Œå’Œmasterè¿›è¡Œé€šä¿¡æ¥è·å–æœ€æ–°çš„metadata æ‰¹å¤„ç†çš„å½¢å¼æ¥å¤„ç†chunkä¿¡æ¯ï¼šclientå°†ä¸€å°æ®µæ—¶é—´å†…çš„å¤šä¸ªchunkçš„è¯·æ±‚è¿›è¡Œèšåˆç„¶åæ‰¹é‡å‘ç»™master é¢„æµ‹æ€§æå‰è·å–ï¼šè·å–ä¸€ä¸ªchunkå†…å®¹æ—¶ï¼Œé¢„æµ‹æ€§çš„è·å–ç›¸å…³çš„chunkï¼Œå­˜å‚¨åœ¨å®¢æˆ·ç«¯ï¼Œä»è€Œå‡å°‘å¯¹chunk serverå‘èµ·è¯·æ±‚ æ•°æ®æ­è½½ä»¥å‡å°‘ 1 ä¸ª RTTï¼Œå°† chunk åˆ›å»ºè¯·æ±‚å’Œè¦å†™å…¥çš„æ•°æ®åˆå¹¶ä¸ºä¸€ä¸ªè¯·æ±‚å¹¶å°†å…¶å‘é€åˆ° chunkserverã€‚ Chunkserver USSOS æ–‡ä¸­æŒ‡å‡ºï¼Œä¼ ç»Ÿçš„kernel-spaceæ–‡ä»¶ç³»ç»Ÿä¼šå­˜åœ¨é¢‘ç¹çš„ç³»ç»Ÿä¸­æ–­å¯¼è‡´æ¶ˆè€—CPUèµ„æºçš„æƒ…å†µï¼Œå’ŒæŸäº›æ•°æ®åœ¨user spaceå’Œkernel spaceå½“ä¸­å­˜å‚¨äº†ä¸¤ä»½ã€‚ä¸ºè§£å†³è¿™ç±»é—®é¢˜ï¼Œé€šè¿‡ç»•è¿‡å†…æ ¸(kernel-bypassing)çš„æ–¹å¼è®¾è®¡äº†USSOS\nuser-levelçš„å†…å­˜ç®¡ç†ï¼š å»ºç«‹ä¸€å—ä½¿ç”¨huge-pageçš„ç©ºé—´ä½œä¸ºç½‘ç»œæ ˆå’Œå­˜å‚¨æ ˆä¹‹é—´çš„å…±äº«å†…å­˜ï¼Œä»è€Œå‡å°‘æ‹·è´çš„å¼€é”€\nä»»åŠ¡è°ƒåº¦ï¼š\nç”±äºé‡‡ç”¨äº†run-to-completionçš„çº¿ç¨‹æ¨¡å‹ï¼Œå¯¹äºé•¿æ—¶é—´è¿è¡Œä¼šé˜»å¡åé¢å…¶ä»–ä»»åŠ¡çš„ï¼Œç§»åŠ¨è‡³åå°çº¿ç¨‹è¿è¡Œ ä¼˜å…ˆçº§è°ƒåº¦ï¼šå»ºç«‹ä¸åŒçš„ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼Œæ ¹æ®QoSç›®æ ‡å°†ä¸åŒçš„ä»»åŠ¡æ”¾åˆ°å¯¹åº”çš„é˜Ÿåˆ—å½“ä¸­ NAPIï¼šå€Ÿé‰´ Linux çš„ NAPIï¼Œé‡‡ç”¨ pollingï¼ˆè½®è¯¢ï¼‰ + event-drivenï¼ˆäº‹ä»¶é©±åŠ¨ï¼‰ ç›¸ç»“åˆçš„æ–¹å¼ï¼Œç½‘å¡å¯¹åº”äº†ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œå½“æœ‰ä»»åŠ¡åˆ°è¾¾æ—¶é€šè¿‡æ–‡ä»¶æè¿°ç¬¦è§¦å‘ä¸­æ–­å”¤é†’ç½‘å¡ï¼Œå³äº‹ä»¶é©±åŠ¨ï¼Œç½‘å¡å¤„ç†ä»»åŠ¡ï¼Œå¹¶è¿›å…¥è½®è¯¢æ¨¡å¼ï¼Œä¸æ–­è¯¢é—®æ˜¯å¦è¿˜æœ‰åç»­ä»»åŠ¡ï¼Œå¦‚æœæœ‰åˆ™å¯ä»¥å¿«é€Ÿå¤„ç†ï¼Œæ— éœ€è¿›è¡Œä¸­æ–­å¤„ç†ï¼›å¦‚æœä¸€æ®µæ—¶é—´æ²¡æœ‰åç»­ä»»åŠ¡ï¼Œå°±å›åˆ°äº‹ä»¶é©±åŠ¨æ¨¡å¼ï¼Œç­‰å¾…ä¸­æ–­ Append-Only USSFS\nå¯¹Append-Onlyè¿›è¡Œä¸€ä¸ªæ€»ç»“ï¼š\nå……åˆ†åˆ©ç”¨self-contained(è‡ªåŒ…å«ï¼Ÿç‹¬ç«‹ï¼Ÿ)çš„chunkæ¥å‡å°‘æ•°æ®æ“ä½œæ¬¡æ•° ä¸å­˜åœ¨å¦‚inodeå’Œæ–‡ä»¶ç›®å½•ä¹‹é—´çš„å…³ç³»ï¼Œæ‰€æœ‰çš„æ“ä½œéƒ½éœ€è¦è®°å½•åœ¨log fileså½“ä¸­ï¼Œè€Œç›¸å…³çš„metadataå¯ä»¥é€šè¿‡é‡åšæ—¥å¿—æ¥é‡å»º ä½¿ç”¨è½®è¯¢æ¨¡å¼ä»£æ›¿Ext4ç­‰ä¸­æ–­é€šçŸ¥æœºåˆ¶ï¼Œæœ€å¤§é™åº¦å‘æŒ¥SSDçš„æ€§èƒ½ High Performance SLA Guarantee chasing\nå½“2 x MinCopy \u0026gt; MaxCopyæ—¶ï¼Œå…è®¸MaxCopyå‰¯æœ¬ä¸­çš„MinCopyæˆåŠŸå†™å…¥chunkserversæ—¶ï¼Œå®ƒå…è®¸å®¢æˆ·ç«¯å‘åº”ç”¨ç¨‹åºè¿”å›æˆåŠŸï¼Œå³ä¸‰ä¸ªå‰¯æœ¬çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥ä¸¤ä¸ªchunkserverå®Œæˆå†™å…¥å°±å…è®¸è¿”å›successï¼Œæ­¤æ—¶clientä¼šå°†chunkåœ¨å†…å­˜å½“ä¸­ä¿ç•™æ—¶é—´æ®µt(msçº§)ï¼š\nå¦‚æœåœ¨è¿™ä¸ªæ—¶é—´æ®µå†…èƒ½å¤ŸæˆåŠŸå¾—åˆ°å“åº”ï¼Œå³å¯å°†chunkä»å†…å­˜å½“ä¸­ç§»é™¤ï¼Œç»“æŸæ­¤æ¬¡è¯·æ±‚ å¦‚æœæ— æ³•å¾—åˆ°å“åº”ï¼Œå–å†³äºæœªå®Œæˆå†™å…¥çš„éƒ¨åˆ†çš„å¤§å°kï¼š å¦‚æœ \u0026gt; kï¼Œåˆ™å°å­˜è¿™ä¸ªchunkï¼Œä¹‹åä¸å¯¹è¿™ä¸ªchunkè¿›è¡Œå†™å…¥æ“ä½œï¼Œä»å¦å¤–ä¸¤ä¸ªserverå½“ä¸­å¤åˆ¶æ•°æ®åˆ°ä¸€ä¸ªæ–°çš„chunkserverå½“ä¸­ å¦‚æœ \u0026lt; kï¼Œåˆ™å°è¯•å¯¹ chunk 3 è¿›è¡Œé‡è¯• chasingè®¾è®¡çš„å‡ºå‘ç‚¹å¹¶ä¸æ˜¯å®¹é”™ï¼Œè€Œæ˜¯ä¸ºäº†åœ¨ä¿è¯æ•°æ®ä¸ä¸¢å¤±çš„æƒ…å†µä¸‹ï¼Œå°½å¯èƒ½çš„é™ä½å“åº”çš„å»¶è¿Ÿï¼Œä½¿ç”¨chasingè¿™ä¸ªè¯æ¥è¿›è¡Œæè¿°ï¼ŒæŒ‡çš„å°±æ˜¯å‰ä¸¤ä¸ªchunkserverå·²ç»å®Œæˆäº†å†™å…¥ï¼Œè€Œç¬¬ä¸‰ä¸ªserverè¿˜åœ¨è¡¥é½è¿›åº¦çš„è¿™æ ·ä¸€ä¸ªè¿‡ç¨‹ï¼Œè€Œåœ¨è¿™ä¸ªè¡¥é½çš„è¿‡ç¨‹å½“ä¸­ï¼Œæ˜¯å­˜åœ¨ç¬¬ä¸‰ä¸ªå¤‡ä»½åœ¨clientçš„ï¼Œåœ¨chasingçš„è¿‡ç¨‹å½“ä¸­ï¼Œä¹‹åclient chunkserver1 chunkserver2å…¨éƒ¨æŒ‚æ‰ä¹‹åï¼Œæ•°æ®æ‰ä¼šå½»åº•ä¸¢å¤±ã€‚\nNon-stop write\nè¿™ä¸€éƒ¨åˆ†è¡¥å……äº†å®¹é”™æœºåˆ¶ï¼Œå’Œchasingç»„æˆäº†å®Œæ•´çš„å†™å…¥è§„åˆ™ã€‚å¦‚æœåªæ˜¯å•çº¯çš„å†™å…¥å¤±è´¥ï¼ŒæœåŠ¡å™¨ä»å¯æ­£å¸¸è¯»å–çš„è¯ï¼Œé‚£ä¹ˆå°±å°å­˜å½“å‰çš„chunkï¼Œåˆ†é…ä¸€ä¸ªæ–°çš„chunkæ¥å†™å…¥æœªå®Œæˆçš„éƒ¨åˆ†ï¼Œè€Œå¦‚æœæ˜¯chunkå½“ä¸­çš„æ•°æ®æŸåï¼Œæˆ–è€…è¯´chunkserverå®•æœºï¼Œé‚£ä¹ˆå°±ä»å·²æˆåŠŸå†™å…¥çš„chunkå½“ä¸­ä½¿ç”¨åå°æµé‡å»æ‹·è´ä¸€ä»½åˆ°æ–°çš„chunkå½“ä¸­\nBackup Read\nclientåœ¨æ”¶åˆ°å“åº”ä¹‹å‰ï¼Œä¼šå‘å…¶ä»–çš„chunkserverå‘é€è¯»è¯·æ±‚ï¼Œä»¥é˜²æ­¢åŸæœ¬çš„chunkserverå®•æœºï¼Œä»è€Œå‡å°‘è¯»è¯·æ±‚çš„å»¶è¿Ÿ\nBlacklisting\nä¸ºæé«˜æœåŠ¡è´¨é‡ï¼Œè®¾ç½®äº†é»‘åå•åˆ¶åº¦ï¼Œåˆ†ä¸¤ç§æƒ…å†µï¼š\næ— æ³•æä¾›æœåŠ¡çš„æ·»åŠ åˆ°ç¡®å®šæ€§é»‘åå•å½“ä¸­ï¼Œå¦‚æœå¯ä»¥æä¾›æœåŠ¡åˆ™ç§»é™¤ å»¶è¿Ÿè¿‡é«˜çš„åˆ™åŠ å…¥åˆ°éç¡®å®šæ€§é»‘åå•å½“ä¸­ï¼ŒåŸºäºå»¶è¿Ÿç¡®å®šæ˜¯å¦ç§»é™¤ Phase Two: Adapting to PerformanceOriented Business Model è¿™ä¸ªé˜¶æ®µä¸»è¦è€ƒè™‘å¦‚ä½•è§£å†³æ€§èƒ½çš„ç“¶é¢ˆé—®é¢˜ï¼Œåˆ†åˆ«æ˜¯ç½‘ç»œç“¶é¢ˆï¼Œå†…å­˜ç“¶é¢ˆå’ŒCPUç“¶é¢ˆ\nNetWork Bottleneck é™¤äº†ç®€å•çš„æ‰©å¤§ç½‘ç»œå¸¦å®½ä»¥å¤–ï¼Œè¿™ä¸€éƒ¨åˆ†ä¸»è¦å¯¹æµé‡æ”¾å¤§ç‡è¿›è¡Œä¼˜åŒ–ï¼Œå‡å°‘éœ€è¦ä¼ è¾“çš„æ•°æ®é‡ï¼š\né€šè¿‡çº åˆ ç (EC)æ¥æ›¿ä»£åŸæœ¬çš„ä¸‰å¤‡ä»½å½¢å¼ï¼ŒEC(4,2)é…ç½®æŒ‡çš„æ˜¯ä½¿ç”¨å°†æ•°æ®åˆ†ä¸ºå››ä¸ªåˆ†ç‰‡ï¼Œä½¿ç”¨å…¶ä¸­ä¸¤ä¸ªåˆ†ç‰‡å°±å¯ä»¥æ¢å¤åŸæœ¬çš„æ•°æ® å…è®¸åœ¨åªå­˜å‚¨ç›¸å½“äºåŸå§‹æ•°æ®1.5å€çš„æ€»æ•°æ®é‡çš„æƒ…å†µä¸‹ï¼Œå®¹å¿ä»»æ„ä¸¤ä¸ªåˆ†ç‰‡çš„ä¸¢å¤± å¯¹FlatLogFileè¿›è¡Œå‹ç¼©ï¼šLZ4ç®—æ³• åŠ¨æ€åˆ†é…å¸¦å®½ï¼šå¦‚æ¥å—è¯·æ±‚å’Œåå°å¸¦å®½ï¼Œæ™šä¸Šè¿›è¡ŒGCä»»åŠ¡è¾ƒå¤šæ—¶å°±ç»™åå°åˆ†é…è¾ƒå¤§çš„å¸¦å®½ Memory Bottleneck ä½¿ç”¨å¤šå—è¾ƒå°å®¹é‡çš„å†…å­˜ä»¥å……åˆ†åˆ©ç”¨å†…å­˜é€šé“çš„å¸¦å®½ï¼Œæ¥ä»£æ›¿ä¸€æ•´å—å†…å­˜ å°†èƒŒæ™¯æµé‡ä¹Ÿä½¿ç”¨RDMAï¼Œæé«˜ä¼ è¾“æ•ˆç‡ RDCA CPU Bottleneck æ··åˆRPCï¼šä»¥å¾€ä½¿ç”¨protobufè¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–è¿™ä¸ªè¿‡ç¨‹éœ€è¦è€—è´¹30%çš„CPUå¼€é”€ï¼Œè€Œè¿™ç§æƒ…å†µåªä¼šå‡ºç°åœ¨å°‘é‡çš„rpcç±»å‹å½“ä¸­ï¼Œå› æ­¤é‡‡ç”¨æ··åˆrpcï¼Œéƒ¨åˆ†æƒ…å†µç›´æ¥ä¼ è¾“åŸå§‹ç»“æ„ï¼Œä¸è¿›è¡Œåºåˆ—åŒ– ä½¿ç”¨cpu waitä»¥æ”¯æŒè¶…çº¿ç¨‹ è½¯ç¡¬ä»¶ååŒè®¾è®¡ï¼Œå³å°†ä¸€éƒ¨åˆ†çš„è®¡ç®—å·¥ä½œè½¬ç§»è‡³FPGAæ¥å®Œæˆï¼Œä»¥å‡å°‘CPUçš„è´Ÿè½½ã€‚ ","permalink":"https://fischer0522.github.io/en/posts/tech/pangu2.0/","summary":"More Than Capacity: Performance-oriented Evolution of Pangu in Alibaba Introduction æœ¬æ–‡ä¸»è¦è®²è¿°äº†ç›˜å¤åˆ†å¸ƒå¼å­˜å‚¨åå¹´æ¥çš„ä¸€ä¸ªæ¼”å˜å†ç¨‹ï¼Œä¸»è¦åˆ†ä¸ºäº†ä¸‰ä¸ªé˜¶æ®µï¼Œåˆ†åˆ«æ˜¯1.0ï¼Œ2.0çš„é˜¶æ®µä¸€å’Œ2.0çš„é˜¶æ®µäºŒã€‚ åœ¨ç›˜","title":"More Than Capacity: Performance-oriented Evolution of Pangu in Alibaba"},{"content":"ç”±äºMiniobçš„æ•´ä½“æ¶æ„å¹¶æ²¡æœ‰åšå‡ºå¾ˆå¤§çš„å˜åŒ–ï¼Œå¹¶ä¸”ç›®å‰çŸ¥ä¹ä¸Šä¹Ÿå·²ç»æœ‰å…¶ä»–äººå†™çš„æ¶æ„åˆ†ææ–‡ç« ï¼Œæˆ‘åœ¨è¿™é‡Œå°±ä¸è¿‡å¤šä»‹ç»æ¶æ„ç›¸å…³çš„äº†ï¼Œåªè¯´ä¸€ä¸‹æˆ‘è‡ªå·±çš„ä¸€äº›å®ç°å’Œé‡åˆ°çš„bugä»¥åŠå¯¹åº”çš„ä¿®å¤æ–¹å¼ã€‚\nè´Ÿè´£é¢˜ç›® è´Ÿè´£é¢˜ç›®ï¼š\ndate drop-table update join-tables null text big write big query update-mvcc åˆèµ›é™„åŠ é¢˜ å…±è®¡210åˆ† ç”±äºé˜Ÿå‹é¾™å“¥å¤ªçŒ›äº†ï¼Œä¸€ä¸ªäººæå®Œäº†æ‰€æœ‰å¸¦åµŒå¥—å­è¯­å¥çš„é¢˜ï¼Œå¹¶ä¸”åšäº†å¥½å‡ ä¸ªmidçš„é¢˜ï¼Œæ‰€ä»¥ç•™ç»™æˆ‘å®ç°çš„å†…å®¹ä¹Ÿä¸å¤ªå¤šï¼Œå¹¶ä¸”ç”±äºæˆ‘æœªæ¥ç ”ç©¶ç”Ÿé˜¶æ®µä¸»è¦åšçš„æ˜¯å­˜å‚¨æ–¹å‘çš„ï¼Œå› æ­¤è¿™æ¬¡åˆèµ›å½“ä¸­æˆ‘ä¹Ÿä¸»è¦è´Ÿè´£å­˜å‚¨ç›¸å…³çš„å†…å®¹ï¼Œå¦‚record-managerçš„ç›¸å…³æ”¹é€ ï¼Œå’Œæ–°ç±»å‹çš„æ”¯æŒã€‚\næ­¤å¤–ï¼Œåœ¨å®ç°nullå’Œupdate-mvccæ—¶ï¼Œå‘ç°äº†Miniobç›®å‰å­˜åœ¨çš„ä¸¤ä¸ªbugï¼Œå’Œæ¥å“¥æ²Ÿé€šä¹‹åï¼Œä¹Ÿæ˜¯æäº†præŠŠæˆ‘çš„è§£å†³æ–¹æ¡ˆç»™åˆå¹¶åˆ°äº†ä¸»åˆ†æ”¯å½“ä¸­ï¼Œä¹Ÿç®—æ˜¯åšä¸€äº›å¼€æºè´¡çŒ®äº†ã€‚\nèµ›ç¨‹å®‰æ’ ä¹æœˆä»½å°±æŠŠå»å¹´obçš„ä»£ç ç»™æ‹‰ä¸‹æ¥äº†ï¼Œå½“æ—¶ä¸»è¦åœ¨æé¢„æ¨å…çš„äº‹ï¼ŒåŠ ä¸Šæ‡’äº†ï¼Œä¸€ç›´åœ¨æœ¬åœ°åƒç°ã€‚çœŸæ­£å¼€å§‹æçš„æ—¶å€™å¤§æ¦‚æ˜¯å¼€èµ›å‰ä¸€å‘¨ï¼Œå½“æ—¶åŒå¼€äº†rcore,æœ€åé€‰æ‹©æ˜¯çŒ®ç¥­rcoreå…¨åŠ›æobï¼Œrcoreå†™å®Œrustlingsä¹‹åä¾¿æ²¡æœ‰å†æ¨è¿›ã€‚\nå¼€èµ›å‰ä¸€å‘¨ çº¯åç‰¢ï¼Œé…ç¯å¢ƒå°±èŠ±äº†ä¸€å¤©ï¼Œsudoæ‰§è¡Œbashè„šæœ¬ç¼–è¯‘å‡ºæ¥çš„éœ€è¦sudoæ‰èƒ½å¯åŠ¨ï¼Œè€Œvscodeçš„è°ƒè¯•æ¨¡å¼åˆä¸æ”¯æŒsudoï¼Œ(åæ¥å‘ç°æŠŠbashè„šæœ¬é‡Œé¢çš„ä¸‹è½½ç¬¬ä¸‰æ–¹åº“çš„éƒ¨åˆ†æ³¨é‡Šæ‰å¯ä»¥ä¸sudoæ‰§è¡Œï¼Œå‘†)ï¼Œæ— å¥ˆæ¢äº†clionã€‚åé¢åˆå› ä¸ºé˜Ÿå‹çš„ä¸€äº›è¯­æ³•åœ¨Macæ”¯æŒä¸æ˜¯å¾ˆå¥½ï¼Œæ¢æˆäº†linuxä½œä¸ºå¼€å‘æœºï¼Œä¹‹åèŠ±äº†ä¸€ç‚¹æ—¶é—´ç¼•æ¸…æ¶æ„å’Œæ‰§è¡Œæµç¨‹ï¼Œåªåšäº†dateå’Œdrop-tableã€‚\nç¬¬ä¸€å‘¨ ç»§ç»­åç‰¢ï¼Œä¾æ—§æ²¡å†™å‡ ä¸ªé¢˜ï¼Œå¤§å¤šæ•°æ—¶é—´èŠ±åœ¨äº†ç ”ç©¶lexå’Œbison(æœ¬ç§‘é˜¶æ®µæ²¡å­¦è¿‡ç¼–è¯‘åŸç†)ï¼Œå’Œexpressionçš„ç›¸å…³å†…å®¹ï¼Œåªå†™å®Œäº†join tableså’Œæ¥æ‰‹äº†é˜Ÿå‹å†™äº†ä¸€åŠçš„update\nç¬¬äºŒå‘¨ ç®—æ˜¯ç†Ÿæ‚‰æ•´ä¸ªç³»ç»Ÿå’Œsqlè§£æäº†ï¼Œè¿›åº¦ä¸Šå¿«äº†ä¸€äº›ï¼Œå†™å®Œäº†null,å®Œå–„äº†updateçš„å¤šå­—æ®µæ”¯æŒï¼Œå’Œtextï¼Œé¡ºæ‰‹æäº†é™„åŠ é¢˜\nç¬¬ä¸‰å‘¨ èŠ±äº†ä¸¤å¤©æ—¶é—´æäº†ä¸€ä¸‹mvccï¼Œé€šè¿‡æ‰€æœ‰æµ‹è¯•ï¼Œæå‰æ”¶é˜Ÿã€‚\næ€è·¯åˆ†äº« drop table å¤§æ¦‚æ˜¯æœ€ç®€å•çš„ä¸€ä¸ªé¢˜äº†ï¼Œåªéœ€è¦æŠŠcreate tableç»™é€†å‘æ“ä½œå°±å¯ä»¥äº†ï¼Œå®˜ç½‘ä¹Ÿç»™å‡ºäº†è¯¦ç»†çš„æŒ‡å¯¼ï¼Œå¤§è‡´æ€è·¯åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼š\nåˆ é™¤xxx.table è¡¨çš„å…ƒæ•°æ®æ–‡ä»¶ åˆ é™¤xxx.dataæ•°æ®æ–‡ä»¶ åˆ é™¤xxx.indexç´¢å¼• é™¤æ­¤ä¹‹å¤–åšä¸€äº›ç®€å•çš„å¼‚å¸¸å¤„ç†å°±å¯ä»¥äº†ï¼Œæ ¡éªŒä¸€ä¸‹è¡¨åæ˜¯å¦å­˜åœ¨ç­‰ã€‚ Date ä»Šå¹´miniobçš„ä»£ç ç»“æ„ç›¸æ¯”äº22å¹´è¦ä¼˜åŒ–äº†ä¸å°‘ï¼Œä½†æ˜¯Dateæ¶‰åŠåˆ°è¦æ”¹åŠ¨çš„åœ°æ–¹ä¾æ—§ä¸å°‘ï¼Œä¸»è¦æœ‰ï¼š\nåœ¨lexå’Œyaccå½“ä¸­æ·»åŠ å¯¹ dateå’Œæ—¥æœŸæ ¼å¼çš„åŒ¹é…æ”¯æŒ åœ¨valueå½“ä¸­æ·»åŠ dateç±»å‹å’Œè¡¨ç¤ºå½¢å¼ è€ƒè™‘Dateçš„å…·ä½“å­˜å‚¨æ–¹æ³• ä¸º Date æ·»åŠ åˆå§‹åŒ–ï¼Œæ ¡éªŒï¼Œæ¯”è¾ƒç­‰åŠŸèƒ½ è§£æ ä¸»è¦éœ€è¦æ·»åŠ ä¸¤ä¸ªç±»å‹çš„è§£æï¼Œä¸€ä¸ªæ˜¯dateå…³é”®å­—ï¼Œä¸€ä¸ªæ˜¯yyyy-mm-ddæ ¼å¼çš„å­—ç¬¦ä¸²åŒ¹é…ï¼Œå‰è€…ç›´æ¥å®šä¹‰ä¸€ä¸ªtokenå³å¯ï¼Œåè€…å¯ä»¥é‡‡ç”¨æ­£åˆ™çš„å½¢å¼æ¥å¤„ç†ï¼Œå¯¹äºæ—¥æœŸå­—ç¬¦ä¸²çš„æ­£åˆ™åŒ¹é…ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯èŒƒå›´éœ€è¦ä»0000-00-00åˆ°9999-99-99éƒ½åŒ¹é…ä¸Šï¼Œå¦åˆ™å¦‚13æœˆè¿™ç§é”™è¯¯çš„æ—¥å¿—å°±ä¼šåŒ¹é…åˆ°æ™®é€šå­—ç¬¦ä¸²ä¸Šï¼Œä»è€Œå¯¼è‡´åæœŸæ— æ³•è¿›è¡Œæ ¡éªŒå¤„ç†ã€‚å…¶ä»–çš„æŒ‰ç…§å®˜æ–¹æ‰‹å†Œå®ç°å³å¯\nå­˜å‚¨ä¸è¡¨ç¤º\nåœ¨å­˜å‚¨ä¸Šï¼Œæˆ‘é€‰æ‹©äº†ä½¿ç”¨ä¸€ä¸ªyyyymmddçš„int32æ¥è¿›è¡Œå­˜å‚¨è¿™æ ·åªéœ€è¦å››ä¸ªå­—èŠ‚ï¼Œæ¯”å­—ç¬¦ä¸²è¦èŠ‚çœç©ºé—´ã€‚\nåœ¨å†…å­˜è¡¨ç¤ºä¸Šï¼Œæˆ‘é€‰æ‹©äº†å®šä¹‰ä¸€ä¸ªDateç±»ï¼Œå¹¶å°†ç›¸å…³çš„ç›¸å…³çš„é€»è¾‘æ“ä½œéƒ½å°è£…åœ¨è¿™é‡Œé¢ï¼Œå¦‚ç±»å‹è½¬æ¢ï¼Œåˆæ³•æ€§æ ¡éªŒï¼Œæ¯”è¾ƒï¼Œto_stringç­‰ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 class Date { public: Date() = default; Date(const char *str); Date(int data); // Date(int year,int month,int day); bool isValid() const { return valid; } bool operator\u0026lt;(const Date \u0026amp;that) const; bool operator==(const Date \u0026amp;that) const; int compare(const Date \u0026amp;that) const; std::string to_string() const; int to_int() const; void parse_date_int(int date); bool isDateValid() const; bool valid{}; int year{}; int month{}; int day{}; std::string format(const std::string \u0026amp;formatStr) constï¼› }; Value åœ¨valueå½“ä¸­ï¼Œæ·»åŠ äº†ä¸€ä¸ªDateå­—æ®µæ¥å­˜å‚¨ä¸€ä¸ªDateç±»ï¼Œå¹¶ä¸”æŠŠè½¬æ¢ä¸ºintçš„dateå­˜æ”¾åˆ°num_value_å½“ä¸­ï¼Œä¹‹å.data()ç”¨æ¥ä¼ è¾“æ•°æ®å’ŒæŒä¹…åŒ–æ—¶ç›´æ¥è¿”å›è¿™ä¸ªnum_value_å³å¯ã€‚\nåˆ°è¿™dateåŸºæœ¬å°±å®ç°å®Œäº†ï¼Œä¼¼ä¹ä»Šå¹´miniobçš„ä»£ç é‡æ„äº†ä¸å°‘ï¼Œå¾€å¹´è¯´è¿˜éœ€è¦æ›´æ”¹B+æ ‘éƒ¨åˆ†çš„ä»Šå¹´éƒ½ä¸éœ€è¦äº†ã€‚\ntypecast è¯´Joinä¹‹å‰å…ˆè¯´ä¸€ä¸‹typecastï¼Œä»Šå¹´typecastæ²¡æœ‰ä½œä¸ºä¸€ä¸ªå•ç‹¬çš„é¢˜ç›®å‡ºç°ï¼Œä½†æ˜¯ä¹Ÿå¹¶æ²¡æœ‰ç»™æä¾›å¾ˆå®Œå–„çš„å®ç°ï¼Œåœ¨å®ç°joinæ—¶å‘ç°äº†joinå¯¹typecastå¼ºä¾èµ–ï¼Œæ¶‰åŠåˆ°å¾ˆå¤šintå’Œstringï¼Œfloatå’Œstringä¹‹é—´çš„joinã€‚ä¸»è¦éœ€è¦ä¸ºstringå’Œå…¶ä»–çš„ç±»å‹ä¹‹é—´æä¾›è½¬æ¢ã€‚\nåœ¨githubçš„wikiå½“ä¸­ç»™å‡ºäº†æ ‡å‡†ï¼Œç…§ç€å®ç°å°±å¥½\nå­—ç¬¦ä¸²è½¬æ•°å­—\nå¦‚æœå­—ç¬¦ä¸²åˆšå¥½æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œåˆ™è½¬æ¢ä¸ºå¯¹åº”çš„æ•°å­—ï¼ˆå¦‚'1\u0026rsquo;è½¬æ¢ä¸º1ï¼Œ\u0026lsquo;2.1\u0026rsquo;è½¬æ¢ä¸º2.1ï¼‰; å¦‚æœå­—ç¬¦ä¸²çš„å‰ç¼€æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œåˆ™è½¬æ¢å‰ç¼€æ•°å­—éƒ¨åˆ†ä¸ºæ•°å­—ï¼ˆå¦‚'1a1\u0026rsquo;è½¬æ¢ä¸º1ï¼Œ\u0026lsquo;2.1a\u0026rsquo;è½¬æ¢ä¸º2.1ï¼‰; å¦‚æœå­—ç¬¦ä¸²å‰ç¼€ä¸æ˜¯ä»»ä½•åˆæ³•çš„æ•°å­—ï¼Œåˆ™è½¬æ¢ä¸º0ï¼ˆä¸éœ€è¦è€ƒè™‘å‰å¯¼ç¬¦å· \u0026lsquo;+\u0026rsquo; \u0026lsquo;-\u0026rsquo;ï¼‰ï¼›Â é—®é¢˜ï¼š å¦‚æœè½¬æ¢æ•°å­—æº¢å‡ºæ€ä¹ˆå¤„ç†?ï¼ˆä¸è€ƒè™‘ï¼‰ æ˜¯å¦è€ƒè™‘åå…­è¿›åˆ¶/å…«è¿›åˆ¶?ï¼ˆä¸è€ƒè™‘ï¼‰ Join Tables ç®—æ˜¯midé‡Œé¢æœ€ç®€å•çš„å‡ ä¸ªä¹‹ä¸€äº†ï¼Œä½†æ˜¯ä¾èµ–ä¸å°‘å…¶ä»–çš„ç›¸å…³å†…å®¹ï¼Œå¦‚typecastå’Œexpressionï¼Œä»Šå¹´çš„miniobå·²ç»å®ç°äº†select tablesï¼Œå› æ­¤åªéœ€è¦å†æ¬¡åŸºç¡€ä¸Šå®ç°joinå³å¯ã€‚\nå…ˆä»è§£æå¼€å§‹è¯´ï¼Œjoinä¸»è¦åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼Œå·¦è¡¨ï¼Œå³è¡¨ï¼Œå’Œæ¡ä»¶ï¼Œé€šè¿‡inner join onæ¥åˆ‡åˆ†å³å¯ï¼Œå¹¶ä¸”ç”±äºå¯èƒ½å­˜åœ¨å¤šå¼ è¡¨ä¹‹é—´çš„joinï¼Œå› æ­¤è¿™ä¸ªè§£æä¸ºä¸€ä¸ªé€’å½’çš„è¿‡ç¨‹ï¼Œå¯ä»¥å…ˆé€’å½’çš„è§£æinner join åé¢çš„å†…å®¹ï¼Œä¹‹åå†å°†æœ€åˆçš„å·¦è¡¨æ·»åŠ åˆ°å…¶ä¸­ã€‚åœ¨æ¡ä»¶çš„è§£æä¸Šï¼Œé˜Ÿå‹å®šä¹‰äº†conditionTreeçš„è§£ææ–¹å¼ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„è§£æå¤šä¸ªconditionï¼Œæˆ‘è¿™é‡Œå°±ç›´æ¥æ‹¿æ¥ç”¨äº†ã€‚è§£æçš„æ ¼å¼å¦‚ä¸‹ï¼š\n1 2 inner_join_list: | INNER JOIN table_name ON condition_tree inner_join_list æœ€ç»ˆçš„è§£æç»“æœå¯ä»¥å¾—åˆ°nä¸ªtableå’Œn-1ä¸ªconditon_treeï¼Œä¹‹ååœ¨select_stmtçš„createå½“ä¸­æŒ‰ç…§å’Œfilter_stmtç›¸åŒçš„æ–¹æ³•æ¥åˆ›å»ºä¸€ä¸ªjoin_stmtå³å¯ã€‚\næœ€åæ”¹å†™ä¸€ä¸‹join_operatorå½“ä¸­çš„é€»è¾‘å³å¯ï¼Œè¿™ä¸€éƒ¨åˆ†åè€Œæ˜¯å·¥ä½œé‡æœ€å°çš„ã€‚ 23å¹´çš„æ•°æ®é‡å¹¶ä¸å¤§ï¼Œå¹¶ä¸å­˜åœ¨å‰ä¸¤å¹´çš„6è¡¨joinçš„æƒ…å†µï¼Œå› æ­¤åªéœ€è¦å®ç°æœ€åŸºç¡€çš„NLJï¼Œç”šè‡³æˆ‘ä»¬åœ¨é‡æ„expressionçš„æ—¶å€™å–æ¶ˆäº†è°“è¯ä¸‹æ¨ä¾æ—§å¯ä»¥é€šè¿‡æµ‹è¯•ã€‚\nbug\nåœ¨è°ƒè¯•è¿‡ç¨‹ä¸­ï¼Œå‘ç°äº†ä¸€ä¸ªminiobå½“å‰å­˜åœ¨çš„bugï¼Œjoin operatorå½“ä¸­åœ¨åŒ¹é…æ—¶ï¼Œæ¯å½“å³è¡¨åŒ¹é…å®Œä¸€è½®ä¹‹åéƒ½è¦è°ƒç”¨table_scançš„close()å’Œopen()å‡½æ•°ï¼Œè€Œåœ¨è¿™å…¶ä¸­ï¼Œopen()å½“ä¸­åˆä¼šè°ƒç”¨ä¸€ä¸ªset schemaçš„å‡½æ•°ï¼Œåœ¨è¿™å…¶ä¸­ï¼Œæ˜¯é‡‡ç”¨push_backçš„æ–¹å¼è¿›è¡Œåˆå§‹åŒ–çš„ï¼Œä½†æ˜¯åœ¨close()å½“ä¸­åˆæ²¡æœ‰æ¸…ç©ºæ‰fieldæ•°ç»„ï¼Œå°±å¯¼è‡´ï¼Œæ¯æ¬¡openï¼Œéƒ½ä¼šå‘é‡Œé¢é‡æ–°æ·»åŠ ä¸€éfieldï¼Œä»è€Œå¯¼è‡´åœ¨è¿›è¡Œå¤šè½®éå†ä¹‹åï¼Œtupleé‡Œé¢ä¼šæœ‰å‡ åä¸ªfieldä¹‹å¤šï¼Œä¸è¿‡åœ¨ç‰©åŒ–çš„è¿‡ç¨‹ä¸­ï¼Œåªä¼šæ ¹æ®recordå»è·å–valueï¼Œè¿™æ ·å¹¶ä¸ä¼šå½±å“æ­£ç¡®æ€§ï¼Œä½†æ˜¯ä¼šå¯¼è‡´å¹³ç™½æ— æ•…çš„æ·»åŠ ä¸€å †æ— ç”¨çš„æ•°æ®ï¼Œæˆ‘åœ¨print tuple.to_stringæ—¶éƒ½æƒŠäº†ï¼Œä¹Ÿå¯èƒ½æ­£æ˜¯å› ä¸ºä¸å½±å“æ­£ç¡®æ€§ï¼Œè¿™ä¸ªbugä¹Ÿæ²¡æœ‰è¢«å‘ç°ï¼Œæ­£ç¡®çš„åšæ³•åº”è¯¥æ˜¯åœ¨set_schemaæ—¶å…ˆé‡ç½®å†æ·»åŠ \n1 2 3 4 5 6 7 8 9 void set_schema(const Table *table, const std::vector\u0026lt;FieldMeta\u0026gt; *fields) { table_ = table; this-\u0026gt;speces_.clear(); this-\u0026gt;speces_.reserve(fields-\u0026gt;size()); for (const FieldMeta \u0026amp;field : *fields) { speces_.push_back(new FieldExpr(table, \u0026amp;field)); } } Update updateæ¯”è¾ƒç®€å•ï¼Œå…ˆåˆ åå¢å³å¯ï¼Œæ³¨æ„åœ¨big queryå’Œbig writeå½“ä¸­éœ€è¦æ”¯æŒupdateå¤šä¸ªå­—æ®µï¼Œå…¶ä»–çš„å‚ç…§deleteå®ç°å³å¯ï¼Œåº”è¯¥æ˜¯æœ€ç®€å•operatoräº†ï¼Œç”¨æ¥ç†Ÿæ‚‰ä¸€ä¸‹æ•´ä¸ªsqlçš„æµç¨‹ä¸é”™ã€‚\nbig write / query updateåŠ ä¸Šå¤šå­—æ®µæ”¯æŒä¹‹åç›´æ¥è¿‡æ‰big queryå’Œbig writeï¼Œç›´æ¥+60ï¼Œæ°åˆ†æ°çˆ½äº†ã€‚\nnull å‚è€ƒå¾€å¹´çš„æ€è·¯ï¼Œé€‰æ‹©åœ¨sys_fieldåæ·»åŠ ä¸€ä¸ªnull_fieldæ¥è¡¨ç¤ºnull(ä¸ªäººæ„Ÿè§‰å•çº¯ç”¨ä¸€ä¸ªmagic numberè¡¨ç¤ºnullä¹Ÿä¸æ˜¯ä¸è¡Œï¼Œå•çº¯æƒ³è¿‡teståº”è¯¥æ˜¯å¯ä»¥è¿‡çš„)ã€‚\nnull_fieldä¸ºä¸€ä¸ªé•¿åº¦ä¸º32çš„bitmapï¼Œå¯ä»¥è¡¨ç¤ºåé¢32ä¸ªfieldæ˜¯å¦ä¸ºnullï¼Œå®Œå…¨è¶³å¤Ÿï¼Œåœ¨å­˜å‚¨çš„æ—¶å€™ç›´æ¥ä½¿ç”¨ä¸€ä¸ª4ä¸ªå­—èŠ‚çš„charsè¿›è¡Œå­˜å‚¨å³å¯ã€‚\nnullæœ‰è¿™ä¹ˆ2ä¸ªé—®é¢˜ï¼š\nupdateæ—¶å¦‚æœä»index = 0å¼€å§‹ç‰©åŒ–valueï¼Œä¼šè¯»åˆ°nullï¼Œä¹‹åå†make_recordæ—¶å°±ä¼šæŠŠnullåˆç»™æ‰”è¿›å»å½“æˆäº†ä¸€ä¸ªæ™®é€šçš„fieldï¼Œå¯¼è‡´recordé‡Œé¢æœ‰ä¸¤ä¸ªnull_fieldï¼Œéœ€è¦ç»™ä¸€ä¸ªsys_field_num + null_field_numçš„ä¸€ä¸ªoffsetï¼Œå¦å¤–ä¸€ç§è§£å†³æ–¹æ³•å°±æ˜¯é‡å†™cell_atå‡½æ•°ï¼Œåœ¨å…¶ä¸­ç»™ä¸€ä¸ªoffsetï¼Œä¸å¯¹å¤–æš´éœ²sys_fieldå’Œnull_field Null çš„è®¾ç½®æ—¶æœºï¼Œåˆšä»ç£ç›˜å½“ä¸­è¯»å–å‡ºæ¥çš„ record æ˜¯ä¸å…·æœ‰ null å±æ€§çš„ï¼Œéœ€è¦åœ¨ä¸€ä¸ªåˆé€‚çš„æ—¶æœºé€šè¿‡ bitmap æ¥æ¢å¤å…¶ null å±æ€§ï¼Œæœ€å¼€å§‹å®šä¹‰åœ¨ project operator é‡Œé¢ï¼Œåé¢å‘ç°æœ‰å¾ˆå¤šä¾èµ– null çš„ operator åœ¨ project operator ä¸‹é¢ï¼Œå› æ­¤æŠŠè¿™ä¸ªè®¾ç½® null çš„è¿‡ç¨‹ç§»åŠ¨åˆ°äº† RowTuple åˆ° set_record å’Œ cell_at é‡Œé¢ï¼Œåœ¨ set_record æ—¶ï¼Œä»ä¸­è§£æå‡º bitmapï¼Œä¹‹å cell_at æ—¶æ ¹æ® bitmap å»åˆ¤æ–­æ˜¯å¦ä¸º nullï¼Œæ˜¯å¦å…è®¸ä¸º null åˆ°é€»è¾‘ä¹Ÿåœ¨è¿™é‡Œå¤„ç†ï¼Œä¸è¿‡æ—¢ç„¶èƒ½æ­£ç¡®å†™å…¥ï¼Œè¿™é‡Œä¸€èˆ¬æ˜¯ä¸ä¼šå‡ºé—®é¢˜çš„ æ­¤å¤–ï¼Œnullè¿˜éœ€è¦Fieldå’ŒValueä¸ºå…¶æä¾›æ”¯æŒï¼Œæ·»åŠ å­—æ®µæ¥è¡¨ç¤ºæ˜¯å¦å…è®¸ä¸ºnullå’Œæ˜¯å¦ä¸ºnullï¼Œæ€»ä¹‹nulléœ€è¦æ”¹åŠ¨çš„éƒ¨åˆ†éå¸¸å¤šï¼Œå½“æ—¶commitæ—¶çœ‹äº†ä¸€çœ¼å¤§æ¦‚ä¿®æ”¹äº†20ä¸ªæ–‡ä»¶ã€‚ã€‚éº»äº† ä»Šå¹´nullçš„æµ‹è¯•ä¾èµ–ä¹Ÿå¾ˆå¤šï¼Œéœ€è¦å®ç°äº†update-selectï¼Œå’Œuniqueä¹‹åæ‰èƒ½è¿‡ï¼Œè€Œuniqueåˆä¾èµ–multi indexã€‚\ntext é€»è¾‘ä¸Šæ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯å‘ä¸å°‘ã€‚\né€»è¾‘ä¸Šé‡‡ç”¨æº¢å‡ºé¡µçš„æ–¹å¼å¤„ç†æ¯”è¾ƒç®€å•ï¼Œå†™å…¥æ—¶æŒ‰éœ€é¢å¤–å»ç”³è¯·å‡ ä¸ªpageç”¨æ¥å­˜å‚¨textæ•°æ®ï¼Œrecordæœ¬èº«å­˜å‚¨page_numï¼Œè¯»å–æ—¶å†æ ¹æ®page_numå»è·å–åˆ°çœŸå®çš„textå†…å­˜ã€‚ ä»Šå¹´çš„è¦æ±‚å˜äº†ï¼Œtextçš„æœ€å¤§é•¿åº¦å˜æˆäº†å’ŒMySQLä¸€è‡´çš„64KBï¼Œä½†æ˜¯æœ¬èº«çš„PAGE_SIZEä¹Ÿä»4KBå˜æˆäº†8KBï¼Œå› æ­¤å¦‚æœç®—ä¸Šheaderçš„è¯ï¼Œéœ€è¦9ä¸ªæº¢å‡ºé¡µæ¥è¿›è¡Œå­˜å‚¨ï¼Œæœ€é•¿çš„æƒ…å†µä¸ºå‰8ä¸ªpageå…¨éƒ¨å­˜æ»¡ï¼Œæœ€åä¸€ä¸ªpageå­˜éƒ¨åˆ†ã€‚\nå› æ­¤recordå½“ä¸­çš„fieldå°±éœ€è¦9ä¸ªintæ¥å­˜å‚¨ï¼Œæ•´ä¸ªfieldå 36ä¸ªå­—èŠ‚ï¼Œæ²¡æœ‰ç”¨ä¸Šçš„pageåœ¨å­˜å‚¨æ—¶å°±å‘recordé‡Œé¢æ·»åŠ INVALID_PAGE_NUMï¼Œè¯»å–çš„æ—¶å€™è¯»å–åˆ°INVALID_PAGE_NUMå°±æˆªæ–­å³å¯ã€‚ ä½†æ˜¯å®ç°çš„æ—¶å€™åœ¨é•¿åº¦ä¸Šæœ‰ä¸¤ä¸ªé—®é¢˜ï¼Œä¸€ä¸ªæ˜¯obclientæ— æ³•æ¥å—è¶…è¿‡4KBçš„textï¼Œè¶…é•¿ä¼šæˆªæ–­ï¼Œè¿™ä¸ªéœ€è¦ä¸‹è½½readlineï¼Œä¹‹åé‡æ–°ç¼–è¯‘ï¼Œè¿˜æœ‰ä¸€ä¸ªæ˜¯å‘é€ç½‘ç»œè¯·æ±‚æ—¶çš„buffer sizeä¸º8KBï¼Œå…¨æ–‡æœç´¢é•¿åº¦ï¼Œä¹‹ååœ¨åé¢åŠ ä¸ª0å°±è¡Œã€‚\nåœ¨è¿›è¡Œåˆ é™¤å’Œæ›´æ–°ä¸Šï¼Œéœ€è¦é¦–å…ˆåˆ é™¤æº¢å‡ºé¡µå½“ä¸­çš„å†…å®¹ï¼Œä¹‹åå†åˆ é™¤æ‰è¯¥æ¡recordï¼Œåˆ é™¤çš„è¯å¯ä»¥æœ‰ä¸¤ç§æ€è·¯ï¼Œä¸€æ˜¯å°†è¯¥pageé€šè¿‡init_empty_pageè¿›è¡Œåˆå§‹åŒ–ï¼Œä¹‹ååŠ å…¥åˆ°free_listå½“ä¸­ï¼Œè€Œæ˜¯å¯ä»¥ä½¿ç”¨disposeå°†å…¶åˆ é™¤ï¼Œä¹‹åç”¨æ¥é‡æ–°åˆ†é…ã€‚ä¸è¿‡æˆ‘éƒ½æ²¡å®ç°ï¼Œè°è®©ä¸æ£€æµ‹å‘¢ :)\nUpdate mvcc å…ˆè¯´è¯´MVCCæœ¬èº«ï¼Œå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼Œä½†æ˜¯ä¸¥æ ¼æ„ä¹‰ä¸Šæ¥è¯´å¹¶ä¸æ˜¯ä¸€ä¸ªå®Œæ•´çš„å¹¶å‘æ§åˆ¶åè®®ï¼ŒMVCCæœ€å¤§çš„ç‰¹ç‚¹æ˜¯ä¿è¯äº†è¯»å†™ä¹‹é—´ä¸å†²çªï¼Œå†™è¯·æ±‚ä¸ä¼šå› ä¸ºæ­£åœ¨è¯»è€Œé˜»å¡å†™å…¥ï¼Œè€Œè¯»è¯·æ±‚å¯ä»¥æ ¹æ®è‡ªèº«ç‰ˆæœ¬å»è¯»å–åˆ°å¯¹è‡ªå·±å¯è§çš„ç‰ˆæœ¬æ•°æ®ï¼Œä¸ä¼šè¢«æ­£åœ¨æ‰§è¡Œçš„å†™å…¥é˜»å¡ã€‚\nä¹‹æ‰€ä»¥è¯´MVCCå¹¶ä¸æ˜¯ä¸€ä¸ªå®Œæ•´çš„å¹¶å‘æ§åˆ¶ï¼Œæ˜¯å› ä¸ºMVCCå¹¶æ²¡æœ‰åŠæ³•è§£å†³å†™å†™ä¹‹é—´çš„å†²çªï¼Œå› æ­¤éœ€è¦å…¶ä»–çš„æ‰‹æ®µæ¥åŠ ä»¥è¾…åŠ©ï¼Œå¸¸è§çš„æ‰‹æ®µæœ‰åŸºäºæ—¶é—´æˆ³æˆ–è€…åŸºäºé”çš„ï¼ŒMiniobå½“ä¸­çš„å®ç°æ–¹å¼æ¯”è¾ƒç²—æš´ï¼Œåªè¦æœ‰ä¸¤ä¸ªäº‹åŠ¡åœ¨æ›´æ–°åŒä¸€ä¸ªrecordï¼Œé‚£ä¹ˆåä¸€ä¸ªäº‹åŠ¡åœ¨æ›´æ–°æ—¶å°±è¿”å›failtureã€‚\nè€ŒMVCCå½“ä¸­çš„ç‰ˆæœ¬æ˜¯åŸºäºtidçš„ï¼Œåœ¨å¼€å¯äº†MVCCæ¨¡å¼ä¹‹åï¼Œæ¯ä¸€æ¡recordä¼šç”Ÿæˆä¸¤ä¸ªsys_fieldï¼Œåˆ†åˆ«å­˜å‚¨beginå’Œendï¼Œæ¥æ ‡è¯†ä¸€ä¸ªäº‹åŠ¡çš„å¯è§æ€§ï¼Œè¿™é‡Œä¼¼ä¹å¹¶æ²¡æœ‰ä¸€ä¸ªç»Ÿä¸€çš„æ ‡å‡†ï¼Œåªè¦èƒ½æ»¡è¶³MVCCåè®®æœ¬èº«çš„è¦æ±‚å³å¯ï¼Œåœ¨Miniobå½“ä¸­çš„è®¾ç½®å¦‚ä¸‹ï¼š\nrecordé€šè¿‡beginå’Œend ä¸¤ä¸ªidè¿›è¡ŒçŠ¶æ€ç®¡ç†ï¼Œbeginç”¨äºè¡¨ç¤ºäº‹åŠ¡å¼€å§‹çš„æ—¶é—´ï¼Œendä¸ºäº‹åŠ¡ç»“æŸçš„æ—¶é—´ï¼Œå¯¹äºä¸€æ¡record,å½“ä¸€ä¸ªäº‹åŠ¡å¼€å§‹æ—¶ï¼Œæ–°çš„recordçš„beginè®¾ç½®ä¸º-trx_idï¼Œendä¸ºmax_int32,è¡¨ç¤ºäº‹åŠ¡å†™å…¥ä½†æœªæäº¤ï¼Œè€Œåˆ é™¤æ—¶åˆ™å°†endè®¾ç½®ä¸º-trx_idï¼Œè¡¨ç¤ºåˆ é™¤ä½†æœªæäº¤ï¼Œå†™å…¥æ“ä½œæäº¤æ—¶ï¼Œå°†beginè®¾ç½®ä¸ºtrx_idï¼Œåˆ é™¤æ“ä½œæäº¤æ—¶å°†endè®¾ç½®ä¸ºtrx_idï¼Œæœ€ç»ˆä¼šäº§ç”Ÿäº”ç§çŠ¶æ€ï¼š\nbegin_xid end_xid è‡ªèº«å¯è§ å…¶ä»–äº‹åŠ¡å¯è§ è¯´æ˜ -trx_id MAX å¯è§ ä¸å¯è§ ç”±å½“å‰äº‹åŠ¡å†™å…¥ï¼Œä½†è¿˜æœªæäº¤ï¼Œå¯¹å…¶ä»–äº‹åŠ¡ä¸å¯è§ trx_id MAX å·²æäº¤ å¯¹æ–°äº‹åŠ¡å¯è§ å†™å…¥å¹¶ä¸”å·²ç»æäº¤ï¼Œå¯¹ä¹‹åçš„æ–°äº‹åŠ¡å¯è§ ä»»æ„æ­£æ•° trx_id å·²æäº¤ æ—§äº‹åŠ¡å¯è§ï¼Œæ–°äº‹åŠ¡ä¸å¯è§ åœ¨å½“å‰äº‹åŠ¡ä¸­è¿›è¡Œåˆ é™¤ï¼Œå¹¶äº‹åŠ¡æäº¤ ä»»æ„æ­£æ•° -trx_id ä¸å¯è§ å¯è§ åœ¨å½“å‰äº‹åŠ¡ä¸­è¿›è¡Œåˆ é™¤ï¼Œæœªæäº¤ -trx_id -trx_id ä¸å¯è§ ä¸å¯è§ ç”±å½“å‰äº‹åŠ¡è¿›è¡Œå†™å…¥ï¼Œå¹¶ä¸”åˆè¢«å½“å‰äº‹åŠ¡åˆ é™¤ï¼Œå¹¶ä¸”æœªæäº¤ å…¶ä¸­ï¼Œå·²æäº¤æŒ‡çš„å°±æ˜¯å½“å‰äº‹åŠ¡å·²ç»ç»“æŸï¼Œè‡ªç„¶ä¸å­˜åœ¨ä»€ä¹ˆå¯è§ä¸å¯è§çš„é—®é¢˜ã€‚è€ŒMiniobå½“ä¸­çš„éš”ç¦»çº§åˆ«åº”å½“æ˜¯serializableï¼Œå› ä¸ºæœªæäº¤çš„äº‹åŠ¡çš„ begin \u0026lt; 0ï¼Œå› æ­¤æ˜¯æ°¸è¿œæ— æ³•è¯»å–åˆ°æ–°å†™å…¥çš„recordï¼Œå› æ­¤æ˜¯ä¸å­˜åœ¨å¹»è¯»æƒ…å†µçš„ã€‚\nå¯¹äºrecordæ˜¯å¦å¯è§çš„åˆ¤æ–­ï¼Œåœ¨visit_recordå½“ä¸­æä¾›äº†ä¸€æ®µä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 if (begin_xid \u0026gt; 0 \u0026amp;\u0026amp; end_xid \u0026gt; 0) { if (trx_id_ \u0026gt;= begin_xid \u0026amp;\u0026amp; trx_id_ \u0026lt;= end_xid) { rc = RC::SUCCESS; } else { rc = RC::RECORD_INVISIBLE; } } else if (begin_xid \u0026lt; 0) { // begin xid å°äº0è¯´æ˜æ˜¯åˆšæ’å…¥è€Œä¸”æ²¡æœ‰æäº¤çš„æ•°æ® rc = (-begin_xid == trx_id_) ? RC::SUCCESS : RC::RECORD_INVISIBLE; } else if (end_xid \u0026lt; 0) { // end xid å°äº0 è¯´æ˜æ˜¯æ­£åœ¨åˆ é™¤ä½†æ˜¯è¿˜æ²¡æœ‰æäº¤çš„æ•°æ® if (readonly) { // å¦‚æœ -end_xid å°±æ˜¯å½“å‰äº‹åŠ¡çš„äº‹åŠ¡å·ï¼Œè¯´æ˜æ˜¯å½“å‰äº‹åŠ¡åˆ é™¤çš„ rc = (-end_xid != trx_id_) ? RC::SUCCESS : RC::RECORD_INVISIBLE; } else { // å¦‚æœå½“å‰æƒ³è¦ä¿®æ”¹æ­¤æ¡æ•°æ®ï¼Œå¹¶ä¸”ä¸æ˜¯å½“å‰äº‹åŠ¡åˆ é™¤çš„ï¼Œç®€å•çš„æŠ¥é”™ // è¿™æ˜¯äº‹åŠ¡å¹¶å‘å¤„ç†çš„ä¸€ç§æ–¹å¼ï¼Œéå¸¸ç®€å•ç²—æš´ã€‚å…¶å®ƒçš„å¹¶å‘å¤„ç†æ–¹æ³•ï¼Œå¯ä»¥ç­‰å¾…ï¼Œæˆ–è€…è®©å®¢æˆ·ç«¯é‡è¯• // æˆ–è€…ç­‰äº‹åŠ¡ç»“æŸåï¼Œå†æ£€æµ‹ä¿®æ”¹çš„æ•°æ®æ˜¯å¦æœ‰å†²çª rc = (-end_xid != trx_id_) ? RC::LOCKED_CONCURRENCY_CONFLICT : RC::RECORD_INVISIBLE; } } å½“å‰å­˜åœ¨çš„é—®é¢˜\nç®€å•æ¥è¯´ï¼Œå°±æ˜¯äº‹åŠ¡æäº¤æ—¶ï¼Œå…ˆæ’å…¥å†åˆ é™¤çš„è®°å½•è¡Œä¸ºæ²¡æœ‰å¾—åˆ°æ­£ç¡®çš„è¡¨è¾¾ï¼Œäº§ç”Ÿäº†é¢„æœŸä¹‹å¤–çš„è¡¨ç°\nç¼ºå°‘begin \u0026lt; 0 \u0026amp;\u0026amp; end \u0026lt; 0çš„å¤„ç†ï¼Œå¯¼è‡´å½“å‰äº‹åŠ¡ä¸­å†™å…¥çš„è®°å½•æ— æ³•åˆ é™¤ commitæ—¶å­˜åœ¨é—®é¢˜ï¼Œinsertä¹‹åï¼Œdeleteçš„è®°å½•æ— æ³•æ·»åŠ åˆ°operationé‡Œé¢ï¼Œoperationä¸ºä¸€ä¸ªset,setçš„é€»è¾‘æ˜¯å¯¹äºå†²çªçš„keyæ‹’ç»è¿›è¡Œæ·»åŠ ï¼Œä¼šå¯¼è‡´å³ä¾¿ä¿®å¤äº†1, åœ¨commitä¹‹åä¼šå‡ºç°begin = commit_id,end = -trx_idçš„æƒ…å†µï¼Œç†è®ºä¸Šè¿™ç§æƒ…å†µä¸åº”è¯¥å‡ºç°ï¼Œå› ä¸ºdeleteçš„commitè¡Œä¸ºæ²¡æœ‰å¾—åˆ°æ­£ç¡®æ‰§è¡Œï¼Œå¦‚æœdeleteçš„commitè¡Œä¸ºå¾—åˆ°æ­£ç¡®æ‰§è¡Œï¼Œå°±ä¼šå˜æˆbegin \u0026gt; 0 \u0026amp;\u0026amp; end \u0026gt; 0çš„æƒ…å†µï¼Œå°±å¯ä»¥æŒ‰ç…§ç‰ˆæœ¬å»è¯»å–äº†ã€‚ å¯¹äºä¸Šé¢è¯´åˆ°çš„ç¬¬ä¸€ç‚¹ï¼Œå°‘äº†å¯¹begin \u0026lt; 0 \u0026amp;\u0026amp; end \u0026lt; 0çš„åˆ¤æ–­ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸ºå½“å‰äº‹åŠ¡å†™å…¥ï¼Œåˆè¢«å½“å‰äº‹åŠ¡åˆ é™¤ï¼Œä½†æ˜¯äº‹åŠ¡è¿˜æœªæäº¤ï¼Œæ­¤æ—¶åº”å½“å¯¹å½“å‰äº‹åŠ¡æ˜¯ä¸å¯è§çš„ï¼Œä½†æ˜¯æ ¹æ®ç›®å‰çš„æ¡ä»¶ç»“æ„ï¼Œä¼šè¿”å›SUCCESSï¼Œè¿™æ ·ä¼šå¯¼è‡´åœ¨å½“å‰äº‹åŠ¡ä¸­è¿›è¡Œdeleteä½†æ˜¯ä»å¯è§çš„é—®é¢˜ï¼Œæˆ–è€…å½“å‰äº‹åŠ¡ä¸­è¿›è¡Œupdateï¼Œä½†æ˜¯æ—§æ•°æ®è¿˜å­˜åœ¨çš„é—®é¢˜ã€‚éœ€è¦è¡¥å……ä¸€æ¡é€»è¾‘ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹è¿”å›ä¸å¯è§\nå¦‚ä¸‹é¢çš„ä¾‹å­ï¼š\nåŸæœ¬(4,4,\u0026lsquo;a\u0026rsquo;)çš„recordæ˜¯ç”±ä¸Šä¸€ä¸ªäº‹åŠ¡å†™å…¥çš„ï¼Œå¹¶ä¸”æäº¤(begin_xid \u0026gt; 0)ï¼Œæ­¤æ—¶æ›´æ–°å°±ä¸ä¼šå‡ºç°é—®é¢˜ï¼Œè€Œ(4,761,\u0026lsquo;a\u0026rsquo;)çš„recordæ˜¯å½“å‰äº‹åŠ¡å†™å…¥çš„ï¼Œè¿˜æœªæäº¤ï¼Œbegin_xid \u0026lt; 0,åˆ é™¤ä¹‹åend_xid \u0026lt; 0ï¼Œä¸Šé¢æ¼äº†å¯¹è¿™ç§æƒ…å†µçš„åˆ¤æ–­ï¼Œä»è€Œå¯¼è‡´å…¶åˆå¯è§ã€‚\nå¯¹äºè¯´åˆ°çš„ç¬¬äºŒç‚¹ï¼Œè¡¨ç°å½¢å¼å°±æ˜¯å¦‚æœå½“å‰çš„äº‹åŠ¡commitä¹‹åï¼Œè¿™æ¡è®°å½•å°±åˆå¯è§äº† ä¸‹å›¾æ˜¯æˆ‘ç”¨åˆå§‹ç‰ˆçš„miniobåšçš„æµ‹è¯•ï¼Œå¯ä»¥ç¡®è®¤çš„ç¡®å­˜åœ¨è¿™ä¸ªé—®é¢˜ ä¿®å¤æ–¹å¼ æè¿°å®Œäº§ç”Ÿçš„é—®é¢˜ï¼Œå†æ¥è¯´ä¸€ä¸‹ä¸ºä»€ä¹ˆä¼šæœ‰è¿™ç§é—®é¢˜å’Œè§£å†³æ–¹å¼ã€‚ äº§ç”Ÿçš„åŸå› ä¸»è¦æœ‰ä¸¤ä¸ªï¼š\nseté€»è¾‘é”™è¯¯ï¼ŒåŸæœ¬æƒ³çš„æ˜¯å¯¹äºåŒä¸€æ¡recordçš„æ“ä½œï¼Œåé¢çš„è¦†ç›–å‰ä¸€æ¡ï¼Œæœ€åæäº¤æ—¶åªä¼šæ‰§è¡Œæœ€åä¸€æ¡ï¼Œä½†æ˜¯c++å½“ä¸­çš„std::setå¯¹äºé‡å¤keyçš„æ’å…¥æ“ä½œä¼šç›´æ¥æ‹’ç»ï¼Œå¯¼è‡´æ²¡èƒ½å¤Ÿæ­£ç¡®çš„è¦†ç›– è¦†ç›–é€»è¾‘ï¼šå› ä¸ºé‡‡ç”¨è¦†ç›–çš„æ–¹å¼æ‰§è¡Œï¼Œå› æ­¤å¯¹äºåœ¨å½“å‰äº‹åŠ¡å½“ä¸­æ’å…¥çš„æ•°æ®ï¼Œåœ¨commitæ—¶deleteä¼šè¦†ç›–æ‰insertçš„åŠ¨ä½œï¼Œå°±ä¼šå¯¼è‡´ä¸€ä¸ªé—®é¢˜ï¼šinsertçš„commitåŠ¨ä½œæ²¡æœ‰æ­£ç¡®å¾—åˆ°æ‰§è¡Œï¼Œå‡ºç°äº†begin \u0026lt; 0 end \u0026gt; 0çš„æƒ…å†µï¼Œåœ¨åŸæœ¬çš„tidæ ¡éªŒå½“ä¸­æ²¡æœ‰åˆ¤æ–­ï¼Œè€Œcommitå‰çš„begin \u0026lt; 0 end \u0026lt; 0çš„æƒ…å†µåŒæ ·ä¹Ÿæ²¡æœ‰åˆ¤æ–­ å¤§æ¦‚æƒ³äº†ä¸¤ç‰ˆä¿®å¤æ–¹å¼ï¼š ç¬¬ä¸€ç‰ˆæ¯”è¾ƒå¤æ‚ï¼Œé€»è¾‘ä¸Šæ„Ÿè§‰æ›´ç¬¦åˆmvccçš„å«ä¹‰ï¼š\nç”±å½“å‰äº‹åŠ¡å†™å…¥çš„è®°å½•æ— æ³•è¢«åˆ é™¤ï¼š\nå½“å‰äº‹åŠ¡å†™å…¥çš„è®°å½•ä¸ºbegin = -trx_idï¼Œend = MAX,ä¹‹åç”±å½“å‰è®°å½•è¿›è¡Œåˆ é™¤ä¹‹åï¼Œå˜ä¸ºbegin = -trx_id,end = -trx_idï¼Œå½“å‰visit_recordå½“ä¸­ç¼ºå°‘å¯¹äºè¿™ç§æƒ…å†µçš„åˆ¤æ–­\nè§£å†³æ–¹æ¡ˆï¼šæ·»åŠ å¯¹begin \u0026lt; 0 \u0026amp;\u0026amp; end \u0026lt; 0çš„åˆ¤æ–­ï¼Œæ„ä¹‰æ˜¯ç”±å½“å‰äº‹åŠ¡å†™å…¥ï¼Œå¹¶ç”±å½“å‰äº‹åŠ¡åˆ é™¤ï¼ŒçŠ¶æ€ä¸ºå¯¹æ‰€æœ‰äº‹åŠ¡éƒ½ä¸å¯è§\ncommitåŠ¨ä½œæ²¡æœ‰è¢«æ­£å¸¸æ‰§è¡Œ\nå½“å‰äº‹åŠ¡ä½¿ç”¨ridä½œä¸ºkeyï¼Œä½¿ç”¨std::unordered_setè¿›è¡Œå­˜å‚¨ï¼Œä¿å­˜å½“å‰äº‹åŠ¡çš„operation,ç•™åœ¨æäº¤æ—¶è¿›è¡Œæ‰§è¡Œï¼ŒåŒä¸€ä¸ªridçš„operationåº”å½“åè€…è¦†ç›–å‰è€…ï¼Œä½†æ˜¯setå¯¹äºå·²ç»å­˜åœ¨äº†çš„keyæ— æ³•æ­£ç¡®æ’å…¥ï¼Œæ— æ³•æ­£ç¡®è¦†ç›–ã€‚\nè§£å†³æ–¹æ¡ˆï¼š åœ¨è¿›è¡Œdeleteæ“ä½œæ—¶è¿›è¡Œç‰¹åˆ¤ï¼Œå¦‚æœåŸæœ¬å­˜åœ¨å¯¹åº”çš„keyçš„è¯(å³å½“å‰äº‹åŠ¡è¿›è¡Œäº†ä¸€æ¬¡æ’å…¥æ“ä½œ)ï¼Œå°±åˆ é™¤åŸæœ¬çš„keyï¼Œé‡æ–°æ’å…¥ï¼Œä»¥è¾¾åˆ°è¦†ç›–çš„æ•ˆæœ\ninsertç”±äºå³ä¾¿insertç›¸åŒçš„record,ridä¹Ÿä¸ä¸€è‡´ï¼Œæ— éœ€å¤„ç†ã€‚ å…¶ä»–çš„äº‹åŠ¡è¿›è¡Œçš„æ’å…¥ä¸æ˜¯åŒä¸€ä¸ªset,ä¸ä¼šäº§ç”Ÿå½±å“ å½“å‰äº‹åŠ¡æ’å…¥çš„å…¶ä»–çš„è®°å½•ç”±äº rid ä¸ä¸€è‡´ï¼Œæ— éœ€å¤„ç† åƒåœ¾å›æ”¶é—®é¢˜ï¼š\nå¦‚æœåœ¨å½“å‰äº‹åŠ¡ä¸­åˆ é™¤å·²ç»æäº¤çš„äº‹åŠ¡å†™å…¥çš„è®°å½•ï¼Œä¸ä¼šå‡ºç°ä»»ä½•é—®é¢˜ï¼Œå› ä¸ºæ’å…¥æ“ä½œåœ¨è¿›è¡Œæäº¤æ—¶ä¼šå°†beginè®¾ç½®ä¸ºcommid_tidï¼Œä»è€Œæœ‰äº†æ­£ç¡®çš„ç‰ˆæœ¬ä¿¡æ¯ï¼Œä¹‹ådeleteæ—¶ï¼Œåªéœ€è¦ä¿®æ”¹end = tidå³å¯ï¼Œè€Œæ— è®ºè¿›è¡Œå›æ»šè¿˜æ˜¯æäº¤ï¼Œéƒ½å¯ä»¥ä¿è¯ä¸€ä¸ªæ­£ç¡®çš„çŠ¶æ€ï¼š\næäº¤ï¼šend = commid_tidï¼Œå¯ä»¥æ ¹æ®ç‰ˆæœ¬å»æ­£ç¡®è¯»å– å›æ»šï¼šend = MAXï¼Œæ¢å¤åˆ°åˆšå†™å…¥çš„çŠ¶æ€ å¦‚æœæ˜¯å½“å‰äº‹åŠ¡å†™å…¥åˆç”±å½“å‰äº‹åŠ¡æäº¤ï¼Œåˆ™å­˜åœ¨ä¸€å®šé—®é¢˜ï¼Œç”±äºåœ¨åŒä¸€ä¸ªäº‹åŠ¡å½“ä¸­ï¼ŒåŒä¸€æ¡è®°å½•åé¢ä¼šè¦†ç›–å‰é¢ï¼Œä»è€Œå¯¼è‡´å¦‚æœè¿›è¡Œå†™å…¥åˆåˆ é™¤çš„è¯ï¼Œbeginä¼šä¿ç•™-tidçš„çŠ¶æ€ï¼Œæ­¤æ—¶æ— è®ºè¿›è¡Œcommitè¿˜æ˜¯rollbackéƒ½åªä¼šæ‰§è¡Œdeleteçš„operationï¼Œä»è€Œè¯¥æ¡è®°å½•çš„beginä¼šä¸€ç›´ä¿æŒ-tidï¼Œç»™åƒåœ¾å›æ”¶å’Œæ­£ç¡®è¯»å–å¸¦æ¥å›°æ‰°ã€‚\nå¯ä»¥è€ƒè™‘ï¼š\nå¦‚æœæ˜¯æäº¤æ“ä½œï¼Œé‚£ä¹ˆå°±å°†begin = end = tidï¼Œæ„ä¹‰ä¸ºå½“å‰äº‹åŠ¡å†™å…¥åˆç”±å½“å‰äº‹åŠ¡åˆ é™¤ï¼Œä¸ä¼šå½±å“è¯»å– å¦‚æœæ˜¯å›æ»šæ“ä½œï¼Œé‚£ä¹ˆå°±è°ƒç”¨tableâ†’delete_recordè¿›è¡ŒçœŸæ­£çš„åˆ é™¤ï¼Œç”±äºè¯¥è®°å½•ä»æœªå¯¹å¤–æš´éœ²è¿‡ï¼Œå› æ­¤åˆ é™¤ä¸ä¼šå½±å“å…¶ä»–äº‹åŠ¡çš„è¯»å–ï¼Œå¹¶ä¸”åœ¨é€»è¾‘ä¸Šä¹Ÿç¬¦åˆå›æ»šçš„æ¦‚å¿µã€‚ ç¬¬äºŒç‰ˆçš„å®ç°æ–¹å¼æ¯”è¾ƒçš„å–å·§ï¼Œé’ˆå¯¹é—®é¢˜å‡ºç°çš„æºå¤´è¿›è¡Œä¿®å¤ï¼šå°±æ˜¯åœ¨trx.delete_recordåŠ ä¸ªç‰¹åˆ¤ï¼Œå¦‚æœæ˜¯è‡ªå·±å†™å…¥çš„è¿›è¡Œåˆ é™¤ï¼Œå°±ç›´æ¥è°ƒç”¨delete_record,å¹¶ä¸”ä¹Ÿä¸æ·»åŠ åˆ°operation_é‡Œé¢ï¼Œå¹¶ä¸”åˆ é™¤ä¹‹å‰çš„insertæ“ä½œçš„operationï¼Œç”±äºæ˜¯è‡ªå·±åˆ›å»ºçš„recordï¼Œå¹¶ä¸”åˆè¢«è‡ªå·±åˆ é™¤ï¼Œå› æ­¤å°±å½“ä½œå…¶ä»æ¥æ²¡æœ‰å­˜åœ¨è¿‡ã€‚\nåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ—¢ä¸å½±å“å›æ»šï¼Œä¹Ÿä¸å½±å“gcï¼Œæœ€ç»ˆå®ç°ä¹Ÿæ˜¯é‡‡ç”¨ç¬¬äºŒç§æ–¹å¼ å›åˆ°æ­£é¢˜ï¼Œupdate-mvccè¿™é¢˜å…¶å®æ˜¯ä¸æ€ä¹ˆéœ€è¦å®ç°çš„ï¼Œå¤§å¤šæ•°äººåœ¨å®Œæˆäº†uniqueä¹‹åï¼Œupdate-mvccæ˜¯å¯ä»¥ç›´æ¥é€šè¿‡çš„ï¼Œå› ä¸ºç›®å‰miniobå·²ç»ç»™å‡ºäº†mvccçš„insertå’Œdeleteå®ç°ï¼Œç»„åˆä¸€ä¸‹å³å¯ã€‚ä¸è¿‡ç”±äºæˆ‘ä»¬é˜Ÿunique indexå®ç°çš„æ˜¯ä¸€ä¸ªfakeç‰ˆæœ¬ï¼Œåœ¨mvccæ¨¡å¼ä¸‹å¹¶æ²¡æœ‰åŠæ³•æä¾›å”¯ä¸€æ€§ä¿è¯ï¼Œè€Œæˆ‘åˆä¸æƒ³å»é‡æ„ï¼Œå› æ­¤æˆ‘ä»¬é˜Ÿåˆ†äº†ä¸¤æ¡çº¿è¿›è¡Œï¼Œé˜Ÿå‹å»é‡æ„unique indexï¼Œæˆ‘ç‰¹åˆ¤è¡¨åç„¶åå®ç°ä¸€ä¸ªå†…å­˜å½“ä¸­çš„mvccç‰ˆçš„unique indexï¼Œå…¶å®å°±æ˜¯æŠŠvisit_recordå½“ä¸­çš„é€»è¾‘å¯¹ç€unique_indexå®ç°äº†ä¸€éï¼Œä¸è¿‡æœ€åæ˜¯æˆ‘å…ˆæå‡ºæ¥äº†hhhã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 RC Table::insert_record(Record \u0026amp;record) { int decode_index_num; if (table_meta_.name() == mvcc_table_name_) { int index_offset = table_meta_.sys_field_num() + table_meta_.null_field_num(); memcpy(\u0026amp;decode_index_num,record.data() + index_offset * 4,4); if (mvcc_unique_index_.contains(decode_index_num)) { if (is_duplicated(decode_index_num)) { return RC::INVALID_ARGUMENT; } } } else { // ... } } bool Table::is_duplicated(int index_num) { if (!mvcc_unique_index_.contains(index_num)) { return false; } auto current_index = mvcc_unique_index_[index_num]; int begin_tid = current_index.first; int end_tid = current_index.second; bool is_visible; bool is_conflict; if (begin_tid \u0026gt; 0 \u0026amp;\u0026amp; end_tid \u0026gt; 0) { if (trx_-\u0026gt;id() \u0026gt;= begin_tid \u0026amp;\u0026amp; trx_-\u0026gt;id() \u0026lt;= end_tid) { is_visible = true; } else { is_visible = false; } } else if (begin_tid \u0026lt; 0) { if (-begin_tid == trx_-\u0026gt;id() \u0026amp;\u0026amp; end_tid \u0026lt; 0) { is_visible = false; } else if (-begin_tid == trx_-\u0026gt;id()) { is_visible = true; } else { is_visible = false; } } else if (end_tid \u0026lt; 0) { // ç”±äºunique indexåªéœ€è¦ç®¡ç†æ’å…¥ï¼Œå› æ­¤ä¸å­˜åœ¨read_onlyçš„æƒ…å†µ if (-end_tid == trx_-\u0026gt;id()) { is_visible = false; } else { is_conflict = true; } } // æ­£åœ¨æœ‰å…¶ä»–çš„å°è¯•æ’å…¥ï¼Œç›´æ¥æ‹’ç» // å¦‚æœå­˜åœ¨ä¸€æ¡å…ˆå‰å¯è§çš„æ•°æ®ï¼Œä¹Ÿæ‹’ç»æ‰ if (is_conflict || is_visible) { return true; } return false; } åœ¨å®Œæˆäº†unique indexä¹‹åè¿˜å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯mvccæ¨¡å¼ä¸‹,updateæ—¶ï¼Œä¸‹å±‚çš„table_scanä¼šæŠŠæ–°å†™å…¥çš„recordåˆç»™è¯»å‡ºæ¥ï¼Œä»è€Œå¯¼è‡´åˆinsertä¸€éï¼Œå†åŠ ä¸Šæˆ‘æœ€å¼€å§‹visit_recordå½“ä¸­begin \u0026lt; 0 end \u0026lt; 0çš„bugæ²¡ä¿®ï¼Œä»è€Œå¯¼è‡´å…¶ä¼šé€ƒè¿‡uniqueçš„é™åˆ¶ï¼Œè¡¨ç°ç»“æœå°±æ˜¯ä¸€ä¸ªupdateæ›´æ–°äº†ä¸¤æ¬¡ã€‚ é—®é¢˜çš„æºå¤´æ˜¯table_scanä¼šè¯»å–åˆ°æ–°å†™å…¥çš„recordï¼Œä¸è¿‡å½“æ—¶æ²¡ä»”ç»†çœ‹åˆ°åº•ä¸ºä»€ä¹ˆï¼Œåªæ˜¯ä¿®äº†visit_recordå’Œåœ¨updateå½“ä¸­åŠ äº†ä¸€å±‚é™åˆ¶ï¼Œå³å¦‚æœåŸè®°å½•å’Œæ–°è®°å½•å®Œå…¨ä¸€è‡´çš„è¯ï¼Œå°±ä¸è¿›è¡Œæ›´æ–°ï¼Œè¿™æ ·å‹‰å¼ºç®—æ˜¯æŠŠçªŸçª¿ç»™å µä¸Šäº†ï¼Œæœ€åä¹Ÿæ˜¯é€šè¿‡äº†æµ‹è¯•ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 if (begin_xid == -trx_id_) { // fixï¼šæ­¤å¤„æ˜¯ä¸ºäº†ä¿®å¤ç”±å½“å‰äº‹åŠ¡æ’å…¥è€Œåˆè¢«å½“å‰äº‹åŠ¡åˆ é™¤æ—¶æ— æ³•æ­£ç¡®åˆ é™¤çš„é—®é¢˜ï¼š // åœ¨å½“å‰äº‹åŠ¡ä¸­åˆ›å»ºçš„è®°å½•ä»æ¥æœªå¯¹å¤–æš´éœ²è¿‡ï¼Œæœªæ¥æ–¹ä¾¿ä»Šåæ·»åŠ åƒåœ¾å›æ”¶åŠŸèƒ½ï¼Œè¿™é‡Œé€‰æ‹©ç›´æ¥åˆ é™¤çœŸå®è®°å½• // å°±è®¤ä¸ºè®°å½•ä»æ¥æœªå­˜åœ¨è¿‡ï¼Œæ­¤æ—¶æ— è®ºæ˜¯commitè¿˜æ˜¯rollbackéƒ½èƒ½å¾—åˆ°æ­£ç¡®çš„ç»“æœï¼Œå¹¶ä¸”éœ€è¦æ¸…ç©ºä¹‹å‰çš„insert operation,é¿å…äº‹åŠ¡ç»“æŸæ—¶æ‰§è¡Œ auto delete_operation = Operation{Operation::Type::INSERT, table, record.rid()}; std::unordered_set\u0026lt;Operation\u0026gt;::size_type delete_result = operations_.erase(delete_operation); ASSERT(delete_result == 1, \u0026#34;failed to delete insert operation,begin_xid=%d, end_xid=%d, tid=%d, rid:%s\u0026#34;, begin_xid, end_xid, trx_id_, record.rid().to_string().c_str()); rc = table-\u0026gt;delete_record(record); ASSERT(rc == RC::SUCCESS, \u0026#34;failed to delete record in table.table id =%d, rid=%s, begin_xid=%d, end_xid=%d, current trx id = %d\u0026#34;, table.-\u0026gt;table_id(), record.rid().to_string().c_str(), begin_xid, end_xid, trx_id_); return rc; } pair\u0026lt;OperationSet::iterator, bool\u0026gt; ret = operations_.insert(Operation(Operation::Type::DELETE, table, record.rid())); if (!ret.second) { LOG_WARN(\u0026#34;failed to insert operation(deletion) into operation set: duplicate\u0026#34;); return RC::INTERNAL; } ","permalink":"https://fischer0522.github.io/en/posts/tech/oceanbase%E5%88%9D%E8%B5%9B/","summary":"ç”±äºMiniobçš„æ•´ä½“æ¶æ„å¹¶æ²¡æœ‰åšå‡ºå¾ˆå¤§çš„å˜åŒ–ï¼Œå¹¶ä¸”ç›®å‰çŸ¥ä¹ä¸Šä¹Ÿå·²ç»æœ‰å…¶ä»–äººå†™çš„æ¶æ„åˆ†ææ–‡ç« ï¼Œæˆ‘åœ¨è¿™é‡Œå°±ä¸è¿‡å¤šä»‹ç»æ¶æ„ç›¸å…³çš„äº†ï¼Œåªè¯´ä¸€ä¸‹æˆ‘è‡ª","title":"OceanBaseåˆèµ›"},{"content":"SPFresh: Incremental In-Place Update for Billion-Scale Vector Search Introduction æœ¬æ–‡èšç„¦äºä¸¤ä¸ªæ–¹é¢ï¼Œä¸€ä¸ªæ˜¯é‡‡ç”¨in-place(å³åŸåœ°æ›´æ–°)çš„æ–¹å¼æ›´æ–°ç´¢å¼•ï¼Œè€Œå¦ä¸€ä¸ªåˆ™æ˜¯å¦‚ä½•ç»´æŠ¤é«˜è´¨é‡çš„ç´¢å¼•ã€‚å¯¹äºä¹‹å‰çš„ANNSç®—æ³•ï¼Œæ— è®ºæ˜¯åŸºäºå›¾çš„è¿˜æ˜¯åŸºäºç°‡(cluster)çš„ï¼Œé€šå¸¸é‡‡ç”¨çš„æ˜¯é‡å»ºç´¢å¼•çš„æ–¹å¼ï¼Œå³ç§¯ç´¯ä¸€æ®µæ—¶é—´çš„æ–°å‘é‡ï¼Œåˆ°è¾¾ä¸€å®šç¨‹åº¦åé‡æ–°æ„å»ºæ•´ä¸ªç´¢å¼•ã€‚ä½†è¿™æ ·å¸¦æ¥çš„é—®é¢˜å°±æ˜¯ä¼šæ¶ˆè€—å¤§é‡çš„èµ„æºï¼Œå¹¶ä¸”æ„å»ºç´¢å¼•çš„è¿‡ç¨‹ä¹Ÿä¼šç»™æŸ¥è¯¢å¸¦æ¥å»¶è¿Ÿã€‚\nè¿™ç§åŸåœ°æ›´æ–°æ˜¯æœ‰å¿…è¦çš„ï¼Œåœ¨ç›®å‰çš„åœºæ™¯ä¸‹ï¼ŒVDBMSä¼šæ¥æ”¶åˆ°å¤§é‡çš„å¢é‡ä¿¡æ¯ï¼Œè€Œå¦‚æœæ¯æ¬¡éƒ½é‡‡ç”¨é‡å»ºç´¢å¼•çš„æ–¹å¼å°±ä¼šå¸¦æ¥å¤§é‡çš„é¢å¤–å¼€é”€ã€‚\nç›®å‰æ— è®ºæ˜¯åŸºäºå›¾çš„ï¼Œè¿˜æ˜¯ç°‡çš„ï¼Œéƒ½ä¼šåœ¨å†…å­˜å½“ä¸­ç»´æŠ¤ä¸€ä¸ª\u0026quot;shortcut\u0026quot;ï¼Œå¯¹äºå›¾æ¥è¯´ï¼Œå¯ä»¥æ˜¯å‘é‡çš„é‡åŒ–å½¢å¼(DiskANN)ï¼Œè€Œå¯¹äºç°‡çš„å½¢å¼ï¼Œåˆ™ä½¿ç”¨çš„æ˜¯è´¨å¿ƒ(SPANN)ã€‚åœ¨è¿›è¡Œæœç´¢æ—¶é¦–å…ˆä½¿ç”¨ shortcut è¿›è¡Œåˆæ­¥æœç´¢ï¼Œä¹‹åå†å»è¿›è¡Œè¿›ä¸€æ­¥çš„æœç´¢ã€‚å› æ­¤ shortcut çš„è´¨é‡å°±ä¼šå†³å®šæœ€ç»ˆçš„æœç´¢ç»“æœï¼Œå¦‚æœ shortcut ä¸èƒ½å¤Ÿå¾ˆå¥½çš„ä»£è¡¨å¯¹åº”çš„è¯¦ç»†æ•°æ®ï¼Œå¦‚è´¨å¿ƒæ— æ³•æ­£ç¡®è¡¨ç¤º posting listï¼Œé‚£æœ€åçš„æœç´¢è´¨é‡å°±ä¼šä¸‹é™ï¼Œå³å‘ç”Ÿäº†æ•°æ®åˆ†å¸ƒå€¾æ–œã€‚\nåœ¨SPFreshå½“ä¸­ï¼Œæå‡ºäº†LIRE,a Lightweight Incremental RE-balancing protocolï¼Œå…¶æ ¸å¿ƒæ€æƒ³å°±æ˜¯åˆ©ç”¨å·²ç»å­˜åœ¨çš„æœ‰ç€è‰¯å¥½åˆ†åŒºç‰¹æ€§çš„ç´¢å¼•ã€‚å¯¹è¿™ç±»ç´¢å¼•çš„æ›´æ–°åªä¼šåœ¨å°èŒƒå›´å½±å“è‡ªå·±å’Œé‚»å±…ï¼Œå› æ­¤éœ€è¦åšçš„å°±æ˜¯å¹³è¡¡å¥½æ­¤æ¬¡æ›´æ–°æ¶‰åŠåˆ°çš„è¿™ä¸€ä¸ªå°èŒƒå›´ã€‚\nç›®å‰æœ‰ä¸‰ä¸ªæŒ‘æˆ˜ï¼š\nä¸ºäº†ä¿æŒè¾ƒçŸ­çš„æœç´¢å»¶è¿Ÿï¼ŒLIREéœ€è¦åŠæ—¶æ‹†åˆ†å’Œåˆå¹¶åˆ†åŒºæ¥ç»´æŒåˆ†åŒºçš„å‡åŒ€åˆ†å¸ƒ ä¸ºäº†ä¿æŒè¾ƒé«˜çš„æœç´¢ç²¾åº¦ï¼ŒLIRE éœ€è¦è¯†åˆ«å¯¼è‡´ç´¢å¼•ä¸­æ•°æ®ä¸å¹³è¡¡çš„æœ€å°å‘é‡é›†ã€‚åº”é‡æ–°åˆ†é…è¿™äº›å‘é‡ä»¥ä¿æŒé«˜ç´¢å¼•è´¨é‡ã€‚ LIRE çš„å®ç°åº”è¯¥æ˜¯è½»é‡çº§çš„ å¯¹åº”çš„è§£å†³æªæ–½ï¼š\nä¸»åŠ¨æ‹†åˆ†å’Œåˆå¹¶åˆ†åŒºæ¥ç»´æŒåˆ†åŒºå¤§å°çš„å‡åŒ€åˆ†å¸ƒ å®šä¹‰äº†ä¸¤ä¸ªåŸºæœ¬å‡†åˆ™æ¥ä¿è¯re-balanceä¹‹åçš„åˆ†åŒºä¸ä¼šè¿åNPA(rule of nearest neighbor posting assignment) é€šè¿‡å‰é¦ˆç®¡é“çš„å½¢å¼è¿›è¡Œè§£è€¦æˆä¸¤é˜¶æ®µï¼Œå°†reassignçš„è¿‡ç¨‹ä»æ›´æ–°çš„è·¯å¾„ä¸Šç§»èµ° ä½¿ç”¨åŸºäºSSDçš„user-spaceçš„å­˜å‚¨å¼•æ“æ¥ç»•è¿‡ä¼ ç»Ÿå­˜å‚¨å †æ ˆï¼Œä¼˜åŒ–å­˜å‚¨æ€§èƒ½ Background å‘é‡æœç´¢å’ŒANNSåœ¨å¾ˆå¤šåœ°æ–¹éƒ½å·²ç»æåŠäº†ï¼Œè¿™é‡Œå°±ä¸è¯¦ç»†æè¿°äº†ï¼Œè´´ä¸€å¼ å›¾ å‘é‡ç´¢å¼•ç»„ç»‡å½¢å¼\nè¿™é‡Œè®¨è®ºäº†ä¸¤ä¸ªæ¯”è¾ƒä¸»æµçš„ç´¢å¼•ç»„ç»‡å½¢å¼ï¼Œåˆ†åˆ«æ˜¯åŸºäºå›¾çš„(Fine-grained graph-based vector indices)å’ŒåŸºäºç°‡çš„(Coarse-grained cluster-based vector indices)ï¼Œåœ¨æ¶æ„ä¸Šéƒ½æ˜¯å†…å­˜-ç£ç›˜çš„æ··åˆæ¶æ„ã€‚\nFine-grained graph-based vector indices\nåŸºäºå›¾çš„ç»†ç²’åº¦å‘é‡ç´¢å¼•ï¼Œåœ¨ä¸€å¼ å›¾å½“ä¸­ï¼Œä½¿ç”¨é¡¶ç‚¹æ¥ä»£è¡¨å‘é‡ï¼Œä½¿ç”¨è¾¹æ¥è¡¨ç¤ºä¸¤ä¸ªå‘é‡çš„è·ç¦»ï¼Œå¦‚æœä¸¤ä¸ªå‘é‡è¶³å¤Ÿè¿‘çš„è¯ï¼Œå°±ä½¿ç”¨ä¸€æ¡è¾¹æ¥è¿æ¥ã€‚åœ¨è¿›è¡ŒKä¸´è¿‘æœç´¢æ—¶ï¼Œä½¿ç”¨è´ªå¿ƒç®—æ³•éå†å›¾ï¼Œä¼˜å…ˆæœç´¢è·ç¦»æœ€è¿‘çš„é‚»å±…ã€‚\néƒ¨åˆ†ç®—æ³•çš„å®ç°é€‰æ‹©å…¨éƒ¨åŸºäºå†…å­˜æ¥å®ç°ï¼Œè¿™æ ·åšçš„ä»£ä»·å°±æ˜¯ä¼šå¸¦æ¥å¤§é‡çš„å†…å­˜å¼€é”€ã€‚ä¸€å°éƒ¨åˆ†ç®—æ³•ä¼šé€‰æ‹©ä½¿ç”¨å†…å­˜-ç£ç›˜çš„æ··åˆæ¶æ„ï¼Œå¦‚DiskANNï¼ŒDiskANNé‡‡ç”¨çš„è§£å†³æ–¹æ¡ˆæ˜¯åœ¨å†…å­˜å½“ä¸­å­˜å‚¨ä½¿ç”¨PQé‡åŒ–å‹ç¼©ä¹‹åçš„é¡¶ç‚¹ï¼Œä»¥ä¾¿èŠ‚çœå†…å­˜å¼€é”€ï¼Œå¹¶ä¸”ç”¨äºä½œä¸ºä¸€çº§ç´¢å¼•æ¥åŠ é€ŸæŸ¥è¯¢ã€‚\nCoarse-grained cluster-based vector indices\nåŸºäºç°‡çš„ç²—ç²’åº¦å‘é‡ç´¢å¼•,å°†ç›¸è¿‘çš„å‘é‡ç®¡ç†åœ¨åŒä¸€ä¸ªç°‡å½“ä¸­ï¼ŒåŒä¸€ä¸ªç°‡å½“ä¸­çš„å‘é‡ä½¿ç”¨å…¨è¿æ¥å›¾ï¼Œè€Œä¸åŒç°‡ä¹‹é—´ä¸å­˜åœ¨è¾¹ã€‚\næ¯”è¾ƒæœ‰ä»£è¡¨æ€§çš„å°±æ˜¯SPANNï¼ŒSPANNåœ¨å†…å­˜å½“ä¸­å­˜å‚¨ç°‡çš„è´¨å¿ƒï¼Œå…ˆæœç´¢å‡ºKä¸´è¿‘çš„è´¨å¿ƒï¼Œä¹‹åå†å»æœç´¢è´¨å¿ƒå¯¹åº”çš„ç°‡ï¼Œæ‰¾åˆ°ç¬¦åˆè¦æ±‚çš„å‘é‡ã€‚ä»è€Œåœ¨å®ç°é«˜æœç´¢æ€§èƒ½çš„åŒæ—¶ï¼Œä¿è¯äº†è¾ƒä½çš„å†…å­˜å¼€é”€ã€‚\nç›¸æ¯”äºå±€éƒ¨æ•æ„Ÿæ€§å“ˆå¸Œå’Œkmeansï¼ŒSPANNåœ¨åˆ›å»ºç°‡æ—¶å¯¹ç°‡è¿›è¡Œäº†å¤§å°ä¸Šçš„å¹³è¡¡(åŸºäºåˆ†å±‚çš„å®ç°)ï¼Œå¹¶ä¸”é‡‡ç”¨çš„æ˜¯é‡å»ºç´¢å¼•çš„æ–¹å¼æ¥å®Œæˆæ›´æ–°(out-of-place)ï¼Œ(åœ¨ç›®å‰çš„æ”¹è¿›æ–¹æ¡ˆä¸­ï¼Œä¸éœ€è¦ä½¿ç”¨out-of-placeï¼Œä½†æ˜¯ä¸ºäº†é˜²æ­¢æ•°æ®å€¾æ–œçš„å‘ç”Ÿï¼Œä¾æ—§éœ€è¦å‘¨æœŸæ€§çš„é‡å»ºç´¢å¼•)ä»£ä»·å°±æ˜¯é‡å»ºç´¢å¼•çš„é«˜å¼€é”€ï¼ŒåŒ…æ‹¬æ—¶é—´å’Œç©ºé—´ï¼Œæ—¶é—´ä¸Šä¸å¿…å¤šè¯´ï¼Œç©ºé—´ä¸Šéœ€è¦åœ¨æ›´æ–°æœŸç»´æŠ¤ä¸€ä¸ªå‰¯ç´¢å¼•ï¼Œæœç´¢æ—¶éœ€è¦ä¸¤ä¸ªç´¢å¼•éƒ½è¿›è¡Œæœç´¢(å°±åƒredisçš„æ¸è¿›å¼rehashï¼Œç»´æŠ¤äº†ä¸¤ä¸ªå“ˆå¸Œè¡¨ï¼Œæœç´¢æ—¶æ£€æµ‹ä¸¤ä¸ªå“ˆå¸Œè¡¨) ä½†æ˜¯å¦‚æœç›´æ¥ä½¿ç”¨in-placedçš„æ›´æ–°æ–¹æ³•ï¼Œç›´æ¥åœ¨æŸä¸ªç°‡å†…è¿½åŠ å‘é‡ï¼Œé‚£ä¹ˆå°±å¿…ç„¶ä¼šå¯¼è‡´æœ€åçš„æ•°æ®åˆ†åŒºå€¾æ–œçš„é—®é¢˜ï¼Œè¿™ä¹Ÿæ˜¯in-placeæ›´æ–°æ–¹å¼æœ€å…ˆéœ€è¦è§£å†³çš„ã€‚\nè®¾è®¡ç›®æ ‡\nåœ¨ç»´æŠ¤å¤§è§„æ¨¡ç´¢å¼•æ—¶ä¿è¯ä½èµ„æºå¼€é”€ æœç´¢å’Œæ›´æ–°éƒ½å®ç°é«˜ååé‡å’Œä½å»¶è¿Ÿ æ–°å‘é‡å¯ä»¥é«˜æ¦‚ç‡è¢«æ£€ç´¢åˆ°ã€‚ ä¸ºæ­¤ï¼Œè®¾è®¡äº†SPFreshï¼Œåœ¨ç´¢å¼•æ•°æ®ç»“æ„ä¸­è¿›è¡ŒåŸåœ°ã€å¢é‡å¼çš„æ›´æ–°ï¼Œä»¥é€‚åº”æ•°æ®åˆ†å¸ƒçš„åç§»\nLIRE Protocol Design LIREåŸºäº SPANNï¼ŒSPANNçš„ç›¸å…³å†…å®¹å¦‚ä¸‹[[SPANN]]\nLIRE: Lightweight Incremental RE-balancing èƒ½å¤Ÿå½¢æˆè‰¯å¥½åˆ†åŒºçš„å…³é”®æ—¶éµå¾ªnearest partition assignment(NPA)ï¼šæ¯ä¸ªå‘é‡åº”è¯¥æ”¾å…¥æœ€è¿‘çš„posting listä¸­ï¼Œä»¥ä¾¿å¯¹åº”çš„è´¨å¿ƒèƒ½å¤Ÿå¾ˆå¥½è¡¨ç¤ºè¯¥ç°‡å½“ä¸­æ‰€æœ‰çš„å‘é‡ã€‚å¦‚ä¸‹å›¾ï¼ŒAåœ¨è¾¾åˆ°ä¸€å®šå¤§å°ä¹‹åéœ€è¦åˆ†è£‚ï¼Œé»„è‰²çš„å‘é‡è·ç¦»æœ€è¿‘çš„è´¨å¿ƒæ˜¯Bï¼Œè€ŒBä¸­ç»¿è‰²çš„å‘é‡è·ç¦»æœ€è¿‘çš„æ˜¯A2.å› æ­¤å°±ä¸èƒ½ç®€å•çš„å°†Aæ‹†åˆ†ä¸ºä¸¤ä¸ªåˆ†åŒºï¼Œè€Œæ˜¯åº”è¯¥è§†ä¸ºå¯¹Aä»¥åŠå‘¨è¾¹ç°‡ä¸­æ‰€æœ‰å‘é‡çš„é‡æ–°åˆ†é…ã€‚ ä¸ºäº†ä¿è¯ä¸è¿åNPAåŸåˆ™ï¼ŒLIREå®šä¹‰äº†äº”ç§åŸºæœ¬æ“ä½œï¼šInsert,Delete,Merge,Split,Reassign\nInsert \u0026amp; Delete\nInsertéµå¾ªåŸæœ¬çš„SPANNçš„è®¾è®¡ï¼Œç›´æ¥å°†vectoræ’å…¥åˆ°å¯¹åº”çš„ç°‡å½“ä¸­ï¼Œåˆ é™¤çš„è¯å¯ä»¥ä¿è¯è¯¥å‘é‡ä¹‹åéƒ½å¯¹ç”¨æˆ·ä¸å¯è§ï¼Œä½†æ²¡å¿…è¦çœŸæ­£åˆ é™¤æ‰ï¼Œä½¿ç”¨ä¸€ä¸ªğŸª¦æ ‡è®°ä¸€ä¸‹å³å¯ï¼Œç­‰åˆ°åç»­å†å»¶è¿Ÿåˆ é™¤ã€‚ Insertå’ŒDeleteæ˜¯å¤–éƒ¨æ¥å£ï¼Œå…¶ä»–ä½œä¸ºå†…éƒ¨å€Ÿå£ç”±insert deleteè§¦å‘è°ƒç”¨\nSplit\nå½“posting listçš„é•¿åº¦è¶…å‡ºé™åˆ¶ï¼Œå°±å°†å…¶åˆ†å‰²æˆä¸¤ä¸ªè¾ƒå°çš„éƒ¨åˆ†ï¼Œè¿™ä¸€æ­¥ä¼šå¯¼è‡´è¿åNPAï¼Œå› æ­¤éœ€è¦reassignæ“ä½œã€‚åœ¨æœ€åˆä¼šé¦–å…ˆæ¸…é™¤å½“ä¸­å·²ç»è¢«åˆ é™¤çš„å‘é‡ï¼Œè€Œå¦‚æœæ­¤æ—¶é•¿åº¦è¿˜æ˜¯è¶…å‡ºé˜ˆå€¼ï¼Œåˆ™è¿›è¡Œsplitã€‚\nMerge\nå½“posting listè¿‡å°æ—¶ï¼Œå°±éœ€è¦å¯¹å…¶è¿›è¡Œåˆå¹¶ï¼Œåˆå¹¶çš„å®é™…è¿‡ç¨‹æ˜¯åˆ é™¤å½“å‰çš„posting listå’Œå¯¹åº”çš„è´¨å¿ƒï¼Œå°†æ‰€æœ‰çš„å‘é‡æ·»åŠ åˆ°å‘¨å›´ä¸´è¿‘çš„posting listå½“ä¸­ã€‚è¿™ä¸€æ­¥åŒæ ·æœ‰å¯èƒ½è¿åNPAï¼Œå› æ­¤ä¹Ÿéœ€è¦è¿›è¡Œreassign\nReassign\né‡åˆ†é…çš„è¿‡ç¨‹æ¶‰åŠåˆ°æ“ä½œç£ç›˜ä¸Šçš„posting listï¼Œæ‰€ä»¥åº”å½“å°½å¯èƒ½çš„ç¼©å°æ¶‰åŠçš„èŒƒå›´ã€‚å¯¹äºmergeæ“ä½œï¼Œåªéœ€è¦å¯¹äºè¢«åˆ é™¤ä¸­å¿ƒå¯¹åº”çš„å‘é‡å³å¯ã€‚ä½†æ˜¯ç”±äºsplitåˆ›å»ºäº†ä¸¤ä¸ªæ–°çš„è´¨å¿ƒï¼Œå› æ­¤å°±å¤æ‚çš„å¤šï¼Œä¸ºäº†ä¸è¿åNPAåŸåˆ™ï¼Œå®šä¹‰äº†ä¸¤ä¸ªå¿…è¦æ¡ä»¶(å‡å®šè·ç¦»ä½¿ç”¨æ¬§å‡ é‡Œå¾—è·ç¦»è¿›è¡Œè®¨è®º),å¦‚æœæ»¡è¶³å…¶ä¸­ä¹‹ä¸€ï¼Œåˆ™éœ€è¦è€ƒè™‘è¿›è¡Œé‡åˆ†é…ï¼š\n$$D(v,A_o)\\le D(v,A_i) ,\\forall i\\in 1,2$$Dä¸ºè·ç¦»å‡½æ•°ï¼Œ$A_o$ä»£è¡¨æ—§çš„è¢«åˆ†å‰²çš„è´¨å¿ƒï¼Œ$A_i$ä¸ºæ–°åˆ›å»ºçš„è´¨å¿ƒï¼Œè¿™ä¸€æ¡æ„å‘³ç€å¦‚æœåŸæœ¬çš„è´¨å¿ƒä¸ºç¦»å‘é‡væœ€è¿‘çš„è´¨å¿ƒï¼Œå¹¶ä¸ä»£è¡¨æ–°åˆ›å»ºçš„ä¸¤ä¸ªè´¨å¿ƒä¸ºç¦»væœ€è¿‘çš„è´¨å¿ƒï¼Œå‘¨å›´å¯èƒ½å­˜åœ¨æ›´è¿‘çš„è´¨å¿ƒï¼Œæ ·ä¾‹å³ä¸ºä¸Šå›¾ã€‚ç›¸åçš„ï¼Œå¦‚æœæ–°å»ºçš„è´¨å¿ƒè·ç¦»æ›´çŸ­ï¼Œé‚£ä¹ˆå°±æ— éœ€æ‹…å¿ƒ(ä¸ç­‰æ¡ä»¶ä¼ é€’ï¼Œ$D(v,A_i)\\le D(v,A_0)) \\le D(v,B)$ $$D(v,Ai) \\le D(v,A_o) , \\exists i \\in 1,2$$è¿™ç§æƒ…å†µä¸‹,å¯¹äºBè€Œè¨€éœ€è¦è€ƒè™‘å¯¹å…¶ä¸­çš„å…ƒç´ è¿›è¡Œé‡åˆ†é…ï¼Œé“ç†åŒæ ·æ˜¯ä¸ç­‰æ¡ä»¶ä¼ é€’ï¼Œå¯èƒ½è¯ç”Ÿæ–°çš„æ›´è¿‘è´¨å¿ƒã€‚ ç”±äºéœ€è¦å¯¹åˆ†è£‚å’Œå‘¨è¾¹çš„postling listçš„æ‰€æœ‰å‘é‡è¿›è¡Œæ£€æµ‹ï¼Œå¼€é”€æ˜¯å·¨å¤§çš„ï¼Œä¸ºäº†æœ€å°åŒ–å¼€é”€ï¼ŒLIRE ä»…é€šè¿‡é€‰æ‹©å‡ ä¸ª $A_o$ çš„æœ€è¿‘çš„postling listæ¥æ£€æŸ¥é™„è¿‘çš„postling listè¿›è¡Œé‡æ–°åˆ†é…æ£€æŸ¥ï¼Œåœ¨æ­¤åŸºç¡€ä¸Šåº”ç”¨ä¸¤ä¸ªæ¡ä»¶æ£€æŸ¥æ¥ç”Ÿæˆæœ€ç»ˆçš„é‡æ–°åˆ†é…é›†ã€‚ç¬¬ 5 èŠ‚ä¸­çš„å®éªŒè¡¨æ˜ï¼Œåªéœ€å°‘é‡é™„è¿‘çš„postling listè¿›è¡Œä¸¤ä¸ªå¿…è¦çš„æ¡ä»¶æ£€æŸ¥å°±è¶³ä»¥ç»´æŒç´¢å¼•è´¨é‡ã€‚ Split-Reassign Convergence åœ¨è¿™ä¸€éƒ¨åˆ†è¿›è¡Œè¯æ˜ï¼šè™½ç„¶åˆå¹¶å’Œåˆ†å‰²çš„è¿‡ç¨‹ä¼šå‡ºç°çº§è”ç°è±¡ï¼Œä½†æ˜¯æœ€ç»ˆä¼šæ”¶æ•›åˆ°ä¸€ä¸ªç¨³å®šçš„çŠ¶æ€ã€‚\né¦–å…ˆmergeæ“ä½œåœ¨åˆ°è¾¾æœ€ä½é˜ˆå€¼ä¹‹åå°±ä¼šåœæ­¢ï¼Œæ˜¾è€Œæ˜“è§ã€‚\nå¯¹äºinsertæ“ä½œï¼Œå‡è®¾insertä¼šå¼•å‘ä¸€ç³»åˆ—çš„æ›´æ”¹ï¼Œè®°ä¸º$C_i,C_{i+1},\u0026hellip;,C_{i + N}$,è¯æ˜æ”¶æ•›æ€§å°±æ˜¯è¯æ˜Næ˜¯ä¸€ä¸ªæœ‰é™æ•°ã€‚å¯¹äºé›†åˆCè€Œè¨€ï¼Œæœ‰ä»¥ä¸‹çš„ç‰¹ç‚¹ï¼š\n$|C| \\le |V|$,Vä»£è¡¨æ•´ä¸ªæ•°æ®é›†ï¼ŒCä¸ºè´¨å¿ƒé›†åˆï¼Œæ˜¾è€Œæ˜“è§cçš„æ•°é‡ å°äºç­‰äºvçš„æ•°é‡ $|C_{i+1}| = |C_i| + 1$: æ¯æ¬¡åˆ†è£‚éƒ½ä¼šåˆ é™¤ä¸€ä¸ªæ—§çš„é›†åˆï¼Œç”Ÿæˆä¸¤ä¸ªæ–°çš„é›†åˆï¼Œå› æ­¤æ¯æ¬¡åˆ†è£‚å°±æ˜¯å¤šå¤„ä¸€ä¸ªé›†åˆ åŸºäºå±æ€§äºŒé€’æ¨æœ‰ï¼š$|C_{i + N}| = |C_i| = N$ï¼Œæ ¹æ®å±æ€§ä¸€ï¼Œæ‰€ä»¥æœ‰$N \\le V - |C_i|$ï¼Œå› æ­¤ï¼Œæ—¢ç„¶Væ˜¯ä¸€ä¸ªæœ‰é™æ•°ï¼Œé‚£ä¹ˆNåŒæ ·æ˜¯ä¸ªæœ‰é™æ•°ã€‚\nSPFresh Design and Implementation Overall Architecture æ•´ä½“æ¶æ„å¦‚å›¾ï¼šåˆ†åˆ«æœ‰ä¸€ä¸ªè½»é‡çš„in-place updaterï¼Œä¸€ä¸ªä½å¼€é”€çš„Local Rebuilderå’Œä¸€ä¸ªå¿«é€Ÿå­˜å‚¨çš„Block Controller Updater\nå°†æ–°çš„å‘é‡æ·»åŠ åˆ°å¯¹åº”çš„posting listçš„åé¢ï¼Œå¹¶ä¸”ç»´æŠ¤ä¸€ä¸ªmapæ¥è®°å½•è¢«åˆ é™¤çš„å‘é‡ï¼Œå³å¢“ç¢‘æœºåˆ¶ï¼Œè¿˜ç”¨äºè¿½è¸ªæ¯ä¸ªå‘é‡çš„å‰¯æœ¬ã€‚é€šè¿‡å¢åŠ ç‰ˆæœ¬å·ï¼Œå®ƒå°†æ—§å‰¯æœ¬æ ‡è®°ä¸ºå·²åˆ é™¤ã€‚\nå¦‚æœå†…å­˜ä¸­çš„ç‰ˆæœ¬å·å¤§äºç£ç›˜ä¸Šçš„ç‰ˆæœ¬å·ï¼Œåˆ™å‘é‡å·²è¿‡æ—¶ï¼Œå¯å€Ÿæ­¤è¿›è¡ŒGCï¼Œä½¿ç”¨ç‰ˆæœ¬å·å¯ä»¥æ¨è¿Ÿå’Œæ‰¹é‡è¿›è¡ŒGCï¼Œä»è€Œæ§åˆ¶å‘é‡æ¸…é™¤çš„I/Oå¼€é”€ã€‚å®é™…æ•°æ®çš„åˆ é™¤æ˜¯åœ¨local rebuilderéƒ¨åˆ†å¼‚æ­¥è¿›è¡Œçš„ã€‚ å‘é‡æ’å…¥å®Œæˆåï¼Œæ›´æ–°ç¨‹åºä¼šæ£€æŸ¥posting listçš„é•¿åº¦ï¼Œå¦‚æœé•¿åº¦è¶…è¿‡åˆ†å‰²é™åˆ¶ï¼Œåˆ™å°†åˆ†å‰²ä½œä¸šå‘é€åˆ°local rebuilder\nLocal Rebuilder\nåœ¨å…¶ä¸­ç»´æŠ¤äº†ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ï¼Œå½“ä¸­å­˜å‚¨split merge reassignä»»åŠ¡ï¼Œç„¶ååˆ†å‘ä»»åŠ¡ç»™å¤šä¸ªåçº¿ç¨‹å»æ‰§è¡Œã€‚\nsplitç”±updaterè§¦å‘ï¼Œå½“å‘ç°é•¿åº¦è¶…è¿‡é˜ˆå€¼æ—¶ï¼Œå¹¶ä¸”ä¼šæ ¹æ®vector mapå»åˆ é™¤å·²ç»åˆ é™¤çš„å‘é‡ã€‚ merge ç”±Searherè§¦å‘ï¼Œå½“å‘ç°é•¿åº¦å°äºæœ€ä½é˜ˆå€¼æ—¶ reassignç”±splitå’Œmergeè§¦å‘ å½“mergeå’Œsplitå®Œæˆä¹‹åï¼ŒSPFreshå°±ä¼šå»æ›´æ–°å†…å­˜å½“ä¸­çš„SPTAG index Block Controller\nå­˜å‚¨posting listï¼Œæä¾›è¯»å†™æœåŠ¡ï¼Œä½¿ç”¨SPDKæ¥æä¾›ä¸€ç§ç›´æ¥æ“ä½œSSD blockçš„æ¥å£ï¼Œæ¥é¿å…ä½¿ç”¨ä¸€äº›å­˜å‚¨å¼•æ“å¯¼è‡´çš„è¯»/å†™æ”¾å¤§\nLocal Rebuilder Design è®¾è®¡local rebuilderçš„ç›®çš„å°±æ˜¯ä¸ºäº†å°†mergeï¼Œsplitï¼Œreassignç­‰æ“ä½œä»updaterçš„æ‰§è¡Œæµç¨‹å½“ä¸­ç§»é™¤ï¼Œé¿å…ä¸å¿…è¦çš„é˜»å¡ï¼Œç›®å‰updateåˆ†æˆäº†ä¸¤éƒ¨åˆ†ï¼Œå‰ç«¯çš„Updaterå’Œåç«¯çš„Local Rebuilderã€‚\nå¹³è¡¡ç®—æ³•ï¼šsplitè¿‡ç¨‹å½“ä¸­ï¼ŒLocal Rebuilder åˆ©ç”¨SPANNå½“ä¸­æå‡ºçš„ä¸­çš„å¤šçº¦æŸå¹³è¡¡èšç±»ç®—æ³•æ¥ç”Ÿæˆé«˜è´¨é‡çš„è´¨å¿ƒå’Œå¹³è¡¡çš„posting list(SPANNå½“ä¸­è®¤ä¸ºè¿™ä¸ªç®—æ³•åœ¨Nè¿‡å¤§çš„æƒ…å†µä¸‹æ•ˆæœä¸å¥½ï¼Œä½¿ç”¨çš„æ˜¯åˆ†å±‚å¹³è¡¡ï¼Œç”±äºåªæ˜¯åˆ†æˆä¸¤ä¸ªï¼Œä¸å­˜åœ¨SPANNå½“ä¸­é¢ä¸´çš„Nè¿‡å¤§çš„é—®é¢˜ï¼Œæ²¡å¿…è¦ä½¿ç”¨åˆ†å±‚)ã€‚\nvector map\nå‰æ–‡å½“ä¸­æåˆ°äº†ä½¿ç”¨ä¸€ä¸ªvector mapæ¥è®°å½•ç‰ˆæœ¬ä¿¡æ¯ï¼Œè¿™é‡Œè¯¦ç»†è¯´ä¸€ä¸‹ã€‚\né¦–å…ˆï¼Œåœ¨SPANNå½“ä¸­æŒ‡å‡ºï¼Œä¸ºäº†æå‡å¬å›ç‡ï¼Œå¯¹äºè¾¹ç•Œä¸Šçš„å‘é‡ä¼šå­˜å‚¨å¤šä¸ªå¤‡ä»½åœ¨ä¸åŒçš„postling list(A,B,C)å½“ä¸­ã€‚ä½†æ˜¯åœ¨reassignçš„æ—¶å€™ï¼Œç”±äºSPFreshå¸Œæœ›å‡å°‘reassignè¿‡ç¨‹çš„å¼€é”€ï¼Œä¸ä¼šå¤„ç†æ‰€ä»¥çš„é‚»å±…ï¼Œä¾‹å¦‚ï¼Œåœ¨Aå½“ä¸­åˆ é™¤æŸä¸ªç´¢å¼•ï¼Œè§¦å‘äº†mergeï¼ŒæŒ‡æ³¢åŠåˆ°äº†A B Dï¼Œé‚£ä¹ˆCå½“ä¸­çš„å‰¯æœ¬åº”è¯¥è¢«åˆ é™¤ä½†æ˜¯æ²¡åˆ é™¤ï¼Œåç»­æœ‰å¯èƒ½åœ¨æ‰¾åˆ°è´¨å¿ƒCæ—¶åˆè¯»å–åˆ°è¿™ä¸ªå‘é‡ã€‚\nå› æ­¤ï¼Œè¿™è¿™é‡Œå¼•å…¥äº†ç‰ˆæœ¬æ§åˆ¶ï¼Œä¸€æ–¹é¢æ˜¯ä¸ºäº†GCï¼Œå³çœŸæ­£åˆ é™¤çš„å¯ä»¥é€šè¿‡mapæ‰¾åˆ°å¹¶æ¸…é™¤ï¼Œå¦ä¸€æ–¹é¢å°±æ˜¯ä¸ºäº†å¤„ç†è¿™ç§æ¼ç½‘ä¹‹é±¼ï¼šreassignå‘é‡æ—¶ï¼Œæˆ‘ä»¬ä¼šåœ¨ç‰ˆæœ¬æ˜ å°„ä¸­å¢åŠ å…¶ç‰ˆæœ¬å·ï¼Œå¹¶å°†åŸå§‹å‘é‡æ•°æ®åŠå…¶æ–°ç‰ˆæœ¬å·é™„åŠ åˆ°ç›®æ ‡posting listä¸­\nConcurrent Rebuild è¯»å–postling listä¸éœ€è¦é”ã€‚å› æ­¤ï¼Œè¯†åˆ«ç”¨äºreassignçš„å‘é‡æ˜¯æ— é”çš„ï¼Œå› ä¸ºå®ƒä»…æœç´¢ç´¢å¼•å¹¶æ£€æŸ¥ä¸¤ä¸ªå¿…è¦æ¡ä»¶ åœ¨è¿›è¡Œreassignçš„è¿‡ç¨‹å½“ä¸­ï¼Œæ˜¯æœ‰å¯èƒ½å‡ºç°å°†å‘é‡æ·»åŠ åˆ°ä¸€ä¸ªè¢«åˆ é™¤çš„postling listå½“ä¸­ï¼Œæ­¤æ—¶ç»ˆæ­¢æ‰ressignå¹¶å¯¹è¯¥å‘é‡é‡æ–°æ‰§è¡Œã€‚åœ¨æˆ‘ä»¬çš„å®éªŒä¸­ï¼Œåªæœ‰ä¸åˆ° 0.001% çš„æ’å…¥è¯·æ±‚é‡åˆ°äº†æ‹†åˆ†å¯¼è‡´çš„postingç¼ºå¤±é—®é¢˜ã€‚å› æ­¤ï¼Œä¸­æ­¢å’Œé‡æ–°æ‰§è¡Œçš„å¼€é”€å¾ˆå°ã€‚ åœ¨reassignè¿‡ç¨‹å½“ä¸­ï¼Œé€šè¿‡å¯¹ç‰ˆæœ¬å·ä½¿ç”¨CASåŸè¯­æ¥ä¿è¯å¹¶å‘å®‰å…¨ï¼Œå¦‚æœå¤±è´¥åŒæ ·æ˜¯æ”¾å¼ƒå¹¶é‡æ–°æ‰§è¡Œ Block Controller Design Block ControlleråŸºäºSPDKå®ç°ï¼Œæœ€å¤§çš„ç‰¹ç‚¹æ˜¯ç›´æ¥æ“ä½œSSD çš„blockï¼Œè€Œä¸æ˜¯ä½¿ç”¨å¦‚LSM-Treeç­‰å­˜å‚¨å¼•æ“ï¼Œé¿å…æ— æ„ä¹‰çš„å¼€é”€\nå­˜å‚¨æ•°æ®å¸ƒå±€\nå¦‚ä¸‹å›¾ï¼Œç”±ä¸‰éƒ¨åˆ†ç»„æˆ Block Mappingã€Free Block Poolã€Concurrent I/O Request Queueã€‚ Block Mappingå­˜å‚¨ä¸€ä¸ªposting IDå’ŒSSD block metadataçš„ä¸€ä¸ªæ˜ å°„ï¼ŒåŒ…å«åç§»é‡å’Œé•¿åº¦ã€‚\npostingé‡‡ç”¨çš„æ˜¯ä¸€ç»„tupleçš„å½¢å¼è¿›è¡Œç»„ç»‡ï¼Œå½¢å¼ä¸º\u0026lt;vector id, version number, raw vector\u0026gt;,å¤§è‡´ä¼šå ç”¨3-4ä¸ªblock\nConcurrent I/O Request Queue ä½¿ç”¨ SPDKçš„å¾ªç¯bufferå®ç°çš„ï¼Œå‘é€å¼‚æ­¥çš„è¯»å†™è¯·æ±‚æ¥è¾¾åˆ°é«˜ååå’Œä½å»¶è¿Ÿã€‚\nå¯¹äºpostingçš„æ“ä½œæä¾›äº† GET ParallelGET APPEND PUTå››ä¸ªæ¥å£ã€‚ è¿™é‡Œè¯´ä¸€è¯´APPENDï¼ŒAPPENDé‡‡ç”¨çš„æ˜¯è¿½åŠ å†™çš„æ–¹å¼ï¼Œåªä¼šæ“ä½œæ¶‰åŠåˆ°çš„æœ€åä¸€ä¸ªblockï¼Œä»¥æ­¤å‡å°‘è¯»/å†™æ”¾å¤§çš„é—®é¢˜ã€‚ APPENDé¦–å…ˆåˆ†é…ä¸€ä¸ªæ–°çš„blockï¼Œå¦‚æœpostingå½“ä¸­æœ€åä¸€ä¸ªblockä¸ä¸ºç©ºå°±å…ˆè¯»è¿›æ¥ï¼Œç„¶åå°†æ–°çš„å‘é‡æ·»åŠ åˆ°æœ«å°¾ï¼Œä¹‹åå†™å›åˆ°ç£ç›˜ä¸Šï¼Œé¡ºå¸¦æ›´æ–°å†…å­˜å½“ä¸­çš„æ˜ å°„å…³ç³» Crash Recovery è¿™é‡Œä½¿ç”¨çš„æ˜¯snapshot + WALçš„å½¢å¼ï¼Œå¿«ç…§åŒ…å«è´¨å¿ƒç´¢å¼•ï¼Œupdaterå½“ä¸­çš„version mapï¼ŒBlock Controllerå½“ä¸­çš„block mapping å’Œblock poolã€‚\nEvaluation è¿™é‡Œç®€å•è¯´ä¸€ä¸‹å®ç°çš„æ€è·¯å’ŒéªŒè¯çš„ç›®æ ‡ã€‚\næ¨¡æ‹Ÿæ¯å¤©å¤§çº¦ 1% çš„æ•°æ®åˆ é™¤å’Œæ’å…¥ï¼Œç”±äºå„ç±»ç®—æ³•çš„ä¸åŒï¼ŒæŠŠæ›´æ–°æ“ä½œéœ€è¦æ»¡è¶³çš„ QPS ä½œä¸ºæŒ‡æ ‡ï¼Œæä¾›ä¸åŒçº¿ç¨‹æ•°åšåå°ä»»åŠ¡ï¼Œå¦‚merge split rebuild indexç­‰ï¼Œç„¶åæä¾›ç›¸åŒçš„çº¿ç¨‹æ•°æ¥åšæŸ¥è¯¢ï¼Œæ¯”è¾ƒæŸ¥è¯¢çš„ QPS ä»¥åŠ recallï¼Œå†…å­˜å ç”¨ç­‰ï¼Œç»“æœå¦‚ä¸‹ã€‚ è¿™é‡ŒèŠ±äº†ä¸€éƒ¨åˆ†é˜è¿°æŸ¥è¯¢å°¾å»¶å’Œå‡†ç¡®æ€§çš„é—®é¢˜ï¼ŒSPFreshåŸºäºSPANNï¼Œåœ¨SPANNå½“ä¸­ï¼Œä¸€æ®µæ—¶é—´çš„å†™å…¥ä¼šå¯¼è‡´æ•°æ®åˆ†åŒºå€¾æ–œçš„é—®é¢˜ï¼Œå› æ­¤æ— è®ºæ˜¯P99.9çš„å°¾å»¶ï¼Œè¿˜æ˜¯å‡†ç¡®ç‡ï¼Œåœ¨ä¸€æ®µæ—¶é—´åä¸SPFreshä¹‹é—´å‡ºç°äº†çš„å·®è·ã€‚ å¦å¤–ä¸€ä¸ªå°±æ˜¯éªŒè¯äº†åœ¨ä¸åŒçš„æ›´æ–°ç­–ç•¥ä¸‹ï¼Œå¬å›ç‡å’Œå»¶è¿Ÿä¹‹é—´çš„ä¸€ä¸ªtrade-off,è€Œè¿™ä¸€éƒ¨åˆ†å‡ºç°ä¸åŒçš„æ€§èƒ½è¡¨ç°åŒæ ·æ˜¯å› ä¸ºæ•°æ®åˆ†åŒºå€¾æ–œ Reassign Range\nåœ¨æ–‡ç« çš„å‰åŠéƒ¨åˆ†è¯´æ˜äº†ä¸ºäº†é˜²æ­¢åœ¨reassignçš„è¿‡ç¨‹å½“ä¸­é€ æˆè¿‡å¤§çš„å¼€é”€ï¼Œä¼šé™åˆ¶å‚ä¸reassignçš„é‚»å±…æ•°é‡ï¼Œåœ¨å®éªŒéƒ¨åˆ†ä¹Ÿç»™å‡ºäº†å‚æ•°é€‰æ‹©çš„ä¾æ®ï¼Œå¯ä»¥çœ‹åˆ°åœ¨64åˆ°128æ—¶ï¼Œæ€§èƒ½æå‡å¾®ä¹å…¶å¾®ï¼Œå› æ­¤æœ€ç»ˆé€‰æ‹©64ä½œä¸ºå‚æ•°(ä¸è¿‡æ„Ÿè§‰64ä¹ŸæŒºå¤§çš„)\n","permalink":"https://fischer0522.github.io/en/posts/tech/spfresh/","summary":"SPFresh: Incremental In-Place Update for Billion-Scale Vector Search Introduction æœ¬æ–‡èšç„¦äºä¸¤ä¸ªæ–¹é¢ï¼Œä¸€ä¸ªæ˜¯é‡‡ç”¨in-place(å³åŸåœ°æ›´æ–°)çš„æ–¹å¼æ›´æ–°ç´¢å¼•ï¼Œè€Œå¦ä¸€ä¸ªåˆ™æ˜¯å¦‚ä½•ç»´æŠ¤é«˜è´¨é‡çš„ç´¢å¼•ã€‚å¯¹äºä¹‹å‰çš„A","title":"SPFresh: Incremental In-Place Update for Billion-Scale Vector Search"},{"content":"Manu: A Cloud Native Vector Database Management System Introduction Manuæˆ–è€…å…¶å‰èº«Milvusï¼Œå®šä½ç›®æ ‡æ˜¯äº‘åŸç”Ÿçš„å‘é‡æ•°æ®åº“ï¼Œéœ€è¦æä¾›åŸºç¡€çš„å‘é‡å­˜å‚¨å’Œæ£€ç´¢æœåŠ¡ï¼ŒåŒæ—¶ï¼Œç›¸æ¯”ä¼ ç»Ÿçš„äº‘åŸç”ŸDBMSï¼Œä¸»è¦æœ‰ä»¥ä¸‹çš„ç‰¹ç‚¹ï¼š\næ— éœ€æ”¯æŒå¤æ‚çš„äº‹åŠ¡ï¼šä¼ ç»ŸDBMSé€šå¸¸éœ€è¦æ”¯æŒå¤šè¡¨ï¼Œå¤šè¡Œçš„å¤æ‚äº‹åŠ¡å¤„ç†é€»è¾‘ï¼Œä½†æ˜¯è¿™åœ¨VDBMSå½“ä¸­æ˜¯æ²¡æœ‰å¿…è¦çš„ï¼Œ å› ä¸ºéç»“æ„åŒ–æ•°æ®é€šå¸¸é€šè¿‡AIæ¨¡å‹è½¬åŒ–ä¸ºå•ä¸€çš„å‘é‡ï¼Œæœ€åŸºæœ¬çš„ACIDå°±è¶³å¤Ÿäº† æä¾›ä¸€ä¸ªå¯è°ƒèŠ‚çš„æ€§èƒ½å’Œä¸€è‡´æ€§ä¹‹é—´çš„trade-off æä¾›ç»†ç²’åº¦çš„å¼¹æ€§ä¼¸ç¼©ä»¥é¿å…ç¡¬ä»¶èµ„æºçš„æµªè´¹ï¼šVDBMS æ¶‰åŠåˆ°å¾ˆå¤šç¡¬ä»¶åŠ é€Ÿï¼Œå¦‚ GPU æˆ–è€… FPGAï¼Œä»¥åŠå¤§é‡çš„å†…å­˜ã€‚é€šè¿‡å°†å‡½æ•°å±‚æˆ–è€…é€»è¾‘å±‚ä¸ç¡¬ä»¶å±‚è¿›è¡Œè§£è€¦ï¼Œä»¥é¿å…éå³°å€¼æœŸçš„æµªè´¹ (å‚è€ƒ snowflake çš„è®¾è®¡)ï¼Œå¼¹æ€§å’Œèµ„æºåº”è¯¥åœ¨å‡½æ•°å±‚è¿›è¡Œç®¡ç†è€Œä¸æ˜¯ç³»ç»Ÿå±‚ log as data\nManuçš„è®¾è®¡å‡†åˆ™ä¸ºæ—¥å¿—å³æ•°æ®ï¼Œæ•´ä¸ªç³»ç»Ÿé€šè¿‡ä¸€ä¸ªæ—¥å¿—çš„è®¢é˜…/å‘å¸ƒç³»ç»Ÿè¿›è¡Œç®¡ç†ï¼Œé€šè¿‡æ—¥å¿—æ¥å®Œæˆå„ä¸ªå±‚ä¹‹é—´çš„è§£è€¦(decoupling of read from write, stateless from stateful, and storage from computing)\næ—¥å¿—æœºåˆ¶ä¸Šä½¿ç”¨äº†MVCCå’Œtime-tickï¼Œåé¢è¿›è¡Œè¯¦ç»†ä»‹ç»\nåœ¨å‘é‡æ£€ç´¢ä¸Šï¼Œæ”¯æŒé‡åŒ–ã€å€’æ’ç´¢å¼•ã€ä¸´è¿‘å›¾ç­‰ç»“æ„\nBackground And Motivation è¿™é‡Œå‰åŠéƒ¨åˆ†è¯´çš„è¿˜æ˜¯VDBMSé‚£å‡ ä¸ªè€ç”Ÿå¸¸è°ˆçš„ç‰¹æ€§ã€‚å…¶ä»–çš„è¯\né¦–å…ˆè¯´æ˜äº†VDBMSç›®å‰çš„æ¶æ„æ˜¯ä¸æˆç†Ÿæˆ–è€…ä¼šæŒç»­å‘å±•çš„ï¼Œç”±äºç›®å‰VDBMSä¸»è¦æ˜¯ç»™AIæˆ–è€…æ•°æ®é©±åŠ¨ç±»å‹åº”ç”¨æœåŠ¡çš„ï¼Œå› æ­¤éšç€è¿™äº›ä¸Šå±‚åº”ç”¨çš„å‘å±•ï¼ŒVDBMSä¹Ÿä¼šå¸¦åŠ¨ç€ä¸€åŒé©æ–°ã€‚ æ— éœ€æ”¯æŒå¤æ‚äº‹åŠ¡ï¼ŒåŸºç¡€ACIDå³å¯ çŸ¢é‡æ•°æ®åº“åº”ç”¨ç¨‹åºéœ€è¦çµæ´»çš„æ€§èƒ½ä¸€è‡´æ€§ trade-offã€‚å¦‚åœ¨è§†é¢‘æ¨èçš„åœºæ™¯ä¸‹ï¼Œæ‹¿ä¸åˆ°æœ€æ–°ä¸Šä¼ çš„è§†é¢‘æ˜¯å¯ä»¥æ¥å—çš„ï¼Œä½†æ˜¯è®©ç”¨æˆ·é•¿æ—¶é—´ç­‰å¾…æ˜¯ä¸‡ä¸‡ä¸å¯çš„ã€‚å¯ä»¥é€šè¿‡é…ç½®æœ€å¤§çš„å»¶è¿Ÿæ—¶é—´æ¥æé«˜ç³»ç»Ÿçš„ååé‡ã€‚è¿™é‡Œçš„è®¾è®¡å°±æœ‰ç‚¹åƒæœç´¢å¼•æ“äº†ï¼Œå°‘æ£€ç´¢å‡ºé‚£ä¹ˆå‡ æ¡æ•°æ®åˆå¦‚ä½•å‘¢ï¼Œè¿™ä¹Ÿæ˜¯æ—©å¹´ GFS é‡‡å–å¼±ä¸€è‡´æ€§çš„åŸå› ã€‚ åšæ€»ç»“ï¼ŒManuçš„è®¾è®¡ç›®æ ‡å¦‚ä¸‹ï¼š\næ”¯æŒé•¿æ—¶é—´çš„è¿­ä»£æ›´æ–° ä¸€è‡´æ€§å¯è°ƒ è‰¯å¥½çš„å¼¹æ€§ é«˜å¯ç”¨æ€§ é«˜æ€§èƒ½ å¼ºé€‚åº”æ€§ The Manu System Schema, Collection, Shard, and Segment schemaï¼šæ•°æ®ç±»å‹ä¸Šæ”¯æŒåŸºæœ¬æ•°æ®ç±»å‹ + vectorï¼Œä¸€æ¡è®°å½•ç”±user fieldå’Œsys fieldä¸¤éƒ¨åˆ†ç»„æˆ: å…¶ä¸­ï¼Œlabelå’Œnumerical attributeç»„æˆäº†è¿‡æ»¤å­—æ®µï¼Œlabelå°±æ˜¯ä¼ ç»Ÿæ„ä¹‰ä¸Šçš„æ ‡ç­¾ï¼Œå¦‚è¡£æœï¼Œé£Ÿç‰©ç­‰ï¼Œnumerical attributeå³ä¸ºå’Œè¯¥æ¡è®°å½•ç›¸å…³çš„æ•°å€¼å±æ€§ï¼Œå¦‚èº«é«˜ï¼Œä»·æ ¼ç­‰ã€‚\nsys fieldçš„LSNå¯¹äºç”¨æˆ·æ˜¯ä¸å¯è§çš„ï¼Œç”¨äºç³»ç»Ÿå†…éƒ¨ä½¿ç”¨\ncollection: ä½œä¸ºentityçš„é›†åˆï¼Œå¯¹åº”DBMSå½“ä¸­çš„è¡¨çš„è§’è‰²ï¼Œä½†æœ€å¤§çš„åŒºåˆ«æ˜¯ä¸å­˜åœ¨å…³ç³»çš„æ¦‚å¿µï¼Œä¸ä¼šå’Œå…¶ä»–çš„collectionä¹‹é—´å­˜åœ¨relationï¼ŒåŒæ ·ä¹Ÿä¸æ”¯æŒå…³ç³»ä»£æ•°\nshard: åœ¨æ’å…¥æ—¶ï¼Œentityä¼šæ ¹æ®ID hashåˆ°å¤šä¸ªshardå½“ä¸­ï¼Œä½†æ˜¯åœ¨manuå½“ä¸­ï¼Œshardå¹¶éƒ¨ç½²æ•°æ®çš„å­˜å‚¨(placement)å•å…ƒ\nsegmentï¼š æ¯ä¸ªshardå½“ä¸­çš„entityé€šè¿‡segmentæ¥è¿›è¡Œç®¡ç†ï¼Œsegmentå¯ä»¥æœ‰ä¸¤ç§çŠ¶æ€ï¼š\ngrowingï¼šå¯ä»¥å‘å…¶ä¸­æ·»åŠ æ–°çš„entityï¼Œåˆ°è¾¾512MBè½¬æ¢ä¸ºsealedï¼Œæˆ–è€…ä¸€æ®µæ—¶é—´æ²¡æœ‰å‘å…¶ä¸­æ·»åŠ æ–°çš„æ•°æ® Sealedï¼šä¸æ¥å—æ–°çš„ entityï¼Œä¸ºåªè¯»çš„çŠ¶æ€ å°çš„segmentå¯ä»¥è¿›è¡Œåˆå¹¶\nå¯¹äºshardå’Œsegmentï¼Œè¿™é‡Œè¯´çš„æ¯”è¾ƒç®€é™‹ï¼Œåœ¨åé¢æ—¥å¿—éƒ¨åˆ†æœ‰è¯¦ç»†æè¿°ï¼Œshardæ˜¯ä¸€ä¸ªè¾ƒå¤§çš„å•ä½ï¼Œå¯¹åº”äº†ä¸€ä¸ªå­˜å‚¨èŠ‚ç‚¹çš„æ¦‚å¿µï¼Œè®°å½•é€šè¿‡å“ˆå¸Œæ‰¾åˆ°è‡ªå·±æ‰€å±çš„å­˜å‚¨èŠ‚ç‚¹ï¼Œè€Œsegmentåˆ™æ˜¯æ•°æ®çš„å­˜å‚¨æˆ–è€…ç®¡ç†å•å…ƒï¼Œæœ‰ç‚¹ç±»ä¼¼äºchunkçš„è¿™ä¸ªæ¦‚å¿µã€‚\nSystem Architecture æ ¹æ®ä¸Šé¢æè¿°çš„ç§ç§äº‘åŸç”Ÿå‘é‡æ•°æ®åº“çš„éœ€æ±‚ï¼ŒManuåœ¨æ¶æ„ä¸Šè¿›è¡Œç»†ç²’åº¦çš„è§£è€¦ï¼Œåˆ†ä¸ºäº†å¤šä¸ªå±‚ï¼Œæ¯å±‚å„å¸å…¶èŒï¼Œè¿™é‡Œçš„è§£è€¦æ¯”åƒsnowflakeé‚£æ ·çš„å­˜ç®—åˆ†ç¦»è¦å½»åº•ä¸€äº›ã€‚\nAccess layer\nä½äºæ•´ä¸ªç³»ç»Ÿçš„æœ€ä¸Šå±‚ï¼Œé‡‡ç”¨æ— çŠ¶æ€(stateless) + ç¼“å­˜çš„è®¾è®¡æ–¹å¼ï¼Œä»£ç†å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œå¹¶å°†å…¶è½¬å‘åˆ°å¯¹åº”çš„ä¸‹å±‚èŠ‚ç‚¹ä¸Šã€‚\nCoordinator layer\nåœ¨è¿™ä¸€å±‚å½“ä¸­å­˜åœ¨å››ä¸ªCoordinatorï¼Œåˆ†åˆ«è´Ÿè´£ä¸åŒçš„å·¥ä½œï¼š Rootï¼ŒQueryï¼ŒDataï¼ŒIndex\nRootä¸»è¦å¤„ç†åˆ›å»º/åˆ é™¤collectionçš„æ“ä½œ(å¯¹åº” sqlå½“ä¸­çš„ddl)ï¼Œå¹¶ä¸”ç»´æŠ¤collectionçš„å…ƒæ•°æ® Dataè´Ÿè´£ç»´æŠ¤ä¸€ä¸ªcollectionçš„è¯¦ç»†ä¿¡æ¯ï¼Œå¦‚segmentçš„è·¯ç”±æˆ–è€…è·¯å¾„ï¼Œå¹¶ä¸”å¯ä»¥å’Œåº•å±‚çš„data nodeåˆä½œå°†æ›´æ–°çš„æ•°æ®è½¬æ¢ä¸ºbinlog Index ç»´æŠ¤ç´¢å¼•çš„å…ƒæ•°æ®å’Œåˆ›å»ºç´¢å¼•å·¥ä½œ Query æ˜¾è€Œæ˜“è§ Worker layer\nè´Ÿè´£çœŸå®çš„è®¡ç®—ä»»åŠ¡ï¼ŒèŠ‚ç‚¹ä¸ºæ— çŠ¶æ€çš„ï¼Œåªä¼šä»å­˜å‚¨èŠ‚ç‚¹è·å¾—ä¸€ä»½copyæ¥è¿›è¡Œè®¡ç®—ï¼Œå„èŠ‚ç‚¹ä¹‹é—´ä¸å­˜åœ¨äº¤äº’ã€‚ä¸ºäº†ä¿è¯å¯ä»¥æ ¹æ®éœ€æ±‚æ‰©å……ï¼Œå°†èŠ‚ç‚¹æ ¹æ®ä»»åŠ¡ç±»å‹åˆ’åˆ†ä¸ºäº†query data indexä¸‰ç§ç±»å‹\nStorage layer\nä½¿ç”¨etcdæ¥å­˜å‚¨ç³»ç»ŸçŠ¶æ€å’Œå…ƒæ•°æ® ä½¿ç”¨AWS S3ä½œä¸ºå¯¹è±¡å­˜å‚¨ï¼Œå­˜å‚¨segment/shard Log Backbone æ—¥å¿—ä½œä¸ºéª¨æ¶ï¼Œå°†è§£è€¦çš„ç³»ç»Ÿç»„ä»¶è¿æ¥æˆä¸€ä¸ªæ•´ä½“ã€‚æ—¥å¿—ä½¿ç”¨wal + binlogçš„ç»„åˆï¼Œwalä½œä¸ºå¢é‡éƒ¨åˆ†ï¼Œbinä½œä¸ºåŸºç¡€éƒ¨åˆ†ï¼ŒäºŒè€…ç›¸äº’è¡¥å……ã€‚data nodeè®¢é˜…walï¼Œç„¶åå°†row-basedçš„walè½¬æ¢ä¸ºcolumn-basedçš„binlogã€‚\næ‰€æœ‰ä¼šæ›´æ”¹ç³»ç»ŸçŠ¶æ€çš„æ“ä½œéƒ½ä¼šè®°å½•åˆ°æ—¥å¿—å½“ä¸­ï¼ŒåŒ…æ‹¬ddlã€dmlï¼Œå’Œä¸€äº›system coordinationçš„æ“ä½œ(å‘å†…å­˜å½“ä¸­åŠ è½½collecion)ã€‚è€Œåªè¯»è¯·æ±‚ä¸ä¼šè¿›å…¥æ—¥å¿—ã€‚ æ—¥å¿—é‡‡ç”¨çš„æ˜¯é€»è¾‘æ—¥å¿—è€Œéç‰©ç†æ—¥å¿— æ—¥å¿—ç³»ç»Ÿçš„æ¶æ„å¦‚ä¸‹ï¼š loggeré€šè¿‡ä¸€è‡´æ€§å“ˆå¸Œè¿›è¡Œç®¡ç†ï¼Œç›¸æ¯”äºæ™®é€šçš„å“ˆå¸Œå‡½æ•°ï¼Œå¯ä»¥å¾—åˆ°ä¸€ä¸ªè¾ƒå¥½çš„è´Ÿè½½å‡è¡¡å¹¶ä¸”åœ¨æ·»åŠ æˆ–è€…åˆ é™¤èŠ‚ç‚¹æ—¶å½±å“åˆ°çš„èŠ‚ç‚¹è¾ƒå°‘ã€‚ æ¯ä¸€ä¸ªshardå¯¹åº”å“ˆå¸Œç¯ä¸Šçš„ä¸€ä¸ªé€»è¾‘å“ˆå¸Œæ¡¶(å…¶ä¸­å¯¹åº”å¤šä¸ªç‰©ç†å“ˆå¸Œæ¡¶)ï¼Œå¹¶ä¸”å’Œwal channelä¸€ä¸€å¯¹åº” å¯¹äºä¸€æ¬¡è¯·æ±‚ï¼Œé¦–å…ˆæ ¹æ®IDè¿›è¡Œå“ˆå¸Œåˆ°å¯¹åº”çš„loggerï¼Œå†ä½¿ç”¨TSO(å®ç°æ–¹å¼ä¸ºæ··åˆæ—¶é’Ÿ)è¿›è¡Œåˆ†é…ä¸€ä¸ªå…¨å±€çš„LSNï¼Œæ ¹æ®LSNåˆ’åˆ†åˆ°å¯¹åº”çš„segmentå½“ä¸­ï¼Œç„¶åå°†å…¶å†™å…¥åˆ°WALå½“ä¸­ï¼Œæ­¤å¤–è¿˜ä¼šç»´æŠ¤ä¸€ä¸ªentity IDåˆ°segment IDçš„ä¸€ä¸ªæ˜ å°„ï¼Œä½¿ç”¨rocksdbè¿›è¡Œå­˜å‚¨ï¼Œå¹¶ç¼“å­˜åœ¨loggerå½“ä¸­ã€‚ WAL channelæœ¬èº«æä¾›ä¸€ä¸ªå‘å¸ƒè®¢é˜…åŠŸèƒ½ï¼Œæœ¬èº«ç›¸å½“äºä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œåœ¨å®ç°ä¸Šä½¿ç”¨kafkaç­‰ï¼Œloggerç›¸å½“äºå‘å¸ƒç«¯ï¼Œdata nodeè®¢é˜…è¯¥channelï¼Œå°†row-basedçš„walè½¬æ¢ä¸ºcolumn-basedçš„binlogã€‚è€Œä¹‹æ‰€ä»¥ä½¿ç”¨column-basedçš„å½¢å¼ï¼Œè¿˜æ˜¯VDBMSçš„æ£€ç´¢æœåŠ¡æœ¬è´¨ä¸Šè¿˜æ˜¯æœ‰ç‚¹ç±»ä¼¼OLAPåœºæ™¯ï¼Œåˆ—å¼å­˜å‚¨å¯ä»¥æä¾›è¾ƒå¥½çš„å­˜å‚¨å’ŒIOæ€§èƒ½ã€‚ ç»„ä»¶é—´çš„æ¶ˆæ¯ä¹Ÿé€šè¿‡æ—¥å¿—ä¼ é€’ï¼Œä¾‹å¦‚ï¼Œæ•°æ®èŠ‚ç‚¹å®£å¸ƒä½•æ—¶å°†æ®µå†™å…¥å­˜å‚¨ï¼Œç´¢å¼•èŠ‚ç‚¹å®£å¸ƒä½•æ—¶æ„å»ºç´¢å¼•ã€‚è¿™æ˜¯å› ä¸ºæ—¥å¿—ç³»ç»Ÿæä¾›äº†ä¸€ç§ç®€å•å¯é çš„æœºåˆ¶æ¥å¹¿æ’­ç³»ç»Ÿäº‹ä»¶ Tunable Consistency Manuå¼•å…¥äº†â€œdeltaä¸€è‡´æ€§â€ï¼ˆdelta consistencyï¼‰ï¼Œè¿™ç§ä¸€è‡´æ€§æ¨¡å‹ä½äºå¼ºä¸€è‡´æ€§å’Œæœ€ç»ˆä¸€è‡´æ€§ä¹‹é—´ã€‚åœ¨è¿™ç§æ¨¡å‹ä¸‹ï¼Œè¯»æ“ä½œè¿”å›çš„æ˜¯æœ€å¤šåœ¨deltaæ—¶é—´å•ä½ä¹‹å‰äº§ç”Ÿçš„æœ€åä¸€ä¸ªå€¼ã€‚è¿™é‡Œçš„â€œdeltaâ€æ˜¯ä¸€ä¸ªå¯è°ƒæ•´çš„æ—¶é—´å‚æ•°ï¼Œå¯ä»¥æ ¹æ®éœ€è¦è®¾ç½®ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå¼ºä¸€è‡´æ€§å’Œæœ€ç»ˆä¸€è‡´æ€§å¯ä»¥çœ‹ä½œæ˜¯è¿™ä¸ªæ¨¡å‹çš„ç‰¹æ®Šæƒ…å†µï¼Œå…¶ä¸­deltaåˆ†åˆ«ä¸ºé›¶å’Œæ— é™å¤§\nä¸ºäº†å®ç°deltaä¸€è‡´æ€§ï¼Œåˆ†ä¸ºä¸¤æ–¹é¢ï¼š\né¦–å…ˆå®ç°TSOæ¥ç”Ÿæˆå…¨å±€å”¯ä¸€çš„LSNï¼Œè¿™é‡Œä½¿ç”¨äº†æ··åˆæ—¶é’Ÿï¼Œç‰©ç†éƒ¨åˆ†è®°å½•ç‰©ç†æ—¶é—´ï¼Œé€»è¾‘éƒ¨åˆ†è®°å½•æ—¶é—´é¡ºåºã€‚é€»è¾‘éƒ¨åˆ†ç”¨äºç¡®å®šäº‹ä»¶çš„å…ˆåé¡ºåºï¼Œè€Œç‰©ç†éƒ¨åˆ†ç”¨äºå’Œdeltaé…åˆæ¥è®¾ç½®å®¹å¿çš„å»¶è¿Ÿã€‚ä¸è¿‡è¿™é‡ŒTSOæ˜¯å•æœºå®ç°çš„ï¼Œæœ‰å¯èƒ½æˆä¸ºæ•´ä¸ªç³»ç»Ÿçš„ç“¶é¢ˆã€‚è™½ç„¶éƒ½ä½¿ç”¨äº†HLCï¼Œåˆ°é‚£æ—¶å’Œcockroachdbæ˜¯ä¸åŒçš„ã€‚ äºŒæ˜¯ä½¿ç”¨äº†time-tickçš„ç­–ç•¥ï¼Œç®€å•æ¥è¯´è¿™ä¸ªå®ç°æœ‰ç‚¹åƒæœºæªçš„æ›³å…‰å¼¹ï¼Œæ¯éš”å‡ å‘å°±æ·»åŠ ä¸€å‘æ›³å…‰å¼¹æ¥è¿›è¡Œæ ‡è¯† ä½œä¸ºæ—¥å¿—è®¢é˜…è€…çš„query nodeï¼Œéœ€è¦çŸ¥é“ä¸‰ä»¶äº‹:1)ç”¨æˆ·è®¾å®šçš„deltaï¼Œ2)ä¸Šæ¬¡æ›´æ–°çš„æ—¶é—´ï¼Œ3)æŸ¥è¯¢è¯·æ±‚çš„æ—¶é—´ ä½¿ç”¨time-tickç­–ç•¥ï¼Œåœ¨æ—¥å¿—å½“ä¸­ä¼šå®šæœŸçš„æ’å…¥å¸¦æœ‰æ—¶é—´çš„ç‰¹æ®Šæ—¥å¿—æ ‡å¿—ï¼Œå°†æœ€åä¸€æ¬¡çš„æ—¶é—´è®°ä¸º $L_s$ ï¼Œè€Œè¯·æ±‚åˆä¼šå¸¦ä¸Š$L_r$ï¼Œåªæœ‰æ»¡è¶³äº†$L_r - L_s \u0026lt; \\delta$ çš„æƒ…å†µä¸‹æŸ¥è¯¢æ‰ä¼šè¿”å›ï¼Œå¦åˆ™ä¸€ç›´ç­‰å¾… Index Building Manuæ”¯æŒçš„ç´¢å¼•ç±»å‹å¦‚ä¸‹ï¼š Manuå½“ä¸­å¹¶æ²¡æœ‰æå‡ºä»€ä¹ˆæ–°é¢–çš„ç´¢å¼•ç±»å‹ï¼Œåœ¨è¿™ä¸€æ®µï¼Œä¸»è¦é˜è¿°äº†ä¸¤ç§ç´¢å¼•æ„å»ºåœºæ™¯ã€‚åˆ†åˆ«æ˜¯æ‰¹å¤„ç†å’Œæµå¤„ç†ï¼š\næ‰¹å¤„ç†å‘ç”Ÿåœ¨å¯¹äºæ•´ä¸ªcollectionæ„å»ºç´¢å¼•çš„æƒ…å†µï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œindex coordinatorçŸ¥é“collectionæ¶‰åŠçš„æ‰€æœ‰çš„segmentçš„è·¯å¾„ï¼Œç„¶åæŒ‡ç¤ºindex nodeå»åˆ›å»ºç´¢å¼•ã€‚ æµå¤„ç†åˆ™æ˜¯å¢é‡æƒ…å†µï¼Œç´¢å¼•æ˜¯åœ¨ä¸åœæ­¢æœç´¢æœåŠ¡çš„æƒ…å†µä¸‹å®æ—¶å¼‚æ­¥æ„å»ºçš„ã€‚å½“ä¸€ä¸ªSegmentç§¯ç´¯äº†è¶³å¤Ÿæ•°é‡çš„å‘é‡åï¼Œå…¶é©»ç•™æ•°æ®èŠ‚ç‚¹ä¼šå¯†å°è¯¥Segmentå¹¶å°†å…¶ä½œä¸ºbinlogå†™å…¥å¯¹è±¡å­˜å‚¨ã€‚ç„¶åæ•°æ®åè°ƒå™¨é€šçŸ¥ç´¢å¼•åè°ƒå™¨ï¼Œç´¢å¼•åè°ƒå™¨æŒ‡ç¤ºç´¢å¼•èŠ‚ç‚¹ä¸ºè¯¥æ®µå»ºç«‹ç´¢å¼• Manué€šè¿‡bitmapæ¥è®°å½•è¢«segmentå½“ä¸­åˆ é™¤çš„å‘é‡ï¼Œè€Œè¢«åˆ é™¤çš„å‘é‡æ•°é‡è¾¾åˆ°ä¸€å®šç¨‹åº¦åï¼Œä¼šé‡æ–°æ„å»ºç´¢å¼• Vector Search å…ˆè¯´å‡ ä¸ªç‰¹æ€§ï¼š\nå¯ä»¥ä½¿ç”¨è·ç¦»æˆ–è€…ç›¸ä¼¼åº¦å‡½æ•°è¿›è¡Œæœç´¢ï¼Œå¦‚æ¬§å‡ é‡Œå¾—è·ç¦»ï¼Œå†…ç§¯ï¼Œè§’è·ç¦»ç­‰ ä½¿ç”¨cost-basedæ¨¡å‹æ¥é€‰æ‹©æ‰§è¡Œç­–ç•¥ æ”¯æŒå¤šå‘é‡æ£€ç´¢ æŸ¥è¯¢åŠ é€Ÿ\nCollectionè¢«åˆ†ä¸ºsegmentï¼Œç„¶ååœ¨å„ä¸ªsegmentä¸Šè¿›è¡Œå¹¶è¡ŒæŸ¥è¯¢ï¼Œåœ¨æ¯ä¸ªæ®µä¸Šè¿›è¡Œtop-kæŸ¥è¯¢ï¼Œä¹‹åå†ä½¿ç”¨ä¸€ä¸ªèšåˆå‡½æ•°å¤„ç†å„ä¸ªæ®µä¸Šçš„top-kå‘é‡ï¼Œèšåˆå¾—åˆ°ä¸€ä¸ªå…¨å±€çš„top-kç»“æœ\næ•°æ®æ¥æº\nåƒä¹‹å‰è¯´çš„é‚£æ ·ï¼ŒManuä½¿ç”¨çš„æ˜¯å­˜ç®—åˆ†ç¦»çš„æ¶æ„ï¼Œè®¡ç®—èŠ‚ç‚¹è·å–ä¸€ä»½copyè¿›è¡Œè®¡ç®—ã€‚å› æ­¤æŸ¥è¯¢èŠ‚ç‚¹å…±æœ‰ä¸‰ä¸ªæ•°æ®æ¥æºï¼šWALï¼Œç´¢å¼•ï¼Œbinlogï¼š\nå¯¹äºè¿˜å¤„äºgrowingæŒç»­å†™å…¥çš„segmentï¼ŒæŸ¥è¯¢èŠ‚ç‚¹å¯ä»¥é€šè¿‡è®¢é˜…WALçš„æ–¹å¼ï¼Œç„¶ååœ¨å…¶ä¸­è¿›è¡Œæš´åŠ›æ‰«æå¾—åˆ°ç»“æœï¼Œä»¥æ±‚æœ€å°å»¶è¿Ÿã€‚ä½†æ˜¯æš´åŠ›æ‰«æçš„å¼€é”€ä¾æ—§å¾ˆé«˜ï¼Œç»™å‡ºçš„å¯¹ç­–æ˜¯å°†segmentåˆ’åˆ†ä¸ºåˆ‡ç‰‡(slice)ï¼Œä¸€ä¸ªåˆ‡ç‰‡åŒ…å«1wæ¡vectorï¼Œä¸€æ—¦ä¸€ä¸ªåˆ‡ç‰‡å®Œæˆäº†å†™å…¥ï¼Œå°±å¯¹å…¶å»ºç«‹ä¸´æ—¶ç´¢å¼•ä»¥åŠ é€Ÿæœç´¢ï¼Œå¤§çº¦å¯ä»¥æå‡10x è€Œä»growingè½¬æ¢ä¸ºsealedçš„segmentï¼Œå°±å¯ä»¥å¯¹å…¶å»ºç«‹å®Œæ•´çš„ç´¢å¼•ï¼Œå¹¶å­˜å‚¨åœ¨AWS S3å½“ä¸­ï¼Œä¹‹åé€šçŸ¥æŸ¥è¯¢èŠ‚ç‚¹å»åŠ è½½å®Œæ•´ç´¢å¼•æ¥æ›¿æ¢æ‰ä¸´æ—¶ç´¢å¼• å½“æŸ¥è¯¢èŠ‚ç‚¹ä¹‹é—´çš„segmentåˆ†å¸ƒå‘ç”Ÿå˜åŒ–æ—¶ï¼ŒæŸ¥è¯¢èŠ‚ç‚¹ä¼šè®¿é—® binlog æ¥è·å–æ•°æ®ï¼Œè¿™ç§æƒ…å†µå¯èƒ½å‘ç”Ÿåœ¨æ‰©å±•ã€è´Ÿè½½å‡è¡¡ã€æŸ¥è¯¢èŠ‚ç‚¹æ•…éšœå’Œæ¢å¤æœŸé—´ å½“æŸ¥è¯¢èŠ‚ç‚¹å‘ç”Ÿæ•…éšœæ—¶ï¼Œæˆ–è€…èŠ‚ç‚¹è¢«ç§»é™¤æ—¶ï¼ˆscaling down)å…¶è´Ÿè´£çš„ä»»åŠ¡å¯¹åº”çš„segmentå’Œç´¢å¼•å°±ä¼šè¢«åŠ è½½åˆ°å¦å¤–ä¸€ä¸ªæ­£å¸¸çš„èŠ‚ç‚¹å½“ä¸­ å½“æ–°èŠ‚ç‚¹è¢«æ·»åŠ åˆ°å…¶ä¸­æ—¶ï¼ŒåŒæ ·ä¹Ÿä¼šæœ‰ç±»ä¼¼çš„æ“ä½œ åŸå­æ€§\nManu ä¸ç¡®ä¿æ®µé‡æ–°åˆ†é…æ˜¯åŸå­çš„ï¼Œå¹¶ä¸”ä¸€ä¸ªæ®µå¯ä»¥é©»ç•™åœ¨å¤šä¸ªæŸ¥è¯¢èŠ‚ç‚¹ä¸Šã€‚è¿™ä¸ä¼šå½±å“æ­£ç¡®æ€§ï¼Œå› ä¸ºä»£ç†ä¼šåˆ é™¤æŸ¥è¯¢çš„é‡å¤ç»“æœå‘é‡ã€‚\nå‰©ä½™çš„éƒ¨åˆ†å¯èƒ½å¤§å¤šéƒ½æ˜¯äº›å‘é‡ç‰¹ç‚¹å¹¶ä¸æ˜¯é‚£ä¹ˆé²œæ˜çš„å†…å®¹å’Œä¸€äº›ç”¨ä¾‹åˆ†æäº†ï¼Œè¿™é‡Œå°±ä¸åšè¿‡å¤šçš„åˆ†æäº†ã€‚\nSummary åœ¨æˆ‘çœ‹æ¥ã€ŠManu: A Cloud Native Vector Database Management Systemã€‹è¿™ä¸€ç¯‡æ–‡ç« å·¥ç¨‹å®è·µæ€§æ¯”è¾ƒå¼ºçš„æ–‡ç« äº†ï¼Œæ–‡ä¸­å¹¶æ²¡æœ‰å¯¹äºå‘é‡æ•°æ®åº“çš„æ ¸å¿ƒï¼Œå³å‘é‡æ£€ç´¢å’Œç´¢å¼•æ–¹é¢æå‡ºä»€ä¹ˆåˆ›æ–°æ€§çš„è®¾è®¡ï¼Œè€Œæ˜¯æ›´æ³¨é‡æ¶æ„æ–¹é¢ï¼Œä»æ¶æ„æ–¹é¢å‡ºå‘ï¼Œè®²è¿°äº†å‘é‡æ•°æ®åº“å’Œäº‘åŸç”Ÿæ¶æ„ä¹‹é—´çš„ä¸€ä¸ªåŒ–å­¦ååº”ã€‚åŒæ—¶zillizä¹Ÿç®—æ˜¯æ¯”è¾ƒå‡ºåçš„å‘é‡æ•°æ®åº“çš„åˆåˆ›äº†ï¼Œè¿˜æ˜¯æ¯”è¾ƒçœ‹å¥½å…¶å‘å±•çš„ã€‚\n","permalink":"https://fischer0522.github.io/en/posts/tech/manu/","summary":"Manu: A Cloud Native Vector Database Management System Introduction Manuæˆ–è€…å…¶å‰èº«Milvusï¼Œå®šä½ç›®æ ‡æ˜¯äº‘åŸç”Ÿçš„å‘é‡æ•°æ®åº“ï¼Œéœ€è¦æä¾›åŸºç¡€çš„å‘é‡å­˜å‚¨å’Œæ£€ç´¢æœåŠ¡ï¼ŒåŒæ—¶ï¼Œç›¸æ¯”ä¼ ç»Ÿçš„äº‘åŸç”ŸDB","title":"Manu: A Cloud Native Vector Database Management System"},{"content":"raft-example etcd/raftæ•´ä½“æ¶æ„ etcd/rafté€‰ä¸¾æµç¨‹ etcd/raftæ—¥å¿—å¤åˆ¶\n","permalink":"https://fischer0522.github.io/en/posts/tech/etcd/etcd-raft/","summary":"raft-example etcd/raftæ•´ä½“æ¶æ„ etcd/rafté€‰ä¸¾æµç¨‹ etcd/raftæ—¥å¿—å¤åˆ¶","title":"etcd/raft"},{"content":"Raftæ—¥å¿— æ—¥å¿—å­˜å‚¨ Raftæ—¥å¿—åœ¨å­˜å‚¨ä¸Šåˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†ä¸ºæ–°å†™å…¥æˆ–è€…æ–°ç”Ÿæˆçš„æ—¥å¿—ï¼Œæš‚æ—¶å­˜å‚¨äºå†…å­˜å½“ä¸­ï¼Œè¿˜æœªæ¥å¾—åŠè¿›è¡Œç¨³å®šå­˜å‚¨ã€‚è€Œå¦ä¸€éƒ¨åˆ†åˆ™æ˜¯ç›®å‰å·²ç»è¿›è¡Œç¨³å®šå­˜å‚¨çš„ã€‚\nåœ¨Logæ¥å£ä¸­å¯ä»¥çœ‹åˆ°ï¼Œåˆ†ä¸ºå¯¹åº”äºStorageå’Œunstable\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 type raftLog struct { // storage contains all stable entries since the last snapshot. storage Storage // unstable contains all unstable entries and snapshot. // they will be saved into storage. unstable unstable // committed is the highest log position that is known to be in // stable storage on a quorum of nodes. committed uint64 // applied is the highest log position that the application has // been instructed to apply to its state machine. // Invariant: applied \u0026lt;= committed applied uint64 logger Logger // maxNextEntsSize is the maximum number aggregate byte size of the messages // returned from calls to nextEnts. maxNextEntsSize uint64 } ç”±äºetcd/raftçš„åº•å±‚åªè´Ÿè´£rafté€»è¾‘å¤„ç†ï¼Œè€Œå­˜å‚¨ä¸é€šä¿¡äº¤ç»™äº†ä¸Šå±‚ï¼Œå› æ­¤åœ¨è¿™ä¸ªè¿‡ç¨‹å½“ä¸­äº§ç”Ÿçš„æ—¥å¿—å’Œå¿«ç…§å‡é€šè¿‡unstableè¿›è¡Œæš‚æ—¶æ€§çš„å­˜å‚¨ï¼Œä¹‹åé€šè¿‡Ready()å‡½æ•°ï¼Œä»¥æ‰¹å¤„ç†çš„æ–¹å¼ï¼Œä¸€æ¬¡æ€§çš„å°†ä¸€æ®µæ—¶é—´å†…çš„msgã€logã€hardStateã€Snapshotå…¨éƒ¨è¿”å›ç»™ä¸Šå±‚ï¼Œè¿›è¡ŒèŠ‚ç‚¹é—´çš„é€šä¿¡ä¸å­˜å‚¨ã€‚å¯ä»¥åœ¨raft-exampleå½“ä¸­çœ‹åˆ°ç›¸å…³çš„é€»è¾‘\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 for { select { case \u0026lt;-ticker.C: rc.node.Tick() // store raft entries to wal, then publish over commit channel case rd := \u0026lt;-rc.node.Ready(): rc.wal.Save(rd.HardState, rd.Entries) if !raft.IsEmptySnap(rd.Snapshot) { rc.saveSnap(rd.Snapshot) rc.raftStorage.ApplySnapshot(rd.Snapshot) rc.publishSnapshot(rd.Snapshot) } rc.raftStorage.Append(rd.Entries) rc.transport.Send(rd.Messages) applyDoneC, ok := rc.publishEntries(rc.entriesToApply(rd.CommittedEntries)) if !ok { rc.stop() return } rc.maybeTriggerSnapshot(applyDoneC) rc.node.Advance() case err := \u0026lt;-rc.transport.ErrorC: rc.writeError(err) return case \u0026lt;-rc.stopc: rc.stop() return } } unstable unstableçš„ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 type unstable struct { // the incoming unstable snapshot, if any. snapshot *pb.Snapshot // all entries that have not yet been written to storage. entries []pb.Entry offset uint64 logger Logger } å…¶ä¸­ï¼Œoffsetç”¨äºå°†unstableå½“ä¸­çš„ä¸‹æ ‡è½¬æ¢ä¸ºå…¨å±€ä¸‹æ ‡\néƒ¨åˆ†ç›¸å…³å‡½æ•°ï¼š\nå‡½æ•° åŠŸèƒ½ maybeFirstIndex æ±‚å‡ºæ—¥å¿—å½“ä¸­ç¬¬ä¸€ä¸ªEntryçš„Index maybeLastIndex æ±‚å‡ºæ—¥å¿—å½“ä¸­æœ€åä¸€ä¸ªEntryçš„Index maybeTerm æ±‚å‡ºç»™å®šIndexå¯¹åº”çš„Term stableTo å·²ç»é€šè¿‡Readyå°†éƒ¨åˆ†æ—¥å¿—æŒä¹…åŒ–ï¼Œå¯¹çŠ¶æ€è¿›è¡Œæ›´æ–°ï¼Œé€šè¿‡Advanceè°ƒç”¨ stableSnap å¿«ç…§æŒä¹…åŒ– shrinkEntriesArray æ ¹æ®åº•å±‚åˆ‡ç‰‡çš„sizeä¸capçš„å¤§å°æƒ…å†µï¼Œé€‚å½“ç¼©å°åˆ‡ç‰‡ï¼Œé‡Šæ”¾å†…å­˜ truncateAppend å‘åŸæœ‰çš„æ—¥å¿—å½“ä¸­æ·»åŠ æ–°çš„æ—¥å¿—ï¼Œäº§ç”Ÿå†²çªçš„åˆ™å°†æ—§çš„è¦†ç›– slice æ£€æŸ¥èŒƒå›´åè¿”å›ä¸€æ®µçš„æ—¥å¿— å…¶ä¸­ï¼ŒmaybeFirstIndex maybeLastIndex maybeTerméƒ½æ˜¯æ ¹æ®Snapshotè¿›è¡Œåˆ¤æ–­ï¼Œ å¦‚æœå½“å‰å­˜åœ¨ä¸ç¨³å®šçš„Snapshotï¼Œå°±å¯ä»¥æ ¹æ®Snapshotå½“ä¸­çš„å…ƒæ•°æ®æ¨æ–­å‡ºç›¸å¯¹æ•´ä¸ªraftlogçš„æ•°æ®ï¼Œå¦‚æœä¸å­˜åœ¨Snapshotåˆ™æ— æ³•æ¨æ–­ä»è€Œè¿”å›ä¸€ä¸ªfalse stableToã€stableSnapåæ˜ äº†æ•´ä¸ªå­˜å‚¨æ¨¡å—çš„äº¤äº’é€»è¾‘ï¼Œå½“éƒ¨åˆ†æ—¥å¿—é€šè¿‡Ready()äº¤ç»™ä¸Šå±‚è¿›è¡ŒæŒä¹…åŒ–å­˜å‚¨ä¹‹åï¼Œå°±å¯ä»¥è°ƒç”¨Advanceæ¥æ¨è¿›æ•´ä¸ªæµç¨‹ï¼Œä¹‹åAdvanceä¼šè°ƒç”¨åˆ°stableToå’ŒstableSnapå°†å·²ç»æŒä¹…åŒ–çš„æ—¥å¿—ä»å†…å­˜å½“ä¸­é‡Šæ”¾ï¼ˆè¿™é‡Œçš„æŒä¹…åŒ–æ˜¯æŒ‡äº¤ç»™Storageè¿›è¡Œå­˜å‚¨ï¼ŒStorageçš„å…·ä½“å­˜å‚¨é€»è¾‘ä¹‹åè¿›è¡Œåˆ†æ) Storage Storageå®šä¹‰ä¸ºæ¥å£çš„å½¢å¼ï¼Œè€Œå®˜æ–¹ç»™å‡ºå®ç°ä¸ºMemoryStorageï¼Œå°†å…¨éƒ¨çš„æ•°æ®å…¨éƒ¨å­˜æ”¾äºå†…å­˜å½“ä¸­ï¼Œä½†æ˜¯é€šè¿‡WALçš„å½¢å¼ä¿è¯èƒ½å¤Ÿç¨³å®šå­˜å‚¨ï¼Œç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 // MemoryStorage implements the Storage interface backed by an // in-memory array. type MemoryStorage struct { // Protects access to all fields. Most methods of MemoryStorage are // run on the raft goroutine, but Append() is run on an application // goroutine. sync.Mutex // hardStateå³ä¸ºRaftå½“ä¸­éœ€è¦æŒä¹…åŒ–ä¿å­˜çš„å­—æ®µï¼ŒTermã€Voteã€Commit // å¯¹åº”çš„æœ‰SoftStateï¼Œå³æ— éœ€æŒä¹…åŒ–ä¿å­˜ï¼Œå¯ä»¥é€šè¿‡èŠ‚ç‚¹ä¹‹é—´ç›¸äº’é€šä¿¡æ¢å¤ hardState pb.HardState snapshot pb.Snapshot // ents[i] has raft log position i+snapshot.Metadata.Index ents []pb.Entry } ç›¸å…³çš„WALé€»è¾‘å¯ä»¥åœ¨ä¸Šå±‚çš„raft server(raft example)å½“ä¸­å®ç°\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 case rd := \u0026lt;-rc.node.Ready(): rc.wal.Save(rd.HardState, rd.Entries) if !raft.IsEmptySnap(rd.Snapshot) { rc.saveSnap(rd.Snapshot) rc.raftStorage.ApplySnapshot(rd.Snapshot) rc.publishSnapshot(rd.Snapshot) } rc.raftStorage.Append(rd.Entries) rc.transport.Send(rd.Messages) applyDoneC, ok := rc.publishEntries(rc.entriesToApply(rd.CommittedEntries)) if !ok { rc.stop() return } rc.maybeTriggerSnapshot(applyDoneC) rc.node.Advance() 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 func (w *WAL) Save(st raftpb.HardState, ents []raftpb.Entry) error { w.mu.Lock() defer w.mu.Unlock() // short cut, do not call sync if raft.IsEmptyHardState(st) \u0026amp;\u0026amp; len(ents) == 0 { return nil } mustSync := raft.MustSync(st, w.state, len(ents)) // TODO(xiangli): no more reference operator for i := range ents { if err := w.saveEntry(\u0026amp;ents[i]); err != nil { return err } } if err := w.saveState(\u0026amp;st); err != nil { return err } curOff, err := w.tail().Seek(0, io.SeekCurrent) if err != nil { return err } if curOff \u0026lt; SegmentSizeBytes { if mustSync { // gofail: var walBeforeSync struct{} err = w.sync() // gofail: var walAfterSync struct{} return err } return nil } return w.cut() } MemoryStorageä¸­çš„[]Entryé‡‡ç”¨äº†dummy headçš„å®ç°æ–¹å¼ï¼Œå½“æ— å¿«ç…§æ—¶ï¼Œç¬¬ä¸€ä¸ªå­˜å‚¨ä¸€ä¸ªIndexã€Termå‡ä¸º0çš„Entryï¼Œè€Œå½“æœ‰å¿«ç…§æ—¶ï¼Œç¬¬ä¸€ä¸ªæ—¥å¿—å­˜å‚¨lastInclduedIndexå’ŒlastIncludedTermã€‚\né™¤æ­¤ä¹‹å¤–ï¼Œå‰©ä½™çš„é€»è¾‘éƒ½æ¯”è¾ƒç®€å•ï¼Œå¤§å¤šéƒ½æ˜¯åšä¸€äº›å¯¹é½ã€æˆªæ–­å’Œè¶Šç•Œçš„ç›¸å…³å¤„ç†\nraftLog raftLogçš„ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼Œå…¶ä¸­å°è£…äº†Storageå’Œunstableï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 type raftLog struct { // storage contains all stable entries since the last snapshot. storage Storage // unstable contains all unstable entries and snapshot. // they will be saved into storage. unstable unstable // committed is the highest log position that is known to be in // stable storage on a quorum of nodes. committed uint64 // applied is the highest log position that the application has // been instructed to apply to its state machine. // Invariant: applied \u0026lt;= committed applied uint64 logger Logger // maxNextEntsSize is the maximum number aggregate byte size of the messages // returned from calls to nextEnts. maxNextEntsSize uint64 } ç›¸å…³å‡½æ•°\nå‡½æ•° åŠŸèƒ½ maybeAppend åŒ¹é…Termå¹¶è§£å†³å†²çªä¹‹åå°†æ–°çš„æ—¥å¿—è¿½åŠ åˆ°unstableå½“ä¸­ findConflict æ ¹æ®ç»™å®šçš„[]Entryæ‰¾åˆ°å†²çªçš„ä½ç½® findConflictByTerm æ ¹æ®ç»™å®šçš„Termæ‰¾åˆ°å†²çªçš„ä½ç½®ï¼Œç”¨äºè¿›è¡Œå¿«é€Ÿå›é€€ nextEnts [committed + 1,applied]å³å½¢æˆäº†å…±è¯†ä½†æ˜¯è¿˜æœªäº¤ç»™ä¸Šå±‚å»æ‰§è¡Œçš„,å°†è¿™äº›è¿›è¡Œè¿”å› hasPendingSnapshot å³unstableã€æ–°äº§ç”Ÿçš„Snapshot commitTo commitä¹‹åæ›´æ–°çŠ¶æ€ appliedTo applyä¹‹åæ›´æ–°çŠ¶æ€ isUpToDate æ£€æŸ¥Termä¸Indexï¼Œåœ¨Leaderé€‰ä¸¾æ—¶è¿›è¡Œå®‰å…¨æ€§æ£€æŸ¥ matchTerm\\term å¯¹äºä¸å†²çªä¸”é¥±å«ã€ä¸å†²çªä½†ä¸åŒ…å«ã€å†²çªä¸”é¥±å«çš„ä¸‰ç§å½¢å¼è¿›è¡ŒåŒºåˆ† termå†²çªæ ¡éªŒ\nä¸»è¦é€šè¿‡ä¸€ä¸‹ä¸‰ä¸ªå‡½æ•°è¿›è¡Œå®ç°ï¼š\ntermï¼šé€šè¿‡ç»™å®šçš„Indexæ¥è·å–è¯¥Indexçš„Entryçš„Termï¼Œå¹¶ä¸”ä¼šåšè¾¹ç•Œæ£€æŸ¥ï¼Œå¦‚æœè¶…å‡ºèŒƒå›´çš„æƒ…å†µï¼Œåˆ™è¿”å›ä¸€ä¸ª0\nmatchTermæ¯”è¾ƒtermè¿”å›çš„termä¸ç»™å®štermæ˜¯å¦ç›¸åŒï¼Œå¦‚æœç›¸åŒåˆ™ä¸ºtrueï¼Œè€Œä¸‹å±‚è¶Šç•Œè®¿é—®ä¼šè¿”å›ä¸€ä¸ª0ï¼Œä»è€Œåœ¨è¿™é‡Œæ¯”è¾ƒå¾—åˆ°ä¸€ä¸ªfalse\nfindConflictï¼šåƒæ³¨é‡Šå½“ä¸­æ‰€è¯´çš„é‚£æ ·ï¼š\nå¦‚æœä¸å­˜åœ¨å†²çªï¼Œä¸”æ–°æ—¥å¿—å½“ä¸­æ‰€æœ‰çš„å†…å®¹å·²ç»è¢«åŸæœ¬æ—¥å¿—åŒ…å«ï¼Œæ— éœ€è¿›è¡Œä»»ä½•æ“ä½œï¼Œè¿”å›ä¸€ä¸ª0 å¦‚æœä¸å­˜åœ¨å†²çªï¼Œä½†æ˜¯æ–°æ—¥å¿—å½“ä¸­æœ‰æ—§æ—¥å¿—å½“ä¸­ä¸å­˜åœ¨å†…å®¹ï¼Œè¿”å›ç¬¬ä¸€æ¡ä¸å­˜åœ¨çš„Entryç”¨äºè¿½åŠ  å¦‚æœå­˜åœ¨å†²çªï¼Œåˆ™è¿”å›å†²çªçš„ç¬¬ä¸€ä¸ªIndex 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 func (l *raftLog) findConflict(ents []pb.Entry) uint64 { for _, ne := range ents { if !l.matchTerm(ne.Index, ne.Term) { if ne.Index \u0026lt;= l.lastIndex() { l.logger.Infof(\u0026#34;found conflict at index %d [existing term: %d, conflicting term: %d]\u0026#34;, ne.Index, l.zeroTermOnErrCompacted(l.term(ne.Index)), ne.Term) } // å¦‚æœä¸å­˜åœ¨å†²çªï¼Œä½†æ˜¯å­˜åœ¨æ–°çš„å†…å®¹ï¼Œæ— éœ€è¿›è¡Œè¦†ç›–ï¼Œå°†æ–°çš„å†…å®¹è¿½åŠ åˆ°åŸæœ¬çš„æ—¥å¿—ä¹‹å // æ–°çš„å†…å®¹åœ¨term()å½“ä¸­ä¼šå› ä¸ºè¶…èŒƒå›´è¿”å›0ï¼Œå› æ­¤matchTermä¼šè¿”å›falseï¼Œä½†æ˜¯æœ¬è´¨ä¸Šä¸å­˜åœ¨å†²çª // å¦‚æœå­˜åœ¨å†²çªï¼Œåˆ™è¿”å›å†²çªçš„ç¬¬ä¸€æ¡æ—¥å¿—ï¼Œä¹‹åè¿›è¡Œè¦†ç›–ã€‚ return ne.Index } } // æ–°æ—§æ—¥å¿—ä¸å­˜åœ¨å†²çªï¼Œå¹¶ä¸”æ—§æ—¥å¿—å½“ä¸­åŒ…å«äº†æ‰€æœ‰ç»™å®šçš„æ—¥å¿—ï¼Œæ— éœ€è¿›è¡Œæ·»åŠ ï¼Œè¿”å›0 return 0 } å¿«é€Ÿå›é€€\nå¿«é€Ÿå›é€€åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†ä¸ºåœ¨followerç«¯è¿›è¡Œå†²çªçš„æŸ¥è¯¢ï¼Œæ‰¾åˆ°äº§ç”Ÿå†²çªçš„ä½ç½®ä¹‹åè¿”å›ç»™Leaderï¼Œå¦ä¸€éƒ¨åˆ†åˆ™æ˜¯Leaderæ ¹æ®followerçš„hintè¿›è¡Œé‡æ–°å‘é€ï¼Œè¿™é‡Œåªçœ‹ä¸€ä¸‹æ—¥å¿—å±‚é¢çš„å®ç°findConflictByTermï¼Œfollowerå’ŒLeaderå‡ä¼šè°ƒç”¨è¯¥å‡½æ•°ï¼Œè€Œæ•´ä¸ªæµç¨‹ç•™åˆ°ä¹‹åå†è¿›è¡Œåˆ†æ\nå¦‚æœå‘é€æ¥çš„Indexï¼Œè¶…å‡ºäº†followerçš„èŒƒå›´ï¼Œæ— æ³•æ ¹æ®Termè¿›è¡Œæœç´¢ï¼Œwarning follower\\leaderåŒ…å«Indexï¼Œä¹‹åè¿›è¡Œtermçš„åŒ¹é… 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 func (l *raftLog) findConflictByTerm(index uint64, term uint64) uint64 { if li := l.lastIndex(); index \u0026gt; li { // followerçš„è¿›åº¦è¿‡æ—§ï¼Œå®Œå…¨ä¸åŒ…å«Leaderå‘é€è€Œæ¥çš„æ—¥å¿— // NB: such calls should not exist, but since there is a straightfoward // way to recover, do it. // // It is tempting to also check something about the first index, but // there is odd behavior with peers that have no log, in which case // lastIndex will return zero and firstIndex will return one, which // leads to calls with an index of zero into this method. l.logger.Warningf(\u0026#34;index(%d) is out of range [0, lastIndex(%d)] in findConflictByTerm\u0026#34;, index, li) return index } for { logTerm, err := l.term(index) if logTerm \u0026lt;= term || err != nil { break } index-- } return index } æ—¥å¿—è¿½åŠ \né€šè¿‡maybeAppendå’Œappendä¸¤ä¸ªå‡½æ•°è¿›è¡Œå®ç°ï¼Œappendä¸åšTermå†²çªæ ¡éªŒï¼Œåªæ˜¯ç®€å•çš„æ£€æŸ¥commitæƒ…å†µï¼Œå¹¶å°†æ—¥å¿—è¿½åŠ åˆ°unstableå½“ä¸­ï¼Œä½œä¸ºåº•å±‚è¢«maybeAppendè°ƒç”¨ã€‚\nmaybeAppendåˆ™ä¼šæ ¹æ®ä¼ å…¥çš„indexä¸Termè¿›è¡ŒåŒ¹é…ï¼Œå¹¶é€šè¿‡findConflictæ‰¾åˆ°å†²çªçš„ä½ç½®ï¼š\nå¦‚æœæ²¡æœ‰å†²çªä¹Ÿä¸å­˜åœ¨æ–°æ—¥å¿—ï¼Œåˆ™ä¸è¿›è¡Œä»»ä½•çš„å¤„ç† å¦‚æœåœ¨å·²ç»commitçš„æ—¥å¿—èŒƒå›´å†…äº§ç”Ÿå†²çªï¼Œå‡ºç°å¼‚å¸¸ï¼ŒPanic è€Œå¦‚æœæ˜¯ä¸€èˆ¬æƒ…å†µçš„å†²çªï¼Œå³åœ¨æœªcommitçš„åœ°æ–¹äº§ç”Ÿå†²çªï¼Œæˆ–è€…åªæ˜¯ä¼ å…¥çš„Entryå½“ä¸­æœ‰éœ€è¦è¿½åŠ çš„éƒ¨åˆ†ï¼Œåç§»ä¹‹åè°ƒç”¨appendè¿›è¡Œè¿½åŠ  maybeAppendç”±followerçš„handAppendEntriesè¿›è¡Œè°ƒç”¨ï¼Œå…¶ä¸­ä¼šæºå¸¦ç›®å‰Leaderçš„commitè¿›åº¦ï¼Œfollowerå¯¹å…¶è¿›è¡Œæ›´æ–°ã€‚followeræœ€æ–°çš„commitä¸ºmin(committed,lastnewi)\nä¸ºä»€ä¹ˆå–minï¼Ÿ\nå½“å‰çš„followerä¸ºä¸€ä¸ªè¾ƒä¸ºè½åçš„followerï¼ŒLeaderå·²ç»å’Œå…¶ä»–çš„followerå½¢æˆäº†å…±è¯†ï¼Œå¾—åˆ°äº†ä¸€ä¸ªcommittedçš„è¿›åº¦ï¼Œä½†æ˜¯è¿™ä¸ªè¿›åº¦è¿˜æœªå‘é€ç»™è¯¥followerï¼Œæ­¤æ—¶leaderç»™followerå¤åˆ¶æ—¥å¿—æ—¶ï¼Œå¦‚æœå¤åˆ¶çš„æ—¥å¿—æ¡ç›®è¶…è¿‡äº†å•ä¸ªæ¶ˆæ¯çš„ä¸Šé™ï¼Œåˆ™å¯èƒ½å‡ºç°leaderä¼ ç»™followerçš„committedå€¼å¤§äºè¯¥followerå¤åˆ¶å®Œè¿™æ¡æ¶ˆæ¯ä¸­çš„æ—¥å¿—åçš„æœ€å¤§indexï¼Œæ­¤æ—¶ï¼Œè¯¥followerçš„æ–°committedå€¼ä¸ºlastnewiã€‚ followerèƒ½å¤Ÿè·Ÿä¸Šleaderï¼Œleaderä¼ ç»™followerçš„æ—¥å¿—ä¸­æœ‰æœªç¡®è®¤è¢«æ³•å®šæ•°é‡èŠ‚ç‚¹ç¨³å®šå­˜å‚¨çš„æ—¥å¿—ï¼Œæ­¤æ—¶ä¼ å…¥çš„committedæ¯”lastnewiå°ï¼Œè¯¥followerçš„æ–°committedå€¼ä¸ºä¼ å…¥çš„committedå€¼ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 func (l *raftLog) maybeAppend(index, logTerm, committed uint64, ents ...pb.Entry) (lastnewi uint64, ok bool) { if l.matchTerm(index, logTerm) { lastnewi = index + uint64(len(ents)) ci := l.findConflict(ents) switch { case ci == 0: // æ²¡æœ‰å†²çªä¹Ÿæ²¡æœ‰æ–°æ—¥å¿—ï¼Œä¸å¤„ç† case ci \u0026lt;= l.committed: l.logger.Panicf(\u0026#34;entry %d conflict with committed entry [committed(%d)]\u0026#34;, ci, l.committed) default: offset := index + 1 // ä»äº§ç”Ÿå†²çªçš„æ–°æ—¥å¿—å¤„å¼€å§‹è¿›è¡Œè¦†ç›– l.append(ents[ci-offset:]...) } //ä¸ºä»€ä¹ˆå–minï¼Ÿ // 1. leaderç»™followerå¤åˆ¶æ—¥å¿—æ—¶ï¼Œå¦‚æœå¤åˆ¶çš„æ—¥å¿—æ¡ç›®è¶…è¿‡äº†å•ä¸ªæ¶ˆæ¯çš„ä¸Šé™ï¼Œ //åˆ™å¯èƒ½å‡ºç°leaderä¼ ç»™followerçš„committedå€¼å¤§äºè¯¥followerå¤åˆ¶å®Œè¿™æ¡æ¶ˆæ¯ä¸­çš„æ—¥å¿—åçš„æœ€å¤§index // æ­¤æ—¶ï¼Œè¯¥followerçš„æ–°committedå€¼ä¸ºlastnewiã€‚ // 2. followerèƒ½å¤Ÿè·Ÿä¸Šleaderï¼Œleaderä¼ ç»™followerçš„æ—¥å¿—ä¸­æœ‰æœªç¡®è®¤è¢«æ³•å®šæ•°é‡èŠ‚ç‚¹ç¨³å®šå­˜å‚¨çš„æ—¥å¿—ï¼Œ //æ­¤æ—¶ä¼ å…¥çš„committedæ¯”lastnewiå°ï¼Œè¯¥followerçš„æ–°committedå€¼ä¸ºä¼ å…¥çš„committedå€¼ã€‚ l.commitTo(min(committed, lastnewi)) return lastnewi, true } return 0, false } è¿›åº¦è·Ÿè¸ª RaftåŸæ–‡å½“ä¸­ä½¿ç”¨nextIndex[] matchIndex[]è¿›è¡Œè¿½è¸ªfollowerçš„æ—¥å¿—è¿›åº¦ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 if args.Term == rf.currentTerm { if reply.Success { // å‘é€æˆåŠŸåˆ™ä¸ºå‘é€çš„æ‰€æœ‰æ—¥å¿—æ¡ç›®å…¨éƒ¨åŒ¹é…ï¼Œmatchç›´æ¥åŠ ä¸Šlen(Entries) // next æ°¸è¿œç­‰äºmatch + 1 match := args.PrevLogIndex + len(args.LogEntries) next := match + 1 rf.commitIndex = rf.lastIncludedIndex rf.matchIndex[server] = match rf.nextIndex[server] = next Debug(dLog2, \u0026#34;S%d update server is %d nextIndex:%d lastIncludedIndex is:%d preLogIndex is %d lenLog is %d\u0026#34;, rf.me, server, next, rf.lastIncludedIndex, args.PrevLogIndex, len(args.LogEntries)) } åœ¨etcd/raftå½“ä¸­ï¼Œä¸ºäº†å®ç°èŠ‚è—•ï¼Œå•ç‹¬å°è£…äº†ä¸€ä¸ªProgressç»“æ„ä½“ç”¨äºè®°å½•åœ¨Leaderçš„è§†è§’ä¸‹ï¼Œfollowerå¤„äºä½•ç§è¿›åº¦ã€‚æœ€ç»ˆåœ¨Leaderå¤„ç»´æŠ¤ä¸€ä¸ª []progressæ•°ç»„æ¥è¡¨ç¤ºå½“å‰æ‰€æœ‰çš„followerçš„è¿›åº¦ï¼Œprogressç»“æ„ä½“çš„å®šä¹‰å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 type Progress struct { Match, Next uint64 // State defines how the leader should interact with the follower. // // When in StateProbe, leader sends at most one replication message // per heartbeat interval. It also probes actual progress of the follower. // // When in StateReplicate, leader optimistically increases next // to the latest entry sent after sending replication message. This is // an optimized state for fast replicating log entries to the follower. // // When in StateSnapshot, leader should have sent out snapshot // before and stops sending any replication message. State StateType // PendingSnapshot is used in StateSnapshot. // If there is a pending snapshot, the pendingSnapshot will be set to the // index of the snapshot. If pendingSnapshot is set, the replication process of // this Progress will be paused. raft will not resend snapshot until the pending one // is reported to be failed. PendingSnapshot uint64 // RecentActive is true if the progress is recently active. Receiving any messages // from the corresponding follower indicates the progress is active. // RecentActive can be reset to false after an election timeout. // // TODO(tbg): the leader should always have this set to true. RecentActive bool // ProbeSent is used while this follower is in StateProbe. When ProbeSent is // true, raft should pause sending replication message to this peer until // ProbeSent is reset. See ProbeAcked() and IsPaused(). ProbeSent bool // Inflights is a sliding window for the inflight messages. // Each inflight message contains one or more log entries. // The max number of entries per message is defined in raft config as MaxSizePerMsg. // Thus inflight effectively limits both the number of inflight messages // and the bandwidth each Progress can use. // When inflights is Full, no more message should be sent. // When a leader sends out a message, the index of the last // entry should be added to inflights. The index MUST be added // into inflights in order. // When a leader receives a reply, the previous inflights should // be freed by calling inflights.FreeLE with the index of the last // received entry. Inflights *Inflights // IsLearner is true if this progress is tracked for a learner. IsLearner bool } å­—æ®µ ä½œç”¨ Matchã€Next å¯¹åº”åŸæœ¬Raftè®ºæ–‡å½“ä¸­çš„MatchIndex[]ä¸NextIndex[]ï¼Œè¡¨ç¤ºfollowerå½“å‰çš„è¿›åº¦ State å½“å‰followerçš„çŠ¶æ€ï¼Œå†³å®šLeaderä»¥ä½•ç§æ–¹å¼ä¸followerè¿›è¡Œé€šè®¯ PendingSnapshot å¯¹åº”åœ¨raftlogå½“ä¸­çš„PendingSnapshotï¼Œåœ¨StateSnapshoté˜¶æ®µä¸‹ä½¿ç”¨ RecentActive Check Quorumæ—¶ä½¿ç”¨çš„å­—æ®µï¼Œè¡¨ç¤ºå½“å‰çš„followeræ˜¯å¦å¤„äºæ´»è·ƒçŠ¶æ€ ProbeSent StateProbeçŠ¶æ€ä¸‹ç”¨äºé˜»å¡å‘é€ learner è¡¨ç¤ºå½“å‰èŠ‚ç‚¹æ˜¯å¦å¤„äºlearnerçŠ¶æ€ ä¸»è¦æ¥çœ‹ä¸€ä¸‹Stateä¸PendingSnapshotï¼Œå¯¹äºStateï¼Œåœ¨etcdçš„æ³¨è§†å½“ä¸­æè¿°çš„ä¹Ÿéå¸¸æ˜ç¡®ï¼š\nProbeæ‰€è¡¨ç¤ºçš„ä¸ºLeaderï¼Œå¯¹äºå½“å‰followerçš„æœ€åä¸€æ¡æ—¥å¿—çš„Indexå¹¶ä¸çŸ¥æ™“ï¼Œå¯èƒ½æ˜¯followerå®•æœºè®¸ä¹…ä¹‹åé‡å¯ã€‚æ­¤æ—¶åœ¨Leaderæ–¹é¢ï¼Œå°†å…¶è§†ä¸ºProbeçŠ¶æ€ï¼Œåœ¨è¿™ç§çŠ¶æ€ä¸‹ï¼Œleaderæ¯æ¬¡å¿ƒè·³æœŸé—´ä»…ä¸ºfollowerå‘é€ä¸€æ¡MsgAppâ€‹æ¶ˆæ¯ï¼Œä¹‹åè¾¹ç«‹å³é™·å…¥é˜»å¡çŠ¶æ€ï¼Œç­‰å¾…followerçš„å›åº”ä¹‹åæ‰ä¼šé‡æ–°ä»é˜»å¡å½“ä¸­æ¢å¤ StateReplicateè¡¨ç¤ºå½“å‰çš„followerèƒ½å¤Ÿæ­£ç¡®çš„è·Ÿéšä½Leaderçš„è¿›åº¦ï¼Œæ­¤æ—¶å¯ä»¥æŒ‰ç…§æµæ°´çº¿çš„å½¢å¼ä¸æ–­çš„ç»™Followerå‘é€æ¶ˆæ¯ï¼Œå¯ä»¥é‡‡å–æ¯”è¾ƒæ¿€è¿›çš„ä¼˜åŒ–æ–¹å¼ç›´æ¥å¯¹Leaderçš„ä¿¡æ¯è¿›è¡Œæ›´æ–° StateSnapshotè¡¨ç¤ºå½“å‰çš„followerå·²ç»è½åLeaderè¿‡å¤šï¼Œæ‰€éœ€çš„æ—¥å¿—å·²ç»è¢«å¿«ç…§åŒ–ï¼Œæ­¤æ—¶æ‰€éœ€è¦çš„å°±æ˜¯å‘é€å¿«ç…§ã€‚ çŠ¶æ€è½¬æ¢ åˆå§‹çŠ¶æ€\næ¥ä¸‹æ¥è®¨è®ºä¸€ä¸‹Progresså½“ä¸­çš„Stateå¦‚ä½•è¿›è¡ŒçŠ¶æ€è½¬æ¢\nå½“ä¸€ä¸ªèŠ‚ç‚¹å‘ç”ŸçŠ¶æ€è½¬æ¢æ—¶ï¼Œï¼ˆè¿™é‡Œçš„çŠ¶æ€è½¬æ¢æŒ‡çš„æ˜¯Leaderã€Followerã€Candidateï¼‰ä¼šè°ƒç”¨Resetå‡½æ•°ï¼Œåœ¨å…¶ä¸­éå†æ‰€æœ‰çš„èŠ‚ç‚¹ï¼Œå¯¹å…¶è¿›è¡Œåˆå§‹åŒ–ï¼Œè€Œç”±äºStateTypeå®šä¹‰ä¸ºuint64â€‹ç±»å‹çš„å­—æ®µï¼Œå› æ­¤åˆå§‹åŒ–ä¸º0ï¼Œå³StateProbeï¼Œè¿™æ ·çš„åšæ³•ä¹Ÿè¯´å¾—é€šï¼Œå½“ä¸€ä¸ªLeaderåˆšé€šè¿‡é€‰ä¸¾ä¸Šçº¿æ—¶ï¼Œä»–å¯¹å…¶ä»–èŠ‚ç‚¹çš„çŠ¶æ€æ˜¯ä¸æ¸…æ¥šçš„ï¼Œå…ˆå°†å…¶ä»–çš„æ‰€æœ‰çš„followerçš„çŠ¶æ€è®¾ç½®ä¸ºStateProbeâ€‹å› æ­¤åœ¨å‘é€æ—¶å…ˆæ¢æµ‹followerçš„LastIndexã€‚è€Œä¹‹åä¼šåœ¨``becomeLeader å½“ä¸­å°†è‡ªèº«çš„çŠ¶æ€è®¾ç½®ä¸ºStateReplicateâ€‹\n1 2 3 4 5 6 7 8 9 10 11 r.prs.Visit(func(id uint64, pr *tracker.Progress) { *pr = tracker.Progress{ Match: 0, Next: r.raftLog.lastIndex() + 1, Inflights: tracker.NewInflights(r.prs.MaxInflight), IsLearner: pr.IsLearner, } if id == r.id { pr.Match = r.raftLog.lastIndex() } }) 1 2 3 4 5 func(r *raft) becomeLeader() { // ... r.prs.Progress[r.id].BecomeReplicate() // ... } StateProbe -\u0026gt;StateReplicate\nè€Œå½“followerèƒ½å¤Ÿæ­£ç¡®çš„è·ŸéšLeaderçš„è¿›åº¦æ—¶ï¼Œå°±å¯ä»¥ä»SateProbeè½¬å‘StateReplicateè¿›è¡Œå¿«é€Ÿçš„è·Ÿéšå¤åˆ¶ï¼Œå› æ­¤åœ¨Leaderæ¥æ”¶åˆ°MsgAppRespæ—¶ï¼Œå¹¶ä¸”å½“ä¸­çš„rejectä¸ºfalseæ—¶ï¼Œå¹¶ä¸”è¯¥æ¡æ¶ˆæ¯ä¸ºä¸€ä¸ªéè¿‡å¤±çš„æ¶ˆæ¯æ—¶ï¼Œè°ƒç”¨becomeReplicateâ€‹è¿›è¡ŒçŠ¶æ€è½¬æ¢ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 if (m.reject) { // ... } else { if pr.MaybeUpdate(m.Index) { switch { case pr.State == tracker.StateProbe: // åœ¨ProbeçŠ¶æ€ä¸‹ï¼ŒfolloweræˆåŠŸæ¥æ”¶åˆ°Leaderå‘é€çš„RPCå¹¶ä¸”æˆåŠŸç»™äºˆå›åº” // æ­¤æ—¶Leaderå¯ä»¥ç¡®è®¤followerå¯ä»¥è·Ÿä¸Šè¿›åº¦ï¼Œå› æ­¤å–æ¶ˆé˜»å¡ï¼Œå¹¶ä¸”è½¬å˜ä¸ºæµæ°´çº¿ // æ¨¡å¼ä¼˜åŒ–å‘é€é€Ÿåº¦ pr.BecomeReplicate() } } å…¶ä¸­MaybeUpdateç”¨äºåˆ¤æ–­å½“å‰çš„æ¶ˆæ¯æ˜¯å¦ä¸ºä¸€æ¡è¿‡æ—¶çš„æ¶ˆæ¯ï¼Œå¹¶æ›´æ–°çŠ¶æ€ã€‚å³å·²ç»è¿”å›çš„Indexå·²ç»æ˜¯Matchä¹‹åäº†çš„ï¼Œå¯¹äºè¿‡æœŸçš„æ¶ˆæ¯ï¼Œå¯¹å…¶è¿›è¡Œå¿½ç•¥\n1 2 3 4 5 6 7 8 9 10 func (pr *Progress) MaybeUpdate(n uint64) bool { var updated bool if pr.Match \u0026lt; n { pr.Match = n updated = true pr.ProbeAcked() } pr.Next = max(pr.Next, n+1) return updated } StateReplicate -\u0026gt; StateProbe\nå³åŸæœ¬Followerèƒ½å¤Ÿç´§éšLeaderçš„è¿›åº¦ï¼Œä¹‹åå¦‚æœå­˜åœ¨ç½‘ç»œæ•…éšœæˆ–è€…æ¶ˆæ¯åœ¨ç½‘ç»œä¸­ä¹±åºå‘é€ï¼ŒFolloweræ— æ³•ä¸Leaderçš„è¿›åº¦è¿›è¡Œå¯¹é½ï¼Œä¼šè¿”å›Leaderä¸€ä¸ªrejectå’ŒrejectHintï¼Œç”¨äºè¿›è¡Œfast backupï¼Œæ­¤æ—¶å°±ä»£è¡¨Followerå·²ç»æ— æ³•ç´§éšLeaderçš„æ—¥å¿—è¿›åº¦äº†ï¼Œéœ€è¦ä»Replicateå‘Probeè¿›è¡Œè½¬æ¢ï¼š\n1 2 3 4 5 6 7 8 9 10 11 if (m.reject) { // å¦‚æœå›é€€å¤±è´¥åˆ™è¯´æ˜ä¸ºä¸€æ¡è¿‡æœŸçš„æ—¥å¿—ï¼Œä¸åšå¤„ç† // å¦‚æœå›é€€æˆåŠŸï¼Œå¹¶ä¸”å¯¹æ–¹åŸæœ¬ä¸ºStateReplicateï¼Œè½¬æ¢ä¸ºProbeè¿›è¡Œæ¢æµ‹ï¼Œå¹¶ä¸”å†å‘å…¶å‘é€ä¸€æ¬¡MsgApp if pr.MaybeDecrTo(m.Index, nextProbeIdx) { r.logger.Debugf(\u0026#34;%x decreased progress of %x to [%s]\u0026#34;, r.id, m.From, pr) if pr.State == tracker.StateReplicate { pr.BecomeProbe() } r.sendAppend(m.From) } } é™¤æ­¤ä¹‹å¤–ï¼Œ è¿˜åœ¨å¤„ç†MsgUnreachableå½“ä¸­ä»StateReplicateè½¬æ¢ä¸ºProbeï¼Œæš‚æ—¶æ²¡å¤ªå¼„æ˜ç™½è°ƒç”¨çš„æ—¶æœºï¼Œä¸è¿‡ä¸ªäººçŒœæµ‹æ˜¯å½“followeré•¿æ—¶é—´æœªå“åº”Leaderçš„è°ƒç”¨ï¼Œå°±ä¼šæ·»åŠ ä¸€æ¡MsgUnreachableçš„æ¶ˆæ¯ï¼Œæ¥è¡¨ç¤ºFolloweré•¿æœŸæ”¶ä¸åˆ°Leaderçš„æ¶ˆæ¯ï¼Œè½¬æ¢åˆ°ProbeçŠ¶æ€\nStateProbe -\u0026gt; StateSnapshot \u0026amp; StateReplicate -\u0026gt; StateSnapshot\nè¿›å…¥åˆ°StateSnapshotâ€‹å½“ä¸­çš„æƒ…å†µéå¸¸ç®€å•ï¼Œä¸åŒºåˆ†çŠ¶æ€ï¼Œåªè¦åœ¨Leaderè¦å‘é€AppendEntriesæ—¶å‘ç°è‡ªå·±åº”å½“å‘é€ç»™å¯¹æ–¹çš„æ—¥å¿—å·²ç»è¢«å¿«ç…§åŒ–ï¼Œæ­¤æ—¶å°±è½¬å˜ä¸ºStateSnapshotâ€‹ å¼€å§‹å‘é€å¿«ç…§ï¼Œè¿™ä¸ªæƒ…å†µåœ¨StateProbeâ€‹ä¸StateReplicateâ€‹çš„çŠ¶æ€ä¸‹å‡æœ‰å¯èƒ½å‘ç”Ÿï¼Œå°¤å…¶æ˜¯StateProbeâ€‹ çŠ¶æ€ä¸‹ï¼Œæ›´å®¹æ˜“å‡ºç°Leaderä¸Followerä¹‹é—´çš„å·®è·è¿‡å¤§ï¼Œä»è€Œè¦å‘é€ç»™Followerçš„æ—¥å¿—è¢«å¿«ç…§åŒ–çš„æƒ…å†µã€‚\nStateSnapshot -\u0026gt; StateReplicate\nåœ¨StateSnapshotâ€‹çš„çŠ¶æ€ä¸‹ï¼Œå¦‚æœå¦‚æœéœ€è¦å‘é€çš„Snapshotåœ¨Followerçš„è¿›åº¦å·²ç»åŒ¹é…ä¸Šï¼Œæ­¤æ—¶å°±å¯ä»¥è½¬æ¢ä¸ºStateReplicateâ€‹è¿›è¡Œå¿«é€Ÿå‘é€\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 if pr.MaybeUpdate(m.Index) { switch { case pr.State == tracker.StateProbe: // åœ¨ProbeçŠ¶æ€ä¸‹ï¼ŒfolloweræˆåŠŸæ¥æ”¶åˆ°Leaderå‘é€çš„RPCå¹¶ä¸”æˆåŠŸç»™äºˆå›åº” // æ­¤æ—¶Leaderå¯ä»¥ç¡®è®¤followerå¯ä»¥è·Ÿä¸Šè¿›åº¦ï¼Œå› æ­¤å–æ¶ˆé˜»å¡ï¼Œå¹¶ä¸”è½¬å˜ä¸ºæµæ°´çº¿ // æ¨¡å¼ä¼˜åŒ–å‘é€é€Ÿåº¦ pr.BecomeReplicate() case pr.State == tracker.StateSnapshot \u0026amp;\u0026amp; pr.Match \u0026gt;= pr.PendingSnapshot: // TODO(tbg): we should also enter this branch if a snapshot is // received that is below pr.PendingSnapshot but which makes it // possible to use the log again. r.logger.Debugf(\u0026#34;%x recovered from needing snapshot, resumed sending replication messages to %x [%s]\u0026#34;, r.id, m.From, pr) // Transition back to replicating state via probing state // (which takes the snapshot into account). If we didn\u0026#39;t // move to replicating state, that would only happen with // the next round of appends (but there may not be a next // round for a while, exposing an inconsistent RaftStatus). pr.BecomeProbe() pr.BecomeReplicate() StateSnapshot -\u0026gt; StateProbe\nåœ¨Leaderå¤„ç†SnapshotStatusæ¶ˆæ¯æ—¶ï¼Œå¦‚æœå½“å‰çš„çŠ¶æ€ä¸ºStateSnapshotï¼Œåˆ™ä¼šè½¬æ¢ä¸ºStateProbeï¼Œ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 case pb.MsgSnapStatus: if pr.State != tracker.StateSnapshot { return nil } // TODO(tbg): this code is very similar to the snapshot handling in // MsgAppResp above. In fact, the code there is more correct than the // code here and should likely be updated to match (or even better, the // logic pulled into a newly created Progress state machine handler). if !m.Reject { pr.BecomeProbe() r.logger.Debugf(\u0026#34;%x snapshot succeeded, resumed sending replication messages to %x [%s]\u0026#34;, r.id, m.From, pr) } else { // NB: the order here matters or we\u0026#39;ll be probing erroneously from // the snapshot index, but the snapshot never applied. pr.PendingSnapshot = 0 pr.BecomeProbe() r.logger.Debugf(\u0026#34;%x snapshot failed, resumed sending replication messages to %x [%s]\u0026#34;, r.id, m.From, pr) } è€Œè¯¥æ¶ˆæ¯æ˜¯ç”±Nodeå½“ä¸­çš„ReportSnapshotâ€‹æ–¹æ³•è¿›è¡Œå°è£…çš„,ä¸è¿‡è¯¥æ–¹æ³•åœ¨raft-exampleå½“ä¸­å¹¶æ²¡æœ‰è°ƒç”¨ï¼ŒçœŸæ­£çš„è°ƒç”¨ä½äºetcd/serverå½“ä¸­ï¼Œç”¨æ³•ä¸ºï¼šleaderèŠ‚ç‚¹çš„ä½¿ç”¨è€…è¿˜éœ€è¦ä¸»åŠ¨è°ƒç”¨Nodeâ€‹çš„ReportSnapshotâ€‹æ–¹æ³•å‘ŠçŸ¥leaderèŠ‚ç‚¹å¿«ç…§çš„åº”ç”¨çŠ¶æ€ï¼Œleaderä¼šå°†è¯¥followerçš„çŠ¶æ€è½¬ç§»åˆ°StateProbeâ€‹çŠ¶æ€ï¼Œæš‚æ—¶ä¸è¿›è¡Œå±•å¼€\nä»¥ä¸Šå°±æ˜¯æ¶‰åŠåˆ°çš„æ‰€æœ‰çš„çŠ¶æ€åˆ‡æ¢é—®é¢˜ï¼Œå¯ä»¥æ€»ç»“å¦‚ä¸‹ï¼š\næœ€åå†åˆ—ä¸€ä¸‹å„ä¸ªçŠ¶æ€è½¬ç§»çš„å‡½æ•°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 // BecomeProbe transitions into StateProbe. Next is reset to Match+1 or, // optionally and if larger, the index of the pending snapshot. func (pr *Progress) BecomeProbe() { // If the original state is StateSnapshot, progress knows that // the pending snapshot has been sent to this peer successfully, then // probes from pendingSnapshot + 1. if pr.State == StateSnapshot { pendingSnapshot := pr.PendingSnapshot pr.ResetState(StateProbe) pr.Next = max(pr.Match+1, pendingSnapshot+1) } else { pr.ResetState(StateProbe) pr.Next = pr.Match + 1 } } // BecomeReplicate transitions into StateReplicate, resetting Next to Match+1. func (pr *Progress) BecomeReplicate() { pr.ResetState(StateReplicate) pr.Next = pr.Match + 1 } // BecomeSnapshot moves the Progress to StateSnapshot with the specified pending // snapshot index. func (pr *Progress) BecomeSnapshot(snapshoti uint64) { pr.ResetState(StateSnapshot) pr.PendingSnapshot = snapshoti } Progresså‡½æ•° ç°åœ¨å›åˆ°ä¸»çº¿ç»§ç»­åˆ†æProgressçš„ç›¸å…³å‡½æ•°ï¼š\nIsPaused:\nå¯¹äºä¸‰ç§çŠ¶æ€ï¼Œå‡å­˜åœ¨ä¸åŒçš„é˜»å¡æ¡ä»¶ï¼š\nStateProbeä¸‹ï¼Œå‘é€å®Œä¸€æ¡æ—¥å¿—ä¹‹åæ‰‹åŠ¨è®¾ç½®Probe = trueâ€‹,ä¹‹åå¦‚æœæ£€æµ‹åˆ°trueä¹‹åå°±ä¼šåœ¨IsPausedå½“ä¸­é˜»å¡ StateReplicateä¸‹ï¼Œå¦‚æœå½“å‰çš„æ»‘åŠ¨çª—å£ï¼Œæˆ–è€…è¯´æ¶ˆæ¯é˜Ÿåˆ—å·²æ»¡çš„è¯ï¼Œåˆ™é˜»å¡ StateSnapshotä¸‹ï¼Œå¯¹äºç›¸åŒçš„å¿«ç…§ï¼Œåªåº”å‘å¯¹æ–¹å‘é€ä¸€æ¬¡ï¼Œè€Œå¯¹æ–¹å¦‚æœæ”¶åˆ°ä¹‹åå°±ä¼šè„±ç¦»StateSnapshot(è°ƒç”¨Node.ReportSnapshot)ï¼Œå› æ­¤åœ¨StateSanpshotä¸‹åº”å½“æ— æ¡ä»¶é˜»å¡ 1 2 3 4 5 6 7 8 9 10 11 12 func (pr *Progress) IsPaused() bool { switch pr.State { case StateProbe: return pr.ProbeSent case StateReplicate: return pr.Inflights.Full() case StateSnapshot: return true default: panic(\u0026#34;unexpected state\u0026#34;) } } ProbeAcked:\nStateProbeçŠ¶æ€ä¸‹ç¡®è®¤å›åº”ï¼Œè„±ç¦»é˜»å¡\n1 2 3 4 5 6 // ProbeAcked is called when this peer has accepted an append. It resets // ProbeSent to signal that additional append messages should be sent without // further delay. func (pr *Progress) ProbeAcked() { pr.ProbeSent = false } MaybeUpdate:\nåœ¨æ”¶åˆ°AppMsgRespä¹‹åè°ƒç”¨ï¼Œå¯¹æ—¥å¿—Matchçš„è¿›åº¦è¿›è¡Œæ›´æ–°ï¼Œå¹¶ä¸”è°ƒç”¨ProbeAckedè¡¨ç¤ºæ¥æ”¶åˆ°å“åº”è§£é™¤é˜»å¡ã€‚æ­¤å¤–ï¼Œåœ¨AppendEntrieså½“ä¸­ä¹Ÿä¼šè¿›è¡Œè°ƒç”¨ï¼Œå¯¹Leaderè‡ªèº«å¯¹matchè¿›è¡Œæ›´æ–°\n1 2 3 4 5 6 7 8 9 10 11 12 13 // MaybeUpdate is called when an MsgAppResp arrives from the follower, with the // index acked by it. The method returns false if the given n index comes from // an outdated message. Otherwise it updates the progress and returns true. func (pr *Progress) MaybeUpdate(n uint64) bool { var updated bool if pr.Match \u0026lt; n { pr.Match = n updated = true pr.ProbeAcked() } pr.Next = max(pr.Next, n+1) return updated } MaybeDecrTo:\nåœ¨æ”¶åˆ°Followerå‘æ¥çš„MsgAppRespä¹‹åï¼Œå¦‚æœå½“ä¸­çš„rejectä¸ºtrueï¼Œé‚£ä¹ˆå°±æ ¹æ®è¿”å›çš„rejectHintè¿›è¡Œå¿«é€Ÿå›é€€\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 // MaybeDecrTo adjusts the Progress to the receipt of a MsgApp rejection. The // arguments are the index of the append message rejected by the follower, and // the hint that we want to decrease to. // // Rejections can happen spuriously as messages are sent out of order or // duplicated. In such cases, the rejection pertains to an index that the // Progress already knows were previously acknowledged, and false is returned // without changing the Progress. // // If the rejection is genuine, Next is lowered sensibly, and the Progress is // cleared for sending log entries. func (pr *Progress) MaybeDecrTo(rejected, matchHint uint64) bool { if pr.State == StateReplicate { // The rejection must be stale if the progress has matched and \u0026#34;rejected\u0026#34; // is smaller than \u0026#34;match\u0026#34;. if rejected \u0026lt;= pr.Match { return false } // Directly decrease next to match + 1. // // TODO(tbg): why not use matchHint if it\u0026#39;s larger? pr.Next = pr.Match + 1 return true } // æ¢æµ‹æ¨¡å¼ä¸€ä¸ªå¿ƒè·³å‘¨æœŸåªèƒ½å‘é€ä¸€æ¬¡Entryï¼Œå¦‚æœpr.Next - 1 != rejectedåˆ™è¯æ˜å‘é€çš„æ—¶å€™ // å‡ºç°é”™è¯¯ï¼Œåˆ™è¯æ˜å…¶ä¸æ˜¯è¿™ä¸ªå¿ƒè·³å‘¨æœŸå‘é€å‡ºå»çš„ä¿¡æ¯ // The rejection must be stale if \u0026#34;rejected\u0026#34; does not match next - 1. This // is because non-replicating followers are probed one entry at a time. if pr.Next-1 != rejected { return false } pr.Next = max(min(rejected, matchHint+1), 1) pr.ProbeSent = false return true } Tracker åœ¨Progressç»“æ„ä½“ä¹‹ä¸Šï¼Œè¿˜å°è£…äº†ä¸€ä¸ªPorgressTrackerâ€‹ï¼Œå®šä¹‰åœ¨tracker.goâ€‹å½“ä¸­ï¼Œå°è£…äº†ä¸€äº›å¯¹äºProgressMapçš„é›†ä½“æ“ä½œï¼Œè®°å½•å½“å‰æ‰€æœ‰èŠ‚ç‚¹çš„çŠ¶æ€ä¸è¿›åº¦ï¼Œå’Œå½“å‰é›†ç¾¤æ­£åœ¨ä½¿ç”¨çš„é…ç½®ä¿¡æ¯ã€‚å¹¶ä¸”å…³äºæŠ•ç¥¨çš„ç›¸å…³ä¿¡æ¯ä¹Ÿåœ¨è¿™å…¶ä¸­è¿›è¡Œæ›´æ–°ä¸è®°å½•ï¼Œå…¶ä¸­çš„æ“ä½œå¹¶ä¸å¤æ‚ï¼Œæš‚æ—¶ä¸åšå±•å¼€\n1 2 3 4 5 6 7 8 9 10 11 12 // ProgressTracker tracks the currently active configuration and the information // known about the nodes and learners in it. In particular, it tracks the match // index for each peer which in turn allows reasoning about the committed index. type ProgressTracker struct { Config Progress ProgressMap Votes map[uint64]bool MaxInflight int } ectd/raftæ—¥å¿—å¤åˆ¶ èŠ‚ç‚¹èº«ä»½ç¡®è®¤ åœ¨ä¸€ä¸ªé›†ç¾¤å¯åŠ¨ä¹‹åï¼Œé¦–å…ˆä¼šé€šè¿‡becomeFollowerâ€‹å…¨éƒ¨åˆå§‹åŒ–ä¸ºfollowerï¼Œä¹‹åè¶…æ—¶é€šè¿‡becomeCandidateâ€‹å¼€å§‹é€‰ä¸¾ï¼Œæœ€åbecomeLeaderâ€‹å½“é€‰ã€‚åœ¨è¿™ä¸ªä¸‰ä¸ªå‡½æ•°å½“ä¸­å‡ä½¿ç”¨resetâ€‹å¯¹è‡ªèº«çŠ¶æ€è¿›è¡Œé‡ç½®ï¼Œä¹‹åLeaderå†å°†è‡ªèº«çš„è®¾ç½®ä¸ºStateReplicateï¼Œä½†æ˜¯è¿™ä¸ªè®¾ç½®å¹¶ä¸æ˜¯å¾ˆé‡è¦ï¼ŒLeaderä¸»è¦æ ¹æ®Followerçš„Stateå»è¿›è¡Œç›¸å…³çš„é€»è¾‘æ“ä½œï¼Œè¿™é‡Œæ›´åƒæ˜¯è®©å…¶åœ¨é€»è¾‘ä¸Šé€šé¡ºï¼Œè€Œæ²¡æœ‰ä»€ä¹ˆå®è´¨æ€§ä½œç”¨\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 func (r *raft) reset(term uint64) { // ... r.prs.ResetVotes() r.prs.Visit(func(id uint64, pr *tracker.Progress) { *pr = tracker.Progress{ Match: 0, Next: r.raftLog.lastIndex() + 1, Inflights: tracker.NewInflights(r.prs.MaxInflight), IsLearner: pr.IsLearner, } if id == r.id { pr.Match = r.raftLog.lastIndex() } }) } func (r *raft) becomeLeader() { // ... r.prs.Progress[r.id].BecomeReplicate() // ... } ä¹‹åæ‰€æœ‰çš„é€»è¾‘ä¾æ—§åƒé€‰ä¸¾é‚£æ ·éƒ½åœ¨Stepå½“ä¸­å¤„ç†ï¼Œé¦–å…ˆStepè¿›è¡Œé€šç”¨å¤„ç†ä¹‹åå†è°ƒç”¨å¯¹åº”Stepxxxâ€‹ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹å½“ä¸­è§¦å‘äº†æ—¥å¿—å¤åˆ¶çš„å„ç§æ“ä½œ,ä¸è¿‡åœ¨è¿™ä¸ªè¿‡ç¨‹å½“ä¸­ç”±äºå¯¹äºæ—¥å¿—çš„æ“ä½œåœ¨å„ä¸ªè§’è‰²ç¨»ç§ä¸å°½ç›¸åŒï¼Œå› æ­¤Stepå½“ä¸­æ²¡æœ‰æ¶‰åŠåˆ°æ—¥å¿—ç›¸å…³çš„æ“ä½œï¼Œç›´æ¥çœ‹stepxxxï¼Œè¿™é‡Œå¦‚æœåˆ†stepè¿›è¡Œè®¨è®ºéš¾å…ä¼šæœ‰äº›å‰²è£‚ï¼Œå› æ­¤ä¸å¦‚ä»æŸä¸ªStepå…¥æ‰‹ï¼Œå»åˆ†æå‘é€å’Œæ¥æ”¶çš„æ•´ä¸ªè¿‡ç¨‹ã€‚\nå¿ƒè·³ç›¸å…³æ¶ˆæ¯å¤„ç† é€šè¿‡Leaderçš„tickHeartbeatè§¦å‘è°ƒç”¨ï¼Œå¤„ç†çš„é€»è¾‘ä¹Ÿæ¯”è¾ƒçš„ç®€å•ï¼Œåªéœ€è¦ç”Ÿæˆä¸€æ¡MsgHeartbeatå¹¿æ’­ç»™æ‰€æœ‰çš„followerï¼Œå½“ä¸­æºå¸¦äº†ä¸€æ¡commitedå­—æ®µï¼Œå¹¶ä¸”å–äº†min(pr.match,leader.committed)â€‹,åœ¨Raftè®ºæ–‡æˆ–è€…å¯¹åº”çš„å®ç°MIT6.824å½“ä¸­ï¼ŒHeartbeatåªè¦æ±‚äº†ä»¤followerå»é‡ç½®è¶…æ—¶æ—¶é—´ï¼Œè·ŸéšLeaderã€‚\nè€Œåœ¨ectd/raftå½“ä¸­ï¼Œå¯ä»¥é¡ºå¸¦æ›´æ–°followerçš„committedè¿›åº¦ï¼Œå–minä¹Ÿæ˜¯ä¸ºäº†é˜²æ­¢followerçš„è¿›åº¦è½åäºleaderï¼Œè¿˜æœªè·å–åˆ°leaderæœ€æ–°çš„æ—¥å¿—ï¼Œå¦‚æœå‘é€çš„ä¸ºmatchï¼Œåˆ™ä»£è¡¨å°†followerå½“å‰æ‰€æœ‰çš„æ—¥å¿—å…¨éƒ¨è®¾ç½®ä¸ºcommittedã€‚å¹¶ä¸”followerå¹¶ä¸éœ€è¦ç»´æŠ¤progressï¼Œå› æ­¤åªéœ€è¦æ›´æ–°æ—¥å¿—å½“ä¸­çš„committedè¿›åº¦å³å¯\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 func (r *raft) bcastHeartbeat() { lastCtx := r.readOnly.lastPendingRequestCtx() if len(lastCtx) == 0 { r.bcastHeartbeatWithCtx(nil) } else { r.bcastHeartbeatWithCtx([]byte(lastCtx)) } } // sendHeartbeat sends a heartbeat RPC to the given peer. func (r *raft) sendHeartbeat(to uint64, ctx []byte) { // Attach the commit as min(to.matched, r.committed). // When the leader sends out heartbeat message, // the receiver(follower) might not be matched with the leader // or it might not have all the committed entries. // The leader MUST NOT forward the follower\u0026#39;s commit to // an unmatched index. commit := min(r.prs.Progress[to].Match, r.raftLog.committed) m := pb.Message{ To: to, Type: pb.MsgHeartbeat, Commit: commit, Context: ctx, } r.send(m) } // åœ¨candidateå’ŒfollowerçŠ¶æ€å‡ä¼šè°ƒç”¨ï¼Œè½¬å˜ä¸ºfollower func (r *raft) handleHeartbeat(m pb.Message) { r.raftLog.commitTo(m.Commit) r.send(pb.Message{To: m.From, Type: pb.MsgHeartbeatResp, Context: m.Context}) } MsgHeartbeatRespâ€‹\nåœ¨Leaderæ¥æ”¶åˆ°äº†Followerçš„MsgHeartbeatRespä¹‹åï¼Œä¸»è¦åšä¸€ä¸‹çš„ç›¸å…³å¤„ç†ï¼š\nå¦‚æœå½“å‰ä¸ºProbeæ¨¡å¼å¹¶ä¸”å¤„äºé˜»å¡æ¨¡å¼ï¼ŒProbeSentè®¾ç½®ä¸ºfalseè§£é™¤é˜»å¡ RecentActiveè®¾ç½®ä¸ºTrueï¼Œç”¨äºè¿›è¡ŒCheck Quorum å¦‚æœæ¶ˆæ¯é˜Ÿåˆ—å·²æ»¡ï¼Œå¯ä»¥ä»å¤´é‡Šæ”¾ æ ¹æ®Trackerå½“ä¸­çš„Matchè¿›åº¦å’Œå½“å‰çš„æ—¥å¿—æƒ…å†µï¼Œè€ƒè™‘æ˜¯å¦éœ€è¦å‘followerå‘é€æ–°çš„æ—¥å¿— åšä¸€äº›çº¿æ€§ä¸€è‡´æ€§çš„ç›¸å…³å¤„ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 case pb.MsgHeartbeatResp: pr.RecentActive = true pr.ProbeSent = false // free one slot for the full inflights window to allow progress. if pr.State == tracker.StateReplicate \u0026amp;\u0026amp; pr.Inflights.Full() { pr.Inflights.FreeFirstOne() } if pr.Match \u0026lt; r.raftLog.lastIndex() { r.sendAppend(m.From) } if r.readOnly.option != ReadOnlySafe || len(m.Context) == 0 { return nil } if r.prs.Voters.VoteResult(r.readOnly.recvAck(m.From, m.Context)) != quorum.VoteWon { return nil } rss := r.readOnly.advance(m) for _, rs := range rss { if resp := r.responseToReadIndexReq(rs.req, rs.index); resp.To != None { r.send(resp) } } æ—¥å¿—æè®® Leaderå‘é€ ä¸Šå±‚é€šè¿‡è°ƒç”¨Nodeæ¥å£çš„Proposeå‡½æ•°å‘Raftå‘èµ·ä¸€æ¡æè®®ï¼Œå°†ä¸€ä¸ªæ“ä½œå°è£…æˆä¸€æ¡æ—¥å¿—ï¼Œä¹‹åç”¨äºè¾¾æˆå…±è¯†ï¼Œè¯¥æ–¹æ³•ä¼šå°è£…æˆä¸€æ¡MsgPropçš„æ¶ˆæ¯ï¼Œä½œä¸ºæ·»åŠ æ–°æ—¥å¿—çš„èµ·å§‹ç‚¹ã€‚\nè¿™é‡Œä¸Šå±‚æ‰€è°ƒç”¨çš„ä¸ºstepWaitå‡½æ•°ï¼Œå¹¶ä¸”ä¼ ä¸‹æ¥çš„ä¸ºä¸€ä¸ªEntryæ•°ç»„ï¼Œä¸ºæ‰¹å¤„ç†çš„å½¢å¼ï¼Œä¸Šå±‚å†™çš„channelå¹¶å‘ç¼–ç¨‹æš‚æ—¶æ²¡å¤ªçœ‹æ‡‚ï¼Œå…ˆæç½®ä¸€ä¸‹ã€‚\nè¿™é‡Œæ‰€è¿›è¡Œçš„å¤§éƒ¨åˆ†æ“ä½œéƒ½æ˜¯éå†å½“å‰æ–°çš„æè®®æ—¥å¿—ç»„å½“ä¸­æ˜¯å¦æœ‰é…ç½®æ›´æ”¹çš„æ¶ˆæ¯ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œæ¶‰åŠåˆ°çš„é€»è¾‘å¹¶ä¸å¤šï¼š\né¦–å…ˆæ£€æµ‹æ˜¯å¦ä¸ºç©ºæ—¥å¿— æ£€æµ‹å½“å‰çš„Leaderæ˜¯å¦åœ¨å½“å‰é…ç½®æ‰€è§„å®šçš„é›†ç¾¤å½“ä¸­ ä¹‹åé¦–å…ˆæŠŠæ—¥å¿—è¿½åŠ åˆ°è‡ªèº«çš„unstableå½“ä¸­ï¼Œä¹‹ååœ¨å¹¿æ’­å‘é€ç»™å…¶ä»–çš„follower 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 case pb.MsgProp: if len(m.Entries) == 0 { r.logger.Panicf(\u0026#34;%x stepped empty MsgProp\u0026#34;, r.id) } if r.prs.Progress[r.id] == nil { // If we are not currently a member of the range (i.e. this node // was removed from the configuration while serving as leader), // drop any new proposals. return ErrProposalDropped } if r.leadTransferee != None { r.logger.Debugf(\u0026#34;%x [term %d] transfer leadership to %x is in progress; dropping proposal\u0026#34;, r.id, r.Term, r.leadTransferee) return ErrProposalDropped } // å¯¹äºä¸Šæ–¹proposeçš„å…ˆå¤„ç†é…ç½®é—®é¢˜ï¼Œä¹‹åå°†Entriesæ·»åŠ å¹¶å‘followerå¹¿æ’­å‘é€ // å¯¹äºå…¶ä¸­åŒ…å«confChangeåˆ°ä¿¡æ¯ï¼Œè¿›è¡Œç‰¹æ®Šå¤„ç† for i := range m.Entries { e := \u0026amp;m.Entries[i] var cc pb.ConfChangeI if e.Type == pb.EntryConfChange { var ccc pb.ConfChange if err := ccc.Unmarshal(e.Data); err != nil { panic(err) } cc = ccc } else if e.Type == pb.EntryConfChangeV2 { var ccc pb.ConfChangeV2 if err := ccc.Unmarshal(e.Data); err != nil { panic(err) } cc = ccc } if cc != nil { alreadyPending := r.pendingConfIndex \u0026gt; r.raftLog.applied alreadyJoint := len(r.prs.Config.Voters[1]) \u0026gt; 0 wantsLeaveJoint := len(cc.AsV2().Changes) == 0 var refused string if alreadyPending { refused = fmt.Sprintf(\u0026#34;possible unapplied conf change at index %d (applied to %d)\u0026#34;, r.pendingConfIndex, r.raftLog.applied) } else if alreadyJoint \u0026amp;\u0026amp; !wantsLeaveJoint { refused = \u0026#34;must transition out of joint config first\u0026#34; } else if !alreadyJoint \u0026amp;\u0026amp; wantsLeaveJoint { refused = \u0026#34;not in joint state; refusing empty conf change\u0026#34; } if refused != \u0026#34;\u0026#34; { r.logger.Infof(\u0026#34;%x ignoring conf change %v at config %s: %s\u0026#34;, r.id, cc, r.prs.Config, refused) m.Entries[i] = pb.Entry{Type: pb.EntryNormal} } else { r.pendingConfIndex = r.raftLog.lastIndex() + uint64(i) + 1 } } } if !r.appendEntry(m.Entries...) { return ErrProposalDropped } r.bcastAppend() return nil appendEntry\nåœ¨appendEntryå½“ä¸­ï¼Œé¦–å…ˆå¯¹ä¸Šå±‚ä¼ æ¥çš„æ—¥å¿—è¿›è¡Œåˆå§‹åŒ–ï¼Œåˆ¤æ–­å½“å‰Leaderä¸Followerçš„è¿›åº¦å·®è·ï¼Œå³Leaderç›®å‰è¿˜æœ‰å¤šå°‘æœªcommitçš„æ—¥å¿—ï¼Œå¦‚æœå½“å‰æœªcommitçš„æ—¥å¿—è¿‡å¤šï¼Œåˆ™è¯æ˜Leaderä¸Followerçš„å·®è·è¿‡å¤§ï¼Œæ­¤æ—¶å¦‚æœç»§ç»­è¿›è¡Œæè®®ï¼Œé‚£ä¹ˆå°±ä¼šè¿›ä¸€æ­¥æ‹‰å¤§Leaderä¸Followeræˆå·®è·ï¼Œå› æ­¤æ‹’ç»ç»§ç»­æè®®ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 func (r *raft) increaseUncommittedSize(ents []pb.Entry) bool { var s uint64 for _, e := range ents { s += uint64(PayloadSize(e)) } // å¦‚æœå½“å‰æœªæäº¤çš„æ—¥å¿—è¿‡å¤šï¼Œåˆ™è¯æ˜Followeréš¾ä»¥è·Ÿä¸ŠLeaderçš„å‘é€é€Ÿåº¦ // å› æ­¤è¿”å›falseï¼Œä¹‹åä¼šæ‹’ç»æ–°çš„æè®®ï¼Œé˜²æ­¢Leaderä¸Followerä¹‹é—´çš„å·®è·æ›´å¤§ if r.uncommittedSize \u0026gt; 0 \u0026amp;\u0026amp; s \u0026gt; 0 \u0026amp;\u0026amp; r.uncommittedSize+s \u0026gt; r.maxUncommittedSize { // If the uncommitted tail of the Raft log is empty, allow any size // proposal. Otherwise, limit the size of the uncommitted tail of the // log and drop any proposal that would push the size over the limit. // Note the added requirement s\u0026gt;0 which is used to make sure that // appending single empty entries to the log always succeeds, used both // for replicating a new leader\u0026#39;s initial empty entry, and for // auto-leaving joint configurations. return false } r.uncommittedSize += s return true } ä¹‹åé€šè¿‡å°†æ—¥å¿—è¿½åŠ åˆ°Leaderè‡ªèº«çš„æ—¥å¿—å½“ä¸­ï¼Œå¹¶é€šè¿‡MaybeUpdateå¯¹è‡ªèº«çš„Matchè¿›è¡Œæ›´æ–°ï¼Œå¯¹äºè‡ªèº«ï¼Œå†™å…¥äº†è‡ªç„¶èƒ½å¤ŸMatchï¼Œä¹‹åå†é€šè¿‡maybeCommitå»ç»Ÿè®¡å½“å‰èƒ½å¤Ÿé€šè¿‡æŠ•ç¥¨çš„æ—¥å¿—çš„è¿›åº¦å¦‚ä½•ï¼Œå¯¹è‡ªèº«çš„commitedè¿›åº¦è¿›è¡Œæ›´æ–°\n1 2 3 4 5 6 7 // maybeCommit attempts to advance the commit index. Returns true if // the commit index changed (in which case the caller should call // r.bcastAppend). func (r *raft) maybeCommit() bool { mci := r.prs.Committed() return r.raftLog.maybeCommit(mci, r.Term) } 1 2 3 4 5 // Committed returns the largest log index known to be committed based on what // the voting members of the group have acknowledged. func (p *ProgressTracker) Committed() uint64 { return uint64(p.Voters.CommittedIndex(matchAckIndexer(p.Progress))) } appendEntryçš„å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 func (r *raft) appendEntry(es ...pb.Entry) (accepted bool) { li := r.raftLog.lastIndex() // ä¸Šå±‚ä¼ å…¥çš„æ—¥å¿—å½“ä¸­ä¸æ¸…æ¥šä¸‹å±‚çš„Termå’ŒIndexæƒ…å†µï¼Œå› æ­¤åœ¨æ­¤å¤„è¿›è¡Œå°è£… for i := range es { es[i].Term = r.Term es[i].Index = li + 1 + uint64(i) } // Track the size of this uncommitted proposal. if !r.increaseUncommittedSize(es) { r.logger.Debugf( \u0026#34;%x appending new entries to log would exceed uncommitted entry size limit; dropping proposal\u0026#34;, r.id, ) // Drop the proposal. return false } // use latest \u0026#34;last\u0026#34; index after truncate/append li = r.raftLog.append(es...) r.prs.Progress[r.id].MaybeUpdate(li) // Regardless of maybeCommit\u0026#39;s return, our caller will call bcastAppend. r.maybeCommit() return true } bcastAppend\né€šè¿‡progresséå†æ‰€æœ‰çš„èŠ‚ç‚¹ï¼Œå°è¯•å‘é€AppendEntriesï¼Œè¿™ä¸¤æ®µçš„é€»è¾‘éƒ½æ¯”è¾ƒç®€å•ï¼Œé‡ç‚¹åœ¨äºå°è£…çš„maybeSendAppendâ€‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 // bcastAppend sends RPC, with entries to all peers that are not up-to-date // according to the progress recorded in r.prs. // å°è£…ä¸€ä¸ªå‘é€AppendEntriesçš„å‡½æ•°ä½œä¸ºå‚æ•°ä¼ é€’ç»™Visitï¼Œä¹‹åVisitéå†å¹¶è°ƒç”¨è¯¥å‡½æ•° func (r *raft) bcastAppend() { r.prs.Visit(func(id uint64, _ *tracker.Progress) { if id == r.id { return } r.sendAppend(id) }) } // sendAppend sends an append RPC with new entries (if any) and the // current commit index to the given peer. func (r *raft) sendAppend(to uint64) { r.maybeSendAppend(to, true) } maybeSendAppendâ€‹\nå¯¹äºæ—¥å¿—ä¸å¿«ç…§çš„å‘é€å‡é€šè¿‡è¯¥å‡½æ•°è¿›è¡Œï¼Œå¤§è‡´æ­¥éª¤å¦‚ä¸‹ï¼š\né¦–å…ˆé€šè¿‡progressæ£€æŸ¥å¯¹æ–¹æ˜¯å¦å¤„äºé˜»å¡çŠ¶æ€ï¼Œå¦‚æœé˜»å¡ï¼Œåˆ™æ‹’ç»å‘é€\nå°è¯•è·å–åˆ°éœ€è¦å‘é€ç»™å¯¹æ–¹çš„æ—¥å¿—å’Œå¯¹åº”çš„Termï¼Œå¹¶åœ¨è¿™è¿‡è¿‡ç¨‹åˆ¤æ–­éœ€è¦å‘é€çš„æ—¥å¿—æ˜¯å¦è¿‡æ—§å·²ç»è¢«å¿«ç…§åŒ–\nåœ¨ä¸Šä¸€æ­¥å½“ä¸­å¦‚æœåˆ¤æ–­å‡ºäº†å·²ç»è¢«å¿«ç…§åŒ–ï¼Œé‚£ä¹ˆå°±è½¬å˜ä¸ºå‘é€å¿«ç…§ï¼š\nå¦‚æœå‘é€å¯¹æ–¹å¹¶æ²¡æœ‰é€šè¿‡RecentActiveçš„æ£€æŸ¥çš„è¯ï¼Œå†åŠ ä¸Šå¯¹æ–¹ç›®å‰å·²ç»é•¿æ—¶é—´è½åäºLeaderï¼Œå¯ä»¥è®¤å®šä¸ºå…¶å·²ç»å®•æœºæˆ–è€…äº§ç”Ÿç½‘ç»œåˆ†åŒºï¼Œæ— æ³•å’Œleaderè¿›è¡Œé€šä¿¡ï¼Œå› æ­¤æ‹’ç»å‘é€\nå°è£…MsgSnapï¼Œå‡†å¤‡å‘é€æ—¥å¿—ï¼Œå¹¶å°†å¯¹æ–¹çš„çŠ¶æ€è½¬æ¢ä¸ºStateSnaphot\nå¦‚ä¹‹å‰æ‰€è®¨è®ºçš„ï¼šåœ¨followerè½¬ä¸ºStateSnapshotåï¼Œåªæœ‰ä¸¤ç§è·³å‡ºStateSnapshotçš„æ–¹æ³•ï¼š\nfollowerèŠ‚ç‚¹åº”ç”¨å¿«ç…§åä¼šå‘é€MsgAppRespæ¶ˆæ¯ï¼Œè¯¥æ¶ˆæ¯ä¼šæŠ¥å‘Šå½“å‰followerçš„last indexã€‚å¦‚æœfolloweråº”ç”¨äº†å¿«ç…§ålast indexå°±è¿½èµ¶ä¸Šäº†å…¶match indexï¼Œé‚£ä¹ˆleaderä¼šç›´æ¥å°†followerçš„çŠ¶æ€è½¬ç§»åˆ°StateRelicateçŠ¶æ€ï¼Œä¸ºå…¶ç»§ç»­å¤åˆ¶æ—¥å¿—ã€‚ leaderèŠ‚ç‚¹çš„ä½¿ç”¨è€…è¿˜éœ€è¦ä¸»åŠ¨è°ƒç”¨Nodeçš„ReportSnapshotæ–¹æ³•å‘ŠçŸ¥leaderèŠ‚ç‚¹å¿«ç…§çš„åº”ç”¨çŠ¶æ€ï¼Œ\nleaderä¼šå°†è¯¥followerçš„çŠ¶æ€è½¬ç§»åˆ°StateProbeçŠ¶æ€ï¼ˆä¸æ–¹æ³•1é‡å¤çš„æ¶ˆæ¯ä¼šè¢«å¿½ç•¥ï¼‰ã€‚ å¦åˆ™ï¼Œå‘é€æ—¥å¿—ï¼Œåœ¨å®ŒæˆMsgAppçš„å°è£…ä¹‹åï¼Œæ ¹æ®å½“å‰çš„çŠ¶æ€å»æ›´æ–°çŠ¶æ€\nå¦‚æœå½“å‰ä¸ºStateProbeçŠ¶æ€ï¼Œé‚£ä¹ˆçŠ¹è±«StateProbeåœ¨ä¸€æ¬¡å¿ƒè·³ä¿¡æ¯å½“ä¸­åªèƒ½å‘é€ä¸€æ¬¡æ—¥å¿—ï¼Œå› æ­¤å°†StateSentè®¾ç½®ä¸ºtrueï¼Œåœ¨è¯¥å¿ƒè·³å‘¨æœŸå½“ä¸­è¿›è¡Œé˜»å¡ï¼Œç­‰å¾…æ”¶åˆ°MsgAppRespä¹‹åè®¾ç½®ä¸ºfalseï¼Œä»é˜»å¡å½“ä¸­æ¢å¤\nå¦‚æœå½“å‰ä¸ºStateReplicateçŠ¶æ€ï¼Œé‚£ä¹ˆå°±è¯æ˜followerå¯ä»¥è·Ÿä¸ŠLeaderçš„è¿›åº¦ï¼Œå› æ­¤å¯ä»¥ä»¥æµæ°´çº¿çš„å½¢å¼å¿«é€Ÿå‘é€ï¼Œæ— éœ€ç­‰å¾…å›åº”å³å¯æ›´æ–°å¯¹æ–¹çš„Nextè¿›åº¦\n1 2 3 // OptimisticUpdate signals that appends all the way up to and including index n // are in-flight. As a result, Next is increased to n+1. func (pr *Progress) OptimisticUpdate(n uint64) { pr.Next = n + 1 } æœ€åçš„æœ€åï¼Œè°ƒç”¨sendå°è£…ä¸€æ¡Msgäº¤ç»™ä¸Šå±‚è¿›è¡Œå‘é€\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 func (r *raft) maybeSendAppend(to uint64, sendIfEmpty bool) bool { pr := r.prs.Progress[to] // å¯¹æ–¹ç”±äºæŸäº›åŸå› å¤„äºé˜»å¡çŠ¶æ€ï¼Œæ‹’ç»å‘é€ if pr.IsPaused() { return false } m := pb.Message{} m.To = to term, errt := r.raftLog.term(pr.Next - 1) ents, erre := r.raftLog.entries(pr.Next, r.maxMsgSize) if len(ents) == 0 \u0026amp;\u0026amp; !sendIfEmpty { return false } // å¯èƒ½ç”±äºå¯¹æ–¹è¿›åº¦è¿‡æ…¢å¯¼è‡´æ—¥å¿—å†…å®¹å·²ç»è¢«å¿«ç…§åŒ–ï¼Œæ­¤æ—¶å°è¯•å‘é€å¿«ç…§ if errt != nil || erre != nil { // send snapshot if we failed to get term or entries if !pr.RecentActive { r.logger.Debugf(\u0026#34;ignore sending snapshot to %x since it is not recently active\u0026#34;, to) return false } m.Type = pb.MsgSnap snapshot, err := r.raftLog.snapshot() if err != nil { if err == ErrSnapshotTemporarilyUnavailable { r.logger.Debugf(\u0026#34;%x failed to send snapshot to %x because snapshot is temporarily unavailable\u0026#34;, r.id, to) return false } panic(err) // TODO(bdarnell) } if IsEmptySnap(snapshot) { panic(\u0026#34;need non-empty snapshot\u0026#34;) } m.Snapshot = snapshot sindex, sterm := snapshot.Metadata.Index, snapshot.Metadata.Term r.logger.Debugf(\u0026#34;%x [firstindex: %d, commit: %d] sent snapshot[index: %d, term: %d] to %x [%s]\u0026#34;, r.id, r.raftLog.firstIndex(), r.raftLog.committed, sindex, sterm, to, pr) pr.BecomeSnapshot(sindex) r.logger.Debugf(\u0026#34;%x paused sending replication messages to %x [%s]\u0026#34;, r.id, to, pr) } else { m.Type = pb.MsgApp m.Index = pr.Next - 1 m.LogTerm = term m.Entries = ents m.Commit = r.raftLog.committed if n := len(m.Entries); n != 0 { switch pr.State { // optimistically increase the next when in StateReplicate case tracker.StateReplicate: // å½“å‰æ­£ä»¥æµæ°´çº¿çš„æ–¹æ³•ä¼˜åŒ–æ—¥å¿—çš„å¤åˆ¶é€Ÿåº¦ï¼Œå³followerå¯ä»¥ç¡®ä¿è·Ÿä¸Šleaderçš„è¿›åº¦ // å› æ­¤å¯ä»¥ç›´æ¥è®¾ç½®nest last := m.Entries[n-1].Index pr.OptimisticUpdate(last) pr.Inflights.Add(last) case tracker.StateProbe: // åœ¨Probeæ¨¡å¼ä¸‹ï¼Œä¸€æ¬¡åªèƒ½å‘é€ä¸€æ¡æ—¥å¿—ï¼Œå¹¶ä¸”éœ€è¦ç­‰å¾…å¯¹æ–¹çš„å›åº”ä¹‹åæ‰èƒ½ç»§ç»­å‘é€ // åœ¨æ­¤å¤„è®¾ç½®ä¸ºtrueç”¨äºåœ¨IsPaused()å½“ä¸­è¿›è¡Œé˜»å¡ï¼Œç›´åˆ°æ”¶åˆ°followerçš„ç¡®è®¤ pr.ProbeSent = true default: r.logger.Panicf(\u0026#34;%x is sending append in unhandled state %s\u0026#34;, r.id, pr.State) } } } r.send(m) return true } Followerå¤„ç†ä¸å“åº” åœ¨Candidateå’ŒFollowerçŠ¶æ€ä¸‹éƒ½ä¼šæ¥æ”¶å¹¶å¤„ç†MsgAppï¼Œå¦‚æœæ˜¯Candidateï¼Œå°±å¤šäº†ä¸€æ­¥è½¬æ¢ä¸ºfollowerçš„æ­¥éª¤ï¼Œä¹‹åè°ƒç”¨handleAppendEntriesâ€‹è¿›è¡Œå¤„ç†ï¼š\nå¦‚æœå‘é€æ¥çš„æ—¥å¿—å·²ç»committedï¼Œé‚£ä¹ˆåˆ™ä¸ºä¸€æ¡é™ˆæ—§æ¶ˆæ¯ï¼Œè¿”å›ç»™Leaderè‡ªå·±å½“å‰çš„è¿›åº¦å³å¯ ä¹‹åè°ƒç”¨raftLogçš„maybeAppendï¼Œåœ¨å…¶ä¸­å¤„ç†å†²çªå¹¶ä¸”è¿”å›æ˜¯å¦æ·»åŠ æˆåŠŸï¼Œæœ€ç»ˆæ›´æ–°commitçš„è¿›åº¦ï¼Œå…³äºcommitï¼Œåœ¨ä¸Šé¢è®²è¿°raftlogæ—¶å·²ç»è¯´æ˜è¿‡ä¸ºä»€ä¹ˆè¦min(lastnewi,committed),å¦‚æœèƒ½å¤ŸæˆåŠŸæ·»åŠ å°±å¯ä»¥ç›´æ¥å‘Leaderå‘é€MsgAppRespäº†ï¼Œè¿”å›å½“å‰çš„æœ€æ–°çš„æ—¥å¿—çš„Indexè¡¨æ˜è¿›åº¦ å¦‚æœæ·»åŠ å¤±è´¥ï¼Œåˆ™ä»£è¡¨å­˜åœ¨å†²çªï¼Œåœ¨followerç«¯æŒ‰ç…§å¿«é€Ÿå›é€€çš„æ–¹å¼æ ¹æ®Termæ‰¾åˆ°å†²çªçš„ä½ç½®ï¼Œå³ç¬¬ä¸€ä¸ªTerm \u0026lt;= Msg.Termå¹¶ä¸”Index \u0026lt;= Msg.Indexçš„ä½ç½®ä¹‹åå°†Rejectå­—æ®µè®¾ç½®ä¸ºtrueï¼Œè®¾ç½®HintIndexã€HintTermè¿”å›ç»™Leader 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 func (r *raft) handleAppendEntries(m pb.Message) { if m.Index \u0026lt; r.raftLog.committed { r.send(pb.Message{To: m.From, Type: pb.MsgAppResp, Index: r.raftLog.committed}) return } if mlastIndex, ok := r.raftLog.maybeAppend(m.Index, m.LogTerm, m.Commit, m.Entries...); ok { r.send(pb.Message{To: m.From, Type: pb.MsgAppResp, Index: mlastIndex}) } else { r.logger.Debugf(\u0026#34;%x [logterm: %d, index: %d] rejected MsgApp [logterm: %d, index: %d] from %x\u0026#34;, r.id, r.raftLog.zeroTermOnErrCompacted(r.raftLog.term(m.Index)), m.Index, m.LogTerm, m.Index, m.From) // Return a hint to the leader about the maximum index and term that the // two logs could be divergent at. Do this by searching through the // follower\u0026#39;s log for the maximum (index, term) pair with a term \u0026lt;= the // MsgApp\u0026#39;s LogTerm and an index \u0026lt;= the MsgApp\u0026#39;s Index. This can help // skip all indexes in the follower\u0026#39;s uncommitted tail with terms // greater than the MsgApp\u0026#39;s LogTerm. // // See the other caller for findConflictByTerm (in stepLeader) for a much // more detailed explanation of this mechanism. hintIndex := min(m.Index, r.raftLog.lastIndex()) hintIndex = r.raftLog.findConflictByTerm(hintIndex, m.LogTerm) hintTerm, err := r.raftLog.term(hintIndex) if err != nil { panic(fmt.Sprintf(\u0026#34;term(%d) must be valid, but got %v\u0026#34;, hintIndex, err)) } r.send(pb.Message{ To: m.From, Type: pb.MsgAppResp, Index: m.Index, Reject: true, RejectHint: hintIndex, LogTerm: hintTerm, }) } } Leaderæ¥æ”¶MsgAppResp åˆ°è¿™é‡Œä¹Ÿæ˜¯æ—¥å¿—å¤åˆ¶çš„æœ€åä¸€æ­¥ï¼ŒLeaderæ ¹æ®Followerçš„å“åº”æ¥å†³å®šåç»­çš„è¡Œä¸ºï¼Œæ¥æ”¶åˆ°æ¶ˆæ¯é¦–å…ˆå¯ä»¥å°†è¯¥followeræ ‡è®°ä¸ºRecentActiveï¼Œä¹‹åå…ˆæ¥è¯´å­˜åœ¨å†²çªçš„æƒ…å†µï¼š\nå­˜åœ¨å†²çªï¼š\nå­˜åœ¨å†²çªï¼Œå³MsgAppRespå½“ä¸­çš„Rejectä¸ºtrueï¼Œå¯¹åº”çš„è¿˜ä¼šæœ‰Followerè¿”å›çš„HintIndex(RejectHint)ä¸HintTerm(Logterm)ï¼Œåœ¨followerçš„handAppendEntrieså½“ä¸­ï¼Œå¦‚æœfollowerçš„è¿›åº¦è¿‡æ—§ï¼Œå¯¼è‡´index out of rangeçš„è¯ï¼ŒTermå°±ä¼šè®¾ç½®ä¸º0ï¼Œå› æ­¤é¦–å…ˆåˆ¤æ–­Termæ˜¯å¦ä¸º0ï¼Œå¦‚æœä¸ä¸º0çš„è¯å°±è¯æ˜åœ¨followerå½“ä¸­æ‰¾åˆ°äº†å¯¹åº”çš„å†²çªä½ç½®ï¼Œå¯ä»¥æ ¹æ®è¿”å›çš„HintIndexã€HintTermåœ¨Leaderå½“ä¸­æ‰¾åˆ°å¯¹åº”çš„ä½ç½®ï¼Œè®¾ç½®ä¸ºNextï¼Œç”¨äºä¸‹ä¸€æ¬¡å‘é€ã€‚\nä¹‹åå°è¯•å¯¹Leaderçš„Nextè®°å½•è¿›è¡Œå›é€€ï¼Œå¦‚æœå›é€€å¤±è´¥åˆ™è¯´æ˜ä¸ºä¸€æ¡è¿‡æœŸçš„æ—¥å¿—ï¼Œä¸å¤„ç†ï¼Œå¦åˆ™å°†followerçš„çŠ¶æ€è®°å½•ä¸ºStateProbeï¼Œè¿›è¡Œæ¢æµ‹å‘é€ï¼Œç†æƒ³çš„æƒ…å†µä¸‹å¯ä»¥ä¸€è½®æ¢æµ‹å°±è®©followerå’ŒLeaderæ­£ç¡®è·Ÿéšå¯¹é½è¿›åº¦ï¼Œå†é‡æ–°è½¬æ¢ä¸ºStateReplicateã€‚\nä¸å­˜åœ¨å†²çªâ€‹\nå…ˆå°è¯•æ ¹æ®è¿”å›çš„Indexå¯¹matchè¿›è¡Œæ›´æ–°ï¼Œå¦‚æœæ›´æ–°å¤±è´¥ï¼Œåˆ™è¯æ˜Leaderçš„Matchè¿›åº¦å¿«äºFollowerè¿”å›çš„ï¼Œè¯æ˜ï¼š\nè¯¥æ¶ˆæ¯ä¸ºä¸€æ¡è¿‡æœŸçš„æ¶ˆæ¯ï¼Œä¸è¿›è¡Œå¤„ç† è¯¥MsgAppRespç”±å¿«ç…§åº”ç”¨å¿«ç…§åäº§ç”Ÿçš„æ¶ˆæ¯ï¼Œæ­¤æ—¶followerä»æœªè·Ÿä¸Šå…¶MatchIndexï¼Œæ— æ³•å®ŒæˆåŒ¹é… è¯¥æ¶ˆæ¯ä¸ºStateProbeçŠ¶æ€å‘é€çš„ç¡®è®¤æ¶ˆæ¯ï¼Œç”±äºStateProbeçŠ¶æ€åªè¿›è¡Œæ¢æµ‹ï¼Œä¸€æ¬¡æ€§åªåœ¨ä¸€æ¬¡å¿ƒè·³å‘¨æœŸå½“ä¸­å‘é€ä¸€æ¡æ—¥å¿—ï¼Œæ— æ³•è¿›è¡Œæ—¥å¿—å¤åˆ¶è·ŸéšçŠ¶æ€ï¼Œæ‰€ä»¥æ­¤æ—¶ä»æ²¡æœ‰Matchä¸Šï¼Œä¸åšå¤„ç†ï¼Œç­‰åˆ°ä¹‹åæ”¶åˆ°ä¸‹ä¸€ä¸ªå‘¨æœŸçš„HeartbeatRespå†è§£é™¤é˜»å¡ å¦‚æœèƒ½å¤Ÿæ›´æ–°æˆåŠŸï¼š\nå¦‚æœå½“å‰ä¸ºStateProbeï¼Œé‚£ä¹ˆåˆ™è¯æ˜é€šè¿‡æ¢æµ‹å¯¹é½äº†è¿›åº¦ï¼Œæ­¤æ—¶å°±å¯ä»¥è½¬æ¢ä¸ºStateReplicateå»å¿«é€Ÿå‘é€æ—¥å¿—æ›´æ–°çŠ¶æ€ å¦‚æœå½“å‰ä¸ºStateSnapshotï¼Œå¹¶ä¸”Matchçš„è¿›åº¦è¶…è¿‡äº†Snapshotï¼Œæ­¤æ—¶åŒæ ·å¯ä»¥è½¬æ¢ä¸ºStateReplicate è€ŒStateReplicateä¸‹åªéœ€é‡Šæ”¾éƒ¨åˆ†æ¶ˆæ¯é˜Ÿåˆ—çš„å®¹é‡å³å¯ å¤„ç†å®ŒçŠ¶æ€è½¬æ¢ä¹‹åï¼ŒLeaderå¯ä»¥å°è¯•é€šè¿‡æ£€æµ‹å„ä¸ªfollowerçš„å¤åˆ¶è¿›åº¦æ¥å†³å®šcommitï¼Œè¿™ä¸ªåŠ¨ä½œä¸ºå¼‚æ­¥çš„ï¼Œç”±äºå¼•å…¥äº†ProgressTrackerï¼Œåˆ™å¯ä»¥æ ¹æ®å½“å‰è®°å½•çš„ä¿¡æ¯æ—¶ä¸æ—¶çš„è§¦å‘maybeCommitæ¥æ¨è¿›commitè¿›åº¦ï¼Œæ— éœ€å‘MIT-6.824é‚£æ ·å‘é€å®ŒAppendEntries RPCä¹‹ååœ¨è¿™é‡Œç­‰å¾…å“åº”ä»¥ç¡®å®šcommitï¼Œå¦‚æœcommitçš„è¿›åº¦å¾—åˆ°æ¨è¿›ï¼Œå°±å¯ä»¥é¢åœ¨å¹¿æ’­ä¸€æ¬¡AppendEntrieså°†commitè¿›åº¦æºå¸¦äºå…¶ä¸­ï¼Œå‘é€ç»™follower\nå¦‚æœcommit indexæ²¡æœ‰æ›´æ–°ï¼Œè¿˜éœ€è¦è¿›ä¸€æ­¥åˆ¤æ–­è¯¥followerä¹‹å‰æ˜¯å¦æ˜¯é˜»å¡çš„ï¼Œå¦‚æœæ˜¯é‚£ä¹ˆä¸ºè¯¥followerå‘é€ä¸€æ¡æ—¥å¿—å¤åˆ¶æ¶ˆæ¯ä»¥æ›´æ–°å…¶committedâ€‹ç´¢å¼•ï¼Œå› ä¸ºåœ¨è¯¥èŠ‚ç‚¹é˜»å¡æ—¶å¯èƒ½é”™è¿‡äº†committedâ€‹ç´¢å¼•çš„æ›´æ–°æ¶ˆæ¯ã€‚\nä¹‹åå°è¯•é€šè¿‡forå¾ªç¯å»ä¸æ–­çš„å‘é€AppendEntriesã€‚å› ä¸ºæ—¥å¿—å¤åˆ¶éƒ¨åˆ†æœ‰æµæ§é€»è¾‘ï¼Œå› æ­¤è¿™é‡Œçš„å¾ªç¯ä¸ä¼šæˆä¸ºæ­»å¾ªç¯ã€‚è¿™æ ·åšå¯ä»¥å°½å¯èƒ½å¤šåœ°ä¸ºèŠ‚ç‚¹å¤åˆ¶æ—¥å¿—ï¼Œä»¥æé«˜æ—¥å¿—å¤åˆ¶æ•ˆç‡ã€‚\n1 2 3 4 5 6 7 func (r *raft) maybeSendAppend(to uint64, sendIfEmpty bool) bool { // ... if len(ents) == 0 \u0026amp;\u0026amp; !sendIfEmpty { return false } // ... } è‡³æ­¤ï¼Œæ‰€æœ‰å…³äºMsgAppRespçš„å¤„ç†å…¨éƒ¨å®Œæˆï¼Œè¿™ä¸€éƒ¨åˆ†å°¤å…¶æ˜¯rejectè¿›è¡Œå¿«é€Ÿå›é€€çš„è¿‡ç¨‹å½“ä¸­etcdç»™å‡ºäº†å¤§é‡çš„æ ·ä¾‹ç”¨äºè¯´æ˜ä¸åŒæƒ…å†µä¸‹çš„å¯¹é½è¿›åº¦å’Œå¯¹é½æ–¹å¼ï¼Œä¸ªäººè®¤ä¸ºéå¸¸æœ‰å¿…è¦ä¸€è¯»ï¼Œä»¥æ›´å¥½çš„ç†è§£æ•´ä¸ªå›é€€çš„è¿‡ç¨‹ã€‚\né™¤æ­¤ä¹‹å¤–ï¼Œåœ¨å‘é€è¿‡ç¨‹å½“ä¸­ï¼Œå¿«ç…§å‘é€çš„è¿‡ç¨‹ä¸å“åº”çš„è¿‡ç¨‹å¤¹æ‚åœ¨æ—¥å¿—çš„å¤„ç†è¿‡ç¨‹æ‰“çº¢ä¸­é¡ºä¾¿ç»™è¯´æ˜äº†ï¼Œä½†æ˜¯å¯¹äºfolloweråº”å½“å¦‚ä½•åº”ç”¨å¿«ç…§è¿˜æœªæ¶‰åŠåˆ°ï¼Œå› æ­¤å†æ¥çœ‹ä¸€ä¸‹å¿«ç…§åº”ç”¨çš„è¿‡ç¨‹ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œè´´ä¸€ä¸‹ä»£ç å³å¯\n1 2 3 4 5 6 7 8 9 10 11 12 13 func (r *raft) handleSnapshot(m pb.Message) { sindex, sterm := m.Snapshot.Metadata.Index, m.Snapshot.Metadata.Term if r.restore(m.Snapshot) { r.logger.Infof(\u0026#34;%x [commit: %d] restored snapshot [index: %d, term: %d]\u0026#34;, r.id, r.raftLog.committed, sindex, sterm) r.send(pb.Message{To: m.From, Type: pb.MsgAppResp, Index: r.raftLog.lastIndex()}) } else { // è‡ªèº«çš„è¿›åº¦å¿«äºå‘é€çš„Snaoshotï¼Œå°†è‡ªå·±commitçš„æœ€åä¸€æ¡æ—¥å¿—å‘é€ç»™Leaderï¼Œä¾¿äºå…¶æ›´æ–°Matchä¸Next r.logger.Infof(\u0026#34;%x [commit: %d] ignored snapshot [index: %d, term: %d]\u0026#34;, r.id, r.raftLog.committed, sindex, sterm) r.send(pb.Message{To: m.From, Type: pb.MsgAppResp, Index: r.raftLog.committed}) } } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 func (r *raft) restore(s pb.Snapshot) bool { if s.Metadata.Index \u0026lt;= r.raftLog.committed { return false } if r.state != StateFollower { // This is defense-in-depth: if the leader somehow ended up applying a // snapshot, it could move into a new term without moving into a // follower state. This should never fire, but if it did, we\u0026#39;d have // prevented damage by returning early, so log only a loud warning. // // At the time of writing, the instance is guaranteed to be in follower // state when this method is called. r.logger.Warningf(\u0026#34;%x attempted to restore snapshot as leader; should never happen\u0026#34;, r.id) r.becomeFollower(r.Term+1, None) return false } // More defense-in-depth: throw away snapshot if recipient is not in the // config. This shouldn\u0026#39;t ever happen (at the time of writing) but lots of // code here and there assumes that r.id is in the progress tracker. found := false cs := s.Metadata.ConfState for _, set := range [][]uint64{ cs.Voters, cs.Learners, cs.VotersOutgoing, // `LearnersNext` doesn\u0026#39;t need to be checked. According to the rules, if a peer in // `LearnersNext`, it has to be in `VotersOutgoing`. } { for _, id := range set { if id == r.id { found = true break } } if found { break } } if !found { r.logger.Warningf( \u0026#34;%x attempted to restore snapshot but it is not in the ConfState %v; should never happen\u0026#34;, r.id, cs, ) return false } // Now go ahead and actually restore. // åœ¨è‡ªèº«çš„æ—¥å¿—å½“ä¸­å¯ä»¥æ‰¾åˆ°Snapshotå½“ä¸­æœ€åçš„Indexå’ŒTermï¼Œå¯¹è¯¥Snapshotè¿›è¡Œå¿½ç•¥ if r.raftLog.matchTerm(s.Metadata.Index, s.Metadata.Term) { r.logger.Infof(\u0026#34;%x [commit: %d, lastindex: %d, lastterm: %d] fast-forwarded commit to snapshot [index: %d, term: %d]\u0026#34;, r.id, r.raftLog.committed, r.raftLog.lastIndex(), r.raftLog.lastTerm(), s.Metadata.Index, s.Metadata.Term) // å¿«ç…§å½“ä¸­çš„ä¸ºå·²ç»æäº¤çš„æ—¥å¿—ï¼Œå› æ­¤å¯èƒ½éœ€è¦å¯¹æœ¬åœ°çš„commitè¿›åº¦è¿›è¡Œæ›´æ–° r.raftLog.commitTo(s.Metadata.Index) return false } r.raftLog.restore(s) // Reset the configuration and add the (potentially updated) peers in anew. r.prs = tracker.MakeProgressTracker(r.prs.MaxInflight) cfg, prs, err := confchange.Restore(confchange.Changer{ Tracker: r.prs, LastIndex: r.raftLog.lastIndex(), }, cs) if err != nil { // This should never happen. Either there\u0026#39;s a bug in our config change // handling or the client corrupted the conf change. panic(fmt.Sprintf(\u0026#34;unable to restore config %+v: %s\u0026#34;, cs, err)) } assertConfStatesEquivalent(r.logger, cs, r.switchToConfig(cfg, prs)) pr := r.prs.Progress[r.id] pr.MaybeUpdate(pr.Next - 1) // TODO(tbg): this is untested and likely unneeded r.logger.Infof(\u0026#34;%x [commit: %d, lastindex: %d, lastterm: %d] restored snapshot [index: %d, term: %d]\u0026#34;, r.id, r.raftLog.committed, r.raftLog.lastIndex(), r.raftLog.lastTerm(), s.Metadata.Index, s.Metadata.Term) return true } ç›¸å…³ä¼˜åŒ– å¼•ç”¨ï¼šetcd/raft\nå¿«é€Ÿå›é€€ å¿«é€Ÿå›é€€åœ¨RaftåŸæœ¬è®ºæ–‡å’ŒMIT6.824çš„è¯¾ä¸Šéƒ½åšå‡ºäº†ç›¸å…³è¯´æ˜ï¼Œåœ¨ä¸Šæ–‡ä¸­ä¹Ÿåˆ†æäº†æ•´ä¸ªè¿‡ç¨‹ï¼Œå³é€šè¿‡followerå»æ‰¾åˆ°å’Œè‡ªèº«å†²çªçš„ä½ç½®ï¼Œä¹‹åè¿”å›ç»™Leaderï¼Œä¸è¿‡åœ¨RaftåŸæ–‡å½“ä¸­ï¼Œé‡‡ç”¨çš„æ˜¯XTerm + XLen + XIndexçš„ç»„åˆæ–¹å¼æ¥è§£å†³é—®é¢˜:\nXTerm:å†²çªçš„termå· XIndexï¼šXTermçš„ç¬¬ä¸€ä¸ªIndex Xlenï¼šfollowerçš„æ—¥å¿—çš„é•¿åº¦ caseï¼š\ns1 4 5 5 s2 4 6 6 6 s1 4 4 4 s2 4 6 6 6 s1 4 s2 4 6 6 6 å¯¹äºç¬¬ä¸€ä¸ªcaseï¼šs2ç¬¬ä¸€æ¬¡å‘é€AppendEntryåæ¥æ”¶åˆ°çš„XTermä¸º5ï¼ŒXIndexä¸º2ï¼ˆindexä»1å¼€å§‹ï¼‰ï¼Œleaderå½“ä¸­å¹¶æ²¡æœ‰term = 5ï¼Œå› æ­¤åç»­çš„AppendEntryå¯ä»¥ç›´æ¥è·³è½¬åˆ°Index = 2å¼€å§‹å‘é€ å¯¹äºç¬¬äºŒä¸ªcaseï¼šleaderå½“ä¸­å«æœ‰XTerm = 4ï¼Œå› æ­¤leaderå°±ä»XTermçš„æœ€åä¸€ä¸ªEntryå¼€å§‹è¿›è¡ŒåŒæ­¥ å¯¹äºç¬¬ä¸‰ä¸ªcaseï¼šfollowerå½“ä¸­ä¸å­˜åœ¨leaderçš„entryï¼Œé€šè¿‡XLenæ¥æ‰¾åˆ°æœ€åä¸€ä¸ªEntryè¿›è¡ŒåŒæ­¥ MIT6.824å½“ä¸­çš„å®ç°ï¼š\nfollower\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 // figure 2 AppendEntries RPC Receiver implementation 2 // log is too short if rf.getLastIndex() \u0026lt; args.PrevLogIndex { reply.Success = false reply.Conflict = true reply.XTerm = -1 reply.XIndex = -1 reply.XLen = rf.getLastIndex() Debug(dLog, \u0026#34;S%d follower\u0026#39;s log is to short,index:%d,prevLogIndex%d\u0026#34;, rf.me, rf.getLastIndex(), args.PrevLogIndex) Debug(dLog, \u0026#34;S%d Conflict Xterm %d,XIndex %d,XLen %d\u0026#34;, rf.me, reply.XTerm, reply.XIndex, reply.XLen) return } Debug(dLog, \u0026#34;S%d log is %s\u0026#34;, rf.me, rf.log.String()) // figure 2 AppendEntries RPC Receiver implementation 2 if rf.restoreLogTerm(args.PrevLogIndex) != args.PrevLogTerm { reply.Success = false reply.Conflict = true // set XTerm XLen XIndex reply.XTerm = rf.restoreLogTerm(args.PrevLogIndex) for idx := args.PrevLogIndex; idx \u0026gt; rf.lastIncludedIndex; idx-- { // the first index of the conflict term if rf.restoreLogTerm(idx-1) != reply.XTerm { reply.XIndex = idx break } } reply.XLen = len(rf.log.Entries) Debug(dLog, \u0026#34;S%d Conflict Xterm %d, XIndex %d,XLen %d\u0026#34;, rf.me, reply.XTerm, reply.XIndex, reply.XLen) return } leaderâ€‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 } else if reply.Conflict { // å¦‚æœå­˜åœ¨å†²çªåˆ™é€šè¿‡XTerm XLen XIndexè¿›è¡Œå¿«é€Ÿå®šä½ // XTerm == -1åˆ™è¯æ˜ followerå½“ä¸­æ—¥å¿—è¿‡çŸ­ï¼Œä¸å­˜åœ¨å’Œå‘é€çš„åŒtermçš„entryï¼Œç›´æ¥æŒ‰é•¿åº¦ä»æœ€æœ«å°¾è¿›è¡Œé‡å†™ if reply.XTerm == -1 { rf.nextIndex[server] = reply.XLen } else { // xIndexä¸º0åˆ™è¯æ˜ followerå½“ä¸­æ²¡æ‰¾åˆ°ï¼Œå³åªæœ‰ä¸€ä¸ªtermçš„æƒ…å†µ,éœ€è¦leaderè¿›è¡Œå®šä½ // follower : 4 4 4 // leader : 4 4 5 5 5 if reply.XIndex == 0 { last := rf.findLastLogByTerm(reply.XTerm) rf.nextIndex[server] = last } else { // XIndexæ‰¾åˆ°äº†åˆ™ç›´æ¥ä½¿ç”¨XIndexçš„å³å¯ // ä¹Ÿæœ‰å¯èƒ½æ˜¯followerçš„æ—¥å¿—å·²ç»å¿«ç…§åŒ–ï¼Œè®©leaderé‡æ–°æ¢æŸ¥ rf.nextIndex[server] = reply.XIndex } } } åœ¨etcd/raftå½“ä¸­ï¼Œè€ƒè™‘åˆ°æ•…éšœå¹¶ä¸ä¼šç»å¸¸å‘ç”Ÿï¼Œå°†followerçš„æœ€åä¸€æ¡æ—¥å¿—ä½œä¸ºè¯¥å­—æ®µçš„å€¼ï¼Œå› æ­¤å›é€€åˆ°followerçš„æœ€åä¸€æ¡æ—¥å¿—ä¹‹åç”±Leaderå»ä¸€æ¡æ¡æ£€æŸ¥æ—¥å¿—ã€‚\nå¹¶è¡Œå†™å…¥ åœ¨åŸæœ¬çš„Raftå½“ä¸­ï¼Œå¯¹äºæ–°æè®®çš„æ—¥å¿—ï¼Œé¦–å…ˆéœ€è¦å°†æ–°æ—¥å¿—é¦–å…ˆå†™å…¥åˆ°æœ¬åœ°å­˜å‚¨ä¹‹åå†ä¸ºfollowerå¤åˆ¶æ—¥å¿—ï¼Œå‘é€ç½‘ç»œè¯·æ±‚çš„è¿‡ç¨‹è¢«å†™å…¥æŒä¹…åŒ–çš„æ“ä½œé˜»å¡ï¼Œé€ æˆå»¶è¿Ÿã€‚\né€šè¿‡å¹¶è¡Œå†™å…¥çš„æ–¹å¼ï¼Œleaderå¯ä»¥åœ¨ä¸ºfollowerå¤åˆ¶æ—¥å¿—çš„åŒæ—¶å°†æ—¥å¿—å†™å…¥åˆ°æœ¬åœ°çš„ç¨³å®šå­˜å‚¨ä¹‹ä¸­ï¼Œleaderè‡ªå·±çš„match indexè¡¨ç¤ºå…¶å†™å…¥åˆ°äº†ç¨³å®šå­˜å‚¨çš„æœ€åä¸€æ¡æ—¥å¿—çš„ç´¢å¼•ã€‚å½“å½“å‰termçš„æŸæ—¥å¿—è¢«å¤§å¤šæ•°çš„match indexè¦†ç›–æ—¶ï¼Œleaderä¾¿å¯ä»¥ä½¿commit indexå‰è¿›åˆ°è¯¥èŠ‚ç‚¹å¤„ã€‚\næ‰¹å¤„ç† æ‰¹å¤„ç†çš„æ“ä½œä¸»è¦ä½“ç°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š\nproposeæ—¶stepWaitï¼Œç§¯æ”’ä¸€æ‰¹proposeï¼Œæœ€åé€šè¿‡Stepå‘ä¸‹æäº¤çš„ä¸ºä¸€ä¸ª[]Entry é€šè¿‡Readyæ‰€å‘ä¸Šå±‚è¿”å›çš„ä¹Ÿæ˜¯ä¸€æ‰¹æ•°æ®ï¼Œä¸€æ®µæ—¶é—´å†…éœ€è¦è¿›è¡ŒæŒä¹…åŒ–çš„HardStateã€Entryã€Snapshotã€éœ€è¦å‘é€ç»™å…¶ä»–èŠ‚ç‚¹çš„[]Messages leaderåœ¨ä¸ºfollowerè¿›è¡Œæ—¥å¿—å¤åˆ¶æ—¶ä¹Ÿä¼šæˆç»„å‘é€ï¼Œè¿™ä¸ªåœ¨6.824å½“ä¸­ä¹Ÿæœ‰ï¼Œç®—æ˜¯åŸºæœ¬å®ç° æµæ°´çº¿ å’Œä½“ç³»æœºæ„å½“ä¸­çš„æ¦‚å¿µç›¸åŒï¼Œåœ¨StateReplicateçš„çŠ¶æ€ä¸‹ï¼ŒLeaderè®¤ä¸ºFollowerå¯ä»¥ç¨³å®šè·ŸéšLeaderçš„è¿›åº¦ï¼Œå› æ­¤åœ¨ä¸æ”¶åˆ°å“åº”ä¹‹å‰ï¼Œç«‹å³å¯¹Leaderæ‰€åŒ¹é…çš„NextIndexè¿›è¡Œæ›´æ–°ï¼Œä¹‹åç»§ç»­å¤„ç†ä¸‹ä¸€æ¡ï¼Œåœ¨åŒä¸€æ—¶é—´ï¼ŒLeaderæ‰€åœ¨å‘é€çš„è¿˜æœªç»“æŸçš„æŒ‡ä»¤ä¸æ­¢ä¸€æ¡ã€‚\nåœ¨æ­£å¸¸ä¸”ç¨³å®šçš„æƒ…å†µä¸‹ï¼Œæ¶ˆæ¯åº”æ°å¥½ä¸€æ¬¡ä¸”æœ‰åºåˆ°è¾¾ã€‚ä½†æ˜¯åœ¨å¼‚å¸¸æƒ…å†µä¸‹ï¼Œå¯èƒ½å‡ºç°æ¶ˆæ¯ä¸¢å¤±ã€æ¶ˆæ¯ä¹±åºã€‚å½“followeræ”¶åˆ°è¿‡æœŸçš„æ—¥å¿—å¤åˆ¶è¯·æ±‚æ—¶ï¼Œä¼šæ‹’ç»è¯¥è¯·æ±‚ï¼Œéšåfollowerä¼šå›é€€å…¶nextIndexä»¥é‡ä¼ ä¹‹åçš„æ—¥å¿—ã€‚\nSummary ç›¸æ¯”äºRafté€‰ä¸¾çš„è¿‡ç¨‹å½“ä¸­ï¼Œæ—¥å¿—å¤åˆ¶çš„æ•´ä¸ªæµç¨‹å’Œè¦è€ƒè™‘çš„ä¸œè¥¿ä¹Ÿå°±å¤æ‚çš„å¤šï¼Œå†å¼•å…¥äº†Stepã€ProgressTrackerã€ä»¥åŠå­˜å‚¨ä¸é€šä¿¡å•ç‹¬å¤„ç†ï¼Œå°†å­˜å‚¨ã€é€šä¿¡ã€çŠ¶æ€è·Ÿè¸ªä¸ç¡®è®¤å’Œæ•´ä¸ªå¤åˆ¶æµç¨‹è§£è—•ä¹‹åæ¶æ„ä¸Šè¿˜æ˜¯æ¯”è¾ƒæ¸…æ™°çš„ã€‚ä¸è¿‡ç”±äºåˆ†å¸ƒå¼çš„ä¸ç¡®å®šæ€§ï¼Œæ•´ä¸ªå®ç°ä¸ŠåŸºæœ¬éµå¾ªäº†é˜²å¾¡æ€§ç¼–ç¨‹çš„ç†å¿µï¼Œä»¥ç¡®ä¿ç³»ç»Ÿå¤„äºé¢„æœŸçš„çŠ¶æ€ã€‚\nâ€\n","permalink":"https://fischer0522.github.io/en/posts/tech/etcd/raft%E6%97%A5%E5%BF%97/","summary":"Raftæ—¥å¿— æ—¥å¿—å­˜å‚¨ Raftæ—¥å¿—åœ¨å­˜å‚¨ä¸Šåˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†ä¸ºæ–°å†™å…¥æˆ–è€…æ–°ç”Ÿæˆçš„æ—¥å¿—ï¼Œæš‚æ—¶å­˜å‚¨äºå†…å­˜å½“ä¸­ï¼Œè¿˜æœªæ¥å¾—åŠè¿›è¡Œç¨³å®šå­˜å‚¨ã€‚è€Œå¦ä¸€éƒ¨åˆ†åˆ™","title":"etcd/raftæ—¥å¿—å¤åˆ¶"},{"content":"etcd-raftæ•´ä½“æ¶æ„ å¼•ç”¨ï¼šhttp://blog.mrcroxx.com/posts/code-reading/etcdraft-made-simple/2-overview/\nRaftNode å°±åƒåœ¨raft-exampleå½“ä¸­åˆ†æçš„é‚£æ ·ï¼ŒRaft Packageåªè´Ÿè´£Raft çš„å…·ä½“é€»è¾‘çš„å®ç°ï¼Œè€Œå­˜å‚¨é€šä¿¡ç­‰æ¨¡å—å°±äº¤ç»™äº†ä¸Šå±‚çš„Raft Serverï¼Œè€ŒäºŒè€…ä¹‹é—´çš„æ¡¥æ¢å³ä¸ºinterface nodeâ€‹ Raft Packageå¯¹äºraftè¿›è¡Œè¿›ä¸€æ­¥çš„å°è£…ï¼Œå¯¹å¤–åªæš´éœ²ä¸€ä¸ªnodeå€Ÿå£ï¼Œå¼€å‘è€…å¯ä»¥ä½¿ç”¨Nodeæ¥å£å½“ä¸­çš„å‡½æ•°æ¥ä½¿ç”¨Raftï¼Œè€Œå¯¹äºNodeæ¥å£ï¼ŒRaft Packageç”±å®šä¹‰äº†ä¸¤ä¸ªå®ç°çš„ç»“æ„ä½“ï¼Œåˆ†åˆ«æ˜¯node å’Œrawnodeï¼ŒäºŒè€…çš„ä¸»è¦åŒºåˆ«ä¸ºnodeé€šè¿‡channelä¿è¯äº†çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 type Node interface { // Tick increments the internal logical clock for the Node by a single tick. Election // timeouts and heartbeat timeouts are in units of ticks. Tick() // Campaign causes the Node to transition to candidate state and start campaigning to become leader. Campaign(ctx context.Context) error // Propose proposes that data be appended to the log. Note that proposals can be lost without // notice, therefore it is user\u0026#39;s job to ensure proposal retries. Propose(ctx context.Context, data []byte) error // ProposeConfChange proposes a configuration change. Like any proposal, the // configuration change may be dropped with or without an error being // returned. In particular, configuration changes are dropped unless the // leader has certainty that there is no prior unapplied configuration // change in its log. // // The method accepts either a pb.ConfChange (deprecated) or pb.ConfChangeV2 // message. The latter allows arbitrary configuration changes via joint // consensus, notably including replacing a voter. Passing a ConfChangeV2 // message is only allowed if all Nodes participating in the cluster run a // version of this library aware of the V2 API. See pb.ConfChangeV2 for // usage details and semantics. ProposeConfChange(ctx context.Context, cc pb.ConfChangeI) error // Step advances the state machine using the given message. ctx.Err() will be returned, if any. Step(ctx context.Context, msg pb.Message) error // Ready returns a channel that returns the current point-in-time state. // Users of the Node must call Advance after retrieving the state returned by Ready. // // NOTE: No committed entries from the next Ready may be applied until all committed entries // and snapshots from the previous one have finished. Ready() \u0026lt;-chan Ready // Advance notifies the Node that the application has saved progress up to the last Ready. // It prepares the node to return the next available Ready. // // The application should generally call Advance after it applies the entries in last Ready. // // However, as an optimization, the application may call Advance while it is applying the // commands. For example. when the last Ready contains a snapshot, the application might take // a long time to apply the snapshot data. To continue receiving Ready without blocking raft // progress, it can call Advance before finishing applying the last ready. Advance() // ApplyConfChange applies a config change (previously passed to // ProposeConfChange) to the node. This must be called whenever a config // change is observed in Ready.CommittedEntries, except when the app decides // to reject the configuration change (i.e. treats it as a noop instead), in // which case it must not be called. // // Returns an opaque non-nil ConfState protobuf which must be recorded in // snapshots. ApplyConfChange(cc pb.ConfChangeI) *pb.ConfState // TransferLeadership attempts to transfer leadership to the given transferee. TransferLeadership(ctx context.Context, lead, transferee uint64) // ReadIndex request a read state. The read state will be set in the ready. // Read state has a read index. Once the application advances further than the read // index, any linearizable read requests issued before the read request can be // processed safely. The read state will have the same rctx attached. // Note that request can be lost without notice, therefore it is user\u0026#39;s job // to ensure read index retries. ReadIndex(ctx context.Context, rctx []byte) error // Status returns the current status of the raft state machine. Status() Status // ReportUnreachable reports the given node is not reachable for the last send. ReportUnreachable(id uint64) // ReportSnapshot reports the status of the sent snapshot. The id is the raft ID of the follower // who is meant to receive the snapshot, and the status is SnapshotFinish or SnapshotFailure. // Calling ReportSnapshot with SnapshotFinish is a no-op. But, any failure in applying a // snapshot (for e.g., while streaming it from leader to follower), should be reported to the // leader with SnapshotFailure. When leader sends a snapshot to a follower, it pauses any raft // log probes until the follower can apply the snapshot and advance its state. If the follower // can\u0026#39;t do that, for e.g., due to a crash, it could end up in a limbo, never getting any // updates from the leader. Therefore, it is crucial that the application ensures that any // failure in snapshot sending is caught and reported back to the leader; so it can resume raft // log probing in the follower. ReportSnapshot(id uint64, status SnapshotStatus) // Stop performs any necessary termination of the Node. Stop() } ç»“æ„ä½“å½“ä¸­çš„æ³¨è§†å·²ç»ç»™çš„è¾ƒä¸ºæ¸…æ™°ï¼ŒæŒ‘å‡ ä¸ªé‡ç‚¹è¯´ä¸€ä¸‹ï¼š\né¦–å…ˆæ˜¯Tickï¼Œæ­£å¦‚ä¹‹å‰æ‰€è¯´çš„é‚£æ ·ï¼Œetcdå½“ä¸­çš„raftæ¨¡å—ä½¿ç”¨çš„æ˜¯é€»è¾‘æ—¶é’Ÿï¼Œå³éœ€è¦æ‰‹åŠ¨è°ƒç”¨æŸäº›å‡½æ•°æ¥æ¨è¿›æ—¶é’Ÿï¼Œå³ä¸ºæ­¤å¤„çš„Tickï¼Œè¯¥Tickç•™ç»™ä¸Šå±‚åœ¨serverChannelså½“ä¸­è¿›è¡Œè°ƒç”¨ã€‚\nåœ¨Nodeå½“ä¸­æ—¢æœ‰ä¸€ä¸ªTick()å‡½æ•°çš„å®ç°ï¼Œå…¶å‘ä¸€ä¸ªchannelå½“ä¸­å‘é€ä¸€ä¸ªç©ºç»“æ„ä½“ä½œä¸ºé€šçŸ¥ï¼Œè€Œè¿™ä¸ªé€šçŸ¥å°±è¢«node.run()å½“ä¸­çš„ä¸€ä¸ªselectæ¥æ”¶åˆ°ï¼Œä¹‹åè°ƒç”¨ä¸‹å±‚çš„raftçš„tickæœ€ç»ˆé©±åŠ¨æ—¶é’Ÿ\nè€Œrnçš„Tick()ä¸ºä¸€ä¸ªå‡½æ•°ç±»å‹çš„å­—æ®µï¼Œä¼šæ ¹æ®å½“å‰raftnodeçš„èº«ä»½è€Œé€‰æ‹©ä¸åŒçš„Tick()ï¼Œå¦‚TickElection()ã€TickHeartBeat()ç­‰\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 func (n *node) Tick() { select { case n.tickc \u0026lt;- struct{}{}: case \u0026lt;-n.done: default: n.rn.raft.logger.Warningf(\u0026#34;%x A tick missed to fire. Node blocks too long!\u0026#34;, n.rn.raft.id) } } // in node.run() select { case \u0026lt;-n.tickc: n.rn.Tick() } Campaignå’ŒProposeåˆ†åˆ«æ˜¯ç”¨æ¥è¿›è¡Œé€‰ä¸¾å’Œå°†ä¸Šå±‚kvstoreä¼ ä¸‹æ¥çš„è¯·æ±‚å°è£…ä¸ºæ—¥å¿—ï¼Œè¿™ä¸ªç•™åˆ°ä¹‹åçš„é€‰ä¸¾æµç¨‹å’Œæ—¥å¿—å†è¿›è¡Œåˆ†æ\nStep()ä¸ºæ•´ä¸ªRaftæ¨¡å—çš„æ ¸å¿ƒï¼Œæ•´ä¸ªRaftçŠ¶æ€æœºçš„æ”¹å˜æˆ–è€…æ›´æ–°éƒ½ç”±Stepå‡½æ•°æ¥å®Œæˆ\nReady()ä¹‹å‰å·²ç»åˆ†æè¿‡ï¼Œåœ¨Raft Packageå½“ä¸­å·²ç»å®Œæˆäº†çš„å·¥ä½œï¼Œä¹‹åéœ€è¦ä¸Šå±‚çš„raft serverè¿›è¡Œå¤„ç†çš„éƒ½é€šè¿‡Readyè¿›è¡Œä¼ é€’ï¼Œå¦‚éœ€è¦æŒä¹…åŒ–å­˜å‚¨çš„HardStateã€Entriesï¼Œå·²ç»æäº¤äº†éœ€è¦è¿›è¡ŒApplyçš„committedEntriesï¼Œä»¥åŠéœ€è¦å‘é€ç»™å…¶ä»–èŠ‚ç‚¹çš„Messages[]\nAdvance()ï¼Œé€šå¸¸å’ŒReady()æˆå¯¹å‡ºç°ï¼Œå½“ä¸Šå±‚çš„Raft Serverå¤„ç†å®Œä¸€æ‰¹é€šè¿‡Readyè¿”å›çš„å†…å®¹ä¹‹åï¼Œé€šè¿‡Advance()æ¥é€šçŸ¥ä¸‹å±‚çš„Raft Nodeå·²ç»å®Œæˆï¼Œæ¨è¿›è¿›åº¦\nReadIndex()ç”¨äºä¿è¯çº¿æ€§ä¸€è‡´æ€§ï¼Œè¯»å–çŠ¶æ€å…·æœ‰ä¸€ä¸ªè¯»å–ç´¢å¼•ã€‚ä¸€æ—¦åº”ç”¨ç¨‹åºçš„è¿›åº¦è¶…è¿‡äº†è¯»å–ç´¢å¼•ï¼Œä»»ä½•åœ¨è¯»å–è¯·æ±‚ä¹‹å‰å‘å‡ºçš„çº¿æ€§å¯è¯»è¯·æ±‚å°±å¯ä»¥å®‰å…¨åœ°å¤„ç†ã€‚\nRaft Package è¿˜æ˜¯å…ˆçœ‹ä¸€ä¸‹ç›¸å…³çš„ç»“æ„ä½“\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 type raft struct { id uint64 Term uint64 Vote uint64 readStates []ReadState // the log raftLog *raftLog maxMsgSize uint64 maxUncommittedSize uint64 // TODO(tbg): rename to trk. prs tracker.ProgressTracker state StateType // isLearner is true if the local raft node is a learner. isLearner bool msgs []pb.Message // the leader id lead uint64 // leadTransferee is id of the leader transfer target when its value is not zero. // Follow the procedure defined in raft thesis 3.10. leadTransferee uint64 // Only one conf change may be pending (in the log, but not yet // applied) at a time. This is enforced via pendingConfIndex, which // is set to a value \u0026gt;= the log index of the latest pending // configuration change (if any). Config changes are only allowed to // be proposed if the leader\u0026#39;s applied index is greater than this // value. pendingConfIndex uint64 // an estimate of the size of the uncommitted tail of the Raft log. Used to // prevent unbounded log growth. Only maintained by the leader. Reset on // term changes. uncommittedSize uint64 readOnly *readOnly // number of ticks since it reached last electionTimeout when it is leader // or candidate. // number of ticks since it reached last electionTimeout or received a // valid message from current leader when it is a follower. electionElapsed int // number of ticks since it reached last heartbeatTimeout. // only leader keeps heartbeatElapsed. heartbeatElapsed int checkQuorum bool preVote bool heartbeatTimeout int electionTimeout int // randomizedElectionTimeout is a random number between // [electiontimeout, 2 * electiontimeout - 1]. It gets reset // when raft changes its state to follower or candidate. randomizedElectionTimeout int disableProposalForwarding bool tick func() step stepFunc logger Logger // pendingReadIndexMessages is used to store messages of type MsgReadIndex // that can\u0026#39;t be answered as new leader didn\u0026#39;t committed any log in // current term. Those will be handled as fast as first log is committed in // current term. pendingReadIndexMessages []pb.Message } åœ¨å…¶ä¸­é™¤äº†ä¸€ä¸ªraftæœ¬èº«çš„ç»“æ„ä½“ï¼Œè¿˜æœ‰ä¸€ä¸ªconfigç»“æ„ä½“ï¼Œåœ¨åœ¨ä¸Šå±‚çš„startRaftå½“ä¸­è°ƒç”¨é…ç½®Raftçš„åˆå§‹ä¿¡æ¯\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 type Config struct { // ID is the identity of the local raft. ID cannot be 0. ID uint64 // ElectionTick is the number of Node.Tick invocations that must pass between // elections. That is, if a follower does not receive any message from the // leader of current term before ElectionTick has elapsed, it will become // candidate and start an election. ElectionTick must be greater than // HeartbeatTick. We suggest ElectionTick = 10 * HeartbeatTick to avoid // unnecessary leader switching. ElectionTick int // HeartbeatTick is the number of Node.Tick invocations that must pass between // heartbeats. That is, a leader sends heartbeat messages to maintain its // leadership every HeartbeatTick ticks. HeartbeatTick int // Storage is the storage for raft. raft generates entries and states to be // stored in storage. raft reads the persisted entries and states out of // Storage when it needs. raft reads out the previous state and configuration // out of storage when restarting. Storage Storage // Applied is the last applied index. It should only be set when restarting // raft. raft will not return entries to the application smaller or equal to // Applied. If Applied is unset when restarting, raft might return previous // applied entries. This is a very application dependent configuration. Applied uint64 // MaxSizePerMsg limits the max byte size of each append message. Smaller // value lowers the raft recovery cost(initial probing and message lost // during normal operation). On the other side, it might affect the // throughput during normal replication. Note: math.MaxUint64 for unlimited, // 0 for at most one entry per message. MaxSizePerMsg uint64 // MaxCommittedSizePerReady limits the size of the committed entries which // can be applied. MaxCommittedSizePerReady uint64 // MaxUncommittedEntriesSize limits the aggregate byte size of the // uncommitted entries that may be appended to a leader\u0026#39;s log. Once this // limit is exceeded, proposals will begin to return ErrProposalDropped // errors. Note: 0 for no limit. MaxUncommittedEntriesSize uint64 // MaxInflightMsgs limits the max number of in-flight append messages during // optimistic replication phase. The application transportation layer usually // has its own sending buffer over TCP/UDP. Setting MaxInflightMsgs to avoid // overflowing that sending buffer. TODO (xiangli): feedback to application to // limit the proposal rate? MaxInflightMsgs int // CheckQuorum specifies if the leader should check quorum activity. Leader // steps down when quorum is not active for an electionTimeout. CheckQuorum bool // PreVote enables the Pre-Vote algorithm described in raft thesis section // 9.6. This prevents disruption when a node that has been partitioned away // rejoins the cluster. PreVote bool // ReadOnlyOption specifies how the read only request is processed. // // ReadOnlySafe guarantees the linearizability of the read only request by // communicating with the quorum. It is the default and suggested option. // // ReadOnlyLeaseBased ensures linearizability of the read only request by // relying on the leader lease. It can be affected by clock drift. // If the clock drift is unbounded, leader might keep the lease longer than it // should (clock can move backward/pause without any bound). ReadIndex is not safe // in that case. // CheckQuorum MUST be enabled if ReadOnlyOption is ReadOnlyLeaseBased. ReadOnlyOption ReadOnlyOption // Logger is the logger used for raft log. For multinode which can host // multiple raft group, each raft group can have its own logger Logger Logger // DisableProposalForwarding set to true means that followers will drop // proposals, rather than forwarding them to the leader. One use case for // this feature would be in a situation where the Raft leader is used to // compute the data of a proposal, for example, adding a timestamp from a // hybrid logical clock to data in a monotonically increasing way. Forwarding // should be disabled to prevent a follower with an inaccurate hybrid // logical clock from assigning the timestamp and then forwarding the data // to the leader. DisableProposalForwarding bool } Message æ•´ä¸ªRaftçš„çŠ¶æ€æœºçš„åˆ‡æ¢éƒ½æ˜¯é€šè¿‡Stepå‡½æ•°ï¼Œè€ŒStepå‡½æ•°è°ƒç”¨æ—¶ä¼šä¼ å…¥ä¸€ä¸ªmessageï¼Œå› æ­¤ä¸å¦¨å…ˆçœ‹ä¸€ä¸‹message\ngrpcå½“ä¸­çš„æ¶ˆæ¯ä¼ è¾“ä¸ºprotobufçš„å½¢å¼ï¼Œmessageé€šè¿‡grpcè¿›è¡Œä¼ è¾“ï¼Œé¦–å…ˆåœ¨raft.protoå½“ä¸­å®šä¹‰ï¼Œä¹‹åå¯ä»¥ç”Ÿæˆå¯¹åº”çš„goç»“æ„ä½“ã€‚\næ‰€æœ‰çš„rpcçš„æ¶ˆæ¯éƒ½é€šè¿‡Messageæ¥æ‰¿è½½ï¼Œå¦‚RequestVote,AppendEntriesï¼Œé€šè¿‡ä¸€ä¸ªMessageTypeè¿›è¡ŒåŒºåˆ†ã€‚\nMessageä¹Ÿå¹¶ä¸å®Œå…¨ç”¨äºæ¶ˆæ¯ä¼ è¾“ï¼Œå¯¹äºæœ¬æœºçš„æ“ä½œæ¶‰åŠåˆ°ä¿®æ”¹çŠ¶æ€æœºçš„ä¹Ÿå¯ä»¥é€šè¿‡å°è£…æˆä¸€ä¸ªMessageæ¥äº¤ç»™Stepå¤„ç†\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 type Message struct { Type MessageType `protobuf:\u0026#34;varint,1,opt,name=type,enum=raftpb.MessageType\u0026#34; json:\u0026#34;type\u0026#34;` To uint64 `protobuf:\u0026#34;varint,2,opt,name=to\u0026#34; json:\u0026#34;to\u0026#34;` From uint64 `protobuf:\u0026#34;varint,3,opt,name=from\u0026#34; json:\u0026#34;from\u0026#34;` Term uint64 `protobuf:\u0026#34;varint,4,opt,name=term\u0026#34; json:\u0026#34;term\u0026#34;` // logTerm is generally used for appending Raft logs to followers. For example, // (type=MsgApp,index=100,logTerm=5) means leader appends entries starting at // index=101, and the term of entry at index 100 is 5. // (type=MsgAppResp,reject=true,index=100,logTerm=5) means follower rejects some // entries from its leader as it already has an entry with term 5 at index 100. LogTerm uint64 `protobuf:\u0026#34;varint,5,opt,name=logTerm\u0026#34; json:\u0026#34;logTerm\u0026#34;` Index uint64 `protobuf:\u0026#34;varint,6,opt,name=index\u0026#34; json:\u0026#34;index\u0026#34;` Entries []Entry `protobuf:\u0026#34;bytes,7,rep,name=entries\u0026#34; json:\u0026#34;entries\u0026#34;` Commit uint64 `protobuf:\u0026#34;varint,8,opt,name=commit\u0026#34; json:\u0026#34;commit\u0026#34;` Snapshot Snapshot `protobuf:\u0026#34;bytes,9,opt,name=snapshot\u0026#34; json:\u0026#34;snapshot\u0026#34;` Reject bool `protobuf:\u0026#34;varint,10,opt,name=reject\u0026#34; json:\u0026#34;reject\u0026#34;` RejectHint uint64 `protobuf:\u0026#34;varint,11,opt,name=rejectHint\u0026#34; json:\u0026#34;rejectHint\u0026#34;` Context []byte `protobuf:\u0026#34;bytes,12,opt,name=context\u0026#34; json:\u0026#34;context,omitempty\u0026#34;` } æ¶ˆæ¯çš„ç±»å‹å¯ä»¥åœ¨ å½“ä¸­æŸ¥çœ‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 type MessageType int32 // MsgHupç”¨äºè¿›è¡Œé€‰ä¸¾ï¼Œå½“è¶…æ—¶æ˜¯å‘stepå‡½æ•°ä¼ å…¥MsgHup // MsgBeatç”¨äºè®©Leaderå‘å…¶followerå»å‘é€å¿ƒè·³ä¿¡æ¯ // MsgPropç”¨äºAEï¼Œä¼ å…¥stepä¹‹åLeaderé¦–å…ˆå…ˆå‘è‡ªå·±å†™å…¥Entriesï¼Œä¹‹åå‘followerå¹¿æ’­ // MsgAppå½“ä¸­åŒ…å«è¦æ·»åŠ çš„Entriesï¼Œå¦‚æœcandidateæ”¶åˆ°ä¹‹åï¼Œä¼šå°†è‡ªèº«è½¬æ¢ä¸ºfollower // const ( MsgHup MessageType = 0 MsgBeat MessageType = 1 MsgProp MessageType = 2 MsgApp MessageType = 3 MsgAppResp MessageType = 4 MsgVote MessageType = 5 MsgVoteResp MessageType = 6 MsgSnap MessageType = 7 MsgHeartbeat MessageType = 8 MsgHeartbeatResp MessageType = 9 MsgUnreachable MessageType = 10 MsgSnapStatus MessageType = 11 MsgCheckQuorum MessageType = 12 MsgTransferLeader MessageType = 13 MsgTimeoutNow MessageType = 14 MsgReadIndex MessageType = 15 MsgReadIndexResp MessageType = 16 MsgPreVote MessageType = 17 MsgPreVoteResp MessageType = 18 ) Step etcdå½“ä¸­å°†æ‰€æœ‰å’ŒRaftçŠ¶æ€æœºç›¸å…³çš„æ“ä½œå…¨éƒ¨é›†ä¸­äºStepå½“ä¸­ï¼Œè€Œå…·ä½“åº”å½“è¿›è¡Œä½•ç§æ“ä½œåˆ™æ ¹æ®Stepå½“ä¸­ä¼ å…¥çš„Messageå½“ä¸­çš„MessageTypeè¿›è¡Œåˆ¤æ–­ï¼Œè€Œå¯¹äºMessageçš„è°ƒç”¨ï¼Œä¸€èˆ¬åœ¨Nodeå½“ä¸­æˆ–ç›´æ¥æˆ–é—´æ¥çš„å¯¹å…¶è¿›è¡Œè°ƒç”¨ã€‚\nå¯¹äºStepï¼Œé¦–å…ˆå®šä¹‰ä¸€ä¸ªç»Ÿä¸€çš„Stepå‡½æ•°ï¼Œåœ¨å…¶ä¸­è¿›è¡Œä¸€äº›é¢„å¤„ç†æˆ–è€…ç»¼åˆå¤„ç†ï¼Œå³æ— è®ºå½“å‰çš„èŠ‚ç‚¹çš„èº«ä»½ä¸ºä½•éƒ½å¯èƒ½éœ€è¦è¿›è¡Œçš„æ“ä½œï¼Œä¹‹ååœ¨å•ç‹¬å®šä¹‰å‡ ä¸ªstepå‡½æ•°ï¼Œé’ˆå¯¹ä¸åŒèº«ä»½çš„èŠ‚ç‚¹ã€‚åœ¨Stepå½“ä¸­ï¼Œç»¼åˆå¤„ç†å®Œä¹‹åä»éœ€å¤„ç†çš„å°±è°ƒç”¨å•ç‹¬çš„stepã€‚è€Œå¦‚æœæœ‰ä¸€äº›æ“ä½œå°±æ˜¯é’ˆå¯¹æŸäº›ç‰¹å®šèº«ä»½ï¼Œä¹Ÿå¯ä»¥ç›´æ¥è°ƒç”¨å¯¹åº”çš„stepxxxï¼Œæ— éœ€è°ƒç”¨Stepã€‚\né’ˆå¯¹ç‰¹å®šèº«ä»½çš„stepå¦‚ä¸‹ï¼Œä½œä¸ºä¸€ä¸ªå‡½æ•°ç±»å‹çš„å˜é‡å®šä¹‰åœ¨ç»“æ„ä½“å½“ä¸­ï¼Œåœ¨çŠ¶æ€åˆ‡æ¢æ—¶è¿›è¡Œè®¾ç½®\n1 2 3 func stepLeader(r *raft, m pb.Message) error {...} func stepCandidate(r *raft, m pb.Message) error {...} func stepFollower(r *raft, m pb.Message) error {...} 1 2 3 4 5 6 7 8 func (r *raft) becomeFollower(term uint64, lead uint64) { r.step = stepFollower r.reset(term) r.tick = r.tickElection r.lead = lead r.state = StateFollower r.logger.Infof(\u0026#34;%x became follower at term %d\u0026#34;, r.id, r.Term) } 1 2 3 4 5 6 7 8 9 switch m.Type { case xxx: // ... default: err := r.step(r, m) if err != nil { return err } â€\nCampaign:Campaignåªä¼šç”±candidateå‡ºå‘ï¼Œå¯¹stepâ€‹çš„ç›´æ¥è°ƒç”¨ï¼Œæœ€ç»ˆä¼šè°ƒç”¨åˆ°stepCandidateâ€‹\n1 2 3 func (n *node) Campaign(ctx context.Context) error { return n.step(ctx, pb.Message{Type: pb.MsgHup}) } Tickâ€‹ï¼šç®—æ˜¯å¯¹Stepçš„é—´æ¥è°ƒç”¨ï¼Œä¸»è¦é¡ºåºå¦‚ä¸‹ï¼š\nè°ƒç”¨Tickæ—¶å‘channelå½“ä¸­å‘é€ä¸€æ¡é€šçŸ¥ è¯¥é€šçŸ¥è¢«è¿è¡Œnode.run()å½“ä¸­çš„åç¨‹è·å–åˆ°ï¼Œè°ƒç”¨ä¸‹å±‚raftçš„Tickï¼Œè¯¥TickåŒæ ·ä¸ºä¸€ä¸ªå‡½æ•°ç±»å‹çš„å˜é‡ï¼Œå¦‚æœå½“å‰ä¸ºLeaderï¼Œé‚£ä¹ˆå°±ä¼šè°ƒç”¨åˆ°tickHeartBeatâ€‹ åœ¨tickHeartBeatâ€‹å½“ä¸­è°ƒç”¨åˆ°æœ€ç»ˆçš„Stepï¼Œå¯¹çŠ¶æ€æœºè¿›è¡Œæ“ä½œ 1 2 3 4 5 6 7 8 func (n *node) Tick() { select { case n.tickc \u0026lt;- struct{}{}: case \u0026lt;-n.done: default: n.rn.raft.logger.Warningf(\u0026#34;%x A tick missed to fire. Node blocks too long!\u0026#34;, n.rn.raft.id) } } 1 2 case \u0026lt;-n.tickc: n.rn.Tick() 1 2 3 func (rn *RawNode) Tick() { rn.raft.tick() } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 func (r *raft) tickHeartbeat() { r.heartbeatElapsed++ r.electionElapsed++ if r.electionElapsed \u0026gt;= r.electionTimeout { r.electionElapsed = 0 // æ£€æŸ¥å½“å‰æ´»è·ƒçš„followeræ˜¯å¦æ»¡è¶³quorum å³å¤§å¤šæ•° if r.checkQuorum { r.Step(pb.Message{From: r.id, Type: pb.MsgCheckQuorum}) } // If current leader cannot transfer leadership in electionTimeout, it becomes leader again. if r.state == StateLeader \u0026amp;\u0026amp; r.leadTransferee != None { r.abortLeaderTransfer() } } if r.state != StateLeader { return } if r.heartbeatElapsed \u0026gt;= r.heartbeatTimeout { r.heartbeatElapsed = 0 r.Step(pb.Message{From: r.id, Type: pb.MsgBeat}) } } â€\nâ€\n","permalink":"https://fischer0522.github.io/en/posts/tech/etcd/etcd-raft%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84/","summary":"etcd-raftæ•´ä½“æ¶æ„ å¼•ç”¨ï¼šhttp://blog.mrcroxx.com/posts/code-reading/etcdraft-ma","title":"etcd-raftæ•´ä½“æ¶æ„"},{"content":"Rafté€‰ä¸¾æµç¨‹ å¼•ç”¨ï¼šhttp://blog.mrcroxx.com/posts/code-reading/etcdraft-made-simple/3-election/\nRafté€‰ä¸¾æµç¨‹ä¼˜åŒ– å¯¹äºRaftçš„åŸºæœ¬å®ç°ï¼Œå‘ˆç°åœ¨Diego Ongaroçš„ã€ŠIn Search of an Understandable Consensus Algorithm (Extended Version)ã€‹ä¸€æ–‡å½“ä¸­ã€‚å®ç°äº†Raftçš„åŸºæœ¬åŠŸèƒ½ã€‚è€Œåˆåœ¨Ongaroçš„åšå£«è®ºæ–‡å½“ä¸­ï¼Œå¯¹äºRaftçš„é€‰ä¸¾æµç¨‹æå‡ºäº†ä¸‰ç§ä¼˜åŒ–ï¼Œåˆ†åˆ«æ˜¯Pre-Vote,Check Quorumã€Leader Leaseã€‚\nPreVote æƒ³è±¡è¿™æ ·çš„ä¸€ç§åœºæ™¯ï¼Œåœ¨ä¸€ä¸ªäº”ä¸ªèŠ‚ç‚¹çš„Rafté›†ç¾¤å½“ä¸­å‘ç”Ÿäº†ç½‘ç»œåˆ†åŒºï¼Œ åˆ†ä¸ºäº†ä¸€ä¸ªä¸‰ä¸ªèŠ‚ç‚¹çš„åˆ†åŒºå’Œä¸€ä¸ªä¸¤ä¸ªèŠ‚ç‚¹çš„åˆ†åŒºã€‚\nä¸‰ä¸ªèŠ‚ç‚¹çš„åˆ†åŒºå½“ä¸­å¦‚æœä¸å‘ç”Ÿå®•æœºçš„è¯ï¼Œç”±äºæ»¡è¶³Quorumæ•°ï¼ŒLeaderå¯ä»¥ä¸€ç›´ç»´æŒä»–çš„ä»»æœŸï¼Œå› æ­¤Termä¸€ç›´ä¸å˜ã€‚ä½†æ˜¯ä¸¤ä¸ªå½“ä¸­çš„èŠ‚ç‚¹æ•°ä¸è¶³ï¼Œå› æ­¤ä¸€ç›´ä¼šå°è¯•Leader Electionçš„è¿‡ç¨‹ï¼Œ åˆå› ä¸ºèŠ‚ç‚¹æ•°ä¸è¶³ï¼Œé€‰ä¸¾ä¸€ç›´ä¸ä¼šæˆåŠŸï¼Œè€Œåœ¨è¿™ä¸ªè¿‡ç¨‹å½“ä¸­ï¼ŒèŠ‚ç‚¹æ¯æ¬¡è¿›è¡Œé€‰ä¸¾éƒ½ä¼šè‡ªå¢è‡ªèº«çš„Termå·ã€‚\nå½“ç½‘ç»œåˆ†åŒºæ¢å¤ä¹‹åï¼Œä¸¤ä¸ªåˆ†åŒºåˆèƒ½å¤Ÿäº’é€šï¼Œæ­¤æ—¶3ä¸ªèŠ‚ç‚¹çš„åˆ†åŒºå½“ä¸­çš„Leaderä¼šæ”¶åˆ°æ¥è‡ªäºŒèŠ‚ç‚¹çš„RequestVoteï¼Œå¹¶ä¸”Termé«˜äºè‡ªèº«çš„Termï¼Œä»è€Œä¼šå¯¼è‡´Leaderè½¬æ¢ä¸ºFollowerï¼Œä¹‹ååœ¨é‡æ–°è¿›è¡Œä¸€è½®é€‰ä¸¾ã€‚\nåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¼šå¯¼è‡´ç³»ç»Ÿçš„Termæ— æ„ä¹‰çš„å¢å¤§ï¼Œå¹¶ä¸”åœ¨ç½‘ç»œåˆ†åŒºæ¢å¤æ—¶ä¼šé¢å¤–è¿›è¡Œä¸€æ¬¡é€‰ä¸¾ã€‚\né€šè¿‡PreVoteçš„æœºåˆ¶ï¼Œå¯ä»¥è§£å†³ä»¥ä¸Šé—®é¢˜ï¼Œåœ¨æ­£å¼æŠ•ç¥¨ä¹‹å‰ï¼Œå…ˆè¿›è¡Œä¸€è½®é‡æŠ•ç¥¨ï¼Œåœ¨é¢„æŠ•ç¥¨é˜¶æ®µä¸å¯¹è‡ªå·±çš„Termè¿›è¡Œè‡ªå¢ï¼Œå¦‚æœåœ¨é¢„æŠ•ç¥¨å½“ä¸­èƒ½å¤Ÿé€‰å‡ºLeaderï¼Œå³è¶…è¿‡1/2çš„èŠ‚ç‚¹ç»™å‡ºèµæˆæŠ•ç¥¨ï¼Œé‚£ä¹ˆå°±å¯ä»¥å¯¹è‡ªå·±çš„Termè¿›è¡Œè‡ªå¢ï¼Œè¿›è¡Œæ­£å¼çš„é€‰ä¸¾è¿‡ç¨‹ã€‚æ­¤æ—¶å°±å¯ä»¥ä¿è¯åœ¨ä¸Šé¢çš„ä¾‹å­å½“ä¸­å³è¾¹çš„åˆ†åŒºç”±äºä¸€ç›´æ— æ³•é€‰ä¸¾å‡ºLeaderï¼Œä»è€Œä¸ä¼šå¯¹Termè¿›è¡Œè‡ªå¢ï¼Œä¹‹åç½‘ç»œåˆ†åŒºæ¢å¤ä¹‹åï¼ŒTermä¹Ÿä¸€å®š \u0026lt;=ä¸»åˆ†åŒºçš„Termï¼Œä»è€Œå¯ä»¥å¾ˆè‡ªç„¶çš„åŠ å…¥åˆ°ä¸»åˆ†åŒºå½“ä¸­ï¼Œä¸ä¼šå¼•èµ·å½“å‰Leaderçš„é€€ä½ã€‚\nCheck Quorum è¿˜æ˜¯ä»¥åˆšæ‰çš„ä¾‹å­ï¼Œä½†æ˜¯è¿™æ¬¡åœ¨å‡ºç°ç½‘ç»œåˆ†åŒºå‰Leaderä½äºå³è¾¹çš„åˆ†åŒºå½“ä¸­ï¼Œè™½ç„¶æ­¤æ—¶æ–°çš„è¯·æ±‚å†ä¹Ÿæ— æ³•è¾¾æˆå…±è¯†ï¼Œä½†æ˜¯ç”±äºRaftçš„èŠ‚ç‚¹ä¸ä¼šä¸»åŠ¨çš„æ£€æµ‹å½“å‰é›†ç¾¤çš„çŠ¶æ€ï¼Œå› æ­¤æ­¤æ—¶çš„Leaderä»è®¤ä¸ºè‡ªå·±ä¸ºLeaderï¼Œè¿˜ä¼šä¸æ–­çš„æ¥å—æ–°çš„è¯·æ±‚å’Œå‘é€å¿ƒè·³ä¿¡æ¯ã€‚\nå¦‚æœåƒMIT6.824å½“ä¸­é‚£æ ·é€šè¿‡Raftæ—¥å¿—æ¥ä¿è¯å¼ºä¸€è‡´æ€§ï¼Œå³æ¯æ¡è¯·æ±‚æ— è®ºè¯»å†™éƒ½å°†å…¶å†™å…¥åˆ°Raftæ—¥å¿—å½“ä¸­å½¢æˆå…±è¯†ï¼Œå½“è¾¾æˆå…±è¯†ä¹‹åå†ç»™äºˆå®¢æˆ·ç«¯å“åº”ã€‚æ­¤æ—¶åœ¨å°‘æ•°åˆ†åŒºå½“ä¸­çš„Leaderæ¥å—äº†è¯·æ±‚ä¹Ÿæ— æ³•è¾¾æˆå…±è¯†ï¼Œä»è€Œä¼šè¶…æ—¶å‘å®¢æˆ·ç«¯æŠ¥é”™ã€‚ä¹‹åå®¢æˆ·ç«¯å°±å¯ä»¥åˆ¤æ–­å½“å‰çš„Leaderä¸ºä¸å¯ç”¨çŠ¶æ€ã€‚æ­¤æ—¶æ²¡æœ‰å‡ºç°ä»»ä½•é—®é¢˜ã€‚\nä½†æ˜¯ç”¨äºç½‘ç»œåº”ç”¨é€šå¸¸ä¸ºè¯»å¤šå†™å°‘çš„ç±»å‹ï¼Œæ­¤æ—¶ä½¿ç”¨Log Readä¼šå¯¼è‡´è¯»çš„æ€§èƒ½å¾ˆå·®ï¼Œå› æ­¤å¯ä»¥é‡‡ç”¨åœ¨Leaderè¿›è¡Œæœ¬åœ°è¯»çš„æ–¹å¼ï¼Œæé«˜è¯»å–æ€§èƒ½ã€‚\nä½†æ˜¯æ­¤æ—¶å¦‚æœå‘ç”Ÿä¸Šè¿°çš„ç½‘ç»œåˆ†åŒºé—®é¢˜æ—¶ï¼Œå°±ä¼šè¯»å–åˆ°æ—§çš„æ•°æ®ï¼Œè¿åçº¿æ€§ä¸€è‡´æ€§ã€‚\nåœ¨å¼€å¯Check Quorumåï¼ŒLeaderä¼šå‘¨æœŸæ€§çš„å‘Followerå»å‘é€ä¸€æ¡ä¿¡æ¯ï¼Œå»ç¡®è®¤å½“å‰é›†ç¾¤å½“ä¸­çš„å­˜æ´»çš„Followeræ•°é‡ï¼Œæ˜¯å¦æ»¡è¶³Quorumï¼Œå¦‚æœä¸æ»¡è¶³ï¼Œåˆ™è¯æ˜æ­¤æ—¶å‘ç”Ÿäº†ç½‘ç»œåˆ†åŒºï¼Œå¹¶ä¸”å½“å‰çš„Leaderå¤„äºèŠ‚ç‚¹æ•°å°‘çš„é‚£ä¸ªåˆ†åŒºï¼Œæ­¤æ—¶Leaderå°±åº”å½“é€€ä½å˜ä¸ºFollowerã€‚é€šè¿‡Check Quorumæœºåˆ¶å¯ä»¥å°½æ—©çš„å‘ç°ç½‘ç»œåˆ†åŒºçš„é—®é¢˜ï¼Œä½†æ˜¯ä¾æ—§ä¸èƒ½å®Œå…¨è§£å†³stale readçš„é—®é¢˜ï¼Œéœ€è¦å…¶ä»–çš„æ‰‹æ®µæ¥ä¿è¯å¼ºä¸€è‡´æ€§ã€‚\nLeader Lease åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ï¼Œå¯èƒ½ä¼šå‡ºç°éƒ¨åˆ†ç½‘ç»œåˆ†åŒºçš„é—®é¢˜ï¼Œå³A-B B-Cä¹‹å‰éƒ½èƒ½ç›¸äº’é€šä¿¡ï¼Œä½†æ˜¯A-Cä¹‹é—´ä¸é€šã€‚\næ­¤æ—¶èŠ‚ç‚¹2ä¼šå› ä¸ºæ”¶ä¸åˆ°èŠ‚ç‚¹1çš„æ¶ˆæ¯è€Œå°è¯•é‡æ–°è¿›è¡Œé€‰ä¸¾ï¼Œè€Œåœ¨èŠ‚ç‚¹2å’ŒèŠ‚ç‚¹1å‘ç”Ÿç½‘ç»œéƒ¨åˆ†åˆ†åŒºåˆ°èŠ‚ç‚¹2è¶…æ—¶é‡æ–°é€‰ä¸¾è¿™æ®µæ—¶é—´å†…å¦‚æœ1 3æ²¡æœ‰å†™å…¥æ–°çš„Logï¼ŒèŠ‚ç‚¹2å°±å¯ä»¥æ‹¿åˆ°è‡ªèº«å’ŒèŠ‚ç‚¹3çš„é€‰ç¥¨ï¼Œä»è€Œæˆä¸ºLeaderã€‚ç”±äºé€‰ä¸¾å¯¼è‡´çš„èŠ‚ç‚¹Termå¢åŠ å°±ä¼šä»2 ä¼ åˆ° 3ï¼Œä¹‹å1å†å‘3å‘é€æ¶ˆæ¯å°±ä¼šå› ä¸ºTermä½äºèŠ‚ç‚¹3è€Œå˜ä¸ºFollowerï¼Œæœ€ç»ˆèŠ‚ç‚¹2ä¼šæˆä¸ºæ•´ä¸ªé›†ç¾¤æ–°çš„Nodeï¼Œä½†æ˜¯é›†ç¾¤çš„çŠ¶æ€ä¹ŸåŸæœ¬å¹¶æ²¡æœ‰ä»€ä¹ˆå·®å¼‚ï¼Œå¯ä»¥è§†ä¸ºä¸€ä¸ªæ— æ„ä¹‰çš„é€‰ä¸¾ã€‚\né€šè¿‡Leader Leaseå¯ä»¥è§£å†³è¯¥é—®é¢˜ï¼šå½“èŠ‚ç‚¹åœ¨Election Timeoutè¶…æ—¶ä¹‹å‰ï¼Œå¦‚æœæ”¶åˆ°äº†Leaderçš„æ¶ˆæ¯ï¼Œé‚£ä¹ˆä»–å°±ä¸ä¼šå†å»å“åº”å…¶ä»–èŠ‚ç‚¹å‘èµ·çš„RequestVoteçš„æŠ•ç¥¨å’Œé¢„æŠ•ç¥¨çš„æ¶ˆæ¯ã€‚å³é˜»æ­¢æ­£å¸¸å·¥ä½œçš„èŠ‚ç‚¹ç»™å…¶ä»–èŠ‚ç‚¹è¿›è¡ŒæŠ•ç¥¨ã€‚\nLeader Leaseæœºåˆ¶éœ€è¦å’ŒCheck Quorumé…åˆä½¿ç”¨ï¼Œä¸€ç§å¯èƒ½çš„å±€éƒ¨ç½‘ç»œåˆ†åŒºå¦‚ä¸‹ï¼š\nâ€\næ­¤æ—¶ç†æƒ³çŠ¶æ€ä¸º3 4 å‘èµ·é€‰ä¸¾ï¼Œäº§ç”Ÿæ–°çš„é›†ç¾¤[2 3 4]ï¼Œå¦‚æœåªå¼•å…¥äº†Leader Leaseæœºåˆ¶ï¼Œæ­¤æ—¶åªæœ‰2å¯ä»¥ä¸Leader1è¿›è¡Œæ­£å¸¸é€šä¿¡ï¼Œå› æ­¤æ­¤æ—¶çš„2ä¸ä¼šå¼€å¯é€‰ä¸¾ä¹Ÿä¸ä¼šä¸ºå…¶ä»–äººæŠ•ç¥¨ï¼Œ3 4 æœ€å¤šåªèƒ½å¾—åˆ°ä¸¤ç¥¨ä»è€Œæ— æ³•é€‰ä¸¾å‡ºLeaderï¼Œè€Œå¦‚æœå¼•å…¥Check Quorumæœºåˆ¶ä¹‹åï¼ŒLeaderæœ€å¤šåªèƒ½æ£€æµ‹åˆ°ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå› æ­¤å°±ä¼šé€€ä½ï¼Œä»è€Œä¸ä¼šå› ä¸ºLeader Leaseå¹²æ‰°æ­£å¸¸çš„é€‰ä¸¾æµç¨‹ï¼Œ2 3 4å½¢æˆæ–°çš„å¯ç”¨é›†ç¾¤ã€‚\nä¼˜åŒ–å¼•å…¥çš„é—®é¢˜ åœ¨å¼•å…¥Leader Leaseå¹¶é¡ºå¸¦å¼€å¯Check Quorumä¹‹åï¼Œæ— è®ºæ˜¯å¦å¼€å¯PreVoteï¼Œéƒ½ä¼šå¼•å…¥æ–°çš„é—®é¢˜ï¼Œå‡è®¾ä¸å¼€å¯PreVoteï¼Œåœ¨å‘ç”Ÿç½‘ç»œåˆ†åŒºä¹‹åï¼ŒèŠ‚ç‚¹3å°±ä¼šä¸æ–­çš„è‡ªå¢è‡ªå·±çš„Termï¼Œè€Œå¦‚æœå¼€å¯äº†Leader Leaseï¼ŒèŠ‚ç‚¹1 2å°±ä¼šå¿½ç•¥èŠ‚ç‚¹3çš„æŠ•ç¥¨ä¿¡æ¯ï¼Œæˆ–èŠ‚ç‚¹1 2å†™å…¥äº†æ–°çš„æ—¥å¿—ï¼Œç”±äºæ—¥å¿—çš„å®‰å…¨æ€§é—®é¢˜å¿½ç•¥3çš„RequestVoteï¼Œè€ŒèŠ‚ç‚¹1 2å‘èŠ‚ç‚¹3å‘é€çš„æ¶ˆæ¯ä¹Ÿä¼šå› ä¸ºTermè¿‡ä½è€Œå¯¼è‡´è¢«å¿½ç•¥ã€‚\nè€Œå¦‚æœå¼•å…¥äº†PreVoteä¹‹åä¹Ÿä¼šäº§ç”Ÿç±»ä¼¼çš„æƒ…å†µï¼Œç½‘ç»œåˆ†åŒºæ¢å¤ä¹‹åèŠ‚ç‚¹3å‘èµ·ä¸€è½®PreVoteï¼Œå¹¶å¾—åˆ°äº†èŠ‚ç‚¹1 2 çš„å›åº”ï¼Œåˆäº§ç”Ÿäº†èŠ‚ç‚¹3çš„Termæ¯”1 2é«˜çš„é—®é¢˜\nåœ¨åŸæœ¬çš„Raftå½“ä¸­ï¼ŒèŠ‚ç‚¹1 2æ”¶åˆ°äº†3çš„RequestVoteï¼Œç”±äº3çš„Termæ›´é«˜ï¼Œä»è€Œä¼šä»¤1é€€ä½å¹¶æ›´æ–°Termï¼Œ2æ›´æ–°Termï¼Œä¹‹åå³å¯åœ¨ç›¸åŒçš„Termä¸‹è¿›è¡Œæ–°ä¸€è½®çš„é€‰ä¸¾ï¼Œä»è€Œé¿å…äº†ä¸Šè¿°çš„æƒ…å†µã€‚\nå¤„ç†æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼ŒæŒ‰ç…§å’ŒåŸæœ¬å·®ä¸å¤šçš„æ€è·¯è¿›è¡Œå¤„ç†ï¼ŒåŸæœ¬ä¼šè‡ªåŠ¨å¤„ç†è·Ÿéšé«˜Termï¼Œæ­¤å¤„å°±æ‰‹åŠ¨å‘é€ä¸€æ¬¡é«˜Termå¼ºåˆ¶è·Ÿéšï¼šå¦‚æœæ”¶åˆ°äº†termæ¯”å½“å‰èŠ‚ç‚¹termä½çš„leaderçš„æ¶ˆæ¯ï¼Œä¸”é›†ç¾¤å¼€å¯äº†Check Quorum / Leader Leaseæˆ–Pre-Voteï¼Œé‚£ä¹ˆå‘é€ä¸€æ¡termä¸ºå½“å‰termçš„æ¶ˆæ¯ï¼Œä»¤termä½çš„èŠ‚ç‚¹æˆä¸ºfollower\né…ç½®æ›´æ–°\nåœ¨æ›´å¤æ‚çš„æƒ…å†µä¸­ï¼Œæ¯”å¦‚ï¼Œåœ¨å˜æ›´é…ç½®æ—¶ï¼Œå¼€å¯äº†åŸæœ¬æ²¡æœ‰å¼€å¯çš„Pre-Voteæœºåˆ¶ã€‚æ­¤æ—¶å¯èƒ½ä¼šå‡ºç°ä¸ä¸Šä¸€æ¡ç±»ä¼¼çš„æƒ…å†µï¼Œå³å¯èƒ½å› termæ›´é«˜ä½†æ˜¯logæ›´æ—§çš„èŠ‚ç‚¹çš„å­˜åœ¨å¯¼è‡´æ•´ä¸ªé›†ç¾¤çš„æ­»é”ï¼Œæ‰€æœ‰èŠ‚ç‚¹éƒ½æ— æ³•é¢„æŠ•ç¥¨æˆåŠŸã€‚è¿™ç§æƒ…å†µæ¯”ä¸Šä¸€ç§æƒ…å†µæ›´å±é™©ï¼Œä¸Šä¸€ç§æƒ…å†µåªæœ‰ä¹‹å‰åˆ†åŒºçš„èŠ‚ç‚¹æ— æ³•åŠ å…¥é›†ç¾¤ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ•´ä¸ªé›†ç¾¤éƒ½ä¼šä¸å¯ç”¨\nå¤„ç†æ–¹æ³•ä¸ºå¯¹äºtermæ¯”å½“å‰èŠ‚ç‚¹ä½çš„Termçš„PreVoteï¼Œæ— è®ºæ˜¯å¦å¼€å¯äº†Check Quorum Leader Leaseï¼Œéƒ½é€šè¿‡å‘é€ä¸€æ¡ä¸ºå½“å‰Termçš„ä¿¡æ¯ï¼Œè¿«ä½¿å…¶è½¬æ¢ä¸ºFollowerå¹¶æ›´æ–°Termã€‚\né€‰ä¸¾æµç¨‹ RaftNode/Campaign åœ¨Nodeæ¥å£å½“ä¸­ï¼Œå¯¹å¤–æä¾›äº†ä¸€ä¸ªCampaignå‡½æ•°ï¼Œè°ƒç”¨è¯¥å‡½æ•°å³å¯ä»¥MsgHupä¸ºå‚æ•°è°ƒç”¨step(æ­¤å¤„è°ƒç”¨çš„ä¸ºstepFollower)ï¼Œä»è€Œå¼€å¯é€‰ä¸¾çš„è¿‡ç¨‹\n1 2 3 func (n *node) Campaign(ctx context.Context) error { return n.step(ctx, pb.Message{Type: pb.MsgHup}) } ä½†æ˜¯æ›´ä¸ºå¸¸è§çš„ä¸ºé€šè¿‡Tick()å‡½æ•°è¿›è¡Œè§¦å‘ï¼Œç»è¿‡åœ¨ä¸Šä¸€ç« å½“ä¸­åˆ†æçš„Tickæµç¨‹ï¼Œæœ€ç»ˆè°ƒç”¨åˆ°äº†followeræˆ–è€…candidateçš„tickEelction,ä¹‹ååœ¨è°ƒç”¨Stepï¼Œåœ¨å…¶ä¸­è§¦å‘é€‰ä¸¾\n1 2 3 4 5 6 7 8 9 // tickElection is run by followers and candidates after r.electionTimeout. func (r *raft) tickElection() { r.electionElapsed++ if r.promotable() \u0026amp;\u0026amp; r.pastElectionTimeout() { r.electionElapsed = 0 r.Step(pb.Message{From: r.id, Type: pb.MsgHup}) } } hup/campaign æœ€ç»ˆçš„é€‰ä¸¾é€»è¾‘æ˜¯åœ¨hup/campaignå‡½æ•°å½“ä¸­è¿›è¡Œå¤„ç†çš„ï¼Œå…ˆçœ‹ä¸€çœ‹å½“ä¸­çš„é€»è¾‘ï¼Œä¹‹åå†ç ”ç©¶è¿™ä¸¤ä¸ªå‡½æ•°çš„è°ƒç”¨æ—¶æœº\nhup hupå‡½æ•°ç»è¿‡ä¸€å®šçš„æ£€æŸ¥ä¹‹åå¼€å¯é€‰ä¸¾è¿‡ç¨‹ï¼š\nå½“å‰å¦‚æœä¸ºLeaderï¼Œé‚£ä¹ˆåˆ™ä¸èƒ½å¤Ÿè¿›è¡Œé€‰ä¸¾ é€šè¿‡promotableâ€‹æŸ¥çœ‹å½“å‰èŠ‚ç‚¹æ˜¯å¦èƒ½å¤Ÿæå‡ä¸ºLeader æŸ¥çœ‹å½“å‰æ˜¯å¦æœ‰è¿˜æœ‰æäº¤çš„æ—¥å¿—ã€‚ å½“å‰çš„èŠ‚ç‚¹å·²æäº¤çš„æ—¥å¿—ä¸­ï¼Œæ˜¯å¦æœ‰è¿˜æœªè¢«åº”ç”¨çš„é›†ç¾¤é…ç½®å˜æ›´ConfChangeâ€‹æ¶ˆæ¯ï¼Œå¦‚æœæœ‰ï¼Œä¾æ—§ä¸èƒ½è¿›è¡Œé€‰ä¸¾ å¦‚æœä¸Šè¿°æ£€æŸ¥å…¨éƒ¨é€šè¿‡ï¼Œé‚£ä¹ˆå³å¯å°è¯•è¿›è¡Œé€‰ä¸¾ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 func (r *raft) hup(t CampaignType) { if r.state == StateLeader { r.logger.Debugf(\u0026#34;%x ignoring MsgHup because already leader\u0026#34;, r.id) return } if !r.promotable() { r.logger.Warningf(\u0026#34;%x is unpromotable and can not campaign\u0026#34;, r.id) return } ents, err := r.raftLog.slice(r.raftLog.applied+1, r.raftLog.committed+1, noLimit) if err != nil { r.logger.Panicf(\u0026#34;unexpected error getting unapplied entries (%v)\u0026#34;, err) } if n := numOfPendingConf(ents); n != 0 \u0026amp;\u0026amp; r.raftLog.committed \u0026gt; r.raftLog.applied { r.logger.Warningf(\u0026#34;%x cannot campaign at term %d since there are still %d pending configuration changes to apply\u0026#34;, r.id, r.Term, n) return } r.logger.Infof(\u0026#34;%x is starting a new election at term %d\u0026#34;, r.id, r.Term) r.campaign(t) } promoptableâ€‹ï¼š\nåœ¨è¯¥å‡½æ•°å½“ä¸­ä¸»è¦æ£€æŸ¥ä¸‰æ¡ï¼š\nå½“å‰èŠ‚ç‚¹æ˜¯å¦ä¸ºæ–°åŠ å…¥é›†ç¾¤å½“ä¸­è¿½èµ¶è¿›åº¦çš„Learner å½“å‰èŠ‚ç‚¹æ˜¯å¦å±äºå½“å‰çš„é›†ç¾¤ æ˜¯å¦è¿˜æœ‰æœªåº”ç”¨çš„Snapshot 1 2 3 4 5 6 // promotable indicates whether state machine can be promoted to leader, // which is true when its own id is in progress list. func (r *raft) promotable() bool { pr := r.prs.Progress[r.id] return pr != nil \u0026amp;\u0026amp; !pr.IsLearner \u0026amp;\u0026amp; !r.raftLog.hasPendingSnapshot() } ä¹‹åï¼Œå³å¯è°ƒç”¨campaignå°è¯•è¿›è¡Œé€‰ä¸¾\ncampaign ç”±äºè°ƒç”¨campaginçš„ä½ç½®å¹¶ä¸åªhupå½“ä¸­ï¼Œå› æ­¤æœ€åˆé¦–å…ˆä¹Ÿéœ€è¦æ£€æŸ¥promotableã€‚\nè°ƒç”¨campaignæ—¶ï¼Œä¼ å…¥ä¸€ä¸ªå‚æ•°è¡¨ç¤ºå½“å‰ä¸ºé¢„é€‰ä¸¾è¿˜æ˜¯æ­£å¼é€‰ä¸¾ã€‚ä¹‹åæ ¹æ®è¯¥å‚æ•°å¯¹å½“å‰èŠ‚ç‚¹çš„çŠ¶æ€è¿›è¡Œæ›´æ–°\n1 2 3 4 5 6 7 8 9 10 if t == campaignPreElection { r.becomePreCandidate() voteMsg = pb.MsgPreVote // PreVote RPCs are sent for the next term before we\u0026#39;ve incremented r.Term. term = r.Term + 1 } else { r.becomeCandidate() voteMsg = pb.MsgVote term = r.Term } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 func (r *raft) becomeCandidate() { // TODO(xiangli) remove the panic when the raft implementation is stable if r.state == StateLeader { panic(\u0026#34;invalid transition [leader -\u0026gt; candidate]\u0026#34;) } r.step = stepCandidate r.reset(r.Term + 1) r.tick = r.tickElection r.Vote = r.id r.state = StateCandidate r.logger.Infof(\u0026#34;%x became candidate at term %d\u0026#34;, r.id, r.Term) } func (r *raft) becomePreCandidate() { // TODO(xiangli) remove the panic when the raft implementation is stable if r.state == StateLeader { panic(\u0026#34;invalid transition [leader -\u0026gt; pre-candidate]\u0026#34;) } // Becoming a pre-candidate changes our step functions and state, // but doesn\u0026#39;t change anything else. In particular it does not increase // r.Term or change r.Vote. r.step = stepCandidate r.prs.ResetVotes() r.tick = r.tickElection r.lead = None r.state = StatePreCandidate r.logger.Infof(\u0026#34;%x became pre-candidate at term %d\u0026#34;, r.id, r.Term) } åœ¨å®Œæˆäº†çŠ¶æ€æ›´æ–°ä¹‹åï¼Œå½“å‰èŠ‚ç‚¹é¦–å…ˆæŠ•è‡ªå·±ä¸€ç¥¨ï¼Œè¿™ä¸ªæ“ä½œæ˜¯é€šè¿‡pollå‡½æ•°å®Œæˆçš„ï¼Œè¿™ä¸ªè¿‡ç¨‹å¹¶ä¸æ¶‰åŠåˆ°ä»»ä½•çš„rpcï¼Œåªæ˜¯å•çº¯çš„æŠ•è‡ªå·±ä¸€ç¥¨å¹¶è¿›è¡Œè®°å½•ï¼Œä¹‹ååœ¨æ ¹æ®é…ç½®æ–‡ä»¶æ¥ç»Ÿè®¡æ˜¯å¦èµ¢å¾—é€‰ç¥¨ï¼Œå¦‚æœèƒ½å¤Ÿèµ¢å¾—é€‰ç¥¨ï¼Œåˆ™è¯æ˜å½“å‰çš„raftæ˜¯ä»¥å•èŠ‚ç‚¹çš„çŠ¶æ€å¯åŠ¨çš„ï¼Œé›†ç¾¤å½“ä¸­åªæœ‰è¿™ä¸€ä¸ªèŠ‚ç‚¹ã€‚ç›´æ¥ç»“æŸå½“å‰çš„é€‰ä¸¾æµç¨‹ï¼Œæˆä¸ºLeader\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 func (r *raft) poll(id uint64, t pb.MessageType, v bool) (granted int, rejected int, result quorum.VoteResult) { if v { r.logger.Infof(\u0026#34;%x received %s from %x at term %d\u0026#34;, r.id, t, id, r.Term) } else { r.logger.Infof(\u0026#34;%x received %s rejection from %x at term %d\u0026#34;, r.id, t, id, r.Term) } r.prs.RecordVote(id, v) return r.prs.TallyVotes() } func (p *ProgressTracker) RecordVote(id uint64, v bool) { _, ok := p.Votes[id] if !ok { p.Votes[id] = v } } 1 2 3 4 5 6 7 8 9 10 if _, _, res := r.poll(r.id, voteRespMsgType(voteMsg), true); res == quorum.VoteWon { // We won the election after voting for ourselves (which must mean that // this is a single-node cluster). Advance to the next state. if t == campaignPreElection { r.campaign(campaignElection) } else { r.becomeLeader() } return } è€Œå¦‚æœåªé è‡ªå·±ç»™è‡ªå·±æŠ•ç¥¨æ— æ³•èµ¢å¾—é€‰ä¸¾çš„è¯ï¼Œå°±éœ€è¦å€ŸåŠ©å‘é€rpcæ¥è¯·æ±‚å…¶ä»–çš„èŠ‚ç‚¹ç»™è‡ªå·±æŠ•ä¸€ç¥¨ï¼Œè¿™ä¸ªå‘é€çš„è¿‡ç¨‹é€šè¿‡sendæ·»åŠ åˆ°è‡ªèº«çš„[]Messageså½“ä¸­ï¼Œäº¤ç»™ä¸Šå±‚çš„raft serverå»å®Œæˆç½‘ç»œé€šä¿¡ï¼Œç­‰å¾…å¯¹æ–¹æŠ•ç¥¨å®Œæˆåè°ƒç”¨Stepå¹¶å‘å…¶ä¸­ä¼ å…¥ä¸€ä¸ªMsgHupRespçš„æ¶ˆæ¯ç±»å‹è¿›è¡Œå¤„ç†ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 var ids []uint64 { idMap := r.prs.Voters.IDs() ids = make([]uint64, 0, len(idMap)) for id := range idMap { ids = append(ids, id) } sort.Slice(ids, func(i, j int) bool { return ids[i] \u0026lt; ids[j] }) } for _, id := range ids { if id == r.id { continue } r.logger.Infof(\u0026#34;%x [logterm: %d, index: %d] sent %s request to %x at term %d\u0026#34;, r.id, r.raftLog.lastTerm(), r.raftLog.lastIndex(), voteMsg, id, r.Term) var ctx []byte if t == campaignTransfer { ctx = []byte(t) } r.send(pb.Message{Term: term, To: id, Type: voteMsg, Index: r.raftLog.lastIndex(), LogTerm: r.raftLog.lastTerm(), Context: ctx}) } åªæ˜¯ç®€å•çš„å°†msgæ·»åŠ åˆ°[]Messageså½“ä¸­ï¼Œä¹‹åé€šè¿‡Ready()äº¤ç»™ä¸Šå±‚è¿›è¡Œå‘é€\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 func (r *raft) send(m pb.Message) { if m.From == None { m.From = r.id } if m.Type == pb.MsgVote || m.Type == pb.MsgVoteResp || m.Type == pb.MsgPreVote || m.Type == pb.MsgPreVoteResp { if m.Term == 0 { // All {pre-,}campaign messages need to have the term set when // sending. // - MsgVote: m.Term is the term the node is campaigning for, // non-zero as we increment the term when campaigning. // - MsgVoteResp: m.Term is the new r.Term if the MsgVote was // granted, non-zero for the same reason MsgVote is // - MsgPreVote: m.Term is the term the node will campaign, // non-zero as we use m.Term to indicate the next term we\u0026#39;ll be // campaigning for // - MsgPreVoteResp: m.Term is the term received in the original // MsgPreVote if the pre-vote was granted, non-zero for the // same reasons MsgPreVote is panic(fmt.Sprintf(\u0026#34;term should be set when sending %s\u0026#34;, m.Type)) } } else { if m.Term != 0 { panic(fmt.Sprintf(\u0026#34;term should not be set when sending %s (was %d)\u0026#34;, m.Type, m.Term)) } // do not attach term to MsgProp, MsgReadIndex // proposals are a way to forward to the leader and // should be treated as local message. // MsgReadIndex is also forwarded to leader. if m.Type != pb.MsgProp \u0026amp;\u0026amp; m.Type != pb.MsgReadIndex { m.Term = r.Term } } r.msgs = append(r.msgs, m) } Stepé¢„å¤„ç† Stepå‡½æ•°åŒ…å«äº†æ‰€æœ‰å¯¹çŠ¶æ€æœºè¿›è¡Œæ›´æ”¹çš„æ“ä½œï¼Œä½†æ˜¯é€šè¿‡stepxxx + é€šç”¨å¤„ç†çš„æ‹†åˆ†ä¹‹åé€»è¾‘ä¸Šç›¸å½“çš„æ¸…æ™°ï¼Œä¸»è¦è´Ÿè´£ä¸€ä¸‹å››ç§æ“ä½œï¼Œå…¶ä»–çš„å…¨éƒ¨äº¤ç»™stepxxxå»å•ç‹¬å¤„ç†ï¼š\nå¤„ç†æ¯”å½“å‰èŠ‚ç‚¹Termé«˜çš„æ¶ˆæ¯ å¤„ç†æ¯”å½“å‰èŠ‚ç‚¹Termä½çš„æ¶ˆæ¯ é€šè¿‡hupè¿›è¡Œé€‰ä¸¾ å¤„ç†Vote PreVoteæˆäºˆæŠ•ç¥¨ æ¯”å½“å‰Termé«˜çš„æ¶ˆæ¯ï¼š å¦‚æœæ”¶åˆ°äº†ä¸€ä¸ªæ›´é«˜çš„Termï¼Œå¹¶ä¸”å¦‚æœä¸ºPreVoteæˆ–è€…Voteç±»å‹çš„æ¶ˆæ¯ï¼Œå¦‚æœCheck Quorumé€šè¿‡ï¼Œå¹¶ä¸”å½“å‰èŠ‚ç‚¹æŒæœ‰ï¼ˆæš‚æ—¶è¿™ä¹ˆå½¢å®¹ï¼‰Leader Leaseï¼Œé‚£ä¹ˆå°±å¯¹å…¶å¿½ç•¥ï¼Œç›´æ¥è¿”å›ã€‚\næ­¤å¤–è¿˜æœ‰ä¸€ä¸ªforceå˜é‡ï¼Œç”¨äºè¡¨æ˜é’ˆå¯¹ä¼˜åŒ–å½“ä¸­çš„åœºæ™¯ä¸€äºŒçš„è§£å†³æ–¹æ¡ˆï¼Œå¦‚æœContextå½“ä¸­çš„å†…å®¹ä¸º\u0026quot;campaignTransfer\u0026quot;çš„è¯ï¼Œå³ä¸ºé€šè¿‡å¼ºåˆ¶ä»¤è½¬ç§»Leaderæ¥è§£å†³èŠ‚ç‚¹æ— æ³•åŠ å…¥åˆ°é›†ç¾¤å½“ä¸­çš„é—®é¢˜ã€‚\n1 2 // campaignTransfer represents the type of leader transfer campaignTransfer CampaignType = \u0026#34;CampaignTransfer\u0026#34; ä¹‹åï¼Œå¯¹äºMsgPreVoteå’Œå¯¹æ–¹ä¸æ‹’ç»çš„MsgPreVoteRespï¼Œå¿½ç•¥å³å¯ï¼Œä¸éœ€è¦è¿›è¡Œä»»ä½•æ“ä½œã€‚é™¤æ­¤ä¹‹å¤–ï¼Œå¯¹äºå…¶ä»–é«˜äºè‡ªèº«çš„æ¶ˆæ¯ç±»å‹å½“ä¸­ï¼ŒMsgAppã€MsgHeartBeatã€MsgSnapï¼Œè¿™ä¸‰ç§ä¿¡æ¯åªèƒ½ç”±Leaderå‘é€ï¼Œå‡ä»£è¡¨å½“å‰å­˜åœ¨ä¸€ä¸ªæ˜ç¡®çš„Leaderï¼Œå¯¹å…¶è¿›è¡Œè·Ÿéšã€‚\nè€Œå¯¹äºå…¶ä»–æƒ…å†µï¼Œæ¯”å¦‚å½“å‰èŠ‚ç‚¹ä¸ºLeaderï¼Œå¯¹ä¸€ä¸ªfollowerå‘é€äº†ä¸€æ¡Heartbeatï¼Œä½†æ˜¯æ”¶åˆ°äº†ä¸€ä¸ªæ¯”è‡ªå·±Termè¦é«˜çš„HeartbeatRespï¼Œåˆ™è¯æ˜å½“å‰çš„é›†ç¾¤å½“ä¸­å­˜åœ¨æŸä¸ªæœªçŸ¥çš„Leaderï¼Œå› æ­¤åŒæ ·å°†è‡ªèº«è½¬æ¢ä¸ºfollowerï¼Œä½†æ˜¯Leaderçš„idå´æœªçŸ¥ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 case m.Term \u0026gt; r.Term: // æ¥æ”¶åˆ°ä¸€ä¸ªæ›´é«˜çš„Termï¼Œä½†æ˜¯å½“å‰checkQuorumæ ¡éªŒé€šè¿‡ï¼Œå³åœ¨ç§ŸæœŸå†…ï¼Œå› æ­¤æ²¡å¿…è¦å¯¹å…¶è¿›è¡ŒæŠ•ç¥¨ï¼Œä¸å¤„ç† if m.Type == pb.MsgVote || m.Type == pb.MsgPreVote { force := bytes.Equal(m.Context, []byte(campaignTransfer)) inLease := r.checkQuorum \u0026amp;\u0026amp; r.lead != None \u0026amp;\u0026amp; r.electionElapsed \u0026lt; r.electionTimeout if !force \u0026amp;\u0026amp; inLease { // If a server receives a RequestVote request within the minimum election timeout // of hearing from a current leader, it does not update its term or grant its vote r.logger.Infof(\u0026#34;%x [logterm: %d, index: %d, vote: %x] ignored %s from %x [logterm: %d, index: %d] at term %d: lease is not expired (remaining ticks: %d)\u0026#34;, r.id, r.raftLog.lastTerm(), r.raftLog.lastIndex(), r.Vote, m.Type, m.From, m.LogTerm, m.Index, r.Term, r.electionTimeout-r.electionElapsed) return nil } } switch { case m.Type == pb.MsgPreVote: // Never change our term in response to a PreVote case m.Type == pb.MsgPreVoteResp \u0026amp;\u0026amp; !m.Reject: // We send pre-vote requests with a term in our future. If the // pre-vote is granted, we will increment our term when we get a // quorum. If it is not, the term comes from the node that // rejected our vote so we should become a follower at the new // term. default: // é™¤æ­¤ä¹‹å¤–æŒ‰ç…§raftçš„æ­£å¸¸é€»è¾‘è¿›è¡Œå¤„ç†ï¼Œé‡åˆ°æ›´é«˜Termçš„å¯¹å…¶è¿›è¡Œè·Ÿéš r.logger.Infof(\u0026#34;%x [term: %d] received a %s message with higher term from %x [term: %d]\u0026#34;, r.id, r.Term, m.Type, m.From, m.Term) if m.Type == pb.MsgApp || m.Type == pb.MsgHeartbeat || m.Type == pb.MsgSnap { // è¿™ä¸‰ç§æ¶ˆæ¯åªèƒ½ç”±leaderå‘é€ï¼Œä¸”å‘é€è€…ç­‰termæ›´é«˜ï¼Œå› æ­¤æ”¶åˆ°æ¶ˆæ¯åå˜ä¸ºfollower r.becomeFollower(m.Term, m.From) } else { // ä¸çŸ¥é“leaderæ˜¯è°ï¼Œä½†æ˜¯æ”¶åˆ°äº†æ›´é«˜termçš„æ¶ˆæ¯ä¾æ—§éœ€è¦è½¬å˜ä¸ºfollower r.becomeFollower(m.Term, None) } } æ¯”å½“å‰èŠ‚ç‚¹Termæ›´ä½çš„æ¶ˆæ¯ æœ€åï¼Œå¦‚æœæ¶ˆæ¯çš„Termâ€‹æ¯”å½“å‰Termâ€‹å°ï¼Œå› å­˜åœ¨ä¼˜åŒ–å¼•å…¥çš„é¢å¤–é—®é¢˜ï¼Œé™¤äº†å¿½ç•¥æ¶ˆæ¯å¤–ï¼Œè¿˜è¦åšé¢å¤–çš„å¤„ç†ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 case m.Term \u0026lt; r.Term: // æ¥æ”¶åˆ°äº†ä¸€ä¸ªæ¥è‡ªæ›´å°çš„Termçš„å¿ƒè·³ä¿¡æ¯æˆ–è€…AppendEntryï¼Œå¦‚æœä¸è¿›è¡Œå¤„ç†ï¼Œå‡è®¾äº§ç”Ÿåˆ†åŒºï¼Œ // å¦‚æœæ²¡å¼€å¯preVoteï¼Œè¢«åˆ†åŒºçš„èŠ‚ç‚¹çš„Termå°±ä¼šå¤§äºä¸»åˆ†åŒºï¼Œè€Œç”±äºcheckQuorumï¼Œå¯¼è‡´ä¸»åˆ†åŒºçš„èŠ‚ç‚¹ä¸ä¼šç»™ // æ¬¡åˆ†åŒºçš„èŠ‚ç‚¹æŠ•ç¥¨ï¼Œæ¬¡åˆ†åŒºçš„æ— æ³•æˆåŠŸé€‰ä¸¾ï¼Œè€Œæ¬¡åˆ†åŒºçš„Termå¤§äºä¸»åˆ†åŒºï¼Œä¸»åˆ†åŒºå‘é€çš„ä¼šè¢«èµ·ç»Ÿç»Ÿæ‹’ç»ï¼Œå› æ­¤å°±æ— æ³•å† // é‡æ–°åŠ å…¥åˆ°é›†ç¾¤å½“ä¸­ // è€Œå¯¹äºå¼€å¯preVoteæ—¶ï¼Œå½“ä¸€ä¸ªèŠ‚ç‚¹è¿›è¡ŒpreVoteä¹‹åå‡†å¤‡å‘èµ·æ­£å¼æŠ•ç¥¨æ—¶è¢«åˆ†åŒºè‡³åˆ†åŒº2ï¼Œè„±ç¦»ä¸»åˆ†åŒº1ï¼Œå…¶termä¼šé«˜äºä¸»åˆ†åŒº // ä¼šå‘ç”Ÿå’Œä¸Šè¿°åŒæ ·çš„æƒ…å†µï¼Œå³è¯¥èŠ‚ç‚¹å†ä¹Ÿæ— æ³•åŠ å…¥åˆ°é›†ç¾¤å½“ä¸­ // é€šè¿‡å‘é€ä¸€ä¸ªè‡ªèº«çš„Termè®©å¯¹æ–¹ä¸‹å°ï¼Œå°±ç­‰äºæ²¡é‡‡å–checkQuorum å’ŒLeader leaseä¼˜åŒ–æ—¶çš„å¤„ç†æ–¹æ³• if (r.checkQuorum || r.preVote) \u0026amp;\u0026amp; (m.Type == pb.MsgHeartbeat || m.Type == pb.MsgApp) { // We have received messages from a leader at a lower term. It is possible // that these messages were simply delayed in the network, but this could // also mean that this node has advanced its term number during a network // partition, and it is now unable to either win an election or to rejoin // the majority on the old term. If checkQuorum is false, this will be // handled by incrementing term numbers in response to MsgVote with a // higher term, but if checkQuorum is true we may not advance the term on // MsgVote and must generate other messages to advance the term. The net // result of these two features is to minimize the disruption caused by // nodes that have been removed from the cluster\u0026#39;s configuration: a // removed node will send MsgVotes (or MsgPreVotes) which will be ignored, // but it will not receive MsgApp or MsgHeartbeat, so it will not create // disruptive term increases, by notifying leader of this node\u0026#39;s activeness. // The above comments also true for Pre-Vote // // When follower gets isolated, it soon starts an election ending // up with a higher term than leader, although it won\u0026#39;t receive enough // votes to win the election. When it regains connectivity, this response // with \u0026#34;pb.MsgAppResp\u0026#34; of higher term would force leader to step down. // However, this disruption is inevitable to free this stuck node with // fresh election. This can be prevented with Pre-Vote phase. r.send(pb.Message{To: m.From, Type: pb.MsgAppResp}) } else if m.Type == pb.MsgPreVote { // Before Pre-Vote enable, there may have candidate with higher term, // but less log. After update to Pre-Vote, the cluster may deadlock if // we drop messages with a lower term. //åœ¨æ›´å¤æ‚çš„æƒ…å†µä¸­ï¼Œæ¯”å¦‚ï¼Œåœ¨å˜æ›´é…ç½®æ—¶ï¼Œå¼€å¯äº†åŸæœ¬æ²¡æœ‰å¼€å¯çš„Pre-Voteæœºåˆ¶ã€‚ // æ­¤æ—¶å¯èƒ½ä¼šå‡ºç°ä¸ä¸Šä¸€æ¡ç±»ä¼¼çš„æƒ…å†µï¼Œå³å¯èƒ½å› Termæ›´é«˜ä½†æ˜¯Logæ›´æ—§çš„èŠ‚ç‚¹çš„å­˜åœ¨å¯¼è‡´æ•´ä¸ªé›†ç¾¤çš„æ­»é”ï¼Œ // æ‰€æœ‰èŠ‚ç‚¹éƒ½æ— æ³•é¢„æŠ•ç¥¨æˆåŠŸ // å¯¹äºTermæ¯”å½“å‰èŠ‚ç‚¹Termä½çš„é¢„æŠ•ç¥¨è¯·æ±‚ï¼Œæ— è®ºæ˜¯å¦å¼€å¯äº†Check Quorum / Leader Leaseæˆ–Pre-Voteï¼Œ // éƒ½è¦é€šè¿‡ä¸€æ¡Termä¸ºå½“å‰Termçš„æ¶ˆæ¯ï¼Œè¿«ä½¿å…¶è½¬ä¸ºFollowerå¹¶æ›´æ–°Term r.logger.Infof(\u0026#34;%x [logterm: %d, index: %d, vote: %x] rejected %s from %x [logterm: %d, index: %d] at term %d\u0026#34;, r.id, r.raftLog.lastTerm(), r.raftLog.lastIndex(), r.Vote, m.Type, m.From, m.LogTerm, m.Index, r.Term) r.send(pb.Message{To: m.From, Term: r.Term, Type: pb.MsgPreVoteResp, Reject: true}) } else { // ignore other cases r.logger.Infof(\u0026#34;%x [term: %d] ignored a %s message with lower term from %x [term: %d]\u0026#34;, r.id, r.Term, m.Type, m.From, m.Term) } return nil } é€‰ä¸¾ æœ€ç»ˆï¼Œç»ˆäºè½®åˆ°è¿›è¡Œé€‰ä¸¾äº†ï¼Œæ ¹æ®æ˜¯å¦ä¸ºpreVoteå‘å…¶ä¸­ä¼ å…¥ä¸åŒçš„é€‰ä¸¾ç±»å‹å³å¯\n1 2 3 4 5 6 7 switch m.Type { case pb.MsgHup: if r.preVote { r.hup(campaignPreElection) } else { r.hup(campaignElection) } æŠ•ç¥¨ åœ¨æŠ•ç¥¨ä¸Šè¿›è¡Œå®‰å…¨æ€§æ ¡éªŒï¼š\nå¦‚æœå½“å‰Termä¹‹å‰å¯¹è¯¥èŠ‚ç‚¹æŠ•è¿‡ç¥¨ï¼Œå…è®¸æŠ•ç¥¨ å¦‚æœå½“å‰TermæœªæŠ•è¿‡ç¥¨ï¼Œå¹¶ä¸”è‡ªèº«ä¹Ÿæ²¡æœ‰Leaderï¼Œå…è®¸æŠ•ç¥¨ æ¥æ”¶åˆ°ä¸€ä¸ªTermé«˜äºè‡ªå·±çš„PreVoteï¼Œå…è®¸æŠ•ç¥¨ æ­¤å¤–è¿˜éœ€è¦æ ¡éªŒè‡ªèº«çš„Logï¼Œé˜²æ­¢Logè¦†ç›–ã€‚\nå¦åˆ™ï¼ŒæŠ•å‡ºæ‹’ç»ç¥¨ã€‚\n1 2 3 4 5 6 7 8 9 10 11 case pb.MsgVote, pb.MsgPreVote: // We can vote if this is a repeat of a vote we\u0026#39;ve already cast... canVote := r.Vote == m.From || // ...we haven\u0026#39;t voted and we don\u0026#39;t think there\u0026#39;s a leader yet in this term... (r.Vote == None \u0026amp;\u0026amp; r.lead == None) || // ...or this is a PreVote for a future term... (m.Type == pb.MsgPreVote \u0026amp;\u0026amp; m.Term \u0026gt; r.Term) // ...and we believe the candidate is up to date. // raftå½“ä¸­é€šè¿‡æ—¥å¿—Termè¿›è¡Œçš„æœ€åŸºç¡€çš„å®‰å…¨æ€§æ ¡éªŒ if canVote \u0026amp;\u0026amp; r.raftLog.isUpToDate(m.Index, m.LogTerm) { // Note: it turns out that that learners must be allowed 1 2 3 func (l *raftLog) isUpToDate(lasti, term uint64) bool { return term \u0026gt; l.lastTerm() || (term == l.lastTerm() \u0026amp;\u0026amp; lasti \u0026gt;= l.lastIndex()) } è§’è‰²ç›¸å…³step step å½“æ‰€æœ‰çš„é¢„å¤„ç†å‡å¤„ç†å®Œä¹‹åï¼Œå¦‚æœè¿˜æœ‰åç»­å·¥ä½œï¼Œå°±äº¤ç»™stepxxxæ¥å®Œæˆï¼Œåˆ†åˆ«ä¸ºstepLeaderã€stepFollowerã€stepCandidate\n1 2 3 4 5 6 type stepFunc func(r *raft, m pb.Message) error type raft struct { // ... step stepFunc // ... } 1 2 3 4 5 default: err := r.step(r, m) if err != nil { return err } stepLeader stepLeaderå½“ä¸­æ¶‰åŠåˆ°çš„é€»è¾‘è¾ƒä¸ºå¤æ‚ï¼ŒåŒ…å«äº†é€‰ä¸¾ã€æ—¥å¿—å¤åˆ¶ã€å¿«ç…§å¤„ç†ç­‰å¤šæ–¹é¢ï¼Œè¿™é‡Œå…ˆä»…åˆ†æé€‰ä¸¾ç›¸å…³çš„å†…å®¹ã€‚\né¦–å…ˆå¦‚æœStepä¼ æ¥çš„æ¶ˆæ¯ä¸ºMsgCheckQuorumâ€‹ç±»å‹ï¼Œé‚£ä¹ˆå°±æ‰§è¡ŒCheck Quorumæ“ä½œï¼Œæ£€æŸ¥å½“å‰é›†ç¾¤å½“ä¸­æ´»è·ƒçš„èŠ‚ç‚¹æ•°é‡ï¼Œå¦‚æœæ´»è·ƒæ•°é‡è¾¾ä¸åˆ°Quorumçš„è¦æ±‚ï¼Œå½“å‰çš„Leaderå°±é€€ä½æˆä¸ºFollowerã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 case pb.MsgCheckQuorum: // The leader should always see itself as active. As a precaution, handle // the case in which the leader isn\u0026#39;t in the configuration any more (for // example if it just removed itself). // // TODO(tbg): I added a TODO in removeNode, it doesn\u0026#39;t seem that the // leader steps down when removing itself. I might be missing something. if pr := r.prs.Progress[r.id]; pr != nil { pr.RecentActive = true } if !r.prs.QuorumActive() { r.logger.Warningf(\u0026#34;%x stepped down to follower since quorum is not active\u0026#34;, r.id) r.becomeFollower(r.Term, None) } // Mark everyone (but ourselves) as inactive in preparation for the next // CheckQuorum. r.prs.Visit(func(id uint64, pr *tracker.Progress) { if id != r.id { pr.RecentActive = false } }) return nil stepCandidate åœ¨stepCandidateå½“ä¸­ï¼Œå¦‚æœæ¥æ”¶åˆ°äº†Leaderå‘é€æ¥çš„æ¶ˆæ¯ï¼Œå¦‚MsgAppâ€‹ MsgHeartbeatâ€‹ MsgSnapâ€‹ï¼Œé‚£ä¹ˆå°±æ”¾å¼ƒé€‰ä¸¾ï¼Œè‡ªåŠ¨è½¬æ¢ä¸ºfollowerï¼Œè€Œå¦‚æœæ¥æ”¶åˆ°äº†MsgPropâ€‹ï¼Œproposeæ¶ˆæ¯åªæœ‰Leaderæ‰èƒ½å¤Ÿå¤„ç†ï¼Œå› æ­¤è¿”å›ä¸€ä¸ªErrï¼Œæ‹’ç»å¤„ç†ã€‚\nstepCandidateå½“ä¸­çš„é€‰ä¸¾çš„ç›¸å…³é€»è¾‘ä¸»è¦ä¸ºå¤„ç†é€‰ä¸¾çš„ç»“æœï¼ŒåŒæ ·é€šè¿‡pollå‡½æ•°è¿›è¡Œæ£€æŸ¥ï¼Œä½†æ˜¯æ­¤æ—¶å·²ç»æœ‰å…¶ä»–çš„èŠ‚ç‚¹é€šè¿‡ç¥¨äº†ï¼Œä¼šè®°å½•åœ¨Tracker.progresså½“ä¸­ï¼Œå¦‚æœèƒ½å¤Ÿæ‹¿åˆ°è¶³å¤Ÿå¤šçš„é€‰ç¥¨ï¼Œåœ¨æ ¹æ®å½“å‰é€‰ä¸¾çš„çŠ¶æ€åˆ¤æ–­ï¼Œå¦‚æœæ˜¯é¢„é€‰ä¸¾ï¼Œé‚£ä¹ˆå°±å¼€å¯æ­£å¼é€‰ä¸¾ï¼Œè€Œå¦‚æœæ˜¯æ­£å¼é€‰ä¸¾ï¼Œé‚£ä¹ˆå°±æˆä¸ºLeaderï¼Œå¹¶ä¸”ä¸Šçº¿ä¹‹åç«‹åˆ»å¹¿æ’­ä¸€æ¬¡AppendEntriesã€‚\nâ€\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 // stepCandidate is shared by StateCandidate and StatePreCandidate; the difference is // whether they respond to MsgVoteResp or MsgPreVoteResp. func stepCandidate(r *raft, m pb.Message) error { // Only handle vote responses corresponding to our candidacy (while in // StateCandidate, we may get stale MsgPreVoteResp messages in this term from // our pre-candidate state). var myVoteRespType pb.MessageType if r.state == StatePreCandidate { myVoteRespType = pb.MsgPreVoteResp } else { myVoteRespType = pb.MsgVoteResp } switch m.Type { case pb.MsgProp: r.logger.Infof(\u0026#34;%x no leader at term %d; dropping proposal\u0026#34;, r.id, r.Term) return ErrProposalDropped case pb.MsgApp: r.becomeFollower(m.Term, m.From) // always m.Term == r.Term r.handleAppendEntries(m) case pb.MsgHeartbeat: r.becomeFollower(m.Term, m.From) // always m.Term == r.Term r.handleHeartbeat(m) case pb.MsgSnap: r.becomeFollower(m.Term, m.From) // always m.Term == r.Term r.handleSnapshot(m) case myVoteRespType: gr, rj, res := r.poll(m.From, m.Type, !m.Reject) r.logger.Infof(\u0026#34;%x has received %d %s votes and %d vote rejections\u0026#34;, r.id, gr, m.Type, rj) switch res { case quorum.VoteWon: if r.state == StatePreCandidate { r.campaign(campaignElection) } else { r.becomeLeader() r.bcastAppend() } case quorum.VoteLost: // pb.MsgPreVoteResp contains future term of pre-candidate // m.Term \u0026gt; r.Term; reuse r.Term r.becomeFollower(r.Term, None) } } return nil } stepFollower followerå½“ä¸­å’Œé€‰ä¸¾ç›¸å…³çš„å†…å®¹ä¸æ˜¯å¾ˆå¤šï¼Œåªæœ‰ä¸€æ¡è¶…æ—¶è¿›è¡Œé€‰ä¸¾ï¼Œå…¶ä»–çš„éƒ½æ˜¯å¯¹LeaderçŠ¶æ€çš„è·Ÿéšï¼Œå³å¤„ç†AppendEntriesã€Heartbeatã€Snapshotã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 func stepFollower(r *raft, m pb.Message) error { switch m.Type { case pb.MsgProp: if r.lead == None { r.logger.Infof(\u0026#34;%x no leader at term %d; dropping proposal\u0026#34;, r.id, r.Term) return ErrProposalDropped } else if r.disableProposalForwarding { r.logger.Infof(\u0026#34;%x not forwarding to leader %x at term %d; dropping proposal\u0026#34;, r.id, r.lead, r.Term) return ErrProposalDropped } m.To = r.lead r.send(m) case pb.MsgApp: r.electionElapsed = 0 r.lead = m.From r.handleAppendEntries(m) case pb.MsgHeartbeat: r.electionElapsed = 0 r.lead = m.From r.handleHeartbeat(m) case pb.MsgSnap: r.electionElapsed = 0 r.lead = m.From r.handleSnapshot(m) case pb.MsgTransferLeader: if r.lead == None { r.logger.Infof(\u0026#34;%x no leader at term %d; dropping leader transfer msg\u0026#34;, r.id, r.Term) return nil } m.To = r.lead r.send(m) case pb.MsgTimeoutNow: r.logger.Infof(\u0026#34;%x [term %d] received MsgTimeoutNow from %x and starts an election to get leadership.\u0026#34;, r.id, r.Term, m.From) // Leadership transfers never use pre-vote even if r.preVote is true; we // know we are not recovering from a partition so there is no need for the // extra round trip. r.hup(campaignTransfer) case pb.MsgReadIndex: if r.lead == None { r.logger.Infof(\u0026#34;%x no leader at term %d; dropping index reading msg\u0026#34;, r.id, r.Term) return nil } m.To = r.lead r.send(m) case pb.MsgReadIndexResp: if len(m.Entries) != 1 { r.logger.Errorf(\u0026#34;%x invalid format of MsgReadIndexResp from %x, entries count: %d\u0026#34;, r.id, m.From, len(m.Entries)) return nil } r.readStates = append(r.readStates, ReadState{Index: m.Index, RequestCtx: m.Entries[0].Data}) } return nil } çŠ¶æ€åˆ‡æ¢ å½“è¿›è¡ŒçŠ¶æ€åˆ‡æ¢æ—¶ï¼Œ å‡ä¼šè°ƒç”¨ä¸€ä¸ªresetâ€‹å‡½æ•°ï¼Œå¯¹è‡ªèº«çš„çŠ¶æ€è¿›è¡Œé‡ç½®ï¼š\nå°†è‡ªå·±çš„termè®¾ç½®ä¸ºé¢„æœŸçš„Term æ¸…é™¤è‡ªèº«çš„Leader é‡ç½®å®šæ—¶å™¨ æ¸…é™¤é€‰ç¥¨ éå†tracker.Progressé‡ç½®çŠ¶æ€ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 func (r *raft) reset(term uint64) { if r.Term != term { r.Term = term r.Vote = None } r.lead = None r.electionElapsed = 0 r.heartbeatElapsed = 0 r.resetRandomizedElectionTimeout() r.abortLeaderTransfer() r.prs.ResetVotes() r.prs.Visit(func(id uint64, pr *tracker.Progress) { *pr = tracker.Progress{ Match: 0, Next: r.raftLog.lastIndex() + 1, Inflights: tracker.NewInflights(r.prs.MaxInflight), IsLearner: pr.IsLearner, } if id == r.id { pr.Match = r.raftLog.lastIndex() } }) r.pendingConfIndex = 0 r.uncommittedSize = 0 r.readOnly = newReadOnly(r.readOnly.option) } follower 1 2 3 4 5 6 7 8 func (r *raft) becomeFollower(term uint64, lead uint64) { r.step = stepFollower r.reset(term) r.tick = r.tickElection r.lead = lead r.state = StateFollower r.logger.Infof(\u0026#34;%x became follower at term %d\u0026#34;, r.id, r.Term) } å­—æ®µ ä½œç”¨ step è§’è‰²å¯¹åº”çš„stepï¼Œåœ¨ä¸Šé¢å·²ç»åˆ†æè¿‡ tick è§’è‰²å¯¹åº”çš„tickå‡½æ•°ï¼Œå¯¹äºfollowerä¸ºtickElectionï¼Œç”¨äºè¿›è¡Œè¶…æ—¶é€‰ä¸¾ lead å½“å‰çš„Leader state è§’è‰²çŠ¶æ€ candidate 1 2 3 4 5 6 7 8 9 10 11 12 func (r *raft) becomeCandidate() { // TODO(xiangli) remove the panic when the raft implementation is stable if r.state == StateLeader { panic(\u0026#34;invalid transition [leader -\u0026gt; candidate]\u0026#34;) } r.step = stepCandidate r.reset(r.Term + 1) r.tick = r.tickElection r.Vote = r.id r.state = StateCandidate r.logger.Infof(\u0026#34;%x became candidate at term %d\u0026#34;, r.id, r.Term) } å­—æ®µ ä½œç”¨ step è§’è‰²å¯¹åº”çš„stepï¼Œåœ¨ä¸Šé¢å·²ç»åˆ†æè¿‡ tick è§’è‰²å¯¹åº”çš„tickå‡½æ•°ï¼Œå¯¹äºcandidateä¸ºtickElectionï¼Œç”¨äºè¿›è¡Œè¶…æ—¶é€‰ä¸¾ Vote å½“å‰Termä¸‹æŠ•å‡ºçš„ç¥¨ï¼Œcandidateä¼šä¸ºè‡ªå·±æŠ•ç¥¨ state è§’è‰²çŠ¶æ€ PreCandidate å¯¹äºPreCVandidateï¼Œä¸¥æ ¼æ„ä¹‰ä¸Šå…¶å¹¶éçŠ¶æ€åˆ‡æ¢ï¼Œå³æœ¬è´¨ä¸Šè¿˜æ˜¯ä¸ºfollowerï¼Œåªä¸è¿‡ä¸ºäº†å¯¹å¤–å‘èµ·PreVoteè®¾ç½®äº†ä¸€ä¸ªå•ç‹¬çš„StatePreCandidateçš„çŠ¶æ€ï¼Œå› æ­¤åœ¨becomePreCandidateå½“ä¸­ä¸ä¼šè°ƒç”¨resetè¿›è¡ŒçŠ¶æ€é‡ç½®ï¼Œåªæœ‰å½“å…¶ç¡®è®¤ä¼šè¿›è¡Œæ­£å¼æŠ•ç¥¨æ—¶ï¼Œæ‰ä¼šè½¬æ¢ä¸ºCandidate\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 func (r *raft) becomePreCandidate() { // TODO(xiangli) remove the panic when the raft implementation is stable if r.state == StateLeader { panic(\u0026#34;invalid transition [leader -\u0026gt; pre-candidate]\u0026#34;) } // Becoming a pre-candidate changes our step functions and state, // but doesn\u0026#39;t change anything else. In particular it does not increase // r.Term or change r.Vote. r.step = stepCandidate r.prs.ResetVotes() r.tick = r.tickElection r.lead = None r.state = StatePreCandidate r.logger.Infof(\u0026#34;%x became pre-candidate at term %d\u0026#34;, r.id, r.Term) } å­—æ®µ ä½œç”¨ step è§’è‰²å¯¹åº”çš„stepï¼Œå’ŒCandidateå…¬ç”¨ç›¸åŒçš„é€»è¾‘ tick è§’è‰²å¯¹åº”çš„tickå‡½æ•°ï¼Œå¯¹äºcandidateä¸ºtickElectionï¼Œç”¨äºè¿›è¡Œè¶…æ—¶é€‰ä¸¾ lead è¿›è¡Œé¢„æŠ•ç¥¨æ—¶å³ä¸ºè®¤å®šå½“å‰é›†ç¾¤å½“ä¸­æ— Leaderï¼Œå› æ­¤è®¾ç½®ä¸ºNone Vote å½“å‰Termä¸‹æŠ•å‡ºçš„ç¥¨ï¼Œcandidateä¼šä¸ºè‡ªå·±æŠ•ç¥¨ state è§’è‰²çŠ¶æ€ Leader 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 func (r *raft) becomeLeader() { // TODO(xiangli) remove the panic when the raft implementation is stable if r.state == StateFollower { panic(\u0026#34;invalid transition [follower -\u0026gt; leader]\u0026#34;) } r.step = stepLeader r.reset(r.Term) r.tick = r.tickHeartbeat r.lead = r.id r.state = StateLeader // Followers enter replicate mode when they\u0026#39;ve been successfully probed // (perhaps after having received a snapshot as a result). The leader is // trivially in this state. Note that r.reset() has initialized this // progress with the last index already. r.prs.Progress[r.id].BecomeReplicate() // Conservatively set the pendingConfIndex to the last index in the // log. There may or may not be a pending config change, but it\u0026#39;s // safe to delay any future proposals until we commit all our // pending log entries, and scanning the entire tail of the log // could be expensive. r.pendingConfIndex = r.raftLog.lastIndex() emptyEnt := pb.Entry{Data: nil} if !r.appendEntry(emptyEnt) { // This won\u0026#39;t happen because we just called reset() above. r.logger.Panic(\u0026#34;empty entry was dropped\u0026#34;) } // As a special case, don\u0026#39;t count the initial empty entry towards the // uncommitted log quota. This is because we want to preserve the // behavior of allowing one entry larger than quota if the current // usage is zero. r.reduceUncommittedSize([]pb.Entry{emptyEnt}) r.logger.Infof(\u0026#34;%x became leader at term %d\u0026#34;, r.id, r.Term) } å­—æ®µ ä½œç”¨ step è§’è‰²å¯¹åº”çš„stepï¼ŒstepLeader tick è§’è‰²å¯¹åº”çš„tickå‡½æ•°ï¼Œå¯¹äºLeaderä¸ºtickHeartbeatï¼Œå‘é€å¿ƒè·³ä¿¡æ¯ lead leadè®¾ç½®ä¸ºè‡ªèº« state è§’è‰²çŠ¶æ€ â€\n","permalink":"https://fischer0522.github.io/en/posts/tech/etcd/raft%E9%80%89%E4%B8%BE%E6%B5%81%E7%A8%8B/","summary":"Rafté€‰ä¸¾æµç¨‹ å¼•ç”¨ï¼šhttp://blog.mrcroxx.com/posts/code-reading/etcdraft-made-si","title":"etcd/rafté€‰ä¸¾æµç¨‹"},{"content":"æ—¥å¿—ä¸æ¢å¤ æ•°æ®åº“å½“ä¸­å­˜åœ¨å“ªäº›æ•…éšœï¼Ÿ ç®€å•æ¥è¯´å¯ä»¥åˆ†ä¸ºä¸‰ç§æ•…éšœï¼š\näº‹åŠ¡æ•…éšœ ç³»ç»Ÿæ•…éšœ å­˜å‚¨ä»‹è´¨æ•…éšœ è€Œäº‹åŠ¡æ•…éšœä¹Ÿå¯åˆ†ä¸ºä¸¤ç§ï¼š\né€»è¾‘é”™è¯¯ (Logical Errors)ï¼šç”±äºä¸€äº›å†…éƒ¨çº¦æŸï¼Œå¦‚æ•°æ®ä¸€è‡´æ€§çº¦æŸï¼Œå¯¼è‡´äº‹åŠ¡æ— æ³•æ­£å¸¸å®Œæˆ å†…éƒ¨é”™è¯¯ (Internal State Errors)ï¼šç”±äºæ•°æ®åº“å†…éƒ¨è°ƒåº¦ã€å¹¶å‘æ§åˆ¶ï¼Œå¦‚æ­»é”ï¼Œå¯¼è‡´äº‹åŠ¡æ— æ³•æ­£å¸¸æäº¤ ç³»ç»Ÿæ•…éšœå¯ä»¥åˆ†ä¸ºä¸¤ç§ï¼š\nè½¯ä»¶æ•…éšœ (Software Failure)ï¼šå¦‚ DBMS æœ¬èº«çš„å®ç°é—®é¢˜ (NPE, Divide-by-zero) ç¡¬ä»¶æ•…éšœ (Hardware Failure)ï¼šDBMS æ‰€åœ¨çš„å®¿ä¸»æœºå‘ç”Ÿå´©æºƒï¼Œå¦‚æ–­ç”µã€‚ä¸”ä¸€èˆ¬å‡è®¾éæ˜“å¤±æ€§çš„å­˜å‚¨æ•°æ®åœ¨å®¿ä¸»æœºå´©æºƒåä¸ä¼šä¸¢å¤± å¦‚æœå­˜å‚¨ä»‹è´¨å‘ç”Ÿæ•…éšœï¼Œé€šå¸¸è¿™æ ·çš„æ•…éšœå°±æ˜¯æ— æ³•ä¿®å¤çš„ï¼Œå¦‚å‘ç”Ÿæ’å‡»å¯¼è‡´ç£ç›˜éƒ¨åˆ†æˆ–å…¨éƒ¨å—æŸï¼Œç£ç›˜ä¸Šçš„ç£æ€§ä»‹è´¨è¢«åˆ®ä¼¤ã€‚åœ¨ L1 - RAIDâ€‹ å°±æœ‰ä»‹ç»è¿‡è¿™ç§æƒ…å†µï¼Œé€šå¸¸æ¯ä¸ªç£ç›˜éƒ½ä¼šæœ‰å¯¹åº”çš„å¤‡ä»½æ•°æ®ã€å¤‡ä»½ç£ç›˜ï¼Œé‚£ä¹ˆå°±ä¿è¯äº†æ•°æ®ä¸ä¼šä¸¢å¤±ã€‚æˆ‘ä»¬éœ€è¦ä»å¤‡ä»½è®°å½•ä¸­æ¢å¤æ•°æ®\nå¯¹äºæ•…éšœæ•°æ®åº“çš„è§£å†³æ–¹æ¡ˆï¼Ÿ é¦–å…ˆå¯¹äºå­˜å‚¨ä»‹è´¨çš„æ•…éšœï¼Œåœ¨æ•°æ®åº“å±‚é¢æ— èƒ½ä¸ºåŠ›ï¼Œåªèƒ½é€šè¿‡ç¡¬ä»¶å±‚é¢çš„å¤‡ä»½ä¸æ¢å¤è¿›è¡Œè§£å†³ã€‚è€Œå¯¹äºä¸Šå±‚çš„äº‹åŠ¡æ•…éšœå’Œç³»ç»Ÿæ•…éšœï¼Œå¯ä»¥dbå±‚é¢å°½å¯èƒ½çš„è¿›è¡Œè§£å†³ã€‚\nå¯¹äºæ”¯æŒäº‹åŠ¡çš„æ•°æ®åº“ç³»ç»Ÿï¼Œåœ¨æ•…éšœæ¢å¤ä¸Šå°±è¦è€ƒè™‘åˆç†ç¼–æ’æˆ–è€…æ¢å¤æ•°æ®ï¼Œä»¥ä¿è¯äº‹åŠ¡çš„ç‰¹æ€§ä¸è¢«è¿åã€‚å¦‚ä¸èƒ½å‡ºç°ä¸ä¸€è‡´çš„ä¸­é—´æ€ï¼Œæˆ–è€…è¯´è¿åäº†åŸå­æ€§ï¼Œå­˜åœ¨éƒ¨åˆ†æŒ‡ä»¤æˆåŠŸæ‰§è¡Œè€Œéƒ¨åˆ†æŒ‡ä»¤æœªæ‰§è¡Œçš„æƒ…å†µã€‚\næ•…éšœæ¢å¤æœºåˆ¶åŒ…æ‹¬ä¸¤éƒ¨åˆ†ï¼š\nåœ¨äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­é‡‡å–çš„è¡ŒåŠ¨æ¥ç¡®ä¿åœ¨å‡ºç°æ•…éšœæ—¶èƒ½å¤Ÿæ¢å¤ åœ¨æ•…éšœå‘ç”Ÿåçš„æ¢å¤æœºåˆ¶ï¼Œå¦‚ç¡®ä¿åŸå­æ€§ã€ä¸€è‡´æ€§å’ŒæŒä¹…æ€§ å¯¹äºä¸¤æ–¹é¢æ€»ç»“çš„è¯ï¼Œå°±æ˜¯åœ¨äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­é‡‡ç”¨shadow pageæˆ–è€…WALçš„æ–¹å¼ï¼Œå†åŠ ä¸Šåˆé€‚çš„ Buffer Pool Policyï¼Œç»´æŠ¤ç›¸å…³æ•°æ®ï¼Œä¹‹ååœ¨å‘ç”Ÿæ•…éšœæ—¶ï¼Œå¯¹äº‹åŠ¡è¿›è¡Œå›æ»šæˆ–è€…é‡åš\nBuffer Pool Policies ä¿®æ”¹æ•°æ®æ—¶ï¼ŒDBMS éœ€è¦å…ˆæŠŠå¯¹åº”çš„æ•°æ®é¡µä»æŒä¹…åŒ–å­˜å‚¨ä¸­è¯»åˆ°å†…å­˜ä¸­ï¼Œç„¶ååœ¨å†…å­˜ä¸­æ ¹æ®å†™è¯·æ±‚ä¿®æ”¹æ•°æ®ï¼Œæœ€åå°†ä¿®æ”¹åçš„æ•°æ®å†™å›åˆ°æŒä¹…åŒ–å­˜å‚¨ã€‚åœ¨æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼ŒDBMS éœ€è¦ä¿è¯ä¸¤ç‚¹ï¼š\n1DBMS å‘ŠçŸ¥ç”¨æˆ·äº‹åŠ¡å·²ç»æäº¤æˆåŠŸå‰ï¼Œç›¸åº”çš„æ•°æ®å¿…é¡»å·²ç»æŒä¹…åŒ– 2.å¦‚æœäº‹åŠ¡ä¸­æ­¢ï¼Œä»»ä½•æ•°æ®ä¿®æ”¹éƒ½ä¸åº”è¯¥æŒä¹…åŒ– å¦‚æœçœŸçš„é‡ä¸Šäº‹åŠ¡æ•…éšœæˆ–è€…ç³»ç»Ÿæ•…éšœï¼ŒDBMS æœ‰ä¸¤ç§åŸºæœ¬æ€è·¯æ¥æ¢å¤æ•°æ®ä¸€è‡´æ€§ï¼Œå‘ç”¨æˆ·æä¾›ä¸Šè¿°ä¸¤æ–¹é¢ä¿è¯ï¼š\nUndoï¼šå°†ä¸­æ­¢æˆ–æœªå®Œæˆçš„äº‹åŠ¡ä¸­å·²ç»æ‰§è¡Œçš„æ“ä½œå›é€€ Redoï¼šå°†æäº¤çš„äº‹åŠ¡æ‰§è¡Œçš„æ“ä½œé‡åš DBMS å¦‚ä½•æ”¯æŒ undo/redo å–å†³äºå®ƒå¦‚ä½•ç®¡ç† buffer poolã€‚æˆ‘ä»¬å¯ä»¥ä»ä¸¤ä¸ªè§’åº¦æ¥åˆ†æ buffer pool çš„ç®¡ç†ç­–ç•¥ï¼šSteal Policy å’Œ Force Policy\nSTEALï¼š\nstealæ‰€å†³å®šçš„æ˜¯DBMSæ˜¯å¦å…è®¸ä¸€ä¸ªæœªæäº¤çš„äº‹åŠ¡æ˜¯å¦ä¿®æ”¹æŒä¹…åŒ–å­˜å‚¨å½“ä¸­çš„æ•°æ®ï¼Œå¦‚æœå…è®¸ï¼Œåˆ™ä¸ºSTEALï¼Œå¦‚æœä¸å…è®¸ï¼Œåˆ™ä¸ºNO-STEAL\nå¦‚æœå…è®¸(Steal)ï¼Œå½“ T1 å›æ»šæ—¶ï¼Œéœ€è¦æŠŠå·²ç»æŒä¹…åŒ–çš„æ•°æ®è¯»è¿›æ¥ï¼Œå›æ»šæ•°æ®ï¼Œå†ä¿å­˜å›å»ã€‚ä½†æ˜¯åœ¨ä¸å‘ç”Ÿå›æ»šæ—¶ï¼ŒDBMS çš„ I/O è¾ƒä½ã€‚\nå¦‚æœä¸å…è®¸(No-steal)ï¼Œå½“ T1 å›æ»šæ—¶ï¼Œç”±äºæ‰€æœ‰æ•°æ®éƒ½åªä¿å­˜åœ¨å†…å­˜ä¸­æ²¡æœ‰è¿›å…¥ç£ç›˜ä¸­ï¼Œæ‰€ä»¥åªéœ€è¦ä¸¢å¼ƒè¿™äº›å†…å­˜ä¸­çš„ page å³å¯ã€‚ä½†æ˜¯å‡å¦‚ T1 æ˜¯ä¸€ä¸ªé•¿äº‹åŠ¡ï¼Œå†…å­˜å¯èƒ½æ— æ³•å®Œå…¨å®¹çº³è¿› T1 çš„æ‰€æœ‰ pageï¼Œå°±éœ€è¦å°†ä¸­é—´æ•°æ®å­˜å‚¨åœ¨é¢å¤–çš„ç£ç›˜ç©ºé—´ä¸­ï¼Œé‚£ä¹ˆ DBMS ä¼šå¸¦æ¥é¢å¤–çš„ç©ºé—´æµªè´¹ã€‚\nFORCEï¼š\nforceæ‰€å†³å®šDBMSæ˜¯å¦è¦æ±‚åœ¨ä¸€ä¸ªäº‹åŠ¡å…è®¸commitä¹‹å‰ï¼Œè¯¥äº‹åŠ¡æ‰€ä½œçš„æ‰€æœ‰æ›´æ”¹åº”å½“è¢«æ˜ å°„åˆ°æ•°æ®åº“å½“ä¸­ï¼Œå³è¿›è¡Œè„é¡µå›å†™ï¼Œå¦‚æœè¦æ±‚ï¼Œåˆ™ä¸ºFORCEï¼Œåä¹‹åˆ™ä¸ºNO-FORCE\nforceæ‰€è¦æ±‚çš„æ˜¯å°†è¯¥äº‹åŠ¡æœ¬èº«åšå‡ºçš„æ›´æ”¹æ˜ å°„åˆ°æ•°æ®åº“å½“ä¸­ï¼Œè€Œå¯¹äºT1æ‰€åšçš„æ›´æ”¹ï¼Œåº”å½“å°†å…¶å‰”é™¤æˆ–é¿å¼€ï¼Œé‡‡ç”¨çš„è§£å†³æ–¹æ¡ˆä¸ºç”Ÿæˆä¸€ä¸ªå‰¯æœ¬ï¼Œåœ¨å…¶ä¸­ä¿å­˜åªç”±T2åšå‡ºçš„æ›´æ”¹ï¼Œä¹‹ååœ¨commitæ—¶å°†è¿™ä¸ªå‰¯æœ¬æ˜ å°„åˆ°æ•°æ®åº“å½“ä¸­ï¼Œå°±åªä¼šå°†T2åšå‡ºçš„æ›´æ”¹æ˜ å°„åˆ°ç£ç›˜å½“ä¸­ã€‚\nå¦‚æœå¼ºåˆ¶(Force)ï¼Œæ¯æ¬¡äº‹åŠ¡æäº¤ä¹‹åï¼Œéƒ½å¿…é¡»è¦ä¿è¯æ•°æ®è½ç›˜ï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚\nå¦‚æœä¸å¼ºåˆ¶(No-Force)ï¼ŒDBMS åˆ™å¯ä»¥å»¶è¿Ÿæ‰¹é‡åœ°å°†æ•°æ®è½ç›˜ï¼Œæ•°æ®ä¸€è‡´æ€§å¯èƒ½å­˜åœ¨é—®é¢˜ï¼Œä½† I/O æ•ˆç‡è¾ƒé«˜ã€‚\næœ€ç»ˆçš„buffer pool ç­–ç•¥ä¸ºSTEALæŒ‡æ ‡å’ŒFORCEæŒ‡æ ‡çš„ç»„åˆã€‚\nsteal no-steal force Steal + Force No-Steal + Force no-force Steal + No-Force No-Steal + No-Force é€šå¸¸å®è·µä¸­åº”ç”¨çš„ä¸ºNo-Steal + Forceä¸Steal + No-Force\nShadow Page No-Steal + Force åœ¨ä½¿ç”¨No-Steal + Forceçš„ç­–ç•¥ç»„åˆä¸‹ï¼š\nå½“äº‹åŠ¡ä¸­æ­¢æ—¶ï¼Œæ— éœ€è¿›è¡Œå›æ»šï¼Œå› ä¸ºäº‹åŠ¡ä½œå‡ºçš„ä¿®æ”¹ä¸ä¼šä¸»åŠ¨è¿›è¡ŒæŒä¹…åŒ–ï¼Œä¹Ÿä¸å…è®¸è¢«å…¶ä»–çš„äº‹åŠ¡æå¸¦è½ç›˜ å½“äº‹åŠ¡æäº¤æ—¶ï¼Œä¹Ÿæ— éœ€è¿›è¡Œé‡åšï¼Œå› ä¸ºæäº¤çš„æ•°æ®å·²ç»å…¨éƒ¨è¿›è¡ŒæŒä¹…åŒ– æœ€ç®€å•çš„å®ç°æ–¹å¼ä¸ºShadow Pageï¼Œå…¶ä¼šç»´æŠ¤ä¸¤ä»½æ•°æ®ï¼š\nmasterï¼šåŒ…å«æ‰€æœ‰å·²ç»æäº¤çš„äº‹åŠ¡çš„æ•°æ® shadowï¼šåœ¨Masterä¹‹ä¸Šå¢åŠ ä¸ºæäº¤çš„æ•°æ®å˜åŠ¨ æœ€å¼€å§‹ï¼Œåœ¨å†…å­˜å½“ä¸­ç»´æŠ¤ä¸€ä¸ªMasterçš„Page Tableå’ŒæŒ‡å‘è¯¥Tableçš„DB Rootï¼Œå½“æœ‰äº‹åŠ¡è¦è¿›è¡Œå†™æ“ä½œæ—¶ï¼Œåœ¨å†…å­˜å½“æ±‡æ€»ç»™ä½ åˆ›å»ºä¸€ä¸ªShadow Page Tableï¼Œå…¨éƒ¨æŒ‡å‘ç¡¬ç›˜å½“ä¸­çš„Masterï¼Œä¹‹åç¡¬ç›˜ä¸Šä¹Ÿä»Master å¤åˆ¶å‡ºæ¥ä¸€ä¸ªShadow Pageï¼Œå¹¶ä¸”ä»¤ç¡¬ç›˜å½“ä¸­çš„å¯¹åº”çš„page tableæ”¹å˜æŒ‡å‘ã€‚\nä¹‹åï¼Œæ‰€æœ‰çš„å†™æ“ä½œéƒ½åœ¨Shadow Pageä¸Šè¿›è¡Œã€‚åœ¨äº‹åŠ¡æäº¤å‰ï¼ŒDB Rootä¾æ—§æŒ‡å‘Master Page Tableï¼Œæ‰€æœ‰çš„Shadow Page å¯¹å…¶ä»–çš„äº‹åŠ¡éƒ½ä¸å¯è§ã€‚\nåœ¨äº‹åŠ¡æäº¤æ—¶ï¼Œåˆ™æ”¹å˜DB Rootçš„æŒ‡å‘ï¼Œä»¤å…¶æŒ‡å‘Shadow page Tableã€‚ä»è€Œè¯¥äº‹åŠ¡ä½œå‡ºçš„æ›´æ”¹å¯¹äºå…¶ä»–çš„äº‹åŠ¡å…¨éƒ¨å¯è§\nåœ¨ shadow pagingâ€‹ ä¸‹å›æ»šã€æ¢å¤æ•°æ®éƒ½å¾ˆå®¹æ˜“ï¼š\nUndo/Rollbackï¼šåˆ é™¤ shadow pages (table)â€‹ï¼Œå•¥éƒ½ä¸ç”¨åš Redoï¼šä¸éœ€è¦ redoâ€‹ï¼Œå› ä¸ºæ¯æ¬¡å†™äº‹åŠ¡éƒ½ä¼šå°†æ•°æ®è½ç›˜ Shadow Pageçš„ç¼ºé™·ï¼Ÿ å¤åˆ¶æ•´ä¸ª page table ä»£ä»·è¾ƒå¤§ï¼Œå°½ç®¡å¯ä»¥é€šè¿‡ä»¥ä¸‹æªæ–½æ¥é™ä½è¿™ç§ä»£ä»·ï¼š\néœ€è¦ä½¿ç”¨ç±»ä¼¼ B+ æ ‘çš„æ•°æ®ç»“æ„æ¥ç»„ç»‡ page tableâ€‹ æ— éœ€å¤åˆ¶æ•´ä¸ªæ ‘çŠ¶æ¶æ„ï¼Œåªéœ€è¦å¤åˆ¶åˆ°è¾¾æœ‰å˜åŠ¨çš„å¶å­èŠ‚ç‚¹çš„è·¯å¾„å³å¯ äº‹åŠ¡æäº¤çš„ä»£ä»·è¾ƒå¤§ï¼š\néœ€è¦å°†æ‰€æœ‰å‘ç”Ÿæ›´æ–°çš„ data pageã€page table ä»¥åŠæ ¹èŠ‚ç‚¹éƒ½åŒæ—¶è½ç›˜ã€‚ å®¹æ˜“äº§ç”Ÿç£ç›˜ç¢ç‰‡ï¼Œä½¿å¾—åŸå…ˆè·ç¦»è¿‘çš„æ•°æ®æ¸è¡Œæ¸è¿œï¼ŒIO å°±ä¼šå˜æˆç£ç›˜ IO ï¼Œæ‹–ç¼“é€Ÿåº¦ã€‚ éœ€è¦åšåƒåœ¾æ”¶é›† åªæ”¯æŒä¸€ä¸ªå†™äº‹åŠ¡æˆ–ä¸€æ‰¹å†™äº‹åŠ¡ä¸€æ¬¡æ€§æŒä¹…åŒ–ï¼Œéœ€è¦åŸºäºä¸åŒçš„å¹¶å‘ç­–ç•¥åˆ†æã€‚ Write-Ahead Log Steal + No-Force WALåŸºäºä¸€ä¸ªå‡è®¾ï¼Œæ¯ä¸ªä¿®æ”¹æ“ä½œéƒ½æœ‰ä¸€æ¡å¯¹åº”çš„æ—¥å¿—æ–‡ä»¶ã€‚\nè®¾ç«‹ä¸€ä¸ªå•ç‹¬çš„æ—¥å¿—æ–‡ä»¶ï¼Œè¦æ±‚åœ¨è¿›è¡ŒæŒä¹…åŒ–åˆ·ç›˜ä¹‹å‰ï¼Œå¿…é¡»è¦è¯å¯¹åº”çš„æ—¥å¿—æ–‡ä»¶é¦–å…ˆè¢«æŒä¹…åŒ–é“ç£ç›˜å½“ä¸­ï¼Œä»å­—é¢æ„æ€ä¸Šä½“ç°äº†write-ahead log ã€‚å½“æ—¥å¿—å®Œæˆå†™å…¥ä¹‹åï¼Œå³å¯è®¤ä¸ºæ­¤æ¬¡äº‹åŠ¡å·²ç»æäº¤ï¼Œå¯ä»¥ç»™äºˆå“åº”ã€‚\næ•´ä¸ªè¿‡ç¨‹å¦‚ä¸‹ï¼š\né¦–å…ˆå°†äº‹åŠ¡è¿›è¡Œçš„æ“ä½œæ”¾åœ¨å†…å­˜å½“ä¸­ï¼Œå³ä¸ºredo buffer åœ¨å¯¹å†…å­˜ä¸­çš„æ•°æ®è¿›è¡Œä¿®æ”¹(data pageå¯¹åº”çš„buffer poolä¸­çš„æ•°æ®ï¼‰ å¦‚æœè¯¥data pageè¦åˆ·ç›˜ï¼Œéœ€è¦æŠŠè¯¥äº‹åŠ¡å¯¹åº”çš„æ‰€æœ‰çš„æ—¥å¿—å¼ºåˆ¶å…¨éƒ¨åˆ·ç›˜ å½“ä¸€ä¸ªäº‹åŠ¡è¿›è¡Œæäº¤æ—¶ï¼Œæ— éœ€å°†data pageè¿›è¡Œåˆ·ç›˜ï¼Œåªéœ€è¦ä¿è¯data pageå¯¹åº”çš„æ—¥å¿—å…¨éƒ¨åˆ·ç›˜ï¼Œåªè¦æ—¥å¿—å…¨éƒ¨åˆ·ç›˜å®Œæˆï¼Œåˆ™å¯ä»¥å¯¹å¤–å®£å¸ƒæ­¤æ¬¡äº‹åŠ¡æˆåŠŸcommit ä¸€ä¸ªäº‹åŠ¡ç»ˆæ­¢æ—¶ï¼Œéœ€è¦å°†å…¶çš„æ‰€æœ‰æ—¥å¿—å…¨éƒ¨åˆ·ç›˜ï¼ŒåŒ…æ‹¬abortè®°å½• WALå½“ä¸­çš„æ—¥å¿—æ ¼å¼ï¼Ÿ æ¯ä¸ªäº‹åŠ¡å¼€å§‹æ—¶ï¼Œå…ˆæ—¥å¿—ä¸Šå†™ä¸Šä¸€ä¸ª\u0026lt;BEGIN\u0026gt;â€‹æ ‡ç­¾\näº‹åŠ¡commitæ—¶ï¼Œæ—¥å¿—ä¸Šå†™ä¸Šä¸€ä¸ª\u0026lt;COMMIT\u0026gt;â€‹â€‹æ ‡ç­¾\næ—¥å¿—ä¸Šçš„æ¯ä¸€æ¡è®°å½•åŒ…å«ï¼š\nTransaction Id (äº‹åŠ¡ id) Object Id (æ•°æ®è®°å½• id)ï¼šfilenameâ€‹â€‹ å’Œ pageid/blocknumâ€‹â€‹ Before Value (ä¿®æ”¹å‰çš„å€¼)ï¼Œç”¨äº undo æ“ä½œ After Value (ä¿®æ”¹åçš„å€¼)ï¼Œç”¨äº redo æ“ä½œ Log Sequence Numbers\nDBMSä¸ºæ¯æ¡æ—¥å¿—ç”Ÿæˆçš„å…¨å±€å”¯ä¸€çš„åºåˆ—å·ï¼Œä¸€èˆ¬LSNå•è°ƒé€’å¢ï¼Œå¹¶ä¸”ä¸ºäº†è¿›è¡Œcrash recoveryï¼Œéœ€è¦åœ¨å„ä¸ªéƒ¨åˆ†è¿›è¡Œè®°å½•ç›¸å…³ä¿¡æ¯\næ¯ä¸ªpageä¿å­˜ç€ä¸€ä¸ªpageLSNï¼ŒDBMSæœ¬èº«ç»´æŠ¤è€…flushedLSNï¼Œè¡¨æ˜ä¸Šä¸€æ¬¡è½ç›˜çš„æ—¥å¿—çš„LSNï¼Œè€Œåœ¨ä¸€ä¸ª$page_x$è½ç›˜ä¹‹å‰ï¼Œé¦–å…ˆåº”å½“ä¿è¯ $pageLSN_x \u0026lt;= flushedLSN$ï¼Œè¿™æ„å‘³ç€åœ¨è¯¥pageè½ç›˜æ—¶ï¼Œè¯¥pageçš„æ‰€æœ‰çš„æ—¥å¿—éƒ½å·²ç»è½ç›˜ã€‚æ¥ä¿è¯ WALçš„æ€æƒ³\nå­˜å‚¨å’Œç®¡ç†çš„ä½ç½®å¦‚å›¾ï¼š\nLogging Scheme å°±åƒSQLæ‰§è¡Œå™¨é‚£æ ·å¯ä»¥åˆ†ä¸ºç‰©ç†è®¡åˆ’å’Œé€»è¾‘è®¡åˆ’ï¼Œåœ¨Logging Scheme(æ—¥å¿—æ–¹æ¡ˆï¼Ÿ)ä¸ŠåŒæ ·å¯ä»¥åˆ†ä¸ºç‰©ç†å’Œé€»è¾‘ä¸¤ç§æ–¹æ¡ˆ\nPhysical Loggingï¼šè®°å½•åœ¨æ•°æ®åº“ä¸­çš„çœŸå®è®°å½•ï¼Œåœ¨å“ªä¸ªpageçš„ä»€ä¹ˆä½ç½®çš„è¿›è¡Œäº†ä¿®æ”¹ Logical Loggingï¼šé€»è¾‘æ—¥å¿—åªè®°å½•åšçš„é€»è¾‘æ“ä½œï¼Œå¦‚æ›´æ–°æ‰€æœ‰age=20çš„tupleï¼Œè®°å½•å†…å®¹è¾ƒå°‘ï¼Œä½†æ˜¯ç›¸å¯¹çš„éš¾ä»¥å¼„æ¸…æ¥šå…·ä½“åšäº†ä»€ä¹ˆå˜åŒ–ï¼Œæ¢å¤çš„æ—¶å€™ä»£ä»·æ›´ä¸ºæ˜‚è´µ è¿˜æœ‰ä¸€ç§æ··åˆç­–ç•¥ï¼Œç§°ä¸º physiological loggingâ€‹ï¼Œè¿™ç§æ–¹æ¡ˆä¸ä¼šåƒ physical loggingâ€‹ ä¸€æ ·è®°å½• xx page xx åç§»é‡ä¸Šçš„æ•°æ®å‘ç”Ÿ xx æ”¹åŠ¨ï¼Œè€Œæ˜¯è®°å½• xx page ä¸Šçš„ id ä¸º xx çš„æ•°æ®å‘ç”Ÿ xx æ”¹åŠ¨ï¼Œå‰è€…éœ€è¦å…³å¿ƒ data page åœ¨ç£ç›˜ä¸Šçš„å¸ƒå±€ï¼Œåè€…åˆ™æ— éœ€å…³å¿ƒã€‚physiological loggingâ€‹ ä¹Ÿæ˜¯å½“ä¸‹æœ€æµè¡Œçš„æ–¹æ¡ˆã€‚\nWALå¦‚ä½•è§£å†³äº†Shadow Pageçš„ç¼ºé™· åœ¨Shadow Pageç­–ç•¥å½“ä¸­ï¼Œé€šè¿‡Page Tableè®¿é—®Shadow Pageè®¿é—®å±äºéšæœº IO ï¼Œä¼šå½±å“äº‹åŠ¡æäº¤æ—¶çš„æ•ˆç‡ï¼Œå½±å“å¹¶å‘äº‹åŠ¡çš„æ•°é‡ã€‚è€Œé¡ºåºå†™å…¥æ°¸è¿œæ¯”éšæœºå†™å…¥å¿«ï¼ŒWrite-Ahead Logå³è·µè¡Œäº†è¿™ç§æ€æƒ³ï¼Œå°±å¥½æ¯”é‚£ä¸ªç²‰æ¿çš„ä¾‹å­ï¼Œé¡ºåºå†™ç²‰æ¿æ°¸è¿œå¿…éšæœºå†™åˆ°è´¦æœ¬ä¸Šçš„é€Ÿåº¦è¦å¿«ã€‚\næ­¤å¤–ï¼ŒWALä¹Ÿä¸æ¶‰åŠåˆ°åƒæ˜¯Pageå¤åˆ¶ç­‰æ“ä½œï¼Œåªéœ€è¦ç»´æŠ¤ä¸€ä¸ªæ—¥å¿—æ–‡ä»¶ï¼Œä¹‹åä¸€è‡´å‘å…¶ä¸­è¿½åŠ å†™å…¥å³å¯ã€‚\nè¯´ä¸€è¯´WALå½“ä¸­çš„Checkpoint WALä¼šä¸€ç›´è¿›è¡Œè®°å½•ï¼Œå¦‚æœå‘ç”Ÿå´©æºƒæƒ³è¦è¿›è¡Œredoæ¥æ¢å¤æ•°æ®åº“çŠ¶æ€ï¼Œé‚£ä¹ˆå°±è¦æ‰§è¡Œæ•´ä¸ªæ—¥å¿—æ–‡ä»¶æ¥è¿›è¡Œæ¢å¤ï¼Œè€—æ—¶è¾ƒé•¿ã€‚\nå½“ç¼“å­˜ä¸­çš„æ•°æ®ï¼ˆdata pageï¼‰å·²ç»æŒä¹…åŒ–åˆ°ç¡¬ç›˜å½“ä¸­ï¼Œæ­¤åä¾¿æ— éœ€å†æ‹…å¿ƒè¿™äº›æ•°æ®çš„æŒä¹…åŒ–é—®é¢˜ï¼Œä¾¿å¯ä»¥æ‰“ä¸Šä¸€ä¸ªcheckpointï¼Œé€šè¿‡checkpointçš„æ–¹å¼ï¼Œå°±åƒæ¸¸æˆä¸­çš„æ£€æŸ¥ç‚¹ï¼Œåç»­çš„æ¢å¤åªéœ€è¦ä»checkpointçš„ä½ç½®å¼€å§‹æ¢å¤å³å¯ï¼Œä¹‹å‰çš„æ—¥å¿—æ–‡ä»¶æ— éœ€åœ¨æ„ï¼Œç”šè‡³å¯ä»¥ç›´æ¥åˆ é™¤ã€‚\né€šè¿‡\u0026lt;CHECKPOINT\u0026gt;â€‹æ ‡ç­¾æ¥è¡¨æ˜åœ¨æ­¤å¤„æ‰“ä¸Šäº†ä¸€ä¸ªcheckpoint\nCheckpointæœ‰ä»€ä¹ˆç›¸å…³ä¼˜åŒ–ï¼Ÿ ç›®å‰æè¿°çš„CheckPointä¸º Non-Fuzzy Checkpointï¼Œåˆ›å»ºæ—¶ï¼š\nåœæ­¢åˆ›å»ºä»»ä½•çš„æ–°äº‹åŠ¡ ç­‰å¾…ç›®å‰æ‰€æœ‰çš„æ´»è·ƒ(active)äº‹åŠ¡æ‰§è¡Œå®Œæ¯• å°†æ‰€æœ‰çš„è„é¡µè¿›è¡Œåˆ·ç›˜ ç”±æ­¤å¯è§ï¼ŒNon-Fuzzy Checkpointçš„åˆ›å»ºä¼šä¸¥é‡å½±å“DBMSçš„æ€§èƒ½ï¼Œå› æ­¤åœ¨æ­¤åŸºç¡€ä¸Šå¯ä»¥è¿›è¡Œæ”¹è¿›ï¼š\nSlighly Better Checkpointâ€‹\nåœ¨è¿›è¡Œcheckpointåˆ›å»ºåï¼Œæ ¹æ®é”çš„æš‚åœå†™äº‹åŠ¡ï¼Œå†™äº‹åŠ¡å¯ä»¥å‘checkpiontå¼€å§‹å‰å°±å·²ç»åŠ é”çš„pageè¿›è¡Œç»§ç»­å†™å…¥ï¼Œä½†æ˜¯ä¸èƒ½è·å–æ–°çš„é”ï¼Œæ­¤æ—¶ç³»ç»Ÿå½“ä¸­ç”±äºå·²ç»å­˜åœ¨å·²ç»å¼€å§‹ä½†è¢«æš‚åœçš„å†™äº‹åŠ¡ï¼Œå› æ­¤åœ¨ä¹‹ååˆ›å»ºcheckpointjæ‰«ææ•´ä¸ªbuffer poolåˆ·ç›˜æ—¶ï¼Œä¼šå°†è„é¡µä¹Ÿé¡ºå¸¦å†™å…¥ç£ç›˜å½“ä¸­ï¼Œå¯èƒ½ä¼šå‡ºç°ä¸ä¸€è‡´çš„é—®é¢˜ï¼Œå› æ­¤éœ€è¦é¢å¤–è®°å½•ï¼š\nActive Transaction Tableï¼ˆATTï¼‰ï¼šè®°å½•å½“å‰æ‰€æœ‰çš„æ´»è·ƒäº‹åŠ¡ Dirty Page Tableï¼ˆDPTï¼‰ï¼šè®°å½•ç›®å‰buffer poolä¸­çš„è„é¡µ ATTå½“ä¸­è®°å½•ç€äº‹åŠ¡idã€äº‹åŠ¡çŠ¶æ€ä»¥åŠlastLSNï¼Œå½“ä¹‹åäº‹åŠ¡ä¸­æ­¢æˆ–è€…æäº¤æ—¶ï¼Œå“åº”çš„è®°å½•æ‰ä¼šè¢«åˆ é™¤\nâ€\nFuzzy Checkpoint fuzzyçš„æ„æ€ä¸ºcheckpointçš„åˆ›å»ºä¸ºä¸€ä¸ªåŠ¨æ€çš„æ¨¡ç³Šçš„è¿‡ç¨‹ï¼Œå¹¶ä¸æ˜¯åœ¨æŸä¸€ä¸ªäº‹åŠ¡çš„ä¹‹å‰ä¹‹åè¿›è¡Œçš„åˆ›å»ºï¼Œè€Œæ˜¯åœ¨äº‹åŠ¡çš„æ‰§è¡Œè¿‡ç¨‹ä¸­è¿›è¡Œåˆ›å»ºã€‚\nfuzzy checkpointçš„åˆ›å»ºä¸ä¸­æ–­ä»»ä½•ä¸€ä¸ªäº‹åŠ¡çš„æ‰§è¡Œï¼Œåœ¨æ­¤æœŸé—´å…è®¸äº‹åŠ¡ç»§ç»­æ‰§è¡Œå’Œè„é¡µçš„åˆ·ç›˜\nç”±äºåˆ›å»ºä¸ºä¸€ä¸ªæ—¶é—´æ®µï¼Œå¹¶ä¸”å…è®¸äº‹åŠ¡æ‰§è¡Œï¼Œå› æ­¤éœ€è¦æ ‡è®°å¼€å§‹çš„å’Œç»“æŸçš„çŠ¶æ€ï¼š\nCHECKPOINT-BEGINï¼šè¡¨æ˜å¼€å§‹åˆ›å»ºæ£€æŸ¥ç‚¹ CHECKPOINT-ENDï¼šç»“æŸåˆ›å»ºï¼ŒåŒ…å«ATT+DPT å½“checkpointåˆ›å»ºæˆåŠŸåï¼Œcheckpointçš„LSNè¢«å†™å…¥åˆ° DBçš„MasterRecordä¸­\nä»»ä½•ä¸€ä¸ªåœ¨CHECKPOINT-BEGINä¹‹åå¼€å§‹çš„äº‹åŠ¡éƒ½ä¸è¢«è®°å½•åˆ°CHECKPOINT-ENDä¸­çš„ATTå½“ä¸­ï¼Œè®°å½•åœ¨CHECKPOINT-BEGINä¹‹å‰å¼€å§‹ä½†æ˜¯è¿˜æœªæ‰§è¡Œå®Œçš„äº‹åŠ¡\nARIES Database Recovery Algorithms for Recovery and Isoation Exploiting Semantics\nå¯¹äºARIESï¼Œå…¶åŸºç¡€æ˜¯æ—¥å¿—ç­–ç•¥å¿…é¡»ä½¿ç”¨WALï¼Œå³ï¼š\nä»»ä½•æ›´æ”¹åœ¨å†™å…¥åˆ°æ•°æ®åº“ä¹‹å‰éƒ½è¦å…ˆè®°å½•åœ¨æ—¥å¿—å½“ä¸­å¹¶ä¸”æŒä¹…åŒ–åˆ°ç¡¬ç›˜ä¹‹ä¸Š buffer poolçš„ç®¡ç†ç­–ç•¥å¿…é¡»ä½¿ç”¨ STEAL+NO-FORCE å¹¶ä¸”é€šè¿‡redo å’Œ undo æ¥å®Œæˆå´©æºƒåçš„æ¢å¤ï¼š\nåœ¨crashåè¿˜æ˜¯è¿›è¡Œæ¢å¤æ—¶ï¼Œæœ€å¼€å§‹å…ˆé‡æ–°æ‰§è¡Œæ—¥å¿—ä¸­è®°å½•çš„æ“ä½œï¼Œå°†æ•°æ®åº“çš„çŠ¶æ€æ¢å¤åˆ°å´©æºƒä¹‹å‰ åœ¨redoæ‰§è¡Œå®Œä¹‹åï¼Œå†è¿›è¡Œundoæ“ä½œï¼Œæ’¤é”€æœªå®Œæˆçš„äº‹åŠ¡ï¼Œå¹¶ä¸”å°†undoæ“ä½œè®°å½•åˆ°æ—¥å¿—å½“ä¸­ï¼Œæ¥ç¡®ä¿é‡å¤å¤±è´¥æ—¶ä¸ä¼šé‡å¤æ“ä½œ äº‹åŠ¡æäº¤æ—¶çš„æ—¥å¿—è¡Œä¸ºï¼Ÿ å½“äº‹åŠ¡æäº¤æ—¶ï¼Œé¦–å…ˆå†™ä¸€æ¡COMMITè®°å½•å½“WALå½“ä¸­ï¼Œä¹‹åå°†COMMITä»¥åŠä¹‹å‰çš„æ—¥å¿—è¿›è¡Œè½ç›˜ï¼Œä¹‹åå°†flushedLSNè¿›è¡Œæ›´æ–°ï¼Œä¹‹åå³å¯æ¸…é™¤æ‰å†…å­˜å½“ä¸­COMMITä»¥åŠä¹‹å‰çš„æ—¥å¿—ã€‚ä¹‹åå†å†™å…¥ä¸€æ¡TXN-ENDè®°å½•åˆ°æ—¥å¿—å½“ä¸­ï¼Œè¡¨ç¤ºäº‹åŠ¡çœŸæ­£ç»“æŸ\näº‹åŠ¡ä¸­æ­¢æ—¶çš„æ—¥å¿—è¡Œä¸ºï¼Ÿ è¦è¿›è¡Œäº‹åŠ¡ä¸­æ­¢ï¼Œå°±è¦åœ¨å½“å‰çš„çŠ¶æ€çš„åŸºç¡€ä¹‹ä¸Šï¼Œæ ¹æ®å…ˆå‰å†™å…¥çš„WALæ—¥å¿—ï¼Œè¿›è¡Œä¸€æ¡æ¡çš„å›é€€è¿›è¡Œundoï¼Œæ¢å¤åˆ°äº‹åŠ¡å¼€å§‹æ—¶çš„çŠ¶æ€ã€‚\nå› æ­¤åœ¨åŸæœ¬æ—¥å¿—çš„åŸºç¡€ä¸Šï¼Œéœ€è¦å¼•å…¥ä¸€ä¸ªé¢å¤–çš„æ•°æ®preLSNï¼Œè¡¨æ˜å½“å‰äº‹åŠ¡æ—¥å¿—çš„å‰ä¸€æ¡æ—¥å¿—ï¼Œç”¨äºå½¢æˆä¸€ä¸ªé“¾è¡¨çš„å½¢å¼å°†æ•´ä¸ªäº‹åŠ¡çš„ç›¸å…³æ—¥å¿—ä¸²è”èµ·æ¥ï¼Œä¾¿äºå›é€€æ‰§è¡Œã€‚\nä¸ºäº†é˜²æ­¢åœ¨å›æ»šè¿‡ç¨‹ä¸­å†æ¬¡æ•…éšœå¯¼è‡´éƒ¨åˆ†æ“ä½œè¢«æ‰§è¡Œå¤šæ¬¡ï¼Œå›æ»šæ“ä½œä¹Ÿéœ€è¦å†™å…¥æ—¥å¿—ä¸­ï¼Œç­‰å¾…æ‰€æœ‰æ“ä½œå›æ»šå®Œæ¯•åï¼ŒDBMS å†å¾€ WAL ä¸­å†™å…¥ TXN-END è®°å½•ï¼Œæ„å‘³ç€æ‰€æœ‰ä¸è¿™ä¸ªäº‹åŠ¡æœ‰å…³çš„æ—¥å¿—éƒ½å·²ç»å†™å®Œï¼Œä¸ä¼šå†å‡ºç°ç›¸å…³ä¿¡æ¯\nå› æ­¤å¼•å…¥äº†CLRï¼ŒCLRä½œä¸ºä¸€ç§æ“ä½œï¼Œä¸COMMIT UPDATEç­‰ä¸€æ ·éœ€è¦é€šè¿‡æ—¥å¿—è¿›è¡Œè®°å½•ï¼ŒCLRå½“ä¸­è®°å½•undoçš„å…·ä½“æ“ä½œï¼Œå¹¶ä¸”é€šè¿‡ä¸€ä¸ªundoNextæŒ‡é’ˆï¼ŒæŒ‡å‘ä¸‹ä¸€æ¡è¿›è¡Œundoçš„æ—¥å¿—ã€‚\næ°¸è¿œä¸ä¼šå¯¹CLRæœ¬èº«è¿›è¡Œundo\nå®Œæ•´è¿‡ç¨‹ä¸ºï¼š\né¦–å…ˆåœ¨æ—¥å¿—å‰æ·»åŠ ä¸€ä¸ªABORTè®°å½•ï¼Œè¡¨ç¤ºå¼€å§‹è¿›è¡Œä¸­æ­¢æ“ä½œ æ‰¾åˆ°æ—¥å¿—å½“ä¸­è¯¥äº‹åŠ¡çš„æœ€åä¸€æ¡æ—¥å¿—ï¼Œæ ¹æ®preLSNé€†åºè¿›è¡Œæ“ä½œ å¯¹äºä¹‹å‰çš„æ¯ä¸ªUPDATE RECORDï¼Œæ·»åŠ ä¸€æ¡CLRï¼Œä¹‹åå°†æ•°æ®åº“å½“ä¸­çš„å€¼æ¢å¤ä¸ºåŸæœ¬çš„å€¼ æœ€ç»ˆå›æ»šç»“æŸæ—¶ï¼Œåœ¨æ—¥å¿—çš„æœ«å°¾æ·»åŠ ä¸€æ¡TXN-ENDï¼Œè¡¨æ˜å›æ»šç»“æŸ â€\nARIES -Recovery Phases Crash Recoveryä¸»è¦åˆ†ä¸ºä¸‰ä¸ªè¿‡ç¨‹ï¼š\nAnalysisï¼šé€šè¿‡æ—¥å¿—è§£æå‡ºåœ¨crashä¹‹å‰çš„æ•°æ®åº“çŠ¶æ€ï¼Œæ‰¾åˆ°ä¸Šä¸€ä¸ªæ£€æŸ¥ç‚¹ é€šè¿‡ATTå’ŒDPTè·å–å´©æºƒæ—¶çš„æ•°æ®åº“çš„çŠ¶æ€ï¼Œæ‰¾åˆ°å½“æ—¶çš„è„é¡µå’Œæ´»è·ƒäº‹åŠ¡çš„æƒ…å†µï¼Œæ¥ç¡®å®šé‚£äº›éœ€è¦redoï¼Œé‚£äº›éœ€è¦undo Redoï¼šä»ä¸€ä¸ªåˆé€‚çš„ç‚¹å¼€å§‹é‡å¤æ‰§è¡Œæ—¥å¿—ä¸­è®°å½•çš„æ‰€æœ‰æ“ä½œï¼Œå³ä¾¿è¯¥æ“ä½œå¯¹åº”çš„äº‹åŠ¡åœ¨åç»­è¢«abort Undoï¼šå¯¹äºcrashå‰çš„æ‰€æœ‰æœªcommitçš„äº‹åŠ¡ï¼ˆåŒ…æ‹¬æ²¡æ¥å¾—åŠè¿›è¡Œcommitï¼Œæ‰§è¡Œäº†ä¸€åŠçš„äº‹åŠ¡å’Œæœ€ç»ˆéœ€è¦abortçš„äº‹åŠ¡ï¼‰åå‘æ‰§è¡Œï¼Œæ’¤é”€å…¶è¿›è¡Œçš„æ“ä½œå’Œå¯¹ç£ç›˜çš„å½±å“ Analysis phase ä»æœ€è¿‘çš„begin checkpointè¿›è¡Œæ‰«æï¼Œå¦‚æœæ‰«æåˆ°äº†ä¸€ä¸ªTXN-ENDâ€‹é‚£ä¹ˆå°±æŠŠå¯¹åº”çš„äº‹åŠ¡ç§»é™¤ATTï¼Œè€Œå¯¹äºå…¶ä»–ç±»å‹çš„è®°å½•ï¼š\nå°±å°†å…¶åŠ å…¥åˆ°ATTå½“ä¸­ï¼Œå¹¶è®¾ç½®statusä¸ºUNDO å¦‚æœæ‰«æåˆ°äº†ä¸€ä¸ªCOMMITâ€‹å°±å°†äº‹åŠ¡çš„çŠ¶æ€æ”¹ä¸ºCOMMITâ€‹ å¯¹äºUPDATEâ€‹ recordsï¼Œå¦‚æœæ›´æ–°çš„page pä¸åœ¨ DPTå½“ä¸­ï¼Œé‚£ä¹ˆå°±å°†å…¶åŠ å…¥åˆ°DPTå½“ä¸­ï¼Œå¹¶ä¸”è®¾ç½®ï¼šrecLSN = LSNâ€‹ï¼ˆè¡¨æ˜è¿™æ˜¯ç¬¬ä¸€æ¬¡å°†è¯¥pageåŠ è½½åˆ°buffer poolå½“ä¸­å¹¶ä¸”è¿›è¡Œæ›´æ”¹ï¼‰ å½“æ‰§è¡Œå®ŒAnalysisè¿‡ç¨‹ï¼Œæ„å»ºå‡ºATTå’ŒDPTä¹‹åï¼š\nATTè¡¨æ˜åœ¨crashæ—¶æœ‰å“ªäº›äº‹åŠ¡å¤„äºæ´»è·ƒçŠ¶æ€ DPTè¡¨æ˜å½“æ—¶æœ‰å“ªäº›è„é¡µè¿˜æ²¡æ¥å¾—åŠè½ç›˜ Redo Phase é‡å»ºèµ·crashæ—¶dbçš„çŠ¶æ€ï¼Œé‡æ–°æ‰§è¡Œæ‰€æœ‰çš„updateå’ŒCLRs\nä» DPT ä¸­æ‰¾åˆ°æœ€å°çš„ recLSNï¼Œä»é‚£å¼€å§‹å‘å redoâ€‹ æ—¥å¿—å’Œ CLRæ—¥å¿—ï¼Œé™¤äº†ä¸€ä¸‹çš„ä¸¤ç§æƒ…å†µï¼Œå…¶ä»–å‡åº”å½“è¿›è¡Œredoæ“ä½œï¼š\nå¦‚æœä¸åœ¨DPTä¸­ï¼Œåˆ™è¯æ˜ä¹‹å‰åœ¨æŸæ—¶é—´å·²ç»å°†å…¶åˆ·ç›˜æŒä¹…åŒ–åˆ°ç¡¬ç›˜å½“ä¸­ å¦‚æœè®°å½•çš„LSNå°äº pageçš„recLSNï¼Œåˆ™è¯æ˜ï¼Œåœ¨æ­¤æ¬¡æ“ä½œå°†å…¶åˆ·ç›˜ä¹‹åï¼Œåˆæœ‰å…¶ä»–çš„äº‹åŠ¡è¯»å–äº†è¯¥é¡µåˆ°å†…å­˜å½“ä¸­è¿›è¡Œäº†é‡æ–°çš„ä¿®æ”¹ï¼Œå› æ­¤æ­¤æ¬¡æ“ä½œè¢«åç»­çš„æ“ä½œè¦†ç›–ï¼Œå› æ­¤å¯ä»¥å¿½ç•¥ï¼ˆå‚è€ƒ recLSNçš„å®šä¹‰ï¼‰ æœ€å°çš„recLSNè¡¨æ˜ä¸ºæ•°æ®åº“ä¸­æœ€æ—©çš„è„é¡µçŠ¶æ€ï¼Œå†æ­¤ä¹‹å‰çš„æ—¥å¿—å‡ä¸ºäº§ç”Ÿè„é¡µï¼Œå› æ­¤ä¸éœ€è¦è¿›è¡Œé‡æ–°æ„å»ºã€‚\nredoæ—¶ï¼Œéœ€è¦ï¼š\né‡æ–°æ‰§è¡Œæ—¥å¿—ä¸­çš„æ“ä½œ å°† pageLSN ä¿®æ”¹æˆæ—¥å¿—è®°å½•çš„ LSN ä¸å†æ–°å¢æ“ä½œæ—¥å¿—ï¼Œä¹Ÿä¸å¼ºåˆ¶åˆ·ç›˜ åœ¨ Redo Phase ç»“æŸæ—¶ï¼Œä¼šä¸ºæ‰€æœ‰çŠ¶æ€ä¸º COMMIT çš„äº‹åŠ¡å†™å…¥ TXN-END æ—¥å¿—ï¼ŒåŒæ—¶å°†å®ƒä»¬ä» ATT ä¸­ç§»é™¤ã€‚\nUndo Phase å°†æ‰€æœ‰ Analysis Phase åˆ¤å®šä¸º U (candidate for undo) çŠ¶æ€çš„äº‹åŠ¡çš„æ‰€æœ‰æ“ä½œæŒ‰æ‰§è¡Œé¡ºåºå€’åº Undoâ€‹ï¼Œå¹¶ä¸”ä¸ºæ¯ä¸ª undo æ“ä½œå†™ä¸€æ¡ CLR æ›´æ–°åˆ°æ—¥å¿—æ–‡ä»¶ä¸­ã€‚\n","permalink":"https://fischer0522.github.io/en/posts/tech/%E6%97%A5%E5%BF%97%E4%B8%8E%E6%81%A2%E5%A4%8D/","summary":"æ—¥å¿—ä¸æ¢å¤ æ•°æ®åº“å½“ä¸­å­˜åœ¨å“ªäº›æ•…éšœï¼Ÿ ç®€å•æ¥è¯´å¯ä»¥åˆ†ä¸ºä¸‰ç§æ•…éšœï¼š äº‹åŠ¡æ•…éšœ ç³»ç»Ÿæ•…éšœ å­˜å‚¨ä»‹è´¨æ•…éšœ è€Œäº‹åŠ¡æ•…éšœä¹Ÿå¯åˆ†ä¸ºä¸¤ç§ï¼š é€»è¾‘é”™è¯¯ (Logical Errors)ï¼šç”±","title":"æ—¥å¿—ä¸æ¢å¤"},{"content":"äº‹åŠ¡ä¸å¹¶å‘æ§åˆ¶ ç®€å•ä»‹ç»ä¸€ä¸‹äº‹åŠ¡ï¼Ÿ äº‹åŠ¡ä½œä¸ºæ•°æ®åº“æ‰§è¡Œè¿‡ç¨‹ä¸­çš„ä¸€ä¸ªé€»è¾‘å•ä½ï¼Œå¯ä»¥è¡¨æ˜ä¸€ç»„æ“ä½œï¼Œè¿™ä¸€ç»„æ“ä½œè¦ä¹ˆä¸€èµ·æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å›æ»šï¼Œå¹¶ä¸”äº‹åŠ¡ä¹‹é—´ä¸€å®šç¨‹åº¦ä¸Šç›¸äº’éš”ç¦»ï¼Œäº’ä¸å½±å“ã€‚äº‹åŠ¡å…·æœ‰äº‹åŠ¡çš„å››å¤§ç‰¹æ€§ ACIDï¼Œåˆ†åˆ«ä¸ºåŸå­æ€§ ä¸€è‡´æ€§ éš”ç¦»æ€§ä¸æŒä¹…æ€§\nä»‹ç»ä¸€ä¸‹äº‹åŠ¡çš„å››å¤§ç‰¹æ€§ äº‹åŠ¡çš„å››å¤§ç‰¹æ€§åˆ†åˆ«ä¸ºåŸå­æ€§ã€ä¸€è‡´æ€§ã€éš”ç¦»æ€§ä¸æŒä¹…æ€§\nå¯¹äºåŸå­æ€§ï¼Œåˆ™äº‹åŠ¡æœ¬èº«ä½œä¸ºä¸€ä¸ªæ•´ä½“ï¼Œè¦ä¹ˆå…¨éƒ¨æˆåŠŸæ‰§è¡Œï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥å›æ»šï¼Œä¸å­˜åœ¨æ‰§è¡ŒæˆåŠŸä¸€åŠçš„ä¸­é—´æ€ã€‚\nä¸€è‡´æ€§è¡¨æ˜æ•°æ®åº“åœ¨äº‹åŠ¡æ‰§è¡Œå‰å’Œæ‰§è¡Œåï¼Œæ•°æ®åº“çš„çŠ¶æ€å¿…é¡»æ»¡è¶³é¢„å®šçš„ä¸€è‡´æ€§è§„åˆ™ï¼Œå³æ•°æ®åº“åªèƒ½ä»ä¸€ç§çŠ¶æ€è½¬æ¢ä¸ºå¦å¤–ä¸€ç§ä¸€è‡´æ€§çŠ¶æ€ï¼Œæœ€ç®€å•çš„ä¾‹å­å³ä¸ºé“¶è¡Œè½¬è´¦ï¼Œåªæœ‰è½¬è´¦å‰ä¸è½¬è´¦åçš„ä¸¤ç§ä¸€è‡´æ€§çŠ¶æ€ï¼Œä¸å­˜åœ¨ä¸€äººè½¬å‡ºè€Œå¦ä¸€äººæœªæ”¶åˆ°çš„ä¸­é—´çŠ¶æ€ã€‚æ­¤å¤–ä¸€è‡´æ€§åˆ†ä¸ºæ•°æ®åº“ä¸€è‡´æ€§å’Œäº‹åŠ¡ä¸€è‡´æ€§ï¼Œæ•°æ®åº“åªä¿è¯æ•°æ®åº“ä¸€è‡´æ€§ï¼Œå°±åƒä¸Šé¢æ‰€è¯´çš„é‚£æ ·ï¼Œè€Œäº‹åŠ¡ä¸€è‡´æ€§åˆ™æ›´æ˜¯ä¸€ç§é€»è¾‘å…³ç³»ï¼Œéœ€è¦æ“ä½œäººå‘˜å»æ‰‹åŠ¨çº¦æŸ\næ­¤å¤– æ•°æ®åº“çš„ä¸€è‡´æ€§åº”å½“ä¸åˆ†å¸ƒå¼ç³»ç»Ÿå½“ä¸­çš„ä¸€è‡´æ€§çš„æ¦‚å¿µç›¸åŒºåˆ†ï¼Œåˆ†å¸ƒå¼å½“ä¸­çš„ä¸€è‡´æ€§æŒ‡çš„æ˜¯åœ¨å¤šä¸ªèŠ‚ç‚¹ä¸Šæ•°æ®ä¿æŒä¸€è‡´çš„çŠ¶æ€ï¼Œæ¯”å¦‚å…¶ä¸­æœ€ä¸¥æ ¼çš„çº¿æ€§ä¸€è‡´æ€§å°±è¦æ±‚å¯¹å¤–éœ€è¦è¡¨ç°æˆå•æœºèŠ‚ç‚¹ï¼Œå¦‚æœä¸€æ¬¡å†™å…¥å®Œæˆé‚£ä¹ˆåç»­å°±ä¸€å®šè¦èƒ½å¤Ÿè¯»å–åˆ°æ•°æ®\néš”ç¦»å‹ï¼šå¹¶å‘æ‰§è¡Œçš„å¤šä¸ªäº‹åŠ¡ä¹‹é—´åº”å½“éš”ç¦»ï¼Œä½¿æ¯ä¸ªäº‹åŠ¡æ„Ÿè§‰åœ¨ç‹¬ç«‹çš„æ“ä½œæ•°æ®åº“ï¼Œé˜²æ­¢äº‹åŠ¡ä¹‹é—´çš„ç›¸äº’å¹²æ‰°ä¸æ•°æ®æ±¡æŸ“\næŒä¹…æ€§ï¼šæŒä¹…æ€§è¡¨æ˜ä¸€æ—¦äº‹åŠ¡æäº¤ï¼Œé‚£ä¹ˆå…¶åšå‡ºçš„æ›´æ”¹åº”å½“ä¸ºæ°¸ä¹…æ€§çš„\nè¯´ä¸€ä¸‹äº‹åŠ¡çš„éš”ç¦»çº§åˆ« å››ç§éš”ç¦»çº§åˆ«çš„å·®åˆ«ä¸»è¦èšç„¦äºè¯»æ“ä½œä¸Šï¼Œå¯¹äºå†™æ“ä½œï¼Œä¸ºäº†ä¿è¯æ•°æ®åº“ä¸€è‡´æ€§ï¼Œåªæœ‰å†™å…¥çš„é”åªæœ‰æ•°æ®æäº¤æ—¶æ‰èƒ½å¤Ÿé‡Šæ”¾ï¼Œå¦‚æœä¸­é€”é‡Šæ”¾é”ï¼Œå†™å…¥çš„æ“ä½œç»“æœå¯èƒ½ä¼šè¢«å…¶ä»–çš„è¦†ç›–ï¼Œä»è€Œè¿åäº†æ•°æ®åº“ä¸€è‡´æ€§ã€‚å•ç‹¬çœ‹å†™é”çš„è¯ï¼Œéƒ½æ˜¯é‡‡ç”¨äº†ä¸¥æ ¼ä¸¤é˜¶æ®µé”çš„ç­–ç•¥ï¼Œä¿è¯ä¸€è‡´æ€§ï¼ŒåŒæ—¶é¿å…çº§è”ä¸­æ­¢ã€‚\nREAD UNCOMMITTED\næœ€å®½æ¾çš„éš”ç¦»çº§åˆ«ï¼Œæ ¹æ®ä¸Šè¡¨å¯ä»¥çœ‹åˆ°è„è¯» ä¸å¯é‡å¤è¯» å¹»è¯»éƒ½ä¼šå‘ç”Ÿ\nåœ¨å®ç°ä¸Šè¯»æ“ä½œä¸éœ€è¦åŠ é”ï¼Œå†™æ“ä½œå’Œå…¶ä»–çš„ä¸€è‡´ï¼Œå› æ­¤æ‰€æœ‰è¯»ç›¸å…³çš„é”éƒ½ä¸æ”¯æŒï¼Œå¦‚æœæƒ³å°è¯•åŠ [S,IS,SIX]ï¼Œéƒ½ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚ç”±äºåªæ”¯æŒå†™é”ï¼Œåœ¨shrinkingé˜¶æ®µï¼Œä»»ä½•åŠ é”æ“ä½œéƒ½æ˜¯ä¸å…è®¸çš„ï¼Œä¼šæŠ›å‡ºå¼‚å¸¸ã€‚\nå› æ­¤å¹¶ä¸ä¿è¯è¯»å–åˆ°çš„æ•°æ®ä¸€å®šæ˜¯æäº¤çš„æ•°æ®ï¼Œç”±äºå¹¶æ²¡æœ‰åŠ è¯»é”å’Œå…¶ä»–çš„äº‹åŠ¡è¿›è¡Œäº’æ–¥ï¼Œå…¶ä»–çš„äº‹åŠ¡ä¸€æ—¦å†™å…¥ä¹‹åå°±å¯ä»¥è¢«è¯»å–ï¼Œå› æ­¤å½“è¯»å–åˆ°ä¹‹åï¼Œå¦‚æœå†™å…¥æ•°æ®çš„äº‹åŠ¡ä¸­æ­¢å›æ»šï¼Œé‚£ä¹ˆè¯»å–åˆ°çš„æ•°æ®å°±å˜æˆäº†è„æ•°æ®äº§ç”Ÿè„è¯»ã€‚\nREAD COMMITTED\nç›¸æ¯”äºè¯»æœªæäº¤è§£å†³äº†è„è¯»çš„é—®é¢˜ï¼Œä½†æ˜¯ä¾æ—§ä¼šå‡ºç°ä¸å¯é‡å¤è¯»å’Œå¹»è¯»\nåœ¨å®ç°ä¸Šè¯»æ“ä½œéœ€è¦åœ¨Tableä¸ŠåŠ ISï¼Œåœ¨Rowä¸ŠåŠ Sï¼Œå¹¶ä¸”å½“å®Œæˆä¸€æ¬¡è¯»å–ä¹‹åå³å¯å°†é”é‡Šæ”¾ï¼Œæ— éœ€ç­‰å¾…äº‹åŠ¡çš„æäº¤ã€‚é‡Šæ”¾Sé”å¹¶ä¸ä¼šå¯¼è‡´äº‹åŠ¡ä»growingå‘shrinkingè½¬å˜ã€‚\nç”±äºé€šè¿‡Sé”è¿›è¡Œäº’æ–¥ï¼Œä»è€Œä¿è¯é‚£äº›æ­£åœ¨å†™å…¥çš„äº‹åŠ¡åœ¨æäº¤å‰ä¸åº”è¢«è¯»å–åˆ°ï¼Œèƒ½å¤Ÿè¯»å–åˆ°çš„æ•°æ®ä¸€å®šæ˜¯æäº¤ä¹‹åç¨³å®šå†™å…¥çš„æ•°æ®ã€‚\nREPEATABLE READ\nåœ¨è¯»æäº¤çš„åŸºç¡€ä¸Šåˆè§£å†³äº†ä¸å¯é‡å¤è¯»çš„é—®é¢˜ï¼Œå­˜åœ¨å¹»è¯»ã€‚\nå®ç°ä¸ŠåŠ é”ç­–ç•¥å’ŒREAD COMMITTEDå¹¶æ²¡æœ‰åŒºåˆ«ï¼Œä½†æ˜¯åœ¨é‡Šæ”¾é”ä¸Šè¯»å†™é”å…¨éƒ¨é‡‡ç”¨ä¸¥æ ¼ä¸¤é˜¶æ®µé”çš„ç­–ç•¥ï¼Œæ­¤æ¬¡äº‹åŠ¡ä¼šä¸€ç›´æŒæœ‰è¯»é”ï¼Œä»è€Œä¸­é€”ä¸å¯èƒ½è¢«å…¶ä»–çš„äº‹åŠ¡é‡æ–°å†™å…¥æ›´æ–°ï¼Œåœ¨ä¸€æ¬¡äº‹åŠ¡å½“ä¸­è¯»å–çš„æ•°æ®å…¨éƒ¨ä¸ºä¸€è‡´çš„ã€‚\nshrinkingé˜¶æ®µä¸å…è®¸æ·»åŠ ä»»ä½•çš„é”ï¼Œé‡Šæ”¾S Xé”å°±ä¼šå‘shrinkingè¿›è¡Œè½¬å˜ã€‚\nå¯ä¸²è¡ŒåŒ–\næœ€ä¸¥æ ¼çš„éš”ç¦»çº§åˆ«ï¼Œç®€å•æ¥è¯´å°±æ˜¯åœ¨è¯¥éš”ç¦»çº§åˆ«ä¸‹ï¼Œäº‹åŠ¡çš„æ‰§è¡Œå¯ä»¥ç­‰ä»·æˆä¸€æ¬¡ä¸å­˜åœ¨å¹¶å‘çš„ä¸²è¡Œæ‰§è¡Œã€‚æœ€ç®€å•çš„åˆ¤æ–­æ˜¯å¦ä¸ºå¯ä¸²è¡ŒåŒ–çš„æ–¹æ³•å°±æ˜¯äº¤æ¢ä¸€ç³»åˆ—ä¸å†²çªçš„æŒ‡ä»¤ï¼Œä»è€Œçœ‹åŸæœ¬çš„äº‹åŠ¡è°ƒåº¦æ˜¯å¦å¯ä»¥è¢«åˆ†ä¸ºä¸¤ä¸ªåœ¨æ—¶é—´ä¸Šå®Œå…¨é”™å¼€çš„ä¸²è¡Œè°ƒåº¦ï¼Œç®€å•ç”¨è¯»å†™æ¥è¡¨ç¤ºï¼Œä¸€æ¬¡é€šè¿‡äº¤æ¢æˆ–é‡æ‹è½¬æ¢æˆä¸²è¡Œç»“æœå¦‚ä¸‹ï¼š\nåœ¨15-445å½“ä¸­æ²¡æœ‰å®ç°è¯¥éš”ç¦»çº§åˆ«ï¼Œä¸è¿‡åœ¨6.830å½“ä¸­å®ç°è¿‡ï¼Œå°±ç®€å•è¯´ä¸€ä¸‹6.830çš„å®ç°æ–¹å¼\nå…¶ç›¸æ¯”äºREPEATABLE READï¼Œé¿å…çš„å¹»è¯»çš„å‘ç”Ÿï¼Œæœ€ç®€å•çš„å®ç°æ‰‹æ®µæ˜¯åŠ è¡¨çº§åˆ«çš„é”ï¼Œä»è€Œä¿è¯åœ¨è¯»çš„æ—¶å€™æ²¡æœ‰å…¶ä»–çš„äº‹åŠ¡èƒ½å¤Ÿæ’å…¥æ–°çš„æ•°æ®ï¼Œè¿™æ ·è™½ç„¶å¯ä»¥ä¿è¯å„ä¸ªæ–¹é¢çš„å®‰å…¨ï¼Œè„è¯» ä¸å¯é‡å¤è¯» å¹»è¯»å…¨éƒ¨è§£å†³ï¼Œä½†æ˜¯å¸¦æ¥çš„é—®é¢˜å°±æ˜¯å¹¶å‘åº¦å¾ˆä½ï¼Œå¦‚æœä¸€å¼ è¡¨ä¸Šå­˜åœ¨å†™å…¥çš„äº‹åŠ¡ï¼Œé‚£ä¹ˆå°±æ²¡æœ‰å¹¶å‘åº¦äº†ã€‚\nå¦‚ä½•åˆ¤æ–­äº‹åŠ¡ä¹‹é—´ä¸ºå¯ä¸²è¡ŒåŒ– æœ€ç®€å•çš„æ–¹å¼å³ä¸ºåƒä¸Šé¢é‚£æ ·å»äº¤æ¢ä¸¤æ¡ä¸å†²çªçš„æŒ‡ä»¤ï¼Œå¦‚æœèƒ½å¤Ÿé€šè¿‡äº¤æ¢çš„å½¢å¼æŠŠä¸¤ä¸ªäº‹åŠ¡çš„æŒ‡ä»¤åœ¨æ—¶é—´é¡ºåºä¸Šå®Œå…¨éš”å¼€ï¼Œé‚£ä¹ˆå°±æ˜¯æ»¡è¶³å¯ä¸²è¡ŒåŒ–çš„ã€‚\næ­¤å¤–è¿˜æœ‰ä¸€ç§æ–¹æ³•æ˜¯ï¼Œå¯¹äºå­˜åœ¨å†²çªçš„ä¸¤ä¸ªæŒ‡ä»¤ï¼Œå»ºç«‹ä¸€æ¡è¾¹ï¼Œä»æ—¶é—´è¾ƒæ—©çš„æŒ‡å‘æ—¶é—´è¾ƒæ™šçš„ï¼Œå¦‚æœåœ¨ä¹‹é—´å‡ºç°äº†ç¯ï¼Œé‚£ä¹ˆå°±æ˜¯ä¸å¯ä¸²è¡ŒåŒ–è°ƒåº¦çš„\nå¹¶å‘æ§åˆ¶æ‰‹æ®µéƒ½æœ‰å“ªäº› å¹¶å‘æ§åˆ¶åè®®æ˜¯DBMSå¦‚ä½•å†³å®šåœ¨å¤šäº‹åŠ¡æ—¶çš„æ­£ç¡®äº¤å‰æ‰§è¡Œ\næ‚²è§‚é”ï¼šæ‚²è§‚é”ï¼šå¯¹äºåŒä¸€ä¸ªæ•°æ®çš„å¹¶å‘æ“ä½œï¼Œæ‚²è§‚é”è®¤ä¸ºè‡ªå·±åœ¨ä½¿ç”¨æ•°æ®çš„æ—¶å€™ä¸€å®šæœ‰åˆ«çš„çº¿ç¨‹æ¥ä¿®æ”¹æ•°æ®ï¼Œå› æ­¤åœ¨è·å–æ•°æ®çš„æ—¶å€™ä¼šå…ˆåŠ é”ï¼Œç¡®ä¿æ•°æ®ä¸ä¼šè¢«åˆ«çš„çº¿ç¨‹ä¿®æ”¹ã€‚Javaä¸­ï¼Œsynchronizedå…³é”®å­—å’ŒLockçš„å®ç°ç±»éƒ½æ˜¯æ‚²è§‚é”ã€‚è€Œåœ¨MySQLå½“ä¸­ï¼Œæ’ä»–é”å³ä¸ºæ‚²è§‚é” ä¹è§‚é”ï¼šä¹è§‚é”è®¤ä¸ºè‡ªå·±åœ¨ä½¿ç”¨æ•°æ®æ—¶ä¸ä¼šæœ‰åˆ«çš„çº¿ç¨‹ä¿®æ”¹æ•°æ®ï¼Œå‡è®¾å¹¶å‘å†²çªå¾ˆç½•è§ï¼Œæ‰€ä»¥ä¸ä¼šæ·»åŠ é”ï¼Œåªæ˜¯åœ¨æ›´æ–°æ•°æ®çš„æ—¶å€™å»åˆ¤æ–­ä¹‹å‰æœ‰æ²¡æœ‰åˆ«çš„çº¿ç¨‹æ›´æ–°äº†è¿™ä¸ªæ•°æ®ï¼ˆå…·ä½“æ–¹æ³•å¯ä»¥ä½¿ç”¨ç‰ˆæœ¬å·æœºåˆ¶å’ŒCASç®—æ³•ï¼‰ã€‚å¦‚æœè¿™ä¸ªæ•°æ®æ²¡æœ‰è¢«æ›´æ–°ï¼Œå½“å‰çº¿ç¨‹å°†è‡ªå·±ä¿®æ”¹çš„æ•°æ®æˆåŠŸå†™å…¥ã€‚å¦‚æœæ•°æ®å·²ç»è¢«å…¶ä»–çº¿ç¨‹æ›´æ–°ï¼Œåˆ™æ ¹æ®ä¸åŒçš„å®ç°æ–¹å¼æ‰§è¡Œä¸åŒçš„æ“ä½œï¼šé‡è¯•æˆ–è€…æŠ¥å¼‚å¸¸ã€‚ é”(Lock)å’Œé”å­˜å™¨(Latch)å½“ä¸­æœ‰ä»€ä¹ˆåŒºåˆ« é”çš„æ¦‚å¿µæ›´åŠ å±äºæ•°æ®åº“çš„æŠ½è±¡é€»è¾‘å±‚é¢çš„ï¼Œæ„åœ¨ä¿æŠ¤æ•°æ®åº“çš„é€»è¾‘ç»“æ„ ï¼Œå¦‚tupleæˆ–è€… è¡¨ç­‰\né”å­˜å™¨æ„åœ¨ä¿æŠ¤æ•°æ®åº“çš„ç‰©ç†ç»“æ„ å¦‚çœŸå®çš„æ•°æ®ç»“æ„ç­‰ï¼Œå¦‚ä½¿ç”¨é”å­˜å™¨ä¿è¯buffer poolçš„çº¿ç¨‹å®‰å…¨ï¼Œæ¥è§£å†³ä¸€ä¸ªB+æ ‘çš„å¹¶å‘é—®é¢˜ï¼Œæ‰€è®¨è®ºçš„å°±æ˜¯ä½¿ç”¨é”å­˜å™¨æ¥å¯¹é‚£ä¸ªæ ‘çš„èŠ‚ç‚¹æ¥è¿›è¡ŒåŠ é”ä¿æŠ¤ã€‚å¯¹äºé”å­˜å™¨æ¥è¯´ï¼Œçº¿ç¨‹ä¸ºå…¶çš„ç«äº‰æˆ–è€…æŒæœ‰è€…ï¼Œè€Œé”åˆ™æ˜¯ä»¥äº‹åŠ¡ä¸ºå•ä½\nä»‹ç»ä¸€ä¸‹ä¸¤é˜¶æ®µé”åè®® è€ƒè™‘è¿™æ ·ä¸€ç§æƒ…å†µï¼Œä¸€ä¸ªç®€å•çš„é“¶è¡Œè½¬è´¦çš„ä¾‹å­ï¼Œäº‹åŠ¡T1è´Ÿè´£å®Œæˆè½¬è´¦ï¼Œå…¶è·å–é”ä¹‹åä¿®æ”¹äº†Açš„ä½™é¢ï¼Œé‡Šæ”¾é”ï¼Œæ­£å‡†å¤‡è·å–Bçš„é”ä¿®æ”¹Bçš„ä½™é¢æ—¶ï¼Œäº‹åŠ¡T2è·å–åˆ°äº†ABçš„é”ï¼Œè¯»å–æ•°æ®ï¼Œç»“æœè¯»å–åˆ°äº†ä¸€ç§ä¸­é—´æ€ï¼Œè¿åäº†äº‹åŠ¡çš„ä¸€è‡´æ€§ã€‚\nè¿™ç§é—®é¢˜å¯ä»¥é€šè¿‡å¼•å…¥ä¸¤é˜¶æ®µé”åè®®è¿›è¡Œè§£å†³ï¼Œå³å°†åŠ é”å’Œé‡Šæ”¾é”è¿‡ç¨‹åˆ’åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼Œç¬¬ä¸€ä¸ªé˜¶æ®µç§°ä¸ºgrowingï¼Œåªè¿›è¡ŒåŠ é”ï¼Œç¬¬äºŒé˜¶æ®µç§°ä¸ºshrinkingï¼Œåªè¿›è¡Œè§£é”æ“ä½œã€‚\nå¼•å…¥ä¸¤é˜¶æ®µé”åè®®ä¹‹åï¼Œåœ¨çœ‹ä¸Šè¿°é—®é¢˜ï¼ŒT1ä¿®æ”¹å®ŒAä¹‹åä¸é‡Šæ”¾Açš„é”ï¼Œä¹‹åå°è¯•å¯¹Bä¸Šé”ï¼Œæ­¤æ—¶å‡ºç°ä¸¤ç§æƒ…å†µï¼Œå¦‚æœT2è¿˜æœªå¯¹Bä¸Šé”ï¼Œé‚£ä¹ˆé¡ºåˆ©æ‰§è¡Œï¼Œä¸ä¼šè¿åä¸€è‡´æ€§ï¼Œè€Œå¦‚æœBä¸Šé”ï¼Œé‚£ä¹ˆå°±ä¼šé€ æˆæ­»é”ï¼Œéœ€è¦é€šè¿‡æ­»é”æ£€æµ‹æ¥è¿›è¡Œè§£å†³\nä¸¤é˜¶æ®µé”åè®®ä¼šå¼•å…¥ä»€ä¹ˆé—®é¢˜ï¼Ÿ è¿˜æ˜¯ä»¥é“¶è¡Œè½¬è´¦ä¸ºä¾‹ï¼ŒT1é¦–å…ˆå®Œæˆå¯¹Aå’ŒBçš„æ›´æ–°ï¼Œæ›´æ–°åçš„æ•°æ®ä¸ºA1B1ä¹‹åè¿›å…¥shrinkingé˜¶æ®µï¼Œé‡Šæ”¾äº†ABçš„é”ï¼Œæ­¤æ—¶äº‹åŠ¡T2åœ¨A1B1çš„åŸºç¡€ä¸Šè¿›è¡Œä¿®æ”¹ï¼Œäº§ç”Ÿå‰¯æœ¬A2B2ï¼Œä½†æ˜¯ä¹‹åï¼Œäº‹åŠ¡T1ç”±äºæŸäº›é—®é¢˜éœ€è¦ä¸­æ­¢è¿›è¡Œå›æ»šï¼Œå…¶äº§ç”Ÿçš„æ•°æ®A1B1å°±æˆäº†è„æ•°æ®ï¼Œä»è€Œåœ¨åŸºç¡€ä¸Šè¿›è¡Œä¿®æ”¹çš„A2B2ä¹ŸåŒæ ·æ— æ•ˆï¼Œåº”å½“å›æ»šï¼Œè¿™å°±äº§ç”Ÿäº†çº§è”ä¸­æ­¢ï¼Œå³ä¸€ä¸ªäº‹åŠ¡çš„ä¸­æ­¢å¯¼è‡´äº†å…¶ä»–äº‹åŠ¡çš„ä¸­æ­¢\næ­¤å¤–ï¼Œå°±åƒä¸Šé¢çš„ä¾‹å­é‚£æ ·ï¼Œä¸¤é˜¶æ®µé”åè®®åŒæ ·è¿˜ä¼šå¼•å…¥æ­»é”çš„é—®é¢˜ã€‚\nçº§è”ä¸­æ­¢æœ‰ä»€ä¹ˆè§£å†³æ–¹æ¡ˆï¼Ÿ ä¸€ç§è§£å†³æ–¹æ¡ˆä¸ºå°†ä¸¤é˜¶æ®µé”åè®®å‡çº§ä¸ºä¸¥æ ¼ä¸¤é˜¶æ®µé”åè®®ï¼Œå³growingé˜¶æ®µä¸å˜ï¼Œè€Œshrinkingé˜¶æ®µæ”¹å˜ä¸ºåªæœ‰äº‹åŠ¡æäº¤æ—¶æ‰èƒ½å¤Ÿé‡Šæ”¾é”ï¼Œè€Œåœ¨ä¸Šè¿°çš„ä¾‹å­å½“ä¸­ï¼Œäº‹åŠ¡T2å°±æ— æ³•åœ¨T1çš„åŸºç¡€ä¸Šè¿›è¡Œä¿®æ”¹å¾—åˆ°A2B2ï¼Œåªä¼šè¯»å–åˆ°T1æäº¤æˆ–è€…ä¸­æ­¢åçš„ç»“æœï¼Œä»è€Œé¿å…çš„çº§è”ä¸­æ­¢\næ­»é”çš„äº§ç”Ÿæ¡ä»¶ ç§»æ­¥OS\næ­»é”çš„è§£å†³æ¡ä»¶ ä¸»è¦æœ‰ç ´é™¤å’Œé¢„é˜²ä¸¤ä¸ªæ–¹æ¡ˆæ¥è§£å†³æ­»é”é—®é¢˜\nç ´é™¤ï¼šæœ€ç®€å•çš„æ–¹å¼å³ä¸ºè¶…æ—¶ç­‰å¾…ï¼Œåœ¨è·å–é”æ˜¯é€šè¿‡ä¸€ä¸ªè‡ªæ—‹é”çš„æ–¹å¼ï¼Œåœ¨è‡ªæ—‹å½“ä¸­è¿›è¡Œæ£€æŸ¥ï¼Œå¦‚æœè¶…å‡ºäº†è§„å®šçš„æ—¶é—´å°±æ”¾å¼ƒè·å–é”ï¼Œå¹¶å°†äº‹åŠ¡ä¸­æ­¢ã€‚\næ­¤å¤–ï¼Œè¿˜å¯ä»¥é€šè¿‡æ„å»ºç­‰å¾…å›¾ + DFSçš„å½¢å¼æ¥è¿›è¡Œè§£å†³ï¼Œå³å¦‚æœä¸€ä¸ªäº‹åŠ¡åœ¨ç­‰å¾…å¦å¤–ä¸€ä¸ªäº‹åŠ¡ä¸Šçš„é”æ—¶ï¼Œå°±æ·»åŠ ä¸€æ¡è¾¹ï¼Œä»ç­‰å¾…è€…æŒ‡å‘èµ„æºæŒæœ‰è€…ï¼Œä¹‹åé€šè¿‡DFSçš„æ–¹å¼è¿›è¡Œæœç´¢ï¼Œè€Œå¦‚æœåœ¨ç­‰å¾…å›¾å½“ä¸­å‡ºç°äº†ç¯ï¼Œé‚£ä¹ˆå°±è¯æ˜å‡ºç°äº†æ­»é”ï¼Œæ­¤æ—¶éœ€è¦æŒ‘é€‰ä¸€ä¸ªå—å®³è€…(victim)ï¼Œå°†å…¶æŒæœ‰çš„é”é‡Šæ”¾ï¼Œå¹¶ä¸”å¯¹äº‹åŠ¡è¿›è¡Œå›æ»š\nå¯¹äºæ­»é”çš„å¤„ç†ï¼Œå¯ä»¥é€šè¿‡é”çš„åˆç†åˆ†é…ï¼Œæ¥è¾¾åˆ°æå‰é¿å…ï¼Œé¦–å…ˆå‡è®¾æ—¶é—´è¾ƒä¹…çš„æ—¶é—´æˆ³çš„äº‹åŠ¡æ‹¥æœ‰è¾ƒé«˜çš„ä¼˜å…ˆçº§ï¼Œåˆ™é€šå¸¸æœ‰ä»¥ä¸‹ä¸¤ç§ç­–ç•¥ï¼š\nWait-Dieï¼ˆold waits for youngï¼‰\nå¦‚æœç”³è¯·é”çš„æ¯”ç°åœ¨æŒæœ‰é”çš„æ‹¥æœ‰æ›´é«˜çš„ä¼˜å…ˆçº§ï¼Œé‚£ä¹ˆç”³è¯·é”çš„ç»§ç»­ç­‰å¾…ï¼Œç›´åˆ°æŒæœ‰é”çš„é‡Šæ”¾é” å…¶ä»–æƒ…å†µç”³è¯·çš„äº‹åŠ¡æ”¾å¼ƒï¼ˆ abortsï¼‰ Wound-Wait(young wait for old)\nå¦‚æœç”³è¯·é”çš„æ¯”ç°åœ¨æŒæœ‰é”çš„æ‹¥æœ‰æ›´é«˜çš„ä¼˜å…ˆçº§ï¼Œé‚£ä¹ˆæŒæœ‰é”çš„æ”¾å¼ƒï¼ˆabortsï¼‰ï¼Œç„¶åé‡Šæ”¾é” å…¶ä»–æƒ…å†µç”³è¯·é”çš„ç­‰å¾… åœ¨æ­»é”ç ´é™¤å½“ä¸­å¦‚ä½•é€‰æ‹©Victim ç‰ºç‰²è€…çš„é€‰å–é€šå¸¸ç”±ä¸€ä¸‹å‡ ä¸ªå› ç´ è¿›è¡Œç»¼åˆè€ƒè™‘ï¼š\nå¹´é¾„ï¼Œå³äº‹åŠ¡åˆ›å»ºçš„æ—¶é—´æˆ³ ä»»åŠ¡ï¼Œæ¯”å¦‚å¦‚æœä¸€ä¸ªäº‹åŠ¡éœ€è¦æ‰§è¡Œå¤§é‡çš„æŸ¥è¯¢ï¼Œé‚£ä¹ˆæœ€å¥½æŠŠä»–å½“ä½œç‰ºç‰²è€…ï¼ˆæœ€å¥½ä¸è¦æŠŠä»–å½“ä½œç‰ºç‰²è€…ï¼‰å…·ä½“æ˜¯å¦é€‰å–å–å†³äºä¸åŒçš„æ•°æ®åº“ æŒæœ‰çš„é”çš„æ•°é‡ å›æ»šæ—¶å…³è”çš„å…¶ä»–çš„äº‹åŠ¡çš„å¤šå°‘ï¼ˆçº§è”ç»ˆæ­¢ï¼‰å¼ºé™åˆ¶ä¸¤é˜¶æ®µé”å¹¶ä¸æ˜¯å¿…é¡»çš„ï¼Œæœ‰çš„ç³»ç»Ÿé‡‡ç”¨æ™®é€šçš„ä¸¤é˜¶æ®µé”åè®®ï¼Œé”å®šç„¶åçº§è”ä¸­æ­¢çš„å¤„ç†æ–¹å¼ æ•°æ®åº“å½“ä¸­å¸¸è§çš„é”çº§åˆ« åœ¨åŸºç¡€çš„è¯»å†™é”æ¨¡å‹ä¸Šï¼Œä¸ºäº†æé«˜å¹¶å‘åº¦ï¼Œåœ¨æ•°æ®åº“å½“ä¸­é€šå¸¸è¿˜æ”¯æŒæ„å‘é”æ¥æé«˜å¹¶å‘åº¦å’Œä¾¿äºé”çš„ç®¡ç†\næ„å‘é”æ˜¯ä¸€ç§ä¸ä¸è¡Œçº§é”å†²çªè¡¨çº§é”ï¼Œå› æ­¤å¯ä»¥ä¸å»æ£€æŸ¥åº•å±‚çš„èŠ‚ç‚¹ï¼ˆtupleï¼‰æ˜¯å¦å­˜åœ¨å†²çªå°±å»å¯¹æ›´é«˜ä¸€çº§åˆ«çš„èŠ‚ç‚¹å»åŠ é”ï¼ˆTableï¼‰å³è¡¨æ˜æˆ‘å¯¹è¿™å¼ è¡¨çš„æŸäº›è¡Œæœ‰è¯»å–æˆ–è€…å†™å…¥çš„æ„å‘\nå…±äº«æ„å‘æ’ä»–é”ï¼ˆShared Intention Exclusive Lockï¼‰ï¼š= S-LOCK + IX-LOCKï¼ŒS-LOCKè¿™ä¸€å±æ€§è¡¨æ˜è¦å»è¯»å–è¡¨çš„æ‰€æœ‰çš„è®°å½•ï¼Œå…¶ä»–çš„äº‹åŠ¡å°±ä¸ä¼šå¹¶å‘çš„æ›´æ–°ä»»æ„çš„è®°å½•ï¼ŒIX-LOCKè®©å…¶ä»–äº‹åŠ¡çŸ¥é“æˆ‘ä»¬è¦æ›´æ–°ç›®æ ‡è¡¨çš„ä¸€éƒ¨åˆ†è®°å½•ï¼Œå…¶ä»–äº‹åŠ¡å°±ä¸ä¼šå¹¶å‘çš„è¯»å–æ‰€æœ‰çš„è®°å½•ï¼Œè¿™é‡Œåªä¼šé˜»æ­¢å¯¹è¡¨çš„æ•´ä½“çš„æ“ä½œï¼Œå¦‚SeqScan(è¡¨çº§Sé”)ï¼Œå’Œå…¨è¡¨æ›´æ–°(è¡¨çº§Xé”)ï¼Œå¯¹äºéƒ¨åˆ†æ›´æ–°ï¼Œåˆ™åœ¨è¡¨çº§åˆ«ä¸Šæ·»åŠ IXé”ï¼Œä¸ä¼šå’ŒSIXå‘ç”Ÿå†²çªï¼Œä¸€å®šç¨‹åº¦æé«˜å¹¶å‘åº¦\nè€Œåœ¨åŠ é”æ—¶ï¼Œé¦–å…ˆéœ€è¦å¯¹è¡¨çº§åˆ«åŠ æ„å‘é”ï¼Œå¦‚IS IX SIXï¼Œä¹‹åå†å¯¹è¡Œçº§åˆ«åŠ è¯»å†™é” S Xï¼Œåœ¨åŠ é”æ—¶é¦–å…ˆéœ€è¦æ£€æŸ¥åœ¨Tableä¸Šæ˜¯å¦å‘ç”Ÿå†²çªï¼Œå¦‚æœå‘ç”Ÿå†²çªåˆ™ç›´æ¥é˜»å¡ï¼Œå½“è·å–åˆ°Tableä¸Šçš„é”ä¹‹åï¼Œå†åˆ¤æ–­rowæ˜¯å¦å­˜åœ¨å†²çªï¼Œè€Œåœ¨é‡Šæ”¾é”æ—¶ï¼Œè¡Œé”å¯ä»¥æŒ‰éœ€é‡Šæ”¾ï¼Œè¡¨é”éœ€è¦ä¿è¯åœ¨è¡Œé”å…¨éƒ¨é‡Šæ”¾å®Œæ¯•åæ‰èƒ½é‡Šæ”¾\nè¯´ä¸€è¯´æ—¶é—´æˆ³æ’åºå¹¶å‘æ§åˆ¶ å…ˆä»‹ç»ä¸€ä¸‹åŸºæœ¬æ—¶é—´æˆ³é¡ºåºåè®®\né¦–å…ˆé€šè¿‡æ—¶é—´æˆ³æ¥å¯¹äº‹åŠ¡è¿›è¡Œæ ‡è®°ï¼ŒåŒæ—¶å¯¹äºä¸€ä¸ªtuple éœ€è¦è®°å½•å…¶ W-TSå’ŒR-TSï¼Œå³æœ€åä¸€æ¬¡å¯¹å…¶è¿›è¡Œè¯»å†™æ“ä½œçš„äº‹åŠ¡çš„æ—¶é—´æˆ³ï¼Œç”¨äºåœ¨ä¸€ä¸ªäº‹åŠ¡è¦å¯¹ä¸€ä¸ªtupleè¿›è¡Œè¯»å†™æ“ä½œæ—¶åˆ¤æ–­æ˜¯å¦æœ‰å…¶ä»–äº‹åŠ¡ä¼šå’Œå®ƒäº§ç”Ÿå†²çª\nåœ¨åŸºæœ¬æ—¶é—´æˆ³é¡ºåºåè®®ä¸­ï¼Œæ—¶é—´æˆ³è®°å½•çš„æ˜¯è¯¥äº‹åŠ¡å¼€å§‹æ—¶çš„æ—¶é—´ï¼Œå³é€šè¿‡BEGINå…³é”®å­—å£°æ˜å¼€å¯äº‹åŠ¡æ—¶æ—§åˆ†é…ä¸€ä¸ªæ—¶é—´æˆ³ï¼Œä½†æ˜¯DBMSæœ¬èº«è¿˜æ˜¯å¹¶å‘çš„ï¼Œå› æ­¤å¯èƒ½ä¼šå‡ºç°åç»­çš„äº‹åŠ¡åœ¨è¾ƒæ—©çš„äº‹åŠ¡ä¹‹å‰æ‰§è¡Œï¼Œæ­¤æ—¶å°±å¯èƒ½å­˜åœ¨é—®é¢˜ï¼Œå¯èƒ½è¦è€ƒè™‘å°†è¾ƒæ—©çš„äº‹åŠ¡ç»™æ’¤é”€ï¼Œå¹¶é‡æ–°åˆ†é…æ—¶é—´æˆ³é‡æ–°æ‰§è¡Œ\nå½“ä¸€ä¸ªäº‹åŠ¡è®¿é—®åˆ°ä¸€ä¸ªtupleæ—¶ï¼Œå‘ç°TS \u0026lt; W-TS ï¼Œåˆ™è¯æ˜æœªæ¥çš„ä¸€æ¬¡å†™å…¥è¦†ç›–äº†ç›®å‰æ­£åœ¨è¯»çš„æ•°å€¼ï¼Œå³å‡ºç°äº†è„è¯»é—®é¢˜ï¼Œè¯»å–åˆ°çš„æ˜¯æ—§å€¼ï¼Œéœ€è¦ç»ˆæ­¢\nå¯¹äºè¯»å†™ï¼Œæœ‰ä»¥ä¸‹çš„è§„åˆ™ï¼š\nè¯»ï¼š\nå¦‚æœTS($T_i$) \u0026lt; W-TS(X),åˆ™è¿åäº†æ—¶é—´æˆ³é¡ºåºï¼Œè¯»åˆ°äº†æ—§çš„å€¼ï¼Œè¯¥äº‹åŠ¡éœ€è¦é‡å¯å¹¶åˆ†é…æ–°çš„æ—¶é—´æˆ³\nå¦åˆ™ï¼š\nå…è®¸äº‹åŠ¡Tå»è¯»å–tuple X æ›´æ–°R-TSï¼ˆXï¼‰ä¸º$max(R-TS(X),TS(T_i))$ ç”Ÿæˆä¸€ä¸ªæœ¬åœ°å‰¯æœ¬ç”¨äºè¯¥äº‹åŠ¡åç»­çš„é‡å¤è¯»ï¼ˆå¦‚æœå†å»è¯»æœ€æ–°çš„æ•°æ®åˆ™ä¼šäº§ç”Ÿä¸¤æ¬¡è¯»å–ä¸ä¸€è‡´çš„ä¸å¯é‡å¤è¯»çš„é—®é¢˜ï¼‰ å†™ï¼š\nå¦‚æœ$TS(T_i)\u0026lt;R-TS(X) or TS(T_i) \u0026lt; W-TS(X)$ æ”¾å¼ƒ$T_i$å¹¶é‡å¯$T_i$\n$TS(T_i)\u0026lt;R-TS(X)$ä¼šå¯¼è‡´åç»­è¯»å–æ“ä½œè¯»å–ä¸åˆ°æ­¤æ¬¡çš„å†™å…¥ $TS(T_i) \u0026lt; W-TS(X)$ä¼šå¯¼è‡´æ­¤æ¬¡çš„å†™å…¥æ— æ„ä¹‰ å¦åˆ™ï¼š\nå…è®¸äº‹åŠ¡$T_i$å»å†™å…¥ï¼Œå¹¶ä¸”æ›´æ–°W-TS(X) ç”Ÿæˆä¸€ä¸ªæœ¬åœ°å‰¯æœ¬ç”¨äºå¯é‡å¤è¯» å¯¹äºå†™æ“ä½œï¼Œè¿˜å¯ä»¥é€šè¿‡Thomas Write Ruleè¿›è¡Œä¼˜åŒ–ï¼š\n$TS(T_i) \u0026lt;R-TS(X)$:æ”¾å¼ƒå¹¶é‡å¯$T_i$ï¼ˆä¸åŸæœ¬ä¸€è‡´ï¼‰ $TS(T_i) \u0026lt;W-TS(X)$:å¿½ç•¥æ­¤æ¬¡å†™å…¥ï¼Œå¹¶å…è®¸äº‹åŠ¡ç»§ç»­æ‰§è¡Œ å…¶ä»–æƒ…å†µåˆ™æœªè¿ååè®®ï¼Œå…è®¸$T_i$å†™å…¥ï¼Œå¹¶æ›´æ–°$W-TS(X)$ è™½ç„¶æœ¬è´¨ä¸Šè¿åäº†åè®®ï¼Œä½†æ˜¯å½“å‰æ­¤æ¬¡å†™åç»­ä¼šè¢«è¦†ç›–æ‰ï¼Œå› æ­¤å¯ä»¥ç›´æ¥è¿›è¡Œå¿½ç•¥\næ€»çš„æ¥è¯´ï¼ŒåŸºæœ¬æ—¶é—´æˆ³é¡ºåºåè®®çš„ç²¾é«“ä¸ºå½“ä¸€ä¸ªäº‹åŠ¡åˆ›å»ºæ—¶åˆ†é…ä¸€ä¸ªæ—¶é—´æˆ³ï¼Œç”±äºäº‹åŠ¡çš„åŸå­æ€§ï¼Œå°†äº‹åŠ¡å½“ä¸­æ‰€æœ‰çš„æŒ‡ä»¤çš„å‘ç”Ÿæ—¶é—´å…¨éƒ¨é›†ä¸­äºbeginçš„è¿™ä¸€æ—¶é—´æˆ³ä¸Šï¼Œä¹‹åå¦‚æœæœ‰è¿åæ—¶é—´é¡ºåºçš„ï¼Œäº‹åŠ¡åˆ™ä¼šä¸­æ­¢å›æ»šï¼Œå¹¶å°è¯•é‡æ–°å¼€å¯äº‹åŠ¡ï¼Œå¦‚è¯»å–æ—¶å‘ç°æœ‰æœªæ¥çš„äº‹åŠ¡å·²ç»å¯¹å…¶è¿›è¡Œäº†å†™å…¥ã€‚\nè¯´ä¸€è¯´ä¹è§‚å¹¶å‘æ§åˆ¶ åŸºæœ¬æ€æƒ³ä¹Ÿä¸ºå°†äº‹åŠ¡çš„æ‰€æœ‰æŒ‡ä»¤å…¨éƒ¨è§†ä¸ºåœ¨ä¸€ä¸ªæ—¶é—´ç‚¹ä¸Šå‘ç”Ÿ\nDBMSç»™æ¯ä¸ªäº‹åŠ¡å‡åˆ†é…ä¸€ä¸ªç§æœ‰çš„å·¥ä½œç©ºé—´ï¼š\nè¿›è¡Œè¯»æ“ä½œæ—¶å°†è¯»çš„ç»“æœcopyåˆ°ç§æœ‰çš„å·¥ä½œç©ºé—´å½“ä¸­ ä¿®æ”¹æ“ä½œåˆ™é’ˆå¯¹äºå·¥ä½œç©ºé—´æ¥è¿›è¡Œä¿®æ”¹ å½“ä¸€ä¸ªäº‹åŠ¡å‡†å¤‡æäº¤æ—¶ï¼Œå†å°†å·¥ä½œç©ºé—´å’Œå…¨å±€Databaseè¿›è¡Œæ¯”è¾ƒï¼ŒæŸ¥çœ‹æ˜¯å¦å­˜åœ¨å†²çªï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºValidation\nå¦‚æœä¸å­˜åœ¨å†²çªï¼Œåˆ™å°†å·¥ä½œç©ºé—´çš„ç»“æœåº”ç”¨åˆ°å…¨å±€Databaseå½“ä¸­\né˜¶æ®µ\nRead Phaseï¼šå½“äº‹åŠ¡è¿›è¡Œè¯»å†™æ“ä½œæ—¶ï¼Œå°†æ‰€æœ‰è®¿é—®åˆ°çš„æ•°æ®ï¼ˆtupleï¼‰è¯»å–åˆ°ç§æœ‰çš„å·¥ä½œç©ºé—´åï¼Œå†å·¥ä½œç©ºé—´ä¸Šè¿›è¡Œæ“ä½œ Validation Phaseï¼šåœ¨äº‹åŠ¡commitå‰éªŒè¯æ˜¯å¦å’Œå…¶ä»–äº‹åŠ¡å­˜åœ¨å†²çª Write Phaseï¼šå¦‚æœä¸å­˜åœ¨å†²çªï¼Œåˆ™å°†ç§æœ‰å·¥ä½œç©ºé—´çš„åšçš„æ›´æ”¹åº”ç”¨åˆ°å…¨å±€æ•°æ®åº“ä¸Šï¼Œå¦åˆ™æ”¾å¼ƒå¹¶é‡å¯äº‹åŠ¡ åœ¨è¿˜æœªè¿›è¡Œvalidateæ—¶ï¼Œå‰¯æœ¬çš„æ—¶é—´æˆ³è®¾ç½®ä¸ºâˆï¼Œå¦‚æœè¿›è¡Œäº†å†™æ“ä½œï¼Œé‚£ä¹ˆæ­¤æ—¶ç§æœ‰ç©ºé—´ä¸­W-TSå³ä¸ºâˆ\nåœ¨éªŒè¯èŠ‚ç‚¹æ‰ä¼šè·å–ä¸€ä¸ªæ—¶é—´æˆ³ï¼Œå› æ­¤å°†éªŒè¯çš„æ—¶é—´æ“ä½œè§†ä¸ºäº‹åŠ¡çœŸæ­£çš„å¼€å§‹æ—¶é—´ï¼ŒAå…ˆäºBè¿›è¡ŒéªŒè¯ï¼Œåˆ™è®¤ä¸ºAå…ˆäºBå¼€å¯äº‹åŠ¡\næ‚²è§‚å¹¶å‘æ§åˆ¶å’Œä¹è§‚å¹¶å‘æ§åˆ¶å„è‡ªçš„åº”ç”¨åœºæ™¯ æ¥è‡ªGPT\næ‚²è§‚å¹¶å‘æ§åˆ¶ï¼ˆPessimistic Concurrency Controlï¼Œç®€ç§° PCCï¼‰å’Œä¹è§‚å¹¶å‘æ§åˆ¶ï¼ˆOptimistic Concurrency Controlï¼Œç®€ç§° OCCï¼‰æ˜¯ä¸¤ç§ä¸åŒçš„å¹¶å‘æ§åˆ¶ç­–ç•¥ï¼Œå®ƒä»¬åœ¨ä¸åŒçš„åº”ç”¨åœºæ™¯ä¸‹æœ‰å„è‡ªçš„ä¼˜åŠ¿ã€‚æ‚²è§‚å¹¶å‘æ§åˆ¶é‡‡ç”¨ä¸€ç§æ‚²è§‚çš„æ€æƒ³ï¼Œå³è®¤ä¸ºåœ¨å¤šç”¨æˆ·å¹¶å‘ç¯å¢ƒä¸‹ï¼Œæ•°æ®å†²çªçš„å¯èƒ½æ€§è¾ƒé«˜ã€‚å› æ­¤ï¼Œåœ¨è¯»å†™æ•°æ®æ—¶ä¼šå¯¹æ•°æ®åŠ é”ï¼Œä»¥ç¡®ä¿æ•°æ®çš„ç‹¬å è®¿é—®ã€‚æ‚²è§‚å¹¶å‘æ§åˆ¶é€‚ç”¨äºæ•°æ®ç«äº‰æ¿€çƒˆçš„åœºæ™¯ï¼Œä»¥åŠå‘ç”Ÿå¹¶å‘å†²çªæ—¶ä½¿ç”¨é”ä¿æŠ¤æ•°æ®çš„æˆæœ¬è¦ä½äºå›æ»šäº‹åŠ¡çš„æˆæœ¬çš„ç¯å¢ƒä¸­åœ¨è¿™ç§åœºæ™¯ä¸‹ï¼Œæ‚²è§‚é”å¯ä»¥æœ‰æ•ˆåœ°ä¿æŠ¤æ•°æ®çš„ä¸€è‡´æ€§å’Œå®Œæ•´æ€§ã€‚\nä¹è§‚å¹¶å‘æ§åˆ¶åˆ™é‡‡ç”¨ä¸€ç§ä¹è§‚çš„æ€æƒ³ï¼Œå³è®¤ä¸ºåœ¨å¤šç”¨æˆ·å¹¶å‘ç¯å¢ƒä¸‹ï¼Œæ•°æ®å†²çªçš„å¯èƒ½æ€§è¾ƒä½ã€‚å› æ­¤ï¼Œåœ¨è¯»å†™æ•°æ®æ—¶ä¸ä¼šå¯¹æ•°æ®åŠ é”ï¼Œè€Œæ˜¯åœ¨æäº¤æ•°æ®æ›´æ–°ä¹‹å‰æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–äº‹åŠ¡ä¿®æ”¹äº†æ•°æ®ã€‚å¦‚æœå‘ç°å†²çªï¼Œåˆ™å›æ»šäº‹åŠ¡å¹¶é€šçŸ¥ç”¨æˆ·ï¼Œä¹è§‚å¹¶å‘æ§åˆ¶é€‚ç”¨äºæ•°æ®äº‰ç”¨ä¸å¤§ï¼Œæ•°æ®å†²çªè¾ƒå°‘çš„åœºæ™¯ä¸‹åœ¨è¿™ç§åœºæ™¯ä¸‹ï¼Œä¹è§‚é”å¯ä»¥æé«˜ç³»ç»Ÿçš„æ•´ä½“ååé‡ï¼Œå› ä¸ºå®ƒé¿å…äº†é”çš„å¼€é”€ã€‚æ€»çš„æ¥è¯´ï¼Œä¹è§‚é”é€‚ç”¨äºå†™æ“ä½œè¾ƒå°‘çš„æƒ…å†µä¸‹ï¼ˆå¤šè¯»åœºæ™¯ï¼‰ï¼Œå³å†²çªçœŸçš„å¾ˆå°‘å‘ç”Ÿçš„æ—¶å€™è€Œæ‚²è§‚é”é€‚ç”¨äºå¤šå†™çš„åœºæ™¯ï¼Œå› ä¸ºåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå†²çªè¾ƒå®¹æ˜“å‘ç”Ÿï¼Œä½¿ç”¨æ‚²è§‚é”å¯ä»¥é¿å…ä¸æ–­çš„é‡è¯•æ“ä½œï¼Œä»è€Œæé«˜æ€§èƒ½ã€‚\nè¯´ä¸€è¯´å¹»è¯» å¹»è¯»æ˜¯åœ¨äº‹åŠ¡å¹¶å‘æ‰§è¡Œæ—¶å¯èƒ½å‡ºç°çš„ä¸€ç§ç°è±¡ï¼Œå®ƒæŒ‡çš„æ˜¯åœ¨ä¸€ä¸ªäº‹åŠ¡å†…éƒ¨ï¼Œå¤šæ¬¡æ‰§è¡Œç›¸åŒçš„æŸ¥è¯¢æ“ä½œï¼Œä½†åœ¨ä¸åŒçš„æŸ¥è¯¢ä¸­è¿”å›çš„è¡Œæ•°å´ä¸ä¸€è‡´ã€‚é€šå¸¸æ˜¯ç”±äºå…¶ä»–äº‹åŠ¡å¹¶å‘åœ°æ’å…¥æˆ–åˆ é™¤äº†ç¬¦åˆæŸ¥è¯¢æ¡ä»¶çš„æ•°æ®æ‰€å¯¼è‡´çš„ã€‚\nä¸ºäº†è§£å†³å¹»è¯»é—®é¢˜ï¼Œå¯ä»¥é‡‡å–ä»¥ä¸‹å‡ ç§æ–¹æ¡ˆï¼š\nä½¿ç”¨é—´éš™é”ï¼šåœ¨æŸäº›æ•°æ®åº“ç³»ç»Ÿä¸­ï¼Œå¯ä»¥ä½¿ç”¨é—´éš™é”ï¼ˆGap Lockï¼‰æ¥é”å®šä¸€ä¸ªèŒƒå›´å†…çš„ç©ºé—´ï¼Œä»¥é˜»æ­¢å…¶ä»–äº‹åŠ¡åœ¨è¯¥èŒƒå›´å†…æ’å…¥æ–°çš„æ•°æ®ã€‚è¿™å¯ä»¥æœ‰æ•ˆåœ°è§£å†³å¹»è¯»é—®é¢˜ã€‚ ç‰ˆæœ¬æ§åˆ¶ï¼šä½¿ç”¨ç‰ˆæœ¬å·æˆ–æ—¶é—´æˆ³æ¥è·Ÿè¸ªæ•°æ®çš„å˜åŒ–ã€‚åœ¨è¯»å–æ“ä½œæ—¶ï¼Œæ ¹æ®äº‹åŠ¡å¼€å§‹æ—¶çš„ç‰ˆæœ¬å·æˆ–æ—¶é—´æˆ³æ¥ç¡®å®šè¯»å–çš„æ•°æ®å¿«ç…§ï¼Œä»¥ä¿è¯ä¸€è‡´æ€§ã€‚å¯ä»¥é€šè¿‡MVCCï¼ˆå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼‰ç­‰æœºåˆ¶æ¥å®ç°ã€‚ æå‡éš”ç¦»çº§åˆ«ï¼šå°†éš”ç¦»çº§åˆ«æå‡åˆ°å¯ä¸²è¡ŒåŒ–ï¼ˆSerializableï¼‰çº§åˆ«ã€‚å¯ä¸²è¡ŒåŒ–çº§åˆ«èƒ½å¤Ÿè§£å†³å¹»è¯»é—®é¢˜ï¼Œä½†ä¹Ÿä¼šç‰ºç‰²ä¸€å®šçš„å¹¶å‘æ€§èƒ½ï¼Œå› ä¸ºå®ƒä¼šå¯¹å¹¶å‘æ“ä½œè¿›è¡Œä¸¥æ ¼çš„åºåˆ—åŒ–ã€‚ MVCC æ¥è‡ª GPT\nMVCCï¼ˆMulti-Version Concurrency Controlï¼Œå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼‰æ˜¯ä¸€ç§å¹¶å‘æ§åˆ¶æ–¹æ³•ï¼Œä¸»è¦ç”¨äºæ•°æ®åº“ç®¡ç†ç³»ç»Ÿä¸­å®ç°å¯¹æ•°æ®åº“çš„å¹¶å‘è®¿é—®ï¼Œåœ¨ç¼–ç¨‹è¯­è¨€ä¸­å®ç°äº‹åŠ¡å†…å­˜MVCCé€šè¿‡ä¿å­˜æ•°æ®çš„å†å²ç‰ˆæœ¬ï¼Œæ ¹æ®æ¯”è¾ƒæ•°æ®çš„ç‰ˆæœ¬å·æ¥å†³å®šæ•°æ®çš„æ˜¯å¦æ˜¾ç¤ºï¼Œåœ¨ä¸éœ€è¦åŠ è¯»é”çš„æƒ…å†µå°±èƒ½è¾¾åˆ°äº‹åŠ¡çš„éš”ç¦»æ•ˆæœï¼Œæœ€ç»ˆå¯ä»¥åœ¨è¯»å–æ•°æ®çš„æ—¶å€™å¯ä»¥åŒæ—¶è¿›è¡Œä¿®æ”¹ï¼Œä¿®æ”¹æ•°æ®æ—¶å€™å¯ä»¥åŒæ—¶è¯»å–ï¼Œæå¤§çš„æå‡äº†äº‹åŠ¡çš„å¹¶å‘æ€§èƒ½ã€‚åœ¨InnoDBå­˜å‚¨å¼•æ“ä¸­ï¼ŒMVCCæ˜¯é€šè¿‡åœ¨æ¯è¡Œè®°å½•åé¢ä¿å­˜ä¸¤ä¸ªéšè—çš„åˆ—æ¥å®ç°çš„ã€‚è¿™ä¸¤ä¸ªåˆ—ï¼Œä¸€ä¸ªä¿å­˜äº†è¡Œçš„åˆ›å»ºæ—¶é—´ï¼Œä¸€ä¸ªä¿å­˜äº†è¡Œçš„è¿‡æœŸæ—¶é—´ï¼ˆæˆ–åˆ é™¤æ—¶é—´ï¼‰ï¼Œå½“ç„¶å­˜å‚¨çš„å¹¶ä¸æ˜¯å®é™…çš„æ—¶é—´å€¼ï¼Œè€Œæ˜¯ç³»ç»Ÿç‰ˆæœ¬å·ã€‚æ¯å¼€å§‹ä¸€ä¸ªæ–°çš„äº‹åŠ¡ï¼Œç³»ç»Ÿç‰ˆæœ¬å·éƒ½ä¼šè‡ªåŠ¨é€’å¢ã€‚äº‹åŠ¡å¼€å§‹æ—¶åˆ»çš„ç³»ç»Ÿç‰ˆæœ¬å·ä¼šä½œä¸ºäº‹åŠ¡çš„ç‰ˆæœ¬å·ï¼Œç”¨æ¥å’ŒæŸ¥è¯¢åˆ°çš„æ¯è¡Œè®°å½•çš„ç‰ˆæœ¬å·è¿›è¡Œæ¯”è¾ƒã€‚MVCCçš„ä¼˜ç‚¹åŒ…æ‹¬ï¼š1. æ”¯æŒå¹¶å‘è¯»å–ï¼šå¤šä¸ªäº‹åŠ¡å¯ä»¥åŒæ—¶è¯»å–æ•°æ®åº“ä¸­çš„æ•°æ®ï¼Œæé«˜äº†å¹¶å‘æ€§èƒ½ã€‚\né¿å…äº†é”ç«äº‰ï¼šåœ¨è¯»å–è¿‡ç¨‹ä¸­ï¼Œä¸éœ€è¦å¯¹è®°å½•è¿›è¡ŒåŠ é”ï¼Œå› æ­¤é¿å…äº†é”ç«äº‰çš„æƒ…å†µï¼Œæé«˜äº†å¹¶å‘æ€§èƒ½ã€‚ ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼šMVCCé€šè¿‡ç‰ˆæœ¬æ§åˆ¶ï¼Œå¯ä»¥ä¿è¯åœ¨å¹¶å‘è¯»å–çš„æƒ…å†µä¸‹ï¼Œæ•°æ®çš„ä¸€è‡´æ€§ã€‚ ç„¶è€Œï¼ŒMVCCä¹Ÿå­˜åœ¨ä¸€äº›å±€é™æ€§ï¼š1. å¢åŠ å­˜å‚¨ç©ºé—´ï¼šä¸ºäº†å®ç°ç‰ˆæœ¬æ§åˆ¶ï¼ŒMVCCåœ¨æ¯æ¡è®°å½•ä¸Šéƒ½éœ€è¦æ·»åŠ æ—¶é—´æˆ³ï¼Œå› æ­¤ä¼šå¢åŠ å­˜å‚¨ç©ºé—´ã€‚\næ— æ³•è§£å†³å¹»è¯»é—®é¢˜ï¼šè™½ç„¶MVCCé€šè¿‡ç‰ˆæœ¬æ§åˆ¶å¯ä»¥é¿å…é”ç«äº‰ï¼Œä½†æ˜¯åœ¨ä¸€äº›æƒ…å†µä¸‹ï¼Œä»ç„¶ä¼šå‡ºç°å¹»è¯»çš„é—®é¢˜ æ— æ³•å®ç°ä¸€äº›é”çš„åŠŸèƒ½ï¼šä¾‹å¦‚ SELECT \u0026hellip; FOR UPDATEã€SELECT \u0026hellip; LOCK IN SHARE MODE ç­‰é”çš„åŠŸèƒ½ï¼Œæ— æ³•åœ¨ MVCC ä¸­å®ç°ã€‚ æ€»ä¹‹ï¼ŒMVCCæ˜¯ä¸€ç§åŸºäºç‰ˆæœ¬æ§åˆ¶çš„å¹¶å‘æ§åˆ¶æœºåˆ¶ï¼Œé€šè¿‡ç‰ˆæœ¬æ§åˆ¶å’Œæ—¶é—´æˆ³æ¯”è¾ƒæ¥ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§å’Œå¹¶å‘æ€§èƒ½ï¼Œä½†ä¹Ÿå­˜åœ¨ä¸€äº›å±€é™æ€§ã€‚åœ¨æ•°æ®åº“ä¸­ï¼Œå¯ä»¥é‡‡ç”¨MVCCä¸æ‚²è§‚é”æˆ–ä¹è§‚é”çš„ç»„åˆæ–¹å¼æ¥æœ€å¤§ç¨‹åº¦åœ°æé«˜æ•°æ®åº“å¹¶å‘æ€§èƒ½ï¼Œå¹¶è§£å†³è¯»å†™å†²çªå’Œå†™å†™å†²çªå¯¼è‡´çš„é—®é¢˜ã€‚\nMVCCä¸ PCCå’Œ OCCä¹‹é—´æœ‰ä»€ä¹ˆè”ç³» MVCCä¸»è¦è§£å†³äº†ä»¥ä¸‹é—®é¢˜ï¼š1. è¯»å†™ä¹‹é—´çš„é˜»å¡é—®é¢˜ï¼šé€šè¿‡MVCCå¯ä»¥è®©è¯»å†™äº’ç›¸ä¸é˜»å¡ï¼Œå³è¯»ä¸é˜»å¡å†™ï¼Œå†™ä¸é˜»å¡è¯»ï¼Œä»è€Œæå‡äº‹åŠ¡å¹¶å‘å¤„ç†èƒ½åŠ›\né™ä½æ­»é”çš„æ¦‚ç‡ï¼šå› ä¸ºInnoDBçš„MVCCé‡‡ç”¨äº†ä¹è§‚é”çš„æ–¹å¼ï¼Œè¯»å–æ•°æ®æ—¶å¹¶ä¸éœ€è¦åŠ é”ï¼Œå¯¹äºå†™æ“ä½œï¼Œä¹Ÿåªé”å®šå¿…è¦çš„è¡Œ MVCCå¯ä»¥è§£å†³è¯»-å†™å†²çªï¼Œä½†ä¸èƒ½è§£å†³å†™-å†™å†²çªä¸ºäº†è§£å†³å†™-å†™å†²çªï¼Œå¯ä»¥å°†MVCCä¸å…¶ä»–å¹¶å‘æ§åˆ¶æ–¹æ³•ç»“åˆä½¿ç”¨ï¼Œä¾‹å¦‚ï¼š\nMVCC + æ‚²è§‚é”ï¼šMVCCè§£å†³è¯»å†™å†²çªï¼Œæ‚²è§‚é”è§£å†³å†™å†™å†²çª\nMVCC + ä¹è§‚é”ï¼šMVCCè§£å†³è¯»å†™å†²çªï¼Œä¹è§‚é”è§£å†³å†™å†™å†²çª\nâ€\n","permalink":"https://fischer0522.github.io/en/posts/tech/%E4%BA%8B%E5%8A%A1%E4%B8%8E%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6/","summary":"äº‹åŠ¡ä¸å¹¶å‘æ§åˆ¶ ç®€å•ä»‹ç»ä¸€ä¸‹äº‹åŠ¡ï¼Ÿ äº‹åŠ¡ä½œä¸ºæ•°æ®åº“æ‰§è¡Œè¿‡ç¨‹ä¸­çš„ä¸€ä¸ªé€»è¾‘å•ä½ï¼Œå¯ä»¥è¡¨æ˜ä¸€ç»„æ“ä½œï¼Œè¿™ä¸€ç»„æ“ä½œè¦ä¹ˆä¸€èµ·æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å›æ»šï¼Œå¹¶ä¸”äº‹åŠ¡ä¹‹é—´","title":"äº‹åŠ¡ä¸å¹¶å‘æ§åˆ¶"},{"content":"æ•°æ®åº“åŸºç¡€ç»“æ„ æ•°æ®åº“ç»“æ„ ä¸ºä»€ä¹ˆéœ€è¦DBMSï¼Ÿ ä¸€ä¸ªæ•°æ®åº“åœ¨æœ€åŸºç¡€çš„å±‚æ¬¡ä¸Šéœ€è¦å®Œæˆä¸¤ä»¶äº‹æƒ…ï¼šå½“ä½ æŠŠæ•°æ®äº¤ç»™æ•°æ®åº“æ—¶ï¼Œå®ƒåº”å½“æŠŠæ•°æ®å­˜å‚¨èµ·æ¥ï¼›è€Œåå½“ä½ å‘æ•°æ®åº“è¦æ•°æ®æ—¶ï¼Œå®ƒåº”å½“æŠŠæ•°æ®è¿”å›ç»™ä½ ã€‚\nå› æ­¤ï¼Œæœ€ç®€å•çš„æ•°æ®åº“å¯ä»¥ä½¿ç”¨ä¸¤æ¡bashè„šæœ¬æ¥å®Œæˆï¼Œåœ¨ddiaå½“ä¸­ä¹Ÿç»™å‡ºäº†ä¾‹å­ï¼š\n1 2 3 4 5 6 7 8 #!/bin/bash db_set () { echo \u0026#34;$1,$2\u0026#34; \u0026gt;\u0026gt; database } db_get () { grep \u0026#34;^$1,\u0026#34; database | sed -e \u0026#34;s/^$1,//\u0026#34; | tail -n 1 } å­˜å‚¨æ—¶ï¼Œåˆ™å¯¹å…¶è¿›è¡Œè¿½åŠ å†™å…¥ï¼Œå°†æ–°æ•°æ®æ·»åŠ åˆ°æ–‡ä»¶çš„æœ«å°¾ï¼Œå› æ­¤å¯¹äºé‡å¤çš„keyï¼Œæ°¸è¿œåœ¨æœ«å°¾ä¸ºæœ€æ–°çš„æ•°æ®ï¼Œå› æ­¤åœ¨è¯»å–æ—¶ï¼Œåˆ™è¯»å–æŒ‡å®škeyçš„æœ€åä¸€ä¸ªæ•°æ®ä½œä¸ºç»“æœã€‚\nä¸å¦¨æ€è€ƒä¸€ä¸‹è¿™ä¸ªæœ€ç®€å•çš„æ•°æ®åº“æœ‰ä»€ä¹ˆåˆå­˜åœ¨ä»€ä¹ˆé—®é¢˜ï¼Œå¯ä»¥å¾—åˆ°æœ€ç»ˆçš„ç­”æ¡ˆ\né¦–å…ˆè¯¥æ•°æ®åº“é‡‡ç”¨çš„ä¸ºåŸºäºæ—¥å¿—ç»“æ„çš„ï¼Œå¯ä»¥æä¾›æŒä¹…åŒ–å­˜å‚¨ï¼Œä½œä¸ºæ•°æ®åº“çš„æœ€åŸºæœ¬åŠŸèƒ½\nä¹‹åç”±äºæ‰€æœ‰æ•°æ®å…¨éƒ¨å­˜å‚¨äºç¡¬ç›˜ä¹‹ä¸Šï¼Œæ¯æ¬¡è¯»å–éƒ½æ¶‰åŠåˆ°è¾ƒé«˜çš„ç£ç›˜IOï¼Œå› æ­¤éœ€è¦é€šè¿‡buffer pool manageræ¥å°†æ•°æ®å­˜å‚¨äºå†…å­˜å½“ä¸­è¿›è¡Œç¼“å­˜ä»¥æé«˜æ€§èƒ½ æ¯æ¬¡è¯»å–éƒ½éœ€è¦éå†æ‰€æœ‰æ•°æ®ï¼Œå¯ä»¥é€šè¿‡æ„å»ºç´¢å¼•è¿›è¡Œä¼˜åŒ–ï¼Œå¦‚bitcaskåœ¨å†…å­˜å½“ä¸­æ„å»ºä¸€ä¸ªhashmapæˆ–è€…æ„å»ºB+æ ‘ åœ¨æœ«å°¾è¿½åŠ ä¼šåœ¨ç£ç›˜å½“ä¸­äº§ç”Ÿå¤§é‡å†—ä½™ï¼Œå› æ­¤éœ€è¦ä¼˜åŒ–å­˜å‚¨ï¼Œæœ€ç®€å•çš„æ–¹å¼ä¸ºé‡‡ç”¨bitcaskè¿›è¡Œå®šæœŸå‹ç¼©ï¼Œæˆ–è€…ç›´æ¥é‡‡ç”¨LSM-Treeç»“æ„è¿›è¡Œå­˜å‚¨ã€‚ä»¥ä¸Šä¸¤ç§ä¸ºé‡‡ç”¨åŸºäºæ—¥å¿—çš„ç»“æ„çš„ï¼Œæ­¤å¤–ï¼Œè¿˜å¯ä»¥é‡‡ç”¨åŸºäºPageçš„HeapPageè¿›è¡Œå­˜å‚¨ å¯¹äºæŸäº›ä¸šåŠ¡ï¼Œéœ€è¦æä¾›äº‹åŠ¡çš„æ”¯æŒï¼Œå³äº‹åŠ¡çš„ACID ä¸ºé˜²æ­¢æ•°æ®ä¸¢å¤±å¹¶ä¸”ä¼˜åŒ–å†™å…¥é€Ÿåº¦ï¼Œå³å°†éšæœºå†™å…¥è½¬æ¢ä¸ºé¡ºåºå†™å…¥ï¼Œå¼•å…¥æ—¥å¿—ç³»ç»Ÿ å¯¹å¤šçº¿ç¨‹çš„è®¿é—®æä¾›æ”¯æŒï¼Œç›¸å…³æ•°æ®ç»“æ„éœ€è¦ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œå¹¶ä¸”å¯¹äºäº‹åŠ¡ä¹Ÿéœ€è¦æä¾›Lock Managerçš„æ”¯æŒ ä»¥ä¸Šä¸ºKVç±»å‹çš„ï¼Œå¦‚æœéœ€è¦å®ç°å…³ç³»å‹æ•°æ®åº“ï¼Œé‚£ä¹ˆåˆ™éœ€è¦å®ç°å…³ç³»æ¨¡å‹ï¼Œå’ŒSQLçš„æ‰§è¡Œå¼•æ“å’Œä¼˜åŒ–å™¨ ä¸ºä»€ä¹ˆéœ€è¦Buffer Poolï¼Ÿ è¯´æ˜äº†æ•°æ®ä»ç¡¬ç›˜åˆ°å†…å­˜å½“ä¸­æœ€åä¸ºCPUæ‰€ç”¨çš„è¿‡ç¨‹ï¼Œè€Œæ“ä½œç³»ç»Ÿä½œä¸ºä¹‹ä¸Šçš„æœ€åº•å±‚ï¼Œä¸ºäº†é˜²æ­¢è¿‡åˆ†é¢‘ç¹çš„è®¿é—®ï¼ŒOSæœ¬èº«ä¹Ÿä¼šå¯¹æ“ä½œç³»ç»Ÿçš„Pageè¿›è¡Œç¼“å­˜ï¼ˆOSçš„PageåŒºåˆ†äºDBMSçš„Pageï¼‰ï¼Œå³page Cache\nå½“é€šè¿‡ç³»ç»Ÿè°ƒç”¨read()â€‹è¿›è¡Œè¯»å–æ—¶ï¼Œå†…æ ¸é¦–å…ˆä¼šä»page cacheå½“ä¸­å»å¯»æ‰¾æ˜¯å¦å­˜åœ¨ç¼“å­˜ï¼Œå¦‚æœä¸å­˜åœ¨ç¼“å­˜ï¼Œåˆ™ç”³è¯·é¡µå¸§ç©ºé—´ï¼Œè¿›è¡ŒIOæ“ä½œï¼Œä¹‹åå°†å…¶å­˜æ”¾åˆ°page cacheå½“ä¸­ï¼Œè¿›è¡Œç¼“å­˜ï¼Œä¹‹åå†å°†å…¶æ‹·è´åˆ°ç¨‹åºçš„ç¼“å­˜å½“ä¸­ï¼Œè¯»å–ç»“æŸ\nè¿™æ ·å­˜åœ¨çš„é—®é¢˜æ˜¯ä¸€ä»½æ•°æ®åœ¨page cacheå½“ä¸­è¿›è¡Œäº†ä¸€æ¬¡ç¼“å­˜çš„åŒæ—¶ï¼Œè¿˜åœ¨ç¨‹åºå½“ä¸­è¿›è¡Œä¸€æ¬¡ç¼“å­˜ï¼Œç¼“å­˜ä¸¤æ¬¡å¯¼è‡´CPU cacheå‘½ä¸­ç‡ä¸é«˜ã€‚å› æ­¤æå‡ºçš„å†…å­˜æ˜ å°„æœºåˆ¶ï¼ˆlinuxå½“ä¸­ä¸º mmapï¼‰\nåœ¨ä½¿ç”¨mmapè°ƒç”¨æ—¶ï¼Œç³»ç»Ÿå¹¶ä¸é©¬ä¸Šä¸ºå…¶åˆ†é…å†…å­˜ç©ºé—´ï¼Œè€Œä»…ä»…æ˜¯æ·»åŠ ä¸€ä¸ªVMA(Virtual Memory Area)åˆ°è¯¥è¿›ç¨‹ä¸­ï¼Œå½“ç¨‹åºè®¿é—®åˆ°ç›®æ ‡ç©ºé—´æ—¶ï¼Œäº§ç”Ÿç¼ºé¡µä¸­æ–­ã€‚åœ¨ç¼ºé¡µä¸­æ–­ä¸­ï¼Œä»page cacheä¸­æŸ¥æ‰¾è¦è®¿é—®çš„æ–‡ä»¶å—ï¼Œè‹¥æœªå‘½ä¸­ï¼Œåˆ™å¯åŠ¨ç£ç›˜I/Oä»ç£ç›˜ä¸­åŠ è½½åˆ°page cacheï¼Œç„¶åå°†æ–‡ä»¶å—åœ¨page cacheä¸­çš„ç‰©ç†é¡µæ˜ å°„åˆ°è¿›ç¨‹mmapåœ°å€ç©ºé—´ã€‚æ•°æ®åœ¨å†…å­˜å½“ä¸­åªä¼šå­˜åœ¨ä¸€ä»½ï¼Œå¹¶ä¸”ä¹‹åå½“ç¨‹åºé€€å‡ºæˆ–è€…å…³é—­æ–‡ä»¶æ—¶ï¼Œpage cacheå½“ä¸­çš„æ•°æ®å¹¶ä¸ä¼šæ¸…é™¤ï¼Œå¦‚æœç‰©ç†å†…å­˜è¶³å¤Ÿçš„æƒ…å†µä¸‹ï¼Œä¼šä¸€ç›´ä¿å­˜åœ¨å†…å­˜å½“ä¸­ï¼Œä¾›ä¹‹åçš„è¿›è¡Œå»è¯»å–ã€‚\nç”±æ­¤å¯è§ï¼ŒOSå¯¹äºæ•°æ®å·²ç»æä¾›äº†ä¸€å®šçš„ç¼“å­˜èƒ½åŠ›ï¼Œä½†æ˜¯æˆ‘ä»¬ä»éœ€è¦åœ¨DBMSå½“ä¸­æä¾›ä¸€ä¸ªBuffer Poolå»æ‰‹åŠ¨ç®¡ç†å†…å­˜ï¼ŒåŸå› å¦‚ä¸‹ï¼š\nOSå¯¹äºæ•°æ®åº“å½“ä¸­çš„å†…å®¹ä¸€æ— æ‰€çŸ¥ï¼Œå³OSå¹¶ä¸çŸ¥é“å½“å‰çš„é‚£äº›Pageå¯¹äºæ•°æ®åº“æ¥è¯´æ˜¯è¾ƒä¸ºé‡è¦ï¼Œä¸èƒ½è¢«æ·˜æ±°çš„ï¼Œæƒ³è±¡è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼Œéå†table1ä»ä¸­è·å–åˆ°ageæœ€å¤§çš„é‚£ä¸€è¡Œæ•°æ®ï¼Œè€Œåœ¨éå†è¯»å–pageçš„è¿‡ç¨‹å½“ä¸­ï¼ŒOSåˆ¤å®šç³»ç»Ÿçš„ç‰©ç†å†…å­˜ä¸è¶³ï¼Œéœ€è¦è¿›è¡Œæ·˜æ±°ï¼Œä½†æ˜¯æŠŠä¹‹å‰åŠ è½½åˆ°å†…å­˜å½“ä¸­çš„pageè¿›è¡Œæ·˜æ±°ã€‚å¯¼è‡´æ•´ä¸ªSQLæ‰§è¡Œå‡ºç°é—®é¢˜ã€‚ ä½¿ç”¨Buffer Poolè¿›è¡Œæ‰‹åŠ¨ç®¡ç†ï¼Œå¯ä»¥æ˜ç¡®pinâ€‹ä½æŸäº›pageï¼Œåœ¨Buffer Poolè¿›è¡Œæ·˜æ±°æ—¶åˆ™ä¸ä¼šé€‰æ‹©å…¶è¿›è¡Œæ·˜æ±°ã€‚ åŒæ—¶Buffer Poolé«˜åº¦è‡ªå®šä¹‰æ€§ï¼Œæ•´ä¸ªBuffer Poolçš„å¤§å°ï¼Œä»¥åŠå•ä¸ªpageçš„å¤§å°ï¼Œä¸å†å—é™äºOS å¦‚ä½•ç®¡ç†Buffer poolå½“ä¸­çš„Pageï¼Ÿ OSç›¸å…³çš„pageæ·˜æ±°ç­–ç•¥éƒ½å¯ä»¥æ‹¿æ¥ç›´æ¥ä½¿ç”¨ï¼Œå¦‚FIFOã€Randomã€LRUã€RRç­‰ï¼Œæ­¤å¤–è¿˜å¯ä»¥ä½¿ç”¨LRU-Kçš„æ·˜æ±°ç­–ç•¥ï¼Œ\nç®€å•ä»‹ç»ä¸€ä¸‹LRU-Kï¼Ÿ LRU-Kå°†ç¼“å†²åŒºåˆ†ä¸ºå†å²é˜Ÿåˆ—å’Œç¼“å†²é˜Ÿåˆ—ï¼Œä¸€ä¸ªpageé¦–å…ˆåŠ å…¥åˆ°å†å²é˜Ÿåˆ—å½“ä¸­ï¼Œåœ¨æ·˜æ±°å‰è®¿é—®äº†kæ¬¡ï¼Œé‚£ä¹ˆå°±å°†å…¶ç§»åŠ¨åˆ°ç¼“å†²é˜Ÿåˆ—å½“ä¸­ã€‚å¹¶ä¸”å¼•å…¥äº†K- distanceçš„æ¦‚å¿µï¼Œå³å‰Kæ¬¡çš„è·ç¦»ï¼Œå¯ä»¥ç®€å•ä½¿ç”¨é€»è¾‘æ—¶é—´æˆ³æ¥è¡¨ç¤ºï¼Œåœ¨å†å²é˜Ÿåˆ—å½“ä¸­çš„K- distanceä¸ºæ­£æ— ç©·ï¼Œè€Œåœ¨ç¼“å†²é˜Ÿåˆ—å½“ä¸­çš„Pageçš„K- distanceå³ä¸ºå‰Kæ¬¡è®¿é—®çš„è·ç¦»ï¼ˆå³æ—¶é—´æˆ³çš„å·®å€¼ï¼‰åœ¨æ·˜æ±°æ—¶é€‰æ‹©K- distanceæœ€å¤§çš„è¿›è¡Œæ·˜æ±°\né€šè¿‡LRU-Kï¼Œå¯ä»¥é¿å…ç”±äºå…¨è¡¨éå†è€Œå¯¼è‡´çš„ç¼“å­˜æ±¡æŸ“é—®é¢˜\nLRU-Kçš„ç¼ºç‚¹ï¼Ÿ ChatGPTï¼š\nLRU-Kï¼ˆLeast Recently Used Kï¼‰æ˜¯ä¸€ç§ç¼“å­˜æ·˜æ±°ç­–ç•¥ï¼Œå®ƒæ ¹æ®æœ€è¿‘ä½¿ç”¨çš„é¢‘ç‡æ¥ç¡®å®šè¦æ·˜æ±°çš„ç¼“å­˜é¡¹ã€‚è™½ç„¶ LRU-K åœ¨æŸäº›æƒ…å†µä¸‹è¡¨ç°è‰¯å¥½ï¼Œä½†ä¹Ÿå­˜åœ¨ä¸€äº›ç¼ºç‚¹ï¼š\nå†…å­˜æ¶ˆè€—ï¼šLRU-K éœ€è¦ç»´æŠ¤é¢å¤–çš„æ•°æ®ç»“æ„ï¼ˆå¦‚è®¡æ•°å™¨æˆ–æ—¶é—´æˆ³æ•°ç»„ï¼‰æ¥è·Ÿè¸ªæœ€è¿‘ä½¿ç”¨çš„é¢‘ç‡ã€‚è¿™ä¼šå¢åŠ é¢å¤–çš„å†…å­˜æ¶ˆè€—ï¼Œå¹¶å¯èƒ½å½±å“ç¼“å­˜ç³»ç»Ÿçš„æ•´ä½“æ€§èƒ½ã€‚ ç®—æ³•å¤æ‚æ€§ï¼šç›¸æ¯”äºç®€å•çš„ LRU ç®—æ³•ï¼ŒLRU-K éœ€è¦æ›´å¤šçš„é€»è¾‘å’Œè®¡ç®—æ¥è·Ÿè¸ªå’Œæ›´æ–°æ¯ä¸ªç¼“å­˜é¡¹çš„ä½¿ç”¨é¢‘ç‡ã€‚è¿™å¢åŠ äº†ç®—æ³•çš„å¤æ‚æ€§ï¼Œå¯èƒ½å¯¼è‡´å®ç°å’Œç»´æŠ¤çš„å›°éš¾ã€‚ å‚æ•°é€‰æ‹©ï¼šé€‰æ‹©é€‚å½“çš„ K å€¼æ˜¯ LRU-K çš„ä¸€ä¸ªæŒ‘æˆ˜ã€‚K å€¼çš„é€‰æ‹©éœ€è¦ç»¼åˆè€ƒè™‘ç³»ç»Ÿçš„ç‰¹æ€§å’Œå·¥ä½œè´Ÿè½½ã€‚é€‰æ‹©è¿‡å°çš„ K å€¼å¯èƒ½å¯¼è‡´é¢‘ç¹çš„ç¼“å­˜é¡¹æ·˜æ±°ï¼Œè€Œé€‰æ‹©è¿‡å¤§çš„ K å€¼å¯èƒ½å¯¼è‡´ç¼“å­˜å‘½ä¸­ç‡ä¸‹é™ã€‚ ä¸é€‚ç”¨äºçªå‘è®¿é—®æ¨¡å¼ï¼šå½“å‡ºç°çªå‘è®¿é—®æ¨¡å¼æ—¶ï¼ŒLRU-K çš„æ€§èƒ½å¯èƒ½ä¸‹é™ã€‚å¦‚æœæœ‰ä¸€ç»„çƒ­ç‚¹æ•°æ®åœ¨çŸ­æ—¶é—´å†…è¢«é¢‘ç¹è®¿é—®ï¼Œè€Œå…¶ä»–æ•°æ®å¾ˆå°‘è¢«è®¿é—®ï¼ŒLRU-K å¯èƒ½æ— æ³•å‡†ç¡®è¯†åˆ«è¿™ç§çƒ­ç‚¹æ•°æ®ï¼Œå¹¶å¯¼è‡´å®ƒä»¬è¢«æå‰æ·˜æ±°ã€‚ ç»¼ä¸Šæ‰€è¿°ï¼Œè™½ç„¶ LRU-K åœ¨æŸäº›åœºæ™¯ä¸‹å¯ä»¥æ”¹å–„ç¼“å­˜å‘½ä¸­ç‡ï¼Œä½†å®ƒä¹Ÿå­˜åœ¨ä¸€äº›ä¸è¶³ä¹‹å¤„ã€‚åœ¨é€‰æ‹©ç¼“å­˜æ·˜æ±°ç­–ç•¥æ—¶ï¼Œéœ€è¦è€ƒè™‘ç³»ç»Ÿçš„ç‰¹æ€§ã€å·¥ä½œè´Ÿè½½ä»¥åŠå¯¹å†…å­˜æ¶ˆè€—å’Œç®—æ³•å¤æ‚æ€§çš„å®¹å¿åº¦ã€‚\nBuffer Poolå½“ä¸­çš„Page Tableæœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ æ­¤å¤„å¯ä»¥å¯¹æ¯”OSçš„å†…å­˜æ˜ å°„å’Œè¯»å–è¿›è¡Œç†è§£ï¼Œåœ¨OSå½“ä¸­ï¼Œé¦–å…ˆæ•°æ®æ˜¯çœŸå®å­˜å‚¨äºç‰©ç†å†…å­˜å½“ä¸­ï¼Œå°†ç‰©ç†å†…å­˜åˆ’åˆ†ä¸ºå¤šä¸ªPageå¤§å°çš„æ§½ä½ï¼Œæ¯ä¸ªæ§½ä½å¯ä»¥å­˜å‚¨ä¸€ä¸ªPageï¼Œè€Œè¯¥æ§½ä½é€šè¿‡PFNï¼ˆPhyical frame numberï¼‰æ¥è¡¨ç¤ºã€‚\nå½“ç¨‹åºè®¿é—®è™šæ‹Ÿå†…å­˜å½“ä¸­çš„æ•°æ®æ—¶ï¼Œè™šæ‹Ÿå†…å­˜å½“ä¸­çš„æ•°æ®ä¼šå±äºæŸä¸€ä¸ªPageï¼Œç”¨VPNï¼ˆvirtual page numberï¼‰è¿›è¡Œè¡¨ç¤ºã€‚\nå› æ­¤åœ¨è¯»å–æ•°æ®æ—¶ï¼Œå°±éœ€è¦ä¸€ä¸ªä»VPNåˆ°PFNåˆ°ä¸€ä¸ªæ˜ å°„ï¼Œè¿™ä¸ªå·¥ä½œå°±äº¤ç»™Page Tableæ¥å®Œæˆï¼Œå…¶æœ€ç®€å•çš„ç»„ç»‡æ–¹å¼ä¸ºä¸€ä¸ªæ•°ç»„ï¼Œå½“ä¸­å­˜å‚¨æ‰€æœ‰å¯èƒ½çš„æ˜ å°„ï¼ˆæœ‰æ•ˆæ— æ•ˆéƒ½å­˜åœ¨ï¼‰ï¼Œè€Œå¦‚æœé‡‡ç”¨å¤šçº§é¡µè¡¨çš„æ–¹å¼ï¼Œå…¶ç»„ç»‡å½¢å¼å°±æ˜¯ä¸€ä¸ªå“ˆå¸Œè¡¨ï¼Œkeyä¸ºVPNï¼Œvalä¸ºPFN\nåœ¨buffer pool å½“ä¸­åŒç†ï¼Œé¦–å…ˆåˆ›å»ºä¸€ä¸ªPage*[]ç”¨äºå­˜å‚¨å†…å­˜å½“ä¸­æ‰€æœ‰çš„Pageï¼Œå¯¹åº”OSå½“ä¸­çš„ç‰©ç†å†…å­˜ï¼Œè¯¥æ•°ç»„çš„ä¸‹æ ‡å³ä¸ºä¸€ä¸ªframe_idï¼ˆå¯¹åº”PFNï¼‰ï¼Œå¯¹äºä¸Šå±‚è·å–æ•°æ®è€Œè¨€ï¼Œè¦æ‹¿åˆ°ä¸€ä¸ªPageåˆ™éœ€è¦é€šè¿‡page_idï¼ˆå¯¹åº”VPNï¼‰ï¼Œæ­¤å¤„çš„page tableåŒæ ·å®Œæˆpage_id -\u0026gt; frame_idçš„æ˜ å°„å…³ç³»ã€‚\næ•°æ®åœ¨ç£ç›˜ä¸Šæœ‰ä»€ä¹ˆç»„ç»‡å½¢å¼ï¼Ÿ ä¸»è¦åˆ†ä¸ºä¸¤ç§ç»„ç»‡å½¢å¼ï¼Œåˆ†åˆ«ä¸ºåŸºäºPageçš„å’ŒåŸºäºæ—¥å¿—çš„\nPage\nåŸºäºPageçš„ä¸»è¦æ–¹å¼ä»¥Pageä¸ºåŸºæœ¬æ•°æ®å•ä½ï¼Œå½“ä¸­çš„æ•°æ®ä¸»ä½“ä¸ºTupleï¼Œæ­¤å¤–è¿˜æœ‰ä¸€äº›å…ƒæ•°æ®ç”¨äºè¾…åŠ©è¯»å–ï¼Œä¹‹åå¤šä¸ªPageç»„æˆä¸€ä¸ªFileï¼Œä¸€ä¸ªFileå¯å¯¹åº”ä¸€ä¸ªä¸€å¼ è¡¨ã€‚åŸºäºPageçš„æœ€å¸¸è§çš„ä¸ºHeapFile-Pageçš„ç»„ç»‡å½¢å¼ã€‚HeapPageæ‰¿è½½Tupleï¼Œå¤šä¸ªHeapPageæ„æˆä¸€ä¸ªHeapFIleã€‚\né¦–å…ˆï¼Œåœ¨HeapFile-Pageçš„æƒ…å†µä¸‹ä¸ºä¹±åºå­˜å‚¨çš„ï¼Œå³æŒ‰é¡ºåºæ’å…¥tuple a å’Œbï¼Œå¹¶ä¸ä¿è¯bå­˜å‚¨äºaä¹‹å‰ã€‚\nå› æ­¤åœ¨ä¸€ä¸ªPageå½“ä¸­ï¼Œåªè¦èƒ½å¤Ÿæ‰¾åˆ°ç©ºä½™ç©ºé—´ï¼Œå°±å¯ä»¥å°†æ•°æ®å­˜å‚¨äºå…¶ä¸­ï¼Œåœ¨è¿™ç§è§„åˆ™ä¸‹ï¼ŒHeapPageçš„ç»“æ„ä¸ºä¸€ä¸ªbyte[]æ•°ç»„çš„headerï¼Œç”¨äºè¡¨ç¤ºè¯¥slotä¸Šæ˜¯å¦ä¸ºç©ºä½™ï¼Œä¹‹ååˆ™æ˜¯ä¸€ä¸ªTuple[]æ•°ç»„ï¼Œç”¨äºå­˜å‚¨å…·ä½“çš„tupleï¼Œåœ¨6.830å½“ä¸­ï¼Œheader[]çš„é•¿åº¦è®¾ç½®ä¸º8ï¼Œå³ä¸€ä¸ªHeapPageå½“ä¸­å¯ä»¥å­˜å‚¨256ä¸ªtuple\nä¹‹åHeapPageå³å¯ç»„æˆHeapFileï¼Œå¯¹äºHeapPageçš„ç®¡ç†æ–¹å¼ï¼Œæœ€ç®€å•çš„æ–¹å¼å³ä¸ºä¸ç®¡ç†ï¼Œå½“éœ€è¦ä¸€ä¸ªpageæ—¶å°±æ ¹æ®pageIdå’ŒpageSizeè®¡ç®—å‡ºåç§»é‡å»åç§»è¯»å–ï¼Œä¹Ÿå¯é€šè¿‡ä¸€ä¸ªPage Directoryè¿›è¡Œç®¡ç†ï¼Œæœ¬è´¨ä¸Šä¸ºä¸€ä¸ªpage_id-\u0026gt;offsetçš„åç§»é‡ï¼Œæœ‰ç‚¹ç±»ä¼¼äºBitcask\nåŸºäºæ—¥å¿—\nBitcask\nåŸºäºæ—¥å¿—æœ€ç»å…¸çš„å°±æ˜¯Bitcaskæ¨¡å‹ï¼Œç¡¬ç›˜ä¸Šä¸ºåªè¿›è¡Œé¡ºåºå†™å…¥çš„æ–‡ä»¶ï¼Œåœ¨å†…å­˜å½“ä¸­å†ç»´æŠ¤ä¸€ä¸ªå“ˆå¸Œè¡¨è®°å½•åç§»ï¼Œç®€å•çš„ä»¥k-vç±»å‹ä¸ºä¾‹ï¼Œåœ¨å†™å…¥æ—¶åªè¿›è¡Œè¿½åŠ å†™å…¥ï¼Œinsertå’Œupdate deleteåˆå¹¶ä¸ºä¸€ä¸ªputæ“ä½œï¼Œinsert updateåªéœ€è¦å‘å…¶ä¸­å†™å…¥æœ€æ–°çš„æ•°æ®ï¼Œå¹¶æ›´æ–°ç´¢å¼•ï¼Œdeleteæ“ä½œåˆ™å†™å…¥ä¸€ä¸ªå¢“ç¢‘æ ‡å¿—ï¼Œç”¨äºè¿›è¡Œå‹ç¼©ï¼Œå¹¶ä¸”åˆ é™¤ç´¢å¼•ã€‚åœ¨è¯»å–æ—¶åªéœ€è¦æ ¹æ®ç´¢å¼•è¿›è¡Œè¯»å–å³å¯ã€‚\nç”±äºä¸€ç›´é¡ºåºå†™å…¥ä¼šå¯¼è‡´å½“ä¸­å­˜å‚¨å¾ˆå¤šé™ˆæ—§æ•°æ®ï¼Œæ­¤æ—¶å°±æ¶‰åŠåˆ°ä¸€ä¸ªå‹ç¼©æ“ä½œï¼Œå³å°†é¡ºåºæ‰«æåŸæœ¬çš„dbæ–‡ä»¶ï¼Œå¹¶åªä¿å­˜æœ€æ–°çš„å€¼\nå­˜å‚¨å•å…ƒé€šå¸¸å¦‚ä¸‹\nLSM-Treeâ€‹\né¦–å…ˆå¯¹äºä¸€ä¸ªæ®µæˆ–è€…levelï¼Œå†…éƒ¨keyéœ€è¦æŒ‰ç…§é¡ºåºç»´æŠ¤ï¼Œè¿™ä¹Ÿæ˜¯ä¸Bitcaskå­˜å‚¨æ¨¡å‹çš„æœ€å¤§çš„ä¸åŒã€‚\nåœ¨å­˜å‚¨ä¸Šåˆ†ä¸ºå†…å­˜å’Œç£ç›˜ä¸¤éƒ¨åˆ†ï¼Œæ‰€æœ‰çš„è¯·æ±‚é¦–å…ˆä¼šå†™å…¥åˆ°å†…å­˜å½“ä¸­ï¼Œåœ¨å†…å­˜ä¸­è¿›è¡Œç®¡ç†ï¼Œä¸ºäº†ç»´æŠ¤æœ‰åºç»“æ„ï¼Œåœ¨å†…å­˜ä¸­å¯ä»¥ä½¿ç”¨è·³è¡¨æˆ–è€…B+æ ‘ç­‰æ–¹å¼ç®¡ç†keyï¼Œå½“å†…å­˜å½“ä¸­çš„keyåˆ°è¾¾ä¸Šé™æ—¶ï¼Œåœ¨å°†å…¶é¡ºåºå†™å…¥åˆ°ç£ç›˜ä¸Šï¼Œå³å¯ä¿è¯ç£ç›˜å½“ä¸­å†…å®¹çš„æœ‰åºæ€§ã€‚\nåœ¨å†™å…¥ä¹‹åï¼Œå†…å­˜å½“ä¸­åªéœ€è¦ä¿å­˜ç¨€ç–çš„ä¸€ä¸ªç´¢å¼•ç»“æ„å³å¯ï¼Œä¸å¿…ä¿å­˜æ‰€æœ‰çš„keyã€‚\nåœ¨ç£ç›˜ä¸Šå³ä¸ºSSTableï¼Œå…¶ä¸­åˆ†ä¸ºä¸¤ç§æ•°æ®å—ï¼Œä¸€ç§ä¸ºå­˜å‚¨æ•°æ®ï¼Œå¦ä¸€ç§ä¸ºç´¢å¼•å—ï¼Œæ ‡æ˜å„ä¸ªå—çš„keyçš„èŒƒå›´ã€‚\nè¯»å†™æ“ä½œ\nå†™ï¼šå°±åƒä¸Šé¢æ‰€è¯´çš„é‚£æ ·ï¼Œå…ˆå†™å…¥åˆ°å†…å­˜å½“ä¸­ï¼Œä¹‹åå†åˆ·ç›˜è¿›è¡ŒæŒä¹…åŒ–ï¼Œå½¢æˆä¸€ä¸ªæœ‰åºæ•°æ®å—ã€‚ è¯»ï¼šç”±äºæ˜¯è¿½åŠ å†™å…¥ï¼Œä¸ºäº†è·å–åˆ°æœ€æ–°çš„keyï¼Œå…ˆå°è¯•ä»å†…å­˜ä¸­è¿›è¡Œè·å–ï¼Œå¦‚æœæ²¡æœ‰åˆ™å»è¯»å–æœ€æ–°çš„å¯¹åº”èŒƒå›´çš„æ•°æ®å—ï¼Œå¦‚æœè·å–ä¸åˆ°å†å»å¯»æ‰¾æ›´é™ˆæ—§çš„æ•°æ®å—ï¼Œåœ¨ç¬¬ä¸€æ¬¡è·å–æ—¶åˆ™å®Œæˆæœç´¢ï¼Œå¦åˆ™ç»§ç»­ç›´è‡³å®Œæˆæœç´¢ã€‚è€Œå¯¹äºèŒƒå›´æŸ¥è¯¢ï¼Œå¯ä»¥å¹¶è¡Œçš„æŸ¥è¯¢å¤šä¸ªç¬¦åˆèŒƒå›´çš„component åˆå¹¶\nä¸ºäº†è§£å†³ç£ç›˜å½“ä¸­componentç§¯ç´¯å¯¼è‡´çš„è¯»æ€§èƒ½ä¸‹é™çš„é—®é¢˜ï¼Œéœ€è¦å°†å¤šä¸ªcomponentåˆå¹¶ï¼Œä»¥å»é™¤é‡å¤çš„keyï¼Œä»è€Œå‡å°‘æŸ¥è¯¢çš„æ¬¡æ•°ã€‚ä¸»è¦æœ‰ä¸¤ç§æ–¹æ¡ˆï¼š\nlevelï¼šåœ¨Lå±‚çº§çš„ä¸€ä¸ªcomponentä¼šæ¥å—ä»L-1å±‚çº§æ¥çš„åˆå¹¶ï¼Œç›´è‡³è¾¾åˆ°è¯¥å±‚çš„ä¸Šé™ï¼Œä¹‹åå‘L+1å±‚å»è¿›è¡Œåˆå¹¶ tiersï¼šä¸€å±‚å½“ä¸­ä¼šæœ‰Tä¸ªcomponentï¼Œå½“æ»¡äº†éœ€è¦åˆå¹¶æ—¶ï¼ŒTä¸ªcomponentåˆå¹¶æˆä¸€ä¸ªå¹¶æ”¾å…¥åˆ°ä¸‹ä¸€å±‚ã€‚ L+1å±‚èƒ½å¤Ÿå®¹çº³çš„keyçš„æ•°é‡ä¸ºLå±‚çš„Tå€ï¼Œå¹¶ä¸”å¯¹äºæ’å…¥åˆ é™¤æ•°é‡ç›¸ç­‰çš„å‡è¡¡æƒ…å†µï¼Œå±‚æ•°ç»´æŒä¸å˜ã€‚\nlevelç­–ç•¥ä¸‹ä¼šé€šè¿‡é¢‘ç¹çš„åˆå¹¶ä»¥å‡å°‘componentçš„æ•°é‡ï¼Œå¯¹è¯»è¯·æ±‚è¾ƒä¸ºå‹å¥½ï¼Œtiersç­–ç•¥ä¸‹åˆå¹¶è¾ƒå°‘(ä¸€å±‚æ»¡äº†Tä¸ªä¹‹åæ‰ä¼šåˆå¹¶)ï¼Œå› æ­¤å¯¹äºå†™è¯·æ±‚è¾ƒä¸ºå‹å¥½ã€‚\nç´¢å¼• è°ˆä¸€è°ˆç´¢å¼•å’Œå¸¸è§çš„ç´¢å¼•å½¢å¼ æ•°æ®åº“ç´¢å¼•æ˜¯ä¸€ç§ç”¨äºæé«˜æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½çš„æ•°æ®ç»“æ„ã€‚å®ƒç±»ä¼¼äºä¹¦ç±çš„ç›®å½•ï¼Œé€šè¿‡æŒ‰ç…§ç‰¹å®šå­—æ®µæˆ–å­—æ®µç»„åˆå¯¹æ•°æ®åº“è¡¨ä¸­çš„æ•°æ®è¿›è¡Œæ’åºå’Œç»„ç»‡ï¼Œä»è€ŒåŠ å¿«å¯¹æ•°æ®çš„æ£€ç´¢é€Ÿåº¦ã€‚\nè¾ƒä¸ºå¸¸è§çš„ç´¢å¼•ç±»å‹ä¸ºhashtable å’Œ B+ Treeï¼Œåœ¨å½¢å¼ä¸Šåˆ†ä¸ºèšç°‡ç´¢å¼•å’Œéèšç°‡ç´¢å¼•\nå¯¹äºèšç°‡ç´¢å¼•ç´¢å¼•ï¼Œåˆ™å­˜åœ¨ä¸€ä¸ªä¸»é”®ï¼Œé»˜è®¤ä¸ºä¸»é”®åˆ›å»ºç´¢å¼•ï¼Œä¹‹åä¸»é”®çš„ç´¢å¼•ä¸Šå­˜å‚¨çœŸå®çš„æ•°æ®ï¼Œé€šè¿‡åœ¨ä¸»é”®ç´¢å¼•ä¸Šæœç´¢å³å¯æ‰¾åˆ°å¯¹åº”çš„Tupleï¼Œè¿™æ ·çš„å¥½å¤„æ˜¯å½“éœ€è¦é€šè¿‡ä¸»é”®è¿›è¡Œæœç´¢æ—¶ï¼Œå¯ä»¥é€šè¿‡å¯¹ç´¢å¼•çš„ä¸€æ¬¡è®¿é—®å°±æ‰¾åˆ°æ•°æ®ï¼Œè€Œå¯¹äºäºŒçº§ç´¢å¼•ï¼Œå…¶ä¸­å­˜å‚¨çš„ä¸ºkey -\u0026gt; ä¸»é”®ï¼Œå³é€šè¿‡äºŒçº§ç´¢å¼•åªèƒ½æ‰¾åˆ°ä¸€ä¸ªä¸»é”®ç´¢å¼•çš„æ ‡å¿—ï¼Œä¹‹åå†é€šè¿‡è¿™ä¸ªæ ‡è¯†å»ä¸»é”®ç´¢å¼•å½“ä¸­è¯»å–ï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºå›è¡¨ã€‚ å¯¹äºéèšç°‡ç´¢å¼•ï¼Œä¸å­˜åœ¨ä¸»é”®ã€äºŒçº§ç´¢å¼•çš„æ¦‚å¿µï¼Œæ‰€æœ‰çš„ç´¢å¼•æ‰€å­˜å‚¨çš„éƒ½æ˜¯ä¸€ä¸ªkey -\u0026gt; offsetï¼Œè¿™ä¸ªoffseté€šå¸¸ä¸ºä¸€ä¸ªç»„åˆï¼Œå½“ä¸­å¯èƒ½åŒ…å«table_id page_id offsetï¼Œæ‹¿åˆ°è¿™ä¸ªoffsetä¹‹åå†å»HeapFile-Pageå½“ä¸­åç§»è¯»å–ã€‚ è¯´ä¸€è¯´B+æ ‘ ä¸æƒ³è¯´äº†ã€‚ã€‚ã€‚ç§»æ­¥Bustub Lab2\nç®€å•ä»‹ç»ä¸€ä¸‹å“ˆå¸Œè¡¨ è¿™é‡Œä¸é’ˆå¯¹å“ˆå¸Œç´¢å¼•ï¼Œåªæ˜¯è¯´ä¸€ä¸‹å“ˆå¸Œè¡¨è¿™ç§æ•°æ®ç»“æ„ï¼Œä¸»è¦åˆ†ä¸ºé™æ€å“ˆå¸Œå’ŒåŠ¨æ€å“ˆå¸Œ\né™æ€å“ˆå¸Œ\né™æ€å“ˆå¸Œçš„æœ¬è´¨ä¸Šä¸ºä¸€ä¸ªæ•°ç»„ï¼Œé€šè¿‡å“ˆå¸Œå‡½æ•° % lençš„æ–¹å¼æ‰¾åˆ°ä¸€ä¸ªæ•°ç»„ä¸‹æ ‡ï¼Œè¯¥ä¸‹æ ‡å°±å¯¹åº”ç€çœŸå®çš„å­˜å‚¨ä½ç½®ã€‚\nå¯¹äºå“ˆå¸Œå†²çªé—®é¢˜ï¼Œæ ¹æ®ä¸åŒçš„è§£å†³æ–¹å¼å¯ä»¥ç»§ç»­ç»†åˆ†ï¼š\næœ€åŸºç¡€çš„å³ä¸ºçº¿æ€§æ¢æµ‹ï¼Œå³å‘ä¸‹ä¸€ä¸ªå“ˆå¸Œæ§½ç§»åŠ¨ï¼Œåœ¨åˆ é™¤æ—¶å°†ç”±äºå†²çªå‘ä¸‹ç§»åŠ¨çš„å‡å‘åŸæ¥çš„ä½ç½®ç§»åŠ¨ä¸€æ ¼ï¼Œæˆ–è€…è®¾ç½®ä¸€ä¸ªå¢“ç¢‘ï¼Œä»¤è¯¥å“ˆå¸Œæ§½ä¸å¯ç”¨\nç½—å®¾æ±‰å“ˆå¸Œ\nç½—å®¾æ±‰åŠ«å¯Œæµè´«ï¼Œç¼©å°è´«å¯Œå·®è·ï¼Œå› æ­¤å¼•å…¥ä¸€ä¸ªæƒé‡ï¼Œæ¥æ ‡è¯†è·ç¦»åŸæœ¬è®¡ç®—å‡ºæ¥çš„æ§½çš„è·ç¦»ï¼Œæœ€ç»ˆçš„ç›®æ ‡æ˜¯ä»¤æ‰€æœ‰çš„æ‰€æœ‰çš„keyçš„æƒé‡ï¼ˆè·ç¦»ï¼‰è¾ƒä¸ºå¹³å‡\nä¸‹å›¾è“è‰²æ ‡è¯†åŸæœ¬è®¡ç®—å‡ºçš„æ§½çš„ä½ç½®ï¼Œval[i]æ ‡è¯†æœ€ç»ˆçš„ä½ç½®å…·ä½“æœ€åˆè®¡ç®—å‡ºçš„ä½ç½®çš„è·ç¦»\nD[1]\u0026lt;E[2]ï¼Œå› æ­¤ä¸ºäº†ä¿è¯å‡è¡¡ï¼ŒEè¿›å…¥å½“å‰Dæ‰€åœ¨çš„æ§½ï¼Œå°†DæŒ¤åˆ°ä¸‹ä¸€ä¸ªæ§½å¤„ï¼Œè¿™æ ·D Eçš„æƒé‡å‡ä¸º2ï¼Œè€Œä¸æ˜¯ä¸€ä¸ª1ä¸€ä¸ª3\nCUCKOO å“ˆå¸Œ\nåˆ›å»ºä¸¤ä¸ªå“ˆå¸Œè¡¨ï¼Œä½†åŠ å…¥ä¸€ä¸ªé”®æ˜¯ï¼Œä½¿ç”¨ä¸¤ä¸ªä¸åŒçš„å“ˆå¸Œå‡½æ•°è¿›è¡Œè¿ç®—ï¼Œåœ¨ä¸¤ä¸ªå“ˆå¸Œè¡¨ä¸­æŒ‘é€‰ä¸€ä¸ªæ²¡æœ‰å†²çªçš„æ§½æ”¾å…¥ å¦‚æœä¸¤ä¸ªå‡å†²çªäº†ï¼Œé€‰æ‹©ä¸€ä¸ªæ§½ï¼Œå‡è®¾é€‰æ‹©äº†1å·å“ˆå¸Œè¡¨ï¼Œå°†å…¶ä¸­åŸæœ¬çš„å…ƒç´ å–å‡ºï¼Œä½¿ç”¨2å·å“ˆå¸Œå‡½æ•°è®¡ç®—ï¼Œè¯•å›¾æ”¾å…¥åˆ°2å·å“ˆå¸Œè¡¨ä¸­ï¼Œå¦‚æœè¿˜å†²çªï¼Œå–å‡º2å·çš„å»1å·å°è¯• è¿™ä¸ªè¿‡ç¨‹ä¸­å¯èƒ½å­˜åœ¨æ— é™å¾ªç¯çš„é—®é¢˜ï¼Œéœ€è¦è¿›è¡Œæ£€æµ‹ï¼Œå¹¶å¯¹å“ˆå¸Œè¡¨æ‰©å®¹ åŠ¨æ€å“ˆå¸Œ\né“¾å“ˆå¸Œï¼šåœ¨ä¸€ä¸ªå“ˆå¸Œæ§½ä¸Šå­˜åœ¨å¤šä¸ªå“ˆå¸Œæ¡¶ï¼Œå„ä¸ªå“ˆå¸Œæ¡¶ä¹‹é—´ç”¨é“¾è¡¨è¿æ¥ï¼Œå“ˆå¸Œæ¡¶ä¸­å­˜åœ¨å¤šä¸ªKey\nEXTENDIBLE HASHINGï¼š\nç»´æŠ¤ä¸€ä¸ªå…¨å±€è®¡æ•°å™¨ï¼Œæ ‡è¯†ä¸€ä¸ªå“ˆå¸Œåœ¨å¯»æ‰¾å“ˆå¸Œæ§½æ˜¯éœ€è¦æ¯”è¾ƒçš„ä½æ•° æ¯ä¸ªå“ˆå¸Œæ§½ç»´æŠ¤ä¸€ä¸ªlocalè®¡æ•°å™¨ï¼Œæ ‡è¯†åœ¨è¿™ä¸ªå“ˆå¸Œæ§½å†…éœ€è¦æ¯”è¾ƒçš„ä½æ•° å…¨å±€è®¡æ•°å™¨ç”¨äºæ‰¾åˆ°å¯¹åº”çš„å“ˆå¸Œæ§½ï¼Œå±€éƒ¨è®¡æ•°å™¨ç”¨äºåœ¨æ‰©å®¹æ—¶åˆ†é…å…ƒç´ \nâ€\nâ€\n","permalink":"https://fischer0522.github.io/en/posts/tech/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9F%BA%E7%A1%80%E7%BB%93%E6%9E%84/","summary":"æ•°æ®åº“åŸºç¡€ç»“æ„ æ•°æ®åº“ç»“æ„ ä¸ºä»€ä¹ˆéœ€è¦DBMSï¼Ÿ ä¸€ä¸ªæ•°æ®åº“åœ¨æœ€åŸºç¡€çš„å±‚æ¬¡ä¸Šéœ€è¦å®Œæˆä¸¤ä»¶äº‹æƒ…ï¼šå½“ä½ æŠŠæ•°æ®äº¤ç»™æ•°æ®åº“æ—¶ï¼Œå®ƒåº”å½“æŠŠæ•°æ®å­˜å‚¨èµ·æ¥ï¼›è€Œåå½“","title":"æ•°æ®åº“åŸºç¡€ç»“æ„"},{"content":"raft-example åœ¨etcdå½“ä¸­ï¼Œæä¾›äº†ä¸€ä¸ªraft-exampleï¼Œè¯¥ç¨‹åºå¹¶éæ„å»ºäº†ä¸€ä¸ªå®Œæ•´çš„Raftæ¨¡å—ï¼Œè€Œæ˜¯å¯¹Raftæ¨¡å—çš„çš„åŸºæœ¬ä½¿ç”¨ã€‚å¹¶åœ¨æ­¤åŸºç¡€ä¸Šæ„å»ºäº†ä¸€ä¸ªç®€å•çš„KVå­˜å‚¨ç»“æ„ã€‚è€ŒRaftæ¨¡å—æ˜¯ä½œä¸ºä¸€ä¸ªåŒ…çš„å½¢å¼å­˜åœ¨çš„ï¼ŒRaftæ¨¡å—åªæä¾›å¦‚Leader Election Log Replication Snapshotç­‰Raftçš„åŸºæœ¬é€»è¾‘åŠŸèƒ½ï¼Œè€Œåœ¨æ­¤ä¹‹ä¸Šçš„å­˜å‚¨ã€ç½‘ç»œé€šä¿¡ç­‰éƒ½äº¤ç»™äº†ä½¿ç”¨RaftåŒ…çš„å¼€å‘è€…æ¥è‡ªè¡Œå†³å®šã€‚\nå› æ­¤æœ€ç»ˆçš„ç»“æ„å°±åˆ†ä¸ºäº†ä¸‰å±‚ï¼š\næœ€åº•å±‚çš„Raft Packageï¼Œåªæä¾›Raftæœ€åŸºæœ¬çš„é€»è¾‘åŠŸèƒ½ RaftæœåŠ¡å™¨ï¼Œè°ƒç”¨åº•å±‚çš„Raft Packageçš„ç›¸å…³APIï¼Œè‡ªå®šä¹‰æ—¥å¿—å’Œå¿«ç…§çš„å­˜å‚¨ä»¥åŠç½‘ç»œé€šä¿¡ç­‰ å†…å­˜æ•°æ®åº“ï¼Œå’ŒRaftæœåŠ¡å™¨ä¹‹é—´é€šè¿‡channelè¿›è¡Œé€šä¿¡ï¼Œå‘ä¸‹æäº¤æ—¥å¿—ï¼Œå¹¶ä¸”æ¥å—RaftæœåŠ¡å™¨ç­‰Commitä¿¡æ¯ï¼Œä¹‹åå°†å…¶åº”ç”¨äºè‡ªèº«çš„å­˜å‚¨æ¨¡å—å½“ä¸­ã€‚ kvstore æ­¤å¤„çš„è®¾è®¡åŸºæœ¬ä¸Šä¸MIT6.824ä¸€è‡´ï¼Œé¦–å…ˆçœ‹ä¸€ä¸‹kvstoreçš„ç»“æ„ä½“\n1 2 3 4 5 6 type kvstore struct { proposeC chan\u0026lt;- string // channel for proposing updates mu sync.RWMutex kvStore map[string]string // current committed key-value pairs snapshotter *snap.Snapshotter } proposeCç”¨äºå‘ä¸‹å±‚çš„RaftæœåŠ¡å™¨æäº¤æ–°çš„è¯·æ±‚ï¼Œä¹‹åä¸‹å±‚çš„RaftæœåŠ¡å™¨æ‹¿åˆ°ä¹‹åè°ƒç”¨Raft Packageå½“ä¸­çš„ç›¸å…³APIå°è£…ä¸ºæ—¥å¿—ï¼Œä¹‹åå½¢æˆå…±è¯† kvStoreå³ä¸ºå†…å­˜æ•°æ®åº“ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡å¿«ç…§ + WALæ—¥å¿—æ¥æä¾›æŒä¹…åŒ–ç¨³å®šå­˜å‚¨ snapshotterç”¨äºå¤„ç†å¿«ç…§ç­‰ç›¸å…³æ¶ˆæ¯ï¼Œå¦‚Load Saveç­‰ï¼Œåœ¨etcdserver/api/snapå½“ä¸­å®ç° åˆ›å»ºâ€‹\nkvStoreçš„åˆ›å»ºè¿‡ç¨‹ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œé¦–å…ˆå°è¯•ä»å¿«ç…§å½“ä¸­æ¢å¤æ•°æ®ï¼Œä¹‹åå°±å•ç‹¬å¼€å¯ä¸€ä¸ªgoroutineï¼Œç›‘å¬ä»ä¸‹å±‚Raftä¼ æ¥çš„æ—¥å¿—æäº¤ä¿¡æ¯ï¼Œå¦‚æœæäº¤ï¼Œå°±å°†å…¶åº”ç”¨åˆ°è‡ªèº«\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 func newKVStore(snapshotter *snap.Snapshotter, proposeC chan\u0026lt;- string, commitC \u0026lt;-chan *commit, errorC \u0026lt;-chan error) *kvstore { s := \u0026amp;kvstore{proposeC: proposeC, kvStore: make(map[string]string), snapshotter: snapshotter} snapshot, err := s.loadSnapshot() if err != nil { log.Panic(err) } if snapshot != nil { log.Printf(\u0026#34;loading snapshot at term %d and index %d\u0026#34;, snapshot.Metadata.Term, snapshot.Metadata.Index) if err := s.recoverFromSnapshot(snapshot.Data); err != nil { log.Panic(err) } } // read commits from raft into kvStore map until error go s.readCommits(commitC, errorC) return s } readCommitçš„å®ç°å’ŒMIT6.824å½“ä¸­çš„å®ç°ç¨æœ‰ä¸åŒï¼Œç”±äºectdçš„å¿«ç…§æ˜¯çœŸå®å­˜å‚¨çš„ï¼Œå› æ­¤ä¸‹å±‚çš„Raftåªéœ€è¦é€šè¿‡ä¸€ä¸ªnilâ€‹æ¥å‘ŠçŸ¥ä¸€ä¸‹ä¸Šå±‚æœ‰äº†æ–°çš„å¿«ç…§ï¼Œä¹‹åä¸Šå±‚å°±å¯ä»¥å»è¿›è¡Œè¯»å–ï¼Œä¹‹åå°±æ˜¯è¯»å–commitä¿¡æ¯åº”ç”¨äºè‡ªèº«ï¼Œæœ€åé€šè¿‡close chançš„å½¢å¼é€šçŸ¥ä¸‹å±‚Raftä¸Šå±‚åº”ç”¨å®Œæ¯•ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 func (s *kvstore) readCommits(commitC \u0026lt;-chan *commit, errorC \u0026lt;-chan error) { for commit := range commitC { // ç›¸æ¯”äºMIT 6.824 æ­¤å¤„çš„snapshotä¸ºçœŸæ­£æŒä¹…åŒ–çš„ï¼Œå› æ­¤æ— éœ€é€šè¿‡channelä¼ è¾“ // å› æ­¤åœ¨chanå½“ä¸­åªéœ€è¦å‘é€ä¸€ä¸ªnilç”¨äºé€šçŸ¥å³å¯ if commit == nil { // signaled to load snapshot snapshot, err := s.loadSnapshot() if err != nil { log.Panic(err) } if snapshot != nil { log.Printf(\u0026#34;loading snapshot at term %d and index %d\u0026#34;, snapshot.Metadata.Term, snapshot.Metadata.Index) if err := s.recoverFromSnapshot(snapshot.Data); err != nil { log.Panic(err) } } continue } // handle the commit data // .... close(commit.applyDoneC) } if err, ok := \u0026lt;-errorC; ok { log.Fatal(err) } } é™¤äº†å‡ ä¸ªä»Snapshotå½“ä¸­åŠ è½½æ•°æ®çš„å‡½æ•°ä¹‹å¤–ï¼Œå°±åªå‰©å†™å…¥å’Œè¯»å–äº†ã€‚å†™å…¥æ“ä½œå’ŒMIT6.824ä¸€æ ·ï¼Œå½“æäº¤äº†ä¸€ä¸ªå†™å…¥è¯·æ±‚ä¹‹åï¼Œå‘ä¸‹æäº¤ä¸€ä¸ªæ—¥å¿—ï¼Œæ­¤æ—¶kvstoreä¼šä¸€ç›´é˜»å¡ï¼Œç›´è‡³ä¸‹å±‚çš„Raftå½¢æˆäº†å…±è¯†å¹¶å‘ä¸Šä¼ é€’äº†commitçš„ä¿¡æ¯ï¼Œä¹‹åæ‰ä¼šé€šçŸ¥å®¢æˆ·ç«¯å†™å…¥æˆåŠŸã€‚\nä½†æ˜¯å¯¹äºè¯»å–æ“ä½œï¼Œåœ¨raft-exampleå½“ä¸­å¹¶æ²¡æœ‰é€šè¿‡Raftæ—¥å¿—æ¥ä¿è¯å¼ºä¸€è‡´æ€§ï¼Œè€Œæ˜¯ç›´æ¥åœ¨Leaderå¤„è¿›è¡Œæœ¬åœ°è¯»çš„æ“ä½œ,å¯ä»¥æé«˜è¯»æ“ä½œçš„qpsï¼Œä½†æ˜¯ç›¸å¯¹çš„ï¼Œå¼ºä¸€è‡´æ€§å°±æ— æ³•å¾—åˆ°ä¿è¯ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 func (s *kvstore) Lookup(key string) (string, bool) { s.mu.RLock() defer s.mu.RUnlock() v, ok := s.kvStore[key] return v, ok } func (s *kvstore) Propose(k string, v string) { var buf bytes.Buffer if err := gob.NewEncoder(\u0026amp;buf).Encode(kv{k, v}); err != nil { log.Fatal(err) } // å°†kvå†™å…¥åˆ°ä¸‹å±‚ï¼Œç­‰å¾…raftå®Œæˆå…±è¯† s.proposeC \u0026lt;- buf.String() } åœ¨kvstoreä¹‹ä¸Šè¿˜æœ‰ä¸€å±‚httpApiï¼Œç”¨äºå¯¹å¤–æä¾›ç½‘ç»œæœåŠ¡ï¼Œæ¯”è¾ƒç®€å•å°±æ”¾ä¸€ä¸‹ä»£ç \n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 func (h *httpKVAPI) ServeHTTP(w http.ResponseWriter, r *http.Request) { key := r.RequestURI defer r.Body.Close() switch { case r.Method == \u0026#34;PUT\u0026#34;: v, err := ioutil.ReadAll(r.Body) if err != nil { log.Printf(\u0026#34;Failed to read on PUT (%v)\\n\u0026#34;, err) http.Error(w, \u0026#34;Failed on PUT\u0026#34;, http.StatusBadRequest) return } h.store.Propose(key, string(v)) // Optimistic-- no waiting for ack from raft. Value is not yet // committed so a subsequent GET on the key may return old value w.WriteHeader(http.StatusNoContent) case r.Method == \u0026#34;GET\u0026#34;: if v, ok := h.store.Lookup(key); ok { w.Write([]byte(v)) } else { http.Error(w, \u0026#34;Failed to GET\u0026#34;, http.StatusNotFound) } case r.Method == \u0026#34;POST\u0026#34;: url, err := ioutil.ReadAll(r.Body) if err != nil { log.Printf(\u0026#34;Failed to read on POST (%v)\\n\u0026#34;, err) http.Error(w, \u0026#34;Failed on POST\u0026#34;, http.StatusBadRequest) return } nodeId, err := strconv.ParseUint(key[1:], 0, 64) if err != nil { log.Printf(\u0026#34;Failed to convert ID for conf change (%v)\\n\u0026#34;, err) http.Error(w, \u0026#34;Failed on POST\u0026#34;, http.StatusBadRequest) return } cc := raftpb.ConfChange{ Type: raftpb.ConfChangeAddNode, NodeID: nodeId, Context: url, } h.confChangeC \u0026lt;- cc // As above, optimistic that raft will apply the conf change w.WriteHeader(http.StatusNoContent) case r.Method == \u0026#34;DELETE\u0026#34;: nodeId, err := strconv.ParseUint(key[1:], 0, 64) if err != nil { log.Printf(\u0026#34;Failed to convert ID for conf change (%v)\\n\u0026#34;, err) http.Error(w, \u0026#34;Failed on DELETE\u0026#34;, http.StatusBadRequest) return } cc := raftpb.ConfChange{ Type: raftpb.ConfChangeRemoveNode, NodeID: nodeId, } h.confChangeC \u0026lt;- cc // As above, optimistic that raft will apply the conf change w.WriteHeader(http.StatusNoContent) default: w.Header().Set(\u0026#34;Allow\u0026#34;, \u0026#34;PUT\u0026#34;) w.Header().Add(\u0026#34;Allow\u0026#34;, \u0026#34;GET\u0026#34;) w.Header().Add(\u0026#34;Allow\u0026#34;, \u0026#34;POST\u0026#34;) w.Header().Add(\u0026#34;Allow\u0026#34;, \u0026#34;DELETE\u0026#34;) http.Error(w, \u0026#34;Method not allowed\u0026#34;, http.StatusMethodNotAllowed) } } Raft Raftæ¨¡å—ï¼Œæˆ–è€…è¯´RaftæœåŠ¡å™¨ï¼Œæ„å»ºäºRaftçš„åŒ…ä¹‹ä¸Šï¼ŒRaftåŒ…æä¾›çš„Leader Eelction Log ReplicationåŠŸèƒ½ä¹‹ä¸Šï¼Œå†æä¾›æ—¥å¿—å’Œå¿«ç…§çš„å­˜å‚¨å½¢å¼ã€èŠ‚ç‚¹ä¹‹é—´çš„é€šä¿¡æ–¹å¼ç­‰åŠŸèƒ½ï¼Œæ„å»ºå‡ºä¸€ä¸ªå®Œæ•´çš„Raftã€‚\né¦–å…ˆè¿˜æ˜¯çœ‹ä¸€ä¸‹Raftçš„ç»“æ„ä½“\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 type raftNode struct { proposeC \u0026lt;-chan string // proposed messages (k,v) confChangeC \u0026lt;-chan raftpb.ConfChange // proposed cluster config changes commitC chan\u0026lt;- *commit // entries committed to log (k,v) errorC chan\u0026lt;- error // errors from raft session id int // client ID for raft session peers []string // raft peer URLs join bool // node is joining an existing cluster waldir string // path to WAL directory snapdir string // path to snapshot directory getSnapshot func() ([]byte, error) confState raftpb.ConfState snapshotIndex uint64 appliedIndex uint64 // raft backing for the commit/error channel node raft.Node raftStorage *raft.MemoryStorage wal *wal.WAL snapshotter *snap.Snapshotter snapshotterReady chan *snap.Snapshotter // signals when snapshotter is ready snapCount uint64 transport *rafthttp.Transport stopc chan struct{} // signals proposal channel closed httpstopc chan struct{} // signals http server to shutdown httpdonec chan struct{} // signals http server shutdown complete logger *zap.Logger } proposeC ä» kvstoreå½“ä¸­æ¥å—æ–°çš„è¯·æ±‚ï¼Œåˆ›å»ºä¸ºæ—¥å¿— confChangeC Rafté›†ç¾¤é…ç½®æ›´æ–°çš„ç›¸å…³æ¶ˆæ¯ commitC å‘kvstoreå‘é€æ—¥å¿—æäº¤çš„ä¿¡æ¯ errorC ä¼ é€’é”™è¯¯ä¿¡æ¯ snapshotIndex å¿«ç…§åŒ–çš„æœ€åä¸€æ¡æ—¥å¿—çš„Indexï¼Œç”¨äºåœ¨æ•…éšœæ¢å¤ä¹‹åæ‰¾åˆ°Index appliedIndex åº”ç”¨äºkvstorteçš„æœ€åä¸€æ¡æ—¥å¿—Indexï¼Œç”¨äºæ•…éšœæ¢å¤ node Raft Packageå¯¹å¤–æä¾›çš„APIæ¥å£ raftStorage ç¨³å®šå­˜å‚¨æ—¥å¿—ï¼Œç”±äºä½¿ç”¨äº†WALï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨å†…å­˜çš„å½¢å¼ç¨³å®šå­˜å‚¨ wal å¯¹WALæ—¥å¿—æ“ä½œçš„å°è£… transport raftèŠ‚ç‚¹ä¹‹é—´çš„é€šä¿¡ æ­¤å¤–è¿˜æœ‰ä¸‰ä¸ªstruct{}çš„ chanç”¨äºè¿›è¡Œæ¶ˆæ¯é€šçŸ¥ï¼Œæ¥æ”¶æ–¹ä½¿ç”¨selecté˜»å¡ï¼Œå‘é€æ–¹å‘å…¶ä¸­å‘é€ä¸€ä¸ªç©ºç»“æ„ä½“å³å¯ä½¿å…¶ä»é˜»å¡å½“ä¸­æ¢å¤ã€‚\nRaftçš„åˆ›å»º å®šä¹‰ä¸€ä¸ªnewRaftNodeä¾›ä¸Šå±‚çš„kvstoreè¿›è¡Œè°ƒç”¨ï¼Œä¼ å…¥ä¸€ä¸ªproposeçš„channelç”¨äºæ¥å—kvstoreçš„æ–°çš„è¯·æ±‚ï¼Œä¹‹ååˆå§‹åŒ–raftNodeçš„éƒ¨åˆ†å€¼ï¼Œå¹¶å°†commitCä¸errorCè¿”å›äº¤ç»™kvstoreã€‚ä¹‹åå†å•ç‹¬å¼€å¯ä¸€ä¸ªgoroutineè°ƒç”¨startRaftæ¥å¯åŠ¨ä¸€äº›raftçš„æœåŠ¡ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 func newRaftNode(id int, peers []string, join bool, getSnapshot func() ([]byte, error), proposeC \u0026lt;-chan string, confChangeC \u0026lt;-chan raftpb.ConfChange) (\u0026lt;-chan *commit, \u0026lt;-chan error, \u0026lt;-chan *snap.Snapshotter) { commitC := make(chan *commit) errorC := make(chan error) rc := \u0026amp;raftNode{ proposeC: proposeC, confChangeC: confChangeC, commitC: commitC, errorC: errorC, id: id, peers: peers, join: join, waldir: fmt.Sprintf(\u0026#34;raftexample-%d\u0026#34;, id), snapdir: fmt.Sprintf(\u0026#34;raftexample-%d-snap\u0026#34;, id), getSnapshot: getSnapshot, snapCount: defaultSnapshotCount, stopc: make(chan struct{}), httpstopc: make(chan struct{}), httpdonec: make(chan struct{}), logger: zap.NewExample(), snapshotterReady: make(chan *snap.Snapshotter, 1), // rest of structure populated after WAL replay } go rc.startRaft() return commitC, errorC, rc.snapshotterReady } åˆå§‹åŒ– startRaftâ€‹\nåœ¨startRaftå½“ä¸­ç»§ç»­å®Œæˆä¸€éƒ¨åˆ†åˆå§‹åŒ–çš„å·¥ä½œï¼Œå½“å‰çš„èŠ‚ç‚¹æœ‰å¯èƒ½æ˜¯ä¹‹å‰å®•æœºä¹‹åé‡å¯ï¼Œå› æ­¤éœ€è¦é¦–å…ˆæ£€æŸ¥å¿«ç…§ä¸å†™å…¥çš„WALï¼Œä»ä¸­è¯»å–å¿«ç…§å¹¶é€šçŸ¥ä¸Šå±‚çš„kvstoreå»åº”ç”¨å¿«ç…§æ¢å¤å†…å­˜æ•°æ®åº“ï¼Œå’Œæ¢å¤Raftæ—¥å¿—åˆ°memoryStorageå½“ä¸­ã€‚\nä¹‹åå†å¯¹åº•å±‚çš„Raft Packageè¿›è¡Œä¸€äº›ç›¸å…³çš„é…ç½®ï¼Œå¦‚è®¾ç½®å¿ƒè·³ä¿¡æ¯ç­‰\netcdå½“ä¸­ä½¿ç”¨çš„ä¸ºé€»è¾‘æ—¶é’Ÿï¼Œå³é€šè¿‡Tickæ¥æ¨è¿›æ—¶é’Ÿï¼Œå¦‚å°†heartbeatçš„é—´éš”è®¾ç½®ä¸º1æ¬¡tickï¼Œé€‰ä¸¾çš„æ—¶é—´é—´éš”è®¾ç½®ä¸º10æ¬¡tick\nä¹‹åå†å®šä¹‰raftèŠ‚ç‚¹ä¹‹é—´çš„ä¼ è¾“åè®®ä¹‹åï¼Œåˆå§‹åŒ–åŸºæœ¬å®Œæˆï¼Œä¹‹ååˆ†åˆ«å¼€å¯ä¸€ä¸ªåç¨‹å»è´Ÿè´£èŠ‚ç‚¹ä¹‹é—´çš„é€šä¿¡å’Œä¸€ä¸ªç”¨äºå¤„ç†å’Œkvstoreçš„channelå’Œraft packageçš„channel\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 func (rc *raftNode) startRaft() { // handle snapshot and wal // ... c := \u0026amp;raft.Config{ ID: uint64(rc.id), ElectionTick: 10, HeartbeatTick: 1, Storage: rc.raftStorage, MaxSizePerMsg: 1024 * 1024, MaxInflightMsgs: 256, MaxUncommittedEntriesSize: 1 \u0026lt;\u0026lt; 30, } // åœ¨åˆ›å»ºèŠ‚ç‚¹æ—¶ï¼Œå¦‚æœé€šè¿‡åŸæœ¬çš„WALæ—¥å¿—è¿›è¡Œlogå’Œsnapshotçš„åŠ è½½ // æˆ–è€…ä¸ºä¸­é€”åŠ å…¥åˆ°é›†ç¾¤å½“ä¸­çš„èŠ‚ç‚¹ç›¸æ¯”äºæ–°èŠ‚ç‚¹å°‘äº†é€šè¿‡bootstrapè¿›è¡Œåˆå§‹åŒ–åŠ è½½ if oldwal || rc.join { rc.node = raft.RestartNode(c) } else { rc.node = raft.StartNode(c, rpeers) } rc.transport = \u0026amp;rafthttp.Transport{ Logger: rc.logger, ID: types.ID(rc.id), ClusterID: 0x1000, Raft: rc, ServerStats: stats.NewServerStats(\u0026#34;\u0026#34;, \u0026#34;\u0026#34;), LeaderStats: stats.NewLeaderStats(zap.NewExample(), strconv.Itoa(rc.id)), ErrorC: make(chan error), } rc.transport.Start() for i := range rc.peers { if i+1 != rc.id { rc.transport.AddPeer(types.ID(i+1), []string{rc.peers[i]}) } } // serveRaftå¯¹å¤–ç›‘å¬ç«¯å£æä¾›æœåŠ¡ // serveChannelså¤„ç†å­˜å‚¨å±‚å‘èµ·çš„è¯·æ±‚ï¼Œå’ŒraftNodeæ‰€ä¼ æ¥çš„ç›¸å…³ä¿¡æ¯ go rc.serveRaft() go rc.serveChannels() } channelså¤„ç† é‡ç‚¹çœ‹ä¸€ä¸‹serveChannels\nåœ¨serverChannelså½“ä¸­ï¼Œåˆå•ç‹¬å¼€äº†ä¸€ä¸ªgoroutineï¼Œå…¶ä¸­é€šè¿‡select ç›‘å¬kvstoreçš„propose channelå’Œé›†ç¾¤é…ç½®çš„channelï¼Œè°ƒç”¨Raft Packageçš„APIäº¤ç»™ä¸‹å±‚çš„Raft Packageè¿›è¡Œå¤„ç†ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 go func() { confChangeCount := uint64(0) for rc.proposeC != nil \u0026amp;\u0026amp; rc.confChangeC != nil { select { case prop, ok := \u0026lt;-rc.proposeC: if !ok { rc.proposeC = nil } else { // blocks until accepted by raft state machine rc.node.Propose(context.TODO(), []byte(prop)) } case cc, ok := \u0026lt;-rc.confChangeC: if !ok { rc.confChangeC = nil } else { confChangeCount++ cc.ID = confChangeCount rc.node.ProposeConfChange(context.TODO(), cc) } } } // client closed channel; shutdown raft if not already close(rc.stopc) }() è€ŒserverChannelsè‡ªèº«çš„goroutineç”¨äºå¤„ç†Raft Packageå¤„ç†å®Œæ¯•çš„æ¶ˆæ¯ï¼Œå…±select ä¸¤ä¸ªchannelï¼Œä¸€ä¸ªç”¨äºå¤„ç†å®šæ—¶å™¨ï¼Œå¦‚æœé€šè¿‡è¿™ä¸ªchannelæ”¶åˆ°äº†æ¶ˆæ¯é‚£ä¹ˆå°±è°ƒç”¨Tickå‡½æ•°æ¨è¿›é€»è¾‘æ—¶é’Ÿã€‚\nå¦å¤–ä¸€ä¸ªChannelæ˜¯é€šè¿‡raftnode.Ready()å‡½æ•°è¿”å›çš„ä¸€ä¸ª chan Readyâ€‹\nReadyçš„ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 type Ready struct { // The current volatile state of a Node. // SoftState will be nil if there is no update. // It is not required to consume or store SoftState. *SoftState // The current state of a Node to be saved to stable storage BEFORE // Messages are sent. // HardState will be equal to empty state if there is no update. pb.HardState // ReadStates can be used for node to serve linearizable read requests locally // when its applied index is greater than the index in ReadState. // Note that the readState will be returned when raft receives msgReadIndex. // The returned is only valid for the request that requested to read. ReadStates []ReadState // Entries specifies entries to be saved to stable storage BEFORE // Messages are sent. Entries []pb.Entry // Snapshot specifies the snapshot to be saved to stable storage. Snapshot pb.Snapshot // CommittedEntries specifies entries to be committed to a // store/state-machine. These have previously been committed to stable // store. CommittedEntries []pb.Entry // Messages specifies outbound messages to be sent AFTER Entries are // committed to stable storage. // If it contains a MsgSnap message, the application MUST report back to raft // when the snapshot has been received or has failed by calling ReportSnapshot. Messages []pb.Message // MustSync indicates whether the HardState and Entries must be synchronously // written to disk or if an asynchronous write is permissible. MustSync bool } æ­¤å¤„æˆ‘ä»¬åªéœ€è¦HardStateã€Entriesã€Snapshotã€Messagesã€CommitedEntries\nå°±åƒä¸Šæ–‡æ‰€è¯´çš„é‚£æ ·ï¼ŒRaft Packageå¹¶ä¸è´Ÿè´£é€šä¿¡å’Œå­˜å‚¨ï¼Œè¿™ä¸¤éƒ¨åˆ†éƒ½è¦äº¤ç»™RaftServerå¤„ç†ï¼Œå› æ­¤å°†HardStateã€Entrieså†™å…¥åˆ°WALå½“ä¸­ï¼ŒSnapshotåŒæ ·è¿›è¡Œä¿å­˜ã€‚ä¹‹åå†æŠŠEntriesæ·»åŠ åˆ°raftStorageå½“ä¸­ã€‚\nè€ŒMessageå³ä¸ºå½“å‰èŠ‚ç‚¹äº§ç”Ÿçš„æ‰€æœ‰çš„éœ€è¦å‘é€ç»™å…¶ä»–èŠ‚ç‚¹çš„æ¶ˆæ¯ï¼Œéƒ½éœ€è¦åœ¨æ­¤å¤„è¿›è¡Œå‘é€ï¼Œé€šè¿‡ä¹‹å‰å®šä¹‰çš„transportæ¨¡å—è¿›è¡Œå‘é€ã€‚\nè€Œå¯¹äºåº•å±‚Raft Packageå·²ç»è¾¾æˆå…±è¯†è®¤å®šä¸ºcommitted çš„Entriesï¼Œé€šè¿‡publishEntriesâ€‹å¤„ç†åé€šè¿‡commitCé€šçŸ¥ä¸Šå±‚çš„kvstoreã€‚\n","permalink":"https://fischer0522.github.io/en/posts/tech/etcd/raft-example/","summary":"raft-example åœ¨etcdå½“ä¸­ï¼Œæä¾›äº†ä¸€ä¸ªraft-exampleï¼Œè¯¥ç¨‹åºå¹¶éæ„å»ºäº†ä¸€ä¸ªå®Œæ•´çš„Raftæ¨¡å—ï¼Œè€Œæ˜¯å¯¹Raftæ¨¡å—çš„çš„åŸºæœ¬ä½¿ç”¨ã€‚å¹¶åœ¨æ­¤åŸºç¡€ä¸Šæ„","title":"raft-example"},{"content":"å†…å­˜è™šæ‹ŸåŒ– ç®€å•è°ˆä¸€è°ˆå¯¹å†…å­˜è™šæ‹ŸåŒ–çš„ç†è§£ï¼Ÿ è®¡ç®—æœºå½“ä¸­çš„å†…å­˜æ¡æˆä¸ºç‰©ç†å†…å­˜ï¼Œè™šæ‹ŸåŒ–å†…å­˜å³ä¸ºå¯¹ç‰©ç†å†…å­˜è¿›è¡ŒæŠ½è±¡ï¼ŒæŠ½è±¡æˆä¸ºåœ°å€ç©ºé—´çš„ä¸€ä¸ªæ¦‚å¿µã€‚åœ¨å…¶ä¸­åˆ’åˆ†äº†ç¨‹åºä»£ç ï¼Œæ ˆã€å †ä¸‰ä¸ªç©ºé—´ï¼Œæ ˆç”¨äºä¿å­˜å‡½æ•°çš„è°ƒç”¨ä¿¡æ¯ï¼Œåˆ†é…ç©ºé—´ç»™å±€éƒ¨å˜é‡ï¼Œç”¨äºä¼ é€’å‚æ•°çš„å‡½æ•°è¿”å›å€¼ï¼Œå †ç”¨äºç®¡ç†åŠ¨æ€åˆ†é…çš„å†…å­˜ã€‚\næ¯ä¸ªè¿›ç¨‹ä½¿ç”¨çš„å†…å­˜ä¸ºæˆä¸ºåœ°å€ç©ºé—´çš„è™šæ‹Ÿå†…å­˜ï¼Œè€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨ç‰©ç†å†…å­˜ï¼Œ é¦–å…ˆå¯ä»¥ä¿è¯æ˜“ç”¨æ€§ï¼Œæ¯ä¸ªè¿›ç¨‹å¯¹åœ°å€çš„ä½¿ç”¨å¯ä»¥ä»0KBå¼€å§‹ï¼Œä¹‹åæ“ä½œç³»ç»Ÿå†å°†åœ°å€ç©ºé—´æ˜ å°„åˆ°ç‰©ç†å†…å­˜çš„æŸä¸ªä½ç½®ä¸Šã€‚åŒæ—¶å¯ä»¥ä¿è¯å®‰å…¨æ€§å’Œéš”ç¦»æ€§ã€‚æ¯ä¸ªè¿›ç¨‹çš„åœ°å€ç©ºé—´éƒ½ä¼šè¢«æ˜ å°„åˆ°ä¸åŒçš„ç‰©ç†å†…å­˜èŒƒå›´ä¸Šï¼Œé™¤éä½¿ç”¨ç‰¹æ®Šçš„æ‰‹æ®µï¼Œä¸€ä¸ªè¿›ç¨‹åœ¨è¿è¡ŒæœŸé—´æ— æ³•è®¿é—®åˆ°å…¶ä»–è¿›ç¨‹åœ¨ç‰©ç†å†…å­˜ä¸Šçš„æ˜ å°„ã€‚\nè¯´ä¸€è¯´åˆ†æ®µå†…å­˜ç®¡ç† å¯¹äºåœ°å€ç©ºé—´ï¼Œå¦‚æœä¸è¿›è¡Œåˆ†æ®µï¼Œåˆ™éœ€è¦é€šè¿‡ä¸€ä¸ªåŸºå€å¯„å­˜å™¨å’Œä¸€ä¸ªèŒƒå›´å¯„å­˜å™¨å°†æ•´ä¸ªåœ°å€ç©ºé—´æ˜ å°„åˆ°ç‰©ç†å†…å­˜çš„æŸä¸ªä½ç½®ä¸Šï¼Œå­˜åœ¨çš„é—®é¢˜æ˜¯ä¸çµæ´»å¹¶ä¸”å®¹æ˜“äº§ç”Ÿç¢ç‰‡ï¼Œå½±å“ä¹‹åå†…å­˜çš„åˆ†é…ã€‚\nè€Œåˆ†æ®µçš„å½¢å¼ï¼Œåˆ™å¯ä»¥å°†æ•´ä¸ªåœ°å€ç©ºé—´åˆ†ä¸ºå¤šä¸ªæ®µï¼Œå¯ä»¥æ˜¯ä»£ç  + æ ˆ + å †ï¼Œä¹Ÿå¯ä»¥é‡‡ç”¨æ›´åŠ ç»†è‡´çš„åˆ†æ³•ï¼Œå¯¹äºæ¯ä¸€æ®µï¼Œå•ç‹¬è¿›è¡Œæ˜ å°„ï¼Œä»è€Œå‡å°‘å†…å­˜ç¢ç‰‡çš„é—®é¢˜ã€‚\nåˆ†æ®µåœ¨æŠ€æœ¯ä¸Šå¦‚ä½•å®ç° åŸæœ¬åœ°å€ç©ºé—´ä½œä¸ºæ•´ä½“è¿›è¡Œæ˜ å°„åªéœ€è¦ä¸€å¯¹åŸºå€å¯„å­˜å™¨ + èŒƒå›´å¯„å­˜å™¨ï¼Œåˆ†æ®µæ—¶å¯ä»¥é‡‡ç”¨å¤šå¯¹å¯„å­˜å™¨ï¼Œæ¥å¯¹ä¸åŒçš„æ®µè¿›è¡Œæ˜ å°„ã€‚\nåœ¨å¯»å€æ—¶ï¼Œé¦–å…ˆæ ¹æ®åœ°å€çš„å‰å‡ ä½æ‰¾åˆ°å¯¹åº”çš„æ®µï¼Œå¯¹äºåé¢çš„å‡ ä½ï¼Œéœ€è¦é¦–å…ˆä¸è¯¥æ®µçš„è™šæ‹Ÿå†…å­˜çš„æ®µé¦–è¿›è¡Œè®¡ç®—ï¼Œå¾—å‡ºä¸€ä¸ªåç§»é‡ï¼Œä¹‹åå†ä¸åŸºå€å¯„å­˜å™¨å½“ä¸­çš„åœ°å€è¿›è¡Œåè¿ç®—ï¼Œå¾—åˆ°çœŸå®çš„ç‰©ç†åœ°å€ã€‚\næ­¤å¤–ï¼Œå¯¹äºæ ˆè¿™ç§åå‘å¢é•¿çš„æ®µï¼Œéœ€è¦é€šè¿‡ä¸€ä¸ªæ ‡å¿—ä½æ¥è¡¨æ˜å…¶å¢é•¿æ–¹å‘ï¼Œå’ŒåŸºå€å¯„å­˜å™¨åç§»è¿ç®—æ—¶åç§»é‡ä¸ºè´Ÿ\nåˆ†æ®µå½¢å¼å¦‚ä½•è¿›è¡Œç©ºé—²å†…å­˜ç®¡ç† åœ¨åˆ†æ®µå†…å­˜ç®¡ç†ä¸‹ï¼Œå¯ä»¥å°†ç‰©ç†å†…å­˜è§†ä¸ºä¸€ä¸ªè¿ç»­çš„å¤§å‹çš„æ•°ç»„ï¼Œæ¯æ¬¡åˆ†é…å°±ä¼šä»è¯¥æ•°ç»„å½“ä¸­åˆ†é…èµ°ä¸€éƒ¨åˆ†è¿ç»­çš„ï¼Œå¤§å°ä¸å›ºå®šçš„ä¸€éƒ¨åˆ†å†…å­˜ã€‚è€Œç©ºé—²ç©ºé—´æ˜¯é€šè¿‡ç©ºé—²é“¾è¡¨(free_list_)è¿›è¡Œç®¡ç†çš„ã€‚æœ€åˆé“¾è¡¨å½“ä¸­åªæœ‰ä¸€ä¸ªå…ƒç´ ï¼Œå³å®Œæ•´çš„æ•°ç»„ï¼Œå¦‚æœä»ç‰©ç†å†…å­˜çš„å¼€å¤´è¿›è¡Œåˆ†é…ï¼Œåˆ™æœ€åç©ºé—²é“¾è¡¨å½“ä¸­ä¸ºä¸€ä¸ªå¤§å°å˜å°äº†çš„å…ƒç´ ï¼Œè€Œå¦‚æœåœ¨ç‰©ç†å†…å­˜çš„ä¸­é—´è¿›è¡Œåˆ†é…ï¼Œåˆ™ä¼šå¯¼è‡´ç‰©ç†åœ°å€çš„ç©ºé—²éƒ¨åˆ†è¢«åˆ†å‰²æˆä¸¤ä»½ï¼Œç©ºé—²é“¾è¡¨å½“ä¸­å³å­˜åœ¨ä¸¤ä¸ªå…ƒç´ ï¼Œè¿™æ ·å¸¦æ¥çš„é—®é¢˜ï¼Œæ–°çš„è¾ƒå¤§çš„å†…å­˜æ— æ³•å¾—åˆ°åˆ†é…ï¼Œå¦‚åŸæœ¬30çš„å†…å­˜åœ°å€åœ¨ä¸­é—´åˆ†é…10çš„å†…å­˜ï¼Œç©ºé—²åœ°å€è¢«åˆ†å‰²æˆäº†10 10ä¸¤ä¸ªéƒ¨åˆ†ï¼Œå¯¹äº15çš„åˆ†é…éœ€æ±‚åˆ™æ— æ³•æ»¡è¶³ã€‚\nå¯¹äºä¸Šä¾‹å½“ä¸­ä¸­é—´çš„éƒ¨åˆ†è¿›è¡Œé‡Šæ”¾ï¼Œåˆ™ä¼šå¾—åˆ°10 10 10ä¸‰æ®µå†…å­˜ç©ºé—´ï¼Œæ­¤æ—¶åˆ™éœ€è¦è¿›è¡Œåˆå¹¶ï¼Œå°†å…¶åˆå¹¶æˆä¸€ä¸ªå®Œæ•´çš„ç©ºé—²å†…å­˜ç©ºé—´ã€‚\nå¦‚æœå› ä¸ºå½“ä¸­å­˜åœ¨å¤§é‡çš„ç¢ç‰‡è€Œå¯¼è‡´æ— æ³•è¿›è¡Œåˆ†é…æ—¶ï¼Œå¯ä»¥æš‚åœæ‰€æœ‰è¿›ç¨‹çš„æ‰§è¡Œï¼Œè¿›è¡Œä¸€æ¬¡é‡æ–°çš„æ˜ å°„ï¼Œå°†å†…å­˜ç¢ç‰‡è¿›è¡Œåˆå¹¶ã€‚åªä¸è¿‡æš‚åœæ‰€æœ‰è¿›ç¨‹çš„æ‰§è¡Œçš„ä»£ä»·ç›¸å½“å¤§ã€‚\nå¦‚ä½•å¯¹å·²ç»åˆ†é…å‡ºå»å†…å­˜è¿›è¡Œå›æ”¶ åœ¨é€šè¿‡mallocè¿›è¡Œåˆ†é…å†…å­˜æ—¶ï¼Œåœ¨å¯»æ‰¾åˆ°ä¸€å—ç©ºé—²çš„ç‰©ç†å†…å­˜ä¹‹åï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ªheaderï¼Œåœ¨å…¶ä¸­ä¿å­˜ä¸€äº›ç›¸å…³çš„ä¿¡æ¯ï¼Œå…¶ä¸­è‡³å°‘åŒ…å«åˆ†é…çš„å†…å­˜ç©ºé—´çš„å¤§å°ï¼Œä¹Ÿæœ‰å¯èƒ½æœ‰ä¸€äº›é¢å¤–çš„ä¿¡æ¯æ¥å¸®åŠ©å†…å­˜ç©ºé—´çš„é‡Šæ”¾ã€‚ä¹‹åè¿”å›çš„æŒ‡é’ˆæŒ‡å‘headerä¹‹åçš„åœ°å€ã€‚\nåœ¨é€šè¿‡freeè¿›è¡Œé‡Šæ”¾æ—¶ï¼Œå¯ä»¥é€šè¿‡æŒ‡é’ˆè¿ç®—æ‰¾åˆ°headerçš„ä½ç½®ï¼Œä¹‹åå°†headerå’Œåˆ†é…çš„å†…å­˜ä¸€å¹¶é‡Šæ”¾\næ®µå¼å†…å­˜åˆ†é…çš„åŸºæœ¬ç­–ç•¥ å›ºå®šåˆ†é…ï¼ˆFixed Allocationï¼‰ï¼šå›ºå®šåˆ†é…æ˜¯æœ€ç®€å•çš„å†…å­˜åˆ†é…ç­–ç•¥ï¼Œå°†å†…å­˜æŒ‰ç…§å›ºå®šå¤§å°çš„æ®µè¿›è¡Œåˆ’åˆ†ã€‚æ¯ä¸ªè¿›ç¨‹è¢«åˆ†é…ä¸€ä¸ªæˆ–å¤šä¸ªå›ºå®šå¤§å°çš„æ®µï¼Œè¿™äº›æ®µåœ¨è¿›ç¨‹çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­ä¿æŒä¸å˜ã€‚å›ºå®šåˆ†é…é€‚ç”¨äºä¸éœ€è¦åŠ¨æ€å†…å­˜ç®¡ç†çš„ç¯å¢ƒã€‚\nç­‰åˆ†åˆ†é…ï¼ˆEqual Allocationï¼‰ï¼šç­‰åˆ†åˆ†é…å°†å¯ç”¨å†…å­˜å‡åŒ€åœ°åˆ’åˆ†ä¸ºè‹¥å¹²ç­‰å¤§å°çš„æ®µï¼Œæ¯ä¸ªè¿›ç¨‹è¢«åˆ†é…ä¸€ä¸ªç­‰å¤§å°çš„æ®µã€‚è¿™ç§åˆ†é…ç­–ç•¥é€‚ç”¨äºè¿›ç¨‹æ•°ç›®å›ºå®šä¸”ç›¸å¯¹å‡åŒ€çš„åœºæ™¯ã€‚\nåŠ¨æ€åˆ†é…ï¼ˆDynamic Allocationï¼‰ï¼šåŠ¨æ€åˆ†é…æ˜¯ä¸€ç§çµæ´»çš„åˆ†é…ç­–ç•¥ï¼Œæ ¹æ®è¿›ç¨‹çš„éœ€æ±‚åŠ¨æ€åˆ†é…å†…å­˜æ®µã€‚åŠ¨æ€åˆ†é…å¯ä»¥é‡‡ç”¨ä»¥ä¸‹å‡ ç§ç­–ç•¥ï¼š\né¦–æ¬¡é€‚åº”ï¼ˆFirst Fitï¼‰ï¼šåœ¨ç©ºé—²åˆ†åŒºåˆ—è¡¨ä¸­æ‰¾åˆ°ç¬¬ä¸€ä¸ªå¤§å°è¶³å¤Ÿçš„ç©ºé—²åˆ†åŒºã€‚ æœ€ä½³é€‚åº”ï¼ˆBest Fitï¼‰ï¼šåœ¨ç©ºé—²åˆ†åŒºåˆ—è¡¨ä¸­æ‰¾åˆ°æœ€å°çš„è¶³å¤Ÿå¤§å°çš„ç©ºé—²åˆ†åŒºã€‚ æœ€å·®é€‚åº”ï¼ˆWorst Fitï¼‰ï¼šåœ¨ç©ºé—²åˆ†åŒºåˆ—è¡¨ä¸­æ‰¾åˆ°æœ€å¤§çš„è¶³å¤Ÿå¤§å°çš„ç©ºé—²åˆ†åŒºã€‚ ä¸‹æ¬¡é€‚åº”ï¼šå¤šç»´æŠ¤ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘ä¸Šä¸€æ¬¡æŸ¥æ‰¾ç»“æŸçš„ä½ç½® å¿«é€Ÿé€‚åº”ï¼ˆQuick Fitï¼‰ï¼šå°†å†…å­˜åˆ’åˆ†ä¸ºå‡ ä¸ªä¸åŒå¤§å°çš„åˆ†åŒºï¼Œæ¯ä¸ªåˆ†åŒºç»´æŠ¤ä¸€ä¸ªç©ºé—²é“¾è¡¨ã€‚æ ¹æ®è¿›ç¨‹çš„å¤§å°é€‰æ‹©ç›¸åº”çš„ç©ºé—²é“¾è¡¨è¿›è¡Œåˆ†é…ã€‚ ä¼™ä¼´åˆ†é…ï¼ˆBuddy Allocationï¼‰ï¼šä¼™ä¼´åˆ†é…å°†å¯ç”¨å†…å­˜åˆ’åˆ†ä¸ºå¤§å°ä¸º2çš„å¹‚æ¬¡æ–¹çš„å—ï¼Œæ¯ä¸ªå—çš„å¤§å°æ˜¯ä¸Šä¸€ä¸ªå—å¤§å°çš„ä¸¤å€ã€‚è¿›ç¨‹ç”³è¯·å†…å­˜æ—¶ï¼Œåˆ†é…å™¨ä¼šæŸ¥æ‰¾å¤§å°åˆé€‚çš„ç©ºé—²å—ï¼Œå¦‚æœæ‰¾åˆ°äº†æ¯”æ‰€éœ€å¤§å°ç¨å¤§çš„å—ï¼Œåˆ™ä¼šè¿›è¡Œåˆ†å‰²ã€‚å¦‚æœæ²¡æœ‰åˆé€‚çš„å—ï¼Œå°†è¿›è¡Œå†…å­˜åˆå¹¶ä»¥åˆ›å»ºæ›´å¤§çš„å—ã€‚\nè¯´ä¸€ä¸‹åˆ†é¡µå†…å­˜ç®¡ç† ç›¸æ¯”äºåˆ†æ®µåŠ¨æ€çš„ç¡®å®šåˆ†é…å†…å­˜çš„å¤§å°ï¼Œåˆ†é¡µé‡‡å–çš„æ–¹å¼æ˜¯å…ˆå°†ç‰©ç†å†…å­˜å’Œè™šæ‹Ÿå†…å­˜åˆ’åˆ†ä¸ºå¤šä¸ªåŸºæœ¬å•ä½ï¼Œä¸€ä¸ªå•ä½æˆä¸ºä¸€ä¸ªé¡µ(Page)ã€‚ä»¥é¡µä¸ºå•ä½è¿›è¡Œè™šæ‹Ÿå†…å­˜å’Œç‰©ç†å†…å­˜ä¹‹é—´çš„æ˜ å°„ï¼Œåœ¨åœ°å€ç©ºé—´å½“ä¸­ï¼Œæ¯ä¸ªPageéƒ½æœ‰ä¸€ä¸ªidï¼Œæˆä¸ºVPN(vitural page number)ï¼Œè€Œåœ¨ç‰©ç†ç©ºé—´å½“ä¸­ï¼Œå­˜åœ¨ä¸€ä¸ªPFN(Physical Frame Number)ï¼Œå¯¹äºåœ°å€ç©ºé—´å½“ä¸­çš„ä¸€ä¸ªPageï¼Œé€šè¿‡åœ°å€è½¬æ¢å³å¯é€šè¿‡VPNå¾—åˆ°PFNï¼Œä»è€Œæ‰¾åˆ°ç‰©ç†å†…å­˜çš„åœ°å€ã€‚\nå¯»å€æ—¶ï¼Œåœ°å€çš„å‰å‡ ä½ä½œä¸ºVPNï¼Œç»è¿‡åœ°å€è½¬æ¢å¾—åˆ°PFNï¼Œåå‡ ä½ä½œä¸ºåç§»é‡æ‰¾åˆ°å¯¹åº”çš„åœ°å€\nè€ŒVPNåˆ°PFNçš„æ˜ å°„çš„é›†åˆç§°ä¸ºé¡µè¡¨ï¼Œç”±äºæ¯ä¸ªè¿›ç¨‹çš„åœ°å€ç©ºé—´å‡ä¸ºä»0å¼€å§‹ï¼Œå› æ­¤æ¯ä¸ªè¿›ç¨‹éƒ½æ‹¥æœ‰ä¸€ä¸ªç‹¬ç«‹çš„é¡µè¡¨ã€‚\né¡µè¡¨çš„æ•°æ®ç»“æ„å’Œå­˜å‚¨ï¼Ÿ é¡µè¡¨æœ¬èº«å­˜å‚¨åœ¨å†…å­˜å½“ä¸­ï¼Œå…¶æœ¬è´¨å³ä¸ºä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„çš„ä¸‹æ ‡å³ä¸ºVPNï¼Œæ•°ç»„çš„æ¯ä¸ªå…ƒç´ ä¸ºä¸€ä¸ªEntryï¼Œç§°ä¸ºPTE(Page Table Entry)å…¶ä¸­é™¤äº†å­˜å‚¨ç‰©ç†é¡µå·PPNä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€äº›æ ‡å¿—ä½ï¼Œå¦‚æœ‰æ•ˆä½ï¼Œè¡¨æ˜è¯¥æ˜ å°„æ˜¯å¦æœ‰æ•ˆï¼Œä¿æŠ¤ä½ï¼Œå­˜åœ¨ä½ï¼Œå‚è€ƒä½ç­‰\nå¦‚ä½•åŠ é€Ÿå†…å­˜çš„è®¿é—®è¿‡ç¨‹ï¼Ÿ ä¸€æ¬¡å®Œæ•´çš„å†…å­˜è®¿é—®è¿‡ç¨‹éœ€è¦ï¼š\nå¯¹åœ°å€å³ç§»è¿ç®—å¾—åˆ°å‰å‡ ä½ï¼Œæ±‚å‡ºVPN è®¡ç®—å‡ºå¯¹åº”PTEåœ¨å†…å­˜å½“ä¸­çš„ä½ç½® è¯»å–å‡ºå¯¹åº”çš„PTEï¼Œåˆ¤æ–­æ˜¯å¦æœ‰æ•ˆï¼Œå¦‚æœæœ‰æ•ˆåˆ™åœ¨å…¶ä¸­è·å–å‡ºPPN æ ¹æ®PPN + åç§»é‡è®¡ç®—å‡ºçœŸå®çš„ç‰©ç†åœ°å€ï¼Œè¯»å–å†…å®¹ æ•´ä¸ªè¿‡ç¨‹ä¸­æ¶‰åŠåˆ°å¤šæ¬¡å†…å­˜è®¿é—®å’Œè®¡ç®—ï¼Œé€Ÿåº¦è¾ƒæ…¢ï¼Œå› æ­¤å¼•å…¥ç¼“å­˜æœºåˆ¶ï¼Œç§°ä¸ºTLB(Transaction-loolaside-buffer) å¯¹é¢‘ç¹å‘ç”Ÿè™šæ‹Ÿå†…å­˜åˆ°ç‰©ç†åœ°å€è½¬æ¢çš„ç¡¬ä»¶ç¼“å­˜ã€‚\nå…¶é‡‡å–å…¨ç›¸è”çš„æ–¹å¼ï¼Œå³åªæœ‰ä¸€ä¸ªç»„ï¼Œä¸€æ¡åœ°å€æ˜ å°„å¯èƒ½å­˜åœ¨TLBä¸­çš„ä»»æ„ä½ç½®ï¼Œè€Œä¸€æ¡TLBçš„ç»“æ„å¯ä»¥ç®€å•çš„è¡¨ç¤ºä¸ºï¼šVPN | PFN | å…¶ä»–ä½â€‹ï¼Œå…¶ä»–ä½ç”¨äºè¡¨ç¤ºå…¶æ˜¯å¦ä¸ºä¸€ä¸ªæœ‰æ•ˆçš„è½¬æ¢ä»¥åŠè¯»å†™ç­‰ä¿æŠ¤ä½\nåœ¨å¼•å…¥äº†TLBä¹‹åï¼Œæ•´ä¸ªå†…å­˜è®¿é—®çš„è¿‡ç¨‹ä¸ºï¼š\næ£€æŸ¥TLBå½“ä¸­æ˜¯å¦å­˜åœ¨ä¸€ä¸ªç›¸å…³æ˜ å°„ å¦‚æœå­˜åœ¨ç›¸å…³æ˜ å°„å¹¶ä¸”æœ‰æ•ˆï¼Œé‚£ä¹ˆç›´æ¥è·å–åˆ°å¯¹åº”çš„PFNï¼Œå»ç‰©ç†å†…å­˜å½“ä¸­è¯»å– å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™ç§°ä¸ºTLBæœªå‘½ä¸­ï¼ŒæŒ‰ç…§ä¹‹å‰çš„æ–¹æ³•è¿›è¡Œåœ°å€è½¬æ¢ï¼Œå¹¶ä¸”å°†è·å–åˆ°çš„PFNç”Ÿæˆä¸€ä¸ªEntryï¼Œæ·»åŠ åˆ°TLBå½“ä¸­ï¼Œè€Œå½“TLBå·²æ»¡æ—¶ï¼Œå¯ä»¥é‡‡ç”¨éšæœºæˆ–è€…LRUçš„æ–¹å¼ä»ä¸­æ·˜æ±°æ‰æŸäº›Entryï¼Œç»§ç»­æ·»åŠ  è°æ¥å¤„ç†TLBæœªå‘½ä¸­ï¼Ÿ åœ¨ä¹‹å‰çš„æ“ä½œç³»ç»Ÿå½“ä¸­ï¼Œé€šå¸¸é€šè¿‡ç¡¬ä»¶æ¥å¤„ç†TLBæœªå‘½ä¸­ï¼Œå‘ç”Ÿæœªå‘½ä¸­æ—¶ï¼Œç¡¬ä»¶éå†é¡µè¡¨æ‰¾åˆ°æ­£ç¡®çš„PTEï¼Œå–å‡ºæƒ³è¦çš„åœ°å€æ˜ å°„ï¼Œç”¨å…¶æ›´æ–°TLB\næ›´åŠ ç°ä»£çš„ä½“ç³»ç»“æ„å½“ä¸­ï¼Œé€šå¸¸é€šè¿‡è½¯ä»¶æ¥å¤„ç†TLBæœªå‘½ä¸­ï¼Œå‘ç”ŸTLBæœªå‘½ä¸­æ—¶ï¼Œç¡¬ä»¶ç³»ç»Ÿè·‘å‡ºä¸€ä¸ªå¼‚å¸¸ï¼Œæš‚åœå½“å‰çš„æŒ‡ä»¤æµï¼Œå¹¶ä¸”å°†ç‰¹æƒçº§åˆ«æå‡è‡³å†…æ ¸æ¨¡å¼ï¼Œè·³è½¬åˆ°å¯¹åº”çš„é™·é˜±å¤„ç†ç¨‹åºï¼Œè¯¥é™·é˜±å¤„ç†ç¨‹åºç”±æ“ä½œç³»ç»Ÿæä¾›ï¼Œåœ¨å…¶ä¸­é€šè¿‡ç‰¹æƒæŒ‡ä»¤æ›´æ–°TLBï¼Œä»é™·é˜±ä¸­è¿”å›ï¼Œä¹‹åç¡¬ä»¶é‡è¯•æŒ‡ä»¤åˆ™ä¼šTLBå‘½ä¸­\nä¸Šä¸‹æ–‡åˆ‡æ¢æ—¶TLBçš„å¤„ç† ç”±äºæ¯ä¸ªè¿›ç¨‹å‡æœ‰ä¸€ä¸ªé¡µè¡¨ï¼Œå¦‚æœTLBä¹Ÿä¸ºå½“å‰è¿›ç¨‹æ‰€ç‹¬å çš„è¯ï¼Œæ¯æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢åï¼Œå…¶ä¸­çš„æ˜ å°„åˆ™å…¨éƒ¨å¤±æ•ˆï¼Œåˆéœ€è¦é‡æ–°å¼€å§‹å»ºç«‹ç¼“å­˜ï¼Œå› æ­¤å¯¹åº”çš„è§£å†³æ–¹æ¡ˆä¸ºæ·»åŠ ä¸€ä¸ªé¢å¤–çš„æ ‡å¿—ä½ï¼Œç§°ä¸ºåœ°å€ç©ºé—´æ ‡è¯†ç¬¦(ASID)ï¼Œå¯ä»¥è§†ä¸ºè¿›ç¨‹æ ‡è¯†ç¬¦(PID)ï¼Œä¹‹åå³å¯å¤šä¸ªè¿›ç¨‹å…±äº«TLBã€‚\nâ€\nå¦‚ä½•è§£å†³é¡µè¡¨è¿‡å¤§çš„é—®é¢˜ï¼Ÿ ç”±äºå•çº§é¡µè¡¨é‡‡ç”¨çš„ç®¡ç†æ–¹å¼ä¸ºç±»ä¼¼æ•°ç»„çš„å½¢å¼ï¼Œå³ä¸€å¼€å§‹å°±ç¡®å®šå¥½VPNå’ŒPFNçš„æ˜ å°„å…³ç³»ï¼Œå¦‚æœå­˜åœ¨äº†æ”¹æ˜ å°„ï¼Œå†å•ç‹¬ä½¿ç”¨æœ‰æ•ˆä½è¿›è¡Œæ ‡è¯†ã€‚å†åŠ ä¸Šæ¯ä¸ªè¿›ç¨‹å‡ä¼šæ‹¥æœ‰ä¸€ä¸ªé¡µè¡¨ï¼Œå¯¹äº32ä½çš„åœ°å€ç©ºé—´ï¼ŒPageä¸º4KBå¤§å°ï¼Œå‡è®¾ä¸€ä¸ªPage Table Entryçš„å¤§å°ä¸º4ä¸ªå­—èŠ‚ï¼Œåˆ™ä¸€ä¸ªé¡µè¡¨çš„å¤§å°ä¸º4Mï¼Œå‡è®¾å½“å‰æœ‰100ä¸ªè¿›ç¨‹ï¼Œé¡µè¡¨åˆ™ä¼šå ç”¨400MBå¤§å°çš„å†…å­˜ã€‚\næœ€ç®€å•çš„æ–¹å¼å³ä¸ºç”¨æ›´å¤§çš„Pageï¼ŒPageçš„å¤§å°æ‰©å¤§Nå€ï¼Œå³å¯ä½¿Page Table Entryçš„æ•°é‡å‡å°‘åˆ°1/Nï¼Œå ç”¨ç©ºé—´ç¼©å‡ä¸ºåŸæœ¬çš„1/N åˆ†æ®µåˆ†é¡µæ··åˆï¼šåˆ†æ®µæ˜¯å°†è¿›ç¨‹çš„åœ°å€ç©ºé—´åˆ’åˆ†ä¸ºå¤šä¸ªæ®µï¼Œæ¯ä¸ªæ®µå…·æœ‰ä¸åŒçš„å¤§å°å’Œå±æ€§ï¼Œå¦‚ä»£ç æ®µã€æ•°æ®æ®µã€å †æ®µå’Œæ ˆæ®µç­‰ã€‚æ¯ä¸ªæ®µéƒ½æœ‰ä¸€ä¸ªæ®µè¡¨ï¼Œç”¨äºæ˜ å°„æ®µçš„é€»è¾‘åœ°å€åˆ°ç‰©ç†åœ°å€ã€‚ç”±äºæ®µçš„å¤§å°å¯ä»¥æ ¹æ®éœ€æ±‚è¿›è¡Œè°ƒæ•´ï¼Œå› æ­¤å¯ä»¥é¿å…å¯¹æ•´ä¸ªè¿›ç¨‹åœ°å€ç©ºé—´çš„æ˜ å°„ï¼ŒèŠ‚çœäº†å†…å­˜ç©ºé—´ å¤šçº§é¡µè¡¨ï¼šå°†Page Tableåˆ†ä¸ºPageå¤§å°çš„å•å…ƒï¼Œå¦‚æœè¯¥å•å…ƒå†…å­˜åœ¨æœ‰æ•ˆçš„æ˜ å°„ï¼Œåˆ™åˆ†é…è¯¥é¡µçš„Page Tableï¼Œå¦åˆ™ä¸åˆ†é…ï¼Œå¯ä»¥é¿å…ä¸ºæ— æ•ˆçš„æ˜ å°„é¢å¤–åˆ†é…å†…å­˜è¿›è¡Œå­˜å‚¨ å±•å¼€è¯´è¯´å¤šçº§é¡µè¡¨ å…ˆä»¥ç®€å•çš„äºŒçº§å¤šçº§é¡µè¡¨ä¸ºä¾‹ï¼Œé¦–å…ˆå°†Page TableæŒ‰ç…§Pageçš„å¤§å°è¿›è¡Œåˆ’åˆ†ä¸ºä¸€ä¸ªä¸ªå•å…ƒï¼Œä¹‹åç¡®å®šä¸€ä¸ªäºŒçº§ç´¢å¼•ï¼Œç§°ä¸ºPage Directoryï¼Œå…¶ä¸­çš„æ¯ä¸€ä¸ªæ¡ç›®ç§°ä¸ºPage Directory Entryï¼ˆPDEï¼‰ï¼ŒPDEå½“ä¸­å­˜å‚¨æœ‰æ•ˆä½å’ŒPage Tableå½“ä¸­çš„æŸä¸€ä¸ªå•å…ƒæ‰€åœ¨çš„ç‰©ç†å†…å­˜çš„ä½ç½®çš„PFNã€‚\nå½“Page Tableå½“ä¸­æŸä¸€ä¸ªå•å…ƒå…¶ä¸­å­˜åœ¨æœ‰æ•ˆçš„æ˜ å°„æ—¶ï¼Œä¸ºå…¶å»ºç«‹äºŒçº§ç´¢å¼•ï¼Œå³åœ¨Page Directoryå½“ä¸­æ·»åŠ ä¸€ä¸ªEntryï¼ŒåŒ…å«è¯¥å•å…ƒçš„ç‰©ç†Page Frame Numberï¼Œé€šè¿‡è¿™æ ·çš„å½¢å¼ï¼Œå¯¹äºä¸€ä¸ªå•å…ƒä¸­å…¨ä¸ºæ— æ•ˆæ˜ å°„çš„å•å…ƒï¼Œä¸ä¸ºå…¶å»ºç«‹ç´¢å¼•ï¼Œä¹Ÿä¸ä¸ºå…¶åœ¨ç‰©ç†å†…å­˜ä¸Šåˆ†é…ç©ºé—´ï¼Œä»è€Œç®€çº¦äº†å†…å­˜ã€‚\nåŒæ—¶ï¼Œé¡µè¡¨ä¹Ÿä¸éœ€è¦è¿ç»­å­˜å‚¨ï¼Œå¯ä»¥ä»¥Pageå¤§å°ä¸ºå•ä½å­˜å‚¨åœ¨å†…å­˜çš„ä»»æ„ä½ç½®ï¼Œä¹‹åé€šè¿‡äºŒçº§ç´¢å¼•å³å¯æ‰¾åˆ°ã€‚\nåœ¨è¿›è¡Œå¯»å€æ—¶ï¼Œå°†è™šæ‹Ÿåœ°å€åˆ’åˆ†ä¸ºä¸‰æ®µï¼Œç¬¬ä¸€æ®µä½œä¸ºPage Directoryç´¢å¼•æ‰¾åˆ°å¯¹åº”çš„PDEï¼Œä¹‹åæ ¹æ®PDEå½“ä¸­çš„PFNå»ç‰©ç†å†…å­˜ä¸­è¯»å–åˆ°å¯¹åº”çš„Page Tableå•å…ƒï¼Œä¹‹åç¬¬äºŒæ®µä½œä¸ºPage Tableçš„ç´¢å¼•ï¼Œæ‰¾åˆ°å¯¹åº”çš„PTEï¼Œåœ¨å…¶ä¸­è·å–åˆ°æœ€ç»ˆçš„PFNï¼Œåœ¨ä½¿ç”¨æœ€åä¸€æ®µä½œä¸ºåç§»é‡ï¼Œå’ŒPFNä¸€èµ·ç¡®å®šæœ€ç»ˆçš„ç‰©ç†åœ°å€ã€‚\nè€Œå½“é¡µè¡¨è¿‡å¤šæ—¶ï¼Œå³Page Directoryä¹Ÿæ— æ³•æ”¾å…¥åˆ°ä¸€ä¸ªPageå½“ä¸­ï¼Œå¯ä»¥å»ºç«‹ä¸‰çº§ç´¢å¼•ï¼Œæ­¤æ—¶å°†è™šæ‹Ÿåœ°å€åˆ’åˆ†ä¸º4æ®µï¼ŒæŒ‰ç…§åŒæ ·çš„æ–¹å¼è¿›è¡Œç´¢å¼•å¯»æ‰¾\nåŒæ—¶ï¼Œå¤šçº§é¡µè¡¨ä¹Ÿå¯ä»¥å’ŒTLBè¿›è¡Œç»“åˆï¼ŒTLBå½“ä¸­ä¸ºå•çº§å½¢å¼ï¼Œè®°å½•VPNå’Œæœ€ç»ˆçš„PFNçš„æ˜ å°„ï¼Œå¤šçº§ç´¢å¼•æœç´¢è¿‡ç¨‹ä¸­Page Tableå•å…ƒçš„PFNä¸å­˜å‚¨äºTLBå½“ä¸­ï¼Œå¦‚æœTLBæœªå‘½ä¸­ï¼Œå†æŒ‰ç…§å¤šçº§ç´¢å¼•çš„æ–¹å¼è¿›è¡Œæœç´¢ã€‚\nä»‹ç»ä¸€ä¸‹Swap ä¹‹å‰æ‰€å‡è®¾çš„éƒ½ä¸ºæ‰€æœ‰Pageå…¨éƒ¨å­˜å‚¨äºå†…å­˜å½“ä¸­ï¼Œè€Œå½“å†…å­˜æ»¡äº†çš„æ—¶å€™ï¼Œåˆ™éœ€è¦å°†ä¸€éƒ¨åˆ†æ²¡æœ‰ä½¿ç”¨åˆ°çš„å†…å­˜äº¤æ¢åˆ°ç£ç›˜ä¸Šè¿›è¡Œå­˜å‚¨ï¼Œæ­¤æ—¶å³å¯ç»™è¿›ç¨‹æä¾›ä¸€ä¸ªå‡è±¡ï¼Œå³å½“å‰çš„è®¡ç®—æœºä¸Šæœ‰æ— ç©·æ— å°½çš„å†…å­˜å¯ä¾›ä½¿ç”¨ï¼Œæ°¸è¿œä¸ä¼šå› ä¸ºå†…å­˜ä¸è¶³è€Œå¯¼è‡´å¤±è´¥ã€‚\nåœ¨åŸæœ¬çš„åŸºç¡€ä¸Šé¦–å…ˆåœ¨ç£ç›˜ä¸Šå¼€è¾Ÿä¸€å—ç©ºé—´ï¼Œä½œä¸ºäº¤æ¢ç©ºé—´(Swap Space)ï¼Œä¹‹åå¯¹äºåŸæœ¬çš„åŸæœ¬çš„æŸ¥æ‰¾è¿‡ç¨‹ï¼Œæ­¤æ—¶åˆ™ä¼šå­˜åœ¨å½“å‰çš„Pageä¸å­˜åœ¨äºå†…å­˜å½“ä¸­ï¼Œå·²ç»è¢«äº¤æ¢åˆ°äº†ç¡¬ç›˜ä¸Šï¼Œæ­¤æ—¶éœ€è¦åœ¨Page Table Entryå½“ä¸­æ·»åŠ ä¸€ä½å­˜åœ¨ä½ï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™ç›´æ¥ä½¿ç”¨PTEå½“ä¸­çš„PFNåœ¨ç‰©ç†å†…å­˜å½“ä¸­è¿›è¡Œè¯»å–ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œæ­¤æ—¶åˆ™è§¦å‘äº†ä¸€ä¸ªPage Faultï¼Œéœ€è¦é¦–å…ˆå°†Pageä»ç¡¬ç›˜å½“ä¸­äº¤æ¢åˆ°å†…å­˜å½“ä¸­ï¼Œä¹‹ååœ¨è¿›è¡Œè¯»å–ã€‚\nè¯´ä¸€è¯´Page Fault Page Faultå³ä¸ºå½“å‰è¯»å–çš„Pageè¢«äº¤æ¢åˆ°äº†ç£ç›˜ä¸Šï¼Œå¯ä»¥é€šè¿‡PTEå½“ä¸­çš„å­˜åœ¨ä½è¿›è¡Œåˆ¤æ–­ï¼Œå¹¶ä¸”åœ¨PTEå½“ä¸­å­˜å‚¨ç¡¬ç›˜åœ°å€ï¼Œç”¨äºè¿›è¡Œè¯»å–ï¼Œå½“ç£ç›˜å®ŒæˆIOä¹‹åï¼Œæ“ä½œç³»ç»Ÿæ›´æ–°Page Tableï¼Œå°†è¯¥é¡µæ ‡è®°ä¸ºå­˜åœ¨ï¼Œæ›´æ–°PTEçš„PFNå­—æ®µï¼Œç”¨äºä¹‹åç›´æ¥ä»ç‰©ç†å†…å­˜å½“ä¸­è¿›è¡Œè¯»å–ï¼Œå¹¶ä¸”æ­¤æ—¶è¿˜ä¼šæ›´æ–°TLBè¿›è¡Œç¼“å­˜ã€‚\nå½“è§¦å‘äº†Page Faultä¹‹åï¼Œæ“ä½œç³»ç»Ÿé€šè¿‡æŸäº›ç®—æ³•æ·˜æ±°ä¸€ä¸ªPageï¼Œä¹‹åä»ç£ç›˜å½“ä¸­è¿›è¡Œè¯»å–ï¼Œä¹‹åè®¾ç½®PFNå’Œå­˜åœ¨ä½ã€‚\nä»‹ç»ä¸€ä¸‹å†…å­˜ç¼“å†²æ·˜æ±°ç­–ç•¥ é¦–å…ˆç¼“å†²æ·˜æ±°ç­–ç•¥çš„è¡¡é‡æŒ‡æ ‡ä¸ºç¼“å­˜å‘½ä¸­ä¸æœªå‘½ä¸­çš„å¤„ç†æ—¶é—´æ±‚æœŸæœ›ã€‚\næå‡ºçš„æœ€ç†æƒ³çš„æ·˜æ±°ç­–ç•¥ä¸ºï¼šå½“ç¼“å­˜æ»¡æ—¶ï¼Œæ·˜æ±°æœªæ¥æœ€è¿œçš„å°†æ¥æ‰ä¼šè®¿é—®çš„Pageï¼Œä½†æ˜¯ç”±äºå¯¹äºæœªæ¥çš„æƒ…å†µæ— æ³•ä¼°è®¡ï¼Œå› æ­¤å…¶åªä½œä¸ºæœ€ä¼˜çš„æƒ…å†µç”¨äºæ€§èƒ½è¯„ä¼°ï¼Œçœ‹å…¶ä»–çš„ç®—æ³•åœ¨æ€§èƒ½ä¸Šä¸å…¶æ€§èƒ½ä¸Šçš„å·®è·ã€‚\nçœŸå®å¯ä»¥å®ç°çš„æœ‰FIFOä¸Randomï¼Œä»¥åŠLRUã€‚å…¶ä¸­LRUåŸºäºå±€éƒ¨æ€§åŸç†ï¼ˆæ—¶é—´å±€éƒ¨æ€§ä¸ç©ºé—´å±€éƒ¨æ€§ï¼‰å¯ä»¥å–å¾—è¾ƒå¥½çš„æ€§èƒ½ã€‚\nåœ¨LRUçš„åŸºç¡€ä¸Šè¿˜æœ‰ç”¨äºè§£å†³ç¼“å­˜æ±¡æŸ“é—®é¢˜çš„LRU-Kå’Œç”¨äºå‡å°‘è®¡ç®—å¼€é”€çš„è¿‘ä¼¼LRU\nè¿‘ä¼¼LRUï¼š\næ—¶é’Ÿç®—æ³•ï¼šæ—¶é’Ÿç®—æ³•ä½¿ç”¨ä¸€ä¸ªç¯å½¢ç¼“å†²åŒºï¼Œæ¯ä¸ªé¡µé¢æœ‰ä¸€ä¸ªè®¿é—®ä½ï¼Œè¡¨ç¤ºæ˜¯å¦è¢«è®¿é—®è¿‡ã€‚ç®—æ³•ç»´æŠ¤ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘å½“å‰ä½ç½®ã€‚å½“é¡µé¢è¢«è®¿é—®æ—¶ï¼Œè®¿é—®ä½è®¾ç½®ä¸º1ã€‚å½“éœ€è¦æ·˜æ±°é¡µé¢æ—¶ï¼Œç®—æ³•ä»å½“å‰ä½ç½®å¼€å§‹æŸ¥æ‰¾ï¼Œå¦‚æœè®¿é—®ä½ä¸º0ï¼Œåˆ™é€‰æ‹©æ·˜æ±°è¯¥é¡µé¢ï¼Œå¹¶å°†æŒ‡é’ˆç§»åˆ°ä¸‹ä¸€ä¸ªä½ç½®ï¼›å¦‚æœè®¿é—®ä½ä¸º1ï¼Œåˆ™å°†è®¿é—®ä½è®¾ä¸º0ï¼Œå¹¶å°†æŒ‡é’ˆç§»åˆ°ä¸‹ä¸€ä¸ªä½ç½®ï¼Œç»§ç»­æŸ¥æ‰¾ã€‚è¿™æ ·ï¼Œè¾ƒé•¿æ—¶é—´æœªè¢«è®¿é—®çš„é¡µé¢ä¼šè¢«æ·˜æ±°ï¼Œè¿‘ä¼¼å®ç°äº†LRUç®—æ³•çš„æ•ˆæœã€‚ äºŒæ¬¡æœºä¼šç®—æ³•ï¼šäºŒæ¬¡æœºä¼šç®—æ³•æ˜¯å¯¹æ—¶é’Ÿç®—æ³•çš„æ”¹è¿›ï¼Œå®ƒåœ¨æ¯ä¸ªé¡µé¢çš„åŸºç¡€ä¸Šæ·»åŠ äº†ä¸€ä¸ªä¿®æ”¹ä½ï¼Œè¡¨ç¤ºé¡µé¢æ˜¯å¦è¢«ä¿®æ”¹è¿‡ã€‚ç®—æ³•ç»´æŠ¤ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘å½“å‰ä½ç½®ã€‚å½“é¡µé¢è¢«è®¿é—®æ—¶ï¼Œè®¿é—®ä½è®¾ç½®ä¸º1ï¼Œä¿®æ”¹ä½ä¿æŒä¸å˜ã€‚å½“éœ€è¦æ·˜æ±°é¡µé¢æ—¶ï¼Œç®—æ³•ä»å½“å‰ä½ç½®å¼€å§‹æŸ¥æ‰¾ï¼Œå¦‚æœè®¿é—®ä½å’Œä¿®æ”¹ä½éƒ½ä¸º0ï¼Œåˆ™é€‰æ‹©æ·˜æ±°è¯¥é¡µé¢ï¼Œå¹¶å°†æŒ‡é’ˆç§»åˆ°ä¸‹ä¸€ä¸ªä½ç½®ï¼›å¦‚æœè®¿é—®ä½ä¸º1ï¼Œåˆ™å°†è®¿é—®ä½è®¾ä¸º0ï¼Œå¹¶å°†æŒ‡é’ˆç§»åˆ°ä¸‹ä¸€ä¸ªä½ç½®ï¼Œç»§ç»­æŸ¥æ‰¾ã€‚å¦‚æœè®¿é—®ä½ä¸º0è€Œä¿®æ”¹ä½ä¸º1ï¼Œåˆ™å°†è®¿é—®ä½è®¾ä¸º1ï¼Œå¹¶å°†æŒ‡é’ˆç§»åˆ°ä¸‹ä¸€ä¸ªä½ç½®ã€‚è¿™æ ·ï¼Œè¾ƒé•¿æ—¶é—´æœªè¢«è®¿é—®ä¸”æœªè¢«ä¿®æ”¹çš„é¡µé¢ä¼šè¢«ä¼˜å…ˆæ·˜æ±° ","permalink":"https://fischer0522.github.io/en/posts/tech/%E5%86%85%E5%AD%98%E8%99%9A%E6%8B%9F%E5%8C%96/","summary":"å†…å­˜è™šæ‹ŸåŒ– ç®€å•è°ˆä¸€è°ˆå¯¹å†…å­˜è™šæ‹ŸåŒ–çš„ç†è§£ï¼Ÿ è®¡ç®—æœºå½“ä¸­çš„å†…å­˜æ¡æˆä¸ºç‰©ç†å†…å­˜ï¼Œè™šæ‹ŸåŒ–å†…å­˜å³ä¸ºå¯¹ç‰©ç†å†…å­˜è¿›è¡ŒæŠ½è±¡ï¼ŒæŠ½è±¡æˆä¸ºåœ°å€ç©ºé—´çš„ä¸€ä¸ªæ¦‚å¿µã€‚åœ¨å…¶ä¸­","title":"å†…å­˜è™šæ‹ŸåŒ–"},{"content":"å¦‚ä½•ç†è§£CPUè™šæ‹ŸåŒ–ï¼Ÿ CPUè™šæ‹ŸåŒ–ï¼Œç”¨ä¸€å¥è¯ç®€å•çš„æ¦‚æ‹¬å°±æ˜¯ï¼Œé€šè¿‡CPUè™šæ‹ŸåŒ–çš„æ‰‹æ®µï¼Œå¯ä»¥è®©å¤šä¸ªç¨‹åºåœ¨åŒä¸€æ—¶é—´æ®µå†…åœ¨ä¸€å°æœºå™¨ä¸Šè¿è¡Œï¼Œå…±äº«CPUï¼ŒåŒæ—¶å¯¹æ­¤æ¯«æ— æ„ŸçŸ¥ï¼Œæ¯ä¸ªç¨‹åºè®¤ä¸ºåªæœ‰è‡ªå·±åœ¨ä½¿ç”¨CPUã€‚\nä¸ºäº†è¾¾åˆ°æ­¤ç›®çš„ï¼Œæ“ä½œç³»ç»Ÿé¦–å…ˆå°†è¿è¡Œçš„ç¨‹åºæŠ½è±¡æˆè¿›ç¨‹ã€‚è¦è¿è¡Œä¸€ä¸ªç¨‹åºå³å¯åŠ¨ä¸€ä¸ªè¿›ç¨‹ï¼Œä¸ºå…¶åˆ†é…ç›¸åº”çš„èµ„æºå’Œå†…å­˜ç©ºé—´ã€‚ä¹‹åå°†å…¶äº¤ç»™æ“ä½œç³»ç»Ÿç®¡ç†ã€‚è€Œä¸ºäº†å®ç°å¤šä¸ªè¿›ç¨‹éƒ½æ¯«æ— æ„ŸçŸ¥çš„åŒæ—¶è¿è¡Œä½¿ç”¨CPUï¼Œæ­¤æ—¶å°±éœ€è¦æ¶‰åŠåˆ°è¿›ç¨‹è°ƒåº¦ç®—æ³•ï¼Œå¦‚FIFOã€å¤šçº§åé¦ˆé˜Ÿåˆ—ç­‰ã€‚å¹¶ä¸”é€šè¿‡ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ¥å®ç°è¿›ç¨‹ä¹‹é—´çš„åˆ‡æ¢ã€‚æ­¤æ—¶å°±å¯ä»¥å°†å•ä¸€çš„CPUäº¤ç»™ä¸åŒçš„è¿›ç¨‹å»ä½¿ç”¨ï¼Œæ­¤æ—¶åœ¨å®è§‚çš„æ—¶é—´æ®µä¸Šæ¥çœ‹ï¼Œå°±æœ‰å¤šä¸ªç¨‹åºåœ¨åŒæ—¶æ‰§è¡Œï¼Œä½¿ç”¨åŒä¸€ä¸ªCPUã€‚\nè¿›ç¨‹ç›¸å…³API fork():é€šè¿‡fork()â€‹å¯ä»¥åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹ï¼Œforkçš„è°ƒç”¨å’Œè¿”å›éƒ½æ¯”è¾ƒå¥‡æ€ªï¼Œè°ƒç”¨å½“ä¸€ä¸ªè¿›ç¨‹è°ƒç”¨forkä¹‹åï¼Œå½“å‰è¿›ç¨‹ä¼šä»forkè¿”å›ï¼ŒåŒæ—¶ä¹Ÿä¼šåˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹ï¼Œä¹Ÿä»forkå½“ä¸­è¿”å›ã€‚å¦‚æœä¸åŠ ä»¥åŒºåˆ†çš„è¯ï¼ŒäºŒè€…ä¹‹åä¼šæ‰§è¡Œç›¸åŒä»£ç ã€‚\nå­è¿›ç¨‹ä¸çˆ¶è¿›ç¨‹ä¹‹é—´çš„åŒºåˆ†æ–¹å¼é‡‡ç”¨çš„ä¸ºè¿›ç¨‹æè¿°ç¬¦ pidâ€‹ï¼Œå¯¹äºçˆ¶è¿›ç¨‹ï¼Œè¿”å›æ—¶ä¼šå¾—åˆ°å­è¿›ç¨‹çš„pidï¼Œè€Œå¯¹äºå­è¿›ç¨‹ï¼Œå¾—åˆ°çš„pidä¸º0ï¼Œä¹‹åå¯ä»¥é€šè¿‡ifçš„æ–¹å¼åŒºåˆ†ï¼Œå¦çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹æ‰§è¡Œä¸åŒçš„ä»£ç ã€‚ä½†æ˜¯æ­¤æ—¶çˆ¶è¿›ç¨‹ä¸å­è¿›ç¨‹æ‰§è¡Œçš„ä¸ºåŒä¸€ä¸ªç¨‹åºï¼Œåªä¸è¿‡æ˜¯ä¸åŒçš„éƒ¨åˆ†\nä»£ç çš„æ ¼å¼å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 #include\u0026lt;stdio.h\u0026gt; #include \u0026lt;stdlib.h\u0026gt; #include \u0026lt;unistd.h\u0026gt; #include \u0026lt;sys/wait.h\u0026gt; #include \u0026lt;iostream\u0026gt; int main() { std::cout \u0026lt;\u0026lt; \u0026#34;hello world pid:\u0026#34; \u0026lt;\u0026lt; getpid() \u0026lt;\u0026lt; std::endl; int rc = fork(); if (rc \u0026lt; 0) { std::cout \u0026lt;\u0026lt; \u0026#34;fork failed\u0026#34; \u0026lt;\u0026lt; std::endl; } else if (rc == 0) { std::cout \u0026lt;\u0026lt; \u0026#34;hello world in child\u0026#34; \u0026lt;\u0026lt; std::endl; } else { int rc = wait(NULL); std::cout \u0026lt;\u0026lt; \u0026#34;hello world in parent\u0026#34; \u0026lt;\u0026lt; std::endl; } return 0; } æœ€ç»ˆçš„æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š\nwait()â€‹çˆ¶è¿›ç¨‹å¯ä»¥é€šè¿‡è°ƒç”¨waitâ€‹å‡½æ•°æ¥ç­‰å¾…å­è¿›ç¨‹æ‰§è¡Œå®Œæˆï¼Œå¦‚ä¸Šé¢çš„ç»“æœä¸€æ ·ï¼Œçˆ¶è¿›ç¨‹æ‰“å°çš„æ¶ˆæ¯åœ¨å­è¿›ç¨‹ä¹‹åï¼Œå¦‚æœä¸åŠ waitåˆ™ä¼šä¹±åºæ‰“å°ã€‚\nwaitåªåº”å½“åœ¨çˆ¶è¿›ç¨‹ä¸­è°ƒç”¨ï¼Œå¦‚æœåœ¨å­è¿›ç¨‹å½“ä¸­è°ƒç”¨ï¼Œåˆ™ä¼šäº§ç”Ÿä¸€ä¸ªé”™è¯¯ï¼Œå¹¶è¿”å›-1\nexec():é€šè¿‡exec()â€‹å¯ä»¥ä»¤çˆ¶å­è¿›ç¨‹æ‰§è¡Œå®Œå…¨ä¸åŒçš„ç¨‹åºã€‚å½“å­è¿›ç¨‹è¿”å›ä¹‹åï¼Œå¯ä»¥è°ƒç”¨execä»¤å…¶æ‰§è¡Œä¸åŒçš„ç¨‹åºï¼Œexecä¸ä¼šåˆ›å»ºæ–°çš„è¿›ç¨‹ï¼Œè°ƒç”¨ä¹‹åä¼šå°†å½“å‰çš„å­è¿›ç¨‹ç»™è¦†ç›–æ‰ï¼Œå°±åƒåŸæœ¬çš„è¿›ç¨‹æ²¡æœ‰æ‰§è¡Œè¿‡ä¸€æ ·ï¼ŒåŒ…æ‹¬ä»£ç æ®µã€å †ã€æ ˆåŠå…¶ä»–å†…å­˜ç©ºé—´éƒ½ä¼šè¢«åˆå§‹åŒ–ï¼Œå› æ­¤ï¼Œexecä¹‹åçš„ä»£ç ä¹Ÿéƒ½ä¸ä¼šæ‰§è¡Œï¼Œå¯¹execçš„è°ƒç”¨ä¹Ÿæ°¸è¿œä¸ä¼šè¿”å›ã€‚\né¦–å…ˆè®¾ç½®ä¸€ä¸ªç®€å•çš„æ‰“å°æ•°ç»„çš„å‡½æ•°ï¼Œç”¨äºä¹‹åç»™execè°ƒç”¨\n1 2 3 4 5 6 7 8 9 10 #include\u0026lt;iostream\u0026gt; #include\u0026lt;vector\u0026gt; int main() { std::vector\u0026lt;int\u0026gt; v1 = {1,2,3}; for (auto num : v1) { std :: cout \u0026lt;\u0026lt; num \u0026lt;\u0026lt; \u0026#34; \u0026#34;; } std::cout \u0026lt;\u0026lt; std::endl; return 0; } ç¨‹åºä¸»ä½“ç»“æ„å¦‚ä¸‹ï¼Œåˆ›å»ºå‡ºå­è¿›ç¨‹ä¹‹åè°ƒç”¨execï¼Œç”¨äºä¸éœ€è¦å‚æ•°ï¼Œåªéœ€è¦ä¼ é€’ä¸€ä¸ªç¨‹åºåå³å¯\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 #include\u0026lt;stdio.h\u0026gt; #include \u0026lt;stdlib.h\u0026gt; #include \u0026lt;unistd.h\u0026gt; #include \u0026lt;sys/wait.h\u0026gt; #include \u0026lt;iostream\u0026gt; int main() { std::cout \u0026lt;\u0026lt; \u0026#34;hello world pid:\u0026#34; \u0026lt;\u0026lt; getpid() \u0026lt;\u0026lt; std::endl; int rc = fork(); if (rc \u0026lt; 0) { std::cout \u0026lt;\u0026lt; \u0026#34;fork failed\u0026#34; \u0026lt;\u0026lt; std::endl; } else if (rc == 0) { std::cout \u0026lt;\u0026lt; \u0026#34;hello world in child\u0026#34; \u0026lt;\u0026lt; std::endl; auto arg = strdup(\u0026#34;./print_vec\u0026#34;); char * myargs[2]; myargs[0] = strdup(\u0026#34;print_vec\u0026#34;); myargs[1] = NULL; execvp(arg, myargs); std::cout \u0026lt;\u0026lt; \u0026#34;shouldn\u0026#39;t print\u0026#34; \u0026lt;\u0026lt; std::endl; } else { int rc = wait(NULL); std::cout \u0026lt;\u0026lt; \u0026#34;hello world in parent\u0026#34; \u0026lt;\u0026lt; std::endl; } return 0; } æœ€ç»ˆçš„æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š\nå½“å‰ç¨‹åºåˆ›å»ºå­è¿›ç¨‹ä¹‹åï¼Œå­è¿›ç¨‹è°ƒç”¨execæ‰§è¡Œå…¶ä»–çš„ç¨‹åºï¼Œexecä¹‹åçš„é‚£ä¸€æ¡è¾“å‡ºä¹Ÿæ²¡æœ‰è¢«æ‰§è¡Œï¼Œçˆ¶è¿›ç¨‹é€šè¿‡waitç­‰å¾…æ–°çš„å­è¿›ç¨‹æ‰§è¡Œç»“æŸã€‚\nâ€\né€šè¿‡è¿™ä¸‰ç§çœ‹èµ·æ¥è¾ƒä¸ºè¯¡å¼‚çš„APIï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„å®ç°shellï¼Œshellæœ¬èº«ä¹Ÿä¸ºä¸€ä¸ªç¨‹åºï¼Œæ¯”å¦‚è¾“å…¥ä¸€ä¸ªå¯æ‰§è¡Œç¨‹åºæ—¶ï¼Œshellå°±é€šè¿‡forkåˆ›å»ºä¸€ä¸ªæ–°çš„å­è¿›ç¨‹ï¼Œå¹¶è°ƒç”¨execå°†è¾“å…¥çš„ç¨‹åºåä¼ é€’ç»™execï¼Œæ‰§è¡Œæ–°çš„ç¨‹åºï¼Œä¹‹åshellé€šè¿‡waitç­‰å¾…æ–°ç¨‹åºçš„æ‰§è¡Œç»“æŸã€‚ç»“æŸä¹‹åï¼Œå†è¾“å‡ºä¸€ä¸ªæç¤ºç¬¦ï¼Œç­‰å¾…ç”¨æˆ·çš„ä¸‹ä¸€æ¬¡è¾“å…¥ã€‚\nâ€\nç”¨æˆ·æ€ä¸å†…æ ¸æ€ ä¸ºäº†ä¿è¯å®‰å…¨æ€§ï¼Œæ“ä½œç³»ç»Ÿä¸èƒ½ä»¤è¿›ç¨‹ä¸å—ä»»ä½•é™åˆ¶çš„æ‰§è¡Œï¼Œå°±åƒæ—©æœŸçš„æ“ä½œç³»ç»Ÿé‚£æ ·ï¼Œä»…ä»…æ˜¯ä¸€ä¸ªåº“ã€‚\nä¸ºäº†å¯¹è¿›ç¨‹åŠ ä»¥é™åˆ¶ï¼Œæ“ä½œç³»ç»Ÿæœ‰äº†ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„æ¦‚å¿µï¼Œåœ¨ç”¨æˆ·æ€çš„æ¨¡å¼ä¸‹ï¼Œè¿›è¡Œåªèƒ½æ‰§è¡Œä¸€äº›åŸºç¡€çš„æ“ä½œï¼Œä¸èƒ½å‘èµ·IOè®¿é—®ç¡¬ä»¶èµ„æºï¼Œè€Œåœ¨å†…æ ¸æ€ä¸‹ï¼Œæ“ä½œç³»ç»Ÿå¯ä»¥è®¿é—®æœºå™¨çš„å…¨éƒ¨èµ„æºï¼Œå¦‚å‘èµ·IOç­‰ã€‚ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„ä¹‹é—´é€šè¿‡é™·é˜±æŒ‡ä»¤å’Œä»ä»é™·é˜±è¿”å›çš„æŒ‡ä»¤æ¥å®ç°ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„åˆ‡æ¢ã€‚\né™·é˜±è¡¨æ˜¯ä»€ä¹ˆ é™·é˜±è¡¨ç”±ä¸€ç³»åˆ—æ¡ç›®ç»„æˆï¼Œæ¯ä¸ªæ¡ç›®ä¸ç‰¹å®šçš„ç³»ç»Ÿè°ƒç”¨ã€å¼‚å¸¸æˆ–ä¸­æ–­ç›¸å…³è”ã€‚æ¯ä¸ªæ¡ç›®åŒ…å«å¤„ç†ç¨‹åºçš„åœ°å€æˆ–å¤„ç†ç¨‹åºçš„æŒ‡é’ˆï¼Œå½“ç›¸åº”çš„äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œæ“ä½œç³»ç»Ÿä¼šæ ¹æ®é™·é˜±è¡¨ä¸­çš„æ¡ç›®æ‰¾åˆ°å¯¹åº”çš„å¤„ç†ç¨‹åºæ¥å¤„ç†äº‹ä»¶ï¼Œè€Œæ‰§è¡Œäº†é™·é˜±è¡¨ä¸Šçš„ç›¸å…³æŒ‡ä»¤å°±ä¼šä»ç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€ã€‚æå‡æƒé™ï¼Œå®Œæˆä¸€äº›æ“ä½œã€‚ä¹‹åæ“ä½œç³»ç»Ÿå¯ä»¥å°†æ§åˆ¶æƒè¿”å›ç»™ç”¨æˆ·æ€ï¼Œä½¿è¿›ç¨‹ç»§ç»­æ‰§è¡Œã€‚\nå¯¹äºä¸€ä¸ªå‘èµ·IOçš„è¿›ç¨‹ï¼Œæ•´ä¸ªçš„æ‰§è¡Œæµç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ å½“è¦åˆ›å»ºä¸€ä¸ªè¿›ç¨‹æ—¶ï¼Œæ“ä½œç³»ç»Ÿé¦–å…ˆåœ¨å†…æ ¸æ€ä¸ºè¯¥è¿›ç¨‹åˆ†é…å†…å­˜ï¼Œä¹‹åå°†ç¨‹åºåŠ è½½åˆ°å†…å­˜å½“ä¸­ï¼Œæ ¹æ®argvæ¥è®¾ç½®ç¨‹åºæ ˆï¼Œç”¨å¯„å­˜å™¨/pcå¡«å……å†…æ ¸æ ˆï¼Œä¹‹åä»é™·é˜±å½“ä¸­è¿”å› æ­¤æ—¶æ“ä½œç³»ç»Ÿè½¬æ¢ä¸ºç”¨æˆ·æ€ï¼Œè·³è½¬åˆ°mainå‡½æ•°ï¼Œè¿›è¡Œæ‰§è¡Œï¼Œç›´è‡³æ‰§è¡Œåˆ°å‘èµ·IOçš„ç³»ç»Ÿè°ƒç”¨ æ­¤æ—¶å°†å¯„å­˜å™¨ä¿å­˜åˆ°å†…æ ¸æ ˆï¼Œè½¬å‘å†…æ ¸æ¨¡å¼ï¼Œæ ¹æ®é™·é˜±è¡¨æ¥è·³è½¬åˆ°å¯¹åº”çš„å¤„ç†ç¨‹åº åœ¨å†…æ ¸æ€ä¸‹å¤„ç†é™·é˜±ï¼Œå®Œæˆç³»ç»Ÿè°ƒç”¨çš„å·¥ä½œï¼Œä»é™·é˜±è¿”å› ä»å†…æ ¸æ ˆæ¢å¤å¯„å­˜å™¨ï¼Œåˆ‡æ¢åˆ°ç”¨æˆ·æ¨¡å¼ï¼Œpcè¿›è¡Œç›¸åº”çš„è·³è½¬ ç»§ç»­æ‰§è¡Œï¼Œç›´è‡³ä»mainå‡½æ•°ä¸­è¿”å›ï¼Œé€šè¿‡exit(0)ç³»ç»Ÿè°ƒç”¨é‡æ–°åˆ‡æ¢åˆ°å†…æ ¸æ€ åœ¨å†…æ ¸æ€ä¸‹é‡Šæ”¾è¿›ç¨‹çš„å†…å­˜ï¼Œå°†è¿›ç¨‹ä»è¿›ç¨‹åˆ—è¡¨å½“ä¸­æ¸…é™¤ã€‚ è¿›ç¨‹é—´å¦‚ä½•è¿›è¡Œåˆ‡æ¢ï¼Ÿ åœ¨å•CPUå•æ ¸çš„å‰æä¸‹ã€‚é¦–å…ˆæ“ä½œç³»ç»Ÿæœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„åº”ç”¨ç¨‹åºï¼Œå¦‚æœæ­¤æ—¶CPUåœ¨è¿è¡ŒæŸä¸ªåº”ç”¨è¿›ç¨‹ï¼Œé‚£ä¹ˆä»–å°±ä¸èƒ½è¿è¡Œæ“ä½œç³»ç»Ÿï¼Œæ­¤æ—¶æ“ä½œç³»ç»Ÿå¤±å»äº†å¯¹è®¡ç®—æœºçš„æ§åˆ¶ã€‚ä¸ºè§£å†³æ­¤é—®é¢˜ï¼Œé‡‡ç”¨çš„æ˜¯æ—¶é’Ÿä¸­æ–­çš„æ–¹å¼ï¼Œå³æ¯éš”ä¸€æ®µæ—¶é—´CPUä¼šå‘å‡ºä¸€æ¬¡ä¸­æ–­ã€‚äº§ç”Ÿä¸­æ–­æ—¶ï¼Œæ­£åœ¨è¿è¡Œçš„è¿›ç¨‹ä¼šç»ˆæ­¢ï¼Œæ­¤æ—¶æ“ä½œç³»ç»Ÿå³å¯é‡è·å¯¹è®¡ç®—æœºçš„æ§åˆ¶ï¼Œä¹‹åå¯ä»¥å†³å®šæ˜¯è®©ä¹‹å‰çš„è¿›ç¨‹ç»§ç»­è¿è¡Œè¿˜æ˜¯åšå…¶ä»–çš„å·¥ä½œã€‚\næ­¤æ—¶ç¡®å®šäº†æ“ä½œç³»ç»Ÿèƒ½å¤Ÿé—´éš”æ€§çš„é‡æ–°è·å–è®¡ç®—æœºçš„æ§åˆ¶æƒã€‚å½“æ“ä½œç³»ç»Ÿè·å–åˆ°æ§åˆ¶æƒä¹‹åï¼Œå³å¯é€šè¿‡ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ–¹å¼å®Œæˆè¿›è¡Œçš„åˆ‡æ¢\nå¦‚ä½•ç†è§£ä¸Šä¸‹æ–‡ï¼Ÿ ä¸Šä¸‹æ–‡è¿™ä¸ªæ¦‚å¿µåœ¨è®¡ç®—æœºå½“ä¸­å‡ºç°çš„è¾ƒä¸ºé¢‘ç¹ï¼Œå¦‚æ“ä½œç³»ç»Ÿå½“ä¸­å’Œspringå½“ä¸­çš„Application Contextã€‚ç®€å•æ¥è¯´å°±æ˜¯ä¿å­˜äº†æŸä¸€ä¸ªæ—¶åˆ»çš„å…¨éƒ¨çŠ¶æ€ï¼Œæ‰€éœ€çš„ä¿¡æ¯éƒ½å¯ä»¥ä»ä¸Šä¸‹æ–‡å½“ä¸­è·å–ï¼Œå¯¹äºæ“ä½œç³»ç»Ÿæ¥è¯´ï¼Œè¿›ç¨‹ä¸Šä¸‹æ–‡å³æŒ‡æè¿°è¿›ç¨‹æˆ–çº¿ç¨‹å½“å‰çŠ¶æ€çš„æ‰€æœ‰ä¿¡æ¯çš„é›†åˆã€‚å®ƒåŒ…å«äº†ä½¿è¿›ç¨‹æˆ–çº¿ç¨‹èƒ½å¤Ÿç»§ç»­æ‰§è¡Œçš„æ‰€æœ‰å¿…è¦ä¿¡æ¯ï¼ŒåŒ…æ‹¬å¯„å­˜å™¨å€¼ã€ç¨‹åºè®¡æ•°å™¨ã€æ ˆæŒ‡é’ˆã€å†…å­˜æ˜ å°„ã€æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦ã€ä¿¡å·å¤„ç†ç¨‹åºã€æƒé™ç­‰ç­‰ã€‚\nå› æ­¤åœ¨ä¸Šä¸‹æ–‡åˆ‡æ¢æ—¶ï¼Œåˆ™å°†å½“å‰æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹çš„ä¸Šä¸‹æ–‡ä¿å­˜åˆ°å†…å­˜çš„æŸä¸ªä½ç½®ï¼Œä¹‹åå†å°†å¦å¤–ä¸€ä¸ªè¿›ç¨‹çš„ä¸Šä¸‹æ–‡è¿›è¡ŒåŠ è½½ï¼Œä»å†…æ ¸æ€è¿”å›ä¹‹åå†æ‰§è¡Œçš„å°±æ˜¯å¦å¤–ä¸€ä¸ªè¿›ç¨‹äº†ã€‚\nè¿™ä¸ªè¿‡ç¨‹æœ‰ç‚¹ç±»ä¼¼äºå‡½æ•°è°ƒç”¨ï¼Œåœ¨è¿›è¡Œå‡½æ•°è°ƒç”¨æ—¶ï¼Œå°†å½“å‰å‡½æ•°çš„åœ¨å¯„å­˜å™¨å½“ä¸­çš„ä¸€äº›ä¿¡æ¯å‹å…¥åˆ°æ ˆä¸­è¿›è¡Œä¿å­˜ï¼Œä¹‹åä¾¿å¯ä»¥è¿›è¡Œè·³è½¬ï¼Œæ‰§è¡Œå¦å¤–ä¸€ä¸ªå‡½æ•°ã€‚åªä¸è¿‡ä¸Šä¸‹æ–‡åˆ‡æ¢æ‰€éœ€ä¿å­˜å’Œæ¢å¤åˆ°ä¿¡æ¯æ›´å¹¿ï¼Œè€Œä¸”è¿›ç¨‹ä¹‹é—´çš„ç¨‹åºæ ˆä¸å…±äº«ï¼Œå› æ­¤ä¿¡æ¯ä¿å­˜ä¸å†…å­˜å½“ä¸­å¦å¤–çš„æŸä¸ªåŒºåŸŸã€‚\nå¸¸è§çš„è¿›ç¨‹è°ƒåº¦ç®—æ³•æœ‰å“ªäº› å…ˆæ¥å…ˆæœåŠ¡ï¼ˆFirst-Come, First-Servedï¼ŒFCFSï¼‰ï¼šæŒ‰ç…§è¿›ç¨‹åˆ°è¾¾çš„å…ˆåé¡ºåºè¿›è¡Œè°ƒåº¦ï¼Œå³å…ˆåˆ°å…ˆæœåŠ¡ã€‚ æœ€çŸ­ä½œä¸šä¼˜å…ˆï¼ˆShortest Job Nextï¼ŒSJNï¼‰ï¼šé€‰æ‹©ä¼°è®¡è¿è¡Œæ—¶é—´æœ€çŸ­çš„è¿›ç¨‹è¿›è¡Œè°ƒåº¦ï¼Œä»¥æœ€å°åŒ–å¹³å‡ç­‰å¾…æ—¶é—´ã€‚ æœ€çŸ­å‰©ä½™æ—¶é—´ä¼˜å…ˆï¼ˆShortest Remaining Time Firstï¼ŒSRTFï¼‰ï¼šé€‰æ‹©å‰©ä½™æ‰§è¡Œæ—¶é—´æœ€çŸ­çš„è¿›ç¨‹è¿›è¡Œè°ƒåº¦ï¼Œä»¥æœ€å°åŒ–ç­‰å¾…æ—¶é—´ã€‚ ä¼˜å…ˆçº§è°ƒåº¦ï¼ˆPriority Schedulingï¼‰ï¼šæ¯ä¸ªè¿›ç¨‹éƒ½åˆ†é…äº†ä¸€ä¸ªä¼˜å…ˆçº§ï¼Œä¼˜å…ˆçº§é«˜çš„è¿›ç¨‹ä¼˜å…ˆè¢«è°ƒåº¦ã€‚ è½®è½¬è°ƒåº¦ï¼ˆRound Robinï¼ŒRRï¼‰ï¼šæŒ‰ç…§è½®è½¬çš„æ–¹å¼åˆ†é…å¤„ç†å™¨æ—¶é—´ç‰‡ç»™æ¯ä¸ªè¿›ç¨‹ï¼Œæ¯ä¸ªè¿›ç¨‹ä¾æ¬¡æ‰§è¡Œä¸€ä¸ªæ—¶é—´ç‰‡ã€‚ æœ€é«˜å“åº”æ¯”ä¼˜å…ˆï¼ˆHighest Response Ratio Nextï¼ŒHRRNï¼‰ï¼šæ ¹æ®ç­‰å¾…æ—¶é—´å’ŒæœåŠ¡æ—¶é—´çš„æ¯”ç‡æ¥é€‰æ‹©ä¸‹ä¸€ä¸ªè¢«è°ƒåº¦çš„è¿›ç¨‹ï¼Œä»¥æé«˜ç³»ç»Ÿå“åº”æ€§ã€‚ å¤šçº§åé¦ˆé˜Ÿåˆ—è°ƒåº¦ï¼ˆMultilevel Feedback Queueï¼ŒMLFQï¼‰ï¼šå°†è¿›ç¨‹åˆ’åˆ†ä¸ºå¤šä¸ªé˜Ÿåˆ—ï¼Œæ¯ä¸ªé˜Ÿåˆ—æœ‰ä¸åŒçš„ä¼˜å…ˆçº§å’Œæ—¶é—´ç‰‡å¤§å°ï¼Œè¿›ç¨‹æ ¹æ®è¡Œä¸ºåœ¨é˜Ÿåˆ—ä¹‹é—´åˆ‡æ¢ ä»‹ç»ä¸€ä¸‹å¤šçº§åé¦ˆé˜Ÿåˆ—è°ƒåº¦ å…±æœ‰äº”æ¡è§„åˆ™ï¼š\nå¦‚æœAçš„ä¼˜å…ˆçº§ \u0026gt; Bçš„ä¼˜å…ˆçº§ï¼Œåˆ™è¿è¡ŒA å¦‚æœAå’ŒBçš„ä¼˜å…ˆçº§ç›¸åŒï¼Œåˆ™è½®è½¬è¿è¡ŒAå’ŒB å½“ä¸€ä¸ªè¿›ç¨‹è¿›å…¥ç³»ç»Ÿæ—¶ï¼Œå…ˆå°†å…¶åŠ å…¥åˆ°æœ€é«˜çš„ä¼˜å…ˆçº§å½“ä¸­ ä¸€æ—¦ä¸€ä¸ªè¿›ç¨‹åœ¨æŸä¸€å±‚ç”¨å®Œäº†å…¶çš„æ—¶é—´é…é¢ï¼ˆæ— è®ºä¸­é—´æ˜¯å¦æœ‰ä¸»åŠ¨æ”¾å¼ƒè¿‡CPUï¼Œæ”¾å¼ƒäº†å¤šå°‘æ¬¡ï¼‰éƒ½å°†å…¶ç§»åŠ¨åˆ°ä¸‹ä¸€å±‚å½“ä¸­ï¼Œé™ä½ä¼˜å…ˆçº§ æ¯ç»è¿‡ä¸€æ®µæ—¶é—´Sï¼Œå°±å°†ç³»ç»Ÿä¸­æ‰€æœ‰çš„å·¥ä½œå…¨éƒ¨é‡æ–°æ·»åŠ åˆ°æœ€é«˜ä¸€çº§çš„é˜Ÿåˆ—å½“ä¸­ å¤šçº§åé¦ˆé˜Ÿåˆ—åŸºäºä¼˜å…ˆçº§è°ƒåº¦ï¼Œå³è§„åˆ™1 2 3ã€‚åœ¨æ­¤åŸºç¡€ä¹‹ä¸Šï¼Œä¸ºäº†è§£å†³åº•å±‚è®¡ç®—å¯†é›†å‹çš„è¿›ç¨‹é¥¥é¥¿çš„é—®é¢˜ï¼Œæå‡ºäº†è§„åˆ™4ï¼Œå¯ä»¥ä½¿æ–°åŠ å…¥ç³»ç»Ÿçš„ä¼˜å…ˆçº§é€æ¸ä¸‹é™ï¼ŒåŒæ—¶è§„åˆ™4ä¹Ÿå¯ä»¥é˜²æ­¢æŸäº›è¿›ç¨‹é€šè¿‡ä¸»åŠ¨æ”¾å¼ƒCPUçš„æ–¹å¼é•¿æœŸå æœ‰é«˜ä¼˜å…ˆçº§ï¼Œè§„åˆ™5åˆ™å¯ä»¥ä½¿åº•å±‚çš„é•¿æœŸå¾—ä¸åˆ°æ‰§è¡Œçš„è¿›è¡Œé‡æ–°åˆ°æœ€é«˜å±‚å¾—ä»¥æ‰§è¡Œã€‚\n","permalink":"https://fischer0522.github.io/en/posts/tech/cpu%E8%99%9A%E6%8B%9F%E5%8C%96/","summary":"å¦‚ä½•ç†è§£CPUè™šæ‹ŸåŒ–ï¼Ÿ CPUè™šæ‹ŸåŒ–ï¼Œç”¨ä¸€å¥è¯ç®€å•çš„æ¦‚æ‹¬å°±æ˜¯ï¼Œé€šè¿‡CPUè™šæ‹ŸåŒ–çš„æ‰‹æ®µï¼Œå¯ä»¥è®©å¤šä¸ªç¨‹åºåœ¨åŒä¸€æ—¶é—´æ®µå†…åœ¨ä¸€å°æœºå™¨ä¸Šè¿è¡Œï¼Œå…±äº«CPU","title":"CPUè™šæ‹ŸåŒ–"},{"content":"Lab4 ç”±äºäº”ä¸€ä¸´è¿‘è€ƒè¯•ï¼Œå†åŠ ä¸Šåç»­è¿˜éœ€è¦å‡†å¤‡å„ç§æœºè¯•ä»¥åŠ408ç­‰ï¼Œæ•´ä¸ªLab4åšçš„æ¯”è¾ƒçš„è‰ç‡ï¼ŒåŸºæœ¬ä¸Šåªå®ç°äº†æœ€åŸºç¡€çš„åŠŸèƒ½ï¼ŒLeaderboard Bonusçš„å„ç§ä¼˜åŒ–éƒ½æ²¡å»å®ç°ï¼Œç¡®å®æ˜¯æ²¡æ—¶é—´äº†ï¼Œåœ¨è¿™é‡Œä¹Ÿåªèƒ½ç®€å•è®°å½•ä¸€ä¸‹\nTask1 - Lock Manager å½“äº‹åŠ¡å°è¯•è¯»å–æˆ–è€…ä¿®æ”¹Tupleæ—¶ï¼ŒTableHeapå’ŒExecutorç±»éƒ½ä¼šä½¿ç”¨ Lock Managerå»å°è¯•åœ¨ä¸€ä¸ªTupleä¸Šè·å–é”ï¼ˆé€šè¿‡RIDï¼‰\næ”¯æŒè¡¨çº§åˆ«å’ŒTupleçº§åˆ«çš„é”ï¼Œä»¥åŠè¯»æœªæäº¤ï¼Œè¯»æäº¤ï¼Œå¯é‡å¤è¯»ä¸‰ç§éš”ç¦»çº§åˆ«ï¼ŒLock Manageré€šè¿‡éš”ç¦»çº§åˆ«è¿›è¡ŒåŠ é”\nHintsâ€‹\né€šè¿‡LockRequestQueueæ¥ä¿å­˜ç­‰å¾…è·å–çš„é”ï¼Œå¯¹äºTupleå’Œå¯¹äºTable è€ƒè™‘ä½•æ—¶è¿›è¡Œé”å‡çº§ï¼Œè¿›è¡Œé”å‡çº§æ—¶ï¼Œéœ€è¦å¯¹LockRequestQueueåšä»€ä¹ˆ å½“è·å–åˆ°é”ä¹‹åï¼Œé€šè¿‡æ¡ä»¶å˜é‡æ¥é€šçŸ¥å°è¯•è·å–é”çš„äº‹åŠ¡ éœ€è¦å¯¹äº‹åŠ¡çš„çŠ¶æ€è¿›è¡Œç»´æŠ¤ï¼Œå¦‚GROWINGï¼ŒSHRINKINGï¼Œå½“è¿›è¡Œäº†unlockæ—¶ï¼Œå°±æ¶‰åŠåˆ°çŠ¶æ€çš„åˆ‡æ¢ï¼ˆå…·ä½“å–å†³äºéš”ç¦»çº§åˆ«ï¼‰ é€šè¿‡*lock_set_â€‹æ¥è®°å½•ä¸€ä¸ªäº‹ç‰©è·å–çš„æ‰€æœ‰çš„é”ï¼Œå½“äº‹åŠ¡è¿›è¡Œæäº¤æ—¶ï¼Œlock_manageré‡Šæ”¾å…¶ç›¸å…³çš„é” å°†ä¸€ä¸ªäº‹åŠ¡çš„çŠ¶æ€è®¾ç½®ä¸ºABORTEDéšå«åœ°ä¸­æ­¢äº†è¯¥äº‹åŠ¡ï¼Œä½†ç›´åˆ°TransactionManager::Abortè¢«è°ƒç”¨æ—¶æ‰ä¼šæ˜¾å¼åœ°ä¸­æ­¢ã€‚ä½ åº”è¯¥é€šè¯»è¿™ä¸ªå‡½æ•°å’Œæä¾›çš„æµ‹è¯•ï¼Œä»¥äº†è§£å®ƒçš„ä½œç”¨ï¼Œä»¥åŠä½ çš„é”ç®¡ç†å™¨åœ¨ä¸­æ­¢è¿‡ç¨‹ä¸­æ˜¯å¦‚ä½•ä½¿ç”¨çš„ã€‚ å®éªŒæ‰‹å†Œå½“ä¸­å¹¶æ²¡æœ‰æä¾›å¤ªå¤šæœ‰ç”¨çš„ä¿¡æ¯ï¼Œåœ¨lock_manager.hçš„æ³¨é‡Šå½“ä¸­ï¼Œæ¶‰åŠåˆ°äº†å…·ä½“åº”å½“å¦‚ä½•å®ç°ï¼Œè¿™é‡ŒæŒ‘æœ‰ç”¨çš„ç¿»è¯‘ä¸€ä¸‹ï¼ŒæŒ‰ç…§æ•´ä¸ªæ³¨é‡Šæä¾›çš„ä¿¡æ¯ï¼Œæ‹é¡ºä¸€ä¸‹åŸºæœ¬å°±èƒ½å¤Ÿå®ŒæˆåŠŸèƒ½äº†ã€‚\nLOCK NOTEâ€‹\nLockTable()å’ŒLockRow()å‡ä¸ºé˜»å¡çš„æ–¹å¼ï¼Œåº”å½“ç­‰åˆ°é”æˆäºˆä¹‹åå†returnï¼Œå¯¹äºä¸­æ­¢çš„äº‹åŠ¡åº”å½“æ‹’ç»æˆäºˆï¼Œå¹¶è¿”å›false\næ”¯æŒçš„é”æ¨¡å‹ï¼š\nTableçº§çš„æ”¯æŒæ‰€æœ‰ç±»å‹çš„é” Tupleçº§åˆ«çš„ä¸æ”¯æŒæ„å‘é” éš”ç¦»çº§åˆ«ï¼šåªæœ‰ç¬¦åˆå½“å‰éš”ç¦»çº§åˆ«çš„é”ï¼Œå¹¶ä¸”æ ¹æ®å½“å‰æƒ…å†µå…è®¸ï¼Œæ‰èƒ½æˆäºˆé”ï¼Œä¾‹å¦‚ï¼ŒREAD_UNCOMMITTEDä¸‹ä¸æ”¯æŒS/IS/SIXé”ï¼Œç›¸ä¼¼çš„X/IXé”åœ¨SHRINKINGé˜¶æ®µåŒæ ·ä¸æ”¯æŒ\nREPEATABLE_READï¼šå¯ä»¥è·å–æ‰€æœ‰çº§åˆ«çš„é”ï¼Œåªæœ‰åœ¨GROWINGé˜¶æ®µæ‰èƒ½å¤Ÿè·å–é” READ_COMMITTEDï¼šå¯ä»¥è·å–æ‰€æœ‰çº§åˆ«çš„é”ï¼Œåœ¨GROWINGé˜¶æ®µå¯ä»¥è·å–æ‰€æœ‰çš„é”ï¼Œåœ¨SHRINKINGé˜¶æ®µåªèƒ½è·å–ISï¼ŒSé” READ_UNCOMMITEDï¼šåªæ”¯æŒIX,Xé”ï¼Œå¹¶ä¸”åªåœ¨GROWINGé˜¶æ®µå¯ä»¥è·å– åœ¨åœ¨Tupleä¸Šè·å–é”çš„æ—¶å€™ï¼Œéœ€è¦ä¿è¯é¦–å…ˆåœ¨Tupleæ‰€å±çš„Tableä¸Šè·å–åˆ°å¯¹åº”çš„é”ï¼Œ\né”å‡çº§ï¼šå¯¹äºä¸€ä¸ªå½“å‰äº‹åŠ¡å·²ç»ä¸Šé”è¿‡çš„èµ„æºï¼š\nè¦è·å–çš„å’Œä¹‹å‰ä¸Šé”çš„ç±»å‹ä¸€è‡´ï¼Œç›´æ¥è¿”å›\nä¸å…è®¸å¤šä¸ªäº‹åŠ¡åŒæ—¶è¿›è¡Œé”å‡çº§ï¼Œé€šè¿‡ä¸€ä¸ªæ ‡å¿—ä½æ¥è¿›è¡Œåˆ¤æ–­\nå¦‚æœé”æ¨¡å‹ä¸ä¸€æ ·ï¼Œè€ƒè™‘å¯¹å…¶è¿›è¡Œå‡çº§ï¼Œå…è®¸çš„ç±»å‹å¦‚ä¸‹ï¼š\n1 2 3 4 * IS -\u0026gt; [S, X, IX, SIX] * S -\u0026gt; [X, SIX] * IX -\u0026gt; [X, SIX] * SIX -\u0026gt; [X] å¦‚æœå¯¹ä¸€ä¸ªäº‹åŠ¡æˆäºˆäº†ä¸€ä¸ªé”ï¼Œé‚£ä¹ˆéœ€è¦å¯¹äº‹åŠ¡çš„é”é›†åˆè¿›è¡Œé€‚å½“çš„æ›´æ–°\nUNLOCK NOTEâ€‹\nUnlockTable() UnlockRow()å°è¯•åœ¨æŸä¸€èµ„æºä¸Šé‡Šæ”¾é”ï¼Œéœ€è¦ç¡®ä¿å½“å‰äº‹åŠ¡æŒæœ‰è¯¥é”ï¼Œå¦‚æœæ²¡æœ‰æŒæœ‰è¯¥é”å°±é‡Šæ”¾åˆ™æŠ›å‡ºå¼‚å¸¸\nåªæœ‰åœ¨æ²¡æœ‰æŒæœ‰è¯¥Tableæ‰€ä¸‹å±çš„Tupleæ—¶ï¼Œæ‰èƒ½é‡Šæ”¾Tableä¸Šçš„é”ï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸\näº‹åŠ¡çŠ¶æ€æ›´æ–°ï¼šæ ¹æ®éš”ç¦»çº§åˆ«ï¼Œé‡Šæ”¾é”ä¼šå¯¼è‡´äº‹åŠ¡ä»GROWINGæƒ³SHRINKINGè½¬å˜ï¼Œåªæœ‰é‡Šæ”¾S/Xé”æ‰ä¼šæ”¹å˜äº‹åŠ¡çŠ¶æ€ã€‚\nREPEATABLE_READï¼šé‡Šæ”¾S/Xå¯¼è‡´è½¬å˜ä¸ºSHRINKING READ_COMMITTEDï¼šé‡Šæ”¾Xé”å¯¼è‡´å‘SHRINKINGè½¬å˜ï¼Œé‡Šæ”¾Sé”æ— å½±å“ READ_UNCOMMITEDï¼šé‡Šæ”¾Xé”å¯¼è‡´å‘SHRINKINGè½¬å˜ï¼ŒREAD_UNCOMMITTEDä¸æ”¯æŒSé” ç›¸å…³æ•°æ®ç»“æ„ LockRequestâ€‹\næ ¹æ®å½“ä¸­çš„grantedâ€‹å­—æ®µï¼Œå¯ä»¥ä»£è¡¨ä¸€æ¬¡ç”³è¯·è¯·æ±‚ï¼Œæˆ–è€…ä»£è¡¨å½“å‰Tableæˆ–è€…Tupleæ­£æŒæœ‰çš„é”\nLockRequestQueueâ€‹\nç»´æŠ¤LockRequestçš„é˜Ÿåˆ—ï¼Œä»£è¡¨ä¸€ä¸ªTableæˆ–è€…Tupleé”çš„ç”³è¯·å’ŒæŒæœ‰æƒ…å†µï¼ŒæŒ‰ç…§FIFOçš„é¡ºåºæ¥å¯¹é”è¿›è¡Œç”³è¯·ï¼Œé‡Šæ”¾é”æ—¶å°†å…¶ä»é˜Ÿåˆ—å½“ä¸­ç§»é™¤ã€‚\n**table_lock_map/row_lock_map_**â€‹\nç»´æŠ¤æ‰€æœ‰Tableï¼ŒRowçš„é”çš„æƒ…å†µï¼Œéå¹¶å‘å®‰å…¨ï¼Œéœ€è¦é€šè¿‡é”æ¥ä¿æŠ¤\nc++å½“ä¸­å¹¶æ²¡æœ‰ç±»ä¼¼Javaçš„ConcurrentHashMapï¼Œå› æ­¤å¤§å¤šæ•°æ•°æ®ç»“æ„éƒ½éœ€è¦æ‰‹åŠ¨åŠ é”è§£é”æ¥ç»´æŠ¤å¹¶å‘å®‰å…¨çš„é—®é¢˜ï¼Œæ— è®ºæ˜¯queueè¿˜æ˜¯map\nLock æ ¹æ®ä¸Šè¿°ï¼ŒåŸºæœ¬å¯ä»¥æ‹æ¸…æ¥šæ•´ä¸ªLockTableçš„è¿‡ç¨‹ï¼Œä¸»è¦åˆ†ä¸ºå‡ ä¸ªé˜¶æ®µï¼Œå‰å‡ ä¸ªé˜¶æ®µä¸€ç›´å°è¯•æŠ›å‡ºå¼‚å¸¸ï¼Œä¸­æ­¢æ‰ä¸€äº›ç‰¹æ®Šæƒ…å†µï¼Œä¹‹åæ‰å°è¯•å¯¹é”è¿›è¡Œè·å–ã€‚\n1.å¼‚å¸¸å¤„ç†\nå¯èƒ½æœ‰çš„å¼‚å¸¸ä¸ºï¼š\né”ç±»å‹ä¸æ”¯æŒï¼šREAD_UNCOMMITEDä¸‹å°è¯•è·å–S/IS/SIXï¼Œ é˜¶æ®µé”™è¯¯ï¼Œå³åœ¨Shrinkingé˜¶æ®µå°è¯•è·å–é”ï¼š REPEATBLE_READæ¡ä»¶ä¸‹å°è¯•è·å–ä»»æ„ç±»å‹çš„é” READ_COMMITTEDæ¡ä»¶ä¸‹è·å–X IX SIX READ_UNCOMMITTEDæ¡ä»¶ä¸‹è·å–ä»»æ„ç±»å‹çš„é” å¯¹äºLockRowï¼Œè¿˜æœ‰è¿˜æœªåœ¨Tableä¸ŠåŠ é”å°±åœ¨Rowä¸ŠåŠ é” 2.è·å–åˆ°Tableå¯¹åº”çš„LockRequestQueueâ€‹\né€šè¿‡é”ä¿æŠ¤å¹¶å‘å®‰å…¨ï¼Œå¦‚æœå­˜åœ¨åˆ™ç›´æ¥è·å–ï¼Œç„¶åé‡Šæ”¾é”ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºä¸€ä¸ªã€‚\nLockRequestQueueæ‰€è®°å½•çš„æ˜¯å¯¹äºä¸€ä¸ªTableä¸Šç›¸å…³çš„é”çš„æŒæœ‰æƒ…å†µï¼Œå³åªæœ‰ç¡®å®šéœ€è¦è¦ç”³è¯·é”ï¼Œæ‰å°†é”åŠ å…¥åˆ°å…¶ä¸­ï¼Œä¹‹ååªæœ‰é”é‡Šæ”¾çš„æ—¶å€™ï¼Œæ‰å°†å…¶ä»é˜Ÿåˆ—å½“ä¸­ç§»é™¤ï¼Œå› æ­¤ä¸»è¦èµ·åˆ°ä¸¤ä¸ªä½œç”¨ï¼š\nè®°å½•å½“å‰Tableå½“å‰Tableä¸Šé”çš„ç”³è¯·é¡ºåºï¼Œæ ¹æ®ç”³è¯·é¡ºåºæ¥ç¡®å®šæ˜¯å¦éœ€è¦æˆäºˆé”æˆ–è€…è¿›è¡Œé”å‡çº§ ç»´æŠ¤å·²ç»ç”³è¯·ä¸‹æ¥çš„é”ï¼Œæ§åˆ¶å¹¶å‘ï¼Œç›´è‡³é‡Šæ”¾é”æ—¶æ‰å°†å…¶ä»é˜Ÿåˆ—å½“ä¸­ç§»é™¤ è€Œå¦‚æœå½“ä¸­åªæœ‰ä¸€ä¸ªä¸”ä¸ºå½“å‰äº‹åŠ¡æ–°åˆ›å»ºçš„Lock_Reqeustçš„è¯ï¼Œåˆ™è¯æ˜å½“å‰æ²¡æœ‰ä»»ä½•ä¸€ä¸ªäº‹åŠ¡åœ¨å½“å‰èµ„æºä¸Šç”³è¯·é”æˆ–è€…æŒæœ‰é”ï¼Œé‚£ä¹ˆè‡ªå·±å°±æ˜¯ä¼˜å…ˆçº§æœ€é«˜çš„ï¼Œå³ä¸éœ€è¦ç­‰å¾…å…¶ä»–çš„é”æˆäºˆå®Œï¼Œä¹Ÿä¸éœ€è¦é”å‡çº§ï¼Œä¹Ÿä¸éœ€è¦æ£€æŸ¥æ˜¯å¦å†²çªï¼Œç›´æ¥æˆäºˆé”å³å¯ã€‚\n3.æ£€æŸ¥é”å‡çº§\nå¦‚ä¸Šé¢æ‰€è¯´ï¼Œè¯¥Tableçš„queueå½“ä¸­åŒæ—¶å­˜åœ¨ç”³è¯·é”å’ŒæŒæœ‰é”çš„è®°å½•ï¼Œæ ¹æ®grantedå­—æ®µæ¥åˆ¤æ–­\né¦–å…ˆåˆ¤æ–­æ˜¯å¦éœ€è¦è¿›è¡Œé”å‡çº§ï¼Œå³å½“å‰çš„äº‹åŠ¡ä¹‹å‰æ˜¯å¦æœ‰åœ¨è¯¥èµ„æºä¸ŠæŒæœ‰é”ï¼Œå¦‚æœæœ‰ï¼Œåˆ™è€ƒè™‘è¿›è¡Œé”å‡çº§ï¼Œå¦‚æœæ²¡æœ‰åˆ™è·³è¿‡è¿™ä¸€æ­¥ï¼Œç›´æ¥å°è¯•åŠ é”\né”å‡çº§çš„å‰ææ¡ä»¶ä¸ºå½“å‰æ²¡æœ‰ä»»ä½•å…¶ä»–çš„äº‹åŠ¡åœ¨è¿›è¡Œé”å‡çº§ï¼Œé€šè¿‡ä¸€ä¸ªæ ‡å¿—ä½æ¥åˆ¤æ–­ï¼Œå¦‚æœæœ‰åˆ™ä¸­æ­¢äº‹åŠ¡ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚è¯¥æ ‡å¿—ä½åœ¨è¿›è¡Œé”å‡çº§æ—¶ç½®ä¸ºå½“å‰äº‹åŠ¡çš„tidï¼Œåœ¨å®Œæˆé”å‡çº§ï¼Œå³è·å–åˆ°äº†é”ä¹‹åï¼Œç½®ä¸ºä¸€ä¸ªç©ºçš„tidã€‚\nåˆ°ç›®å‰å·²ç»æ»¡è¶³çš„é”å‡çº§çš„å¤–éƒ¨æ¡ä»¶ï¼Œå³å½“å‰äº‹åŠ¡ä¹‹å‰åœ¨è¯¥èµ„æºä¸ŠæŒæœ‰äº†ä¸€ä¸ªé”ï¼Œå¹¶ä¸”æ²¡æœ‰å…¶ä»–çš„äº‹åŠ¡æ­£åœ¨è¿›è¡Œé”å‡çº§ï¼Œæ­¤æ—¶éœ€è¦åˆ¤æ–­å†…éƒ¨æ¡ä»¶ï¼Œå³é”çš„ç±»å‹æ˜¯å¦æ»¡è¶³å‡çº§æ¡ä»¶ï¼š\n1 2 3 4 * IS -\u0026gt; [S, X, IX, SIX] * S -\u0026gt; [X, SIX] * IX -\u0026gt; [X, SIX] * SIX -\u0026gt; [X] å¦‚æœä¹‹å‰æŒæœ‰çš„é”çš„ç­‰çº§é«˜äºå½“å‰æŒæœ‰çš„é”ï¼Œé‚£ä¹ˆæ¸…ç©ºæ ‡å¿—ä½ï¼Œç»“æŸé”å‡çº§ï¼Œä¹Ÿä¸éœ€è¦æˆäºˆæ–°çš„é”ï¼Œç›´æ¥è¿”å›ã€‚ å¦‚æœå½“å‰çš„é”æ»¡è¶³å‡çº§æ¡ä»¶ï¼Œé‚£ä¹ˆé‡Šæ”¾ä¹‹å‰çš„é”ï¼Œå°†é”å‡çº§çš„è¿‡ç¨‹è§†ä¸ºä¸€æ¬¡æ–°çš„é”çš„è·å–ï¼Œè®¾ç½®å‡çº§çš„æ ‡å¿—ä½ï¼Œåœ¨ç¬¬ä¸€ä¸ªè¿˜æœªæˆäºˆçš„Lock_Reqeustä¹‹å‰æ·»åŠ ä¸€ä¸ªæ–°çš„LockRequestä»è€Œå¯ä»¥ä¿è¯å¯ä»¥ç«‹åˆ»å¯¹å…¶è¿›è¡Œé”å‡çº§ï¼Œå¦‚æœä¸æ»¡è¶³å‡çº§æ¡ä»¶ï¼Œåˆ™ä¸­æ­¢äº‹åŠ¡ï¼ŒæŠ›å‡ºå¼‚å¸¸ 4.è·å–é”â€‹\næˆ‘ç›®å‰åˆæ­¥çš„æƒ³æ³•æ˜¯å¦‚æœèƒ½æ‰§è¡Œåˆ°è¿™ä¸€æ­¥ï¼Œåˆ™è¯æ˜æ— éœ€è¿›è¡Œé”å‡çº§ï¼Œå¸¸è§„åŠ é”ï¼Œå³è·å–åˆ°èµ„æºå¯¹åº”çš„é˜Ÿåˆ—ï¼Œæ–°å»ºä¸€ä¸ªLockRequestè¯·æ±‚ï¼Œå°†å…¶æ·»åŠ åˆ°é˜Ÿåˆ—å½“ä¸­ã€‚ä¹‹åæ ¹æ®é˜Ÿåˆ—å½“ä¸­çš„é”æƒ…å†µæ¥è¿›è¡Œé”çš„è·å–ã€‚\næœ€å¼€å§‹æˆ‘çš„æƒ³æ³•æ˜¯å•ç‹¬åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œä¸æ–­çš„å»è½®è¯¢æ‰€æœ‰é˜Ÿåˆ—ï¼Œå¦‚æœå‘ç°å¯ä»¥æˆäºˆé”ï¼Œé‚£ä¹ˆåˆ™æˆäºˆé”ï¼Œå¹¶é€šè¿‡æ¡ä»¶å˜é‡æ¥é€šçŸ¥è°ƒç”¨Lockçš„çº¿ç¨‹ï¼Œå‘ŠçŸ¥å…¶å·²ç»æˆäºˆé”ï¼Œå¯ä»¥ä»é˜»å¡å½“ä¸­è‹é†’è¿”å›ï¼Œè€Œè°ƒç”¨Unlockçš„çº¿ç¨‹åªéœ€è¦é‡Šæ”¾é”ï¼Œä¸éœ€è¦ä¼ é€’æˆ–è€…å‘å‡ºä»»ä½•ä¿¡å·ã€‚æ•´ä½“å®ç°ä¸Šæœ‰ç‚¹åƒ6.824å½“ä¸­æ—¥å¿—æäº¤å‘ä¸Šå±‚å‘ŠçŸ¥Applyä¿¡æ¯çš„è¿‡ç¨‹ï¼Œä½†æ˜¯åæ¥æƒ³äº†æƒ³ï¼Œä¹Ÿçœ‹äº†ä¸€ä¸‹åˆ«äººçš„åšå®¢çš„æ€è·¯ï¼Œæ„Ÿè§‰æ²¡å¿…è¦é‚£ä¹ˆéº»çƒ¦ã€‚ä¿¡å·å‘é€çš„å·¥ä½œäº¤ç»™è°ƒç”¨Unlockçš„çº¿ç¨‹å³å¯ï¼Œå¤§è‡´æ€è·¯å¦‚ä¸‹ï¼š\nè°ƒç”¨Lockå°†æ–°åˆ›å»ºçš„LockRequeståŠ å…¥åˆ°é˜Ÿåˆ—å½“ä¸­ ä¹‹åé€šè¿‡æ¡ä»¶å˜é‡çš„å½¢å¼ï¼Œåå¤åˆ¤æ–­æ˜¯å¦æ»¡è¶³è·å–é”çš„æ¡ä»¶ï¼Œå¦‚æœä¸æ»¡è¶³åˆ™é€šè¿‡æ¡ä»¶å˜é‡é˜»å¡ å¦‚æœæœ‰å…¶ä»–çš„çº¿ç¨‹é‡Šæ”¾é”äº†ï¼Œé€šè¿‡notify_allè¿›è¡Œé€šçŸ¥ï¼Œé‚£ä¹ˆæ­¤æ—¶å°±ä¼šä»é˜»å¡å½“ä¸­æ¢å¤ï¼Œé‡æ–°åˆ¤æ–­ä¸€æ¬¡æ˜¯å¦èƒ½å¤ŸåŠ é”ï¼Œå¦‚æœèƒ½åˆ™åŠ é”å¹¶è¿”å›ä¸€ä¸ªfalseï¼Œè·³è¿‡æ¡ä»¶å˜é‡ï¼Œåç»­ç›´æ¥è¿”å› GrantLock\nå•ç‹¬å°è£…æˆä¸€ä¸ªå‡½æ•°ï¼Œåœ¨ä½œä¸ºæ¡ä»¶å˜é‡whileçš„è¿›å…¥æ¡ä»¶ï¼Œéå†å½“å‰çš„é˜Ÿåˆ—ï¼Œå¦‚æœåœ¨æ­¤æ¬¡ç”³è¯·çš„é”ä¹‹å‰è¿˜æœ‰æœªæˆäºˆçš„é”(granted == false)ï¼Œé‚£ä¹ˆæ— æ³•æˆäºˆï¼Œè¿”å›falseï¼Œäº¤ç»™æ¡ä»¶å˜é‡å»ç­‰å¾…ã€‚å¦‚æœå½“å‰çš„é”ä¸ºé˜Ÿåˆ—å½“ä¸­ç¬¬ä¸€ä¸ªæœªæˆäºˆçš„ï¼Œé‚£ä¹ˆåˆ¤æ–­æ˜¯å¦å…¼å®¹ï¼Œå¦‚æœä¸å…¼å®¹åˆ™è¿”å›falseï¼Œç­‰å¾…å‘ç”Ÿå†²çªçš„é”é‡Šæ”¾ï¼Œå…¼å®¹åˆ™è¿”å›trueï¼Œæˆäºˆé”å¹¶è·³è¿‡æ¡ä»¶å˜é‡ã€‚\nåœ¨è°ƒç”¨GrantLockæ—¶é˜Ÿåˆ—å½“ä¸­è‡³å°‘å­˜åœ¨ä¸€ä¸ªlock_requestï¼Œå³å½“å‰äº‹åŠ¡æ–°åˆ›å»ºçš„ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è¯æ˜å‡ºç°äº†é—®é¢˜ï¼Œè¿”å›false\nUnlock Unlockçš„æ€è·¯æ¯”è¾ƒç®€å•ï¼Œé¦–å…ˆåŒæ ·å…ˆå¤„ç†å¼‚å¸¸æƒ…å†µï¼Œå¦‚æœunlockæ—¶å‘ç°åœ¨å¯¹åº”çš„èµ„æºä¸ŠæœªæŒæœ‰é”ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚å¯¹äºUnlockTableè¿˜éœ€è¦æ£€æŸ¥æ˜¯å¦æœ‰è¯¥Tableå¯¹åº”çš„Rowä¸Šé¢çš„é”è¿˜æœªé‡Šæ”¾ï¼Œå¦‚æœæœ‰ï¼ŒæŠ›å‡ºå¼‚å¸¸\nä¹‹åå³å¯éå†é˜Ÿåˆ—ï¼Œæ‰¾åˆ°å½“å‰äº‹åŠ¡æŒæœ‰çš„é”ï¼Œå°†å…¶é‡Šæ”¾ï¼Œé€šçŸ¥å…¶ä»–çº¿ç¨‹ï¼Œè®©å…¶é‡æ–°è¿›è¡Œä¸€æ¬¡ç«äº‰ï¼Œå°è¯•è·å–é”ï¼Œæœ€åæ ¹æ®é”çš„ç±»å‹å’Œéš”ç¦»çº§åˆ«æ¥åˆ¤æ–­æ˜¯å¦è½¬æ¢ä¸ºSHRINKINGã€‚\nå½“äº‹åŠ¡æäº¤æˆ–è€…ä¸­æ­¢æ—¶ï¼Œä¼šå°†å½“å‰äº‹åŠ¡æŒæœ‰çš„æ‰€æœ‰çš„é”è¿›è¡Œé‡Šæ”¾ï¼Œå› æ­¤éœ€è¦é›†åˆæ¥ç»´æŠ¤å½“å‰äº‹åŠ¡æ‰€æŒæœ‰çš„æ‰€æœ‰çš„é”ï¼Œåœ¨äº‹åŠ¡ç±»å½“ä¸­å·²ç»ç»™å‡ºï¼Œå› æ­¤åœ¨lock unlockçš„è¿‡ç¨‹å½“ä¸­ï¼Œä¸€æ—¦é”çš„æŒæœ‰æƒ…å†µæœ‰å˜åŒ–ï¼Œå°±å¯¹å¯¹åº”çš„é›†åˆè¿›è¡Œæ›´æ–°ã€‚\nTask2 - Deadlock Detection é€šè¿‡ä¸€ä¸ªåå°çº¿ç¨‹å»ä¸æ–­çš„æ£€æµ‹æ˜¯å¦å­˜åœ¨æ­»é”ï¼Œå»ºç«‹ä¸€ä¸ªç›¸äº’ç­‰å¾…çš„å›¾ï¼Œå»å‘ç°æ˜¯å¦å­˜åœ¨å¾ªç¯ï¼Œå¦‚æœå­˜åœ¨åˆ™è¯æ˜æœ‰æ­»é”ï¼Œæ‰“ç ´å¾ªç¯\nç›¸å…³APIï¼š\nAddEdge(t1,t2)â€‹ï¼šæ·»åŠ ä¸€æ¡ä»t1åˆ°t2çš„è¾¹ï¼Œå¦‚æœå­˜åœ¨çš„è¯å°±ä»€ä¹ˆéƒ½ä¸éœ€è¦åš RemoveEdge(t1,t2)â€‹ï¼šå¦‚æœå­˜åœ¨åˆ™ç§»é™¤ä¸€æ¡è¾¹ HasCycle(txn_id)â€‹ï¼šé€šè¿‡dfså»å¯»æ‰¾æ˜¯å¦å­˜åœ¨å¾ªç¯ï¼Œå¦‚æœå­˜åœ¨å¾ªç¯ï¼Œåˆ™å­˜å‚¨å¾ªç¯å½“ä¸­æœ€æ–°çš„äº‹åŠ¡idï¼Œå¹¶è¿”å›trueï¼Œå¹¶ä¸”è¿”å›æ‰¾åˆ°çš„ç¬¬ä¸€ä¸ªå¾ªç¯ GetEdgeList()â€‹ï¼šè¿”å›æ‰€æœ‰å­˜åœ¨çš„è¾¹ï¼Œç”¨äºè¿›è¡Œç»“æœæ£€æµ‹ RunCycleDetection()â€‹ï¼šå¾ªç¯æ£€æµ‹çš„ä¸»ä½“ Hintâ€‹\nä¸éœ€è¦ç»´æŠ¤ä¸€ä¸ªå›¾ï¼Œæ¯å½“åå°çº¿ç¨‹å”¤é†’æ—¶å»ºç«‹ä¸€ä¸ªè¡¨ï¼Œä¹‹åé”€æ¯ ä¸ºä¿è¯dfsçš„ç¡®å®šæ€§ï¼Œæ¯æ¬¡é€‰æ‹©æœ€ä½çš„äº‹åŠ¡idä¸ºç¬¬ä¸€ä¸ªï¼Œè€Œä¸‹ä¸€ä¸ªè¿›è¡Œéå†çš„ä¹Ÿé€‰æ‹©æœ€ä½çš„äº‹åŠ¡id çº¿ç¨‹å”¤é†’æ—¶ï¼Œéœ€è¦æ‰“ç ´æ‰€æœ‰çš„å¾ªç¯ å¯¹äºä¸­æ­¢çš„äº‹åŠ¡ï¼Œä¸åŠ ä»¥è€ƒè™‘ï¼Œä¸ç”»è¾¹å’ŒèŠ‚ç‚¹ é€šè¿‡é™æ€GetTransactionâ€‹æ–¹æ³•æ¥è·å–ä¸€ä¸ªäº‹åŠ¡çš„æŒ‡é’ˆ std::this_thread::sleep_forâ€‹è¿›è¡Œä¼‘çœ ï¼Œæ—¶é•¿ä¸ºCYCLE_DETECTION_INTERVALâ€‹ å½“ä¸€ä¸ªäº‹åŠ¡ç­‰å¾…å¦å¤–ä¸€ä¸ªäº‹åŠ¡æ—¶ï¼Œæ·»åŠ ä¸€æ¡è¾¹ï¼Œå¯èƒ½ä¼šæœ‰å¤šä¸ªäº‹åŠ¡åœ¨åŒä¸€ä¸ªå¯¹è±¡ä¸ŠæŒæœ‰é”ï¼Œå› æ­¤å­˜åœ¨ä¸€ç­‰å¤šçš„æƒ…å†µ äº‹åŠ¡ä¸­æ­¢æ—¶ï¼Œéœ€è¦å°†Stateè®¾ç½®ä¸ºABORTEDâ€‹ å½“ä¸€ä¸ªäº‹åŠ¡ä¸­æ­¢æ—¶ï¼Œéœ€è¦é€šçŸ¥è¯¥äº‹åŠ¡è¢«ä¸­æ­¢ Task2çš„æ ¸å¿ƒå°±æ˜¯dfsï¼Œé€šè¿‡dfsåœ¨æœ‰å‘å›¾å½“ä¸­æ£€æµ‹æ˜¯å¦æœ‰ç¯ï¼Œé¦–å…ˆæ‰«æå½“å‰çš„é”æƒ…å†µï¼Œé€šè¿‡ä¸€ä¸ªé›†åˆè®°å½•å½“å‰æ‰€æœ‰çš„äº‹åŠ¡çš„tidï¼Œç”±äºéœ€è¦ä¿è¯dfsçš„ç»“æœæ˜¯ç¡®å®šçš„ï¼Œå› æ­¤æ¯æ¬¡ä»æœ€å°çš„txn_idï¼Œå³æœ€æ—©åˆ›å»ºçš„äº‹åŠ¡å¼€å§‹éå†ï¼Œå½“éå†åˆ°ä¸€ä¸ªtxn_idä¹‹åï¼Œå°±å°†å…¶åŠ å…¥åˆ°æ´»è·ƒé›†åˆå½“ä¸­ï¼Œå¦‚æœåç»­çš„æœç´¢è¿‡ç¨‹å½“ä¸­å†æ¬¡æ‰¾åˆ°äº†è¯¥é›†åˆï¼Œé‚£ä¹ˆå°±è¯æ˜å‡ºç°äº†ç¯ï¼Œæ­¤æ—¶æŒ‘é€‰ä¸€ä¸ªæœ€æ–°çš„äº‹åŠ¡ï¼Œå³txn_idæœ€å¤§çš„äº‹åŠ¡è¿›è¡Œä¸­æ­¢ã€‚dfsç»“æŸä¹‹åï¼Œå°±å°†å…¶ä»æ´»è·ƒæ•°ç»„å½“ä¸­æ¸…é™¤ï¼Œå¹¶ä¸”å¯ä»¥å°†å…¶æ·»åŠ åˆ°å®‰å…¨é›†åˆå½“ä¸­ï¼Œä¹‹ååœ¨å¯¹å…¶ä»–çš„èŠ‚ç‚¹è¿›è¡Œåˆ¤æ–­æ—¶ï¼Œåªè¦éå†åˆ°è¯¥èŠ‚ç‚¹ï¼Œå°±è¯æ˜åç»­å¹¶ä¸å­˜åœ¨ç¯ï¼Œå¯ä»¥ç›´æ¥è¿”å›ã€‚\nå½“å‘ç°äº†æ­»é”ï¼Œå¹¶å°†äº‹åŠ¡è®¾ç½®ä¸­æ­¢ä¹‹åï¼Œé€šçŸ¥æ­£åœ¨ç­‰å¾…é”çš„äº‹åŠ¡ï¼Œæ­¤æ—¶è‹é†’ä¹‹åéœ€è¦æ£€æŸ¥å½“å‰äº‹åŠ¡çš„çŠ¶æ€æ˜¯å¦ä¸­æ­¢ï¼Œå¦‚æœä¸­æ­¢ï¼Œåˆ™ç»“æŸåŠ é”çš„è¿‡ç¨‹ï¼Œç›´æ¥è¿”å›ã€‚\nè¯¥åå°çº¿ç¨‹ä¼šå’Œæ­£åœ¨è·å–å’Œé‡Šæ”¾é”çš„çº¿ç¨‹ä¹‹é—´å­˜åœ¨å¹¶å‘å®‰å…¨é—®é¢˜ï¼Œè®¿é—®ç›¸å…³æ•°æ®ç»“æ„æ—¶éœ€è¦åŠ é”ä¿æŠ¤ã€‚\nTask3 - Concurrent Query Execution å¯¹ä¹‹å‰çš„Next() æ–¹æ³•è¿›è¡Œä¿®æ”¹ï¼Œå½“äº‹åŠ¡è¿›è¡Œä¸Šé”å’Œè§£é”å¤±è´¥æ—¶ï¼Œåº”å½“æŠ›å‡ºå¼‚å¸¸ã€‚\nå½“äº‹åŠ¡ä¸­æ­¢æ—¶ï¼Œéœ€è¦å¯¹è¯¥äº‹åŠ¡æ¶‰åŠåˆ°çš„tableä¸Šçš„tuple è¿˜æœ‰indexè¿›è¡Œundoæ“ä½œï¼Œé€šè¿‡åœ¨äº‹åŠ¡å½“ä¸­ç»´æŠ¤ä¸€ä¸ªå†™é›†åˆæ¥å®ç°ï¼Œå½“äº‹åŠ¡ç»ˆæ­¢æ—¶ï¼Œå°†è¯¥é›†åˆä¼ é€’ç»™Abort\nè·å–é”å¤±è´¥æ—¶ï¼Œåº”è¯¥æŠ›å‡ºExecutionExceptionâ€‹å¼‚å¸¸ï¼Œå‘ŠçŸ¥ä¸Šå±‚ã€‚\nåœ¨ä¸€ä¸ªäº‹åŠ¡å½“ä¸­ï¼Œåº”å½“è€ƒè™‘ä¼šå¯¹æ•°æ®è¿›è¡Œå¤šæ¬¡æŸ¥è¯¢ï¼Œé’ˆå¯¹ä¸åŒçš„éš”ç¦»çº§åˆ«è¿›è¡Œå¤„ç†\nåœ¨åŠ é”ä¸Šï¼Œç”±äºæ”¯æŒäº†æ„å‘é”ï¼Œå› æ­¤åœ¨Initæ–¹æ³•å½“ä¸­å…ˆé€šè¿‡æ„å‘é”é”ä½æ•´ä¸ªè¡¨ï¼Œä¹‹ååœ¨Nextæ–¹æ³•å½“ä¸­åœ¨åŠ å†™é”æˆ–è€…è¯»é”é”ä½å•ä¸ªTupleã€‚æ ¹æ®éš”ç¦»çº§åˆ«å†è€ƒè™‘åˆé€‚é‡Šæ”¾æ‰é”ã€‚\néš”ç¦»çº§åˆ«â€‹\nREPEATABLE_READï¼šé‡‡ç”¨ä¸¥æ ¼ä¸¤é˜¶æ®µé”åè®®ï¼Œå› æ­¤åªåŠ é”ä¸è§£é”ï¼Œæœ€ç»ˆç”±commitæˆ–è€…abortç»Ÿä¸€é‡Šæ”¾é”ï¼Œåœ¨Initå½“ä¸­åŠ è¡¨çº§çš„æ„å‘é”ï¼Œåœ¨Nextå½“ä¸­å¯¹TupleåŠ è¯»å†™é” READ_COMMITTEDï¼šåœ¨Initå½“ä¸­åŠ è¡¨çº§çš„æ„å‘é”ï¼Œåœ¨Nextå½“ä¸­æ·»åŠ è¡Œçº§åˆ«çš„é”ï¼Œå¯¹äºSé”ï¼Œè¯»å–å®Œå°±å¯ä»¥é‡Šæ”¾ï¼Œæ— è®ºæ˜¯å¦ä¸ºGrowingã€‚Xé”ä¸ºä¿è¯å¯¹å¤–éš”ç¦»ï¼Œéœ€è¦åœ¨äº‹åŠ¡æäº¤æ—¶è¿›è¡Œé‡Šæ”¾ã€‚å¯ä»¥ä¿è¯è¯»å–åˆ°çš„éƒ½æ˜¯å·²ç»æäº¤çš„æ•°æ®ï¼Œä½†æ˜¯æ— æ³•æä¾›å¯é‡å¤è¯»ï¼Œåœ¨ä¸€æ¬¡äº‹åŠ¡å½“ä¸­çš„è¯»å–çš„æ•°æ®å¹¶ä¸ä¸€è‡´ã€‚ READ_UNCOMMITTEDï¼šè¯»æ“ä½œæ— éœ€åŠ é”ï¼Œå› æ­¤ä¼šè¯»å–åˆ°å†™å…¥ä½†æ˜¯è¿˜æœªæäº¤çš„æ•°æ®ï¼Œå†™æ“ä½œåœ¨Initå½“ä¸­åŠ æ„å‘é”ï¼ŒNextå½“ä¸­åŠ Xé”ï¼Œæœ€åç”±äº‹åŠ¡ç»Ÿä¸€é‡Šæ”¾ã€‚ åœ¨æ‰§è¡Œå™¨å½“ä¸­ï¼Œä¼šæ¥æ”¶åˆ°åŠ é”\\è§£é”æ“ä½œä»ä¸‹å±‚æŠ›å‡ºçš„å¼‚å¸¸ï¼Œå› æ­¤éœ€è¦æ•è·ä¸‹å±‚çš„å¼‚å¸¸ï¼Œå¹¶é‡æ–°å¯¹å¤–æŠ›å‡ºä¸€ä¸ªç»Ÿä¸€çš„å¼‚å¸¸ï¼Œå¹¶ä¸”åŠ é”\\è§£é”æ“ä½œä¹Ÿå¯èƒ½ä¼šå¤±è´¥ï¼Œå¦‚æœå¤±è´¥åŒæ ·éœ€è¦å‘ä¸ŠæŠ›å‡ºä¸€ä¸ªåŠ é”å¤±è´¥çš„å¼‚å¸¸ï¼Œå› æ­¤åŠ é”çš„å½¢å¼å¤§è‡´å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 try { if (exec_ctx_-\u0026gt;GetTransaction()-\u0026gt;GetIsolationLevel() != IsolationLevel::READ_UNCOMMITTED) { auto is_locked = exec_ctx_-\u0026gt;GetLockManager()-\u0026gt;LockTable( exec_ctx_-\u0026gt;GetTransaction(), LockManager::LockMode::INTENTION_SHARED, table_info_-\u0026gt;oid_); if (!is_locked) { throw ExecutionException(\u0026#34;SeqScan Executor Get Table Lock Failed\u0026#34;); } } // LOG_DEBUG(\u0026#34;SeqScan Init::table_name:%s table_id,%d\u0026#34;, table_info_-\u0026gt;name_.c_str(), table_info_-\u0026gt;oid_); } catch (TransactionAbortException e) { throw ExecutionException(\u0026#34;SeqScan Executor Get Table Lock Failed \u0026#34; + e.GetInfo()); } éš”ç¦»çº§åˆ« åœ¨Task1å’ŒTask3ä¸Šï¼Œåœ¨æ³¨é‡Šå½“ä¸­å·²ç»ç»™å‡ºäº†éå¸¸è¯¦ç»†çš„åŠ é”è§£é”ä»¥åŠå„ç§æ–¹å‘ä¸Šçš„æŒ‡å¯¼ï¼Œåªè¦å°†å…¶ç¿»è¯‘æˆä»£ç çº§åˆ«ä¸Šæ•´ä¸ªLabå°±å®ç°å¥½äº†ã€‚åŸºæœ¬ä¸Šä¸æ€ä¹ˆéœ€è¦ç‰¹åˆ«çš„åŠ¨è„‘å­ï¼Œå…¨ç¨‹è¢«å–‚é¥­ï¼ŒåŠ ä¸Šä¸ªäººåŸºç¡€ä¸å¤ªå¥½ï¼Œå› æ­¤æ„Ÿè§‰è¿˜æ˜¯æœ‰å¿…è¦æ‹é¡ºä¸€ä¸‹å››ç§éš”ç¦»çº§åˆ«åœ¨å®ç°ä¸Šçš„ä¸åŒï¼Œä»¥åŠå„è‡ªé’ˆå¯¹çš„æƒ…å†µã€‚\nå››ç§éš”ç¦»çº§åˆ«çš„å·®åˆ«ä¸»è¦èšç„¦äºè¯»æ“ä½œä¸Šï¼Œå¯¹äºå†™æ“ä½œï¼Œä¸ºäº†ä¿è¯æ•°æ®åº“ä¸€è‡´æ€§ï¼Œåªæœ‰å†™å…¥çš„é”åªæœ‰æ•°æ®æäº¤æ—¶æ‰èƒ½å¤Ÿé‡Šæ”¾ï¼Œå¦‚æœä¸­é€”é‡Šæ”¾é”ï¼Œå†™å…¥çš„æ“ä½œç»“æœå¯èƒ½ä¼šè¢«å…¶ä»–çš„è¦†ç›–ï¼Œä»è€Œè¿åäº†æ•°æ®åº“ä¸€è‡´æ€§ã€‚å•ç‹¬çœ‹å†™é”çš„è¯ï¼Œéƒ½æ˜¯é‡‡ç”¨äº†ä¸¥æ ¼ä¸¤é˜¶æ®µé”çš„ç­–ç•¥ï¼Œä¿è¯ä¸€è‡´æ€§ï¼ŒåŒæ—¶é¿å…çº§è”ä¸­æ­¢ã€‚\nREAD UNCOMMITTEDâ€‹\næœ€å®½æ¾çš„éš”ç¦»çº§åˆ«ï¼Œæ ¹æ®ä¸Šè¡¨å¯ä»¥çœ‹åˆ°è„è¯» ä¸å¯é‡å¤è¯» å¹»è¯»éƒ½ä¼šå‘ç”Ÿ\nåœ¨å®ç°ä¸Šè¯»æ“ä½œä¸éœ€è¦åŠ é”ï¼Œå†™æ“ä½œå’Œå…¶ä»–çš„ä¸€è‡´ï¼Œå› æ­¤æ‰€æœ‰è¯»ç›¸å…³çš„é”éƒ½ä¸æ”¯æŒï¼Œå¦‚æœæƒ³å°è¯•åŠ [S,IS,SIX]ï¼Œéƒ½ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚ç”±äºåªæ”¯æŒå†™é”ï¼Œåœ¨shrinkingé˜¶æ®µï¼Œä»»ä½•åŠ é”æ“ä½œéƒ½æ˜¯ä¸å…è®¸çš„ï¼Œä¼šæŠ›å‡ºå¼‚å¸¸ã€‚\nå› æ­¤å¹¶ä¸ä¿è¯è¯»å–åˆ°çš„æ•°æ®ä¸€å®šæ˜¯æäº¤çš„æ•°æ®ï¼Œç”±äºå¹¶æ²¡æœ‰åŠ è¯»é”å’Œå…¶ä»–çš„äº‹åŠ¡è¿›è¡Œäº’æ–¥ï¼Œå…¶ä»–çš„äº‹åŠ¡ä¸€æ—¦å†™å…¥ä¹‹åå°±å¯ä»¥è¢«è¯»å–ï¼Œå› æ­¤å½“è¯»å–åˆ°ä¹‹åï¼Œå¦‚æœå†™å…¥æ•°æ®çš„äº‹åŠ¡ä¸­æ­¢å›æ»šï¼Œé‚£ä¹ˆè¯»å–åˆ°çš„æ•°æ®å°±å˜æˆäº†è„æ•°æ®äº§ç”Ÿè„è¯»ã€‚\nREAD COMMITTEDâ€‹\nç›¸æ¯”äºè¯»æœªæäº¤è§£å†³äº†è„è¯»çš„é—®é¢˜ï¼Œä½†æ˜¯ä¾æ—§ä¼šå‡ºç°ä¸å¯é‡å¤è¯»å’Œå¹»è¯»\nåœ¨å®ç°ä¸Šè¯»æ“ä½œéœ€è¦åœ¨Tableä¸ŠåŠ ISï¼Œåœ¨Rowä¸ŠåŠ Sï¼Œå¹¶ä¸”å½“å®Œæˆä¸€æ¬¡è¯»å–ä¹‹åå³å¯å°†é”é‡Šæ”¾ï¼Œæ— éœ€ç­‰å¾…äº‹åŠ¡çš„æäº¤ã€‚é‡Šæ”¾Sé”å¹¶ä¸ä¼šå¯¼è‡´äº‹åŠ¡ä»growingå‘shrinkingè½¬å˜ã€‚\nç”±äºé€šè¿‡Sé”è¿›è¡Œäº’æ–¥ï¼Œä»è€Œä¿è¯é‚£äº›æ­£åœ¨å†™å…¥çš„äº‹åŠ¡åœ¨æäº¤å‰ä¸åº”è¢«è¯»å–åˆ°ï¼Œèƒ½å¤Ÿè¯»å–åˆ°çš„æ•°æ®ä¸€å®šæ˜¯æäº¤ä¹‹åç¨³å®šå†™å…¥çš„æ•°æ®ã€‚\nREPEATABLE READâ€‹\nåœ¨è¯»æäº¤çš„åŸºç¡€ä¸Šåˆè§£å†³äº†ä¸å¯é‡å¤è¯»çš„é—®é¢˜ï¼Œå­˜åœ¨å¹»è¯»ã€‚\nå®ç°ä¸ŠåŠ é”ç­–ç•¥å’ŒREAD COMMITTEDå¹¶æ²¡æœ‰åŒºåˆ«ï¼Œä½†æ˜¯åœ¨é‡Šæ”¾é”ä¸Šè¯»å†™é”å…¨éƒ¨é‡‡ç”¨ä¸¥æ ¼ä¸¤é˜¶æ®µé”çš„ç­–ç•¥ï¼Œæ­¤æ¬¡äº‹åŠ¡ä¼šä¸€ç›´æŒæœ‰è¯»é”ï¼Œä»è€Œä¸­é€”ä¸å¯èƒ½è¢«å…¶ä»–çš„äº‹åŠ¡é‡æ–°å†™å…¥æ›´æ–°ï¼Œåœ¨ä¸€æ¬¡äº‹åŠ¡å½“ä¸­è¯»å–çš„æ•°æ®å…¨éƒ¨ä¸ºä¸€è‡´çš„ã€‚\nshrinkingé˜¶æ®µä¸å…è®¸æ·»åŠ ä»»ä½•çš„é”ï¼Œé‡Šæ”¾S Xé”å°±ä¼šå‘shrinkingè¿›è¡Œè½¬å˜ã€‚\nå¯ä¸²è¡ŒåŒ–\næœ€ä¸¥æ ¼çš„éš”ç¦»çº§åˆ«ï¼Œç®€å•æ¥è¯´å°±æ˜¯åœ¨è¯¥éš”ç¦»çº§åˆ«ä¸‹ï¼Œäº‹åŠ¡çš„æ‰§è¡Œå¯ä»¥ç­‰ä»·æˆä¸€æ¬¡ä¸å­˜åœ¨å¹¶å‘çš„ä¸²è¡Œæ‰§è¡Œã€‚æœ€ç®€å•çš„åˆ¤æ–­æ˜¯å¦ä¸ºå¯ä¸²è¡ŒåŒ–çš„æ–¹æ³•å°±æ˜¯äº¤æ¢ä¸€ç³»åˆ—ä¸å†²çªçš„æŒ‡ä»¤ï¼Œä»è€Œçœ‹åŸæœ¬çš„äº‹åŠ¡è°ƒåº¦æ˜¯å¦å¯ä»¥è¢«åˆ†ä¸ºä¸¤ä¸ªåœ¨æ—¶é—´ä¸Šå®Œå…¨é”™å¼€çš„ä¸²è¡Œè°ƒåº¦ï¼Œç®€å•ç”¨è¯»å†™æ¥è¡¨ç¤ºï¼Œä¸€æ¬¡é€šè¿‡äº¤æ¢æˆ–é‡æ‹è½¬æ¢æˆä¸²è¡Œç»“æœå¦‚ä¸‹ï¼š\nSummary æ•´ä¸ªLab4å¤§è‡´å°±æ˜¯è¿™æ ·ï¼Œç”±äºå‡ å¤©åå°±è¦è€ƒè¯•å› æ­¤æ•´ä¸ªLab4åšçš„æ¯”è¾ƒç²—ç³™ï¼Œè®°å½•å†™çš„ä¹Ÿå¾ˆç²—ç³™ã€‚åªå®ç°äº†æœ€åŸºæœ¬çš„åŠŸèƒ½ï¼Œèƒ½å¤Ÿé€šè¿‡æ‰€æœ‰æµ‹è¯•ï¼ŒæœŸé—´è¿˜å› ä¸ºä¸€ä¸ªæ™ºèƒ½æŒ‡é’ˆçš„é—®é¢˜å¡äº†å¾ˆä¹…ï¼Œä¸è¿‡æœªç»ä¼˜åŒ–çš„QPSå‡ ä¹å«åº•ï¼Œä¸è¿‡ç›®å‰ä¹Ÿæ²¡æœ‰æ—¶é—´åšä»€ä¹ˆä¼˜åŒ–äº†ï¼Œåªèƒ½æš‚æ—¶æç½®äº†ã€‚ä¸è¿‡è¿™ä¹Ÿç®—æ˜¯æˆ‘ç”¨cppå†™çš„å¤´ä¸€ä¸ªæ¯”è¾ƒå®Œæ•´çš„é¡¹ç›®ï¼Œä¹Ÿç®—æ˜¯å…‹æœäº†å¯¹cppçš„ææƒ§ã€‚åç»­çš„è¯ç²¾åŠ›åº”è¯¥ä¸»è¦æ”¾åœ¨æœºè¯•å’Œ408å¤ä¹ ä¸Šäº†ï¼Œ928å‰åº”è¯¥ä¸æ‰“ç®—å¼€æ–°çš„Labäº†ï¼Œåç»­å¤ä¹ çš„é¢å¤–æ—¶é—´æ‰“ç®—çœ‹ä¸€çœ‹rocksdbå’Œä¸€äº›c++è¿˜æœ‰cmakeç›¸å…³çš„å·¥ç¨‹åŸºç¡€ã€‚\n","permalink":"https://fischer0522.github.io/en/posts/tech/bustub/bustub-lab4/","summary":"Lab4 ç”±äºäº”ä¸€ä¸´è¿‘è€ƒè¯•ï¼Œå†åŠ ä¸Šåç»­è¿˜éœ€è¦å‡†å¤‡å„ç§æœºè¯•ä»¥åŠ408ç­‰ï¼Œæ•´ä¸ªLab4åšçš„æ¯”è¾ƒçš„è‰ç‡ï¼ŒåŸºæœ¬ä¸Šåªå®ç°äº†æœ€åŸºç¡€çš„åŠŸèƒ½ï¼ŒLeaderboard","title":"BusTub-Lab4"},{"content":"Lab3 Task1 ç«å±±æ¨¡å‹ åœ¨Task1å½“ä¸­å®ç°äº†SeqScanâ€‹ Insertâ€‹ Deleteâ€‹ IndexScanâ€‹ï¼Œç”±äºå‡ä¸ºç«å±±æ¨¡å‹ï¼Œå› æ­¤åœ¨å®ç°ä¸Šå¤§åŒå°å¼‚ï¼Œå°±é›†ä¸­è¯´æ˜ä¸€ä¸‹ç«å±±æ¨¡å‹ï¼Œå’Œå„è‡ªæ‰€éœ€è¦æ³¨æ„çš„å³å¯ã€‚\nç«å±±æ¨¡å‹ï¼Œæˆ–è€…è¯´è¿­ä»£å™¨æ¨¡å‹ï¼Œæ ¸å¿ƒå°±æ˜¯å€ŸåŠ©è¿­ä»£å™¨è¿›è¡Œéå†ã€‚å³å¯¹äºä¸€ä¸ªç®—å­æ¥è¯´ï¼Œè‡ªèº«å³ä¸ºä¸€ä¸ªè¿­ä»£å™¨ï¼Œå¯¹å¤–æä¾›ä¸€ä¸ªNextæ–¹æ³•ï¼Œå°†æ•°æ®å¤„ç†åé€šè¿‡Nextæ–¹æ³•ä¸€æ¡æ¡ç»™å¯¹å¤–æä¾›ã€‚ä»¥SeqScanä¸ºä¾‹ï¼Œæ¯æ¬¡è°ƒç”¨Nextéƒ½ä»tableå½“ä¸­è·å–ä¸€æ¡tupleï¼Œä¹‹åäº¤ç»™ä¸Šå±‚ã€‚\nè€Œå¤šä¸ªè¿­ä»£å™¨å¯ä»¥ç»„æˆè¿­ä»£å™¨é“¾ï¼Œä¸Šå±‚é€šè¿‡ä¸‹å±‚çš„è¿­ä»£å™¨çš„Nextå‡½æ•°æ¥è·å–tupleï¼Œå¤„ç†ä¹‹ååˆé€šè¿‡è‡ªèº«çš„è¿­ä»£å™¨å¯¹å¤–è¿”å›ã€‚å°±åƒä¸‹å›¾è¿™æ ·ï¼ŒNestedLoopJoinä»¥ MockTableScanä½œä¸ºæ•°æ®æ¥æºï¼Œè‡ªèº«å¤„ç†å®Œçš„ç”Ÿæˆçš„tupleåˆä¸€æ¡æ¡çš„é€šè¿‡Nextäº¤ç»™Aggregationã€‚\nâ€\næ­¤å¤–ï¼Œè¿™é‡Œè¿­ä»£å™¨é‡‡ç”¨çš„æ˜¯Top-to-Bottomçš„æ–¹å¼ï¼Œå³ä»¥ä¸Šå±‚çš„è¿­ä»£å™¨ä¸ºé©±åŠ¨ï¼Œä¸æ–­çš„è°ƒç”¨ä¸‹å±‚çš„Nextæ¥è·å–æ•°æ®ã€‚\nSeqScanï¼šå®ç°ä¸€ä¸ªå…¨è¡¨éå†ï¼Œæ¯”è¾ƒç®€å•ï¼Œåªéœ€è¦é€šè¿‡tableä¸Šçš„è¿­ä»£å™¨å»ä¸€æ¡æ¡è·å–å³å¯\nIndex\u0026amp;Deleteï¼šè¿™ä¸¤ä¸ªå®ç°ä¸Šå·®ä¸å¤š,å°†å­è¿­ä»£å™¨å½“ä¸­çš„ä¸€æ¡æ¡æ’å…¥åˆ°ç›®æ ‡è¡¨å½“ä¸­å³å¯ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äºä¸ºç«å±±æ¨¡å‹ï¼Œä¸Šå±‚ä¼šä¸æ–­çš„å°è¯•è°ƒç”¨Nextç›´è‡³è·å–åˆ°falseï¼Œå› æ­¤ä¸ºäº†é˜²æ­¢é‡å¤æ’å…¥æˆ–åˆ é™¤ï¼Œéœ€è¦è®¾ç½®ä¸€ä¸ªflagï¼Œåœ¨å®Œæˆæ’å…¥åç½®ä¸ºfalseï¼Œä¹‹åå†è°ƒç”¨å³å¯ç›´æ¥è¿”å›ï¼Œä¸­æ­¢è¿­ä»£ã€‚\næ­¤å¤–ï¼Œæ’å…¥å’Œåˆ é™¤æ¶‰åŠåˆ°æ›´æ–°ç´¢å¼•ï¼Œè°ƒç”¨ä¸€ä¸‹å¯¹åº”çš„å‡½æ•°å°±å¥½\nIndex Scanï¼šSeqScanä¸ºé€šè¿‡tableçš„è¿­ä»£å™¨è¿›è¡Œéå†ï¼ŒIndex Scanå³é€šè¿‡ç´¢å¼•æ¥è¿›è¡Œéå†ï¼Œå³ä¹‹å‰å®ç°çš„B+æ ‘çš„è¿­ä»£å™¨ï¼ŒæŒ‰ç…§LabçŸ¥é“ä¸Šç»™çš„æç¤ºï¼Œè½¬æ¢ä¹‹åè·å–å…¶è¿­ä»£å™¨\n1 2 tree_{dynamic_cast\u0026lt;BPlusTreeIndexForOneIntegerColumn *\u0026gt;(index_info_-\u0026gt;index_.get())}, iter_{tree_-\u0026gt;GetBeginIterator()} ç”±äºBusTubå®ç°çš„æ˜¯éèšç°‡ç´¢å¼•ï¼Œå› æ­¤ç´¢å¼•å½“ä¸­å­˜å‚¨çš„ä¸ºRIDï¼Œå³ä¸€ä¸ªtupleçš„å”¯ä¸€æ ‡è¯†ï¼ŒRIDç”±page_num å’Œ slot_numç»„æˆï¼Œè¡¨ç¤ºè¯¥tupleå±äºå“ªå¼ è¡¨ï¼Œå­˜åœ¨äºè¡¨çš„å“ªä¸ªä½ç½®ã€‚\nä¹‹åå†å»è¡¨å½“ä¸­åç§»è¯»å–è·å–åˆ°æ‰€éœ€çš„tuple\nSQLæ‰§è¡Œè¿‡ç¨‹ è¿™ä¸€éƒ¨åˆ†å¼ºçƒˆæ¨èçœ‹ä¸€ä¸‹è¿Ÿå…ˆç”Ÿå†™çš„ButTubå…»æˆè®°ã€‚æˆ‘è¿™é‡Œå°±ç®€å•è¯´ä¸€ä¸‹ä»£ç å½“ä¸­éœ€è¦ç”¨åˆ°çš„é‚£éƒ¨åˆ†ã€‚\né¦–å…ˆï¼Œæ ¹æ®SQLè§£æçš„ç»“æœï¼Œä¼˜åŒ–å™¨ä¼šç”Ÿæˆä¸€ä¸ªä¸ªçš„plan_nodeã€‚ä»£è¡¨çš„ä¸€ä¸ªç®—å­çš„æ‰§è¡Œç­–ç•¥ï¼Œå³éœ€è¦ä»å“ªè·å–æ•°æ®ï¼Œè·å–æ•°æ®çš„æ–¹å¼ï¼Œtupleçš„ç»“æ„ç­‰ç­‰ã€‚ç”±äºé€šè¿‡æŠ½è±¡è¯­æ³•æ ‘ä¸€æ­¥æ­¥çš„æ¥ï¼Œæ•´ä¸ªSQLæ‰§è¡Œçš„æ•´ä½“planåŒæ ·ä¸ºæ ‘ç»“æ„ç»„ç»‡ã€‚\nä¹‹åæ¯ä¸ªç®—å­ï¼Œè¢«æŠ½è±¡æˆä¸€ä¸ªExecutorâ€‹ï¼Œä»£è¡¨ä¸€ä¸ªæ‰§è¡Œçš„åŠ¨ä½œã€‚Executorâ€‹ä¸»è¦æœ‰ä¸‰éƒ¨åˆ†ç»„æˆï¼Œåˆ†åˆ«ä¸ºplanâ€‹, executor_contextâ€‹,child_executor:\nplanå³ä¸ºä¸Šè¿°é€šè¿‡ä¼˜åŒ–å™¨çš„æ¥çš„å…·ä½“æ‰§è¡Œæ–¹æ¡ˆï¼Œä»¥åŠæ‰€éœ€çš„æ•°æ®ï¼Œå¦‚Index_Scanå½“ä¸­ä¼šæä¾›indexçš„idï¼Œjoinå½“ä¸­ä¼šæä¾›ä¸€ä¸ªç”¨äºè¿›è¡Œjoin keyçš„Predicateï¼Œä»¥åŠjoinçš„child plan\næ ¹æ®æƒ…å†µï¼Œå…¶ä¼šæ‹¥æœ‰ä¸€ä¸ªæˆ–è€…å¤šä¸ªå­ç®—å­child_executorâ€‹ ï¼Œå³ç«å±±æ¨¡å‹çš„è¿­ä»£å™¨é“¾ï¼Œé€šè¿‡child_executorâ€‹æ¥ä»åº•å±‚è·å–æ•°æ®ã€‚\nexecutor_contextâ€‹ï¼šè¿™ä¸ªæ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œå°±æ˜¯ç”¨äºä¿å­˜æ•´ä¸ªæ•°æ®åº“çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œå¯ä»¥é€šè¿‡å…¶æ¥è·å–åˆ°buffer_pool CataLog LockManagerç­‰ï¼Œç›¸æ¯”äº6.830å°†å…¶å…¨éƒ¨å®šä¹‰åœ¨Databaseç±»å½“ä¸­ä½œä¸ºé™æ€æˆå‘˜å˜é‡ï¼Œä¸ªäººæ„Ÿè§‰å•ç‹¬å®šä¹‰ä¸€ä¸ªç±»ä½œä¸ºä¸Šä¸‹æ–‡èƒ½å¤Ÿæ›´ä¼˜é›…ä¸€ç‚¹\n1 2 3 4 5 6 7 8 9 Transaction *transaction_; /** The datbase catalog associated with this executor context */ Catalog *catalog_; /** The buffer pool manager associated with this executor context */ BufferPoolManager *bpm_; /** The transaction manager associated with this executor context */ TransactionManager *txn_mgr_; /** The lock manager associated with this executor context */ LockManager *lock_mgr_; Task2 è¿™é‡Œè®¾è®¡çš„æœ‰ç‚¹ç»•ï¼Œä¸»è¦çš„ç›¸å…³ç±»ä¸ºï¼š\nâ€‹AggregationPlanNodeâ€‹ã€SimpleAggregationHashTableâ€‹ã€AggregationExecutorâ€‹ï¼Œä¸€ä¸ªä¸ªæ¥çœ‹\nAggregationPlanNode åŒ…å«äº†æ•´ä¸ªèšåˆæ“ä½œçš„é€»è¾‘ï¼Œé€šè¿‡å¯¹SQLçš„è§£æè€Œæ¥ï¼ŒåŒ…æ‹¬è¿›è¡Œå“ªäº›èšåˆè®¡ç®—ï¼Œé€šè¿‡ä»€ä¹ˆå­—æ®µè¿›è¡Œgroup byç­‰ã€‚å¹¶ä¸”ç”±äºè¿›è¡Œgroup byæ”¯æŒå¤šä¸ªå­—æ®µï¼Œä»¥åŠä¸€æ¬¡å¯èƒ½ä¼ å…¥å¤šä¸ªç®—å­ï¼Œå› æ­¤å‡ä¸ºæ•°ç»„çš„å½¢å¼ï¼š\n1 2 3 4 5 6 /** The GROUP BY expressions */ std::vector\u0026lt;AbstractExpressionRef\u0026gt; group_bys_; /** The aggregation expressions */ std::vector\u0026lt;AbstractExpressionRef\u0026gt; aggregates_; /** The aggregation types */ std::vector\u0026lt;AggregationType\u0026gt; agg_types_; 1 2 3 4 query select count(*), min(v1), max(v1), count(v1), sum(v1) from t1; ---- 6 -99999 99999 6 6 ä»¥ä¸Šçš„ä¸€æ¡sqlè§£æå®Œä¹‹åå°±æ˜¯group_bysä¸ºç©ºï¼Œarggegates,agg_typesåˆ†åˆ«æœ‰5ä¸ªå‚æ•°ã€‚\nå¹¶ä¸”ï¼Œåªæœ‰å‚ä¸Aggregationçš„åˆ—æ‰ä¼šåœ¨ç”Ÿæˆplanç­‰æ—¶å€™è¢«åŠ å…¥åˆ°è¿™å‡ ä¸ªæ•°ç»„å½“ä¸­ï¼Œå¦‚ä¸‹sqlå½“ä¸­çš„v4,v5,v4+v5ç­‰å‡ä¸ä¼šå‚ä¸åˆ°Aggregationçš„è¿‡ç¨‹ï¼Œä¹Ÿä¸ä¼šè¢«æ·»åŠ åˆ°æ•°ç»„å½“ä¸­ï¼Œå› æ­¤æœ€ç»ˆv4 v5ä¼šå­˜åœ¨äºgroup_byså½“ä¸­ï¼Œsumã€minã€countåˆ™ä¼šå­˜åœ¨äºaggregateså’Œagg_typeså½“ä¸­ã€‚\n1 select v4, v5, v4+v5, sum(v1+v2), min(v3+v4), count(*) from t1 group by v4, v5; SimpleAggregationHashTable SimpleAggregationHashTableåœ¨å†…éƒ¨ç»´æŠ¤ä¸€ä¸ªstd::unordered_mapï¼Œkeyä¸ºArrgegateKeyï¼Œvalä¸ºä¸€ä¸ªArrgegateValï¼ŒäºŒè€…æœ¬è´¨ä¸Šåˆ†åˆ«ä¸ºä¸€ä¸ªvectorçš„ç®€å•å°è£…ï¼Œä¸6.830ä¸åŒçš„æ˜¯ï¼Œè¿™é‡Œçš„group byæ”¯æŒå¤šä¸ªå­—æ®µï¼Œå¯¹äºå¤šä¸ªå­—æ®µï¼Œå¯ä»¥è§†ä¸ºç»„åˆæˆä¸€ä¸ªè”åˆç´¢å¼•é‚£æ ·ã€‚æ•°ç»„å¤§å°ä¸ºç®—å­çš„æ•°é‡ï¼Œå­˜å‚¨åœ¨è¿™ä¸ªgroupbyå­—æ®µä¸‹çš„æ‰€æœ‰ç®—å­çš„è®¡ç®—ç»“æœã€‚å®šä¹‰åˆ†åˆ«å¦‚ä¸‹:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 struct AggregateKey { /** The group-by values */ std::vector\u0026lt;Value\u0026gt; group_bys_; /** * Compares two aggregate keys for equality. * @param other the other aggregate key to be compared with * @return `true` if both aggregate keys have equivalent group-by expressions, `false` otherwise */ auto operator==(const AggregateKey \u0026amp;other) const -\u0026gt; bool { for (uint32_t i = 0; i \u0026lt; other.group_bys_.size(); i++) { if (group_bys_[i].CompareEquals(other.group_bys_[i]) != CmpBool::CmpTrue) { return false; } } return true; } }; /** AggregateValue represents a value for each of the running aggregates */ struct AggregateValue { /** The aggregate values */ std::vector\u0026lt;Value\u0026gt; aggregates_; }; 1 2 3 4 5 std::unordered_map\u0026lt;AggregateKey, AggregateValue\u0026gt; ht_{}; /** The aggregate expressions that we have */ const std::vector\u0026lt;AbstractExpressionRef\u0026gt; \u0026amp;agg_exprs_; /** The types of aggregations that we have */ const std::vector\u0026lt;AggregationType\u0026gt; \u0026amp;agg_types_; æ’å…¥â€‹\né€šè¿‡æŸ¥è¯¢è¡¨å¾—åˆ°çš„æœ€ç»ˆç»“æœä¸ºä¸€ä¸ªTupleï¼Œè€ŒHashTableå½“ä¸­ä¸ºAggregateKey,AggregateValï¼Œå› æ­¤éœ€è¦å°†tupleè¿›è¡Œè½¬æ¢ï¼Œ\nkeyä¸ºgroupbyçš„å­—æ®µï¼Œå¦‚æœä¸éœ€è¦groupbyï¼Œé‚£ä¹ˆå°±ä½¿ç”¨ä¸€ä¸ªç©ºçš„æ•°ç»„ä½œä¸ºkeyï¼Œä¹‹åæ‰€æœ‰çš„valéƒ½ä¼šåœ¨è¿™ä¸ªå”¯ä¸€çš„keyä¸Šè®¡ç®—ã€‚å¦åˆ™åˆ™æ ¹æ®æä¾›çš„group byå­—æ®µå»tupleå½“ä¸­è¿›è¡Œæå–ï¼Œç”Ÿæˆä¸€ä¸ªkeyã€‚\nè€Œå¯¹äºValueåˆ™æ ¹æ®ç®—å­æ‰€éœ€è¿›è¡Œè·å–å³å¯ï¼Œå¦‚ä¸Šé¢çš„é‚£æ¡Sqlï¼Œæœ€ç»ˆvalsæ•°ç»„å½“ä¸­æ‰€å­˜å‚¨çš„ä¸ºï¼š[1,val(tuple1),val(tuple1),1(or null),val(tuple1)]â€‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 auto MakeAggregateKey(const Tuple *tuple) -\u0026gt; AggregateKey { std::vector\u0026lt;Value\u0026gt; keys; for (const auto \u0026amp;expr : plan_-\u0026gt;GetGroupBys()) { keys.emplace_back(expr-\u0026gt;Evaluate(tuple, child_-\u0026gt;GetOutputSchema())); } return {keys}; } /** @return The tuple as an AggregateValue */ auto MakeAggregateValue(const Tuple *tuple) -\u0026gt; AggregateValue { std::vector\u0026lt;Value\u0026gt; vals; for (const auto \u0026amp;expr : plan_-\u0026gt;GetAggregates()) { vals.emplace_back(expr-\u0026gt;Evaluate(tuple, child_-\u0026gt;GetOutputSchema())); } return {vals}; } åœ¨ç”Ÿæˆäº†å¯¹åº”çš„keyï¼Œvalä¹‹åï¼Œé€šè¿‡InsertCombineä»¥åŠCombineAggregateVluesè¿›è¡Œæ’å…¥ã€‚åœ¨å…¶ä¸­æ‰¾åˆ°å¯¹åº”çš„groupbyå­—æ®µä¹‹åï¼Œå°†æ‰€æœ‰çš„ç®—å­åœ¨åŸæœ¬çš„åŸºç¡€ä¸Šè¿›è¡Œè®¡ç®—ã€‚\n1 2 3 4 5 6 void InsertCombine(const AggregateKey \u0026amp;agg_key, const AggregateValue \u0026amp;agg_val) { if (ht_.count(agg_key) == 0) { ht_.insert({agg_key, GenerateInitialAggregateValue()}); } CombineAggregateValues(\u0026amp;ht_[agg_key], agg_val); } Iteratorï¼šä¸ºäº†å°†è®¡ç®—ç»“æœè¿›è¡Œå¯¼å‡ºæˆTupleï¼Œhtè¿˜æä¾›äº†ä¸€ä¸ªè¿­ä»£å™¨ï¼Œå¯ä»¥ç”¨å…¶å¯¹keyå’Œvalåˆ†åˆ«è¿›è¡Œè¿­ä»£\nAggregateExecutor åœ¨å¤§è‡´ç»“æ„ä¸Šå’Œå…¶ä»–ç®—å­åŸºæœ¬ç›¸åŒï¼Œéƒ½æœ‰ä¸€ä¸ªç”±sqlè§£æå‡ºæ¥çš„planï¼Œå’Œä¸€ä¸ªç”¨äºè¯»å–æ•°æ®çš„child_iteratorï¼Œæ­¤å¤–è¿˜æœ‰ç”¨äºå­˜å‚¨èšåˆç»“æœçš„hashtableå’Œç”¨äºå¯¼å‡ºèšåˆç»“æœçš„è¿­ä»£å™¨.\n1 2 3 4 5 6 7 const AggregationPlanNode *plan_; /** The child executor that produces tuples over which the aggregation is computed */ std::unique_ptr\u0026lt;AbstractExecutor\u0026gt; child_; /** Simple aggregation hash table */ SimpleAggregationHashTable aht_; /** Simple aggregation hash table iterator */ SimpleAggregationHashTable::Iterator aht_iterator_; ä¸å…¶ä»–çš„ç®—å­ä¸åŒçš„æ˜¯ï¼ŒAggregationæ˜¯ pipeline breakerï¼Œå³å…¶ä»–çš„ç«å±±æ¨¡å‹çš„ç®—å­ï¼Œé€šè¿‡nextæ¥è·å–åˆ°ä¸€æ¡æ•°æ®ä¹‹åï¼Œç«‹å³å‘ä¸Šè¿”å›ï¼Œå³è‡ªå§‹è‡³ç»ˆè¯¥ç®—å­åªä¼šæ‹¥æœ‰æˆ–è€…å¤„ç†ä¸€æ¡tupleï¼Œè€ŒAggregationä¸åŒçš„æ˜¯ï¼Œä»–é€šè¿‡child_teratorçš„nextè·å–åˆ°æ‰€æœ‰çš„æ•°æ®ï¼Œå½“è®¡ç®—å®Œæˆä¹‹åï¼Œåœ¨é€šè¿‡è‡ªèº«çš„Nextå»å°†ç»“æœä¸€æ¡æ¡çš„å‘ä¸Šè¿”å›ï¼Œä½†æ˜¯è¿™é‡Œä¾æ—§æ˜¯ç«å±±æ¨¡å‹ï¼Œåªæ˜¯åšäº†ä¸€æ¬¡æˆªæ–­ï¼Œå¹¶ä¸ä¼šåƒç‰©åŒ–æ¨¡å‹é‚£æ ·ä¸€æ¬¡æ€§çš„è¿”å›å¤šä¸ªtupleã€‚\nå› æ­¤å°±éœ€è¦åœ¨Initå½“ä¸­è¿­ä»£å®Œchild_iteratorå½“ä¸­çš„æ‰€æœ‰çš„tupleï¼Œè®¡ç®—å®Œæˆä¹‹åå†é€šè¿‡Nextå°†ç»“æœä¸€æ¡æ¡å‘ä¸Šè¿”å›ã€‚\nNextâ€‹\næ­£å¦‚ä¸Šé¢æ‰€è¯´ï¼ŒNextçš„ä½œç”¨å°±æ˜¯é€šè¿‡è¿­ä»£å™¨ï¼Œè¿­ä»£ä¸Šè¿°å­˜å‚¨èšåˆç»“æœçš„hashtableï¼Œæ ¹æ®æ•°æ®æ¥ä¸€æ¡æ¡ç”Ÿæˆtupleã€‚åˆ†åˆ«å¯¹key valè¿›è¡Œè¿­ä»£ï¼Œå³groupbyå’Œ aggregatesï¼Œå°†å…¶ä½œä¸ºtupleçš„ä¸€åˆ—ï¼Œæ’å…¥åˆ°ä¸€ä¸ªæ•°ç»„å½“ä¸­ï¼Œä¹‹åæ ¹æ®è¯¥æ•°ç»„æ¥æ„å»ºtupleã€‚\nNestedLoopJoin è¿™é‡Œå®ç°ä¸Šå’Œ6.830çš„å·®ä¸å¤šï¼Œä¸»è¦æœ‰ä¸‰ä¸ªé—®é¢˜ï¼š\nduplicated key éœ€è¦æ³¨æ„çš„æ˜¯ä¸è¦æ¼åŒ¹é…å³å¯,å¦‚ä¸‹è¡¨ï¼šå¦‚æœç›´æ¥åŒå±‚whileåµŒå¥—çš„è¯ï¼Œåœ¨å®Œæˆäº†T1çš„1 å’ŒT2çš„ç¬¬ä¸€ä¸ª1åŒ¹é…å®Œæˆå¹¶è¿”å›ä¹‹åï¼Œä¸Šå±‚å†è°ƒç”¨Nextï¼Œå°±ä¼šè°ƒç”¨T1.Nextï¼Œå°±ä¼šä»¤T1è¿­ä»£åˆ°2ï¼Œå¯¼è‡´T1å’ŒT2çš„ç¬¬äºŒ1åŒ¹é…é—å¤±ï¼Œæ¢å¥è¯è¯´å°±æ˜¯æ— æ³•å¤„ç†é‡å¤çš„key\nt1 join t2 on t1.colA = t2.colAâ€‹\nT1.colA T2.colA 0 0 1 1 2 1 å› æ­¤ä¸ºäº†é˜²æ­¢æ¯æ¬¡è°ƒç”¨Joinçš„Nextå·¦è¡¨éƒ½ä¼šå‘ä¸‹éå†ä¸€æ¬¡ï¼Œé‡‡ç”¨ä¸€ä¸ªå˜é‡å»æš‚å­˜ä¸€ä¸‹å·¦è¡¨å½“å‰çš„tupleï¼Œä¹‹åå½“å³è¡¨å®Œå…¨éå†å®Œä¸€æ¬¡ä¹‹åï¼Œå·¦è¡¨æ‰ä¼šé€šè¿‡Nextç§»åŠ¨è‡³ä¸‹ä¸€æ¡tupleã€‚\nå¤§è‡´ç»“æ„å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 while (true) { if (!has_left_next_) { return false; } for (uint32_t flag = right_idx_ \u0026lt; 0 ? 0 : right_idx_; flag \u0026lt; right_tuple_vec_.size(); flag++) { // scan right tuple return true; } if (right_idx_ == -1 \u0026amp;\u0026amp; plan_-\u0026gt;GetJoinType() == JoinType::LEFT) { // generate a tuple with null to handle left join has_left_next_ = left_executor_-\u0026gt;Next(\u0026amp;last_left_tuple_, \u0026amp;left_rid); return true; } right_idx_ = -1; has_left_next_ = left_executor_-\u0026gt;Next(\u0026amp;last_left_tuple_, \u0026amp;left_rid); } å³è¿­ä»£å™¨ åœ¨NestedLoopJoinå½“ä¸­ï¼Œå·¦è¡¨å½“ä¸­çš„æ¯ä¸€æ¡æ•°æ®éƒ½ä¼šéå†å³è¡¨æ¥å¯»æ‰¾èƒ½å¤ŸåŒ¹é…çš„tupleï¼Œå› æ­¤ä¼šå¯¼è‡´å³è¡¨çš„è¿­ä»£å™¨ä¸æ–­è€—å°½ã€‚æœ€å·æ‡’çš„æ–¹å¼ä¸ºå½“å³è¡¨çš„whileè¿­ä»£å®Œæˆä¸€æ¬¡ä¹‹åå°±è°ƒç”¨å…¶Init()â€‹è¿›è¡Œé‡ç½®ï¼Œä¸è¿‡è¿™æ ·åç»­åˆä¼šå»ç£ç›˜å½“ä¸­è¯»å–ï¼Œé€ æˆä¸å¿…è¦çš„ioï¼Œå› æ­¤æ›´å¥½çš„æ–¹å¼ä¸ºé€šè¿‡ä¸€ä¸ªæ•°ç»„è¿›è¡Œæš‚å­˜ï¼Œä¹‹åéå†è¿™ä¸ªç¼“å­˜ä¸‹æ¥çš„æ•°ç»„å³å¯ï¼Œå¯ä»¥å‡å°‘å¤šæ¬¡IOã€‚\nleft join BusTubåˆ†åˆ«æ”¯æŒInner Joinå’ŒLeft Joinï¼Œå¦‚æœå·¦è¡¨çš„ä¸€ä¸ªtupleåœ¨å³è¡¨å½“ä¸­å®Œå…¨æ²¡æœ‰åŒ¹é…çš„è¯ï¼Œé€šè¿‡åœ¨å³è¡¨çš„ä½ç½®å¡«å……nullï¼Œç”Ÿæˆä¸€æ¡æ•°æ®ã€‚\nNestedIndexJoin å’ŒNestedLoopJoinç¨æœ‰ä¸åŒï¼Œä¸»è¦æ˜¯æ•°æ®çš„æ¥æºï¼Œç”±äºé©±åŠ¨è¡¨ä¸€å®šè¦éå†ï¼Œå› æ­¤é€‰æ‹©æ²¡æœ‰ç´¢å¼•çš„è¡¨ä½œä¸ºé©±åŠ¨è¡¨ï¼Œå³è¡¨çš„æ•°æ®è·å–æ–¹å¼é€šè¿‡ç´¢å¼•æ¥å®ç°ã€‚ç”±äºBusTubçš„ç´¢å¼•ä¸æ”¯æŒé‡å¤çš„keyï¼Œå› æ­¤ä¹Ÿä¸éœ€è¦ä¸€ä¸ªå˜é‡æ¥ä¿å­˜å·¦è¡¨çš„tupleé˜²æ­¢è¿”å›è¿­ä»£äº†ã€‚å¦‚æœé€šè¿‡ç´¢å¼•èƒ½æ‰¾åˆ°ï¼Œé‚£ä¹ˆå°±åˆ›å»ºä¸€æ¡å®Œæ•´çš„è®°å½•ï¼Œå¦‚æœç´¢å¼•å½“ä¸­æ‰¾ä¸åˆ°å¹¶ä¸”å½“å‰çš„ç±»å‹ä¸ºleft joinï¼Œé‚£ä¹ˆå°±åˆ›å»ºä¸€æ¡è®°å½•ï¼Œç”¨nullå¯¹å³å€¼è¿›è¡Œå¡«å……ã€‚å¤§è‡´ç»“æ„å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 while (child_executor_-\u0026gt;Next(\u0026amp;left_tuple, \u0026amp;useless_rid)) { std::vector\u0026lt;RID\u0026gt; index_rid; Value value = plan_-\u0026gt;KeyPredicate()-\u0026gt;Evaluate(\u0026amp;left_tuple, child_executor_-\u0026gt;GetOutputSchema()); tree_-\u0026gt;ScanKey(Tuple{{value}, index_info_-\u0026gt;index_-\u0026gt;GetKeySchema()}, \u0026amp;index_rid, exec_ctx_-\u0026gt;GetTransaction()); if (!index_rid.empty()) { // found by the index // generate a tuple return true; } // can not find by index,handle the left join case if (index_rid.empty() \u0026amp;\u0026amp; plan_-\u0026gt;GetJoinType() == JoinType::LEFT) { // generate tuple with null return true; } } HashJoin åœ¨Labå½“ä¸­å¹¶æ²¡æœ‰è¦æ±‚å®ç°HashJoinï¼Œä½†æ˜¯ä¸ªäººæ„Ÿè§‰æ¯”è¾ƒæœ‰æ„æ€ï¼Œå†åŠ ä¸Šå•çº¯åœ¨å†…å­˜å½“ä¸­çš„HashJoinå®ç°èµ·æ¥å¹¶ä¸å›°éš¾ï¼Œå°±ç»™å®ç°äº†ä¸€ä¸‹\né€šè¿‡ä¸€ä¸ªHashTableæ¥å­˜å‚¨å³è¡¨å½“ä¸­çš„tupleï¼Œè€Œç”±äºjoin keyå¯èƒ½é‡å¤ï¼Œå› æ­¤HashTableåº”å½“ä»¥hashä¸ºkeyï¼Œæ•°ç»„ä¸ºvalueï¼Œæ•°ç»„å½“ä¸­å­˜å‚¨æœ‰ç›¸åŒjoin keyçš„Tupleã€‚\n1 2 3 4 5 6 const HashJoinPlanNode *plan_; std::unordered_map\u0026lt;hash_t, std::vector\u0026lt;Tuple\u0026gt;\u0026gt; join_hash_; std::unique_ptr\u0026lt;AbstractExecutor\u0026gt; left_executor_; std::unique_ptr\u0026lt;AbstractExecutor\u0026gt; right_executor_; std::vector\u0026lt;Tuple\u0026gt; result_tuple_; std::vector\u0026lt;Tuple\u0026gt;::const_iterator tuple_iter_; å®ç°ä¸Šçš„å¤§è‡´æ€è·¯å°±æ˜¯é¦–å…ˆéå†å³è¡¨ï¼Œå°†tupleå­˜å‚¨åˆ°HashTableå½“ä¸­ã€‚ä¹‹åå†éå†å·¦è¡¨ï¼Œå»å’Œå³è¡¨è¿›è¡ŒåŒ¹é…ï¼Œæ­¤æ—¶ç›¸å½“äºåœ¨å³è¡¨ä¸Šå»ºç«‹äº†ä¸€ä¸ªHashIndexï¼Œå¦‚æœåŒ¹é…æˆåŠŸåˆ™å°†å…¶è®°å½•åˆ°result_tupleæ•°ç»„å½“ä¸­ï¼Œå¦‚æœåŒ¹é…å¤±è´¥ï¼Œåˆ™å»è€ƒè™‘æ˜¯å¦ä¸ºLeftJoinï¼Œå¦‚æœæ˜¯åˆ™æ·»åŠ ä¸€æ¡å³è¡¨ä¸ºç©ºçš„è®°å½•ï¼Œå…ˆéå†å³è¡¨çš„åŸå› ä¹Ÿæ˜¯ç”¨äºå¤„ç†LeftJoin\nåœ¨è¿›è¡ŒåŒ¹é…æ—¶ï¼Œéœ€è¦å¤„ç†å“ˆå¸Œå†²çªçš„é—®é¢˜ï¼Œç¬¬ä¸€æ¬¡å¿˜è€ƒè™‘äº†ï¼Œå‡ºç°äº†9å’Œ8300è¢«å“ˆå¸Œåˆ°äº†åŒä¸€ä¸ªæ§½å½“ä¸­ï¼Œä¹‹åè¯¯åŒ¹é…ä¸Šäº†ï¼Œè§£å†³åŠæ³•ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œåœ¨é€šè¿‡å“ˆå¸Œå€¼æ‰¾åˆ°å¯¹åº”çš„keyä¹‹ååœ¨joinå‰åˆ¤æ–­ä¸€æ¬¡æ˜¯å¦ç›¸ç­‰å³å¯ã€‚\n1 if (right_join_key.CompareEquals(join_key) == CmpBool::CmpTrue) ä¹‹ååœ¨Nextå½“ä¸­é€šè¿‡è¿­ä»£å™¨å»è®¿é—®result_tupleå³å¯\nä½¿ç”¨HashJoinè¿›è¡Œä¼˜åŒ–ä¹‹åï¼ŒLeaderboard bonusçš„Q1æ‰§è¡Œä¼šå¿«ä¸Šå¾ˆå¤šï¼Œå¦‚æœä¸è¿›è¡Œä¼˜åŒ–çš„è¯ä¸º30000ï¼Œä½¿ç”¨HashJoinå¯ä»¥åˆ°80å¤š\nTask3 åˆ†åˆ«å®ç°sortâ€‹ limitâ€‹ topNâ€‹ä¸‰ä¸ªç®—å­ä»¥åŠtopnå¯¹åº”çš„ä¼˜åŒ–ï¼Œå‰ä¸¤ä¸ªæ²¡ä»€ä¹ˆå¥½è¯´ï¼ŒSeqScanä¿®ä¿®è¡¥è¡¥å³å¯ã€‚\nTop-N Top-Nä¸»è¦é’ˆå¯¹çš„ä¸ºsort+limitçš„æƒ…å†µï¼Œå³order by xxx limit nâ€‹ï¼Œè¿™ç§æƒ…å†µå¦‚æœä¸è¿›è¡Œä¼˜åŒ–åˆ™éœ€è¦å…¨è¡¨éå†å¹¶æ’åºï¼Œä¹‹åå†å¯¹æ’åºå®Œçš„ç»“æœè¿›è¡Œä¸€æ¬¡è®¡æ•°æˆªå–ã€‚\né€šè¿‡Top-Nå³å¯ä¿è¯åªæœ‰ä¸€æ¬¡å…¨è¡¨éå†ï¼Œè®¡ç®—å®Œä¹‹åé€æ¡è¿”å›ã€‚\næ ¹æ®labçš„æç¤ºï¼Œå¾ˆå®¹æ˜“å°±å¯ä»¥ç¡®ç«‹æ€è·¯ï¼Œç»´æŠ¤ä¸€ä¸ªä¼˜å…ˆé˜Ÿåˆ—ï¼Œå¹¶ä¸”ä¿è¯å½“ä¸­åªæœ‰Kä¸ªæ•°æ®ï¼Œå³é€šè¿‡Nextä¸æ–­è·å–å¹¶æ’å…¥åˆ°å…¶ä¸­ï¼Œå¦‚æœè¾¾åˆ°äº†Kä¸ªå°±å¼¹å‡ºä¸€ä¸ªï¼Œä¿è¯è‡³å¤šæœ‰Kä¸ª\nThink of what data structure can be used to track the top n elements (Andy mentioned it in the lecture). The struct should hold at most kâ€‹ elements (where kâ€‹ is the number specified in LIMITâ€‹ clause).\nä¸è¿‡ç”±äºstd::priority_queueâ€‹å½“ä¸­å¹¶æ²¡æœ‰æä¾›è¿­ä»£å™¨ï¼Œä¹Ÿæ²¡æœ‰æä¾›ä¸‹æ ‡è®¿é—®ï¼Œè€Œtopè®¿é—®çš„æ˜¯æ’åºæœ€ä½çš„é‚£ä¸ªï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨ä¸€ä¸ªæ ˆï¼Œå°†æ•´ä¸ªé€»è¾‘è¿›è¡Œç¿»è½¬ï¼Œä»è€Œä¿è¯ä»é«˜å‘ä½çš„è¿›è¡Œè·å–ã€‚\nTop-N Optimizer 1 2 3 4 5 6 7 8 9 10 11 auto Optimizer::Optimize(const AbstractPlanNodeRef \u0026amp;plan) -\u0026gt; AbstractPlanNodeRef { if (force_starter_rule_) { // Use starter rules when `force_starter_rule_` is set to true. auto p = plan; p = OptimizeMergeProjection(p); p = OptimizeMergeFilterNLJ(p); p = OptimizeNLJAsIndexJoin(p); p = OptimizeOrderByAsIndexScan(p); p = OptimizeSortLimitAsTopN(p); return p; } å°†åŸæœ¬æœªç»ä¼˜åŒ–çš„planæ ‘é€šè¿‡å¤šæ¡è§„åˆ™é“¾å¼çš„è¿›è¡Œä¼˜åŒ–ï¼Œæœ€åå¾—åˆ°ä¸€ä¸ªæœ€ç»ˆçš„ä¼˜åŒ–ç»“æœã€‚å¯¹äºå•ä¸ªçš„ä¼˜åŒ–æ–¹æ¡ˆï¼Œéƒ½æ˜¯é‡‡ç”¨åç»­éå†çš„æ–¹å¼ï¼Œè‡ªåº•å‘ä¸Šçš„æ”¹å†™planï¼Œå°†ç¬¦åˆçš„ç±»å‹è¿›è¡Œä¼˜åŒ–ã€‚\nå› æ­¤ç…§çŒ«ç”»è™çš„å®ç°ä¸€ä¸ªï¼Œé€šè¿‡Top-Nå¯¹sort+limitçš„æƒ…å†µè¿›è¡Œä¼˜åŒ–ï¼Œåªæœ‰ä¸Šå±‚ä¸ºlimitï¼Œä¸‹å±‚ä¸ºsortçš„æƒ…å†µï¼Œæ‰å°†å…¶ä¼˜åŒ–ä¸ºTop-Nã€‚\nSummary æ€»çš„æ¥è¯´Lab3çš„éš¾åº¦å¹¶ä¸å¤§ï¼Œå¹¶ä¸”åœ¨æœ¬åœ°æä¾›äº†å…¨éƒ¨çš„æµ‹è¯•ç”¨ä¾‹ï¼Œè€Œä¸”ä¸æ¶‰åŠå¹¶å‘ï¼Œå› æ­¤å¯ä»¥å®‰å¿ƒçš„å•æ­¥è°ƒè¯•ï¼Œå†™èµ·æ¥ä¹Ÿå°±æ¯”è¾ƒçš„ç²—æ”¾ä¸€ç‚¹ï¼Œé¢å‘bugç¼–ç¨‹ã€‚\næ•´ä¸ªLab3åšä¸‹æ¥ç»™æˆ‘çš„æ„Ÿè§‰æ˜¯ç›¸æ¯”äº6.830ï¼Œbustubæ›´æ³¨é‡äºæ·±åº¦ï¼Œåœ¨å¾ˆå¤šåœ°æ–¹éƒ½æä¾›æä¾›äº†ä¸€å®šçš„å°è£…ï¼Œå¦‚ç£ç›˜çš„è¯»å†™ï¼Œtupleçš„è¯»å–å’Œå†™å…¥ã€‚è™½ç„¶å°‘äº†è‡ªè¡Œæ„é€ tableå’Œtupleçš„è¿‡ç¨‹ï¼Œå¯¹äºschemaçš„ç†è§£å¯èƒ½å·®ä¸€ç‚¹ï¼Œä½†æ˜¯åœ¨æœ‰é™çš„æ—¶é—´å†…æ›´æ³¨é‡äºæ·±åº¦ã€‚æ­¤å¤–ï¼Œç”±äºSQLæ‰§è¡Œè¿™ä¸€éƒ¨åˆ†è®¾ç½®åœ¨äº†ç´¢å¼•ä¹‹åï¼Œå› æ­¤åœ¨åŠŸèƒ½çš„å®ç°ä¸Šä¹Ÿå¯ä»¥åº”ç”¨ç´¢å¼•ï¼Œå¦‚NestedIndexJoinã€IndexScanç­‰ã€‚åœ¨åš6.830çš„åŸºç¡€ä¹‹ä¸Šå†™busTubçš„è¯ä¸ªäººæ„Ÿè§‰ä¼šæ›´æœ‰æ”¶è·ä¸€ç‚¹ï¼Œä½†æ˜¯å¦‚æœåªå†™ä¸€ä¸ªçš„è¯ï¼ŒBusTubå¯èƒ½æ›´åˆé€‚ä¸€ç‚¹ï¼Œä¸è¿‡éœ€è¦å»é˜…è¯»ä¸€ä¸‹å…¶ä»–éƒ¨åˆ†çš„æºç ï¼Œæˆ–è€…åƒæŸäº›ä½¬é‚£æ ·ç›´æ¥è‡ªå·±å®ç°ä¸€ä¸ªBusTubã€‚\næœ€è¿‘æ‰‹å¤´äº‹æœ‰ç‚¹å¤šï¼Œä¹Ÿå¿«è€ƒè¯•äº†ï¼Œæ•´ä¸ªæ–‡ç« å†™çš„æ¯”è¾ƒä»“ä¿ƒï¼ŒLeaderborad bonusæš‚æ—¶ä¹Ÿæ²¡æ—¶é—´å†™äº†ï¼Œåªèƒ½å…ˆæç½®åœ¨ä¸€è¾¹äº†ã€‚\n","permalink":"https://fischer0522.github.io/en/posts/tech/bustub/bustub-lab3/","summary":"Lab3 Task1 ç«å±±æ¨¡å‹ åœ¨Task1å½“ä¸­å®ç°äº†SeqScanâ€‹ Insertâ€‹ Deleteâ€‹ IndexScanâ€‹ï¼Œç”±äºå‡ä¸ºç«å±±æ¨¡å‹ï¼Œå› æ­¤åœ¨å®ç°ä¸Šå¤§åŒå°å¼‚ï¼Œ","title":"BusTub Lab3 Query Execution"},{"content":"checkpoint2 Task3 åœ¨æ”¯æŒå¹¶å‘å‰æ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œä¸€ä¸ªç®€å•çš„è¿­ä»£å™¨ã€‚æ ¹æ®beginçš„æ¡ä»¶æ‰¾åˆ°ä¸€ä¸ªèµ·å§‹é¡µï¼Œä¹‹ååœ¨è¯¥é¡µå†…éå†å³å¯ï¼Œå½“éå†å®Œè¯¥é¡µä¹‹åï¼Œæ ¹æ®nextPageIdæ‰¾åˆ°ä¸‹ä¸€é¡µç»§ç»­éå†å³å¯ã€‚\nUnpin\næœ€åˆé€šè¿‡FindLeafæ‰¾åˆ°ä¸€ä¸ªpageï¼Œå¯¹å…¶è¿›è¡Œäº†fetchï¼Œæ­¤æ—¶æ˜¯å¯¹å…¶pinä½äº†çš„ï¼Œå½“éå†å®Œè¯¥pageä¹‹ååº”è¯¥å¯¹è¯¥pageè¿›è¡Œunpinï¼Œå½“è¿­ä»£å™¨ææ„æ—¶ï¼Œåº”å½“å¯¹å½“å‰é¡µunpinã€‚\nå¹¶å‘è¿™é‡Œå…ˆä¸è¯´ï¼Œç•™åœ¨Task4å½“ä¸­è¿›è¡Œå®ç°ã€‚\nTask4 ä¸ªäººæ„Ÿè§‰ç›¸æ¯”äºcheckpoint1æ¥è¯´ï¼Œå…¶å®å¹¶ä¸éš¾ï¼Œåœ¨ç»†èŠ‚çš„å¤„ç†ä¸Šå¹¶æ²¡æœ‰checkpoint1å½“ä¸­å¤æ‚ï¼Œå°¤å…¶æ˜¯deleteæ“ä½œï¼Œä¸ªäººåœ¨deleteä¸ŠèŠ±è´¹äº†å¤§é‡æ—¶é—´è¿›è¡Œç†è§£å’Œdebugï¼Œå¹¶ä¸”åœ¨checkpoint1çš„æµ‹è¯•æ•°æ®å¹¶ä¸å®Œå–„ï¼Œæ ¹æ®ç¾¤å‹æ‰’ä¸‹æ¥æˆ–è€…è‡ªå·±å¤åˆ»çš„ç»“æœæ¥çœ‹ï¼Œå¯¹äºdeleteçš„æµ‹è¯•åªæœ‰ä¸¤ä¸ªï¼Œå¹¶ä¸”ä¸€ä¸ªå•å…ƒæµ‹è¯•å½“ä¸­åªæ’å…¥äº†äº”æ¡æ•°æ®è¿›è¡Œæµ‹è¯•ï¼Œæµ‹è¯•å¼ºåº¦å¾ˆä½ï¼Œè¿™ä¹Ÿå¯¼è‡´å¾ˆå¤šé—®é¢˜åœ¨checkpoint1å½“ä¸­å¹¶æ²¡æœ‰æš´éœ²å‡ºæ¥ï¼Œæœ€ç»ˆæ··åœ¨äº†checkpoint2å½“ä¸­ã€‚\nå¹¶å‘ å¯¹B+æ ‘æ”¯æŒå¹¶å‘ï¼Œä½¿ç”¨æ‰€è°“çš„èƒèŸ¹é”ï¼Œåªæœ‰åœ¨å­èŠ‚ç‚¹å®‰å…¨çš„æƒ…å†µä¸‹æ‰èƒ½å¤Ÿé‡Šæ”¾æ‰ä½äºçˆ¶èŠ‚ç‚¹ä¸Šçš„é”ï¼Œå¯¹äºå®‰å…¨çš„æƒ…å†µæ ¹æ®æ“ä½œè€Œå®šï¼š\nSearchâ€‹ï¼šä»çˆ¶èŠ‚ç‚¹ä¸Šè·å–åˆ°Ré”ï¼Œä¹‹åéå†å­èŠ‚ç‚¹ï¼Œåªè¦åœ¨å­èŠ‚ç‚¹ä¸Šè·å–åˆ°é”ä¹‹åï¼Œå°±å¯ä»¥è®¤ä¸ºå½“å‰å·²ç»å®‰å…¨ï¼Œä¹‹åä¾¿å¯ä»¥é‡Šæ”¾æ‰ä½äºçˆ¶èŠ‚ç‚¹ä¸Šçš„é”ã€‚ Insertâ€‹ï¼šä»æ ¹èŠ‚ç‚¹å¼€å§‹ï¼Œå°è¯•åœ¨å­èŠ‚ç‚¹ä¸Šè·å–Wé”ï¼Œä¸€æ—¦åœ¨å­©å­èŠ‚ç‚¹ä¸Šè·å–é”æˆåŠŸï¼Œé‚£ä¹ˆå°±æ£€æŸ¥æ˜¯å¦å®‰å…¨ï¼Œå¯¹äºæ’å…¥æƒ…å†µè€Œè¨€ï¼Œå¦‚æœæ’å…¥åä¸äº§ç”Ÿåˆ†è£‚åˆ™è§†ä¸ºå®‰å…¨ï¼Œå¦‚æœå®‰å…¨ï¼Œé‚£ä¹ˆå°±æ˜¯é‡Šæ”¾æ‰€æœ‰ç¥–å…ˆçš„é” Deleteâ€‹ï¼šä»æ ¹èŠ‚ç‚¹å¼€å§‹ï¼Œå°è¯•åœ¨å­èŠ‚ç‚¹ä¸Šè·å–Wé”ï¼Œä¸€æ—¦é”å®šï¼Œæ£€æŸ¥æ˜¯å¦å®‰å…¨ï¼Œå¯¹äºåˆ é™¤æƒ…å†µè€Œè¨€ï¼Œä¸ºè‡³å°‘åŠæ»¡ï¼ˆå¯¹äºæ ¹èŠ‚ç‚¹éœ€è¦æŒ‰ç…§ä¸åŒçš„æ ‡å‡†çš„æ£€æŸ¥ï¼‰ï¼Œä¸€æ—¦å­©å­èŠ‚ç‚¹å®‰å…¨ï¼Œé‡Šæ”¾æ‰€æœ‰ç¥–å…ˆçš„é”ã€‚ åœ¨å¹¶å‘çš„å®ç°ä¸Šï¼Œä¸»è¦æ¶‰åŠä¸¤ç‚¹,ä¸€ä¸ªæ˜¯é€šè¿‡Latch Crabbingåœ¨FindLeafçš„é€”ä¸­ä¸€éè·å–ä¸€éé‡Šæ”¾é”ï¼Œä¿è¯å¹¶å‘å®‰å…¨çš„åŒæ—¶æé«˜å¹¶å‘åº¦ï¼ˆæ­¤å¤–è¿˜æœ‰deleteæ—¶å¯¹å…„å¼ŸèŠ‚ç‚¹åŠ é”ï¼‰ã€‚å¦ä¸€ä¸ªåˆ™æ˜¯åœ¨åˆé€‚çš„ä½ç½®é‡Šæ”¾æ‰å’Œå½“å‰äº‹åŠ¡ç›¸å…³çš„é”ã€‚\né”çš„å½¢å¼ é¦–å…ˆï¼Œæ‰€æœ‰çš„Pageéƒ½æ˜¯é€šè¿‡buffer poolè¿›è¡Œè·å–çš„ï¼Œåªæœ‰é€šè¿‡buffer poolè·å–åˆ°äº†Pageä¹‹åï¼Œæ‰å¯ä»¥è¿›è¡Œåç»­çš„æ“ä½œï¼Œè€Œä»buffer_poolå½“ä¸­è·å–åˆ°çš„æœ€åˆå³ä¸ºåŸå§‹çš„Pageï¼Œè€Œä¸æ˜¯å¯¹å†…å­˜é‡æ–°è§£é‡Šè€Œæ¥çš„BPlusTreePageï¼Œè€Œåœ¨Pageçš„å¤´æ–‡ä»¶å½“ä¸­ä¹Ÿç»™å‡ºäº†è¯»å†™çš„latchï¼Œå› æ­¤ï¼Œå¯¹äºå•ä¸ªPageçš„ä¸Šé”ï¼Œä½¿ç”¨Pageå½“ä¸­å®šä¹‰çš„ReaderWriterLatchâ€‹å³å¯ã€‚\nroot_page\nroot_pageåŒæ ·æ˜¯é€šè¿‡buffer_poolæ¥è·å–å¹¶ä¹‹åè¿›è¡Œä¸Šé”çš„ï¼Œæ­£å¸¸æƒ…å†µä¸‹ä¸éœ€è¦è¿›è¡Œé¢å¤–çš„æ“ä½œï¼Œä½†æ˜¯å¦‚æœä¸€é¢—æ ‘æ ¹æœ¬ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆè¿™æ—¶å°±æ²¡æœ‰åŠæ³•å»è·å–root_pageå¹¶ä¸”è¿›è¡Œä¸Šé”ï¼Œå› ä¸ºæ— æ³•å¯¹ä¸€ä¸ªä¸å­˜åœ¨çš„pageè¿›è¡Œä¸Šé”ï¼Œä¸ªäººæ„Ÿè§‰è¿™é‡Œçš„å¤„ç†æ–¹å¼å°±æœ‰ç‚¹ç±»ä¼¼äºå¹»è¯»çš„é—´éš™é”ï¼Œç”±äºæ— æ³•å¯¹ä¸€ä¸ªä¸å­˜åœ¨çš„pageè¿›è¡Œä¸Šé”ï¼Œé‚£ä¹ˆå°±å¯¹å…¶é—´éš™è¿›è¡Œä¸Šé”ï¼Œè¿™é‡Œçš„é—´éš™æŒ‡çš„å°±æ˜¯æ ‘çš„å¼€å¤´ï¼Œåœ¨root_pageçš„ä¸Šé¢è™šæ„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œåœ¨è·å–root_pageä¹‹å‰å…ˆè·å–è¯¥èŠ‚ç‚¹ï¼Œå½“èƒ½å¤Ÿå¯¹root_pageä¸Šé”ä¹‹åå°±é‡Šæ”¾æ‰è¯¥é”ã€‚\ntransaction\nå¯¹Pageè®¿é—®çš„åŸºæœ¬å•ä½ä¸ºtransactionï¼Œå› æ­¤transactionéœ€è¦å¯¹äºè‡ªå·±å½“å‰è·å–çš„é”è¿›è¡Œä¿å­˜å’Œç®¡ç†ï¼Œè¿™åœ¨transactionå½“ä¸­å·²ç»ç»™äº†å®šä¹‰ï¼Œé€šè¿‡GetPageSet()å³å¯è·å–åˆ°ç®¡ç†å½“å‰ç›¸å…³pageçš„é˜Ÿåˆ—ã€‚\nå¹¶ä¸”è·å–é”æ—¶ä¸ºæŒ‰ç…§è‡ªä¸Šå‘ä¸‹çš„é¡ºåºæ¥è·å–é”ï¼Œé‡Šæ”¾æ—¶åŒæ ·æŒ‰ç…§è‡ªé¡¶å‘ä¸‹çš„é¡ºåºè¿›è¡Œï¼Œå¹¶ä¸”ç”±äºé¡¶ä¸Šçš„ç«äº‰è¾ƒä¸ºæ¿€çƒˆï¼Œæå‰é‡Šæ”¾ä¹Ÿæœ‰åˆ©äºæé«˜å¹¶å‘åº¦ã€‚\nè¯¥é˜Ÿåˆ—åªç”¨äºç®¡ç†å†…éƒ¨èŠ‚ç‚¹ä¸Šçš„é”ï¼Œå¯¹äºè¿›è¡Œæ’å…¥æˆ–åˆ é™¤çš„å¶å­èŠ‚ç‚¹ä¸è¿›è¡Œç®¡ç†ï¼Œå•ç‹¬é‡Šæ”¾å¶å­èŠ‚ç‚¹ä¸Šçš„é”ã€‚\nLatch Crabbing æ‰€è°“çš„èƒèŸ¹é”ï¼Œé€šè¿‡æå‰é‡Šæ”¾é”çš„å½¢å¼æ¥å¢åŠ å¹¶å‘åº¦ã€‚å¤§è‡´å«ä¹‰ä¸Šä¸ºä»æ ¹èŠ‚ç‚¹å¼€å§‹ï¼Œå…ˆè·å–ä¸€ä¸ªèŠ‚ç‚¹çš„é”ï¼Œä¹‹åå†å°è¯•è·å–å…¶å­èŠ‚ç‚¹çš„é”ï¼Œå½“è·å–åˆ°äº†å­èŠ‚ç‚¹çš„é”ä¹‹åï¼Œå¦‚æœæ­¤æ¬¡æ“ä½œå¯¹äºå­èŠ‚ç‚¹æ¥è¯´æ˜¯å®‰å…¨çš„ï¼Œé‚£ä¹ˆå°±å¯ä»¥é‡Šæ”¾æ‰è¯¥èŠ‚ç‚¹ä¸Šçš„é”ã€‚å°±åƒèƒèŸ¹é‚£æ ·ï¼Œæ”¾ä¸‹ä¸€åªè„šå¾€å‰èµ°ï¼ˆè·å–å­èŠ‚ç‚¹çš„é”ï¼‰ï¼Œåœ¨æŠ¬èµ·å¦ä¸€åªè„šï¼ˆé‡Šæ”¾å½“å‰èŠ‚ç‚¹ä¸Šçš„é”ï¼‰\nå¯¹äºæ˜¯å¦å®‰å…¨éœ€è¦æ ¹æ®è¯»å†™çš„å½¢å¼è¿›è¡Œåˆ¤æ–­ï¼š\nå¯¹äºè¯»æ“ä½œï¼Œå¹¶ä¸å­˜åœ¨ä»€ä¹ˆå®‰å…¨ä¸å®‰å…¨çš„é—®é¢˜ï¼Œåªè¦èƒ½å¤Ÿè·å–åˆ°å­èŠ‚ç‚¹çš„é”ï¼Œé‚£ä¹ˆå°±æ˜¯å®‰å…¨çš„ï¼Œæ­¤æ—¶å°±å¯ä»¥é‡Šæ”¾æ‰å½“å‰èŠ‚ç‚¹ä¸Šçš„é” å¯¹äºæ’å…¥æ“ä½œï¼šåªæœ‰å½“æ‰§è¡Œåˆ°æœ€åä¸€æ­¥æ‰¾åˆ°å¶å­èŠ‚ç‚¹ä¹‹åæ‰èƒ½å¤ŸçŸ¥é“æ˜¯å¦ä¼šå¼•å‘åˆ†è£‚ï¼Œä»¥åŠåˆ†è£‚æ˜¯å¦ä¼šå‘ä¸Šä½œç”¨ã€‚ä½†æ˜¯ï¼Œåœ¨éå†åˆ°å†…éƒ¨èŠ‚ç‚¹æ—¶ï¼Œå¯ä»¥çŸ¥é“æ˜¯ï¼Œå¦‚æœå‘ç”Ÿäº†åˆ†è£‚ï¼Œå½“å‰èŠ‚ç‚¹æ˜¯å¦ä¼šå‘ç”Ÿåˆ†è£‚ã€‚å³åœ¨éå†åˆ°è¿‡ç¨‹ä¸­ï¼Œè·å–åˆ°å­èŠ‚ç‚¹çš„é”ä¹‹åï¼Œå‡è®¾å­èŠ‚ç‚¹å‘ç”Ÿäº†åˆ†è£‚ï¼Œæ¥åˆ¤æ–­å­èŠ‚ç‚¹çš„åˆ†è£‚å¯¼è‡´çš„InsertIntoParentâ€‹æ˜¯å¦ä¼šå¼•å‘è‡ªèº«çš„åˆ†è£‚ï¼Œå¦‚æœä¸ä¼šï¼Œé‚£ä¹ˆå°±å¯ä»¥é‡Šæ”¾æ‰è‡ªèº«çš„é”ï¼Œå¦åˆ™ç»§ç»­æŒæœ‰ã€‚ å¯¹äºåˆ é™¤æ“ä½œï¼šé€»è¾‘ä¸Šå’Œæ’å…¥æ“ä½œå·®ä¸å¤šï¼Œåªä¸è¿‡æ˜¯å¦å®‰å…¨çš„åˆ¤æ–­æ ‡å‡†ä¸ºæ˜¯å¦å¼•èµ·æ”¶ç¼©ã€‚ å¯¹äºLatch Crabbingï¼Œå…¶è™½ç„¶æ— æ³•ä¿è¯åœ¨æŒç»­å æœ‰é”çš„æ—¶å€™ï¼Œåç»­ä¸€å®šä¼šç”¨åˆ°è¯¥é”ï¼Œå³å¯¹äºä¸€ä¸ªäº”é˜¶B+æ ‘ï¼Œå½“å‰çš„å†…éƒ¨èŠ‚ç‚¹ï¼Œå·²ç»å«æœ‰äº†4ä¸ªkeyï¼Œ5ä¸ªvalueï¼Œæ­¤æ—¶æ ¹æ®æ¡ä»¶åº”å½“ç»§ç»­æŒæœ‰é”ï¼Œä½†æ˜¯æœ€ç»ˆçš„å­èŠ‚ç‚¹å½“ä¸­åªæœ‰ä¸€å¯¹kvï¼Œå› æ­¤ä¸ä¼šå‘ç”Ÿåˆ†è£‚ï¼Œæ­¤æ—¶çš„æŒæœ‰é”å°±å±äºç™½ç™½æŒæœ‰äº†ï¼Œåç»­ä¸ä¼šç”¨åˆ°ï¼Œè™½ç„¶è¿™åœ¨æƒ…å†µå¯¹äºå¹¶å‘åº¦æœ‰ä¸€å®šå½±å“ï¼Œä½†æ˜¯å¯ä»¥ä¿è¯æ‰€æœ‰æƒ…å†µä¸‹çš„æ­£ç¡®æ€§ã€‚\nåœ¨å®ç°ä¸Šä¸»è¦æ˜¯åœ¨FindLeafå½“ä¸­ï¼Œé¦–å…ˆï¼ŒFindLeafè°ƒç”¨æ—¶æ˜¯ä»æ ¹èŠ‚ç‚¹è¿›è¡Œæœç´¢çš„ï¼Œå› æ­¤é¦–å…ˆéœ€è¦è·å–åˆ°root_pageä¸Šçš„é”ï¼Œå¹¶ä¸”åˆ¤æ–­æ˜¯å¦å®‰å…¨ï¼Œä»è€Œé‡Šæ”¾æ‰rootä¸Šçš„é”ã€‚\nä¹‹åï¼Œåˆ™å¾ªç¯æ‰¾åˆ°å¶å­èŠ‚ç‚¹ï¼Œåå¤çš„è·å–å­èŠ‚ç‚¹çš„é”ï¼Œç„¶ååˆ¤æ–­è‡ªèº«æ˜¯å¦å®‰å…¨ï¼Œä»è€Œé€‰æ‹©æ˜¯å¦é‡Šæ”¾é”ã€‚\nè¿™é‡Œä¸»è¦éœ€è¦æ³¨æ„ä¸€ä¸‹åˆ é™¤æ“ä½œçš„æ ¹èŠ‚ç‚¹ï¼Œåœ¨Labçš„é¡µé¢ä¸Šä¹Ÿç»™å‡ºäº†ç›¸å…³æç¤ºï¼Œæ ¹æ®å®šä¹‰ï¼Œä¸€ä¸ªæ ¹èŠ‚ç‚¹æœ€å°‘æœ‰ä¸¤ä¸ªå­èŠ‚ç‚¹ï¼Œåè¿‡æ¥çš„æ„æ€å°±æ˜¯å¦‚æœåªæœ‰ä¸¤ä¸ªå­—èŠ‚ç‚¹çš„æƒ…å†µä¸‹ï¼Œå¦‚æœä¸€ä¸ªèŠ‚ç‚¹è¢«åˆ é™¤æ‰ï¼Œé‚£ä¹ˆå°±å¯èƒ½è§¦å‘AdjustRoot()ï¼Œå› æ­¤å¯¹äºåˆ é™¤æƒ…å†µä¸‹çš„æ ¹èŠ‚ç‚¹çš„å®‰å…¨æ¡ä»¶æ˜¯å­èŠ‚ç‚¹æ•°å¤§äº3ã€‚\nä¸‹å›¾ä¸­å¦‚æœåˆ é™¤èŠ‚ç‚¹3åˆ™ä¼šå¼•å‘AdjustRoot()â€‹ï¼Œå› æ­¤ä¸èƒ½é‡Šæ”¾é”ã€‚\nâ€‹\nâ€‹\nâ€‹\né”çš„é‡Šæ”¾ æ— è®ºæ˜¯GetValueâ€‹,Insertâ€‹è¿˜æ˜¯Removeâ€‹ï¼Œéƒ½éœ€è¦ä¾èµ–FindLeafæ¥æ‰¾åˆ°å¯¹åº”çš„leaf_pageï¼Œä¹‹åè¿›è¡Œå…·ä½“çš„æ“ä½œã€‚å› æ­¤è°ƒç”¨å®ŒFindLeafæ‰¾åˆ°leaf_pageä¹‹åï¼Œå½“å‰çš„äº‹åŠ¡æ˜¯æŒæœ‰è€…è¯¥leaf_pageçš„é”çš„ï¼Œå¦‚æœä¸å®‰å…¨çš„è¯ï¼Œè¿˜æœ‰å¯èƒ½æŒæœ‰ç¥–å…ˆèŠ‚ç‚¹çš„é”ã€‚å› æ­¤å°±éœ€è¦åœ¨åˆé€‚çš„æ—¶æœºé‡Šæ”¾æ‰leaf_pageä¸Šçš„é”å’Œæ‰€æœ‰ç¥–å…ˆèŠ‚ç‚¹ä¸Šçš„é”ï¼Œå¤§è‡´é€»è¾‘å°±æ˜¯åœ¨Searchã€Insertã€Removeä¸‰ä¸ªå‡½æ•°FindLeafä¹‹åã€è¿”å›ä¹‹å‰æ‰¾ä¸€ä¸ªåˆç†çš„ä½ç½®è¿›è¡Œä¸€æ¬¡é”çš„é‡Šæ”¾ï¼Œé‡Šæ”¾æ‰å¶å­èŠ‚ç‚¹å’Œ\nSearch å¯¹äºè¯»æ“ä½œï¼Œå®ç°èµ·æ¥è¾ƒä¸ºç®€å•ï¼Œç›´æ¥ä½¿ç”¨èƒèŸ¹é”å³å¯ï¼Œå…¶ä¸å­˜åœ¨ä»€ä¹ˆä¸å®‰å…¨çš„æƒ…å†µï¼Œå› æ­¤åªéœ€è¦å½“è·å–åˆ°å­©å­èŠ‚ç‚¹çš„é”ä¹‹åï¼Œå°±å¯ä»¥é‡Šæ”¾æ‰çˆ¶äº²èŠ‚ç‚¹ä¸Šçš„é”ã€‚é”çš„ç±»å‹ä¸ºè¯»é”ã€‚\nå› æ­¤åªéœ€è¦åœ¨GetValueè¿”å›å‰é‡Šæ”¾æ‰å¶å­èŠ‚ç‚¹ä¸Šçš„é”å³å¯ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 INDEX_TEMPLATE_ARGUMENTS auto BPLUSTREE_TYPE::GetValue(const KeyType \u0026amp;key, std::vector\u0026lt;ValueType\u0026gt; *result, Transaction *transaction) -\u0026gt; bool { root_page_latch_.RLock(); auto leaf_page = FindLeaf(key, Operation::SEARCH, transaction); auto *node = reinterpret_cast\u0026lt;LeafPage *\u0026gt;(leaf_page-\u0026gt;GetData()); ValueType v; auto is_existed = node-\u0026gt;LookUp(key, \u0026amp;v, comparator_); buffer_pool_manager_-\u0026gt;UnpinPage(leaf_page-\u0026gt;GetPageId(), false); leaf_page-\u0026gt;RUnlatch(); if (is_existed) { result-\u0026gt;push_back(v); return true; } return false; } Insert Insertåˆ™æ¶‰åŠåˆ°ä¸€ä¸ªå®‰å…¨é—®é¢˜ï¼Œå› æ­¤æŒ‰ç…§latch crabbingçš„ç­–ç•¥ï¼Œæ¯æ¬¡è·å–åˆ°é”ä¹‹åéƒ½è¦å°è¯•åˆ¤æ–­ä¸€æ¬¡æ˜¯å¦å®‰å…¨ï¼Œå³åˆ¤æ–­åœ¨å­èŠ‚ç‚¹å½“ä¸­æ’å…¥ä¹‹åæ˜¯å¦ä¼šäº§ç”Ÿåˆ†è£‚ï¼Œå¦‚æœä¸ä¼šäº§ç”Ÿï¼Œé‚£ä¹ˆå°±å¯ä»¥é‡Šæ”¾æ‰ä¹‹å‰æ‰€æœ‰çš„é”ï¼š\nå¯¹äºå†…éƒ¨èŠ‚ç‚¹ï¼Œåˆ™åˆ¤æ–­size \u0026lt; maxSize å¯¹äºå¶å­èŠ‚ç‚¹ï¼Œåˆ™åˆ¤æ–­size \u0026lt; maxSize - 1 åœ¨é‡Šæ”¾é”æ—¶éœ€è¦é‡Šæ”¾å½“å‰èŠ‚ç‚¹ä»¥åŠå½“å‰èŠ‚ç‚¹æ‰€æœ‰çš„ç¥–å…ˆèŠ‚ç‚¹çš„é”ï¼Œå³å°†transactionçš„pageé˜Ÿåˆ—å½“ä¸­çš„æ‰€æœ‰çš„pageä¸Šçš„é”å…¨éƒ¨é‡Šæ”¾ï¼Œå¹¶ä¸”æ³¨æ„æ ¹èŠ‚ç‚¹çš„å¤„ç†ã€‚\nç›¸å…³å‡½æ•°ï¼š\nInsertï¼šå…¥å£å‡½æ•°ï¼šé”ä½root_page_latch StartNewTreeï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„root_pageå¹¶å‘å…¶ä¸­æ·»åŠ æ•°æ®ï¼Œå·²ç»åœ¨Insertå½“ä¸­ä¸Šé”ï¼Œæ— éœ€æ“ä½œ InsertIntoLeafï¼šå·²ç»å­˜åœ¨ä¸€æ£µæ ‘ï¼Œæ‰¾åˆ°å¶å­èŠ‚ç‚¹å¹¶æ’å…¥æ•°æ®ï¼Œè°ƒç”¨FindLeafæ‰¾åˆ°å¶å­èŠ‚ç‚¹ï¼Œæ­¤æ—¶è¿˜æœªé‡Šæ”¾å¶å­èŠ‚ç‚¹ä¸Šçš„Wé”ï¼Œå¹¶ä¸”å¯èƒ½æŒæœ‰ç¥–å…ˆèŠ‚ç‚¹ä¸Šçš„é”ï¼Œå¦‚æœä¸æ¶‰åŠåˆ°åˆ†è£‚ï¼ŒWé”çš„é‡Šæ”¾å’ŒUnpinPageä¸€åŒè¿›è¡Œï¼Œåœ¨è¿”å›å‰é‡Šæ”¾ã€‚ InsertIntoParentï¼šæœ€åˆä¸ºLeafPageå‘ç”Ÿåˆ†è£‚è€Œè°ƒç”¨ï¼Œè°ƒç”¨æ—¶æ—§èŠ‚ç‚¹ä¸Šçš„é”å¹¶æœªé‡Šæ”¾ï¼Œæ•´ä¸ªè¿‡ç¨‹ä¸­ä¿æŒæŒæœ‰é”å³å¯ï¼Œç­‰åˆ°è¿”å›ä¹‹åå†é‡Šæ”¾é”ã€‚ ç»¼ä¸Šï¼Œå¯¹äºInsertæ“ä½œåªéœ€è¦æ‰StartNewTreeå’ŒInsertIntoLeafæ‰§è¡Œç»“æŸåé‡Šæ”¾é”å³å¯ï¼Œå½“æ—¶ä¸ºäº†å°†èµ„æºé‡Šæ”¾çš„é€»è¾‘è¿›è¡Œç»Ÿä¸€ï¼Œå°†é‡Šæ”¾é”çš„æ“ä½œå’ŒInsertIntoLeafå½“ä¸­å’ŒUnpinæ”¾åœ¨äº†ä¸€èµ·ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 INDEX_TEMPLATE_ARGUMENTS auto BPLUSTREE_TYPE::InsertIntoLeaf(const KeyType \u0026amp;key, const ValueType \u0026amp;val, Transaction *transaction) -\u0026gt; bool { auto leaf_page = FindLeaf(key, Operation::INSERT, transaction); // hold the latch of leaf_page and unsafe internal page auto *node = reinterpret_cast\u0026lt;LeafPage *\u0026gt;(leaf_page-\u0026gt;GetData()); auto size = node-\u0026gt;GetSize(); auto new_size = node-\u0026gt;Insert(key, val, comparator_); if (size == new_size) { // duplicate key leaf_page-\u0026gt;WUnlatch(); ReleaseLatchFromQueue(transaction); buffer_pool_manager_-\u0026gt;UnpinPage(leaf_page-\u0026gt;GetPageId(), false); return false; } if (new_size \u0026lt; leaf_max_size_) { leaf_page-\u0026gt;WUnlatch(); ReleaseLatchFromQueue(transaction); buffer_pool_manager_-\u0026gt;UnpinPage(leaf_page-\u0026gt;GetPageId(), true); return true; } // reach the maxsize after insert auto sibling_new_node = Split(node); sibling_new_node-\u0026gt;SetNextPageId(node-\u0026gt;GetNextPageId()); node-\u0026gt;SetNextPageId(sibling_new_node-\u0026gt;GetPageId()); auto first_key = sibling_new_node-\u0026gt;KeyAt(0); InsertIntoParent(node, first_key, sibling_new_node, transaction); ReleaseLatchFromQueue(transaction); leaf_page-\u0026gt;WUnlatch(); buffer_pool_manager_-\u0026gt;UnpinPage(sibling_new_node-\u0026gt;GetPageId(), true); buffer_pool_manager_-\u0026gt;UnpinPage(node-\u0026gt;GetPageId(), true); return true; } Remove å’ŒInsertåŒç†ï¼Œå®‰å…¨æ¡ä»¶ä¸ºä¸äº§ç”Ÿåˆå¹¶æˆ–è€…çªƒå–ï¼Œå³åˆ é™¤å®Œè‡³å°‘ä¸ºåŠæ»¡çš„çŠ¶æ€ï¼Œæ¡ä»¶ä¸º size \u0026gt; MinSize\nç›¸å…³å‡½æ•°ï¼š\nRemoveï¼šå…¥å£å‡½æ•°ï¼Œå’ŒInsertä¸€æ ·çš„å¤„ç†æ–¹å¼ï¼Œé”ä½root_page_latch\nè°ƒç”¨FindLeafæ‰¾åˆ°å¯¹åº”çš„å¶å­èŠ‚ç‚¹ï¼Œæ­¤æ—¶ä»æŒæœ‰å¶å­èŠ‚ç‚¹çš„é”ï¼Œ\nå¦‚æœå°è¯•åˆ é™¤å¤±è´¥ï¼Œåˆ™ç›´æ¥é‡Šæ”¾å¶å­èŠ‚ç‚¹ä¸Šçš„é”ï¼Œè¿”å›\nDeleteEntryï¼š\nAdjustRootï¼šæ‰§è¡Œå®ŒRemove AdjustRootå‡½æ•°ä¹‹åï¼Œè¿”å›æ—¶é‡Šæ”¾é”å³å¯ æ— è®ºæ˜¯Redistributeè¿˜æ˜¯Coalesceï¼Œéƒ½éœ€è¦è·å–åˆ°å…„å¼ŸèŠ‚ç‚¹ï¼Œå› æ­¤éœ€è¦å¯¹å…„å¼ŸèŠ‚ç‚¹è¿›è¡ŒåŠ é” å› æ­¤ï¼Œæˆ‘é‡‡ç”¨äº†ä¸€ç§æ¯”è¾ƒæ— è„‘çš„å®ç°æ–¹å¼ã€‚å³å½“é€šè¿‡FindLeafåŠ é”ä¹‹åï¼Œé™¤äº†ä¹‹åå¯¹å…„å¼ŸèŠ‚ç‚¹è¿›è¡ŒåŠ é”ï¼Œå…¶ä»–æƒ…å†µä¸€å¾‹ä¸è¿›è¡ŒåŠ é”ï¼Œé‡Šæ”¾é”çš„æ“ä½œå…¨éƒ¨ç»Ÿä¸€åˆ°Removeå½“ä¸­ï¼Œåªéœ€è¦åœ¨Removeå‡½æ•°çš„å‡ æ¬¡è¿”å›æ—¶é‡Šæ”¾é”ï¼Œå¯¹äºDeleteå‡½æ•°å½“ä¸­ï¼Œä¸è¿›è¡Œä»»ä½•è§£é”æ“ä½œï¼ŒRemoveå‡½æ•°çš„å¤§è‡´ç»“æ„å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 void BPLUSTREE_TYPE::Remove(const KeyType \u0026amp;key, Transaction *transaction) { root_page_latch_.WLock(); transaction-\u0026gt;AddIntoPageSet(nullptr); if (IsEmpty()) { ReleaseLatchFromQueue(transaction); return; } // hold the lock of leaf page and unsafe internal page auto leaf_page = FindLeaf(key, Operation::DELETE, transaction); auto *node = reinterpret_cast\u0026lt;LeafPage *\u0026gt;(leaf_page-\u0026gt;GetData()); if (node-\u0026gt;IsLeafPage()) { auto before_size = node-\u0026gt;GetSize(); auto size = node-\u0026gt;Delete(key, comparator_); if (before_size == size) { // cannot find the key; ReleaseLatchFromQueue(transaction); leaf_page-\u0026gt;WUnlatch(); buffer_pool_manager_-\u0026gt;UnpinPage(leaf_page-\u0026gt;GetPageId(), false); return; } } auto node_should_delete = DeleteEntry(node, transaction); ReleaseLatchFromQueue(transaction); leaf_page-\u0026gt;WUnlatch(); if (node_should_delete) { transaction-\u0026gt;AddIntoDeletedPageSet(node-\u0026gt;GetPageId()); } buffer_pool_manager_-\u0026gt;UnpinPage(leaf_page-\u0026gt;GetPageId(), true); std::for_each(transaction-\u0026gt;GetDeletedPageSet()-\u0026gt;begin(), transaction-\u0026gt;GetDeletedPageSet()-\u0026gt;end(), [\u0026amp;bpm = buffer_pool_manager_](const page_id_t page_id) { bpm-\u0026gt;DeletePage(page_id); }); transaction-\u0026gt;GetDeletedPageSet()-\u0026gt;clear(); } UnpinPage åŸæ¥åœ¨FindLeafæ—¶ï¼Œä¸€æ—¦éå†è‡³å­èŠ‚ç‚¹æ—¶ï¼Œå½“å‰èŠ‚ç‚¹ç›®å‰å°±ä¸å†è¢«ä½¿ç”¨ï¼Œæ­¤æ—¶å°±å¯ä»¥å¯¹å…¶è¿›è¡Œunpinï¼Œä¹‹æ‰€ä»¥è¯´ç›®å‰ï¼Œæ˜¯å› ä¸ºåç»­å¦‚æœæ¶‰åŠåˆ°åˆå¹¶æˆ–è€…é‡åˆ†é…åˆ°æƒ…å†µï¼Œä¼šé€’å½’çš„å‘ä¸Šé‡æ–°è·å–èŠ‚ç‚¹ï¼Œæ­¤æ—¶åˆä¼šåœ¨æ­¤ç”¨åˆ°è¯¥Pageã€‚å½“æ—¶åšcheckpoint1çš„æ—¶å€™é€‰æ‹©çš„ç­–ç•¥æ˜¯é»˜è®¤åç»­ä¸ä¼šç”¨åˆ°ï¼Œå…è®¸è¿›è¡Œæ·˜æ±°ï¼Œåç»­å¦‚æœéœ€è¦å¹¶ä¸”è¢«æ·˜æ±°äº†ï¼Œå¤§ä¸äº†å°±å†æ¬¡ä»ç£ç›˜åŠ è½½ï¼Œä¹Ÿæ²¡ä»€ä¹ˆå¤§ä¸äº†çš„ã€‚\nä¸è¿‡æ—¢ç„¶å®ç°äº†å¹¶å‘ä¹‹åï¼Œé‚£ä¹ˆä¸å¦‚å°†é€»è¾‘è¿›è¡Œä¸€ä¸‹ç»Ÿä¸€ï¼Œå¦‚æœä¸å®‰å…¨ï¼Œé‚£ä¹ˆå°±æ—¢ä¸é‡Šæ”¾é”ï¼Œä¹Ÿä¸è¿›è¡Œunpinï¼Œç­‰å¾…åç»­é‡æ–°ä½¿ç”¨ã€‚å°è£…æˆä¸€ä¸ªå‡½æ•°\nThink carefully about the order and relationship between UnpinPage(page_id, is_dirty)â€‹ method from buffer pool manager class and UnLock()â€‹ methods from page class. You have to release the latch on that page before you unpin the same page from the buffer pool. å¹¶ä¸”ï¼Œæ ¹æ®Labçš„æç¤ºï¼Œéœ€è¦æ³¨æ„é‡Šæ”¾é”çš„é¡ºåºå’Œunpindçš„é¡ºåºï¼Œè¿™é‡Œçš„é”æ˜¯åŠ åœ¨buffer poolçš„pageä¸Šçš„ï¼Œå¦‚æœä¸€ä¸ªpageè¿˜æœªé‡Šæ”¾æ‰é”å°±å…ˆunpinï¼Œé‚£ä¹ˆä¹‹åå°±æœ‰å¯èƒ½è¢«Evictæ‰ï¼Œè€Œä¹‹åå¦‚æœéœ€è¦ç”¨åˆ°è¯¥Pageæ—¶ï¼Œå†é€šè¿‡FetchPageä»ç£ç›˜åŠ è½½ï¼Œè°ƒç”¨æ„é€ å‡½æ•°ï¼Œé”çš„ç›¸å…³ä¿¡æ¯å°±ä¼šä¸¢å¤±ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 INDEX_TEMPLATE_ARGUMENTS auto BPLUSTREE_TYPE::ReleaseLatchFromQueue(Transaction *transaction) -\u0026gt; void { while (!transaction-\u0026gt;GetPageSet()-\u0026gt;empty()) { Page *page = transaction-\u0026gt;GetPageSet()-\u0026gt;front(); transaction-\u0026gt;GetPageSet()-\u0026gt;pop_front(); if (page == nullptr) { root_page_latch_.WUnlock(); } else { page-\u0026gt;WUnlatch(); buffer_pool_manager_-\u0026gt;UnpinPage(page-\u0026gt;GetPageId(), false); } } } é™¤äº†FindLeafçš„FetchPage Unpinä¹‹å¤–ï¼Œå…¶ä»–çš„å°±æŒ‰ç…§checkpoint1å½“ä¸­çš„å®ç°è¿›è¡Œå³å¯ï¼Œå³åœ¨Deleteçš„è¿‡ç¨‹å½“ä¸­ï¼Œå¯¹äºé€’å½’éœ€è¦çš„parent pageï¼Œå’Œåˆå¹¶ã€é‡åˆ†é…éœ€è¦çš„sibling pageï¼Œåœ¨å“ªé‡ŒFetchäº†å°±åœ¨è¯¥å‡½æ•°å½“ä¸­è¿›è¡ŒUnpinå³å¯ã€‚\nFetchPageå’ŒUnpinPageæœ‰ç‚¹åƒä¸€ç§èµ„æºçš„ç”³è¯·å’Œé‡Šæ”¾ï¼Œå¯ä»¥æŒ‰ç…§RAIIçš„é‚£ç§æ€æƒ³ï¼Œä»¤ç”³è¯·å’Œé‡Šæ”¾éƒ½åœ¨åŒä¸€ä¸ªä½œç”¨åŸŸå†…ã€‚\nIterator åœ¨Beginå½“ä¸­ï¼Œé€šè¿‡Findleafè·å–åˆ°ä¸€ä¸ªleaf_pageçš„é”ï¼Œä¹‹åè¿™ä¸ªIteratorå°±ä¸€ç›´æŒæœ‰è¯¥é”ï¼Œç­‰åˆ°é€šè¿‡++è·å–åˆ°ä¸‹ä¸€ä¸ªpageæ—¶ï¼Œå†è·å–ä¸‹ä¸€ä¸ªpageä¸Šçš„é”ï¼Œå¹¶é‡Šæ”¾å½“å‰pageä¸Šçš„é”ã€‚é€šè¿‡è¿™ç§æ–¹æ¡ˆç¡®å®æ˜¯èƒ½å¤Ÿé€šè¿‡Lab2çš„æµ‹è¯•ï¼Œä½†æ˜¯ä¸ªäººæ„Ÿè§‰ä¼šå¼•èµ·æ­»é”ï¼šä¸€ä¸ªçº¿ç¨‹æ­£åœ¨å¤„ç†å¶å­èŠ‚ç‚¹çš„é‡åˆ†é…ï¼Œå½“å‰å·²ç»è·å–åˆ°äº†å³èŠ‚ç‚¹ä¸Šçš„é”ï¼Œæ­£è¦å°è¯•è·å–å·¦èŠ‚ç‚¹ä¸Šçš„é”ï¼Œè€Œå¦å¤–ä¸€ä¸ªçº¿ç¨‹æ­£åœ¨æ‰§è¡Œä»å·¦å‘å³çš„éå†æ“ä½œï¼Œæ­¤æ—¶è·å–åˆ°äº†å·¦èŠ‚ç‚¹çš„é”ï¼Œå°è¯•è·å–å³èŠ‚ç‚¹çš„é”ï¼Œæ­¤æ—¶å°±ä¼šå½¢æˆæ­»é”ã€‚è¿™é‡Œçš„å¤„ç†æ–¹å¼åº”å½“ä¸ºä»¤è¿­ä»£å™¨è¿›è¡Œå°è¯•ï¼Œå¦‚æœæ— æ³•è·å–é”ï¼Œé‚£ä¹ˆå°±æ”¾å¼ƒè·å–ï¼Œå¹¶é‡Šæ”¾æ‰è‡ªèº«çš„é”ï¼Œä»è€Œç ´é™¤æ­»é”ã€‚\nDebug å¤šçº¿ç¨‹debugè¿˜æ˜¯ç›¸å½“å¤´ç–¼çš„ï¼Œä¸è¿‡ç”±äºæˆ‘åœ¨é”çš„å¤„ç†ä¸Šå®ç°çš„è¾ƒä¸ºç®€å•ï¼Œé€šè¿‡FindLeafè·å–åˆ°é”ä¹‹åï¼Œåœ¨Insertå’ŒRemoveå½“ä¸­åªéœ€è¦åœ¨å‡ ä¸ªåœ°æ–¹é‡Šæ”¾æ‰é”å°±å¯ä»¥äº†ï¼Œæœ€å¼€å§‹ä¹Ÿé‡åˆ°äº†ä¸€äº›æ­»é”é—®é¢˜ï¼Œä¸è¿‡å¤§å¤šéƒ½æ˜¯leaf_pageæœ€åå¿˜åœ¨æ­£ç¡®çš„åœ°æ–¹é‡Šæ”¾äº†ï¼Œé€šè¿‡å•çº¿ç¨‹çš„å•æ­¥è°ƒè¯•å°±å¯ä»¥æ‰¾åˆ°å¡åœ¨äº†å“ªé‡Œï¼Œæœ€ç»ˆå°†æ­»é”è§£å†³å³å¯ã€‚åç»­å†å°±æ²¡æœ‰é‡è§å¹¶å‘å®‰å…¨çš„é—®é¢˜äº†ï¼Œä¹Ÿä¸å­˜åœ¨æ­»é”ã€‚ä¸ªäººæ¯”è¾ƒå¹¸è¿æ²¡æœ‰å‡ºç°å¹¶å‘å®‰å…¨çš„é—®é¢˜ï¼Œæ•´ä¸ªè¿‡ç¨‹å½“ä¸­ä¹Ÿå°±æ²¡æœ‰å»ä¸€ç‚¹ç‚¹è¯»logè¿›è¡Œå¤šçº¿ç¨‹debugã€‚\næˆ‘ä¸ªäººä¸»è¦çš„Bugæ˜¯å­˜åœ¨äºcheckpoint1å½“ä¸­çš„delelteçš„ç»†èŠ‚æ²¡æœ‰å¤„ç†å¥½ï¼Œcheckpoint1åœ¨gradescopeä¸Šçš„æµ‹è¯•å¹¶ä¸å®Œå–„ï¼Œå°¤å…¶æ˜¯å¯¹äºåˆ é™¤çš„æµ‹è¯•ï¼Œåªè¿›è¡Œè¿‡æœ€åŸºç¡€çš„å•èŠ‚ç‚¹çš„åˆ é™¤æµ‹è¯•ï¼Œå› æ­¤åœ¨åšcheckpoint2æ—¶å­˜åœ¨å¾ˆå¤šå†å²é—ç•™é—®é¢˜ï¼Œæœ€ç›´è§‚çš„è¡¨ç°ä¸ºScaleTestæ— æ³•é€šè¿‡ï¼Œå³å¯¹ä¸€ä¸ª3é˜¶çš„B+æ ‘ï¼Œè¿›è¡Œ1wæ¬¡æ’å…¥ã€è¯»å–ã€åˆ é™¤ã€‚æœ€ååˆ¤æ–­æ˜¯å¦ä¸ºç©ºã€‚å¯¹äº3é˜¶çš„B+æ ‘ï¼Œæ’å…¥è¿‡ç¨‹ä¸­çš„åˆ†è£‚éå¸¸é¢‘ç¹ï¼Œåˆ é™¤è¿‡ç¨‹ä¸­çš„åˆå¹¶å’Œé‡åˆ†é…ä¹ŸåŒç†ã€‚å› æ­¤å¦‚æœ1wæ¬¡å­˜åœ¨é—®é¢˜ï¼Œé‚£ä¹ˆå°±è¯´æ˜B+æ ‘çš„é€»è¾‘å¤„ç†ä¸€å®šå­˜åœ¨é—®é¢˜ï¼Œä¹‹åå°±å¯ä»¥å°†æ¬¡æ•°æ”¹ä¸º10æ¬¡ï¼Œè¿è¡Œå‡ æ¬¡åŸºæœ¬ä¸Šå°±å¯ä»¥å¤ç°1ä¸ªbugï¼Œ10æ¬¡æ’å…¥åˆ é™¤å¤„ç†èµ·æ¥ä¹Ÿæ¯”è¾ƒæ–¹ä¾¿ï¼Œé€šè¿‡æä¾›çš„ç”»å›¾å·¥å…·æŠŠæ ‘ç”»å‡ºæ¥å³å¯ï¼Œåˆ†æå“ªé‡Œå‡ºç°äº†é—®é¢˜ã€‚\næœ€åé™„ä¸€ä¸ªé€šè¿‡è®°å½•å’ŒLeaderboard\n","permalink":"https://fischer0522.github.io/en/posts/tech/bustub/busttub-lab2-c2/","summary":"checkpoint2 Task3 åœ¨æ”¯æŒå¹¶å‘å‰æ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œä¸€ä¸ªç®€å•çš„è¿­ä»£å™¨ã€‚æ ¹æ®beginçš„æ¡ä»¶æ‰¾åˆ°ä¸€ä¸ªèµ·å§‹é¡µï¼Œä¹‹ååœ¨è¯¥é¡µå†…éå†å³å¯ï¼Œå½“éå†å®Œè¯¥é¡µä¹‹åï¼Œæ ¹æ®nextPa","title":"BusTub Lab2 B+Tree Index checkpoint2"},{"content":"Lab2 å¯¹äºLabçš„debugï¼Œç”±äºå¹¶æ²¡æœ‰å¼€æ”¾æµ‹è¯•æ ·ä¾‹ï¼Œå› æ­¤æœ€å¥½çš„å°±æ˜¯æ‰¾ä¸€ä¸ªåˆé€‚çš„b+æ ‘çš„æ¨¡æ‹ŸåŠ¨ç”»ï¼Œç„¶åå†ä½¿ç”¨å®˜æ–¹çš„ç”»å›¾å·¥å…·æ¯”è¾ƒè‡ªå·±çš„B+æ ‘ï¼Œä¸€èˆ¬3-4å±‚æ²¡æœ‰é—®é¢˜äº†å¤§å¤šå°±æ˜¯æ²¡æœ‰é—®é¢˜äº†ï¼ŒæŠŠåˆ†è£‚ã€åˆå¹¶ã€é‡åˆ†é…ç­‰å„ç§æƒ…å†µå…¨éƒ¨æ¶‰åŠåˆ°ä¸€æ¬¡åŸºæœ¬å°±å¯ä»¥äº†ã€‚\nB+æ ‘æ¼”ç¤ºåŠ¨ç”»æ¨èå®˜æ–¹çš„ï¼Œå…¶ä»–çš„å¯èƒ½å¤šå°‘éƒ½ä¼šæœ‰ç‚¹bugæˆ–è€…å®ç°æ–¹å¼ä¸å¤ªä¸€æ ·\nhttps://15445.courses.cs.cmu.edu/fall2022/bpt-printer/\nTask1 åˆ†åˆ«å®ç° Parent Page Internal Page Leaf Pageï¼ŒæŒ‰ç…§æ³¨é‡Šå®ç°å³å¯ï¼Œè¾ƒä¸ºç®€å•\næ³¨æ„ä¸€ä¸‹arrry_[1]çš„ä½¿ç”¨æ–¹å¼å³å¯\nflexible arrayâ€‹\nè¿™é‡Œå¯ä»¥å‚è€ƒåä¸€å¤§ä½¬çš„è§£é‡Šï¼Œæè¿°çš„éå¸¸è¯¦ç»†ï¼šflexible array\narray_[1]æ‰€é‡‡ç”¨çš„æ˜¯ä¸€ç§flexible arrayçš„å®ç°æ–¹å¼ï¼Œå³ä¸æŒ‡å®šä¸€ä¸ªæ•°æ®çš„å¤§å°ï¼Œå°†å…¶å°è£…åˆ°ä¸€ä¸ªå¯¹è±¡å½“ä¸­ï¼Œå¯¹æ•´ä¸ªå¯¹è±¡åˆ†é…ä¸€ä¸ªç¡®å®šçš„å¤§å°ï¼Œé™¤å»å·²ç»ä½¿ç”¨çš„ç©ºé—´ï¼Œå‰©ä½™çš„ç©ºé—´å‡å¯ä¸ºarray_[1]æ‰€ä½¿ç”¨ã€‚\nå¯¹äºä¸€ä¸ªInternal Pageï¼ŒBUSTUB_PAGE_SIZEâ€‹å®šä¹‰çš„ä¸º4KBï¼Œå³4096Bï¼Œé™¤å»ä»çˆ¶ç±»ç»§æ‰¿è€Œæ¥çš„6ä¸ªå­—æ®µå„å 4Bï¼Œå…¶ä»–å‰©ä½™çš„æ‰€æœ‰å†…å­˜å‡ä¾›flexible arrayæ¥ä½¿ç”¨\nPage and BPlusTreePageâ€‹\nå°±åƒä¸Šé¢çš„å›¾ç”»çš„é‚£æ ·ï¼Œè¿™äºŒè€…ä¹‹é—´å¹¶ä¸å­˜åœ¨ç»§æ‰¿æˆ–è€…å®ç°çš„å…³ç³»ï¼ŒäºŒè€…åœ¨ç±»çš„å®šä¹‰ä¸Šä¸ºå¹¶åˆ—çš„å…³ç³»ï¼Œå¹¶ä¸åƒæ˜¯åœ¨6.830çš„simpledb å½“ä¸­é€šè¿‡BPlusTreePageå»å®ç°Pageæ¥å£ã€‚\nB+æ ‘çš„ä¸€ä¸ªPageä½œä¸ºç´¢å¼•è€Œå­˜åœ¨ï¼Œè€Œå¶å­èŠ‚ç‚¹å³æ˜¯ç´¢å¼•åˆæ˜¯çœŸå®çš„å­˜å‚¨å•å…ƒï¼ˆå³å­˜å‚¨Tupleå¯¹åº”çš„RIDï¼Œéèšç°‡ç´¢å¼•å®ç°ï¼‰ã€‚\nå³å½“è¦è¯»å–ä¸€ä¸ªtupleæ—¶ï¼Œé¦–å…ˆæ ¹æ®ä¿å­˜çš„root_page_idå»æ‰¾åˆ°æ ¹èŠ‚ç‚¹ï¼Œé€šè¿‡buffer_pool_managerå°†å…¶åŠ è½½åˆ°å†…å­˜å½“ä¸­ï¼Œè€Œroot_pageæ˜¯ä½œä¸ºPageçš„æ•°æ®ç»´æŠ¤åœ¨å†…å­˜å½“ä¸­ï¼ŒPageå½“ä¸­çš„data_â€‹ä¸ºä¸€ä¸ª4KBçš„å­—èŠ‚æ•°ç»„ï¼Œé€šè¿‡reinterpret_castâ€‹å°†å…¶é‡æ–°è§£é‡Šä¸ºBPlusTreePageï¼Œåç»­åœ¨å…¶ä¸­æœç´¢åˆ°å¯¹åº”çš„Keyï¼Œåœ¨é€šè¿‡buffer_pool_managerå»æ‰¾åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œç›´è‡³æœ€åæ‰¾åˆ°å¶å­èŠ‚ç‚¹ï¼Œå¹¶é€šè¿‡RIDå†å»è¯»å–åˆ°tupleã€‚\nè€Œå¯¹äºHeapFileçš„å®ç°æ–¹å¼ï¼Œåˆ™æ˜¯æ‰¾åˆ°ä¸€ä¸ªè¡¨çš„HeapFileï¼Œç„¶åéå†ä¸æ–­è¯»å–å…¶ä¸­çš„HeapPageï¼Œé€šè¿‡bufffer_pool_managerå°†å…¶åŠ è½½åˆ°å†…å­˜å½“ä¸­ï¼Œå†éå†HeapPageå½“ä¸­çš„æ‰€æœ‰çš„tupleï¼Œç›´è‡³æ‰¾åˆ°å¯¹åº”çš„tupleã€‚\nèŠ‚ç‚¹å®ç° èŠ‚ç‚¹å¤§å° å…ˆè¯´ä¸€ä¸ªæ•°æ®åº“ç³»ç»Ÿæ¦‚å¿µå½“ä¸­å¯¹å¤§å°çš„å®šä¹‰ï¼š\né¦–å…ˆå¯¹äºå†…éƒ¨èŠ‚ç‚¹å’Œå¶å­èŠ‚ç‚¹çš„å¤§å°éƒ½åŸºäºMax Degree n\nå¯¹äºå¶å­èŠ‚ç‚¹max_sizeä¸ºn-1ä¸ªkvï¼Œmin_sizeä¸º(n-1)/2å‘ä¸Šå–æ•´ å¯¹äºå†…éƒ¨èŠ‚ç‚¹max_sizeä¸ºnä¸ªæŒ‡é’ˆï¼Œn-1ä¸ªkï¼Œmin_sizeä¸ºn/2å‘ä¸Šå–æ•´ä¸ªæŒ‡é’ˆâ€‹ åœ¨Labå½“ä¸­ï¼Œå¯¹äºä¸€æ£µB+æ ‘ï¼Œå¹¶æ²¡æœ‰åˆ¶å®šMax Degreeï¼Œè€Œæ˜¯åˆ†æˆleaf_max_sizeå’Œinternal_max_sizeæ¥å®šä¹‰çš„ï¼Œå¯ä»¥åˆ†å¼€è®¾ç½®ä½†æ˜¯äºŒè€…ç†è®ºä¸Šåº”è¯¥æ˜¯ç›¸ç­‰çš„ï¼šåœ¨æ˜¯å¦éœ€è¦åˆ†è£‚çš„åˆ¤æ–­æ—¶ï¼ŒLabç»™å‡ºçš„é€»è¾‘æ˜¯ï¼šinternal_max_sizeåœ¨æ’å…¥å‰è¿›è¡Œåˆ¤æ–­ï¼Œleaf_max_sizeåœ¨æ’å…¥åè¿›è¡Œåˆ¤æ–­ï¼Œå› æ­¤å³å¯ä¿è¯å†…éƒ¨èŠ‚ç‚¹å¯ä»¥æ¯”å¶å­èŠ‚ç‚¹å¤šå®¹çº³ä¸€ä¸ªæŒ‡é’ˆã€‚\nå› æ­¤å¯¹äºmin_sizeçš„æ±‚æ³•ï¼š\nleaf_node: n / 2 internal_node (n + 1) / 2 ä¸å‡ä¸€ç›´æ¥é™¤å¯ä»¥ä¸-1ä¹‹åå‘ä¸Šå–æ•´ç­‰ä»·ã€‚\nå®ç°æ–¹å¼ åœ¨ä¸€ä¸ªPageå†…éƒ¨é€šè¿‡array_[1]â€‹æ¥ä¿å­˜æ‰€æœ‰çš„KVï¼Œarray_[1]çš„å…ƒç´ ç±»å‹ä¸ºä¸€ä¸ªKVé”®å€¼å¯¹ï¼Œå¯¹äºå¶å­èŠ‚ç‚¹çš„å®ç°è¾ƒä¸ºä¾¿æ·ï¼Œkvçš„æ•°é‡ç›¸ç­‰ï¼Œç›´æ¥ä»å¤´å¼€å§‹å¡«å……å³å¯ï¼Œåœ¨bustubæ‰€å®ç°çš„ä¸ºéèšç°‡ç´¢å¼•ï¼Œå› æ­¤keyå³ä¸ºè®¾ç½®ç´¢å¼•çš„é”®ï¼Œvalueå³ä¸ºRecordIdã€‚åœ¨é€šè¿‡ç´¢å¼•æ‰¾åˆ°äº†RecordIdä¹‹åå†ä½¿ç”¨RecordIdåœ¨ä¸€ä¸ªPageå½“ä¸­å»è¿›è¡Œåç§»è¯»å–ã€‚\nå¦‚æœæƒ³MySQLé‚£æ ·çš„è¯ä¸»é”®ç´¢å¼•é”å­˜å‚¨çš„ä¸ºæ•´ä¸ªtupleï¼ŒäºŒçº§ç´¢å¼•å­˜å‚¨çš„åˆ™æ˜¯ç´¢å¼•å’Œä¸»é”®ï¼Œé€šè¿‡äºŒçº§ç´¢å¼•è¿›è¡ŒæŸ¥è¯¢ï¼Œéœ€è¦é€šè¿‡ä¸€ä¸ªå›è¡¨çš„è¿‡ç¨‹ã€‚\nâ€\nè€Œå¯¹äºinternal_pageçš„å®ç°ç¨å¾®å¤æ‚ä¸€ç‚¹ï¼Œç”±äºæŒ‡é’ˆæ¯”ç´¢å¼•å¤šä¸€ä¸ªï¼Œå› æ­¤å¯ä»¥é€‰æ‹©å°†ç¬¬ä¸€ä¸ªkeyæ ‡è®°ä¸ºç©ºï¼Œä¸å­˜å‚¨ä»»ä½•ä¸œè¥¿ï¼Œä¹‹åå†æ›´æ–°ç´¢å¼•çš„æ—¶å€™è®°å¾—è·³è¿‡0å·ä½ï¼Œä»1å¼€å§‹ã€‚\nå¯¹äºä¸Šå›¾çš„0003 0005 0007åˆ™ä¸ºï¼š\nTask2 åªæ”¯æŒå”¯ä¸€ç´¢å¼•ï¼Œå½“æ’å…¥é‡å¤çš„keyæ—¶éœ€è¦ä¸æ‰§è¡Œå¹¶è¿”å›falseã€‚\nåœ¨æ’å…¥æ—¶éœ€è¦è¿›è¡Œæœ€å¤§å€¼çš„æ£€æµ‹ï¼š\nå¯¹äºå†…éƒ¨èŠ‚ç‚¹ä¸ºæ’å…¥å‰å­èŠ‚ç‚¹çš„æ•°é‡ï¼ˆæŒ‡é’ˆçš„æ•°é‡ï¼‰ç­‰äºmax_size å¯¹äºå¶å­èŠ‚ç‚¹ä¸ºæ’å…¥åkvé”®å€¼å¯¹çš„æ•°é‡ç­‰äºmax_size å†™æ“ä½œå¯èƒ½ä¼šå¯¼è‡´æ ¹èŠ‚ç‚¹çš„æ›´æ–°ï¼Œä½¿ç”¨updateRootPageIdâ€‹è¿›è¡Œæ›´æ–°ï¼Œåªè¦root_page_idéœ€è¦æ›´æ–°æ—¶ï¼Œå°±å¯¹å…¶è¿›è¡Œè°ƒç”¨\nGetValue æŒ‰ç…§ä¼ªä»£ç æ¥ä¸¥æ ¼å®ç°ï¼ŒæŒ‰ç…§ä¸Šå›¾çš„åˆ’åˆ†æ–¹æ³•è¿›è¡Œå°è£…ï¼Œåˆ†åˆ«å®šä¹‰FindLeaf()ï¼Œç”¨äºä»æ ¹èŠ‚ç‚¹æ‰¾åˆ°å¯¹åº”çš„å¶å­èŠ‚ç‚¹ï¼Œåœ¨è¿™è¿‡ç¨‹å½“ä¸­éœ€è¦åœ¨ä¸€ä¸ªèŠ‚ç‚¹å†…éƒ¨å»æœç´¢ï¼Œå› æ­¤åˆ†åˆ«å®šä¹‰ä¸€ä¸ªLoopUpå’ŒKeyIndexï¼š\nKeyIndexï¼šè°ƒç”¨std::lower_boundå»å¯»æ‰¾ç¬¬ä¸€ä¸ª \u0026gt;= çš„å€¼ LookUpï¼šè°ƒç”¨KeyIndexï¼Œæ ¹æ®è¿”å›çš„ä¸‹è¡¨å»åˆ¤æ–­æ˜¯å¦è·å–åˆ°ã€‚ å¹¶ä¸”å¶å­èŠ‚ç‚¹å’Œå†…éƒ¨èŠ‚ç‚¹çš„æœç´¢é€»è¾‘å¹¶ä¸ç›¸åŒï¼Œå› æ­¤éœ€è¦åˆ†åˆ«å®šä¹‰ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 INDEX_TEMPLATE_ARGUMENTS auto B_PLUS_TREE_LEAF_PAGE_TYPE ::KeyIndex(const KeyType \u0026amp;key, const KeyComparator \u0026amp;comparator) const -\u0026gt; int { auto target = std::lower_bound(array_,array_ + GetSize(),key, [\u0026amp;comparator](const auto \u0026amp;pair,auto k) { return comparator(pair.first,k) \u0026lt; 0; }) ; return std::distance(array_,target); } INDEX_TEMPLATE_ARGUMENTS auto B_PLUS_TREE_LEAF_PAGE_TYPE::LookUp(const KeyType \u0026amp;key, ValueType *valueType, const KeyComparator \u0026amp;keyComparator) const -\u0026gt; bool { int target_in_array = KeyIndex(key,keyComparator); if (target_in_array == GetSize() || keyComparator(array_[target_in_array].first,key) != 0) { return false; } *valueType = array_[target_in_array].second; return true; } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 INDEX_TEMPLATE_ARGUMENTS auto B_PLUS_TREE_INTERNAL_PAGE_TYPE::Lookup(const KeyType \u0026amp;key, const KeyComparator \u0026amp;comparator) const -\u0026gt; ValueType { // skip the empty key auto target = std::lower_bound(array_ + 1, array_ + GetSize(), key, [\u0026amp;comparator](const auto \u0026amp;pair, auto k) { return comparator(pair.first, k) \u0026lt; 0; }); // larger than any key,return the last one if (target == array_ + GetSize()) { return ValueAt(GetSize() - 1); } // return the key == target_key if (comparator(target-\u0026gt;first, key) == 0) { return target-\u0026gt;second; } // return the key \u0026lt; target_key return std::prev(target)-\u0026gt;second; } Insert ä¸»è¦åˆ†ä¸ºå››ä¸ªå‡½æ•°ï¼Œåˆ†åˆ«ä¸ºï¼š\nä¸»ä½“insert å½“æ ‘ä¸ºç©ºæ—¶è°ƒç”¨stratNewTreeåˆ›å»ºç¬¬ä¸€ä¸ªèŠ‚ç‚¹ insert_in_leaf insert_in_parent Insert insertæœ¬èº«å¹¶ä¸å®ç°ä»€ä¹ˆå…·ä½“é€»è¾‘ï¼Œå¯¹StartNewTreeå’Œinsert_in_leafè¿›è¡Œåˆ†ç±»å³å¯\n1 2 3 4 5 6 7 8 INDEX_TEMPLATE_ARGUMENTS auto BPLUSTREE_TYPE::Insert(const KeyType \u0026amp;key, const ValueType \u0026amp;value, Transaction *transaction) -\u0026gt; bool { if (IsEmpty()) { StartNewTree(key,value); return true; } return InsertIntoLeaf(key,value,transaction); } StartNewTree åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„æ ‘ï¼Œåˆ›å»ºä¸€ä¸ªå¶å­èŠ‚ç‚¹å°†å…¶ä½œä¸ºæ ¹èŠ‚ç‚¹ï¼Œå¹¶å‘å…¶ä¸­æ’å…¥ä¸€æ¡æ•°æ®\n1 2 3 4 5 6 7 8 9 10 11 INDEX_TEMPLATE_ARGUMENTS auto BPLUSTREE_TYPE::StartNewTree(const KeyType \u0026amp;key, const ValueType \u0026amp;val) -\u0026gt; void { auto page = buffer_pool_manager_-\u0026gt;NewPage(\u0026amp;root_page_id_); if (page == nullptr) { throw Exception(ExceptionType::OUT_OF_MEMORY,\u0026#34;cannot allocate new page in StartNewPage\u0026#34;); } auto *leaf = reinterpret_cast\u0026lt;LeafPage *\u0026gt;(page-\u0026gt;GetData()); leaf-\u0026gt;Init(root_page_id_,INVALID_PAGE_ID,leaf_max_size_); leaf-\u0026gt;Insert(key,val,comparator_); buffer_pool_manager_-\u0026gt;UnpinPage(page-\u0026gt;GetPageId(), true); } Insertå°è£…åœ¨Leaf_pageå½“ä¸­ï¼Œæ‰¾åˆ°ä¸€ä¸ªåˆé€‚çš„ä½ç½®å‘å…¶ä¸­æ’å…¥ï¼Œå¹¶ä¸”å¯¹äºé‡å¤çš„keyï¼Œæ‹’ç»æ’å…¥ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 INDEX_TEMPLATE_ARGUMENTS auto B_PLUS_TREE_LEAF_PAGE_TYPE::Insert(const KeyType \u0026amp;key, const ValueType \u0026amp;val,const KeyComparator \u0026amp;keyComparator) -\u0026gt; int { auto distance = KeyIndex(key,keyComparator); // larger than any key if (distance == GetSize()) { *(array_ + distance) = std::make_pair(key,val); IncreaseSize(1); return GetSize(); } // duplicated key if (keyComparator(array_[distance].first,key) == 0) { return GetSize(); } std::move_backward(array_ + distance,array_ + GetSize(),array_ +GetSize() + 1); *(array_ + distance) = std::make_pair(key,val); IncreaseSize(1); return GetSize(); } Insert_in_leaf å¯¹äºä¸éœ€è¦åˆ›å»ºæ–°æ ‘çš„æƒ…å†µï¼Œä¸€å¾‹å½’ç±»äºå‘å¶å­èŠ‚ç‚¹å½“ä¸­æ’å…¥æ•°æ®\nå…ˆé€šè¿‡GetValueå½“ä¸­å®ç°çš„FindLeafæ‰¾åˆ°å¯¹åº”çš„å¶å­èŠ‚ç‚¹ï¼Œä¹‹åç›´æ¥å‘å…¶ä¸­æ’å…¥ï¼Œå¦‚æœå¶å­èŠ‚ç‚¹çš„å¤§å°æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œé‚£ä¹ˆåˆ™è¯æ˜ä¸ºé‡å¤çš„keyï¼Œç›´æ¥è¿”å›å³å¯ã€‚\nå¦‚æœå¤§å°å‘ç”Ÿå˜åŒ–ä½†æ˜¯æ²¡æœ‰è¶…å‡ºæœ€å¤§å€¼ï¼Œæ— éœ€è¿›è¡Œåˆ†è£‚ï¼Œä¹Ÿç›´æ¥è¿”å›å³å¯ã€‚\nå‰©ä½™çš„æƒ…å†µåˆ™æ˜¯éœ€è¦è¿›è¡Œåˆ†è£‚ã€‚\nå¶å­èŠ‚ç‚¹åˆ†è£‚â€‹\né¦–å…ˆä»buffer poolå½“ä¸­è·å–å‡ºä¸€ä¸ªæ–°çš„Pageç”¨äºæ‰¿è½½åˆ†è£‚å¾—æ¥çš„æ–°page åŸæœ¬çš„èŠ‚ç‚¹ä¿ç•™minSizeï¼ˆmaxSize / 2 )ä¸ªæ•°æ®ï¼Œå…¶ä»–çš„å…¨éƒ¨æ‹·è´è‡³æ–°çš„èŠ‚ç‚¹ï¼Œæœ€ç»ˆçš„æ–°èŠ‚ç‚¹å½“ä¸­çš„æ•°æ®è¾ƒå¤š å½“å®Œæˆå¶å­èŠ‚ç‚¹çš„åˆ†è£‚ä¹‹åï¼Œå¹¶å°†è¿æ¥å…³ç³»è®¾ç½®å¥½ä¹‹åï¼Œå·¦å³è¿æ¥ï¼ŒparentIdï¼Œä¹‹åå†è°ƒç”¨InsertIntoParentå°†å³èŠ‚ç‚¹çš„ç¬¬ä¸€ä¸ªæ’å…¥åˆ°çˆ¶èŠ‚ç‚¹å½“ä¸­ã€‚\nInsertIntoParent é¦–å…ˆéœ€è¦è¯´æ˜çš„æ˜¯è°ƒç”¨InsertIntoParentçš„æ—¶æœºä¸€å®šæ˜¯åœ¨å¶å­èŠ‚ç‚¹å½“ä¸­æ’å…¥å¼•å‘äº†åˆ†è£‚ï¼Œä¹‹åå°†æ–°åˆ†è£‚å‡ºçš„å³èŠ‚ç‚¹çš„ç¬¬ä¸€ä¸ªkeyå°è¯•æ’å…¥åˆ°çˆ¶äº²èŠ‚ç‚¹å½“ä¸­\nå¯¹äºä¼ªä»£ç å½“ä¸­çš„ä¸€æ¡æ¡æ¥çœ‹ï¼š\nå¦‚æœNä¸ºæ ¹èŠ‚ç‚¹ï¼šåˆ™åˆ›å»ºæ–°çš„æ ¹èŠ‚ç‚¹ï¼Œinsert_in_parentç”±å¶å­èŠ‚ç‚¹å¼€å§‹è°ƒç”¨ï¼Œè€Œæ­¤æ—¶Nä¸ºæ ¹èŠ‚ç‚¹åˆ™è¯æ˜å·²ç»é€’å½’åˆ°å¯¹æ ¹èŠ‚ç‚¹è¿›è¡Œåˆ†è£‚ï¼ŒNâ€˜å³ä¸ºNçš„æ–°å…„å¼ŸèŠ‚ç‚¹ï¼Œå› æ­¤éœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„æ ¹èŠ‚ç‚¹ï¼Œä»¥Nï¼ŒNâ€˜ä¸ºå­èŠ‚ç‚¹ï¼Œ\nå¯¹åº”ä»¥ä¸‹çš„æƒ…å†µï¼šK\u0026rsquo; = 0003\nPæœ‰ä¸åˆ°nä¸ªæŒ‡é’ˆï¼Œè¿˜æœªæ»¡ï¼Œåœ¨çˆ¶èŠ‚ç‚¹å½“ä¸­ç›´æ¥æ’å…¥å¹¶ç»“æŸï¼Œæ²¡ä»€ä¹ˆå¥½è¯´çš„\næ­¤æ—¶å°†6æ’å…¥åˆ°çˆ¶èŠ‚ç‚¹å½“ä¸­ï¼Œçˆ¶èŠ‚ç‚¹ä¹Ÿæ— æ³•å®¹ä¸‹ï¼Œå¯¹çˆ¶èŠ‚ç‚¹è¿›è¡Œåˆ†è£‚ï¼Œåˆ†è£‚å®Œä¹‹åé€’å½’è°ƒç”¨ï¼Œåœ¨å°†5æ’å…¥åˆ°ä¸Šä¸€çº§çš„çˆ¶èŠ‚ç‚¹å½“ä¸­ï¼Œæ­¤æ—¶å¯ä»¥å®¹ä¸‹5ï¼Œå› æ­¤ä¸è¿›è¡Œåˆ†è£‚ï¼Œç»ˆæ­¢æ’å…¥\nåœ¨æ•´ä¸ªæ’å…¥è¿‡ç¨‹å½“ä¸­ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„å®ç°å°±æ˜¯åˆ†è£‚ï¼Œåˆ†è£‚çš„è¿‡ç¨‹ä¸¥æ ¼æŒ‰ç…§ä¼ªä»£ç æ‰€ç»™çš„è¿›è¡Œå®ç°ï¼Œå¯¹äºå¶å­èŠ‚ç‚¹å’Œå†…éƒ¨èŠ‚ç‚¹åœ¨åˆ†è£‚ä¸Šçš„å®ç°æœ‰æ‰€ä¸åŒï¼Œå› æ­¤å®šä¹‰ä¸€ä¸ªSplitæ¥å¯¹å¶å­èŠ‚ç‚¹å’Œå†…éƒ¨èŠ‚ç‚¹çš„æ•°æ®è¿ç§»å’ŒæŒ‡é’ˆæŒ‡å‘æ›´æ”¹ã€‚\nåˆ›å»ºä¸€å—å†…å­˜å—ç”¨äºå­˜æ”¾æ‰€æœ‰çš„ä¹‹å‰çš„æ‰€æœ‰æ•°æ®å’Œè¦æ–°æ’å…¥çš„K\u0026rsquo; N\u0026rsquo;ï¼Œ å°†æ—§èŠ‚ç‚¹çš„æ‰€æœ‰çš„æ•°æ®éƒ½æ‹·è´åˆ°å…¶ä¸­ï¼Œæ–°æ’å…¥çš„Kâ€˜N\u0026rsquo;ä¹ŸåŠ å…¥åˆ°å…¶ä¸­ ã€‚ å®ŒæˆèŠ‚ç‚¹çš„åˆ†è£‚ï¼Œå‰ä¸€ä¸ªèŠ‚ç‚¹ä¿å­˜min_sizeä¸ªèŠ‚ç‚¹ï¼Œåä¸€ä¸ªèŠ‚ç‚¹ä¿å­˜å…¶ä»–çš„æ‰€æœ‰èŠ‚ç‚¹ æŒ‰ç…§ä¼ªä»£ç æè¿°ï¼Œå‰ä¸€ä¸ªèŠ‚ç‚¹åº”å½“ä¿å­˜(n+1)/2å‘ä¸Šå–æ•´ä¸ªèŠ‚ç‚¹ï¼Œå› æ­¤å¦‚æœæ˜¯åŸºæ•°ä¸ªçš„è¯ï¼Œé‚£ä¹ˆå‰ä¸€ä¸ªèŠ‚ç‚¹ä¼šæ¯”åä¸€ä¸ªèŠ‚ç‚¹å¤šä¸€ä¸ªï¼Œä½†æ˜¯ä¸ªäººè®¤ä¸ºè¿™ä¸ªæ˜¯æ— æ‰€è°“çš„ï¼Œå› ä¸ºä¸¤ç§å®ç°æ–¹æ³•éƒ½èƒ½å¤Ÿè¾¾åˆ°å¹³è¡¡ï¼Œåœ¨ç½‘ä¸Šçœ‹åˆ°çš„ä¸¤ä¸ªB+æ ‘çš„æ¼”ç¤ºåŠ¨ç”»ä¹Ÿé‡‡ç”¨äº†ä¸¤ç§ä¸åŒçš„å®ç°æ–¹å¼ã€‚\nåœ¨åˆ†è£‚ä¸Šçš„å®ç°ä¹Ÿä¸æ˜¯å¾ˆç»Ÿä¸€ï¼Œç”±äºå¯¹äºå¶å­èŠ‚ç‚¹çš„åˆ†è£‚ä½¿ç”¨äº†å…ˆæ’å…¥ä¹‹ååœ¨åˆ¤æ–­çš„æ–¹å¼ï¼Œå› æ­¤ç›´æ¥åˆ†è£‚å³å¯ï¼Œå¯¹äºå†…éƒ¨èŠ‚ç‚¹éœ€è¦åœ¨åˆ†è£‚å‰è¡¥ä¸Šæ–°çš„æ•°æ®ã€‚ä¼ªä»£ç å½“ä¸­çš„ä¸´æ—¶å†…å­˜å—å…¶å®ä¸ä½¿ç”¨ä¹Ÿå¯ï¼Œç›´æ¥åœ¨åŸèŠ‚ç‚¹ä¸Šè¿›è¡Œæ“ä½œå°±è¡Œäº†ã€‚æ­£ç¡®æ€§ä¸Šä¹Ÿå¯ä»¥å¾—åˆ°ä¿è¯(åšå®Œä¹‹ååœ¨ç½‘ä¸Šçœ‹åˆ°äº†è¯´ç›´æ¥æ’å…¥ä¼šå¯¼è‡´è¶…å‡ºå¤§å°é™åˆ¶ï¼Œä½†æ˜¯æˆ‘è‡ªå·±åšä¸‹æ¥æŒ‰ç…§ç›´æ¥æ’å…¥çš„æ–¹å¼å¹¶æ²¡æœ‰å‡ºç°ä»€ä¹ˆé—®é¢˜)\n1 2 3 4 5 6 parent_node-\u0026gt;InsertAfterNode(old_node-\u0026gt;GetPageId(), key, new_node-\u0026gt;GetPageId()); auto parent_sibling_node = Split(parent_node); auto new_key = parent_sibling_node-\u0026gt;KeyAt(0); InsertIntoParent(parent_node, new_key, parent_sibling_node); buffer_pool_manager_-\u0026gt;UnpinPage(parent_page-\u0026gt;GetPageId(), true); buffer_pool_manager_-\u0026gt;UnpinPage(parent_sibling_node-\u0026gt;GetPageId(), true); Delete ç›¸å¯¹äºæ’å…¥æ¥è¯´ï¼Œåˆ é™¤çš„é€»è¾‘å°±å¤æ‚çš„å¤š,å‡½æ•°æ‹†åˆ†æ–¹å¼å¦‚ä¸Šï¼Œè¿˜æ˜¯ä¸€æ¡æ¡çš„çœ‹ã€‚\nä¸‹é¢çš„ä¾‹å­å…¨ä»¥MaxDegree = 4ï¼ŒMaxSize = 4,MinSize = 2æ¥è¿›è¡Œè®¨è®º\næœ€å¼€å§‹é€šè¿‡FindLeaf() æ‰¾åˆ°Keyæ‰€åœ¨çš„leaf_pageï¼Œä¹‹åè°ƒç”¨delete_entryè¿›è¡Œåˆ é™¤ï¼Œä¸è¿‡ç”±äºåç»­æ¶‰åŠåˆ°é€’å½’è°ƒç”¨ï¼Œå› æ­¤å¯ä»¥æŠŠä»leaf_pageä¸­åˆ é™¤çš„é€»è¾‘ç§»åˆ°delete_entryå¤–é¢\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 INDEX_TEMPLATE_ARGUMENTS void BPLUSTREE_TYPE::Remove(const KeyType \u0026amp;key, Transaction *transaction) { if (IsEmpty()) { return; } auto leaf_page = FindLeaf(key, transaction); auto *node = reinterpret_cast\u0026lt;LeafPage *\u0026gt;(leaf_page-\u0026gt;GetData()); if (node-\u0026gt;IsLeafPage()) { auto before_size = node-\u0026gt;GetSize(); auto size = node-\u0026gt;Delete(key, comparator_); if (before_size == size) { // cannot find the key; return; } } DeleteEntry(node, key); } AdjustRoot ä¸€æ£µæ ‘çš„åˆå§‹çŠ¶æ€å¦‚ä¸‹ï¼Œæ­¤æ—¶å¦‚æœéœ€è¦ä»ä¸­åˆ é™¤æ‰Key = 3ï¼Œå¶å­èŠ‚ç‚¹å½“ä¸­çš„keyä¸å¤Ÿï¼Œå¹¶ä¸”èƒ½å¤Ÿä¸å·¦èŠ‚ç‚¹åˆå¹¶è€Œä¸è¾¾åˆ°MaxSizeï¼Œå› æ­¤è¿›è¡Œåˆå¹¶\nåˆå¹¶ç»“æœå¦‚ä¸‹ï¼Œæ­¤æ—¶çš„3å·èŠ‚ç‚¹å½“ä¸­åªæœ‰ä¸€ä¸ªæŒ‡é’ˆï¼Œå°äºmin_sizeï¼ŒåŒæ ·çš„ä¸å³èŠ‚ç‚¹åˆå¹¶ä¹‹åä¸ä¼šè¶…è¿‡max_sizeï¼Œå› æ­¤åˆå¹¶\nåˆå¹¶çš„ç»“æœå¦‚ä¸‹ï¼Œå¹¶ä¸”åˆå¹¶ä¹‹åä¼šåœ¨é€’å½’è°ƒç”¨ä¸€æ¬¡delete_entryï¼Œæ­¤æ—¶ä¼ å…¥çš„èŠ‚ç‚¹å³ä¸ºparent(N)ï¼Œæ‰¾åˆ°äº†æ ¹èŠ‚ç‚¹ï¼Œå¹¶ä¸”æ­¤æ—¶çš„æ ¹èŠ‚ç‚¹åªæœ‰ä¸€ä¸ªå­©å­ï¼Œè¾¾åˆ°äº†AdjustRootçš„æ¡ä»¶ï¼š\næœ€ç»ˆAdjustRootçš„ç»“æœå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 INDEX_TEMPLATE_ARGUMENTS auto BPLUSTREE_TYPE::AdjustRoot(BPlusTreePage *old_root_node) -\u0026gt; bool { if (!old_root_node-\u0026gt;IsLeafPage() \u0026amp;\u0026amp; old_root_node-\u0026gt;GetSize() == 1) { auto *root_node = reinterpret_cast\u0026lt;InternalPage *\u0026gt;(old_root_node); auto only_child_page = buffer_pool_manager_-\u0026gt;FetchPage(root_node-\u0026gt;ValueAt(0)); auto only_child_node = reinterpret_cast\u0026lt;BPlusTreePage *\u0026gt;(only_child_page); only_child_node-\u0026gt;SetParentPageId(INVALID_PAGE_ID); root_page_id_ = only_child_node-\u0026gt;GetPageId(); UpdateRootPageId(0); buffer_pool_manager_-\u0026gt;DeletePage(old_root_node-\u0026gt;GetPageId()); return true; } return false; } Coalesceï¼š å½“ä¸¤ä¸ªèŠ‚ç‚¹åˆå¹¶ä¹‹åä»å°äºMaxSizeæ—¶ï¼Œå¯¹ä¸¤ä¸ªèŠ‚ç‚¹è¿›è¡Œåˆå¹¶ï¼Œåœ¨é€»è¾‘ä¸ŠåŒæ ·éœ€è¦åˆ†ä¸ºå¯¹å¶å­èŠ‚ç‚¹è¿›è¡Œæ“ä½œå’Œå¯¹å†…éƒ¨èŠ‚ç‚¹è¿›è¡Œæ“ä½œï¼Œç”±äºåœ¨ä¸Šè¿°AdjustRootçš„ä¾‹å­å½“ä¸­å·²ç»æ¶‰åŠåˆ°äº†æ ¹èŠ‚ç‚¹çš„åˆå¹¶å’Œå¶å­èŠ‚ç‚¹çš„åˆå¹¶ï¼Œå› æ­¤å°±è¿˜ç”¨ä¸Šé¢çš„ä¾‹å­\nå¶å­èŠ‚ç‚¹çš„åˆå¹¶\nåˆå§‹æ ‘ï¼š\nå°†3è¿›è¡Œåˆ é™¤ï¼Œä¹‹åå‘ç°å…¶å·¦èŠ‚ç‚¹ä¸ä¹‹åˆå¹¶ä¹‹åä»å°äºmax_sizeï¼Œæ­¤æ—¶çš„Nä¸ºè‡ªèº«ï¼ŒN\u0026rsquo;ä¸ºå…¶å·¦èŠ‚ç‚¹ï¼ŒK\u0026rsquo;ä¸º3ï¼Œ æ‰§è¡Œåˆå¹¶ï¼Œå°†å³å¶å­èŠ‚ç‚¹å½“ä¸­çš„æ‰€æœ‰KVç§»åŠ¨åˆ°å·¦èŠ‚ç‚¹å½“ä¸­ é€’å½’è°ƒç”¨delete_entryï¼Œåœ¨çˆ¶äº²èŠ‚ç‚¹å½“ä¸­å°è¯•åˆ é™¤æ‰K\u0026rsquo;(3) é€’å½’å®Œä¹‹åæ¸…é™¤æ‰N æœ€ç»ˆç»“æœå¦‚ä¸‹ï¼Œè€Œå½“å‰çš„3å·pageå½“ä¸­åªæœ‰ä¸€ä¸ªæŒ‡é’ˆï¼Œå› æ­¤æ˜¯ä¸ç¨³å®šçš„ï¼Œå¹¶ä¸”å¤§å°å…è®¸åˆå¹¶ï¼Œæ‰§è¡Œå†…éƒ¨èŠ‚ç‚¹çš„åˆå¹¶\nå†…éƒ¨èŠ‚ç‚¹çš„åˆå¹¶â€‹\nåˆå§‹æ ‘ï¼Œå·²ç»åˆ é™¤æ‰Kä¹‹å\nNä¸ºè‡ªèº«èŠ‚ç‚¹ï¼ŒN\u0026rsquo;ä¸ºå…¶å³èŠ‚ç‚¹ï¼ŒK\u0026rsquo;æŒ‰ç…§å®šä¹‰å³ä¸º10ï¼Œå°†Nä½œä¸ºæœ€ç»ˆåˆå¹¶åçš„å­˜å‚¨èŠ‚ç‚¹ å› æ­¤å…ˆå°†K\u0026rsquo;æ·»åŠ åˆ°Nå½“ä¸­ï¼Œä¹‹ååœ¨å°†N\u0026rsquo;å½“ä¸­æ‰€æœ‰çš„KVæ·»åŠ åˆ°å…¶ä¸­ï¼ˆä¸åŒ…æ‹¬ç¬¬ä¸€ä¸ªç©ºçš„Kï¼‰ æœ€ç»ˆç»“æœå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 auto BPlusTree\u0026lt;KeyType, ValueType, KeyComparator\u0026gt;::Coalesce( N *left_node, N *right_node, BPlusTreeInternalPage\u0026lt;KeyType, page_id_t, KeyComparator\u0026gt; *parent, int index) -\u0026gt; bool { auto middle_key = parent-\u0026gt;KeyAt(index); if (!right_node-\u0026gt;IsLeafPage()) { auto *internal_node = reinterpret_cast\u0026lt;InternalPage *\u0026gt;(right_node); auto *internal_left_node = reinterpret_cast\u0026lt;InternalPage *\u0026gt;(left_node); internal_node-\u0026gt;MoveAllTo(internal_left_node, middle_key, buffer_pool_manager_); } else { auto *leaf_node = reinterpret_cast\u0026lt;LeafPage *\u0026gt;(right_node); auto *leaf_left_node = reinterpret_cast\u0026lt;LeafPage *\u0026gt;(left_node); leaf_node-\u0026gt;MoveAllTo(leaf_left_node); parent-\u0026gt;Remove(index); } DeleteEntry(parent, middle_key); buffer_pool_manager_-\u0026gt;DeletePage(right_node-\u0026gt;GetPageId()); return true; } Redistribute åŒæ ·éœ€è¦åˆ†ä¸ºå¶å­èŠ‚ç‚¹å’Œå†…éƒ¨èŠ‚ç‚¹æ¥è¿›è¡Œè®¨è®ºï¼Œå†…éƒ¨èŠ‚ç‚¹ç”±äº0å·ä½Keyä¸ºç©ºï¼Œå› æ­¤æ— æ³•åƒåˆå¹¶é‚£æ ·ç›´æ¥äº¤æ¢é¡ºåºå³å¯ï¼Œè€Œæ˜¯éœ€è¦å®ç°ä¸€ä¸ªé€»è¾‘ä¸Šä¸€æ ·çš„å¯¹ç§°æ“ä½œã€‚\nå¶å­èŠ‚ç‚¹é‡åˆ†é…â€‹\nåˆå§‹æ ‘ï¼š\næ­¤æ—¶å°è¯•ä»ä¸­åˆ é™¤æ‰23ï¼Œæ­¤æ—¶è¯¥å¶å­èŠ‚ç‚¹å½“ä¸­å°±åªå‰©ä¸‹ä¸€ä¸ªKVï¼Œå°äºmin_sizeï¼Œå¹¶ä¸”æ— æ³•å’Œå³èŠ‚ç‚¹è¿›è¡Œåˆå¹¶ï¼Œå› æ­¤éœ€è¦è¿›è¡Œredistribute(ä»£ç é€»è¾‘ä¸­å…ˆåˆ¤æ–­æ˜¯å¦èƒ½è¿›è¡Œé‡åˆ†é…ï¼Œå¦‚æœä¸èƒ½åœ¨åç»­åˆ¤æ–­åˆå¹¶ï¼Œé‡åˆ†é…æœ¬èº«ä¸æ¶‰åŠåˆ°é€’å½’è°ƒç”¨ï¼Œå› æ­¤å¯¹æ•´ä¸ªB+æ ‘çš„è°ƒæ•´èŒƒå›´å°ï¼Œå¼€é”€è¾ƒå°)\nè‡ªèº«ä¸ºNï¼Œå³èŠ‚ç‚¹ä¸ºNâ€˜ï¼Œå°†Nâ€˜å½“ä¸­çš„ç¬¬ä¸€ä¸ªKVç§»åŠ¨è‡³Nçš„æœ«å°¾ï¼Œå¹¶ä¸”å°†parentå½“ä¸­N,N\u0026rsquo;ä¸­é—´çš„keyæ›¿æ¢ä¸ºç§»åŠ¨ä¹‹åçš„Nâ€˜å½“ä¸­çš„ç¬¬ä¸€ä¸ªKï¼ˆ25ï¼‰ï¼Œæœ€ç»ˆç»“æœå¦‚ä¸‹ï¼š\nå¶å­èŠ‚ç‚¹çš„ä¸ºå®Œå…¨å¯¹ç§°çš„ï¼Œå› æ­¤åªéœ€è¦å®Œå…¨å¯¹ç§°çš„å®ç°å³å¯ï¼Œå°†ç¬¬ä¸€ä¸ªæ”¹ä¸ºæœ€åä¸€ä¸ªï¼Œé€»è¾‘ä¸Šå®Œå…¨ä¸€è‡´ã€‚\n1 2 3 4 5 6 7 8 9 10 11 if (node-\u0026gt;IsLeafPage()) { auto *leaf_node = reinterpret_cast\u0026lt;LeafPage *\u0026gt;(node); auto *leaf_neighbor_node = reinterpret_cast\u0026lt;LeafPage *\u0026gt;(node); if (from_prev) { leaf_neighbor_node-\u0026gt;MoveLastToFrontOf(leaf_node); parent-\u0026gt;SetKeyAt(index, leaf_node-\u0026gt;KeyAt(0)); } else { leaf_neighbor_node-\u0026gt;MoveFrontToLastOf(leaf_node); parent-\u0026gt;SetKeyAt(index, leaf_neighbor_node-\u0026gt;KeyAt(0)); } } å†…éƒ¨èŠ‚ç‚¹é‡åˆ†é…â€‹\nåˆå§‹æ ‘å’Œä»ä¸­åˆ é™¤æ‰3ä¹‹åçš„çŠ¶æ€åˆ†åˆ«å¦‚ä¸‹ï¼š\næ­¤æ—¶å·¦ä¾§åªå‰©ä¸‹ä¸€ä¸ªæŒ‡é’ˆï¼Œå¹¶ä¸”åˆå¹¶ä¼šå¤§äºmax_sizeï¼Œå› æ­¤è¿›è¡Œé‡åˆ†é…ï¼ŒNä¸ºè‡ªèº«ï¼ŒN\u0026rsquo;ä¸ºå…¶å³èŠ‚ç‚¹ æ‰¾åˆ°N\u0026rsquo;å½“ä¸­çš„ç¬¬ä¸€ä¸ªKVï¼Œè®°ä¸º(K1,V1)ï¼Œå°†å…¶æ·»åŠ åˆ°Nçš„æœ«å°¾ æ‰¾åˆ°åœ¨parent(N)å½“ä¸­çš„Nä¸N\u0026rsquo;æŒ‡é’ˆä¹‹é—´çš„K\u0026rsquo;ï¼Œå°†Nçš„æœ€åä¸€ä¸ªKè®¾ç½®ä¸ºK\u0026rsquo;ï¼Œå¹¶å°†parent(N)å½“ä¸­çš„K\u0026rsquo;è®¾ç½®ä¸ºK1 æœ€ç»ˆç»“æœå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 auto *internal_node = reinterpret_cast\u0026lt;InternalPage *\u0026gt;(node); auto *internal_neighbor_node = reinterpret_cast\u0026lt;InternalPage *\u0026gt;(neighbor_node); if (from_prev) { internal_neighbor_node-\u0026gt;MoveLastToFrontOf(internal_node, parent-\u0026gt;KeyAt(index), buffer_pool_manager_); parent-\u0026gt;SetKeyAt(index, internal_node-\u0026gt;KeyAt(0)); } else { auto new_parent_key = internal_neighbor_node-\u0026gt;KeyAt(1); internal_neighbor_node-\u0026gt;MoveFrontToLastOf(internal_node, parent-\u0026gt;KeyAt(index + 1), buffer_pool_manager_); parent-\u0026gt;SetKeyAt(index + 1, new_parent_key); } å¯¹äºå†…éƒ¨èŠ‚ç‚¹çš„é‡åˆ†é…ï¼Œå­˜åœ¨é‚£ä¹ˆä¸€ç‚¹ä¸å¯¹ç§°çš„æƒ…å†µï¼š\nå³ä¸Šè¿°ä¾‹å­ä¸ºåœ¨å·¦èŠ‚ç‚¹å½“ä¸­æ£€æµ‹åˆ°éœ€è¦è¿›è¡Œåˆå¹¶ï¼Œç”±äºç¬¬ä¸€ä¸ªç©ºkeyçš„å­˜åœ¨ï¼ŒK\u0026rsquo;çš„ä½ç½®åº”å½“ä¸ºindex + 1,(indexä¸ºNåœ¨parentå½“ä¸­çš„ä½ç½®)ï¼Œè€Œå¦‚æœæ˜¯ä»å³ä¾§æ£€æµ‹åˆ°éœ€è¦è¿›è¡Œé‡åˆ†é…ï¼ŒK\u0026rsquo;å³ä¸ºindex å³ä¾§å‘å·¦ä¾§æ·»åŠ æ—¶åº”å½“æ·»åŠ index = 1çš„KVï¼Œè·³è¿‡ç©ºKeyï¼Œå·¦ä¾§å‘å³ä¾§æ·»åŠ æ—¶ï¼ŒåŒæ ·æ·»åŠ åˆ°ä¸€å·ä½ç½® å®ç°çš„æ—¶å€™æ³¨æ„ä¸€ä¸‹å³å¯ã€‚\n","permalink":"https://fischer0522.github.io/en/posts/tech/bustub/bustub-lab2-c1/","summary":"Lab2 å¯¹äºLabçš„debugï¼Œç”±äºå¹¶æ²¡æœ‰å¼€æ”¾æµ‹è¯•æ ·ä¾‹ï¼Œå› æ­¤æœ€å¥½çš„å°±æ˜¯æ‰¾ä¸€ä¸ªåˆé€‚çš„b+æ ‘çš„æ¨¡æ‹ŸåŠ¨ç”»ï¼Œç„¶åå†ä½¿ç”¨å®˜æ–¹çš„ç”»å›¾å·¥å…·æ¯”è¾ƒè‡ªå·±çš„B+æ ‘ï¼Œä¸€èˆ¬","title":"BusTub Lab2 B+Tree Index checkpoint1"},{"content":"BusTub Lab1 Buffer Pool Manager Task1 å¯æ‰©å±•å“ˆå¸Œè¡¨ ç›¸å…³å‡½æ•° Find(K,V)â€‹ï¼šæŸ¥è¯¢ä¸€ä¸ªKeyæ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨åˆ™å°†å…¶VæŒ‡é’ˆæŒ‡å‘ç›¸å…³çš„å€¼ï¼Œè¿”å›trueï¼Œå¦åˆ™è¿”å›false\nInsert(K,V):æ’å…¥ä¸€ä¸ªå€¼ï¼Œå¦‚æœå·²ç»å­˜åœ¨ï¼Œåˆ™è¦†ç›–åŸæœ¬çš„å€¼ï¼Œè¿”å›trueï¼Œå¦‚æœå½“å‰k-vä¸èƒ½è¢«æ’å…¥ï¼ˆbucketæ»¡äº†ï¼Œå¹¶ä¸”ä¸æ˜¯å¯¹åŸæœ‰çš„keyè¿›è¡Œæ›´æ–°ï¼‰ï¼Œåˆ™ï¼š\nå¦‚æœå±€éƒ¨æ·±åº¦ï¼ˆå®¹é‡ï¼‰ç­‰äºå…¨å±€æ·±åº¦ï¼Œå¢åŠ å…¨å±€æ·±åº¦ï¼Œå¹¶ä¸”å¯¹dictçš„å®¹é‡ç¿»å€ å¢åŠ å½“å‰è¦æ’å…¥çš„bucketçš„æ·±åº¦ åˆ†è£‚å½“å‰çš„bucketï¼Œå¯¹å…¶è¿›è¡Œrehash ä¹‹åå†è¿›è¡Œé‡è¯•ï¼Œåœ¨æ­¤Labå½“ä¸­ï¼Œåœ¨æ’å…¥ä¹‹å‰è¿›è¡Œå®¹é‡çš„æ£€æµ‹å¹¶è¿›è¡Œrehash\nRemove(K):åˆ é™¤ç»™å®šçš„Keyï¼Œå­˜åœ¨åˆ™è¿”å›trueï¼Œå¦åˆ™è¿”å›false\nGetGlobalDepth():è¿”å›å…¨å±€æ·±åº¦\nGetNumBuckets():è¿”å›å½“å‰å­˜åœ¨çš„bucketçš„æ€»é‡\nHintï¼š\nå¯ä»¥ä½¿ç”¨IndexOf(K)â€‹æ¥æ±‚å‡ºå½“å‰Keyæ‰€å±çš„bucket Bucketä½œä¸ºä¸€ä¸ªå†…åµŒç±»ä¹‹äºHashTable ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œä½¿ç”¨std::mutex å®ç° é€»è¾‘ä¸Šè¾ƒä¸ºæ¸…æ™°ï¼Œé¦–å…ˆå®ç°Bucketç±»ï¼Œåœ¨KVçš„ç®¡ç†ä¸Šï¼Œéœ€è¦å®ç°Findã€Insertã€Removeæ“ä½œï¼Œå¹¶ä¸”éœ€è¦æœ‰ä¸€ç³»åˆ—è·å–ç›¸å…³ä¿¡æ¯çš„æ“ä½œï¼Œ\nBucketæœ¬èº«æ˜¯ç”±ä¸€ä¸ªé“¾è¡¨è¿›è¡Œç»„ç»‡çš„ï¼Œå®ç°ä¸Šç›´æ¥è°ƒç”¨std::listçš„APIå³å¯\nä¸»è¦è®¨è®ºä¸€ä¸‹Hashè¿‡ç¨‹\nå¯¹äºå¯æ‰©å±•å“ˆå¸Œï¼Œä¸»è¦æœ‰å››ä¸ªå˜é‡ï¼š\nsize_dir_ï¼šè¡¨ç¤ºæ•´ä¸ªç›®å½•çš„å¤§å°ï¼Œæ‰©å±•æ—¶è¿›è¡Œç¿»å€ size_bucket_ï¼šä¸€ä¸ªbucketä¸­èƒ½å¤Ÿå­˜æ”¾çš„æœ€å¤§çš„å…ƒç´ ï¼Œä¸ºå›ºå®šå€¼ global_depthï¼šæ ¹æ®global_depthçš„ä½æ•°å°†key hashåˆ°å¯¹åº”çš„bucketå½“ä¸­ local_depthï¼šåœ¨bucket splitæ—¶ä½¿ç”¨local_depthè¿›è¡Œrehash åœ¨å¼•å…¥äº†æ·±åº¦çš„æ¦‚å¿µä¹‹åï¼Œç”±äºå¯æ‰©å±•å“ˆå¸Œåˆ†ä¸ºbucketå’Œbucketå½“ä¸­çš„å…ƒç´ ï¼Œå¯¹åº”çš„å°±æœ‰å…¨å±€æ·±åº¦å’Œæœ¬åœ°æ·±åº¦çš„åŒºåˆ†ï¼Œå¦‚æœå…¨å±€æ·±åº¦ä¸º2ï¼Œåˆ™è¯æ˜å½“å‰è‡³å¤šåªèƒ½æœ‰4ä¸ªBucketï¼Œï¼ˆè€Œå®é™…çš„bucketæ•°é‡å¯èƒ½å¹¶æ²¡æœ‰4ä¸ªï¼Œå­˜åœ¨å¤šä¸ªdiræŒ‡å‘åŒä¸€ä¸ªbucketçš„æƒ…å†µï¼‰è€Œå¦‚æœæœ¬åœ°æ·±åº¦ä¸º2ï¼Œåˆ™ä¸‹æ¬¡bucketè¿›è¡Œåˆ†è£‚æ—¶ï¼Œä½¿ç”¨local_depth +1â€‹ä½è¿›è¡Œrehash(å¦‚æœè®¤ä¸ºæœ€å³ä¸€ä½ä¸ºç¬¬1ä½ï¼Œå®é™…ä¸Šåªéœ€è¦å°†1å·¦ç§»local_depthä½å³å¯ï¼‰\nåœ¨æœç´¢æ—¶ï¼Œå…ˆæ ¹æ®global_depthâ€‹æ‰¾åˆ°æ‰€å±çš„bucketï¼Œå†åœ¨bucketå…¶ä¸­éå†å¯»æ‰¾åˆ°å…ƒç´ \næ˜ç¡®äº†æ¦‚å¿µä¹‹åï¼Œå¯ä»¥æ‹ä¸€ä¸‹æ•´ä¸ªè¿‡ç¨‹ï¼š\nå°è¯•å‘å…¶ä¸­æ’å…¥[0,1,2,3,4,5]\nå½“bucketæ»¡äº†æ—¶ï¼š\nå¦‚æœå±€éƒ¨æ·±åº¦ï¼ˆå®¹é‡ï¼‰ç­‰äºå…¨å±€æ·±åº¦ï¼Œå¢åŠ å…¨å±€æ·±åº¦ï¼Œå¹¶ä¸”å¯¹dictçš„å®¹é‡ç¿»å€ å¢åŠ å½“å‰è¦æ’å…¥çš„bucketçš„æ·±åº¦ åˆ†è£‚å½“å‰çš„bucketï¼Œå¯¹å…¶è¿›è¡Œrehash æœ€åˆåœ¨åˆå§‹åŒ–æ—¶ï¼Œglobal_depth = 0â€‹ local_depth = 0â€‹,æ­¤æ—¶åªæœ‰ä¸€ä¸ªbucketï¼Œå¹¶ä¸”å½“ä¸­èƒ½å¤Ÿå­˜æ”¾ä¸€ä¸ªå…ƒç´  ä¹‹åå‘å…¶ä¸­æ’å…¥å…ƒç´ 1ï¼Œè€Œæ­¤æ—¶bucketå½“ä¸­æœ‰ä¸¤ä¸ªå…ƒç´ ï¼Œéœ€è¦å¯¹å…¶è¿›è¡ŒåŒºåˆ†ï¼Œ(è§¦å‘äº†å…¨å±€æ·±åº¦ç­‰äºæœ¬åœ°æ·±åº¦çš„æ¡ä»¶)ï¼Œå› æ­¤ï¼š\nå¢åŠ å…¨å±€æ·±åº¦ï¼Œglobal_depth = 1â€‹,bucketæ•°é‡ç¿»å€ å¢åŠ æœ¬åœ°æ·±åº¦ï¼Œlocal_depth = 1â€‹ rehash è¯´ä¸€ä¸‹æœ€åçš„rehashçš„è¿‡ç¨‹ï¼Œè™½ç„¶æ­¤æ—¶local_depth = 1â€‹ï¼Œä½†æ˜¯åœ¨gloabal_depth=1â€‹çš„æ¡ä»¶ä¸‹ï¼Œhashç 01æ— æ³•å®šä½åˆ°0å·bucketï¼Œå› æ­¤éœ€è¦å¯¹å…¶è¿›è¡Œrehash\næ­¤æ—¶å†å‘å…¶ä¸­æ’å…¥2ï¼ˆ10ï¼‰ï¼Œglobal_depth = 1â€‹å› æ­¤ä¼šè¢«rehashåˆ°0å·bucketå½“ä¸­ï¼Œè€Œ0å·bucketå¹¶æœªæ»¡ï¼Œå› æ­¤å¯ä»¥å°†å…¶æ’å…¥åˆ°å…¶ä¸­ï¼Œ3ï¼ˆ11ï¼‰åŒç†ï¼Œç»“æœå¦‚ä¸‹ï¼š\nå†å‘å…¶ä¸­æ’å…¥4(100),åœ¨global_depth = 1â€‹çš„æ¡ä»¶ä¸‹è¢«åˆ†é…åˆ°0å·bucketï¼Œè€Œæ­¤æ—¶bucket0å·²æ»¡ï¼ŒæŒ‰ç…§ä¸Šé¢çš„è¦æ±‚æ­¥éª¤å¯¹bucket0å†splitä¸€æ¬¡ï¼Œæ’å…¥åçš„ç»“æœå¦‚ä¸‹ï¼š\næ’å…¥5å’Œ4åŒç†ï¼Œå°†bucket1è¿›è¡Œsplit,æœ€ç»ˆç»“æœå¦‚ä¸‹ï¼š\nè¿˜æœ‰ä¸€ç‚¹éœ€è¦è®¨è®ºçš„æ˜¯ï¼Œå¹¶ä¸æ˜¯é€šè¿‡gloal_depthâ€‹ + local_depthâ€‹å¯¹keyç»™è¿›è¡Œå®šä½ï¼Œå¯¹äºglobal_depthâ€‹ï¼Œæ—¢æ˜¯ä»£è¡¨å½“å‰çš„diræ•°é‡ï¼Œ2åˆ™ä»£è¡¨æœ‰00 01 10 11å››ä¸ªbucketï¼Œå¹¶ä¸”å¯¹äºä¸€ä¸ªå“ˆå¸Œç ï¼Œç¡®å®å¯ä»¥é€šè¿‡global_depthâ€‹ä½å°±å°†å…¶å½’äºå±äºçš„bucketå½“ä¸­ï¼Œä½†æ˜¯å¯¹äºlocal_depthâ€‹ï¼Œä»…ä»…åªæ˜¯åœ¨splitæ—¶ç”¨äºå°†å½“å‰bucketä¸­çš„å…ƒç´ å’Œæ–°æ’å…¥çš„å…ƒç´ rehashåˆ°ä¸åŒçš„bucketå½“ä¸­ï¼Œå³ä¸keyçš„æœç´¢æ— å…³ï¼Œä¹Ÿä¸bucketçš„å®¹é‡æ— å…³ã€‚\nå¯¹äºlocal_depteh \u0026lt; global_depthçš„bucketï¼Œä¼šå­˜åœ¨å¤šä¸ªdiræŒ‡å‘åŒä¸€ä¸ªbucketçš„æƒ…å†µï¼Œå½“local_depth = global_depthæ—¶ï¼Œåˆ™åªä¼šæœ‰ä¸€ä¸ªdiræŒ‡å‘è¯¥bucketã€‚\nè€Œåœ¨bucket splitæ—¶ï¼Œé€šè¿‡local_depthæ¥å†³å®šå…ƒç´ éƒ½å±äºå“ªä¸€ä¸ªæ–°çš„bucketå½“ä¸­ã€‚å³å°†1å·¦ç§»local_depthä½ï¼Œå³ä¸ºlocal_maskï¼Œhashè¯¥ä½ä¸º1çš„å½’äºä¸€ä¸ªbucketå½“ä¸­,ä¸º0çš„å½’äºä¸€ä¸ªbucketå½“ä¸­ã€‚\nä¹‹åå†å»è€ƒè™‘ä¸¤ä¸ªæ–°çš„bucketå‡éœ€è¦å±äºå“ªä¸ªdirï¼Œä¸Šä¸€æ­¥ä½ä¸ä¸º0åº”å½“å¯¹åº”åŸæœ¬çš„dir[i]ï¼Œè€Œå¦å¤–ä¸€ä¸ªåº”å½“ä¸ºdir[i+local_mask]ã€‚å› æ­¤ç°åœ¨æ‰€åšçš„å°±æ˜¯éœ€è¦æ‰¾åˆ°iä¸ºå¤šå°‘ï¼Œè®¡ç®—hashå€¼ç„¶åå–local_depthä½ï¼Œå†ä¸local_maskä½ä¸ï¼Œç»“æœä¸º0å³ä¸ºlow_bucket,ä¸º1å³ä¸ºhigh_bucketã€‚\næ­¤å¤–éœ€è¦è€ƒè™‘è¿ç»­åˆ†è£‚çš„é—®é¢˜ï¼Œå¦‚[0 1024 4]è¿›è¡Œä¸€æ¬¡splitä¸è¶³ä»¥å°†è¿™ä¸‰è€…åŒºåˆ†å¼€ï¼Œå› æ­¤ä¸€ç§è§£å†³æ–¹æ³•æ˜¯åœ¨splitæœ€åè°ƒç”¨extendiable_hash_tableä¸­çš„Insertï¼Œè€Œä¸æ˜¯è°ƒç”¨bucketçš„insertï¼Œè®©å“ˆå¸Œè¡¨çš„Insertå†å»åˆ¤æ–­ä¸€éæ˜¯å¦è¿˜éœ€è¦åˆ†è£‚ï¼Œä¸è¿‡è¿™æ ·åµŒå¥—è°ƒç”¨æ— æ³•ä½¿ç”¨RAIIç±»å‹çš„é”ï¼Œéœ€è¦æ‰‹åŠ¨å»åŠ é”è§£é”ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 template \u0026lt;typename K, typename V\u0026gt; void ExtendibleHashTable\u0026lt;K, V\u0026gt;::Insert(const K \u0026amp;key, const V \u0026amp;value) { //std::scoped_lock\u0026lt;std::mutex\u0026gt; lock(latch_); latch_.lock(); auto index = IndexOf(key); auto bucket = this-\u0026gt;dir_[index]; bool result = bucket-\u0026gt;Insert(key, value); if (result) { latch_.unlock(); return; } RedistributeBucket(bucket,key,value); } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 template \u0026lt;typename K, typename V\u0026gt; auto ExtendibleHashTable\u0026lt;K, V\u0026gt;::RedistributeBucket(std::shared_ptr\u0026lt;Bucket\u0026gt; bucket,const K \u0026amp;key,const V \u0026amp;value) -\u0026gt; void { if (!bucket-\u0026gt;IsFull()) { latch_.unlock(); return; } if (bucket-\u0026gt;GetDepth() == this-\u0026gt;GetGlobalDepthInternal()) { auto size = dir_.size(); dir_.reserve(size * 2); std::copy_n(dir_.begin(),size,std::back_inserter(dir_)); this-\u0026gt;global_depth_++; } auto last_depth = bucket-\u0026gt;GetDepth(); auto high_bucket = std::make_shared\u0026lt;Bucket\u0026gt;(bucket_size_,last_depth + 1); auto low_bucket = std::make_shared\u0026lt;Bucket\u0026gt;(bucket_size_,last_depth + 1); num_buckets_++; int local_mask = 1 \u0026lt;\u0026lt; last_depth; for (const auto \u0026amp;[k,v] : bucket-\u0026gt;GetItems()) { if (std::hash\u0026lt;K\u0026gt;()(k) \u0026amp; local_mask) { high_bucket-\u0026gt;Insert(k,v); } else { low_bucket-\u0026gt;Insert(k,v); } } for (auto i = std::hash\u0026lt;K\u0026gt;()(key) \u0026amp; (local_mask - 1);i \u0026lt; dir_.size();i += local_mask) { if (static_cast\u0026lt;bool\u0026gt; (i \u0026amp; local_mask)) { dir_[i] = high_bucket; } else { dir_[i] = low_bucket; } } //auto new_index = IndexOf(key); latch_.unlock(); this-\u0026gt;Insert(key,value); } åœ¨å®ç°ä¸Šå…ˆå®ç°Bucketå³å¯ï¼Œå…ˆå°†Bucketè®¾ç½®ä¸ºæ— é”çš„ç±»å‹ï¼Œå†æ•´ä¸ªHashTableä¸ŠåŠ ä¸€æŠŠå¤§é”ï¼Œåç»­å†è€ƒè™‘è¿›è¡Œæ”¹è¿›ï¼Œä»¥æé«˜å¹¶å‘åº¦\nTask2 LRU-K åœ¨æ·˜æ±°æ—¶é€‰æ‹©Backward k-distanceæœ€å¤§çš„è¿›è¡Œæ·˜æ±°ï¼ŒBackword-distanceä½¿ç”¨å½“å‰çš„æ—¶é—´æˆ³å’Œç¬¬å‰Kæ¬¡è®¿é—®çš„æ—¶é—´æˆ³è¿›è¡Œè®¡ç®—ï¼Œè¿˜æœªè¾¾åˆ°Kæ¬¡è®¿é—®çš„Backword-distanceè®°ä¸ºæ­£æ— ç©·ï¼Œè€Œå½“æœ‰å¤šä¸ªæ­£æ— ç©·æ—¶ï¼Œåˆ™é€‰æ‹©æœ€æ—©çš„æ—¶é—´æˆ³è¿›è¡Œæ·˜æ±°ã€‚\nLRUKReplacerâ€‹å’ŒBufferPoolâ€‹çš„å¤§å°ä¸€è‡´ï¼Œä½†æ˜¯ä»»ä½•æ—¶åˆ»ä¸‹å¹¶ä¸æ˜¯æ‰€æœ‰pageéƒ½ä¼šå»è€ƒè™‘è¢«æ·˜æ±°ï¼Œ\nç›¸å…³å‡½æ•° Evict(frame_id_t*):åœ¨è¢«Replacerè®°å½•çš„æ‰€æœ‰çš„å¯æ·˜æ±°çš„frameä¸­é€‰æ‹©Backward k-distanceæœ€å¤§çš„é‚£ä¸€ä¸ªï¼Œåœ¨å‚æ•°ä¸­ä¿å­˜æ·˜æ±°pageçš„Idï¼Œè¿”å›trueï¼Œå¦‚æœæ²¡æœ‰å¯æ·˜æ±°çš„frameåˆ™è¿”å›false RecordAccess(frame_id_t)â€‹ï¼šåŸºäºå½“å‰çš„æ—¶é—´æˆ³ï¼Œè®°å½•ç»™å®šçš„frameidï¼Œå½“ä¸€ä¸ªpageè¢«BufferPoolManagerâ€‹pinæ—¶è°ƒç”¨ Remove(frame_id_t)â€‹ï¼šæ¸…é™¤ä¸€ä¸ªframeçš„æ‰€æœ‰ç›¸å…³å†å²ï¼Œå½“pageè¢«åˆ é™¤æ—¶è°ƒç”¨ SetEvictable(frame_id_t,bool set_evictable)â€‹ï¼šæ ‡è®°ä¸€ä¸ªframeæ˜¯å¦å¯æ¸…ç† Size()â€‹è¿”å›å¯æ¸…é™¤çš„frameçš„æ•°é‡ã€‚ å®ç° ç›¸å…³æ¦‚å¿µ LRU-Kæ‰€é’ˆå¯¹çš„ä¸ºç¼“å­˜æ±¡æŸ“çš„é—®é¢˜ï¼Œå³é‡åˆ°å…¨è¡¨éå†ç­‰å¤§é‡è¯»å–å¤šä¸ªä¸é‡å¤çš„pageæ—¶ï¼Œå¦‚æœä½¿ç”¨LRUä¼šå°†å½“å‰ç¼“å­˜ä¸­çš„æ‰€æœ‰çš„pageå…¨éƒ¨æ·˜æ±°æ‰ï¼Œä»è€Œé€ æˆç¼“å­˜å¤±æ•ˆçš„é—®é¢˜ã€‚\nåœ¨LRU-Kä¸­ï¼Œä¸»è¦çš„æ·˜æ±°ä¾æ®ä¸ºbackword k-distanceâ€‹â€‹ï¼Œå³æ®Kæ¬¡è®¿é—®å‰çš„è·ç¦»ï¼Œ\nè€Œæ­¤å¤„çš„è·ç¦»ä½œä¸ºæ—¶é—´çš„æŠ½è±¡ï¼Œè®¿é—®æ—¶é—´è·ç¦»å½“å‰è¶Šä¹…åˆ™ä¸ºæ—¶é—´è¶Šé•¿ã€‚è€Œå‰Kæ¬¡è®¿é—®çš„è·ç¦»åˆ™æ˜¯å‰Kæ¬¡è®¿é—®çš„æ—¶é—´ï¼Œå¯ä»¥ç”¨æ—¶é—´æˆ³æ¥è¡¨ç¤º è€Œå¯¹äºè®¿é—®æ¬¡æ•°è¿˜æœªåˆ°Kæ¬¡çš„æƒ…å†µï¼Œåˆ™æ˜¯å°†å…¶è®°ä¸º+infï¼Œå³æ­£æ— ç©· å½“è¿›è¡Œæ·˜æ±°æ—¶ï¼Œé€‰æ‹©backword k-distanceâ€‹æœ€å¤§çš„frameè¿›è¡Œæ·˜æ±° å› æ­¤ï¼Œç”±äºè¿˜æœªè®¿é—®åˆ°Kæ¬¡çš„frameä¼šè¢«è®°ä¸ºæ­£æ— ç©·ï¼Œå› æ­¤æ·˜æ±°æ—¶ä¼šé€‰æ‹©è¿˜æœªè®¿é—®åˆ°kæ¬¡çš„è¿›è¡Œæ·˜æ±°ï¼Œè€Œå¦‚æœå­˜åœ¨å¤šä¸ªè®¿é—®è¿˜ä¸åˆ°Kæ¬¡çš„frameï¼Œåˆ™è¯¥å‡ ä¸ªframeä¹‹é—´ä½¿ç”¨æ™®é€šçš„LRUè¿›è¡Œæ·˜æ±°ï¼Œæ¯”è¾ƒä¸Šä¸€æ¬¡çš„è®¿é—®æ—¶é—´ï¼Œå…¶å®å³ä¸ºk = 1çš„æƒ…å†µã€‚\nè€Œå¦‚æœå…¨éƒ¨ä¸ºè®¿é—®äº†Kæ¬¡ä»¥åŠä»¥ä¸Šçš„frameï¼Œé‚£ä¹ˆåˆ™é€‰æ‹©distanceæœ€å¤§çš„è¿›è¡Œæ·˜æ±°ã€‚\nç›®å‰èƒ½å¤Ÿæƒ³åˆ°çš„æ–¹æ¡ˆå°±æ˜¯å¯¹äºframeä½¿ç”¨ä¸€ä¸ªmapæ¥ç®¡ç†ï¼Œè€Œå¯¹æ¯ä¸ªframeå°è£…ä¸€ä¸ªframeInfoï¼Œåœ¨å…¶ä¸­ç»´æŠ¤å¦‚æ˜¯å¦ä¸º+infï¼Œä¸€æ¬¡ä¸€ä¸ªé•¿åº¦ä¸ºKçš„é“¾è¡¨ï¼Œè®°å½•å‰Kæ¬¡çš„è®¿é—®æ—¶é—´ã€‚ä½†æ˜¯è¿™æ ·çš„é—®é¢˜å°±æ˜¯æ¯æ¬¡æ·˜æ±°frameæ—¶éœ€è¦éå†æ•´ä¸ªmapï¼Œç»Ÿè®¡å‡ºKæ¬¡è®¿é—®æœ€ä¹…è¿œçš„frameï¼Œæ— æ³•æƒ³LRUé‚£æ ·åœ¨O(1)çš„æ—¶é—´å¤æ‚åº¦å®Œæˆget/putã€‚\næ—¶é—´æˆ³å¯ä½¿ç”¨è‡ªå¢çš„idå³å¯ã€‚\næ­¤å¤–è¿˜æœ‰ä¸€ä¸ªæ¦‚å¿µï¼ŒBufferPoolå’ŒLRU-K Replacerå½“ä¸­å­˜å‚¨çš„ä¸ºframeâ€‹ï¼Œåœ¨BufferPoolå½“ä¸­ï¼Œåº”å½“é¢„å…ˆåˆå§‹åŒ–å¥½ä¸€å®šçš„frameï¼Œä¹‹åframeçš„æ•°é‡ä¸€ç›´ä¸å˜ï¼Œæ¯ä¸ªframeå¯¹åº”ä¸€ä¸ªframe_idï¼Œä»»ä½•å¤§äºæ€»å®¹é‡çš„frame_idå‡ä¸ºéæ³•çš„frame_idã€‚åœ¨replacerå½“ä¸­å®šä¹‰ä¸€ä¸ªreplacer_sizeï¼Œå…¶å¤§å°åº”å½“å’Œbuffer_poolçš„sizeå¤§å°ç›¸åŒï¼ŒåŒæ ·å¯¹è¿æ³•çš„frame_idè¿›è¡Œæ£€æµ‹\nå®ç° å•HashMapå†…åµŒList\nè¯´æ¸…æ¥šäº†ç›¸å…³æ¦‚å¿µï¼Œå°±å†è¯´ä¸€ä¸‹å¦‚ä½•å®ç°ï¼Œæˆ‘ä¸»è¦æƒ³åˆ°äº†ä¸¤ç§å®ç°æ–¹æ¡ˆï¼Œç¬¬ä¸€ç§æ˜¯ä¸Šè¿°çš„FrameInfoâ€‹ï¼Œç„¶ååœ¨ä¸€ä¸ªHashMapå½“ä¸­å»ç®¡ç†æ‰€æœ‰çš„FrameInfoï¼Œå®šä¹‰å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 struct FrameInfo{ bool isInf{true}; bool evictable{true}; std::deque\u0026lt;size_t\u0026gt; access_timestamp_; FrameInfo() = default; }; isInfâ€‹è¡¨ç¤ºå½“å‰æ˜¯å¦å·²ç»è¢«è®¿é—®äº†Kæ¬¡ï¼Œå¦‚æœè¿˜æœªï¼Œåˆ™è®¾ç½®ä¸ºtrueï¼Œä¹‹åè¿›è¡Œæ·˜æ±°æ—¶ä¼˜å…ˆæ·˜æ±°è¿˜æœªè®¿é—®Kæ¬¡çš„frameï¼Œå½“åˆ°è¾¾Kæ¬¡ä¹‹åå†è®¾ç½®ä¸ºfalseã€‚\nevictableâ€‹â€‹è¡¨ç¤ºå½“å‰çš„frameæ˜¯å¦èƒ½è¢«æ·˜æ±°ï¼Œç”¨äºåœ¨bufferpoolå½“ä¸­pinä½ä¸€äº›pageï¼ŒåŒæ—¶evictableâ€‹â€‹ä¹Ÿå†³å®šå½“å‰replacerçš„sizeã€‚\ndequeâ€‹è¡¨ç¤ºå½“å‰çš„è¯¥frameè¢«è®¿é—®çš„æ—¶é—´æˆ³ï¼Œå¤§å°ä¸Šé™ä¸ºKï¼Œåªä¿å­˜Kæ¬¡ä»¥å†…çš„æƒ…å†µï¼ˆä¸çŸ¥é“ä¸ºä»€ä¹ˆç”¨listå°±æ’å…¥ä¸è¿›å»ï¼Œæœ€åé€‰æ‹©äº†dequeï¼Œc++å­¦å¤ªçƒ‚äº†å…ˆä¸ç®¡äº†ï¼‰\nåœ¨è¿™ç§å®ç°æ–¹å¼ä¸‹å°±ä¸æ€ä¹ˆåˆ†å†å²é˜Ÿåˆ—å’Œç¼“å†²é˜Ÿåˆ—äº†ï¼Œåæ­£å†å²é˜Ÿåˆ—å’Œç¼“å†²é˜Ÿåˆ—æœ¬èº«éƒ½è¦è¦å­˜å…¥bufferPoolå½“ä¸­çš„ï¼Œä¸å¦‚ç›´æ¥ç»Ÿä¸€ç®¡ç†\nRecord_accessï¼šæ·»åŠ ä¸€æ¬¡è®¿é—®è®°å½•æ—¶é¦–å…ˆåˆ¤æ–­ä¹‹å‰æ˜¯å¦è®¿é—®è¿‡ï¼Œå¦‚æœè®¿é—®è¿‡åˆ™æ‰¾åˆ°ä¹‹å‰çš„è®¿é—®è®°å½•ï¼Œåˆ™åœ¨å°¾éƒ¨æ·»åŠ ä¸€æ¡æ–°çš„ï¼Œæ³¨æ„æ˜¯å¦è¶…è¿‡Kæ¬¡å–æ¶ˆæ‰+infå’Œè¶…è¿‡Kæ¬¡ä¹‹åæŠŠæœ€æ—©çš„åˆ é™¤æ‰å³å¯ï¼Œå¦‚æœä¹‹å‰æ²¡æœ‰ç›¸å…³è®°å½•åˆ™ç›´æ¥æ–°å»ºä¸€æ¡å³å¯\nRemoveã€Sizeã€SetEvictableçš„å®ç°è¾ƒä¸ºç®€å•ï¼ŒæŒ‰ç…§æ³¨é‡Šå®Œæˆå³å¯\nEvictï¼šæŒ‰ç…§LRU-KåŸæœ¬çš„å®šä¹‰ï¼Œåº”å½“å…ˆéå†å†å²é˜Ÿåˆ—ï¼Œå¦‚æœå½“ä¸­æœ‰frameçš„è®¿é—®å†å²è®°å½•ï¼Œåˆ™ä»å†å²é˜Ÿåˆ—ä¸­åˆ é™¤ï¼Œå†å²é˜Ÿåˆ—å½“ä¸­å¦‚æœæ²¡æœ‰èƒ½å¤Ÿå¯ä»¥æ·˜æ±°çš„å†é€‰æ‹©ä»ç¼“å­˜é˜Ÿåˆ—ä¸­è¿›è¡Œæ·˜æ±°ã€‚å› æ­¤å¯¹æ•´ä¸ªFrameInfo Mapè¿›è¡Œéå†ï¼Œ\næ ‡è®°æ‰€æœ‰çš„infï¼Œè®°å½•æœ€å°çš„æ—¶é—´æˆ³ï¼ŒåŒæ—¶ä¹Ÿè®°å½•è®¿é—®äº†Kæ¬¡çš„ï¼Œè®°å½•æœ€å°çš„æ—¶é—´æˆ³ï¼Œæœ€ç»ˆå¦‚æœæ‰¾åˆ°è¿‡infçš„ï¼Œåˆ™é€‰æ‹©infçš„è¿›è¡Œæ·˜æ±°ï¼Œå¦åˆ™æ·˜æ±°è®¿é—®äº†Kæ¬¡çš„ï¼Œæ³¨æ„è·³è¿‡non-evictableâ€‹å³å¯ï¼Œå¼„æ¸…æ¥šäº†LRU-Kçš„æ¦‚å¿µä¹‹åå®ç°èµ·æ¥å°±æ²¡æœ‰ä»€ä¹ˆéš¾åº¦äº†ã€‚\nåŒList+å•HashMapâ€‹\nè¿™ç§æ–¹å¼åˆ™ä½¿ç”¨å°†å†å²è®°å½•å’Œç¼“å­˜åˆ†åˆ«ä½¿ç”¨ä¸¤ä¸ªListç®¡ç†ï¼Œä¹‹ååˆ é™¤æ˜¯å…ˆéå†å†å²è®°å½•çš„Listï¼Œå¦‚æœæ‰¾ä¸åˆ°å¯ä»¥åˆ é™¤çš„ï¼Œåˆ™å†éå†ç¼“å­˜çš„Listï¼Œ\nåœ¨æ·»åŠ ä¸€æ¬¡æ–°çš„è®¿é—®æ—¶ï¼Œå¦‚æœä¹‹å‰æ¯«æ— è®°å½•ï¼Œåˆ™å°†å…¶æ·»åŠ åˆ°å†å²è®°å½•å½“ä¸­ï¼Œå¹¶ä½¿ç”¨HashMapå­˜å‚¨è®°å½•å½“å‰çš„è¿­ä»£å™¨ä½ç½®å’Œæ‰€å±çš„é˜Ÿåˆ—ï¼Œ å¦‚æœè®¿é—®æ¬¡æ•°i 1\u0026lt; i \u0026lt; kâ€‹,ç”±äºæ¯”è¾ƒçš„æ˜¯æœ€æ—©çš„è®¿é—®æ—¶é—´ï¼Œå› æ­¤ä»€ä¹ˆéƒ½ä¸ç”¨åš å¦‚æœè®¿é—®æ¬¡æ•°åˆ°è¾¾Kæ¬¡ï¼Œåˆ™å°†å…¶ç§»å…¥åˆ°ç¼“å†²é˜Ÿåˆ—å½“ä¸­ï¼Œæ›´æ–°Mapå½“ä¸­ç›¸å…³çš„è¿­ä»£å™¨å’Œæ‰€å±é˜Ÿåˆ— å¦‚æœè¶…è¿‡Kæ¬¡ï¼Œåˆ™å°†å…¶ç§»å…¥åˆ°ç¼“å†²é˜Ÿåˆ—çš„å°¾éƒ¨ï¼Œæ·˜æ±°æ—¶ä»å¤´éƒ¨å¼€å§‹è¿›è¡Œæ·˜æ±°ï¼Œæ›´æ–°è¿­ä»£å™¨ å½“æ·˜æ±°æ—¶åˆ™å…ˆéå†å†å²é˜Ÿåˆ—ï¼Œå¯»æ‰¾ç¬¬ä¸€ä¸ªevictableâ€‹çš„frameè¿›è¡Œæ·˜æ±°ï¼Œå¦‚æœæ‰¾ä¸åˆ°ï¼Œå†å»ç¼“å†²é˜Ÿåˆ—å½“ä¸­å»å¯»æ‰¾ã€‚\nä¸¥æ ¼æ¥è¯´è¿™ç§å®ç°æ–¹æ³•æ›´ç¬¦åˆLRU-KåŸæœ¬çš„å®šä¹‰ï¼Œè¿™æ ·å¦‚æœä¸è€ƒè™‘ evictableâ€‹æ‰€å¸¦æ¥çš„é¢å¤–æ¯”è¾ƒï¼Œåœ¨evict removeæ—¶çš„æ—¶é—´å¤æ‚åº¦ä¸ºO(1)ï¼Œè€Œä¹‹å‰é‚£ç§å®ç°æ–¹å¼éœ€è¦éå†æ•´ä¸ªMapå› æ­¤ä¸ºå¸¸æ•°å¤æ‚åº¦ï¼Œç­‰æœ‰ç©ºè€ƒè™‘é‡æ„ä¼˜åŒ–ä¸€ä¸‹ã€‚\næœ¬èº«ä¹Ÿæ²¡æœ‰ä»€ä¹ˆçº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œå„ä¸ªå‡½æ•°ç›´æ¥ä¸€ä¸ªåŒºåŸŸé”åˆ©ç”¨ RAIIä¿å¹³å®‰ã€‚\nTask3 Buffer Pool Manager Instance ä»ç£ç›˜å½“ä¸­å»è¯»å–pageå­˜å‚¨åˆ°å†…å­˜å½“ä¸­ï¼Œå½“Buffer Poolæ»¡äº†ä¹‹åï¼Œå†ä½¿ç”¨LRU-Kå°†pageä»å†…å­˜ä¸­æ·˜æ±°ï¼Œå†™å›åˆ°ç¡¬ç›˜ä¸Šã€‚\nå†…å­˜ä¸­çš„Pageä½¿ç”¨Pageâ€‹å¯¹è±¡è¿›è¡ŒæŠ½è±¡ï¼Œbuffer poolæ— éœ€å…³å¿ƒpageå½“ä¸­çš„å†…å®¹ï¼Œpageå½“ä¸­åŒ…å«ä¸€å—å†…å­˜ï¼Œå¯¹åº”ä¸€ä¸ªç‰©ç†é¡µï¼Œä¹‹åå°†å¯¹åº”çš„å†…å­˜ä¸Šçš„å†…å®¹å†™å…¥åˆ°ç¡¬ç›˜ä¸Šï¼Œä¸€ä¸ªPageâ€‹å¯¹åº”ä¸€ä¸ªç‰©ç†é¡µï¼Œé€šè¿‡page_idâ€‹è¿›è¡Œè¡¨è¿°ï¼Œå¦‚æœè¯¥pageæ²¡æœ‰å¯¹åº”çš„ç‰©ç†é¡µï¼Œåˆ™page_idä¸ºINVALID_PAGE_IDâ€‹\nPageå½“ä¸­éœ€è¦æœ‰ä¸€ä¸ªè®¡æ•°å™¨è®°å½•æœ‰å¤šå°‘ä¸ªçº¿ç¨‹pinnedâ€‹äº†è¯¥pageï¼Œå¯¹äºè¢«pinnedâ€‹çš„pageï¼Œä¸å…è®¸å°†å…¶é‡Šæ”¾ï¼Œpageéœ€è¦è®°å½•æ˜¯å¦ä¸ºdirtyâ€‹ï¼Œå¦‚æœédirtyâ€‹åˆ™æ·˜æ±°æ—¶ä¸éœ€è¦å›å†™ç¡¬ç›˜ï¼Œè€Œdirtyâ€‹çš„pageéœ€è¦å…ˆå›å†™å†é‡æ–°ä½¿ç”¨\nä½¿ç”¨ä¹‹å‰çš„ExtendiableHashTableâ€‹è¿›è¡Œpage_idåˆ°frame_idçš„æ˜ å°„ï¼Œä½¿ç”¨LRUKReplacerâ€‹æ¥è®°å½•å„ä¸ªpageçš„ä½¿ç”¨æƒ…å†µ\nFetchPgImp(page_id)â€‹ï¼šå¦‚æœæ²¡æœ‰å¯ç”¨çš„pageå¹¶ä¸”å…¶ä»–çš„pageå…¨éƒ¨è¢«pinnedâ€‹äº†,è¿”å›nullptr UnpinPgImp(page_id, is_dirty)â€‹ FlushPgImp(page_id)â€‹ï¼šä¸ç®¡æ˜¯å¦è¢«pinï¼Œéƒ½å°†pageç»™åˆ·ç›˜ NewPgImp(page_id)â€‹ï¼šAllocatePageâ€‹ç”¨äºç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„PageIdï¼ŒDeallocatePageâ€‹ æ¨¡æ‹Ÿå°†pageåˆ·ç›˜åˆ°ç¡¬ç›˜ä¸Šï¼Œåœ¨DeletePgImpå½“ä¸­è°ƒç”¨ DeletePgImp(page_id)â€‹ FlushAllPagesImpl()â€‹â€‹ å®ç° Buffer Poolçš„æ•´ä½“å®ç°å¹¶ä¸éš¾ï¼Œé¦–å…ˆæè¿°ä¸€ä¸‹æ•´ä¸ªBuffer Poolçš„ç‰©ç†ç»“æ„ï¼ŒBuffer Poolå½“ä¸­çš„å®¹å™¨æˆ–è€…è¯´pageçš„è½½ä½“ä¸ºframeï¼Œæ‰€æœ‰çš„frameæœ¬èº«æ˜¯ä¸å˜çš„ï¼Œå³frameçš„æ•°é‡å³ä¸ºBuffer Poolçš„å¤§å°ï¼Œåœ¨Buffer Poolè¿›è¡Œåˆå§‹åŒ–æ—¶ï¼Œåˆå§‹åŒ–ä¸€ä¸ªFrameæ•°ç»„ï¼Œå…¶ä¸­æ¯ä¸€ä¸ªå…ƒç´ åŠå¯¹åº”ç€ä¸€ä¸ªFrameï¼Œæ•°ç»„çš„ä¸‹è¡¨å³ä¸ºFrame_idï¼Œå¦‚æœpageä¸ºå°šæœªåˆå§‹åŒ–çš„çŠ¶æ€ï¼Œåˆ™ä»£è¡¨è¯¥frameå½“ä¸­è¿˜æœªå­˜æ”¾å…ƒç´ ï¼Œå½“æœ‰ä¸€ä¸ªPageè¦å—åˆ°Buffer Poolç®¡ç†æ—¶ï¼Œåˆ™å¯¹è¯¥Pageè¿›è¡Œåˆå§‹åŒ–ï¼Œè®¾ç½®å¯¹åº”çš„PageIdå’Œå…ƒæ•°æ® ä»¥åŠPageå½“ä¸­å­˜å‚¨çš„æ•°æ®è®¾ç½®åˆ°è¯¥Pageå½“ä¸­ã€‚\né™¤æ­¤ä¹‹å¤–è¿˜æœ‰Buffer Poolçš„ç®¡ç†æ•°æ®ç»“æ„ï¼Œå³å‰ä¸¤ä¸ªtaskæ‰€å®ç°çš„å¯æ‰©å±•å“ˆå¸Œè¡¨å’ŒLRU-K Replacerï¼Œä»¥åŠä¸€ä¸ªç”¨äºè®°å½•ç©ºframeçš„é“¾è¡¨\nå½“ä¸€ä¸ªPageè¦åŠ å…¥åˆ°Buffer Poolå½“ä¸­ï¼Œæ— è®ºæ˜¯æ–°å»ºä¸€ä¸ªPageè¿˜æ˜¯ä»ç¡¬ç›˜å½“ä¸­è¯»å–ä¸€ä¸ªPageï¼Œé¦–å…ˆå…ˆå°è¯•ä»ç©ºframeé“¾è¡¨å½“ä¸­è·å–ä¸€ä¸ªframe_idï¼Œä¹‹ååœ¨Pageæ•°ç»„å½“ä¸­å¯¹å…¶è¿›è¡Œåˆå§‹åŒ–ï¼Œè€Œå¦‚æœç©ºé—²é“¾è¡¨å½“ä¸­æ²¡æœ‰é¢å¤–çš„frame_idå»åˆ†é…ï¼Œåˆ™è¯æ˜å½“å‰çš„Buffer Poolå·²æ»¡ï¼Œå› æ­¤éœ€è¦å°è¯•é€šè¿‡LRU-Kå»æ·˜æ±°ä¸€ä¸ªå½“å‰Pageçš„ï¼Œè·å–ä¸€ä¸ªæ–°çš„Pageï¼Œä¸ºäº†æµç¨‹çš„ç»Ÿä¸€ï¼Œå°±æ·˜æ±°ä¹‹åå†å°†frameåŠ å…¥åˆ°ç©ºé—²é“¾è¡¨å½“ä¸­ï¼Œä¹‹åå†ä»ç©ºé—²é“¾è¡¨å½“ä¸­å°è¯•å»è·å–ä¸€ä¸ªPageã€‚å°†æ–°çš„Pageé‡æ–°è®©Replacerå’Œpage_tableå»ç®¡ç†ã€‚\nä»¥NewPageä¸ºä¾‹ï¼Œå¤§è‡´æ¶æ„å¦‚ä¸‹ï¼š\nææ¸…æ¥šäº†æ•´ä½“æ¶æ„å†å®ç°èµ·æ¥å°±æ¯”è¾ƒæ–¹ä¾¿äº†ï¼Œè¿™é‡Œå°±ç®€å•è§£é‡Šä¸€ä¸‹å‡ ä¸ªå‡½æ•°çš„ç›¸å…³ä½œç”¨,\nNewPageï¼šå³ä¸ºä¸Šå±‚éœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„Pageç”¨äºå­˜å‚¨æ–°çš„æ•°æ®ï¼Œå¦‚åœ¨Insertæ—¶è¿›è¡Œè°ƒç”¨ï¼Œå³æŒ‰ç…§ä¸Šå›¾çš„æ­¥éª¤å®Œæˆå³å¯ï¼Œå…ˆåå°è¯•ä»free_list_â€‹,è‹¥ä¸èƒ½åˆ™å‘ŠçŸ¥replacerâ€‹è¿›è¡Œæ·˜æ±°ï¼Œå†ä»free_list_â€‹å½“ä¸­è¿›è¡Œè·å–ï¼Œæœ€ååˆ›å»ºPageï¼Œå¹¶Pageäº¤ç»™BufferPoolç®¡ç†ã€‚\næ­¤å¤–ï¼Œåˆ›å»ºPageå³ä»£è¡¨ä¸Šå±‚éœ€è¦ä¸€ä¸ªPageæ¥æ‰¿è½½æ•°æ®ï¼Œå³å½“å‰éœ€è¦ä½¿ç”¨è¯¥Pageï¼Œå› æ­¤éœ€è¦è¯¥Pageé©»ç•™åœ¨Buffer Poolå½“ä¸­ï¼Œå› æ­¤åˆ›å»ºä¹‹ååº”å½“pinâ€‹ä½å®ƒï¼Œå³ä¿®æ”¹pin_count_â€‹å’Œevictableâ€‹ã€‚\nç”±äºæ¶‰åŠä¿®æ”¹å¥½å‡ ä¸ªæ•°æ®ç»“æ„ï¼Œå› æ­¤åšäº†ä¸€ä¸ªå°è£…ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 auto BufferPoolManagerInstance::CreateNewPage(frame_id_t empty_frame_id) -\u0026gt; Page * { auto new_page_id = AllocatePage(); Page *new_page = \u0026amp;pages_[empty_frame_id]; ResetPage(new_page, new_page_id); // pin a new page new_page-\u0026gt;pin_count_++; AddNewPageToBufferPool(empty_frame_id, new_page_id); return new_page; } auto BufferPoolManagerInstance::AddNewPageToBufferPool(frame_id_t frame_id, page_id_t page_id) -\u0026gt; void { replacer_-\u0026gt;RecordAccess(frame_id); replacer_-\u0026gt;SetEvictable(frame_id, false); page_table_-\u0026gt;Insert(page_id, frame_id); } é€šè¿‡replacer_â€‹æ·˜æ±°ä¸€ä¸ªpageå°è£…æˆä¸€ä¸ªå‡½æ•°ï¼Œæ·˜æ±°ä¹‹åå¦‚æœä¸ºè„é¡µåˆ™éœ€è¦è¿›è¡ŒFlushåˆ·ç›˜ï¼Œå› ä¸ºEvictPageâ€‹ä¼šè¢«åŠ é”çš„NewPageè°ƒç”¨ï¼Œå› æ­¤è‡ªèº«å¹¶ä¸åŠ é”ï¼Œè€Œä¸”è°ƒç”¨æ— é”çš„FlushPageâ€‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 auto BufferPoolManagerInstance::EvictPage() -\u0026gt; bool { frame_id_t frame_id; bool result = replacer_-\u0026gt;Evict(\u0026amp;frame_id); if (!result) { return false; } // if frame can be evicted,it means page is not pinned; Page *page_to_evict = \u0026amp;pages_[frame_id]; if (page_to_evict-\u0026gt;IsDirty()) { FlushWithoutLock(page_to_evict-\u0026gt;GetPageId()); } free_list_.push_back(frame_id); page_table_-\u0026gt;Remove(page_to_evict-\u0026gt;page_id_); replacer_-\u0026gt;Remove(frame_id); return true; } FetchPageâ€‹ï¼šåœ¨æµç¨‹ä¸Šå’ŒNewPageâ€‹å·®ä¸å¤šï¼Œå°è¯•ä»Buffer Poolå½“ä¸­è·å–ä¸€ä¸ªPageï¼Œå¦‚æœpage_table_â€‹å½“ä¸­æœ‰åˆ™è¯æ˜å­˜åœ¨äºBuffer Poolå½“ä¸­ ï¼Œç›´æ¥è¯»å–è¿”å›ã€‚è€Œå¦‚æœæ²¡æœ‰åˆ™åˆ†åˆ«ä»free_list_â€‹å’Œreplacerâ€‹å½“ä¸­å°è¯•æ‰¾åˆ°ä¸€ä¸ªframeâ€‹æ¥æ‰¿è½½Pageï¼Œä½¿ç”¨disk_manager_â€‹è¿›è¡Œè¯»å–ï¼Œç„¶åäº¤ç»™Buffer Poolâ€‹ç®¡ç†ã€‚\nç”±äºFetchPageâ€‹çš„ç›®çš„ä¹Ÿæ˜¯å»è¯»å–ä¸€ä¸ªPageä¸ºä¸Šå±‚æ‰€ç”¨ï¼Œå› æ­¤åŒæ ·éœ€è¦å°†å…¶pinä½ï¼Œç›´è‡³ä½¿ç”¨å®Œã€‚\næ­¤å¤–å¦‚æœæ˜¯é€šè¿‡free_list_â€‹å’Œreplacer_â€‹æ‰€è·å–çš„Frameéœ€è¦å…ˆæ¸…é™¤ä¸Šä¸€ä¸ªPageåœ¨å…¶ä¸­æ®‹ç•™çš„æ•°æ®ï¼Œä¹‹ååŠ è½½æ–°æ•°æ®ï¼Œç”±äºgrade_scopeä¸Šä¼ æ—¶ä¸ä¼šå»æ‰“åŒ…Page.hâ€‹ï¼Œå› æ­¤ä¸åº”å½“å¯¹Page.hâ€‹è¿›è¡Œä¿®æ”¹ï¼Œå› æ­¤å°†è¯¥å‡½æ•°å°è£…åˆ°Buffer Poolå½“ä¸­\n1 2 3 4 5 6 auto BufferPoolManagerInstance::ResetPage(Page *page, page_id_t page_id) -\u0026gt; void { page-\u0026gt;ResetMemory(); page-\u0026gt;page_id_ = page_id; page-\u0026gt;pin_count_ = 0; page-\u0026gt;is_dirty_ = false; } UnpinPageâ€‹ï¼šNewPageâ€‹å’ŒFetchPageâ€‹å‡ä¸ºè·å–ä¸€ä¸ªPageï¼Œä¹‹åä¸ºä¸Šå±‚æ‰€ç”¨ï¼Œå› æ­¤è·å–çš„åŒæ—¶ä¼šPinä½è¯¥Pageï¼Œè€ŒUnpinPageâ€‹å³ä¸ºç”¨äºåœ¨ä½¿ç”¨å®Œpageä¹‹åå–æ¶ˆå¯¹è¯¥pageçš„å ç”¨ï¼Œè®©å…¶å¯ä»¥è¢«æ·˜æ±°ã€‚\nUnpinâ€‹ä¸€æ¬¡åˆ™å¯¹pin_count_â€‹é€’å‡ä¸€æ¬¡ï¼Œå½“ä¸º0æ—¶è¯æ˜æ²¡æœ‰ä»»ä½•ä¸Šå±‚å‡½æ•°åœ¨å ç”¨è¯¥Pageï¼Œåˆ™å¯ä»¥set evictableâ€‹ï¼Œä¹‹åreplacerâ€‹å³å¯å¯¹å…¶è¿›è¡Œæ·˜æ±°\nåŒæ—¶UnpinPageâ€‹ä¼šä¼ å…¥ä¸€ä¸ªis_dirtyâ€‹ï¼Œæ¥ä»£è¡¨ä¹‹å‰å æœ‰Pageæ—¶è¿›è¡Œçš„æ“ä½œæ˜¯è¯»æ“ä½œè¿˜æ˜¯å†™æ“ä½œã€‚æ­¤å¤–Pageä¸Šis_diryâ€‹çš„ä¿®æ”¹ä¼šæœ‰ä¸€å®šçš„é™åˆ¶ï¼Œå³å¦‚æœåŸæœ¬ä¸ºè„é¡µï¼Œé‚£ä¹ˆæ­¤æ¬¡è¿›è¡Œçš„æ˜¯è¯»æ“ä½œï¼Œé‚£ä¹ˆä¸èƒ½è¿›è¡Œä¿®æ”¹ï¼Œéœ€è¦ä¿æŒè„é¡µçŠ¶æ€ã€‚è€Œå¦‚æœåŸæœ¬éè„é¡µï¼Œé‚£ä¹ˆå³å¯éšæ„ä¿®æ”¹ã€‚\nFlushPageâ€‹ DeletePageâ€‹ FlushAllPageâ€‹ç­‰é€»è¾‘æ¯”è¾ƒç®€å•ï¼ŒæŒ‰ç…§æ³¨é‡Šå†™åŸºæœ¬å°±æ²¡ä»€ä¹ˆé—®é¢˜ã€‚\ndebug å…³äºçº¿ç¨‹å®‰å…¨ï¼Œä¿é™©çš„æ–¹æ¡ˆå°±æ˜¯ä½¿ç”¨ä¸€ä¸ªåŒºåŸŸé”é”ä½æ•´ä¸ªå‡½æ•°ï¼Œä¸€æŠŠå¤§é”ä¿å¹³å®‰ï¼Œä½†æ˜¯ä¹‹å‰å†™çš„æ—¶å€™åœ¨EvictPageâ€‹å½“ä¸­å·æ‡’å¤ç”¨äº†ä¸€ä¸‹FlushPageâ€‹ï¼Œå› æ­¤è°ƒç”¨å‰è§£é”ï¼Œè°ƒç”¨å®Œå†åŠ é”ï¼Œå¯¼è‡´äº†ä¸€ä¸ªä¸­é—´çŠ¶æ€ï¼Œå†è§£é”çš„é—´éš™æ‰€å°±è¢«åœ¨å¹¶å‘çš„å…¶ä»–å‡½æ•°ï¼ˆUnpinPageâ€‹ï¼‰æŠ¢èµ°äº†ï¼Œå¦‚æœæŒ‰ç…§äº‹åŠ¡çš„è¯´æ³•å°±æ˜¯è¿åäº†åŸå­æ€§ï¼Œå¯¼è‡´å·²ç»pin_count_ = 0â€‹çš„Pageåˆè¢«å…¶ä»–çš„çº¿ç¨‹æŠ¢èµ°äº†é‡æ–°Unpinâ€‹ä¸€æ¬¡\nå› æ­¤æœ€ç»ˆé€‰æ‹©å•ç‹¬å°è£…äº†ä¸€ä¸ªæ— é”ç‰ˆæœ¬çš„FlushWithoutLockâ€‹ï¼Œä¹‹åEvictPageâ€‹ FlushPageâ€‹ FlushAllPageâ€‹å…¨éƒ¨è°ƒç”¨è¯¥å‡½æ•°ã€‚å³å¯ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œä¸ä¼šå‡ºç°ä¸­é—´æ€ã€‚\nSummary æ•´ä¸ªBuffer Poolçš„éš¾åº¦å¹¶ä¸ç®—å¤§ï¼Œå†™å®Œä¹‹åä¹Ÿå¤§è‡´æ„Ÿå—åˆ°äº†BusTubå’Œ6.830çš„ä¾§é‡ç‚¹ ç›¸æ¯”äº6.830 BusTubå°‘äº†å¾ˆå¤šdirty workï¼Œæ›´æ³¨é‡äºæ ¸å¿ƒéƒ¨åˆ†çš„å®ç°ï¼Œåƒè¡¨ç»“æ„ï¼ŒCatalogï¼Œå’ŒHeapFileç»Ÿç»Ÿæ²¡æœ‰è®©æˆ‘å»å†™ï¼Œè€Œæ˜¯ä¸“æ³¨äºæ•´ä¸ªBuffer Poolã€‚\nBuffer Pool ä»0å¼€å§‹ å¯æ‰©å±•å“ˆå¸Œè¡¨+LRU-Kçš„å®ç°ä¹Ÿæœ‰æ„æ€å¾ˆå¤šï¼Œç›¸æ¯”äº6.830çš„ç›´æ¥æ— è„‘ä¸€ä¸ªConcurrentHashMapï¼Œæ·˜æ±°ç­–ç•¥ä¹Ÿæ²¡æœ‰åšä»»ä½•è¦æ±‚ï¼ŒFIFOä¹Ÿèƒ½é€šè¿‡æµ‹è¯•ã€‚\nä¸è¿‡ä¸ªäººæ„Ÿè§‰åˆšæ¥è§¦æ•°æ®åº“çš„è¯6.830å¯èƒ½æ¯”è¾ƒå‹å¥½ä¸€ç‚¹ï¼Œèƒ½å¯¹æ•°æ®åº“çš„å„æ–¹é¢éƒ½æœ‰ä¸€å®šçš„äº†è§£ï¼Œæœ‰äº›dirty worké¦–å…ˆä¸€è¾¹ä½“ä¼šæ‰æ›´æ·±ï¼Œä¾‹å¦‚HeapPage HeapFileé‡Œé¢çš„ä¸€ä¸ªæ¯”è¾ƒTrickyçš„ä½äºç®—å’ŒBit mapï¼Œ445çš„è¯å°±ä¸èƒ½å…‰å»å®ç°projectäº†ï¼Œå…¶ä»–åœ°æ–¹çš„æºç æœ€å¥½ä¹Ÿè¯»ä¸€è¯»ã€‚\nâ€\n","permalink":"https://fischer0522.github.io/en/posts/tech/bustub/bustub-lab1/","summary":"BusTub Lab1 Buffer Pool Manager Task1 å¯æ‰©å±•å“ˆå¸Œè¡¨ ç›¸å…³å‡½æ•° Find(K,V)â€‹ï¼šæŸ¥è¯¢ä¸€ä¸ªKeyæ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨åˆ™å°†å…¶VæŒ‡é’ˆæŒ‡å‘ç›¸å…³çš„å€¼ï¼Œè¿”å›trueï¼Œå¦åˆ™è¿”å›fal","title":"BusTub Lab1 Buffer Pool Manager"},{"content":"BusTub Lab0 cpp primer å®ç°ä¸€ä¸ªå­—å…¸æ ‘ï¼Œä¸»è¦å®šä¹‰äº†ä¸‰ä¸ªç±»ï¼š\nTrieNode TrieNodeWithValue Trie Task1 å®ç°ä¸€ä¸ªä¸æ”¯æŒå¹¶å‘çš„å­—å…¸æ ‘\nTrieNode å†…éƒ¨å­˜å‚¨çš„æ•°æ®ä¸ºä¸€ä¸ªcharå­—ç¬¦ï¼Œ å¹¶ä¸”æœ‰ä¸€ä¸ªæ ‡è¯†ä½ç½®æ¥è¡¨ç¤ºæ˜¯å¦åˆ°è¾¾äº†ç»“æŸä½ç½® å¯¹äºå­—èŠ‚ç‚¹é€šè¿‡ä¸€ä¸ªchar-\u0026gt; unique_ptrçš„Mapæ¥è¿›è¡Œå­˜å‚¨ ä½¿ç”¨unique_ptråˆ™æ„å‘³ç€å½“å°†å…¶åˆ†é…ç»™å…¶ä»–çš„å˜é‡æ—¶éœ€è¦å°å¿ƒï¼ŒInsertChildNodeâ€‹ GetChildNodeâ€‹çš„è¿”å›æ ¼å¼å‡ä¸ºunique_ptrâ€‹ï¼Œå› æ­¤å¯ä»¥ä¸è¿›è¡Œcopyçš„ç›´æ¥è®¿é—®å½“ä¸­çš„æ•°æ®\né€šè¿‡ç§»åŠ¨æ„é€ å‡½æ•°æ¥è¿›è¡Œèµ‹å€¼ï¼Œä¼ è¾“æ•°æ®è‡³ä¸€ä¸ªæ–°çš„èŠ‚ç‚¹ä¸Šï¼Œç¡®ä¿æ²¡æœ‰å¯¹unique_ptrè¿›è¡Œæ‹·è´ã€‚\nTrieNodeWithValue ç»§æ‰¿è‡ªTrieNodeï¼Œä»£è¡¨æœ€ç»ˆèŠ‚ç‚¹ï¼Œkeyä¸ºå­—ç¬¦ä¸²çš„æœ€åä¸€ä¸ªå­—ç¬¦ï¼Œis_endæ°¸è¿œä¸ºtrue\næ ¹æ®æƒ…å†µä¸åŒè°ƒç”¨ä¸åŒçš„æ„é€ å‡½æ•°ï¼š\n(char key_char,T value)ç”¨äºæ ¹æ®ç»™å®šçš„kvåˆ›å»ºä¸€ä¸ªèŠ‚ç‚¹ (TrieNode \u0026amp;\u0026amp;trieNode,T value)è·å–ä¼ å…¥èŠ‚ç‚¹çš„ç‹¬å æŒ‡é’ˆï¼Œå¹¶ä¸”å°†ç»™å®šå€¼è®¾ç½®åˆ°è‡ªèº« Trie å®šä¹‰äº†æ•´ä¸ªå­—å…¸æ ‘ï¼Œå…¶ä¸­å®šä¹‰ä¸€ä¸ªroot nodeä½œä¸ºæ‰€æœ‰èŠ‚ç‚¹çš„æ ¹èŠ‚ç‚¹\nInsertâ€‹\næ’å…¥ä¸€ä¸ªkeyæ—¶éœ€è¦é¦–å…ˆéå†æ•´ä¸ªæ ‘ï¼Œå¦‚æœä¸å­˜åœ¨å†æ’å…¥èŠ‚ç‚¹ï¼Œä¸å…è®¸æ’å…¥é‡å¤çš„èŠ‚ç‚¹ï¼Œé‡å¤åˆ™è¿”å›false\néå†å®Œä¹‹åæœ‰ä¸‰ç§å¯èƒ½ï¼š\nèŠ‚ç‚¹ä¸å­˜åœ¨ï¼Œè°ƒç”¨TrieNodeWithValue(char key_char, T value)æ„é€ å‡½æ•°å»æ’å…¥ä¸€ä¸ªæ–°çš„èŠ‚ç‚¹ï¼Œå¹¶ä¸”å¯¹TrieNodeä½¿ç”¨ç‹¬å æŒ‡é’ˆä¹Ÿå¯ä»¥å¯¹å­˜å‚¨ä¸€ä¸ªæŒ‡å‘TrieNodeWithValueçš„ç‹¬å æŒ‡é’ˆï¼Ÿï¼Ÿ èŠ‚ç‚¹å­˜åœ¨ï¼Œä½†æ˜¯ä¸æ˜¯æœ€ç»ˆèŠ‚ç‚¹ï¼Œéœ€è¦è°ƒç”¨TrieNodeWithValue(TrieNode \u0026amp;\u0026amp;trieNode, T value)â€‹æ„é€ å‡½æ•°å»å°†æ—§çš„TrieNodeâ€‹è½¬æ¢ä¸ºæ–°çš„TrieNodeWithValueâ€‹ èŠ‚ç‚¹å­˜åœ¨ä½†æ˜¯å·²ç»æ˜¯æœ€ç»ˆèŠ‚ç‚¹ï¼Œreturn falseå³å¯ Removeâ€‹\néå†å¯»æ‰¾ç»™å®šçš„keyï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ç«‹å³è¿”å› å¦‚æœæ‰¾åˆ°äº†åˆ™å°†is_end_è®¾ç½®ä¸ºfalse å¦‚æœè¯¥èŠ‚ç‚¹æ²¡æœ‰ä»»ä½•çš„å­èŠ‚ç‚¹ï¼Œç›´æ¥å°†å…¶ä»çˆ¶èŠ‚ç‚¹çš„mapå½“ä¸­ç§»é™¤ éå†å°è¯•å¹¶é€’å½’åœ°åˆ é™¤æ²¡æœ‰å­èŠ‚ç‚¹çš„èŠ‚ç‚¹ã€‚é‡åˆ°æœ‰å­èŠ‚ç‚¹æ—¶åœæ­¢ GetValueâ€‹\nå¦‚æœç±»å‹ä¸åŒ¹é…æˆ–è€…æ²¡æ‰¾åˆ°keyï¼Œåˆ™å°†successè®¾ç½®ä¸ºfalseï¼Œ\nâ€\n","permalink":"https://fischer0522.github.io/en/posts/tech/bustub/bustub-lab0/","summary":"BusTub Lab0 cpp primer å®ç°ä¸€ä¸ªå­—å…¸æ ‘ï¼Œä¸»è¦å®šä¹‰äº†ä¸‰ä¸ªç±»ï¼š TrieNode TrieNodeWithValue Trie Task1 å®ç°ä¸€ä¸ªä¸æ”¯æŒå¹¶å‘çš„å­—å…¸æ ‘ TrieNode å†…éƒ¨å­˜å‚¨çš„æ•°æ®ä¸ºä¸€ä¸ªcharå­—ç¬¦ï¼Œ å¹¶ä¸”æœ‰ä¸€ä¸ªæ ‡è¯†ä½ç½®æ¥è¡¨ç¤ºæ˜¯å¦","title":"BusTub Lab0 cpp primer"},{"content":" Name: Fischer Yu Locationï¼š Xiamen Hobbies: Bass,Tennis,Running Focusing On: Storage,Distrubuted System,Database, and something intresting ","permalink":"https://fischer0522.github.io/en/about/","summary":"Name: Fischer Yu Locationï¼š Xiamen Hobbies: Bass,Tennis,Running Focusing On: Storage,Distrubuted System,Database, and something intresting","title":"About"},{"content":"ç›¸æ¯”äºä¼ ç»Ÿc++å½“ä¸­çš„æ‰‹åŠ¨ç®¡ç†å†…å­˜ï¼Œrusté‡‡ç”¨äº†æ‰€æœ‰æƒ + RAIIçš„æœºåˆ¶ï¼Œå¯¹äºä¸€äº›å¤æ‚çš„æƒ…å†µï¼Œrustè¿˜æœ‰ç”Ÿå‘½å‘¨æœŸç­‰çº¦æŸï¼Œä»è€Œä¿è¯åœ¨ç¼–è¯‘æœŸèƒ½å¤Ÿè§£å†³å¤§å¤šæ•°çš„å†…å­˜å®‰å…¨é—®é¢˜ã€‚\næ ˆ \u0026amp;\u0026amp; å † å¦‚æœè¦è¯´å†…å­˜ç®¡ç†çš„è¯ï¼Œé¦–å…ˆéœ€è¦æ˜ç¡®æ ˆå’Œå †çš„æ¦‚å¿µï¼Œè¿™ä¸€ç‚¹å¯¹äºæ‰€æœ‰ç¼–ç¨‹è¯­è¨€éƒ½é€‚ç”¨ï¼Œä½†æ˜¯åœ¨rustå½“ä¸­å°¤ä¸ºé‡è¦ï¼š\nåŸºæœ¬ç±»å‹å’Œå°çš„å¤åˆç±»å‹ï¼Œåƒæ•´æ•°ã€æµ®ç‚¹æ•°ã€å¸ƒå°”å€¼ã€å­—ç¬¦ä»¥åŠå°çš„æ•°ç»„ã€å…ƒç»„å’Œç»“æ„ä½“è¿™æ ·çš„åŸºæœ¬ç±»å‹é€šå¸¸æ˜¯åœ¨æ ˆä¸Šåˆ†é…çš„ã€‚è¿™äº›ç±»å‹çš„å¤§å°åœ¨ç¼–è¯‘æ—¶æ˜¯å·²çŸ¥çš„ï¼Œå¹¶ä¸”é€šå¸¸æ˜¯å›ºå®šçš„ã€‚æ­¤å¤–å¼•ç”¨åŒæ ·æ˜¯åˆ†é…åœ¨æ ˆçš„ä¸Šï¼Œä»–æŒ‡å‘å¦å¤–ä¸€ä¸ªæ•°æ®(å¯èƒ½åœ¨æ ˆä¸Šä¹Ÿå¯èƒ½åœ¨å †ä¸Š) åˆ†é…åœ¨å †ä¸Šçš„ä¸»è¦æœ‰ä¸¤ä¸ªç±»å‹ï¼šåŠ¨æ€ç±»å‹å’Œæ™ºèƒ½æŒ‡é’ˆï¼Œæ™ºèƒ½æŒ‡é’ˆè‡ªèº«æ˜¯åˆ†é…åœ¨æ ˆä¸Šçš„ï¼Œä½†æ˜¯å…¶ç®¡ç†çš„æ•°æ®åˆ†é…åœ¨å †ä¸Šã€‚è€ŒåŠ¨æ€ç±»å‹å¦‚Vecã€Stringç­‰éœ€è¦è¿›è¡ŒåŠ¨æ€æ‰©å®¹ï¼Œå› æ­¤åˆ†é…åœ¨å †ä¸Šè¿›è¡Œç®¡ç†æ•°æ®ã€‚ å•ä¸€æ‰€æœ‰æƒ å¯¹äºåŸºç¡€ç±»å‹ï¼Œrustå°†å…¶åˆ†é…åœ¨æ ˆä¸Šï¼Œä¼šéšç€æ ˆæ¡¢çš„å¼¹å‡ºè€Œè¢«å›æ”¶ï¼Œå’Œå…¶ä»–è¯­è¨€ç›¸åŒï¼Œä¸éœ€è¦æ‹…å¿ƒæ ˆä¸Šå†…å­˜å®‰å…¨çš„é—®é¢˜ã€‚\nä¸ºäº†èƒ½å¤Ÿç®¡ç†å †ä¸Šçš„æ•°æ®ï¼Œä¿è¯å†…å­˜å®‰å…¨ï¼Œrustå¯¹äºå †ä¸Šçš„æ•°æ®éƒ½å®šä¹‰äº†ä¸€ä¸ªæ‰€æœ‰æƒã€‚å³å †ä¸Šçš„æ•°æ®åœ¨æŸä¸€äº‹ä»¶åªèƒ½è¢«ä¸€ä¸ªå˜é‡æ‰€æŒæœ‰(åŸºç¡€æƒ…å†µ)ï¼Œæ•°æ®ä¼šéšç€æ ˆä¸Šå˜é‡è¢«RAIIå›æ”¶è€Œå›æ”¶ã€‚ä»è€Œä¿è¯äº†å†…å­˜å®‰å…¨ã€‚\nåœ¨ä¸‹é¢ï¼Œå †ä¸Šçš„Stringä¼šéšç€å˜é‡sçš„å›æ”¶è€Œè¢«å›æ”¶\n1 2 3 fn test() { let s = String::from(\u0026#34;hello\u0026#34;); } èµ‹å€¼ åœ¨cppå½“ä¸­ï¼Œå¦‚æœå°†ä¸€ä¸ªæŒ‡é’ˆèµ‹å€¼ç»™å¦å¤–ä¸€ä¸ªæŒ‡é’ˆï¼Œä¸¤ä¸ªæŒ‡é’ˆä¼šæŒ‡å‘åŒä¸€ä¸ªåœ°å€ï¼Œä»è€Œä¸¤ä¸ªæŒ‡é’ˆéƒ½èƒ½å¤Ÿæ“ä½œè¿™ä¸€æ®µåœ°å€å¯¹åº”çš„æ•°æ®ã€‚\nä½†æ˜¯åœ¨Rustä¸­ï¼Œç”±äºå¼•å…¥äº†æ‰€æœ‰æƒçš„æ¦‚å¿µï¼Œä¸€æ®µåœ°å€åªèƒ½è¢«ä¸€ä¸ªå¼•ç”¨æ‰€æŒæœ‰ï¼Œåœ¨åŸºç¡€æƒ…å†µä¸‹ï¼Œä¸å…è®¸ä¸¤ä¸ªå¼•ç”¨æŒ‡å‘å †ä¸ŠåŒä¸€æ®µåœ°å€ï¼Œå› æ­¤ï¼Œå¦‚æœæ˜¯åƒcppè¿›è¡Œèµ‹å€¼æ“ä½œï¼Œåˆ™ä¼šå‘ç”Ÿæ‰€æœ‰æƒçš„è½¬ç§»ï¼Œå³åŸæœ¬çš„å¼•ç”¨å¤±å»å¯¹åœ°å€çš„æ‰€æœ‰æƒï¼Œå°†æ‰€æœ‰æƒè½¬äº¤ç»™æ–°çš„å¼•ç”¨ã€‚\n1 2 3 4 fn test() { let s = String::from(\u0026#34;hello\u0026#34;); let s1 = s; // s1è·å–æ‰€æœ‰æƒï¼Œså¤±å»æ‰€æœ‰æƒ } åˆæˆ–è€…è¯´ï¼Œåœ¨rustå½“ä¸­ï¼Œæ¯ä¸ªå¼•ç”¨ç±»å‹éƒ½å¯¹åº”äº†C++å½“ä¸­çš„unique_ptrï¼Œå¦‚æœæƒ³è®©è½¬ç§»ç»™ä¸€ä¸ªæ–°çš„æŒ‡é’ˆï¼Œå°±éœ€è¦è¿›è¡Œ\u0026quot;move\u0026quot;æ“ä½œã€‚\nè€Œå¦‚æœåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œåªæ˜¯éœ€è¦è¯¥åœ°å€ä¸­çš„æ•°æ®ï¼Œé‚£å°±å¯ä»¥è¿›è¡Œæ·±æ‹·è´ï¼Œåªè·å–æ•°æ®ï¼Œæ ¹æ®æ•°æ®åœ¨å †ä¸Šé‡æ–°åˆ†é…ä¸€æ®µåœ°å€åˆ›å»ºå˜é‡ï¼Œå¹¶ä¸ä¼šå½±å“åŸæœ¬çš„æ•°æ®ï¼ŒåŒæ ·ä¹Ÿä¸ä¼šå‘ç”Ÿæ‰€æœ‰æƒçš„è½¬ç§»ï¼Œå®ç°æ·±æ‹·è´çš„è¯éœ€è¦å®ç°Clone Traitã€‚\n1 2 3 4 fn test() { let s = String::from(\u0026#34;hello\u0026#34;); let s1 = s.clone(); } å¼•ç”¨ä¸ç”Ÿå‘½å‘¨æœŸ å¼•ç”¨ æœ‰äº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¹¶ä¸æƒ³å»è·å–æ‰€æœ‰æƒï¼Œåªæ˜¯æƒ³ä¸´æ—¶å€Ÿç”¨ä¸€ä¸‹è¿™ä¸ªå˜é‡ã€‚è¿™ç§æ—¶å€™ï¼Œrustå°±å¯ä»¥ä½¿ç”¨å¼•ç”¨æ¥å¤„ç†ã€‚\nè¿™é‡Œçš„å¼•ç”¨å…¶å®å’Œc++å½“ä¸­çš„åŸºæœ¬ç±»ä¼¼ï¼Œåªä¸è¿‡ï¼Œrustä¸ºäº†ä¿è¯å®‰å…¨æ€§ï¼Œå¯¹äºå¯å˜æ€§æœ‰ç€æ›´åŠ ä¸¥æ ¼çš„è®¾å®šï¼Œåœ¨c++å½“ä¸­å¯¹äºä¸€ä¸ªconstç±»å‹çš„å˜é‡ï¼Œæ˜¯æ— æ³•å»è·å–ä¸€ä¸ªéconstçš„å¼•ç”¨æ¥ä¿®æ”¹å…¶ä¸­çš„å€¼çš„ï¼Œè¿™ä¸€ç‚¹åœ¨rustå½“ä¸­ä¹Ÿå¾—åˆ°äº†ä¿ç•™ï¼š\n1 2 let x = 5; // ä¸å¯å˜å˜é‡ let y = \u0026amp;mut x; // é”™è¯¯ï¼šä¸èƒ½è·å–ä¸å¯å˜å˜é‡çš„å¯å˜å¼•ç”¨ å¦‚æœæƒ³ä¿®æ”¹çš„è¯ï¼Œåœ¨c++å½“ä¸­å°±éœ€è¦ä½¿ç”¨const_castæ¥è¿›è¡Œè½¬æ¢ï¼Œè€Œrustä¸­å¯ä»¥é€šè¿‡å†…éƒ¨å¯å˜æ€§æ¥è§£å†³ï¼Œä¸è¿‡è¿™å°±æ˜¯åè¯äº†ã€‚\nåœ¨c++ constçš„åŸºç¡€ä¸Šï¼Œruståˆå¤šäº†ä¸€ä¸ªæ–°çš„é™åˆ¶ï¼Œå³åœ¨åŒä¸€ä½œç”¨åŸŸå½“ä¸­ï¼Œå¯¹åŒä¸€æ•°æ®ä¸èƒ½åŒæ—¶æ‹¥æœ‰å¯å˜å¼•ç”¨å’Œä¸å¯å˜å¼•ç”¨ï¼Œè¿™é‡Œä¸»è¦æ˜¯ä¸ºäº†é¿å…æ•°æ®ç«äº‰çš„é—®é¢˜ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œçš„æ•°æ®ç«äº‰å’Œå¤šçº¿ç¨‹æ¯«æ— å…³ç³»ï¼Œå•çº¿ç¨‹åŒæ ·å­˜åœ¨æ•°æ®ç«äº‰é—®é¢˜ã€‚\né€šè¿‡è¿™ç§å†²çªçº¦æŸï¼Œèƒ½å¤Ÿä¿è¯å½“è·å–åˆ°ä¸€ä¸ªä¸å¯å˜å¼•ç”¨æ—¶ï¼Œåœ¨è¯¥å¼•ç”¨å¤±æ•ˆä¹‹å‰ï¼Œèƒ½å¤Ÿä¿è¯æ•°æ®ç¡®å®æ˜¯ä¸å˜çš„ã€‚å¯å˜å¼•ç”¨å’Œå¯å˜å¼•ç”¨ä¹‹é—´çš„å†²çªåŒæ ·å¦‚æ­¤ï¼Œä»»ä½•äººéƒ½ä¸å¸Œæœ›è‡ªå·±åœ¨ä¿®æ”¹è¿‡ç¨‹ä¸­ï¼Œæœ‰å…¶ä»–å¼•ç”¨æ¥ä¿®æ”¹æ•°æ®ï¼Œè¾¾åˆ°å’Œé¢„æœŸä¸ä¸€è‡´çš„ç»“æœã€‚\nè¿™é‡Œæœ‰ç‚¹åƒä¸€ä¸ªè¯»å†™é”çš„è®¾è®¡ï¼Œå¦‚æœå°†ä½œç”¨åŸŸç†è§£ä¸ºä¸€æ®µæ—¶é—´ï¼Œè€Œä¸¤ä¸ªå¼•ç”¨è§†ä¸ºåœ¨äº¤æ›¿æ‰§è¡Œçš„çº¿ç¨‹ï¼Œè¿™æ ·æ•´ä¸ªè¿‡ç¨‹å°±å¯ä»¥è§†ä¸ºå¹¶å‘è¿‡ç¨‹ä¸­çš„æ•°æ®ç«äº‰é—®é¢˜ï¼Œ\n1 2 3 4 5 6 7 8 fn test() { let mut data = 5; let r1 = \u0026amp;data; // ä¸å¯å˜å¼•ç”¨ let r2 = \u0026amp;mut data; // å¯å˜å¼•ç”¨ï¼Œè¿™é‡Œä¼šäº§ç”Ÿç¼–è¯‘é”™è¯¯ println!(\u0026#34;{}\u0026#34;,r1); println!(\u0026#34;{}\u0026#34;,r2); } åœ¨æœ€æ–°çš„rustç¼–è¯‘å™¨å½“ä¸­ï¼Œr1å¯¹dataçš„å¼•ç”¨ä¼šæŒç»­åˆ°æœ€åä¸€æ¬¡ä½¿ç”¨r1ï¼Œè€Œä¸æ˜¯æ•´ä¸ªä½œç”¨åŸŸçš„ç»“å°¾ï¼Œå› æ­¤è¿™æ ·å°±å¯ä»¥é€šè¿‡åˆç†çš„ç¼–æ’ï¼Œå°†â€œå¹¶å‘â€çš„è¿‡ç¨‹è½¬æ¢ä¸ºä¸²è¡Œï¼Œä»è€Œè§£å†³æ•°æ®ç«äº‰çš„é—®é¢˜ï¼Œè¿™ç±»çš„æ•°æ®ç«äº‰é€šå¸¸å‡ºç°åœ¨ï¼Œå…ˆå¯¹ä¸€ä¸ªå®¹å™¨è¿›è¡Œæ¡ä»¶æ€§æ£€ç´¢ï¼Œç„¶åé€šè¿‡æ£€ç´¢ç»“æœå»æ›´æ–°å®¹å™¨ã€‚åœ¨æœç´¢è¿‡ç¨‹ä¸­ä¼šè·å–ä¸€ä¸ªä¸å¯å˜å¼•ç”¨ï¼Œåœ¨ä¿®æ”¹æ—¶åˆä¼šå»è·å–ä¸€ä¸ªå¯å˜å¼•ç”¨ï¼Œä»è€Œäº§ç”Ÿäº†å†²çªï¼Œæ­£ç¡®çš„å†™æ³•æ˜¯åœ¨æ£€ç´¢è¿‡ç¨‹ä¸­ä¿å­˜ç»“æœï¼Œå®Œæˆæ£€ç´¢ä¹‹åå†å»æ›´æ–°å®¹å™¨ï¼Œè€Œä¸æ˜¯ä¸€è¾¹æ£€ç´¢ä¸€è¾¹æ›´æ–°ã€‚\nä¸Šä¾‹ä¸­æ­£ç¡®çš„å†™æ³•å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 fn test() { let mut data = 5; let r1 = \u0026amp;data; // ä¸å¯å˜å¼•ç”¨ println!(\u0026#34;{}\u0026#34;,r1); // r1ç”Ÿå‘½å‘¨æœŸç»“æŸï¼Œé‡Šæ”¾å¼•ç”¨ let r2 = \u0026amp;mut data; // å¯å˜å¼•ç”¨ï¼Œr1è¢«é‡Šæ”¾ä»è€Œr2å¯ä»¥æ­£ç¡®å¼•ç”¨ println!(\u0026#34;{}\u0026#34;,r2); } ç”Ÿå‘½å‘¨æœŸ rustä¸­ç”Ÿå‘½å‘¨æœŸæ ‡æ³¨ï¼Œæ ¸å¿ƒç›®çš„æ˜¯è§£å†³å‚æ‚¬å¼•ç”¨çš„é—®é¢˜ï¼Œé€šä¿—æ¥è®²ï¼Œå°±æ˜¯è°æ¯”è°æ´»å¾—é•¿çš„ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœaæ¯”bæ´»å¾—é•¿ï¼Œä½†æ˜¯aå´å¼•ç”¨äº†bï¼Œé‚£ä¹ˆå°±å­˜åœ¨ä¸€æ®µæ—¶é—´ï¼Œbå·²ç»è¢«é‡Šæ”¾äº†ï¼Œä½†æ˜¯aä¾æ—§æŒæœ‰ä¸€ä¸ªbçš„å¼•ç”¨ï¼Œå»æ“ä½œbï¼Œè¿™æ—¶å€™å°±ä¼šå‡ºç°å†…å­˜å®‰å…¨çš„é—®é¢˜ã€‚\næœ€ç»å…¸çš„è¿åç”Ÿå‘½å‘¨æœŸçº¦æŸçš„ä¾‹å­å¦‚ä¸‹,rçš„ç”Ÿå‘½å‘¨æœŸé•¿äºxï¼Œæ­¤æ—¶å¼•ç”¨xå°±ä¼šäº§ç”Ÿå‚æ‚¬å¼•ç”¨ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 { let r; { let x = 5; r = \u0026amp;x; } println!(\u0026#34;r: {}\u0026#34;, r); } error[E0597]: `x` does not live long enough --\u0026gt; src/main.rs:7:5 | 6 | r = \u0026amp;x; | - borrow occurs here 7 | } | ^ `x` dropped here while still borrowed ... 10 | } | - borrowed value needs to live until here å‡½æ•°ä¸­çš„ç”Ÿå‘½å‘¨æœŸ å’ŒC++ç›¸åŒï¼ŒruståŒæ ·ä¸å…è®¸è¿”å›å±€éƒ¨å˜é‡çš„å¼•ç”¨ï¼Œå› ä¸ºä¼šè¢«RAIIåœ¨å‡½æ•°æ‰§è¡Œå®Œä¹‹åé‡Šæ”¾æ‰ï¼Œä¸€å®šä¼šäº§ç”Ÿå‚æ‚¬å¼•ç”¨é—®é¢˜ã€‚å› æ­¤å¯¹äºå‡½æ•°ä¸­çš„ç”Ÿå‘½å‘¨æœŸï¼Œåªèƒ½æ¥è‡ªè¾“å…¥ã€‚\nä¸€èŠåˆ°rustå‡½æ•°çš„ç”Ÿå‘½å‘¨æœŸï¼Œå°±ä¼šæœ‰è¿™æ ·ä¸€ä¸ªç»å…¸çš„ä¾‹å­ï¼š\n1 2 3 4 5 6 7 fn longest(x: \u0026amp;str, y: \u0026amp;str) -\u0026gt; \u0026amp;str { if x.len() \u0026gt; y.len() { x } else { y } } çœ‹èµ·æ¥å†™çš„æ¯«æ— é—®é¢˜ï¼Œè·å–ä¸¤ä¸ªå¼•ç”¨ï¼Œè¿”å›å…¶ä¸­ä¹‹ä¸€ï¼Œä½†å®é™…ä¸Šä¼šè¢«rustç¼–è¯‘å™¨ç»™æ— æƒ…çš„æ‹’ç»æ‰ï¼Œè€Œå…·ä½“åŸå› æ˜¯æ— æ³•ç¡®å®šxå’Œyç©¶ç«Ÿè°èƒ½å¤Ÿæ´»çš„æ›´ä¹…çš„é—®é¢˜ï¼Œå¦‚æœåƒä»¥ä¸‹è¿™æ ·ï¼Œå°±ä¼šå‡ºç°é—®é¢˜ï¼Œæ­¤æ—¶s2çš„ä½œç”¨åŸŸæ›´å°ï¼Œæå‰é‡Šæ”¾ï¼Œä»è€Œresäº§ç”Ÿäº†å‚æ‚¬å¼•ç”¨çš„é—®é¢˜ï¼Œè¿™ç§æƒ…å†µåœ¨ä¸ä½¿ç”¨å‡½æ•°çš„æƒ…å†µä¸‹ä¸åº”è¯¥å‘ç”Ÿï¼Œè€Œåœ¨è¿›è¡Œå‡½æ•°è°ƒç”¨æ—¶åŒæ ·ä¸åº”è¯¥å‘ç”Ÿï¼Œå› æ­¤å¦‚æœä¸è¿›è¡Œç”Ÿå‘½å‘¨æœŸçš„æ ‡æ³¨ï¼Œç¼–è¯‘å™¨å°±ä¼šä¸¥è‹›çš„æ‹’ç»æ‰ï¼Œä»¥é¿å…é£é™©ï¼Œæ­£ç¡®çš„æ ‡æ³¨æ–¹æ³•å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 fn test() { let res; let s1 = String::from(\u0026#34;1\u0026#34;); { let s2 = String::from(\u0026#34;11111\u0026#34;); res = longeest(\u0026amp;s1,\u0026amp;s2); } } fn longest\u0026lt;\u0026#39;a\u0026gt;(x: \u0026amp;\u0026#39;a str, y: \u0026amp;str) -\u0026gt; \u0026amp;\u0026#39;a str { } ç»“æ„ä½“ä¸­çš„ç”Ÿå‘½å‘¨æœŸ ç›¸æ¯”äºå‡½æ•°çš„ç”Ÿå‘½å‘¨æœŸï¼Œç»“æ„ä½“ä¸­çš„ç”Ÿå‘½å‘¨æœŸå¯èƒ½æ›´ä¸ºå¸¸è§ï¼Œå› ä¸ºç»“æ„ä½“å½“ä¸­çš„å­—æ®µï¼Œå¹¶ä¸æ˜¯éƒ½æ˜¯è‡ªå·±æ‰€æœ‰çš„ï¼Œæœ‰äº›å­—æ®µéœ€è¦å¼•ç”¨å…¶ä»–çš„å˜é‡ï¼Œè¿™ç§å†™æ³•éšå¤„å¯è§ï¼Œæ¯”å¦‚è¯´ä¸€ä¸ªå®¹å™¨çš„è¿­ä»£å™¨ï¼Œå…·ä½“å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 type SkipListIter\u0026lt;\u0026#39;a\u0026gt; = Range\u0026lt;\u0026#39;a,InternalKey,(Bound\u0026lt;InternalKey\u0026gt;,Bound\u0026lt;InternalKey\u0026gt;),InternalKey,ByteVec\u0026gt;; pub struct MemTableIterator \u0026lt;\u0026#39;a\u0026gt; { skip_list: \u0026amp;\u0026#39;a SkipMap\u0026lt;InternalKey,ByteVec\u0026gt;, iter: SkipListIter\u0026lt;\u0026#39;a\u0026gt;, key: ByteVec, value: ByteVec, } impl \u0026lt;\u0026#39;a\u0026gt; Iterator\u0026lt;\u0026#39;a\u0026gt; for MemTableIterator\u0026lt;\u0026#39;a\u0026gt; { fn seek(\u0026amp;mut self, target: \u0026amp;[u8]) { let target_key_min = InternalKey::new(target, MAX_SEQUENCE,K_VALUE_TYPE_FOR_SEEK); let min_bound = Bound::Included(target_key_min); self.iter = self.skip_list.range((min_bound,Bound::Unbounded)); self.next(); } } ä½œä¸ºä¸€ä¸ªè¿­ä»£å™¨çš„Wrapperï¼Œå…¶ä¸­å°è£…äº†skip_mapçš„iterï¼Œä¾‹å¦‚seekç­‰åŠŸèƒ½ï¼Œéœ€è¦æ ¹æ®skip_mapå»é‡æ–°ç”Ÿæˆä¸€ä¸ªiterï¼Œå¹¶ä¿å­˜åˆ°iterçš„å­—æ®µå½“ä¸­ï¼Œiteræœ¬èº«æ˜¯å¯¹å®¹å™¨çš„å¼•ç”¨ï¼Œå› æ­¤è¿™ä¸ªç”Ÿæˆçš„è¿‡ç¨‹å°±æ˜¯å»è·å–ä¸€ä¸ªå¼•ç”¨ã€‚\nè€Œæ­¤æ—¶å°±éœ€è¦å»è¿›è¡Œä¸€ä¸ªç”Ÿå‘½å‘¨æœŸçš„ä¿è¯ï¼ŒåŸæœ¬çš„å®¹å™¨çš„å¼•ç”¨skip_mapè‡³å°‘è¦å’Œiteræ´»å¾—ä¸€æ ·ä¹…ï¼Œæ‰èƒ½å¤Ÿç”Ÿæˆä¸€ä¸ªå¼•ç”¨å®¹å™¨çš„iterï¼Œå¹¶å¤åˆ¶ç»™ç»“æ„ä½“ä¸­çš„å­—æ®µã€‚\nåœ¨è¿™ç§ç”Ÿå‘½å‘¨æœŸçš„æ ‡æ³¨ä¸‹ï¼Œè¡¨æ˜äº†ï¼š\nåœ¨åˆ›å»ºç»“æ„ä½“MemTableIteratoræ—¶ï¼Œè®¾å½“å‰ç»“æ„ä½“çš„ç”Ÿå‘½å‘¨æœŸä¸ºa åœ¨ç»“æ„ä½“å½“ä¸­ä¼šå¼•ç”¨ä¸€ä¸ªè‡³å°‘å’Œå½“å‰ç»“æ„ä½“ç”Ÿå‘½å‘¨æœŸaä¸€æ ·é•¿çš„å®¹å™¨ ä¿å­˜ä¸€ä¸ª iter å­—æ®µï¼Œå…¶ç”Ÿå‘½å‘¨æœŸè‡³å°‘ å’Œå½“å‰ç»“æ„ä½“ä¸€æ ·é•¿ å¯¹äºä¸Šé¢çš„æƒ…å†µï¼Œå¦‚æœç»“æ„ä½“å½“ä¸­ä¿å­˜ä¸€ä¸ªArc\u0026lt;SkipMap\u0026gt;çš„è¯ï¼Œå¯¹äºè¯¥æ–¹æ³•ï¼Œä¼ å…¥äº†\u0026amp;selfï¼Œè€Œåœ¨rustå½“ä¸­ï¼Œ\u0026amp;selfæ˜¯ç‹¬ç«‹äºç»“æ„ä½“ä¸­å£°æ˜çš„ç”Ÿå‘½å‘¨æœŸ'açš„ï¼Œå¯ä»¥è¿™é‡Œå¯ä»¥å®šä¹‰ä¸º'bï¼Œç¼–è¯‘å™¨æ— æ³•å¾—çŸ¥\u0026rsquo;a \u0026lsquo;b ä¹‹é—´çš„ç”Ÿå‘½å‘¨æœŸå…³ç³»ï¼Œå› æ­¤å°±ä¼šæ‹’ç»æ‰ã€‚è¯¥å‡½æ•°å®é™…çš„å£°æ˜å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 impl \u0026lt;\u0026#39;a\u0026gt; Iterator\u0026lt;\u0026#39;a\u0026gt; for MemTableIterator\u0026lt;\u0026#39;a\u0026gt; { fn seek(\u0026amp;\u0026#39;b mut self, target: \u0026amp;[u8]) { let target_key_min = InternalKey::new(target, MAX_SEQUENCE,K_VALUE_TYPE_FOR_SEEK); let min_bound = Bound::Included(target_key_min); self.iter = self.skip_list.range((min_bound,Bound::Unbounded)); self.next(); } } è€Œè‡³äºrustä¸ºä»€ä¹ˆè¦è¿™æ ·åšï¼Œä¸»è¦æ˜¯ä¸ºäº†çµæ´»æ€§ã€‚ä¾‹å¦‚ï¼ŒæŸäº›æ–¹æ³•å¯èƒ½åªæ˜¯ä¸´æ—¶å€Ÿç”¨ç»“æ„ä½“çš„æ•°æ®ï¼Œè€Œä¸éœ€è¦æŒæœ‰ä¸æ•´ä¸ªç»“æ„ä½“ç›¸åŒçš„ç”Ÿå‘½å‘¨æœŸã€‚é€šè¿‡å…è®¸ç‹¬ç«‹çš„ç”Ÿå‘½å‘¨æœŸï¼ŒRust å¯ä»¥æ›´å‡†ç¡®åœ°è¡¨ç¤ºè¿™ç§å€Ÿç”¨è¡Œä¸º:\n1 2 3 4 5 6 7 8 9 struct MyStruct\u0026lt;\u0026#39;a\u0026gt; { reference: \u0026amp;\u0026#39;a i32, } impl\u0026lt;\u0026#39;a\u0026gt; MyStruct\u0026lt;\u0026#39;a\u0026gt; { fn get_reference(\u0026amp;self) -\u0026gt; \u0026amp;i32 { self.reference } } ç”Ÿå‘½å‘¨æœŸæ¶ˆé™¤ å¦‚æœæ‰€æœ‰çš„å¼•ç”¨éƒ½éœ€è¦æ‰‹åŠ¨è¿›è¡Œæ ‡æ³¨ï¼Œé‚£ä¹ˆç¼–ç¨‹ä½“éªŒè‡ªç„¶æ˜¯ç¾éš¾çš„ï¼Œå› æ­¤ç¼–è¯‘å™¨è®¾ç½®äº†ä¸‰æ¡è§„åˆ™ï¼Œå¦‚æœæ»¡è¶³äº†å°±å¯ä»¥è‡ªåŠ¨å®Œæˆç”Ÿå‘½å‘¨æœŸæ ‡æ³¨ï¼Œä»è€Œä¸éœ€è¦æ‰‹åŠ¨æ ‡æ³¨ï¼š\næ¯ä¸ªå¼•ç”¨å‚æ•°éƒ½ä¼šè·å¾—ç‹¬è‡ªçš„ç”Ÿå‘½å‘¨æœŸ å¦‚æœåªæœ‰ä¸€ä¸ªè¾“å…¥ç”Ÿå‘½å‘¨æœŸï¼Œé‚£ä¹ˆè¯¥ç”Ÿå‘½å‘¨æœŸå°±ä¼šèµ‹ç»™æ‰€æœ‰çš„è¾“å‡ºç”Ÿå‘½å‘¨æœŸ å¦‚æœå­˜åœ¨å¤šä¸ªè¾“å…¥ç”Ÿå‘½å‘¨æœŸï¼Œå…¶ä¸­ä¸€ä¸ªæ˜¯\u0026amp;selfæˆ–è€…\u0026amp;mut selfï¼Œé‚£ä¹ˆ\u0026amp;selfçš„ç”Ÿå‘½å‘¨æœŸè¢«èµ‹ç»™æ‰€æœ‰è¾“å‡ºç”Ÿå‘½å‘¨æœŸ æ¥å‡ ä¸ªä¾‹å­ï¼š\n1 2 3 4 fn first_word(s: \u0026amp;str) -\u0026gt; \u0026amp;str { // å®é™…é¡¹ç›®ä¸­çš„æ‰‹å†™ä»£ç  // æ ¹æ®è§„åˆ™1ï¼Œå¾—åˆ°ï¼š fn first_word(s: \u0026amp;\u0026#39;a str) -\u0026gt; \u0026amp;str { //ä¹‹åæ ¹æ®è§„åˆ™2å®Œæˆäº†ç”Ÿå‘½ 1 2 3 fn longest(x: \u0026amp;str, y: \u0026amp;str) -\u0026gt; \u0026amp;str { // å®é™…é¡¹ç›®ä¸­çš„æ‰‹å†™ä»£ç  // æ ¹æ®è§„åˆ™1ï¼Œå¾—åˆ°ï¼š fn longest\u0026lt;\u0026#39;a, \u0026#39;b\u0026gt;(x: \u0026amp;\u0026#39;a str, y: \u0026amp;\u0026#39;b str) -\u0026gt; \u0026amp;str { åç»­å°±ä¸æ»¡è¶³ä»»ä½•è§„åˆ™äº†ï¼Œå› æ­¤æ— æ³•è‡ªåŠ¨æ¶ˆé™¤ï¼Œéœ€è¦æ‰‹åŠ¨è¿›è¡Œç”Ÿå‘½å‘¨æœŸçš„æ ‡æ³¨ã€‚ è€Œå¯¹äºç¬¬ä¸‰æ¡ï¼Œå¸¦ä¸Š\u0026amp;selfçš„å°±æ˜¯æ–¹æ³•äº†ï¼Œå¯¹äºæ–¹æ³•çš„ç”Ÿå‘½å‘¨æœŸï¼Œå¾—ç›Šäºä¸€ä¸‰æ¡è§„åˆ™ï¼Œé€šå¸¸ä¸éœ€è¦è¿›è¡Œæ‰‹åŠ¨æ ‡æ³¨ã€‚\nå°ç»“ï¼šç”Ÿå‘½å‘¨æœŸçš„æ ‡æ³¨ä¸ä¼šæ”¹å˜ä»»ä½•å¼•ç”¨çš„å®é™…ä½œç”¨åŸŸï¼Œä»–åªæ˜¯ä¸ºäº†å–æ‚¦ç¼–è¯‘å™¨ï¼Œè®©ç¼–è¯‘å™¨ä¸è¦éš¾ä¸ºæˆ‘ä»¬ï¼Œåœ¨è¿›è¡Œæ ‡æ³¨ä¹‹åï¼Œå°±ä¼šæŒ‰ç…§æ ‡æ³¨å»è¿›è¡Œæ£€æŸ¥ï¼Œä»è€Œä¿è¯å†…å­˜å†…å­˜å®‰å…¨ã€‚\nå…±äº«æ‰€æœ‰æƒ åœ¨ä¸Šè¿°çš„æƒ…å†µä¸­ï¼Œæ•°æ®çš„æ‰€æœ‰æƒæ°¸è¿œåªå±äºåŒä¸€ä¸ªå˜é‡ã€‚å…¶ä»–æƒ³è¦è®¿é—®è¯¥æ•°æ®åªèƒ½é€šè¿‡å¼•ç”¨æ¥è·å–ï¼Œè¿™æ ·çš„é—®é¢˜æ˜¯ï¼ŒåŸå§‹æ•°æ®å¿…é¡»æœ‰æœ€é•¿çš„ç”Ÿå‘½å‘¨æœŸï¼Œæ‰èƒ½å¤Ÿä¿è¯å…¶ä»–çš„å¼•ç”¨æœ‰æ•ˆã€‚ä½†æ˜¯æœ‰äº›æƒ…å†µï¼Œéœ€è¦å¤šä¸ªæ‰€æœ‰è€…æŒæœ‰åŒä¸€ä¸ªæ•°æ®ï¼Œå¹¶ä¸”ä½¿ç”¨è€…ä¹‹é—´æ˜¯å¯¹ç­‰å…³ç³»ï¼Œæ— æ³•ç¡®å®šä¸€ä¸ªæœ€é•¿çš„æŒæœ‰è€…ã€‚ï¼š\nåœ¨åŒå‘é“¾è¡¨ä¸­ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½ä¼šè¢«å‰ä¸€ä¸ªèŠ‚ç‚¹å’Œåä¸€ä¸ªèŠ‚ç‚¹ä¿å­˜(æŒæœ‰)ã€‚ åœ¨å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­ï¼Œå¤šä¸ªçº¿ç¨‹æŒæœ‰åŒä¸€ä¸ªæ•°æ®ï¼Œå¯¹å…¶è¿›è¡Œä¿®æ”¹ï¼Œç”±äº rust çš„å•ä¸€å¯å˜å¼•ç”¨çš„é™åˆ¶ï¼Œæ— æ³•ä½¿ç”¨å¼•ç”¨æ¥å®Œæˆã€‚ åœ¨Rustå½“ä¸­ï¼Œç»™å‡ºçš„è§£å†³æ–¹æ³•å°±æ˜¯å€ŸåŠ©å¼•ç”¨è®¡æ•°çš„æ€æƒ³ï¼Œä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆRc\u0026lt;T\u0026gt;ä¸Arc\u0026lt;T\u0026gt;ï¼Œå…¶å®ç°çš„ä½œç”¨ç±»ä¼¼äºC++å½“ä¸­çš„share_ptrï¼Œä¸è¿‡åšäº†æ›´å¤šçš„é™åˆ¶æ¥ä¿è¯å®‰å…¨ã€‚\næ­£å¦‚åå­—ï¼ŒArcå®ç°çš„å¼•ç”¨è®¡æ•°æ˜¯Atomicçš„ï¼Œå¯ä»¥ç”¨äºå¤šçº¿ç¨‹ç¯å¢ƒå½“ä¸­ï¼ŒRcåä¹‹ã€‚ ç›¸æ¯”äºC++çš„share_ptrè€Œè¨€ï¼ŒRcä¸Arcæœ€å¤§çš„å·®åˆ«å°±æ˜¯å®ç°çš„æ˜¯ä¸å¯å˜å¼•ç”¨ï¼Œé€šè¿‡è¯¥æŒ‡é’ˆæ— æ³•ç›´æ¥ä¿®æ”¹æŒ‡å‘çš„æ•°æ®ï¼Œåªèƒ½å¤Ÿè¿›è¡Œè¯»å–ï¼Œè€Œå¦‚æœè¿›è¡Œè¯»å–ï¼Œå°±éœ€è¦é€šè¿‡å†…éƒ¨å¯å˜æ€§æ¥å®ç°ï¼Œå³RefCellå’ŒMutex\nå†…éƒ¨å¯å˜æ€§ å…³äºå†…éƒ¨å¯å˜æ€§ï¼Œå¤§æ¦‚æœ‰ä¸¤ä¸ªæ¯”è¾ƒé‡è¦çš„æ¦‚å¿µï¼Œä¸€ä¸ªæ˜¯â€œå…±äº«â€ï¼Œå³é€šè¿‡å¼•ç”¨è®¡æ•°æ¥ä»¤æ•°æ®å¯ä»¥åœ¨å¤šä¸ªæŒæœ‰è€…ä¹‹é—´è¿›è¡Œå…±äº«ï¼Œå¹¶ä¸”å…è®¸è¿›è¡Œä¿®æ”¹ã€‚å¦ä¸€ä¸ªæ˜¯â€œå†…éƒ¨â€ï¼Œä½“ç°äº†å°è£…çš„æ€æƒ³ã€‚\nå¯å˜æ€§\nå¯¹äºåŸºç¡€çš„Rcå’ŒArcï¼Œruståªå…è®¸å¯¹å…¶è¿›è¡Œè¯»å–ï¼Œè€Œæ— æ³•ä¿®æ”¹æ•°æ®ï¼Œé€šè¿‡RefCellå’ŒMutexå…è®¸å¯¹å…¶è¿›è¡Œä¿®æ”¹ï¼Œä½†æ˜¯å¯å˜å¼•ç”¨å’Œä¸å¯å˜å¼•ç”¨ä¹‹é—´çš„å†²çªæ— æ³•ç»•è¿‡ï¼Œåªæ˜¯å°†è¿™ä¸ªè¿‡ç¨‹ä»ç¼–è¯‘å™¨æ¨è¿Ÿåˆ°äº†è¿è¡ŒæœŸï¼Œå¦‚æœæ£€æµ‹åˆ°è¿åçº¦æŸï¼Œç¨‹åºä¼šç›´æ¥panicã€‚\næ•°æ®å…±äº«\nåœ¨å•çº¿ç¨‹æ—¶å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå…±äº«æ•°æ®å¯ä»¥é€šè¿‡å¼•ç”¨æ¥è§£å†³ï¼Œåªè¦å°å¿ƒçš„ä¿è¯åªæœ‰ä¸€ä¸ªå¯å˜å¼•ç”¨çš„åŸåˆ™å°±å¯ä»¥å®ç°ï¼Œä½†æ˜¯æœ‰äº›æƒ…å†µå°±å¾ˆéš¾å¤„ç†äº†ï¼Œå³åœ¨é€»è¾‘ä¸Šå¾ˆéš¾ç¡®å®šä¸€ä¸ªä¸»ä»å…³ç³»ï¼Œå°†æ•°æ®çš„æ‰€æœ‰æƒå½’äºè°ï¼Œè€Œå…¶ä»–çš„å»è¿›è¡Œå¼•ç”¨ã€‚ç”±äºåŸèŠ‚ç‚¹å¦‚æœè¢«é‡Šæ”¾çš„è¯ï¼Œå…¶ä»–çš„å¼•ç”¨å…¨éƒ¨å¤±æ•ˆï¼Œå› æ­¤éœ€è¦ç¡®å®šä¸¥æ ¼çš„ç”Ÿå‘½å‘¨æœŸå…³ç³»ï¼Œåœ¨æœ‰äº›æƒ…å†µä¸‹ï¼Œå„ä¸ªä½¿ç”¨è€…ä¹‹é—´æ˜¯å¯¹ç­‰çš„å…³ç³»ï¼Œå› æ­¤å¾ˆéš¾ç¡®å®šå‡ºè¿™æ ·ä¸€ç§å…³ç³»å’Œç”Ÿå‘½å‘¨æœŸï¼Œæ¯”è¾ƒç»å…¸çš„ä¸€ä¸ªä¾‹å­å°±æ˜¯åŒç«¯é“¾è¡¨ï¼Œå„ä¸ªèŠ‚ç‚¹ä¹‹é—´éƒ½æ˜¯å¯¹ç­‰çš„ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½å¯èƒ½å› ä¸ºç§»å‡ºé“¾è¡¨è€Œè¢«é‡Šæ”¾ï¼Œä¸å­˜åœ¨ä¸€ä¸ªæ˜ç¡®çš„ç”Ÿå‘½å‘¨æœŸå…³ç³»ï¼Œè¿™ç§æ—¶å€™å†ä½¿ç”¨å¼•ç”¨å°±ä¸å¤ªç¬¦åˆé€»è¾‘äº†ã€‚ è€Œå¯¹äºå¤šçº¿ç¨‹ï¼Œé‚£ä¹ˆå°±æ›´éšå¤„å¯è§äº†ï¼Œå…¨å±€åŸå­æ€§è®¡æ•°å™¨ã€æ¶ˆæ¯é˜Ÿåˆ—ã€cacheã€ä»»åŠ¡é˜Ÿåˆ—éƒ½éœ€è¦è¿›è¡Œå…±äº«ï¼Œæ— æ³•è¯´å‡ºæ•°æ®åˆ°åº•è¯¥å½’å±äºè°ï¼Œå°±æ‹¿æ¶ˆæ¯é˜Ÿåˆ—æ¥è¯´ï¼Œé˜Ÿåˆ—ç©¶ç«Ÿè¯¥å±äºè°ï¼Ÿæ— è®ºå±äºå“ªä¸€æ–¹ç„¶åå¦å¤–ä¸€æ–¹å»å¼•ç”¨éƒ½æ˜¯ä¸ç¬¦åˆé€»è¾‘çš„ï¼ŒäºŒè€…æ˜¯ä¸€ä¸ªå…±äº«çš„å…³ç³»ã€‚å…¶å®è¿™å°±æ˜¯ä¸€ä¸ªè®¾è®¡å“²å­¦çš„é—®é¢˜ï¼Œåœ¨C++98å½“ä¸­ï¼Œç¡¬æŠŠé˜Ÿåˆ—å½’å±äºæŸä¸€æ–¹ï¼Œç„¶åè®©å¦å¤–ä¸€æ–¹å»å¼•ç”¨ä¹Ÿæ²¡ä»€ä¹ˆé—®é¢˜ï¼Œåªä¸è¿‡ruståœ¨è®¾è®¡ä¸Šå¼ºè°ƒäº†å…±äº«çš„è¿™ä¸ªæ¦‚å¿µï¼Œå¹¶ä¸”åœ¨ç¼–è¯‘å™¨å±‚é¢åšäº†é™åˆ¶è€Œå·²ã€‚\nå†…éƒ¨æ˜¯ä»€ä¹ˆ\nåœ¨è¯´æ˜å†…éƒ¨æ—¶ï¼Œéœ€è¦å¯¹äºå¯å˜åšä¸€äº›è¯ é‡Šï¼Œåœ¨C++å½“ä¸­ï¼Œé€šå¸¸æˆ‘ä»¬å»è·å–ä¸€ä¸ªconstå¼•ç”¨ï¼Œè¿™æ—¶èƒ½å¤Ÿä¿è¯çš„æ˜¯æˆ‘ä»¬æ— æ³•é€šè¿‡è¿™ä¸ªå¼•ç”¨æ¥ä¿®æ”¹åŸæœ¬çš„æ•°æ®ï¼Œä½†æ˜¯åœ¨rustå½“ä¸­ï¼Œæˆ‘ä»¬è·å–äº†ä¸€ä¸ªä¸å¯å˜å¼•ç”¨ï¼Œè¿™æ—¶å€™æˆ‘ä»¬æ‰€æœŸå¾…çš„æ˜¯åœ¨æˆ‘æŒæœ‰è¿™ä¸ªå¼•ç”¨çš„è¿™ä¸€æ®µæ—¶é—´å†…ï¼Œè¿™ä¸ªå¼•ç”¨æŒ‡å‘çš„æ•°æ®éƒ½ä¸ä¼šè¢«æ”¹å˜ï¼Œé€šè¿‡å¼•ç”¨ï¼Œèƒ½å¤Ÿå¯¹å…¶è¿›è¡Œâ€œå¯é‡å¤è¯»â€ã€‚äºŒè€…çš„å‡ºå‘ç‚¹æ˜¯æœ‰æ‰€ä¸åŒçš„ï¼ŒC++çš„constæ˜¯ä¿è¯è‡ªèº«ä¸å»è¿›è¡Œä¿®æ”¹ï¼Œè€Œrustçš„émutæ˜¯ä¿è¯æ²¡æœ‰å…¶ä»–çš„å¼•ç”¨èƒ½å¤Ÿä¿®æ”¹(åŒæ ·ä¹Ÿä¿è¯äº†è‡ªèº«ä¸å»ä¿®æ”¹)ã€‚ æ‰€ä»¥ï¼Œè¿™é‡Œæˆ‘å¯¹rustä¸­ä¸å¯å˜çš„ç†è§£æ˜¯ï¼šæˆ‘èƒ½å¤Ÿè·å–åˆ°æ•°æ®ï¼Œå¹¶ä¸”åœ¨æˆ‘ä½¿ç”¨æ•°æ®çš„è¿‡ç¨‹ä¸­ï¼Œæ•°æ®éƒ½æ˜¯ä¸€ç›´ä¿è¯ä¸å˜çš„ã€‚\né‚£ä¹ˆå†…éƒ¨ç©¶ç«Ÿè¯¥å¦‚ä½•ç†è§£å‘¢ï¼Ÿè¿™é‡Œrustæœ‰ä¸€ä¸ªæ¯”è¾ƒæœ‰æ„æ€çš„å®ç°ï¼Œå°±æ˜¯å¯¹äºä¸€ä¸ªå¯å˜çš„æ–¹æ³•ï¼Œå¦‚æœä»–æ‰€å±å¯¹è±¡Aåœ¨ç»“æ„ä½“Bä¸­è¢«Arc\u0026lt;Mutex\u0026lt;T\u0026gt;\u0026gt;åŒ…è£¹ï¼Œé‚£ä¹ˆåœ¨Bä¸­å°±å¯ä»¥ä½¿ç”¨ä¸å¯å˜çš„æ–¹æ³•æ¥è¿›è¡Œè°ƒç”¨ï¼Œè¿™é‡Œå®é™…ä¸Šæ˜¯è¿›è¡Œä¿®æ”¹äº†çš„ï¼Œä½†æ˜¯å¯ä»¥ä¿è¯åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªå¯å˜å¼•ç”¨ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼š è¿™é‡Œå®šä¹‰äº†ä¸€ä¸ªShardLRUCacheï¼Œå…¶ä¸­æœ‰å¤šä¸ªLRUCacheï¼Œè€Œç”±äºLRUçš„getä¼šåˆ·æ–°ç¼“å­˜ï¼Œå› æ­¤ä»–æ˜¯ä¸€ä¸ª\u0026amp;mut selfçš„ï¼Œä½†æ˜¯åœ¨ShardLRUCacheå½“ä¸­ï¼Œåœ¨è¿›è¡ŒåŠ é”ä¹‹åï¼Œå¯ä»¥ä½¿ç”¨\u0026amp;selfæ–¹æ³•æ¥å¯¹å…¶è¿›è¡Œè°ƒç”¨ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 struct BaseCache { replacer: LRUReplacer, block_table: HashMap\u0026lt;BlockId,Arc\u0026lt;Block\u0026gt;\u0026gt;, cache_size: usize, } impl BaseCache { pub fn look_up(\u0026amp;mut self,block_id: BlockId) -\u0026gt; Option\u0026lt;Arc\u0026lt;Block\u0026gt;\u0026gt; { match self.block_table.get(\u0026amp;block_id) { Some(block) =\u0026gt; { self.replacer.record_access(block_id.clone()); Some(block.clone()) }, None =\u0026gt; { None } } } } // ä½¿ç”¨Arc\u0026lt;Mutex\u0026lt;T\u0026gt;\u0026gt;æ¥å®Œæˆå¤šçº¿ç¨‹é—´çš„å…±äº«ã€‚ pub struct ShardCache { shards: Vec\u0026lt;Arc\u0026lt;Mutex\u0026lt;BaseCache\u0026gt;\u0026gt;\u0026gt;, last_id: usize, } // ä½¿ç”¨ä¸å¯å˜å¼•ç”¨çš„æ–¹æ³•å¯¹å…¶è¿›è¡Œè°ƒç”¨ impl ShardCache { pub fn look_up(\u0026amp;self,block_id: BlockId) -\u0026gt; Option\u0026lt;Arc\u0026lt;Block\u0026gt;\u0026gt; { let idx = Self::find_shard(block_id); self.shards[idx] .lock().unwrap() .look_up(block_id) } } è€Œè¿™é‡Œï¼Œruståœ¨ä¸€ä¸ªä¸å¯å˜æ–¹æ³•ä¸­é€šè¿‡åŠ é”çš„å½¢å¼ï¼Œè°ƒç”¨äº†ä¸€ä¸ªå¯å˜çš„æ–¹æ³•ï¼Œåœ¨è¿›è¡ŒåŠ é”åï¼Œå°±å¯ä»¥ä¿è¯è‡ªèº«åœ¨ä½¿ç”¨è¯¥å¼•ç”¨æ—¶ï¼Œä¸ä¼šæœ‰å…¶ä»–çº¿ç¨‹æ¥ç¯¡æ”¹æ•°æ®ï¼Œä»è€Œå°†ä¸€ä¸ªå¯å˜æ–¹æ³•è½¬æ¢æˆäº†ä¸å¯å˜æ–¹æ³•ï¼Œè¿™ä¹Ÿå°è¯äº†æˆ‘ä¸Šé¢çš„è¯´æ³•ï¼Œrustçš„ä¸å¯å˜æ‰€è¯´çš„æ˜¯ä½¿ç”¨è¿‡ç¨‹ä¸­ä¸ä¼šè¢«å…¶ä»–ä½¿ç”¨è€…æ”¹å˜ã€‚å› æ­¤ï¼Œè¿™é‡Œçš„å†…éƒ¨æ‰€è¯´æ˜çš„å°±æ˜¯è™½ç„¶å†…éƒ¨å®ç°æ˜¯å¯å˜çš„ï¼Œä½†æ˜¯é€šè¿‡çº¦æŸï¼Œå¯ä»¥ä¿è¯åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­çš„å¯¹å¤–çœ‹èµ·æ¥æ˜¯ä¸å˜çš„æ¥å£ï¼Œæ‰€ä»¥ç§°ä¸ºå†…éƒ¨å¯å˜æ€§ã€‚\né‚£ä¹ˆC++å¦‚ä½•å®ç°è¿™ç§ä¿è¯å‘¢ï¼Ÿåœ¨å•çº¿ç¨‹ç¯å¢ƒä¸­æƒ³è¦å®ç°å°±éœ€è¦ç¨‹åºå‘˜è‡ªèº«æ¥è¿›è¡Œçº¦æŸï¼Œè€Œå¤šçº¿ç¨‹å°±éœ€è¦é”æ¥ä¿è¯äº†ã€‚è€ŒruståŒæ ·åœ¨å¤šçº¿ç¨‹æ—¶åŒæ ·æ˜¯ä½¿ç”¨mutexæ¥è§£å†³çš„ï¼Œå¦‚æœä¸ä½¿ç”¨mutexåŒ…è£¹è€Œå»ä¿®æ”¹ï¼Œå°±æ— æ³•é€šè¿‡ç¼–è¯‘ï¼Œä»è€Œåœ¨ç¼–è¯‘å±‚é¢ä¸Šè§£å†³äº†å¤šçº¿ç¨‹çš„æ•°æ®ç«äº‰çš„é—®é¢˜ã€‚å•çº¿ç¨‹ç¯å¢ƒä¹Ÿæ˜¯åŒç†ï¼Œåœ¨ä¸Šé¢å·²ç»åˆ†æè¿‡äº†ã€‚\nç»¼ä¸Šï¼ŒRusté€šè¿‡å¼•ç”¨è®¡æ•° + å¯å˜æ€§ï¼Œå¾ˆä¼˜é›…åœ°åœ¨ç¼–è¯‘æœŸå°±è§£å†³äº†æ•°æ®å…±äº«æ‰€æœ‰æƒã€å¹¶å‘ã€ä»¥åŠæ•°æ®ç«äº‰çš„é—®é¢˜ï¼Œä»è€Œæå¤§åœ°ä¿è¯äº†å†…å­˜å®‰å…¨ï¼Œåœ¨code reviewæ—¶å°±å¯ä»¥ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘ï¼Œè€Œä¸æ˜¯å†…å­˜çš„ç®¡ç†ã€‚\nå°ç»“ åœ¨æœ¬ç« ä¸­ï¼Œç¬”è€…åˆ†æäº†Rustçš„å†…å­˜ç®¡ç†æ–¹æ¡ˆï¼Œæ—¢ç„¶èƒ½å¤Ÿé€šè¿‡ç¼–è¯‘å™¨è¿›è¡Œçº¦æŸï¼Œé‚£ä¹ˆæ— éå°±æ˜¯å®šä¹‰ä¸€äº›è§„åˆ™ï¼Œç„¶åæŒ‰ç…§è§„åˆ™å»è¿›è¡Œæ£€æŸ¥ï¼Œè€Œè¿™äº›è§„åˆ™å¯¹äºå…¶ä»–égcçš„è¯­è¨€åŒæ ·æ˜¯é€‚ç”¨çš„ï¼š\nå¯¹äºä½œç”¨åŸŸå†…ç”¨å®Œå³é”€æ¯çš„ï¼šrustä½¿ç”¨RAIIï¼Œå½“ç¦»å¼€å˜é‡ä½œç”¨åŸŸï¼Œç»“æŸç”Ÿå‘½å‘¨æœŸæ—¶ï¼Œå¯¹äºå †ä¸Šçš„æ•°æ®åŒæ ·è¿›è¡Œå›æ”¶ï¼Œä»è€Œé¿å…äº†æ‰‹åŠ¨è¿›è¡Œdelete å¯¹äºéœ€è¦ä¼ é€’å‡ºä½œç”¨åŸŸçš„ï¼šrustå®šä¹‰äº†æ‰€æœ‰æƒçš„æ¦‚å¿µï¼Œå¦‚æœéœ€è¦äº¤ç»™ä½œç”¨åŸŸå¤–å»ç»§ç»­ä½¿ç”¨ï¼Œé‚£ä¹ˆå°±éœ€è¦ç§»äº¤æ‰€æœ‰æƒï¼Œå°†å †ä¸Šçš„æ•°æ®è½¬ç§»ç»™å¦å¤–ä¸€ä¸ªå˜é‡è´Ÿè´£ï¼Œä»è€Œä¿è¯ä¸ä¼šå¯¹è¯¥æ•°æ®ä¸¢å¤±ç®¡ç†ï¼Œåç»­å†æŒ‰ç…§å…¶ä»–æ–¹æ³•ç»§ç»­æŒæœ‰æˆ–è€…gc å¯¹äºä¸´æ—¶å€Ÿç”¨çš„å¼•ç”¨ï¼šrustå¯¹å¼•ç”¨æ ‡æ³¨ç”Ÿå‘½å‘¨æœŸï¼Œè¢«å¼•ç”¨è€…çš„ç”Ÿå‘½å‘¨æœŸè‡³å°‘è¦å’Œå¼•ç”¨è€…ä¸€æ ·é•¿ï¼Œè¿™æ ·æ‰ä¸ä¼šå†å¼•ç”¨è€…ä½¿ç”¨æ—¶å·²ç»é‡Šæ”¾æ‰ï¼Œäº§ç”Ÿå‚æ‚¬å¼•ç”¨ã€‚ å¯¹äºå±€éƒ¨å˜é‡ï¼Œæ— è®ºæ˜¯åœ¨æ ˆä¸Šè¿˜æ˜¯å †ä¸Šï¼Œç”±äºç”Ÿå‘½å‘¨æœŸä¼šéšä½œç”¨åŸŸè€Œç»“æŸï¼Œå› æ­¤ç¼–è¯‘å™¨ç›´æ¥æ‹’ç»å¯¹å¤–ä¼ é€’å¼•ç”¨ å¦‚æœæƒ³è¦åœ¨å¤šä¸ªæ‰€æœ‰è€…ä¹‹é—´å…±äº«æ•°æ®ï¼Œé‚£ä¹ˆå°±é€šè¿‡å¼•ç”¨è®¡æ•°çš„æ–¹å¼æ¥å®Œæˆå…±äº« å¯¹äºæ•°æ®ç«äº‰ï¼šå•çº¿ç¨‹çš„æ•°æ®ç«äº‰ï¼Œrusté€šè¿‡ä¸€ä¸ªr-wå†²çªæ¥çº¦æŸï¼Œå³å…è®¸åŒä¸€ä½œç”¨åŸŸå†…å­˜åœ¨å¤šä¸ªä¸å¯å˜å¼•ç”¨æˆ–è€…å•ä¸€å¯å˜å¼•ç”¨ï¼Œä¿è¯äº†è·å–åˆ°çš„ä¸å¯å˜å¼•ç”¨åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­ä¸€å®šæ˜¯ä¸å¯å˜çš„ã€‚è€Œå¯¹äºå¤šçº¿ç¨‹ç¯å¢ƒï¼Œåˆ™ä½¿ç”¨Mutexå¼ºåˆ¶çº¦æŸï¼Œä¸ä½¿ç”¨åˆ™æ— æ³•é€šè¿‡ç¼–è¯‘ï¼Œä»è€Œä¿è¯äº†åœ¨å¼•ç”¨æ—¶çš„ç‹¬å æ€§å’Œä¸å¯å˜æ€§ã€‚ å¾ªç¯å¼•ç”¨ï¼šå’Œ c++ç›¸åŒï¼Œå¯ä»¥ä½¿ç”¨ weak_ptr æ¥å¤„ç†ã€‚ å…¶å®è¿™äº›è§„åˆ™éƒ½æ˜¯ä¸€äº›ä¸æˆæ–‡ä¹ƒè‡³æˆæ–‡çš„è§„å®šï¼Œåœ¨modern c++å½“ä¸­éƒ¨åˆ†è§„åˆ™ä¹Ÿæ—©å°±æ”¯æŒï¼Œæ¯”å¦‚RAIIã€æ™ºèƒ½æŒ‡é’ˆã€‚ä½†æ˜¯å…¶ä»–çš„ä¾æ—§ä¼šç»™ç¨‹åºå‘˜å¸¦æ¥è¾ƒå¤§çš„å¿ƒæ™ºè´Ÿæ‹…ï¼Œå¦‚æœä¸å»è®¤çœŸéµå¾ªï¼Œå°±ä¼šåœ¨è¿è¡ŒæœŸäº§ç”Ÿéš¾ä»¥æ£€æµ‹çš„bugï¼Œrusté€šè¿‡ç¼–è¯‘å™¨å¼ºåˆ¶çº¦æŸï¼Œå°†å¤§å¤šæ•°é—®é¢˜é™åˆ¶åœ¨ç¼–è¯‘å™¨ï¼Œä¸€æ—¦é€šè¿‡ç¼–è¯‘ï¼Œå°±å¯ä»¥ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘ï¼Œä»è€Œæå¤§çš„é™ä½ç¨‹åºå‘˜çš„å¿ƒæ™ºè´Ÿæ‹…ã€‚\nc++å’Œrustä¹‹é—´ä¹Ÿå¹¶ä¸æ˜¯ä»€ä¹ˆå¯¹ç«‹å…³ç³»ï¼Œä¼˜ç§€çš„c++ç¨‹åºå‘˜æ¥å—èµ·æ¥rustæ²¡æœ‰ä»€ä¹ˆéš¾åº¦ï¼Œåè¿‡æ¥ï¼Œå­¦ä¹ rustä¹Ÿæœ‰åŠ©äºå†™å‡ºæ›´é«˜è´¨é‡çš„c++ã€‚\n","permalink":"https://fischer0522.github.io/en/posts/tech/%E6%89%80%E6%9C%89%E6%9D%83%E4%B8%8E%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/","summary":"ç›¸æ¯”äºä¼ ç»Ÿc++å½“ä¸­çš„æ‰‹åŠ¨ç®¡ç†å†…å­˜ï¼Œrusté‡‡ç”¨äº†æ‰€æœ‰æƒ + RAIIçš„æœºåˆ¶ï¼Œå¯¹äºä¸€äº›å¤æ‚çš„æƒ…å†µï¼Œrustè¿˜æœ‰ç”Ÿå‘½å‘¨æœŸç­‰çº¦æŸï¼Œä»è€Œä¿è¯åœ¨ç¼–è¯‘æœŸèƒ½","title":"Rustå†…å­˜ç®¡ç†"},{"content":"ç‰©ç†å­˜å‚¨ç³»ç»Ÿ è¿™ä¸€éƒ¨åˆ†é‡ç‚¹å¹¶ä¸å¤šï¼Œä¸»è¦æ˜¯å„ç§å­˜å‚¨ç±»å‹ä¸Šçš„å·®å¼‚ï¼Œæ¯”è¾ƒäº†å‡ ç§ç‰©ç†å­˜å‚¨ä¸Šçš„å·®å¼‚ï¼Œä»¥åŠSSDï¼ŒHDD ä¹‹é—´çš„å·®å¼‚ï¼Œæœ€ååˆä»‹ç»äº†RAIDçš„æ€æƒ³ä»¥åŠRAIDåˆ†å±‚ï¼Œæ€»ç»“å‡ ä¸ªé—®é¢˜\nè¯´ä¸€ä¸‹å¸¸è§ç‰©ç†å­˜å‚¨ä»‹è´¨ï¼Ÿ é«˜é€Ÿç¼“å­˜ï¼ˆcacheï¼‰ï¼Œé€šå¸¸æŒ‡CPUçš„cacheï¼Œå¤„äºé€Ÿåº¦æœ€é«˜ä½†æ˜¯æœ€æ˜‚è´µçš„çº§åˆ«ï¼Œåœ¨æ•°æ®åº“å½“ä¸­ï¼Œé€šå¸¸ä¸éœ€è¦æˆ‘ä»¬æ¥è¿›è¡Œæ‰‹åŠ¨ç®¡ç† ä¸»å­˜ï¼Œå³é€šå¸¸æ‰€è¯´çš„å†…å­˜ï¼Œåœ¨æ•°æ®åº“å½“ä¸­é€šå¸¸ä½œä¸ºç¼“å­˜ä½¿ç”¨ï¼Œé€šè¿‡æ„å»ºbufferpool manageræ¥è¿›è¡Œç®¡ç†ã€‚è‡³æ­¤ä»ä¸ºæ˜“å¤±çš„(volatile) é—ªå­˜ï¼šæ—©äº›å¹´ç”¨äºUç›˜ç­‰å­˜å‚¨ä»‹è´¨å½“ä¸­ï¼Œç›®å‰çš„SSDä¹ŸåŸºäºé—ªå­˜ï¼Œç”¨é€”ä¸ç£ç›˜ï¼ˆHDDï¼‰åŒæ•ˆï¼Œå¯ä»¥ä¿æŒéæ˜“å¤±(non-volatile)ï¼Œä½†æ˜¯åœ¨è®¿é—®é€Ÿåº¦ä¸Šä¼šé¢†å…ˆHDDå¾ˆå¤š ç£ç›˜ï¼šæœ€ä¼ ç»Ÿçš„éæ˜“å¤±å­˜å‚¨ä»‹è´¨ï¼Œé€šè¿‡ç‰©ç†çš„æ–¹å¼è¿›è¡Œå­˜å‚¨ï¼Œå› æ­¤åœ¨é€Ÿåº¦ä¸Šå—é™äºç‰©ç†é€Ÿåº¦ï¼Œå³disk armçš„ç§»åŠ¨é€Ÿåº¦ã€‚è´­ä¹°ç£ç›˜æ—¶ä¹Ÿä¼šè¯´æ˜disk armçš„è½¬é€Ÿ ç£ç›˜çš„ç‰©ç†ç‰¹æ€§ ç£ç›˜åœ¨å‚ç›´ä¸Šç”±å¤šä¸ªæ‰‡ç‰‡ç»„æˆï¼Œå»¶ä¸­å¿ƒï¼Œæ¯ä¸€åœˆå¯ç§°ä¸ºä¸€ä¸ªç£é“ï¼Œåœ¨ä¸€ä¸ªç£é“ä¸Šï¼Œæœ‰ä¸ªæ°›å›´å¤šä¸ªæ‰‡åŒºï¼Œæ‰‡åŒºå³ä¸ºç£ç›˜å†™å…¥å’Œè¯»å–çš„æœ€æ—©å•ä½ã€‚ è¯»å–å’Œå†™å…¥çš„è¿‡ç¨‹æä¸ºdisk armè½¬åŠ¨æ‰¾åˆ°å¯¹åº”çš„ä½ç½®ï¼Œå†é€šè¿‡ç£å¤´è¿›è¡Œå†™å…¥ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­æ¶‰åŠåˆ°äº†ç‰©ç†è¿åŠ¨ï¼Œå› æ­¤é€Ÿåº¦è¾ƒæ…¢ã€‚\nRAID RAID(Redundant Array of Independent Disk) ç‹¬ç«‹ç£ç›˜å†—ä½™é˜µåˆ—ï¼Œä¸»è¦æ€æƒ³ä¸ºå°†æ•°æ®å­˜å‚¨åœ¨ä¸åŒçš„ç¡¬ç›˜ä¸Šï¼Œä¸»è¦å¯ä»¥å¸¦æ¥ä¸¤ç‚¹å¥½å¤„ï¼š\né€šè¿‡å†—ä½™æé«˜å¯é æ€§ï¼šå³å°†åŒä¸€ä»½æ•°æ®ä»¥pageæˆ–è€…è‡ªå®šçš„å—å¤§å°æ¥å­˜å‚¨åœ¨ä¸åŒçš„ç£ç›˜ä¹‹ä¸Šï¼Œå¦‚æœå…¶ä¸­çš„ä¸€ä¸ªç£ç›˜æŸåï¼Œè¿˜å¯ä»¥åˆ‡æ¢åˆ°å¤‡ä»½ç£ç›˜ä¸Šï¼Œä»è€Œä¿è¯èƒ½å¤Ÿæä¾›æ­£å¸¸æœåŠ¡ï¼Œåªæœ‰åœ¨ç¬¬ä¸€ä»½ç£ç›˜è¢«ä¿®å¤å‰ï¼Œå¤‡ä»½å…¨éƒ¨æŒ‚æ‰æ—¶ï¼Œæ‰ä¼šçœŸæ­£çš„æ•°æ®ä¸¢å¤±ã€‚ é€šè¿‡å¹¶è¡Œæé«˜æ€§èƒ½ï¼šé€šè¿‡ç£ç›˜é•œåƒï¼Œå¯ä»¥æé«˜è¯»å–çš„é€Ÿåº¦ï¼Œç”±äºæ‰€æœ‰çš„å¤‡ä»½å…¨éƒ¨ä¸ºä¸€è‡´çš„ï¼Œå› æ­¤è¯»è¯·æ±‚å¯ä»¥å‘é€åˆ°ä»»æ„ä¸€ä¸ªç£ç›˜ä¸Šï¼Œä»è€Œå½¢æˆè´Ÿè½½å‡è¡¡æˆ–è€…å‡å°‘å•ä¸€ç£ç›˜çš„å‹åŠ›ã€‚æ­¤å¤–ï¼Œè¿˜ä¸€åˆ»é€šè¿‡è·¨å¤šå¼ ç£ç›˜çš„æ–¹å¼è¿›è¡Œæ•°æ®æ‹†åˆ†ï¼Œä»è€Œæé«˜æ•°æ®ä¼ è¾“ç‡ï¼š æ¯”ç‰¹çº§æ‹†åˆ†(bit-level striping) :è¾ƒä¸ºç®€å•æˆ–è€…å¸¸è§çš„æ•°æ®æ‹†åˆ†æ–¹å¼ä¸ºå¯¹ä¸€ä¸ªå­—èŠ‚è¿›è¡Œæ‹†åˆ†ï¼Œå°†ä¸€ä¸ªå­—èŠ‚æŒ‰ç…§8bitè¿›è¡Œæ‹†åˆ†ï¼Œå¦‚å¦‚æœæœ‰ä¸€ä¸ªå…«å¼ ç£ç›˜ç»„æˆçš„é˜µåˆ—ï¼Œå°†æ¯ä¸ªå­—èŠ‚çš„ç¬¬iä½å†™åˆ°ç¬¬iå¼ ç£ç›˜ä¸Šã€‚ å—çº§æ‹†åˆ†(block-level striping) :å°†ç£ç›˜é˜µåˆ—æ˜¯ä¸ºä¸€ä¸ªå®Œæ•´çš„å¤§ç£ç›˜ï¼ŒæŒ‰ç…§ä¸€ä¸ªå®Œæ•´ç£ç›˜æ¥å¯¹å„ä¸ªå—è¿›è¡Œç¼–å·ï¼Œä¹‹åæ ¹æ®ç¼–å·å–æ¨¡äºç£ç›˜æ•°å¾—åˆ°è¯¥å—å­˜æ”¾çš„ä½ç½® RAIDçº§åˆ« é•œåƒæä¾›äº†é«˜å¯é æ€§ï¼Œä½†æ˜¯å¾ˆæ˜‚è´µã€‚æ‹†åˆ†æä¾›äº†é«˜æ•°æ®ä¼ è¾“ç‡ï¼Œä½†æ˜¯å¹¶æœªæé«˜å¯é æ€§ã€‚æˆ‘ä»¬ç³»ç»Ÿé€šè¿‡è¾ƒä½çš„ä¸€ä¸ªæˆæœ¬æ¥è·å–å¯é æ€§å¹¶æé«˜æ€§èƒ½ï¼Œè¿™ä¹‹é—´å°±æ¶‰åŠåˆ°äº†ä¸€äº›ç›¸å…³çš„trade offï¼Œä»è€ŒRAIDäº§ç”Ÿäº†å„ä¸ªçº§åˆ«ï¼š\nRAID 0:æœ‰å—æ‹†åˆ†ä½†æ˜¯æ²¡æœ‰ä»»ä½•å†—ä½™ï¼Œå¯ä»¥æé«˜æ•°æ®ä¼ è¾“ç‡ä½†æ˜¯æ— æ³•æé«˜å¯é æ€§ RAID 1:æä¾›å†—ä½™ï¼Œæœ‰å—çº§åˆ«æ‹†åˆ†çš„ç£ç›˜é•œåƒ RAID 5:å…·æœ‰äº¤å‰åˆ†å¸ƒçš„å¥‡å¶æ ¡éªŒï¼Œå¯¹äºN + 1ä¸ªç£ç›˜ï¼Œå…¶ä¸­ä¸€ä¸ªç£ç›˜å­˜å‚¨å¥‡å¶æ ¡éªŒï¼Œå¦å¤–Nå¼ ç£ç›˜å­˜å‚¨è¿™äº›å— RAID 6:P+Qçš„å†—ä½™æ–¹æ¡ˆï¼Œåœ¨RAID5ç‚¹åŸºç¡€ä¸Šå­˜å‚¨äº†é¢å¤–çš„å†—ä½™ä¿¡æ¯ RAID 234å‡ä¸å†ä½¿ç”¨ RAID1æä¾›äº†æœ€ä½³çš„å†™å…¥æ€§èƒ½ï¼Œé€šå¸¸ç”¨äºæ•°æ®åº“ç³»ç»Ÿçš„æ—¥å¿—æ–‡ä»¶å½“ä¸­ã€‚RAID5å…·æœ‰æ¯”RAID1æ›´ä½çš„å­˜å‚¨å¼€é”€ï¼Œä½†æ˜¯å…·æœ‰æ›´é«˜çš„å†™å…¥æ—¶é—´é€šå¸¸ç”¨äºå†™å…¥è¾ƒå°‘çš„ç³»ç»Ÿå½“ä¸­ ç”µæ¢¯ç®—æ³• ç”µæ¢¯ç®—æ³•é€šå¸¸åº”ç”¨äºç£ç›˜è‡‚çš„è°ƒåº¦å½“ä¸­ï¼Œå·¥ä½œæ–¹å¼ä¸ç”µæ¢¯çš„å·¥ä½œæ–¹å¼ç›¸åŒï¼Œå‡è®¾ä¸€å¼€å§‹ï¼Œç£ç›˜è‡‚ä»æœ€å†…ä¾§çš„ç£é“å‘ç£ç›˜çš„å¤–ä¾§ç§»åŠ¨ï¼Œåœ¨ç”µæ¢¯ç®—æ³•çš„æ§åˆ¶ä¸‹ï¼Œå¯¹æ¯æ¡æœ‰è®¿é—®è¯·æ±‚çš„ç£é“ï¼Œç£ç›˜è‡‚éƒ½ä¼šåœ¨é‚£æ¡ç£é“åœä¸‹æ¥ä¸ºè¯·æ±‚æä¾›æœåŠ¡ï¼Œä¹‹åç»§ç»­å‘å¤–ç§»åŠ¨ï¼ŒçŸ¥é“æ²¡æœ‰å¯¹æ›´å¤–ä¾§ç£é“çš„è¯·æ±‚ï¼Œä¹‹åå†è°ƒè½¬æ–¹å‘å‘å†…ä¾§ç§»åŠ¨ï¼ŒæŒ‰ç…§åŒæ ·çš„æ€è·¯è¿›è¡Œï¼ŒçŸ¥é“å¯¼å¸ˆæ²¡æœ‰æ›´é è¿‘ä¸­å¿ƒçš„æœ‰è¯·æ±‚çš„ç£é“ï¼Œä¹‹åè°ƒè½¬æ–¹å‘å¼€å§‹ä¸€ä¸ªæ–°çš„å‘¨æœŸ\næ•°æ®å­˜å‚¨ç»“æ„ ä¸Šä¸€ç« æ‰€è®¨è®ºçš„æ˜¯ç”¨äºå­˜å‚¨çš„ç‰©ç†ä»‹è´¨ï¼Œè€Œåœ¨æ­¤ä¹‹ä¸Šï¼Œé€šå¸¸æœ‰æ“ä½œç³»ç»Ÿæ¥è¿›è¡Œè¿›ä¸€æ­¥çš„æŠ½è±¡ï¼Œå¯¹ä¸Šå±‚æä¾›ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œè€Œæ•°æ®åº“å³æ˜¯åœ¨è¯¥æ–‡ä»¶ç³»ç»Ÿä¹‹ä¸Šæ¥å®Œæˆæ•°æ®çš„å­˜å‚¨ã€‚è¿™ä¸€ç« æ‰€è®¨è®ºçš„å°±æ˜¯å¦‚ä½•å°†æ•°æ®ç»„ç»‡å®‰æ”¾åˆ°æ–‡ä»¶å½“ä¸­ã€‚\næ–‡ä»¶ç»„ç»‡ æ•°æ®åº“ä½¿ç”¨æ“ä½œç³»ç»Ÿæ‰€æä¾›çš„æ–‡ä»¶ç³»ç»Ÿè¿›è¡Œå­˜å‚¨ï¼Œæ“ä½œç³»ç»Ÿçš„æ–‡ä»¶åœ¨é€»è¾‘ä¸Šè¿›è¡Œåˆ’åˆ†ï¼Œé€šå¸¸å¯ä»¥åˆ’åˆ†ä¸º4KB-8KBçš„pageä¸ºå•ä½ï¼Œæ•°æ®åº“å¯ä»¥é»˜è®¤ä½¿ç”¨æ“ä½œç³»ç»Ÿçš„pageå¤§å°ï¼Œä¹Ÿå¯ä»¥è‡ªå®šä¹‰pageå¤§å°ï¼Œä¹‹åæ ¹æ®pageå¤§å°è¿›è¡Œè®¿é—®å’Œè¯»å–ï¼Œä¸€æ¬¡æ€§åŠ è½½ä¸€ä¸ªpageåˆ°å†…å­˜å½“ä¸­è¿›è¡Œè¯»å†™æ“ä½œã€‚ é¦–å…ˆå‡å®šæ²¡æœ‰æ¯”å—æ›´å¤§çš„è®°å½•ï¼Œä¹‹åä¸€æ¡è®°å½•ä¸ä¼šè·¨page\nå®šé•¿è®°å½•çš„å­˜å‚¨ å¯¹äºå®šé•¿è®°å½•ï¼Œå½“ç¡®å®šé•¿åº¦ä¹‹åï¼Œæ¯æ¡é•¿åº¦åˆ†é…åˆé€‚çš„ç©ºé—´ï¼Œä¹‹åä»å‰å‘åæ’åˆ—å³å¯ï¼Œå­˜å‚¨æ—¶ä¸éœ€è¦åœ¨æ„é¡ºåºï¼Œå› æ­¤åœ¨åˆ é™¤æ—¶é€‰æ‹©å°†æœ€åä¸€æ¡æ•°æ®ç§»åŠ¨åˆ°å½“å‰åˆ é™¤çš„ä½ç½®ï¼Œä¹‹åæ‹†å…¥å†ä»åæ’å…¥å³å¯ã€‚å¦å¤–ä¸€ç§è§£å†³æ–¹æ¡ˆä¸ºè®¾ç½®ä¸€ä¸ªheaderï¼Œé€šè¿‡free listçš„å½¢å¼ç®¡ç†æ‰€æœ‰çš„è¢«åˆ é™¤çš„æ•°æ®çš„ç©ºç™½ç©ºé—´ï¼Œä¹‹åå³å¯æ’å…¥æ—¶å…ˆé€šè¿‡free listè¿›è¡Œè·å–\nå˜é•¿è®°å½•çš„å­˜å‚¨ æ€è·¯åŸºæœ¬ä¸€è‡´ï¼Œåªä¸è¿‡å¯¹äºä¸€æ¡è®°å½•ï¼Œéœ€è¦åˆ›å»ºä¸€ä¸ªEntryï¼ŒEntryçš„å‰å‡ ä¸ªå…ƒç´ ç”¨äºå­˜å‚¨åé¢æ¯ä¸€ä¸ªå±æ€§çš„é•¿åº¦ï¼Œä¹‹åè·Ÿéšè®°å½•å½“ä¸­å®šé•¿çš„å±æ€§ï¼Œæœ€åæ”¾ç½®å˜é•¿å±æ€§ï¼Œåœ¨æ•´ä½“å­˜å‚¨ä¸Šé‡‡ç”¨headeræ¥è¡¨ç¤ºå…·ä½“ä½ç½®ï¼Œæ–°çš„è®°å½•ä»pageçš„åé¢åˆ›å»ºï¼Œheaderä¸è®°å½•ä¹‹é—´çš„åŒºåŸŸä¸ºè‡ªç”±ç©ºé—´ã€‚\næ–‡ä»¶ç»„ç»‡ å †æ–‡ä»¶ç»„ç»‡ï¼š è®°å½•å¯ä»¥å­˜å‚¨åœ¨å¯¹åº”ä¸€ä¸ªå…³ç³»çš„æ–‡ä»¶ä¸­çš„ä»»ä½•ä½ç½®ï¼Œé€šå¸¸ä¸€æ—¦ç¡®å®šä½ç½®ï¼Œä¹‹åå°±ä¸ä¼šå†ç§»åŠ¨ã€‚å¯¹äºå †æ–‡ä»¶(HeapFile)æ¥è¯´ï¼Œä¸€ä¸ªHeapFileé€šå¸¸ç”±å¤šä¸ªHeapPageç»„æˆï¼Œå †æ–‡ä»¶éœ€è¦é€šè¿‡ä¸€ä¸ªè‡ªç”±ç©ºé—´å›¾(free space map)æ¥æ ‡è¯†å„ä¸ªHeapPageå½“ä¸­çš„å‰©ä½™ç©ºé—´ï¼Œé€šå¸¸æ˜¯ä»¥æ¯”ä¾‹çš„å½¢å¼å­˜åœ¨ï¼Œä¹‹åéœ€è¦æ·»åŠ æ–°çš„è®°å½•æ—¶ï¼Œåªéœ€è¦é€šè¿‡éå†free-space mapå³å¯æ‰¾åˆ°å¯¹åº”çš„ç©ºç™½ä½ç½®ã€‚å°†æ•°æ®å†™å…¥åˆ°å¯¹åº”çš„HeapPageå½“ä¸­ã€‚è€Œå½“heapPageè¿‡å¤šæ—¶ï¼Œå¯ä»¥è€ƒè™‘å»ºç«‹äºŒçº§ç´¢å¼•æ¥æé«˜æ•ˆç‡ã€‚ å¤šè¡¨èšç°‡ç»„ç»‡ ï¼š å¯¹äºæŸäº›å¸¸ç”¨çš„joinè¯­å¥ï¼Œå¯ä»¥è€ƒè™‘å°†joinçš„ä¸¤å¼ è¡¨è¿›è¡Œè”åˆå­˜å‚¨ï¼Œå¯ä»¥åŠ å¿«ç‰¹å®šçš„joinæŸ¥è¯¢é€Ÿåº¦ï¼Œä½†æ˜¯å¸¦æ¥çš„é—®é¢˜å°±æ˜¯å¯¹äºå•è¡¨æŸ¥è¯¢éœ€è¦æŸ¥è¯¢é¢å¤–çš„å­—æ®µ é¡ºåºæ–‡ä»¶ç»„ç»‡ ï¼š åœ¨æ–‡ä»¶å½“ä¸­ï¼Œæ ¹æ®æŸä¸ªå±æ€§å»ç»´æŠ¤é¡ºåºå­˜å‚¨ï¼Œå¯ä»¥æœ‰åˆ©äºæŸäº›ä¾èµ–äºé¡ºåºçš„æŸ¥è¯¢æ“ä½œï¼Œä½†æ˜¯æ’å…¥æ—¶çš„ä»£ä»·è¾ƒé«˜ï¼Œéœ€è¦è¿›è¡Œæ•´ä½“ç§»åŠ¨ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªpageå½“ä¸­é‡‡ç”¨é¡ºåºç»„ç»‡ï¼Œè€Œå„ä¸ªpageä¹‹é—´é€šè¿‡B+ Treeçš„å½¢å¼è¿›è¡Œç»„ç»‡ï¼Œå¯ä»¥å‡å°‘å¼€é”€ã€‚\nç¼“å†²æ± æ›¿æ¢ç­–ç•¥ å¯¹äºæ“ä½œç³»ç»Ÿï¼Œæ“ä½œç³»ç»Ÿæ— æ³•é¢„çŸ¥æœªæ¥çš„pageçš„è®¿é—®æƒ…å†µï¼Œå› æ­¤æ“ä½œç³»ç»Ÿæ ¹æ®å±€éƒ¨æ€§åŸç†ä½¿ç”¨LRUè¿›è¡Œpageçš„ç¼“å†²æ§åˆ¶ã€‚ ä½†æ˜¯æ•°æ®åº“èƒ½å¤Ÿæ¯”æ“ä½œç³»ç»Ÿæ›´å‡†ç¡®çš„é¢„æµ‹æœªæ¥çš„è®¿é—®æ–¹å¼ï¼Œé€šè¿‡æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’å³å¯å¾—çŸ¥ä¹‹åéœ€è¦ç”¨åˆ°å“ªäº›pageï¼Œå¯ä»¥é’ˆå¯¹è®¡åˆ’è¿›è¡Œè®¾è®¡ï¼š\n1 2 select * from instructor natural join department; å¯¹äºä¸Šè¿°çš„sqlï¼Œåœ¨ä½¿ç”¨å®Œä¸€æ¡è®°å½•ä¹‹ååé¢åˆ™ä¸ä¼šå†ç”¨åˆ°ï¼Œ å› æ­¤å¯ä»¥è®¾è®¡æœ€è¿‘æœ€å¸¸ä½¿ç”¨(Most Recently Usedï¼ŒMRU)ï¼Œä½¿ç”¨å®Œç«‹åˆ»æ·˜æ±°ï¼Œä¸LRUåˆšå¥½ç›¸åã€‚\näº‹åŠ¡ äº‹åŠ¡çš„å››å¤§ç‰¹æ€§ äº‹åŠ¡çš„å››å¤§ç‰¹æ€§åˆ†åˆ«ä¸ºåŸå­æ€§ã€ä¸€è‡´æ€§ã€éš”ç¦»æ€§ä¸æŒä¹…æ€§ å¯¹äºåŸå­æ€§ï¼Œåˆ™äº‹åŠ¡æœ¬èº«ä½œä¸ºä¸€ä¸ªæ•´ä½“ï¼Œè¦ä¹ˆå…¨éƒ¨æˆåŠŸæ‰§è¡Œï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥å›æ»šï¼Œä¸å­˜åœ¨æ‰§è¡ŒæˆåŠŸä¸€åŠçš„ä¸­é—´æ€ã€‚ ä¸€è‡´æ€§è¡¨æ˜æ•°æ®åº“åœ¨äº‹åŠ¡æ‰§è¡Œå‰å’Œæ‰§è¡Œåï¼Œæ•°æ®åº“çš„çŠ¶æ€å¿…é¡»æ»¡è¶³é¢„å®šçš„ä¸€è‡´æ€§è§„åˆ™ï¼Œå³æ•°æ®åº“åªèƒ½ä»ä¸€ç§çŠ¶æ€è½¬æ¢ä¸ºå¦å¤–ä¸€ç§ä¸€è‡´æ€§çŠ¶æ€ï¼Œæœ€ç®€å•çš„ä¾‹å­å³ä¸ºé“¶è¡Œè½¬è´¦ï¼Œåªæœ‰è½¬è´¦å‰ä¸è½¬è´¦åçš„ä¸¤ç§ä¸€è‡´æ€§çŠ¶æ€ï¼Œä¸å­˜åœ¨ä¸€äººè½¬å‡ºè€Œå¦ä¸€äººæœªæ”¶åˆ°çš„ä¸­é—´çŠ¶æ€ã€‚æ­¤å¤–ä¸€è‡´æ€§åˆ†ä¸ºæ•°æ®åº“ä¸€è‡´æ€§å’Œäº‹åŠ¡ä¸€è‡´æ€§ï¼Œæ•°æ®åº“åªä¿è¯æ•°æ®åº“ä¸€è‡´æ€§ï¼Œå°±åƒä¸Šé¢æ‰€è¯´çš„é‚£æ ·ï¼Œè€Œäº‹åŠ¡ä¸€è‡´æ€§åˆ™æ›´æ˜¯ä¸€ç§é€»è¾‘å…³ç³»ï¼Œéœ€è¦æ“ä½œäººå‘˜å»æ‰‹åŠ¨çº¦æŸ æ­¤å¤– æ•°æ®åº“çš„ä¸€è‡´æ€§åº”å½“ä¸åˆ†å¸ƒå¼ç³»ç»Ÿå½“ä¸­çš„ä¸€è‡´æ€§çš„æ¦‚å¿µç›¸åŒºåˆ†ï¼Œåˆ†å¸ƒå¼å½“ä¸­çš„ä¸€è‡´æ€§æŒ‡çš„æ˜¯åœ¨å¤šä¸ªèŠ‚ç‚¹ä¸Šæ•°æ®ä¿æŒä¸€è‡´çš„çŠ¶æ€ï¼Œæ¯”å¦‚å…¶ä¸­æœ€ä¸¥æ ¼çš„çº¿æ€§ä¸€è‡´æ€§å°±è¦æ±‚å¯¹å¤–éœ€è¦è¡¨ç°æˆå•æœºèŠ‚ç‚¹ï¼Œå¦‚æœä¸€æ¬¡å†™å…¥å®Œæˆé‚£ä¹ˆåç»­å°±ä¸€å®šè¦èƒ½å¤Ÿè¯»å–åˆ°æ•°æ® éš”ç¦»å‹ï¼šå¹¶å‘æ‰§è¡Œçš„å¤šä¸ªäº‹åŠ¡ä¹‹é—´åº”å½“éš”ç¦»ï¼Œä½¿æ¯ä¸ªäº‹åŠ¡æ„Ÿè§‰åœ¨ç‹¬ç«‹çš„æ“ä½œæ•°æ®åº“ï¼Œé˜²æ­¢äº‹åŠ¡ä¹‹é—´çš„ç›¸äº’å¹²æ‰°ä¸æ•°æ®æ±¡æŸ“ æŒä¹…æ€§ï¼šæŒä¹…æ€§è¡¨æ˜ä¸€æ—¦äº‹åŠ¡æäº¤ï¼Œé‚£ä¹ˆå…¶åšå‡ºçš„æ›´æ”¹åº”å½“ä¸ºæ°¸ä¹…æ€§çš„\nä¸è¿‡ä¸ªäººè®¤ä¸ºè¿™å››è€…ä¸æ˜¯ç®€å•çš„å¹³çº§æˆ–è€…ç‹¬ç«‹çš„å…³ç³»ï¼Œå…¶ä¸­ï¼Œä¸€è‡´æ€§éœ€è¦åŸå­æ€§å’Œéš”ç¦»å‹çš„æ”¯æŒï¼Œç³»ç»Ÿå¦‚æœæ— æ³•ä¿è¯æ‰€æœ‰å‘½ä»¤å…¨éƒ¨æˆåŠŸæˆ–è€…å…¨éƒ¨å¤±è´¥çš„è¯ï¼Œè‡ªç„¶ä¼šå‡ºç°åªæ‰§è¡Œäº†ä¸€åŠå‘½ä»¤çš„ä¸­é—´æ€ï¼Œè€Œå¦‚æœæ— æ³•ä¿è¯éš”ç¦»æ€§çš„è¯ï¼Œä¸€ä¸ªäº‹åŠ¡è¿˜æœªæäº¤çš„å˜æ›´å°±èƒ½è¢«å…¶ä»–çš„äº‹åŠ¡è¯»å–åˆ°ï¼Œé‚£ä¹ˆåŒæ ·æ— æ³•ä¿è¯ä¸€è‡´æ€§ï¼ŒæŒä¹…æ€§å¯èƒ½ç›¸å¯¹çš„ç‹¬ç«‹ä¸€ç‚¹ï¼Œå’Œå…¶ä»–çš„ä¸¤ä¸ªæ²¡ä»€ä¹ˆå¤ªå¤§çš„è”ç³»\nå¯ä¸²è¡ŒåŒ– å¦‚æœèƒ½å¤Ÿä¿è¯ä¸€ä¸ªè°ƒåº¦ç­–ç•¥èƒ½å¤Ÿåœ¨ç»“æœä¸Šç­‰ä»·äºä¸²è¡ŒåŒ–è°ƒåº¦ï¼ˆå³æ²¡æœ‰ä»»ä½•å¹¶å‘ï¼‰ï¼Œé‚£ä¹ˆå°±ç§°ä¸ºè¯¥è°ƒåº¦ä¸ºå¯ä¸²è¡ŒåŒ–æˆ–è€…å†²çªå¯ä¸²è¡ŒåŒ–ã€‚è€Œå†²çªæŒ‡çš„æ˜¯è¯»å†™å†²çª åˆ¤æ–­å¯ä¸²è¡ŒåŒ–ä¸»è¦æœ‰ä¸¤ä¸ªæ–¹æ¡ˆï¼š\né€šè¿‡äº¤æ¢æŒ‡ä»¤è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœèƒ½å¤Ÿé€šè¿‡äº¤æ¢ä¸å†²çªçš„æŒ‡ä»¤æ¥å¾—åˆ°ä¸€ä¸ªä¸²è¡ŒåŒ–è°ƒåº¦ï¼Œé‚£ä¹ˆå°±ç§°ä¸ºå…¶ä¸ºå¯ä¸²è¡ŒåŒ–çš„ã€‚ é€šè¿‡æ„é€ æœ‰å‘å›¾çš„æ–¹å¼ï¼Œå³å¦‚æœT1,T2ä¹‹é—´æœ‰æŒ‡ä»¤å†²çªï¼Œé‚£ä¹ˆå°±æ„å»ºä¸€ä¸ªä»å…ˆæ‰§è¡Œçš„æŒ‡ä»¤çš„äº‹åŠ¡æŒ‡å‘åæ‰§è¡Œçš„æŒ‡ä»¤çš„äº‹åŠ¡ï¼Œè€Œå¦‚æœå‡ºç°äº†å›è·¯ï¼Œåˆ™è¯æ˜å…¶ä¸ºä¸å¯ä¸²è¡ŒåŒ–çš„ã€‚ è€Œå†²çªçš„ä¸€ç§è§£å†³æˆ–è€…ä¿æŠ¤æ–¹å¼å³ä¸ºé€šè¿‡åŠ é”æ¥å®ç°ï¼Œå¦‚æœåŠ é”é‡‡ç”¨åŒæ ·çš„è¯»å†™é”æ¨¡å‹+ä¸¤é˜¶æ®µé”åè®®çš„è¯ï¼Œé‚£ä¹ˆå†²çªä¸å¯ä¸²è¡ŒåŒ–å°±ä»£è¡¨ç€æ­»é”ï¼ŒåŒæ ·å¯ä»¥é€šè¿‡å¯»æ‰¾ç¯è·¯æ¥åˆ¤æ–­å’Œè§£å†³ã€‚ æ­¤å¤–éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå­˜åœ¨ä¸€ä¸ªè°ƒåº¦ä¸ä¸²è¡Œè°ƒåº¦åœ¨ç»“æœä¸Šç­‰ä»·ï¼Œä½†æ˜¯ä¸ºä¸å¯ä¸²è¡ŒåŒ–çš„ã€‚ å¯æ¢å¤è°ƒåº¦ä¸æ— çº§è”è°ƒåº¦ å¯æ¢å¤è°ƒåº¦æŒ‡çš„æ˜¯å¯ä»¥é€šè¿‡çº§è”ä¸­æ­¢çš„æ–¹å¼æ¥æ¢å¤è„è¯»å¯¹æ•°æ®åº“çš„å½±å“ã€‚è€ƒè™‘è¿™æ ·ä¸€ç§æƒ…å†µï¼ŒT1wtrieAä¹‹åT2è¿›è¡Œäº†readAï¼Œè€Œå¦‚æœT1è¿›è¡Œäº†å›æ»šå°±ä¼šå¯¼è‡´Aç§°ä¸ºè„æ•°æ®ï¼ŒT2è¿›è¡Œäº†è„è¯»ï¼Œè€Œæ­¤æ—¶å¦‚æœT2åœ¨T1ä¹‹åæ‰æäº¤å°±ä¸ºå¯æ¢å¤ï¼Œåä¹‹ä¸ºä¸å¯æ¢å¤ã€‚ è€Œæ¢å¤çš„æ–¹å¼å°±æ˜¯é€šè¿‡çº§è”ä¸­æ­¢çš„æ–¹å¼è¿›è¡Œæ¢å¤ï¼Œå³T1å›æ»šä¼šè¿åŒT2ä¸€åŒè¿›è¡Œå›æ»šã€‚ ä¸ºä¿è¯å¯æ¢å¤è°ƒåº¦ï¼Œå¯ä»¥é€šè¿‡æ ‡è®°ä¾èµ–çš„æ–¹å¼ï¼Œå³T2ä¾èµ–äºT1ï¼ŒT2ä¼šç­‰åˆ°T1commitä¹‹åå†è¿›è¡Œcommitï¼Œæˆ–è€…é€šè¿‡å¼ºä¸¤é˜¶æ®µé”çš„æ–¹å¼(ä¸€åŒè§£å†³å¯æ¢å¤æ€§å’Œæ— çº§è”) æ­£å¦‚ä¸Šé¢æ‰€è¯´ï¼Œå¦‚æœä¸æƒ³äº§ç”Ÿè„è¯»ï¼Œé‚£ä¹ˆT1çš„å›æ»šå°±ä¼šå¯¼è‡´T2çš„å›æ»šï¼Œè¿™ç§æƒ…å†µæˆä¸ºçº§è”å›æ»šï¼Œçº§è”å›æ»šåœ¨æ¶‰åŠåˆ°å¤§é‡äº‹åŠ¡æ—¶ä¼šäº§ç”Ÿç›¸å½“å¤§çš„å¼€é”€ï¼Œå› æ­¤å¸Œæœ›é¿å…çº§è”å›æ»šçš„å‘ç”Ÿï¼Œå¦‚æœä¸€ä¸ªè°ƒåº¦ä¸ä¼šäº§ç”Ÿçº§è”å›æ»šï¼Œé‚£ä¹ˆç§°ä¸ºæ— çº§è”è°ƒåº¦ï¼Œåœ¨å®ç°ä¸Šé€šå¸¸é‡‡ç”¨ä¸¤é˜¶æ®µé”çš„æ–¹å¼è¿›è¡Œ\näº‹åŠ¡çš„éš”ç¦»çº§åˆ« å››ç§éš”ç¦»çº§åˆ«çš„å·®åˆ«ä¸»è¦èšç„¦äºè¯»æ“ä½œä¸Šï¼Œå¯¹äºå†™æ“ä½œï¼Œä¸ºäº†ä¿è¯æ•°æ®åº“ä¸€è‡´æ€§ï¼Œåªæœ‰å†™å…¥çš„é”åªæœ‰æ•°æ®æäº¤æ—¶æ‰èƒ½å¤Ÿé‡Šæ”¾ï¼Œå¦‚æœä¸­é€”é‡Šæ”¾é”ï¼Œå†™å…¥çš„æ“ä½œç»“æœå¯èƒ½ä¼šè¢«å…¶ä»–çš„è¦†ç›–ï¼Œä»è€Œè¿åäº†æ•°æ®åº“ä¸€è‡´æ€§ã€‚å•ç‹¬çœ‹å†™é”çš„è¯ï¼Œéƒ½æ˜¯é‡‡ç”¨äº†ä¸¥æ ¼ä¸¤é˜¶æ®µé”çš„ç­–ç•¥ï¼Œä¿è¯ä¸€è‡´æ€§ï¼ŒåŒæ—¶é¿å…çº§è”ä¸­æ­¢ã€‚\nREAD UNCOMMITTED\næœ€å®½æ¾çš„éš”ç¦»çº§åˆ«ï¼Œæ ¹æ®ä¸Šè¡¨å¯ä»¥çœ‹åˆ°è„è¯» ä¸å¯é‡å¤è¯» å¹»è¯»éƒ½ä¼šå‘ç”Ÿ\nåœ¨å®ç°ä¸Šè¯»æ“ä½œä¸éœ€è¦åŠ é”ï¼Œå†™æ“ä½œå’Œå…¶ä»–çš„ä¸€è‡´ï¼Œå› æ­¤æ‰€æœ‰è¯»ç›¸å…³çš„é”éƒ½ä¸æ”¯æŒï¼Œå¦‚æœæƒ³å°è¯•åŠ [S,IS,SIX]ï¼Œéƒ½ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚ç”±äºåªæ”¯æŒå†™é”ï¼Œåœ¨shrinkingé˜¶æ®µï¼Œä»»ä½•åŠ é”æ“ä½œéƒ½æ˜¯ä¸å…è®¸çš„ï¼Œä¼šæŠ›å‡ºå¼‚å¸¸ã€‚\nå› æ­¤å¹¶ä¸ä¿è¯è¯»å–åˆ°çš„æ•°æ®ä¸€å®šæ˜¯æäº¤çš„æ•°æ®ï¼Œç”±äºå¹¶æ²¡æœ‰åŠ è¯»é”å’Œå…¶ä»–çš„äº‹åŠ¡è¿›è¡Œäº’æ–¥ï¼Œå…¶ä»–çš„äº‹åŠ¡ä¸€æ—¦å†™å…¥ä¹‹åå°±å¯ä»¥è¢«è¯»å–ï¼Œå› æ­¤å½“è¯»å–åˆ°ä¹‹åï¼Œå¦‚æœå†™å…¥æ•°æ®çš„äº‹åŠ¡ä¸­æ­¢å›æ»šï¼Œé‚£ä¹ˆè¯»å–åˆ°çš„æ•°æ®å°±å˜æˆäº†è„æ•°æ®äº§ç”Ÿè„è¯»ã€‚\nREAD COMMITTED\nç›¸æ¯”äºè¯»æœªæäº¤è§£å†³äº†è„è¯»çš„é—®é¢˜ï¼Œä½†æ˜¯ä¾æ—§ä¼šå‡ºç°ä¸å¯é‡å¤è¯»å’Œå¹»è¯»\nåœ¨å®ç°ä¸Šè¯»æ“ä½œéœ€è¦åœ¨Tableä¸ŠåŠ ISï¼Œåœ¨Rowä¸ŠåŠ Sï¼Œå¹¶ä¸”å½“å®Œæˆä¸€æ¬¡è¯»å–ä¹‹åå³å¯å°†é”é‡Šæ”¾ï¼Œæ— éœ€ç­‰å¾…äº‹åŠ¡çš„æäº¤ã€‚é‡Šæ”¾Sé”å¹¶ä¸ä¼šå¯¼è‡´äº‹åŠ¡ä»growingå‘shrinkingè½¬å˜ã€‚\nç”±äºé€šè¿‡Sé”è¿›è¡Œäº’æ–¥ï¼Œä»è€Œä¿è¯é‚£äº›æ­£åœ¨å†™å…¥çš„äº‹åŠ¡åœ¨æäº¤å‰ä¸åº”è¢«è¯»å–åˆ°ï¼Œèƒ½å¤Ÿè¯»å–åˆ°çš„æ•°æ®ä¸€å®šæ˜¯æäº¤ä¹‹åç¨³å®šå†™å…¥çš„æ•°æ®ã€‚\nREPEATABLE READ\nåœ¨è¯»æäº¤çš„åŸºç¡€ä¸Šåˆè§£å†³äº†ä¸å¯é‡å¤è¯»çš„é—®é¢˜ï¼Œå­˜åœ¨å¹»è¯»ã€‚\nå®ç°ä¸ŠåŠ é”ç­–ç•¥å’ŒREAD COMMITTEDå¹¶æ²¡æœ‰åŒºåˆ«ï¼Œä½†æ˜¯åœ¨é‡Šæ”¾é”ä¸Šè¯»å†™é”å…¨éƒ¨é‡‡ç”¨ä¸¥æ ¼ä¸¤é˜¶æ®µé”çš„ç­–ç•¥ï¼Œæ­¤æ¬¡äº‹åŠ¡ä¼šä¸€ç›´æŒæœ‰è¯»é”ï¼Œä»è€Œä¸­é€”ä¸å¯èƒ½è¢«å…¶ä»–çš„äº‹åŠ¡é‡æ–°å†™å…¥æ›´æ–°ï¼Œåœ¨ä¸€æ¬¡äº‹åŠ¡å½“ä¸­è¯»å–çš„æ•°æ®å…¨éƒ¨ä¸ºä¸€è‡´çš„ã€‚\nshrinkingé˜¶æ®µä¸å…è®¸æ·»åŠ ä»»ä½•çš„é”ï¼Œé‡Šæ”¾S Xé”å°±ä¼šå‘shrinkingè¿›è¡Œè½¬å˜ã€‚\nå¯ä¸²è¡ŒåŒ–\næœ€ä¸¥æ ¼çš„éš”ç¦»çº§åˆ«ï¼Œç®€å•æ¥è¯´å°±æ˜¯åœ¨è¯¥éš”ç¦»çº§åˆ«ä¸‹ï¼Œäº‹åŠ¡çš„æ‰§è¡Œå¯ä»¥ç­‰ä»·æˆä¸€æ¬¡ä¸å­˜åœ¨å¹¶å‘çš„ä¸²è¡Œæ‰§è¡Œã€‚æœ€ç®€å•çš„åˆ¤æ–­æ˜¯å¦ä¸ºå¯ä¸²è¡ŒåŒ–çš„æ–¹æ³•å°±æ˜¯äº¤æ¢ä¸€ç³»åˆ—ä¸å†²çªçš„æŒ‡ä»¤ï¼Œä»è€Œçœ‹åŸæœ¬çš„äº‹åŠ¡è°ƒåº¦æ˜¯å¦å¯ä»¥è¢«åˆ†ä¸ºä¸¤ä¸ªåœ¨æ—¶é—´ä¸Šå®Œå…¨é”™å¼€çš„ä¸²è¡Œè°ƒåº¦ï¼Œç®€å•ç”¨è¯»å†™æ¥è¡¨ç¤ºï¼Œä¸€æ¬¡é€šè¿‡äº¤æ¢æˆ–é‡æ‹è½¬æ¢æˆä¸²è¡Œç»“æœå¦‚ä¸‹ï¼š\nç›¸æ¯”äºå¯é‡å¤è¯»ï¼Œä¸»è¦éœ€è¦è§£å†³å¹»è¯»çš„é—®é¢˜ï¼Œå½“å‰æˆç†Ÿçš„å•†ä¸šæ•°æ®åº“é€šå¸¸é‡‡ç”¨ä¸¤é˜¶æ®µé” + ç´¢å¼•é”ï¼ˆè°“è¯é”ï¼‰çš„æ–¹å¼è¿›è¡Œè§£å†³ï¼Œè€Œä¸€ç§æ¯”è¾ƒç®€å•ç²—æš´çš„è§£å†³æ–¹å¼å³ä¸ºç›´æ¥ä¸Šè¡¨é”ï¼Œå³å¯é¿å…åœ¨é—´éš™ä¸­çš„è¯»å†™è¡Œä¸ºï¼Œä»è€Œä¿è¯å¯ä¸²è¡ŒåŒ–ã€‚### è¯´ä¸€ä¸‹äº‹åŠ¡çš„éš”ç¦»çº§åˆ«\nå››ç§éš”ç¦»çº§åˆ«çš„å·®åˆ«ä¸»è¦èšç„¦äºè¯»æ“ä½œä¸Šï¼Œå¯¹äºå†™æ“ä½œï¼Œä¸ºäº†ä¿è¯æ•°æ®åº“ä¸€è‡´æ€§ï¼Œåªæœ‰å†™å…¥çš„é”åªæœ‰æ•°æ®æäº¤æ—¶æ‰èƒ½å¤Ÿé‡Šæ”¾ï¼Œå¦‚æœä¸­é€”é‡Šæ”¾é”ï¼Œå†™å…¥çš„æ“ä½œç»“æœå¯èƒ½ä¼šè¢«å…¶ä»–çš„è¦†ç›–ï¼Œä»è€Œè¿åäº†æ•°æ®åº“ä¸€è‡´æ€§ã€‚å•ç‹¬çœ‹å†™é”çš„è¯ï¼Œéƒ½æ˜¯é‡‡ç”¨äº†ä¸¥æ ¼ä¸¤é˜¶æ®µé”çš„ç­–ç•¥ï¼Œä¿è¯ä¸€è‡´æ€§ï¼ŒåŒæ—¶é¿å…çº§è”ä¸­æ­¢ã€‚\nREAD UNCOMMITTED\næœ€å®½æ¾çš„éš”ç¦»çº§åˆ«ï¼Œæ ¹æ®ä¸Šè¡¨å¯ä»¥çœ‹åˆ°è„è¯» ä¸å¯é‡å¤è¯» å¹»è¯»éƒ½ä¼šå‘ç”Ÿ\nåœ¨å®ç°ä¸Šè¯»æ“ä½œä¸éœ€è¦åŠ é”ï¼Œå†™æ“ä½œå’Œå…¶ä»–çš„ä¸€è‡´ï¼Œå› æ­¤æ‰€æœ‰è¯»ç›¸å…³çš„é”éƒ½ä¸æ”¯æŒï¼Œå¦‚æœæƒ³å°è¯•åŠ [S,IS,SIX]ï¼Œéƒ½ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚ç”±äºåªæ”¯æŒå†™é”ï¼Œåœ¨shrinkingé˜¶æ®µï¼Œä»»ä½•åŠ é”æ“ä½œéƒ½æ˜¯ä¸å…è®¸çš„ï¼Œä¼šæŠ›å‡ºå¼‚å¸¸ã€‚\nå› æ­¤å¹¶ä¸ä¿è¯è¯»å–åˆ°çš„æ•°æ®ä¸€å®šæ˜¯æäº¤çš„æ•°æ®ï¼Œç”±äºå¹¶æ²¡æœ‰åŠ è¯»é”å’Œå…¶ä»–çš„äº‹åŠ¡è¿›è¡Œäº’æ–¥ï¼Œå…¶ä»–çš„äº‹åŠ¡ä¸€æ—¦å†™å…¥ä¹‹åå°±å¯ä»¥è¢«è¯»å–ï¼Œå› æ­¤å½“è¯»å–åˆ°ä¹‹åï¼Œå¦‚æœå†™å…¥æ•°æ®çš„äº‹åŠ¡ä¸­æ­¢å›æ»šï¼Œé‚£ä¹ˆè¯»å–åˆ°çš„æ•°æ®å°±å˜æˆäº†è„æ•°æ®äº§ç”Ÿè„è¯»ã€‚\nREAD COMMITTED\nç›¸æ¯”äºè¯»æœªæäº¤è§£å†³äº†è„è¯»çš„é—®é¢˜ï¼Œä½†æ˜¯ä¾æ—§ä¼šå‡ºç°ä¸å¯é‡å¤è¯»å’Œå¹»è¯»\nåœ¨å®ç°ä¸Šè¯»æ“ä½œéœ€è¦åœ¨Tableä¸ŠåŠ ISï¼Œåœ¨Rowä¸ŠåŠ Sï¼Œå¹¶ä¸”å½“å®Œæˆä¸€æ¬¡è¯»å–ä¹‹åå³å¯å°†é”é‡Šæ”¾ï¼Œæ— éœ€ç­‰å¾…äº‹åŠ¡çš„æäº¤ã€‚é‡Šæ”¾Sé”å¹¶ä¸ä¼šå¯¼è‡´äº‹åŠ¡ä»growingå‘shrinkingè½¬å˜ã€‚\nç”±äºé€šè¿‡Sé”è¿›è¡Œäº’æ–¥ï¼Œä»è€Œä¿è¯é‚£äº›æ­£åœ¨å†™å…¥çš„äº‹åŠ¡åœ¨æäº¤å‰ä¸åº”è¢«è¯»å–åˆ°ï¼Œèƒ½å¤Ÿè¯»å–åˆ°çš„æ•°æ®ä¸€å®šæ˜¯æäº¤ä¹‹åç¨³å®šå†™å…¥çš„æ•°æ®ã€‚\nREPEATABLE READ\nåœ¨è¯»æäº¤çš„åŸºç¡€ä¸Šåˆè§£å†³äº†ä¸å¯é‡å¤è¯»çš„é—®é¢˜ï¼Œå­˜åœ¨å¹»è¯»ã€‚\nå®ç°ä¸ŠåŠ é”ç­–ç•¥å’ŒREAD COMMITTEDå¹¶æ²¡æœ‰åŒºåˆ«ï¼Œä½†æ˜¯åœ¨é‡Šæ”¾é”ä¸Šè¯»å†™é”å…¨éƒ¨é‡‡ç”¨ä¸¥æ ¼ä¸¤é˜¶æ®µé”çš„ç­–ç•¥ï¼Œæ­¤æ¬¡äº‹åŠ¡ä¼šä¸€ç›´æŒæœ‰è¯»é”ï¼Œä»è€Œä¸­é€”ä¸å¯èƒ½è¢«å…¶ä»–çš„äº‹åŠ¡é‡æ–°å†™å…¥æ›´æ–°ï¼Œåœ¨ä¸€æ¬¡äº‹åŠ¡å½“ä¸­è¯»å–çš„æ•°æ®å…¨éƒ¨ä¸ºä¸€è‡´çš„ã€‚\nshrinkingé˜¶æ®µä¸å…è®¸æ·»åŠ ä»»ä½•çš„é”ï¼Œé‡Šæ”¾S Xé”å°±ä¼šå‘shrinkingè¿›è¡Œè½¬å˜ã€‚\nå¯ä¸²è¡ŒåŒ–\næœ€ä¸¥æ ¼çš„éš”ç¦»çº§åˆ«ï¼Œç®€å•æ¥è¯´å°±æ˜¯åœ¨è¯¥éš”ç¦»çº§åˆ«ä¸‹ï¼Œäº‹åŠ¡çš„æ‰§è¡Œå¯ä»¥ç­‰ä»·æˆä¸€æ¬¡ä¸å­˜åœ¨å¹¶å‘çš„ä¸²è¡Œæ‰§è¡Œã€‚æœ€ç®€å•çš„åˆ¤æ–­æ˜¯å¦ä¸ºå¯ä¸²è¡ŒåŒ–çš„æ–¹æ³•å°±æ˜¯äº¤æ¢ä¸€ç³»åˆ—ä¸å†²çªçš„æŒ‡ä»¤ï¼Œä»è€Œçœ‹åŸæœ¬çš„äº‹åŠ¡è°ƒåº¦æ˜¯å¦å¯ä»¥è¢«åˆ†ä¸ºä¸¤ä¸ªåœ¨æ—¶é—´ä¸Šå®Œå…¨é”™å¼€çš„ä¸²è¡Œè°ƒåº¦ï¼Œç®€å•ç”¨è¯»å†™æ¥è¡¨ç¤ºï¼Œä¸€æ¬¡é€šè¿‡äº¤æ¢æˆ–é‡æ‹è½¬æ¢æˆä¸²è¡Œç»“æœå¦‚ä¸‹ï¼š\nå¹¶å‘æ§åˆ¶ é”çš„æˆäºˆæ–¹å¼ é¦–å…ˆè€ƒè™‘é”å†²çªçš„é—®é¢˜ï¼Œæœ€ç®€å•çš„ä¸ºè¯»å†™å†²çªï¼Œå¦‚æœäº§ç”Ÿå†²çªè‡ªç„¶æ— æ³•è¿›è¡ŒåŠ é”ï¼Œä¹‹åå¯ä»¥è€ƒè™‘æ›´åŠ ç»†ç²’åº¦çš„é”ï¼Œå¦‚å¯¹rowåŠ é”æ—¶éœ€è¦å…ˆè·å–tableä¸Šçš„é”ã€‚ ä¸å­˜åœ¨å†²çªæ—¶å¹¶ä¸æ„å‘³ç€å¯ä»¥ç›´æ¥è·å–é”å¦‚æœå½“å‰T1æŒæœ‰Sé”ï¼ŒT2è¯•å›¾è·å–Xé”æ­£åœ¨é˜»å¡ï¼Œæ­¤æ—¶T3æƒ³è¦è·å–Sé”ï¼Œåˆ™ä¸T1ä¸å†²çªå¯ä»¥ç›´æ¥è·å–ï¼Œä½†æ˜¯ä¹‹åçš„äº‹åŠ¡éƒ½æ¥è·å–Sé”ï¼Œé‚£ä¹ˆé•¿ä¹…ä»¥æ¥å°±ä¼šå‡ºç°T2äº‹åŠ¡starvedã€‚ å› æ­¤åˆç†çš„ç»„ç»‡æ–¹å¼å°±æ˜¯å¯¹äºä¸€ä¸ªéœ€è¦ä¸Šé”çš„èµ„æºï¼Œé€šè¿‡ä¸€ä¸ªé˜Ÿåˆ—è¿›è¡Œç®¡ç†ï¼Œåªæœ‰è‡ªèº«ä¸å½“å‰æŒæœ‰çš„é”ä¸å†²çªï¼Œå¹¶ä¸”åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­æ’åç¬¬ä¸€æ—¶æ‰èƒ½è·å–é”ã€‚ä¿è¯äº†äº’æ–¥ä¸é˜²æ­¢starvedã€‚æ­¤å¤–è¿˜æœ‰é”å‡çº§çš„ç›¸å…³ç»†èŠ‚ï¼Œå¯ä»¥å‚è€ƒbustubå½“ä¸­çš„å®ç°ã€‚\nä¸¤é˜¶æ®µé”åè®® é¦–å…ˆæ˜ç¡®æ¦‚å¿µï¼Œä¸¤é˜¶æ®µé”åè®®åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š\nå¢é•¿é˜¶æ®µ(growing phase)ï¼Œåªèƒ½è·å–é” ç¼©å‡é˜¶æ®µ(shrinking phase)ä¸€ä¸ªäº‹åŠ¡å¯ä»¥é‡Šæ”¾é”ï¼Œä½†æ˜¯ä¸èƒ½è·å–ä»»ä½•æ–°é” äº‹åŠ¡ä¸€æ—¦é‡Šæ”¾äº†ä»»ä½•ä¸€ä¸ªé”ï¼Œå°±ä¼šä»growing phaseè½¬æ¢åˆ°shrinking phaseã€‚ 2PLï¼šè¯»é”å†™é”éƒ½æŒ‰ç…§growing shrinkingçš„æ–¹å¼æ¥è·å–é‡Šæ”¾ï¼Œæœ€åŸºç¡€çš„ä¸¤é˜¶æ®µé”æ‰€è§£å†³çš„ä¸å¯é‡å¤è¯»çš„é—®é¢˜ï¼Œæ•´ä¸ªè¯»å–è¿‡ç¨‹ä¸­æŒæœ‰é”ï¼Œä»è€Œä¿è¯äº†ä¸ä¼šæœ‰å…¶ä»–çš„äº‹åŠ¡æ¥ä¿®æ”¹æ•°æ® S2PLï¼šå†™é”åªæœ‰åœ¨äº‹åŠ¡æäº¤æ—¶æ‰èƒ½å¤Ÿé‡Šæ”¾ï¼Œè¯»é”ä¸åŸæœ¬ä¿æŒä¸å˜ï¼Œå³å†™é”çš„shrinkingé˜¶æ®µå˜æˆäº†ä¸€ä¸ªç‚¹ï¼Œ2PLå­˜åœ¨çš„é—®é¢˜æ˜¯ç”±äºè¿‡æ—©çš„é‡Šæ”¾é”ï¼Œä¼šå¯¼è‡´å‡ºç°è„è¯»/è„å†™çš„é—®é¢˜ï¼Œéœ€è¦é€šè¿‡çº§è”å›æ»šçš„æ–¹æ³•æ¥è§£å†³ï¼Œä½†æ˜¯è¿™ä¸ªæ–¹æ¡ˆä¼šäº§ç”Ÿè¾ƒå¤§çš„å¼€é”€ã€‚S2PLåªæœ‰åœ¨commitæ—¶æ‰ä¼šé‡Šæ”¾é”ï¼Œä»è€Œå…¶ä»–äº‹åŠ¡è¯»å–åˆ°çš„ä¸€å®šæ˜¯commitäº†çš„æ•°æ®ï¼Œä»è€Œé¿å…äº†çº§è”ä¸­æ­¢çš„é—®é¢˜ SS2PL(rigorous two-phase locking protocol)ï¼šä½œä¸ºS2PLçš„å˜ä½“ï¼Œè¦æ±‚è¯»é”ä¹Ÿåœ¨commitæ—¶è¿›è¡Œé‡Šæ”¾ã€‚ åŸºäºå›¾çš„åè®® å¯¹æ‰€æœ‰éœ€è¦åŠ é”çš„èµ„æºæ¥æ„å»ºä¸€ä¸ªååºçš„å…³ç³»ï¼ˆæœ‰å‘æ— ç¯å›¾ï¼‰ï¼Œä¹‹åå¦‚æœéœ€è¦è¿›è¡ŒåŠ é”ï¼Œåˆ™æŒ‰ç…§è¯¥ååºå…³ç³»è¿›è¡ŒåŠ é”ï¼Œå¹¶ä¸”ï¼Œåªæ„å»ºå¸¦æœ‰æ ¹èŠ‚ç‚¹çš„å½¢å¼ã€‚ é€šè¿‡è¯¥æ ‘å½¢å¼ï¼Œå¯ä»¥ä¿è¯å†²çªå¯ä¸²è¡ŒåŒ–å’Œä¸ä¼šäº§ç”Ÿæ­»é”ï¼Œä½†æ˜¯å¹¶ä¸èƒ½å¤Ÿä¿è¯å¯æ¢å¤æ€§å’Œæ— çº§è”æ€§\nå¦‚æœæƒ³è¦ä¿è¯å¯æ¢å¤æ€§ï¼Œå¯ä»¥å¼•å…¥ä¸€ä¸ªä¾èµ–å…³ç³»ï¼Œè‡ªèº«ä¾èµ–çš„äº‹åŠ¡åœ¨commitå‰è‡ªèº«ä¸èƒ½å¤Ÿè¿›è¡Œcommit å¦‚æœæƒ³è¦åŒæ—¶ä¿è¯å¯æ¢å¤æ€§å’Œæ— çº§è”æ€§ï¼Œåˆ™éœ€è¦åœ¨äº‹åŠ¡ç»“æŸå‰ä¸é‡Šæ”¾æ’ä»–é”ã€‚ æ­»é”çš„é¢„é˜² æ­»é”çš„é¢„é˜²ä¸»è¦åˆ†ä¸ºä¸¤ç§ï¼š\nä¸€ç§æ˜¯é€šè¿‡æ’åºçš„æ–¹å¼ï¼Œå³ä¸Šé¢çš„æ ‘çŠ¶å½¢å¼å°±æ˜¯é€šè¿‡ä¸€ç§ååºçš„æ–¹å¼æ¥è¿›è¡Œæ­»é”çš„é¢„é˜²ï¼Œæˆ–è€…åƒä¹‹å‰godisæ‰€å†™çš„é‚£æ ·ï¼Œé€šè¿‡å¯¹å…¨å±€çš„keyè¿›è¡Œæ’åºä»¥é¢„é˜²æ­»é”ã€‚ å¦å¤–ä¸€ç§å³ä¸ºåŸºäºæ—¶é—´æˆ³çš„æ–¹å¼ï¼Œç»†åˆ†ä¸ºæŠ¢å å¼çš„wound-waitå’ŒéæŠ¢å å¼çš„wait-die æ­¤å¤–æœ€ç®€å•çš„æ–¹å¼å³ä¸ºé€šè¿‡é”è¶…æ—¶çš„æ–¹å¼è¿›è¡Œï¼Œè¶…æ—¶å³æ”¾å¼ƒäº‹åŠ¡å›æ»šã€‚ æ­»é”æ£€æµ‹ä¸æ¢å¤ æ­»é”æ£€æµ‹çš„æ–¹æ³•å’Œä¹‹å‰å†²çªå¯ä¸²è¡ŒåŒ–çš„åˆ¤æ–­æ–¹å¼ç›¸åŒï¼Œé€šè¿‡æ„å»ºç­‰å¾…æœ‰å‘å›¾çš„æ–¹å¼è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœåœ¨å›¾ä¸­å­˜åœ¨ç¯è·¯ï¼Œåˆ™è¯æ˜å­˜åœ¨æ­»é”/ä¸å¯ä¸²è¡ŒåŒ–ã€‚ æ­»é”æ¢å¤ï¼š Victimï¼šé€šè¿‡ç¯è·¯æ‰¾åˆ°äº†æ­»é”ä¹‹åï¼Œè€ƒè™‘é€‰æ‹©ä¸€ä¸ªç‰ºç‰²è€…äº‹åŠ¡è¿›è¡Œå›æ»šï¼Œæ¥ç ´é™¤æ‰ç¯è·¯(æ­»é”)ï¼Œç‰ºç‰²è€…çš„é€‰æ‹©å‡†åˆ™ï¼š\näº‹åŠ¡æ‰§è¡Œæ—¶é—´ï¼Œä»¥åŠä¹‹åè¿˜è¦æ‰§è¡Œå¤šä¹… äº‹åŠ¡å·²ç»ä½¿ç”¨çš„æ•°æ®é¡¹ï¼Œå®Œæˆäº‹åŠ¡è¿˜éœ€è¦å¤šå°‘æ•°æ®é¡¹ å›æ»šäº‹åŠ¡ç‰µæ‰¯åˆ°çš„äº‹åŠ¡æ•°é‡ å›æ»šï¼š å…¨éƒ¨å›æ»š éƒ¨åˆ†å›æ»šï¼Œå›æ»šåˆ°åˆšå¥½å¯ä»¥æ‰“ç ´æ­»é”çš„ä½ç½®ï¼Œéœ€è¦è®°å½•é¢å¤–çš„ä¿¡æ¯ã€‚ å¹»è¯»ä¸ç´¢å¼•é” å¹»è¯»æ˜¯åœ¨äº‹åŠ¡å¹¶å‘æ‰§è¡Œæ—¶å¯èƒ½å‡ºç°çš„ä¸€ç§ç°è±¡ï¼Œå®ƒæŒ‡çš„æ˜¯åœ¨ä¸€ä¸ªäº‹åŠ¡å†…éƒ¨ï¼Œå¤šæ¬¡æ‰§è¡Œç›¸åŒçš„æŸ¥è¯¢æ“ä½œï¼Œä½†åœ¨ä¸åŒçš„æŸ¥è¯¢ä¸­è¿”å›çš„è¡Œæ•°å´ä¸ä¸€è‡´ã€‚é€šå¸¸æ˜¯ç”±äºå…¶ä»–äº‹åŠ¡å¹¶å‘åœ°æ’å…¥æˆ–åˆ é™¤äº†ç¬¦åˆæŸ¥è¯¢æ¡ä»¶çš„æ•°æ®æ‰€å¯¼è‡´çš„ã€‚ ä¸»è¦åŸå› ä¸ºå•ç‹¬çš„è¡Œé”æ— æ³•å¯¹ä¸å­˜åœ¨æ•°æ®è¿›è¡ŒåŠ é”ï¼Œå› æ­¤æ— æ³•é™åˆ¶æ–°æ•°æ®çš„æ’å…¥ï¼Œä»è€Œäº§ç”Ÿäº†ä¸¤æ¬¡æŸ¥è¯¢ç»“æœä¸ä¸€è‡´çš„é—®é¢˜ï¼Œè§£å†³æ–¹æ¡ˆä¹Ÿå³ä¸ºå¯¹â€œä¸å­˜åœ¨â€çš„æ•°æ®è¿›è¡Œä¸Šé”ã€‚å¸¸è§çš„è§£å†³æ–¹æ³•ä¸ºç´¢å¼•é”æˆ–è€…è°“è¯é”ã€‚ ç´¢å¼•é” ç´¢å¼•é”ä»¥B+æ ‘ä¸ºä¾‹ï¼Œå¯¹å¶å­ç»“ç‚¹è¿›è¡Œä¸Šé”ï¼Œæ­¤æ¬¡sqlæ¶‰åŠåˆ°çš„æ‰€æœ‰çš„å¶å­ç»“ç‚¹å‡è¿›è¡Œä¸Šé”ï¼Œå¦‚æœè¦åœ¨ä¼šæ¶‰åŠåˆ°çš„èŒƒå›´å†…æ’å…¥æ–°æ•°æ®ï¼Œåˆ™åŠ¿å¿…ä¼šå¼•èµ·å†²çªï¼Œå³ä¾¿æ˜¯å¼€åŒºé—´å¦‚\n1 select * from a where a.col1 \u0026gt; 10000; ç„¶åæ’å…¥ä¸€ä¸ªcol1 = 20000çš„è®°å½•ï¼Œä¹Ÿä¼šè½åˆ°æœ€åä¸€ä¸ªå¶å­ç»“ç‚¹ä¸Šï¼Œå³ä¾¿æœ€åä¸€ä¸ªå¶å­ç»“ç‚¹å·²æ»¡ï¼Œä¹Ÿéœ€è¦å…ˆæ’å…¥åˆ°å…¶ä¸­å†åˆ†è£‚ã€‚ è°“è¯é” è°“è¯é”å³ä¸ºé’ˆå¯¹whereåé¢çš„æ¡ä»¶è¿›è¡Œä¸Šé”ï¼Œä»é€»è¾‘ä¸Šè¿›è¡Œå†²çªåˆ¤æ–­\næ—¶é—´æˆ³æ’åºåè®® å…ˆä»‹ç»ä¸€ä¸‹åŸºæœ¬æ—¶é—´æˆ³é¡ºåºåè®®\né¦–å…ˆé€šè¿‡æ—¶é—´æˆ³æ¥å¯¹äº‹åŠ¡è¿›è¡Œæ ‡è®°ï¼ŒåŒæ—¶å¯¹äºä¸€ä¸ªtuple éœ€è¦è®°å½•å…¶ W-TSå’ŒR-TSï¼Œå³æœ€åä¸€æ¬¡å¯¹å…¶è¿›è¡Œè¯»å†™æ“ä½œçš„äº‹åŠ¡çš„æ—¶é—´æˆ³ï¼Œç”¨äºåœ¨ä¸€ä¸ªäº‹åŠ¡è¦å¯¹ä¸€ä¸ªtupleè¿›è¡Œè¯»å†™æ“ä½œæ—¶åˆ¤æ–­æ˜¯å¦æœ‰å…¶ä»–äº‹åŠ¡ä¼šå’Œå®ƒäº§ç”Ÿå†²çª\nåœ¨åŸºæœ¬æ—¶é—´æˆ³é¡ºåºåè®®ä¸­ï¼Œæ—¶é—´æˆ³è®°å½•çš„æ˜¯è¯¥äº‹åŠ¡å¼€å§‹æ—¶çš„æ—¶é—´ï¼Œå³é€šè¿‡BEGINå…³é”®å­—å£°æ˜å¼€å¯äº‹åŠ¡æ—¶æ—§åˆ†é…ä¸€ä¸ªæ—¶é—´æˆ³ï¼Œä½†æ˜¯DBMSæœ¬èº«è¿˜æ˜¯å¹¶å‘çš„ï¼Œå› æ­¤å¯èƒ½ä¼šå‡ºç°åç»­çš„äº‹åŠ¡åœ¨è¾ƒæ—©çš„äº‹åŠ¡ä¹‹å‰æ‰§è¡Œï¼Œæ­¤æ—¶å°±å¯èƒ½å­˜åœ¨é—®é¢˜ï¼Œå¯èƒ½è¦è€ƒè™‘å°†è¾ƒæ—©çš„äº‹åŠ¡ç»™æ’¤é”€ï¼Œå¹¶é‡æ–°åˆ†é…æ—¶é—´æˆ³é‡æ–°æ‰§è¡Œ\nå½“ä¸€ä¸ªäº‹åŠ¡è®¿é—®åˆ°ä¸€ä¸ªtupleæ—¶ï¼Œå‘ç°TS \u0026lt; W-TS ï¼Œåˆ™è¯æ˜æœªæ¥çš„ä¸€æ¬¡å†™å…¥è¦†ç›–äº†ç›®å‰æ­£åœ¨è¯»çš„æ•°å€¼ï¼Œå³å‡ºç°äº†è„è¯»é—®é¢˜ï¼Œè¯»å–åˆ°çš„æ˜¯æ—§å€¼ï¼Œéœ€è¦ç»ˆæ­¢\nå¯¹äºè¯»å†™ï¼Œæœ‰ä»¥ä¸‹çš„è§„åˆ™ï¼š\nè¯»ï¼š\nå¦‚æœTS($T_i$) \u0026lt; W-TS(X),åˆ™è¿åäº†æ—¶é—´æˆ³é¡ºåºï¼Œè¯»åˆ°äº†æ—§çš„å€¼ï¼Œè¯¥äº‹åŠ¡éœ€è¦é‡å¯å¹¶åˆ†é…æ–°çš„æ—¶é—´æˆ³\nå¦åˆ™ï¼š\nå…è®¸äº‹åŠ¡Tå»è¯»å–tuple X æ›´æ–°R-TSï¼ˆXï¼‰ä¸º$max(R-TS(X),TS(T_i))$ ç”Ÿæˆä¸€ä¸ªæœ¬åœ°å‰¯æœ¬ç”¨äºè¯¥äº‹åŠ¡åç»­çš„é‡å¤è¯»ï¼ˆå¦‚æœå†å»è¯»æœ€æ–°çš„æ•°æ®åˆ™ä¼šäº§ç”Ÿä¸¤æ¬¡è¯»å–ä¸ä¸€è‡´çš„ä¸å¯é‡å¤è¯»çš„é—®é¢˜ï¼‰ å†™ï¼š\nå¦‚æœ$TS(T_i)\u0026lt;R-TS(X) or TS(T_i) \u0026lt; W-TS(X)$ æ”¾å¼ƒ$T_i$å¹¶é‡å¯$T_i$\n$TS(T_i)\u0026lt;R-TS(X)$ä¼šå¯¼è‡´åç»­è¯»å–æ“ä½œè¯»å–ä¸åˆ°æ­¤æ¬¡çš„å†™å…¥ $TS(T_i) \u0026lt; W-TS(X)$ä¼šå¯¼è‡´æ­¤æ¬¡çš„å†™å…¥æ— æ„ä¹‰ å¦åˆ™ï¼š\nå…è®¸äº‹åŠ¡$T_i$å»å†™å…¥ï¼Œå¹¶ä¸”æ›´æ–°W-TS(X) ç”Ÿæˆä¸€ä¸ªæœ¬åœ°å‰¯æœ¬ç”¨äºå¯é‡å¤è¯» å¯¹äºå†™æ“ä½œï¼Œè¿˜å¯ä»¥é€šè¿‡Thomas Write Ruleè¿›è¡Œä¼˜åŒ–ï¼š\n$TS(T_i) \u0026lt;R-TS(X)$:æ”¾å¼ƒå¹¶é‡å¯$T_i$ï¼ˆä¸åŸæœ¬ä¸€è‡´ï¼‰ $TS(T_i) \u0026lt;W-TS(X)$:å¿½ç•¥æ­¤æ¬¡å†™å…¥ï¼Œå¹¶å…è®¸äº‹åŠ¡ç»§ç»­æ‰§è¡Œ å…¶ä»–æƒ…å†µåˆ™æœªè¿ååè®®ï¼Œå…è®¸$T_i$å†™å…¥ï¼Œå¹¶æ›´æ–°$W-TS(X)$ è™½ç„¶æœ¬è´¨ä¸Šè¿åäº†åè®®ï¼Œä½†æ˜¯å½“å‰æ­¤æ¬¡å†™åç»­ä¼šè¢«è¦†ç›–æ‰ï¼Œå› æ­¤å¯ä»¥ç›´æ¥è¿›è¡Œå¿½ç•¥\næ€»çš„æ¥è¯´ï¼ŒåŸºæœ¬æ—¶é—´æˆ³é¡ºåºåè®®çš„ç²¾é«“ä¸ºå½“ä¸€ä¸ªäº‹åŠ¡åˆ›å»ºæ—¶åˆ†é…ä¸€ä¸ªæ—¶é—´æˆ³ï¼Œç”±äºäº‹åŠ¡çš„åŸå­æ€§ï¼Œå°†äº‹åŠ¡å½“ä¸­æ‰€æœ‰çš„æŒ‡ä»¤çš„å‘ç”Ÿæ—¶é—´å…¨éƒ¨é›†ä¸­äºbeginçš„è¿™ä¸€æ—¶é—´æˆ³ä¸Šï¼Œä¹‹åå¦‚æœæœ‰è¿åæ—¶é—´é¡ºåºçš„ï¼Œäº‹åŠ¡åˆ™ä¼šä¸­æ­¢å›æ»šï¼Œå¹¶å°è¯•é‡æ–°å¼€å¯äº‹åŠ¡ï¼Œå¦‚è¯»å–æ—¶å‘ç°æœ‰æœªæ¥çš„äº‹åŠ¡å·²ç»å¯¹å…¶è¿›è¡Œäº†å†™å…¥ã€‚ å¯æ¢å¤æ€§ä¸æ— çº§è”æ€§ åŸºç¡€çš„æ—¶é—´æˆ³æ’åºåè®®æ˜¯æ— æ³•æä¾›å¯æ¢å¤æ€§ä¸æ— çº§è”æ€§çš„ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹çš„æ–¹å¼æ¥ä¿è¯ï¼š\né€šè¿‡åœ¨äº‹åŠ¡æœ«å°¾ä¸€èµ·æ‰§è¡Œæ‰€æœ‰çš„å†™æ“ä½œå¯ä»¥ä¿è¯å¯æ¢å¤æ€§å’Œæ— çº§è”æ€§ å¯æ¢å¤æ€§ä¸æ— çº§è”æ€§ä¹Ÿå¯ä»¥é€šè¿‡å°†è¯»æ“ä½œæ¨è¿Ÿåˆ°æ›´æ–°è¯¥æ•°æ®çš„äº‹åŠ¡æäº¤ä¹‹åè¿›è¡Œæ¥ä¿è¯ã€‚ å•ç‹¬çš„å¯æ¢å¤æ€§å¯ä»¥é€šè¿‡ä¾èµ–è¿½è¸ªçš„æ–¹å¼è¿›è¡Œè§£å†³ï¼Œå³åªæœ‰ä¾èµ–çš„äº‹åŠ¡æäº¤äº†æ‰ä¼šæäº¤å½“å‰äº‹åŠ¡ Thomaså†™è§„åˆ™ Thomaså†™è§„åˆ™å¯¹åŸºæœ¬æ—¶é—´æˆ³åè®®è¿›è¡Œäº†ä¸€äº›ä¼˜åŒ–ï¼Œç»è¿‡ä¼˜åŒ–åçš„å†™è§„åˆ™å¦‚ä¸‹ï¼š\nå¦‚æœ$TS(T_i)$ \u0026lt; R-timestampï¼Œåˆ™è¯æ˜å·²ç»å­˜åœ¨äº†ä¸€ä¸ªæ›´æ–°çš„è¯»å–æ“ä½œï¼Œæ­¤æ¬¡å†™å…¥æ˜¯ä¸è¢«éœ€è¦çš„ï¼Œå› æ­¤ç›´æ¥æ‹’ç»å¹¶å›æ»š å¦‚æœ$TS(T_i)$ \u0026lt; W-timestampï¼Œåˆ™è¯æ˜å·²ç»å­˜åœ¨äº†ä¸€ä¸ªæ›´æ–°çš„å†™å…¥æ“ä½œï¼Œå½“å‰çš„å†™å…¥ä¹‹åä¼šè¢«è¦†ç›–ï¼Œå› æ­¤ä»€ä¹ˆä¹Ÿä¸éœ€è¦åšï¼Œå¿½ç•¥æ‰æ­¤æ¬¡write å…¶ä»–æƒ…å†µåˆ™æ­£å¸¸å†™å…¥ MVCC ä¸¥æ ¼æ¥è¯´ï¼ŒMVCC(Multiversion Concurrency Control)å¹¶ä¸æ˜¯ä¸€ç§å¹¶å‘æ‰‹æ®µï¼Œä»–å¹¶ä¸èƒ½å¤Ÿå®Œæ•´çš„è§£å†³å¹¶å‘å†²çªé—®é¢˜ï¼ŒMVCCèƒ½å¤Ÿæä¾›çš„åªæœ‰è¯»ä¸å†™ä¹‹é—´ä¸äº§ç”Ÿå†²çªï¼Œè€Œæ— æ³•ä¿è¯å†™ä¸å†™ä¹‹é—´çš„å†²çªé—®é¢˜ï¼Œå› æ­¤éœ€è¦å¼•å…¥é¢å¤–çš„å¹¶å‘æ§åˆ¶æ‰‹æ®µï¼Œåˆ†åˆ«æœ‰ä¸¤ç§ï¼Œä¸ºä¸æ—¶é—´æˆ³åè®®è¿›è¡Œç»„åˆçš„å¤šç‰ˆæœ¬æ—¶é—´æˆ³æ’åºå’Œä¸ä¸¤é˜¶æ®µé”ç»„åˆçš„å¤šç‰ˆæœ¬ä¸¤é˜¶æ®µå°é”ã€‚ æœ€åç”¨ä¸€å¥è¯æ¥æè¿°MVCCå³ä¸ºè¯»ä¸é˜»å¡å†™ï¼Œå†™ä¸é˜»å¡è¯»ã€‚\nå¤šç‰ˆæœ¬æ—¶é—´æˆ³æ’åº å¯¹äºæ¯ä¸ªæ•°æ®é¡¹ï¼Œå­˜åœ¨ä¸€ä¸ªç‰ˆæœ¬åºåˆ—$\u0026lt;Q_1,Q_2,Q_3,\u0026hellip;,Q_k\u0026gt;$ ï¼Œå¹¶ä¸”æ¯ä¸ªç‰ˆæœ¬$Q_k$åŒ…å«ä¸‰ä¸ªå­—æ®µï¼š\nContent:å½“å‰ç‰ˆæœ¬çš„å€¼ W-timestamp:åˆ›å»º$Q_k$ç‰ˆæœ¬çš„äº‹åŠ¡æ—¶é—´æˆ³ R-timestampï¼šæ‰€æœ‰æˆåŠŸè¯»å–è¿‡çš„å½“ä¸­çš„æœ€å¤§çš„äº‹åŠ¡æ—¶é—´æˆ³ å½“äº‹åŠ¡$T_i$æºå¸¦æ—¶é—´æˆ³$TS(T_i)$åˆ›å»ºè¯¥ç‰ˆæœ¬æ—¶ï¼Œä½¿ç”¨è¯¥æ—¶é—´æˆ³æ¥åˆå§‹åŒ–W-timestampå’ŒR-timestamp åŸºäºæ—¶é—´æˆ³ï¼Œè¯»å†™æœ‰ä»¥ä¸‹çš„è§„åˆ™ï¼š å¦‚æœäº‹åŠ¡Tå‘å‡ºread(Q)ï¼Œé‚£ä¹ˆå®ƒèƒ½å¤Ÿè¯»å–åˆ°çš„ä¸ºå°äºç­‰äºTçš„æ—¶é—´æˆ³çš„æœ€å¤§çš„ç‰ˆæœ¬çš„å€¼ å¦‚æœäº‹åŠ¡å‘å‡ºwrite(Q)ï¼š å¦‚æœæ—¶é—´æˆ³$TS(T_i)$ \u0026lt; R-timestampï¼Œåˆ™è¯æ˜å­˜åœ¨æ›´æ–°çš„è¯»å–ï¼Œå›æ»šäº‹åŠ¡ å¦‚æœæ—¶é—´æˆ³$TS(T_i)$ \u0026lt; W-timestampï¼Œåˆ™å¿½ç•¥æ‰æ­¤æ¬¡å†™å…¥ å¦‚æœæ—¶é—´æˆ³$TS(T_i)$ = W-timestampï¼Œåˆ™è¦†ç›–æ‰æ­¤æ¬¡ç‰ˆæœ¬çš„å†…å®¹ å¦‚æœæ—¶é—´æˆ³$TS(T_i)$ \u0026gt; W-timestampï¼Œåˆ™åˆ›å»ºä¸€ä¸ªW-timestamp = $TS(T_i)$çš„æ–°ç‰ˆæœ¬ ç”±äºåº”ç”¨äº†æ—¶é—´æˆ³ï¼Œå› æ­¤æœ¬è´¨ä¸Šä¸ºä¹è§‚çš„å¹¶å‘æ§åˆ¶åè®®ï¼Œé€‚ç”¨äºå†²çªå‘ç”Ÿæ¯”è¾ƒå°‘çš„æƒ…å†µã€‚ è¯¥æ–¹æ¡ˆä¸ä¿è¯å¯æ¢å¤æ€§å’Œæ— çº§è”æ€§ã€‚å¯ä»¥æŒ‰ç…§å¯¹åŸºæœ¬æ—¶é—´æˆ³æ’åºçš„æ–¹å¼è¿›è¡Œæ‰©å±•ï¼Œä½¿å…¶å…·æœ‰å¯æ¢å¤æ€§å’Œæ— çº§è”æ€§ã€‚ å¤šç‰ˆæœ¬ä¸¤é˜¶æ®µé”åè®® å°†MVCCä¸ä¸¤é˜¶æ®µé”åè®®ç»“åˆèµ·æ¥ï¼Œå¯¹äºäº‹åŠ¡åˆ†ä¸ºåªè¯»äº‹åŠ¡å’Œæ›´æ–°äº‹åŠ¡ã€‚\næ›´æ–°äº‹åŠ¡åœ¨åˆ›å»ºæ—¶ä¼šè·å¾—ä¸€ä¸ªé€»è¾‘æ—¶é—´æˆ³ï¼Œåˆ›å»ºçš„æ–°ç‰ˆæœ¬çš„æ—¶é—´æˆ³ä¸ºæ­£æ— ç©·ï¼Œä¹‹ååœ¨äº‹åŠ¡æäº¤æ—¶æ›´æ–°ä¸ºäº‹åŠ¡çš„æ—¶é—´æˆ³ æ›´æ–°äº‹åŠ¡æƒ³è¦è¯»å–ä¸€ä¸ªæ•°æ®æ—¶éœ€è¦è·å–ä¸€ä¸ªSé”ï¼Œå°è¯•å†™å…¥æ—¶éœ€è¦è·å–Xé” åªè¯»äº‹åŠ¡æ— éœ€åŠ é”ï¼Œåªéœ€è¦æ›´æ–°æ—¶é—´æˆ³å»è¯»å–å¯¹åº”çš„ç‰ˆæœ¬å³å¯ã€‚ ","permalink":"https://fischer0522.github.io/en/posts/tech/%E6%95%B0%E6%8D%AE%E5%BA%93%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%AE%BA/","summary":"ç‰©ç†å­˜å‚¨ç³»ç»Ÿ è¿™ä¸€éƒ¨åˆ†é‡ç‚¹å¹¶ä¸å¤šï¼Œä¸»è¦æ˜¯å„ç§å­˜å‚¨ç±»å‹ä¸Šçš„å·®å¼‚ï¼Œæ¯”è¾ƒäº†å‡ ç§ç‰©ç†å­˜å‚¨ä¸Šçš„å·®å¼‚ï¼Œä»¥åŠSSDï¼ŒHDD ä¹‹é—´çš„å·®å¼‚ï¼Œæœ€ååˆä»‹ç»äº†RAIDçš„","title":"æ•°æ®åº“ç³»ç»Ÿæ¦‚å¿µ"},{"content":"å·®ç”Ÿæ–‡å…·å¤šç³»åˆ—\nCSæ–¹å‘ï¼Œä¸ªäººç§‘ç ” + å¼€å‘å·¥å…·é“¾åˆ†äº«ï¼Œä¸»è¦æ¶‰åŠåˆ°æ–‡çŒ®é˜…è¯»ã€ä»£ç ç¼–è¾‘ã€ç¬”è®°ç­‰å†…å®¹\næ–‡çŒ®é˜…è¯» Zotero é›†æ–‡ä»¶ç®¡ç†ã€é˜…è¯»ã€è®°å½•ä¸ºä¸€ä½“ï¼ŒåŸºæœ¬å¯ä»¥è§£å†³æ‰€æœ‰é—®é¢˜ã€‚\næ”¯æŒé€šè¿‡æ’ä»¶è¿›è¡Œæ‰©å±•ï¼Œå¦‚ç¿»è¯‘ï¼Œmarkdownï¼Œç¬”è®°ç­‰ã€‚ç¿»è¯‘æ’ä»¶å¯ä»¥è‡ªç”±é…ç½®APIï¼Œé€‰æ‹©Googleã€DeepLç­‰ã€‚ å¯ä»¥ä½¿ç”¨å®˜æ–¹åŒæ­¥ï¼Œä¸è¿‡å®¹é‡æœ‰é™ã€‚ä½†æ˜¯æ”¯æŒç¬¬ä¸‰æ–¹åŒæ­¥ï¼Œå¯ä»¥ä½¿ç”¨åšæœäº‘ç­‰ ç¼ºç‚¹å¤§æ¦‚æ˜¯æ¯”è¾ƒåƒå†…å­˜ï¼ŒåŸºæœ¬å¯åŠ¨èµ·æ¥å°±ä¼šåƒ1GB+ å¦‚æœä¸æƒ³é…ç½®Zoteroçš„è¯ä¹Ÿå¯ä»¥ä½¿ç”¨å°ç»¿é²¸ï¼Œå„æ–¹é¢ä¹Ÿéƒ½è¿˜ç®—ä¸é”™ï¼ŒåŒæ ·æ”¯æŒç¿»è¯‘å’Œå®˜æ–¹åŒæ­¥ï¼Œæ¯”è¾ƒçƒ¦çš„æ˜¯ç™»å½•éœ€è¦å¾®ä¿¡æ‰«ç \nZotero | Your personal research assistant å°ç»¿é²¸è‹±æ–‡æ–‡çŒ®é˜…è¯»å™¨â€”â€”ä¸“æ³¨æé«˜SCIé˜…è¯»æ•ˆç‡ PDF ç›®å‰ä½¿ç”¨çš„æ˜¯Macä¸Šè‡ªå¸¦çš„é¢„è§ˆï¼Œå¿«é€Ÿä¸”è½»é‡ï¼Œå¯ä»¥æ»¡è¶³æ—¥å¸¸ä½¿ç”¨ï¼Œå¦‚æœæœ‰éœ€è¦æ“ä½œPDFï¼Œå¦‚åˆå¹¶ï¼Œåˆ†å‰²ï¼Œæ ¼å¼è½¬æ¢ç­‰ï¼Œä½¿ç”¨ILovePDF(é™¤äº†ILovePDFï¼Œè¿˜æœ‰å¦‚ILoveIMGç­‰)\nwinä¸Šé¢å¯ä»¥è€ƒè™‘ä½¿ç”¨Sumatra PDFï¼Œå¦‚æœå­¦æ ¡ä¹°äº†Adobeç³»åˆ—ä¹Ÿå¯ä»¥ä½¿ç”¨Adobe\niLovePDF | Online PDF tools for PDF lovers Free PDF Reader - Sumatra PDF ä»£ç ç¼–è¾‘ Vscode ç›®å‰ç¬”è€…å†™çš„æœ€å¤šçš„æ˜¯C++/Rust/Goï¼ŒåŸºæœ¬ä¸ŠVscodeä¸€ç«™å¼è§£å†³ï¼Œvscodeçš„é…ç½®æ–‡ç« ç½‘ä¸Šæœ‰å¾ˆå¤šï¼Œè¿™é‡Œå°±ä¸è¯¦ç»†å±•å¼€äº†ï¼Œæ”¾å‡ ä¸ªæˆ‘ç›®å‰åœ¨ä½¿ç”¨çš„æ’ä»¶ï¼š ruståŸºæœ¬ä¸Šä¸€ä¸ªrust-analyzerå°±å¤Ÿäº†ï¼Œè¡¥å……ä¸€ä¸ªtomlæ–‡ä»¶æ”¯æŒçš„ï¼š å…¶ä»–æ’ä»¶\nBookmarksï¼šä¸ºä»£ç æ·»åŠ æ ‡è®°ï¼Œæ–¹ä¾¿è·³è½¬ error-lensï¼šæ›´åŠ äººæ€§åŒ–çš„é«˜äº®æ˜¾ç¤ºerror hex-editorï¼šé˜…è¯»å’Œç¼–è¾‘äºŒè¿›åˆ¶æ–‡ä»¶ remote-sshï¼šè¿™ä¸ªä¸å¿…å¤šè¯´äº†ï¼Œä½¿ç”¨æœåŠ¡å™¨å¿…å¤‡ Vimï¼švscodeä¸Šçš„Vimæ’ä»¶ VsCode Counter: ä»£ç é‡ç»Ÿè®¡ï¼Œé«˜çº§ç‰ˆwc Tokyo Nightï¼šä¸ªäººæœ€å–œæ¬¢çš„ä¸»ä½“ Cappuccin Icon / Material Iconï¼šå›¾æ ‡ Vim ç›®å‰åœ¨ç”¨Lazy vimï¼Œå› ä¸ºæœ‰æ—¶å€™å†™æ€¥çœ¼äº†è¿˜æ˜¯å–œæ¬¢å»æ‘¸é¼ æ ‡ï¼Œæ‰€ä»¥å¯¹æˆ‘è€Œè¨€è¿˜å±äºç©å…·æ€§è´¨ï¼Œæ²¡æœ‰å°†å…¶å½“ä½œä¸»åŠ›æ¥ä½¿ç”¨ã€‚\nç›¸åŒçš„è¿˜æœ‰LunarVimï¼Œéƒ½æ˜¯å±äºå¼€ç®±å³ç”¨\nç¬”è®° ç¬”è€…å¯¹ç¬”è®°è½¯ä»¶çš„åŸºæœ¬è¦æ±‚æœ‰ä¸¤ä¸ªï¼Œä¸€æ˜¯é«˜æ€§èƒ½ï¼ŒäºŒæ˜¯åŒæ­¥ã€‚\nä¸€äº›ç¬”è®°è½¯ä»¶åœ¨å­—æ•°è¾¾åˆ°1-2wä¹‹åå°±ä¼šå‡ºç°è¾ƒä¸ºæ˜æ˜¾çš„å¡é¡¿å’Œå»¶è¿Ÿï¼Œè¿™ç§å°±ä¸äºˆè€ƒè™‘ åŒæ­¥ï¼šåŒæ­¥çš„æ–¹å¼ä¸»è¦æœ‰ä¸¤ç§ï¼Œä¸€æ˜¯ç¬”è®°ç›´æ¥äº‘ç«¯å­˜å‚¨ï¼Œå¦‚notionã€è¯­é›€ã€wolaiç­‰ã€‚å¦å¤–ä¸€ç§å½¢å¼æ˜¯æœ¬åœ°å­˜å‚¨ + äº‘ç«¯å¤‡ä»½åŒæ­¥ï¼Œä»£è¡¨æœ‰obsidianå’Œæ€æºç¬”è®°ã€‚ é’ˆå¯¹è¿™ä¸¤ä¸ªé—®é¢˜ï¼Œä¹‹å‰å¯¹å¸‚é¢ä¸Šçš„ä¸»æµç¬”è®°è½¯ä»¶éƒ½æœ‰ä½“éªŒï¼š é«˜æ€§èƒ½ï¼šTyporaï¼Œnotionã€è¯­é›€ä»¥åŠå…¶ä»–äº‘ç«¯å­˜å‚¨ç¬”è®°è½¯ä»¶ï¼Œåœ¨ç¬”è®°è§„æ¨¡è¾¾åˆ°1w-2wå·¦å³å°±å¯ä»¥æ„Ÿå—åˆ°å­˜åœ¨å»¶è¿Ÿå’Œå¡é¡¿ï¼Œå› æ­¤ä¸è€ƒè™‘ä½œä¸ºä¸»åŠ›æ¥ä½¿ç”¨ åŒæ­¥ï¼šè¿™ä¸ªæ¯”è¾ƒå¥½è§£å†³ï¼Œå¯ä»¥èŠ±é’±ä½¿ç”¨å®˜æ–¹å­˜å‚¨ï¼Œä¹Ÿå¯ä»¥è‡ªå·±ä½¿ç”¨githubæ¥è§£å†³ã€‚ Obsidian å› æ­¤ï¼Œç»¼åˆè€ƒè™‘ï¼Œæœ€ç»ˆç¬”è€…çš„é€‰æ‹©æ˜¯obsidianï¼š\nobå¯ä»¥é€‰æ‹©å¼€å¯GPUåŠ é€Ÿï¼Œæ€§èƒ½æœ‰åŸºæœ¬ä¿è¯ï¼Œå¯ä»¥å¤„ç†è¾ƒå¤§è§„æ¨¡çš„ç¬”è®° ç¬”è®°ç®¡ç†ï¼šobæ˜¯ä¸€ç§ç±»ä¼¼çŸ¥è¯†åº“çš„å½¢å¼ï¼Œé€‰æ‹©ä¸€ä¸ªç›®å½•ä½œä¸ºç©ºé—´ï¼Œä¹‹åæ‰€æœ‰ç¬”è®°éƒ½ç®¡ç†åœ¨è¿™ä¸ªç©ºé—´å†…ï¼Œè™½ç„¶ä¸æ”¯æŒåƒnoitioné‚£æ ·è¿›è¡Œç¬”è®°åµŒå¥—ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡æ–‡ä»¶å¤¹åˆ†ç±»ç®¡ç† åŒé“¾ç¬”è®°ï¼šç”¨äºè¿›è¡ŒçŸ¥è¯†ç‚¹çš„èä¼šè´¯é€š ä¸°å¯Œçš„æ’ä»¶ç”Ÿæ€ï¼ŒåŸºæœ¬èƒ½å¤Ÿæƒ³åˆ°çš„åŠŸèƒ½éƒ½æœ‰å¯¹åº”çš„æ’ä»¶æ”¯æŒ å¤–è§‚ä¸°å¯Œï¼Œå¯ä»¥è¿›è¡Œèµ›åšæš–æš– åŒæ­¥ obæœ‰å®˜æ–¹çš„åŒæ­¥æœåŠ¡ï¼Œä½†æ˜¯éœ€è¦æ”¶è´¹ã€‚ç”±äºä½¿ç”¨çš„æ˜¯mdæ–‡ä»¶å­˜å‚¨ï¼Œå› æ­¤æƒ³è¦è‡ªå·±åŒæ­¥ä¹Ÿéå¸¸ç®€å•ï¼š\nå¯¹äºæºæ–‡ä»¶ï¼Œç›´æ¥ä½¿ç”¨githubobä¹Ÿæœ‰å¯¹åº”çš„è‡ªåŠ¨commit å’Œ pushçš„æ’ä»¶ã€‚ å¯¹äºå›¾ç‰‡ï¼Œä½¿ç”¨ PicGo + å›¾åºŠï¼Œob ä¹Ÿæœ‰å¯¹åº”çš„ PicGo æ’ä»¶, æŠŠå›¾ç‰‡å¤åˆ¶åˆ°æ–‡æœ¬å½“ä¸­å°±ä¼šè‡ªåŠ¨ä¸Šä¼  + è¿”å›å¼•ç”¨é“¾æ¥ã€‚ä½¿ç”¨è…¾è®¯äº‘çš„è¯ï¼Œå¦‚æœåªä¾›è‡ªå·±è§‚çœ‹ï¼Œä¸€ä¸ªæœˆå¤§æ¦‚åªéœ€è¦å‡ åˆ†é’±ã€‚ é™¤äº†githubä¹‹å¤–ï¼Œè¿˜å¯ä»¥ç›´æ¥ä½¿ç”¨åšæœäº‘åŒæ­¥obçš„æ ¹ç›®å½•ï¼Œå¤šä¸€ä»½ä¿é™©ã€‚\nObsidian - Sharpen your thinking\næ€æºç¬”è®° åœ¨ä½¿ç”¨obä¹‹å‰ï¼Œç¬”è€…ç”¨äº†å¾ˆé•¿ä¸€æ®µæ—¶é—´çš„æ€æºç¬”è®°ï¼Œä¸ªäººè®¤ä¸ºåœ¨ä½¿ç”¨ä½“éªŒä¸Šå„æ–¹é¢éƒ½å’Œobä¸ç›¸ä¸Šä¸‹ï¼Œä¼¼ä¹æ˜¯åŸºäºelectronå®ç°çš„ï¼Œä½†æ˜¯æ€§èƒ½å‡ºå¥‡åœ°é«˜ï¼Œå·ç§°ç™¾ä¸‡çº§åˆ«çš„å­—æ•°ä¹Ÿä¸ä¼šå¡é¡¿ï¼Œæ¯”obè¿˜è¦æµç•…ã€‚å¹¶ä¸”å†…å­˜å ç”¨åªæœ‰100MBå·¦å³ã€‚åŒæ—¶ä¹Ÿæœ‰ä¸°å¯Œçš„æ’ä»¶ç³»ç»Ÿï¼Œç”šè‡³è¿˜æœ‰ï¼š ä¸è¿‡ç”±äºä¸æ˜¯ä½¿ç”¨mdå­˜å‚¨(å¯ä»¥å¯¼å‡ºä¸ºmdï¼Œä½†æ˜¯ä¸æ˜¯ç›´æ¥ä½¿ç”¨mdå­˜å‚¨)ï¼Œæ‰‹åŠ¨åŒæ­¥èµ·æ¥æ¯”è¾ƒè´¹åŠ²ï¼Œæœ€ç»ˆå’Œobçš„æ¯”è¾ƒè¿˜æ˜¯è´¥ä¸‹é˜µæ¥ï¼Œåªèƒ½å¿ç—›å‰²çˆ±äº†ã€‚å¦‚æœæ€æºæ„¿æ„ä½¿ç”¨mdè¿›è¡Œå­˜å‚¨çš„è¯ï¼Œæˆ‘è¿˜æ˜¯æ›´æ„¿æ„ä½¿ç”¨æ€æºã€‚\nSiYuan - Privacy-first personal knowledge management system that supports Markdown, block-level ref, and bidirectional links\nNotion åœ¨ä¸Šé¢çš„æ–¹æ¡ˆå½“ä¸­ï¼Œobçš„é—®é¢˜æ˜¯æ–‡ä»¶æ˜¯æœ¬åœ°å­˜å‚¨çš„ï¼Œå› æ­¤æƒ³è¦æŠŠç¬”è®°åˆ†äº«ç»™åˆ«äººæ¯”è¾ƒè´¹åŠ²ï¼Œå¯ä»¥åˆ†äº«githubçš„é“¾æ¥ï¼Œä¸è¿‡æˆ‘è®¾ç½®æˆäº†privateï¼Œæ‰€ä»¥è¿™ä¸ªå°±ä¸è¡Œäº†ã€‚å› æ­¤ï¼Œåœ¨åˆ†äº«ä¸Šæˆ‘ä½¿ç”¨notionä½œä¸ºè¡¥å……ï¼Œå¯¼å…¥èµ·æ¥ä¹Ÿæ¯”è¾ƒæ–¹ä¾¿ã€‚\nå…¶ä»– æµè§ˆå™¨ ä¸»åŠ›æ˜¯Arcï¼Œä»Šå¹´å‘ç°çš„å®è—ï¼Œæ— è®ºæ˜¯å…¶ä¾§è¾¹æ çš„ç½‘é¡µç®¡ç†è¿˜æ˜¯å„ç§å°åŠŸèƒ½éƒ½ç”¨ç€æå…¶èˆ’é€‚ã€‚ å®Œå…¨å…¼å®¹chromeç”Ÿæ€(æ¯•ç«Ÿæ˜¯åŒä¸€ä¸ªå†…æ ¸)ï¼Œå¯ä»¥æ— ç¼ä»chromeåˆ‡æ¢è¿‡æ¥ï¼Œæ’ä»¶ï¼Œå„ç±»é…ç½®ï¼Œä¸ªäººæ”¶è—ï¼Œè®°å½•çš„å¯†ç éƒ½å¯ä»¥å…¨éƒ¨å¯¼å…¥ã€‚\næ›´æ–°å¾ˆé¢‘ç¹ï¼Œæ—¶ä¸æ—¶ä¼šæ·»åŠ ä¸€äº›æ–°çš„åŠŸèƒ½ã€‚\nå¾ˆéš¾ç”¨å‡ å¥è¯å°±æŠŠArcçš„ä¼˜ç‚¹å…¨éƒ¨æè¿°æ¸…æ¥šï¼Œä¸è¿‡ä¸ªäººä½¿ç”¨ä¸‹æ¥çš„æ„Ÿè§‰å°±æ˜¯æåº¦èˆ’é€‚ï¼Œæœ€å¤§çš„é—®é¢˜æ˜¯åªç™»é™†äº†Macã€‚\näº§å“è¶‹åŠ¿02æœŸ(ä¸Š)ï½œæŒ‘æˆ˜Chromeçš„æœ€å¼ºæµè§ˆå™¨ï¼ŸArcç©¶ç«Ÿç‰›åœ¨å“ªé‡Œ - çŸ¥ä¹ Arc from The Browser Company AIåŠ©æ‰‹ ä¸»åŠ›æ˜¯GPT4ï¼Œå¦‚æœGPTæŠ½é£çš„è¯ä¼šä½¿ç”¨Kimi Chatï¼Œå„æ–¹é¢éƒ½è¿˜ä¸é”™ï¼Œæ”¯æŒæ–‡ä»¶ä¸Šä¼ å’Œè”ç½‘æœåŠ¡ï¼Œå¹¶ä¸”æœ‰æ‰‹æœºç«¯ï¼Œåœ¨æ‰‹æœºä¸Šä¸æƒ³æŒ‚æ¢¯å­çš„æ—¶å€™ä¼šç”¨ã€‚ Kimi Chat - å¸®ä½ çœ‹æ›´å¤§çš„ä¸–ç•Œ\nç»ˆç«¯ ç›®å‰æ˜¯Iterm2å’ŒWarpæ··ç”¨ï¼Œä½¿ç”¨ä½“éªŒéƒ½ä¸é”™ï¼ŒWarpåœ¨å‘½ä»¤è¡¥å…¨å’Œæç¤ºä¸Šæ•ˆæœæ›´å¥½ï¼Œå¹¶ä¸”é›†æˆäº†AIï¼ŒIterm2å°±æ˜¯æ›´åŠ è½»é‡ä¸€äº›ï¼Œå¦‚æœæƒ³è¡¥å…¨çš„è¯å¯ä»¥ä½¿ç”¨Figã€‚\nIterm2å’ŒWarpç›®å‰åªç™»é™†äº†Macï¼Œæ¯”è¾ƒé—æ†¾\nFig\nå¾ˆå¥½ç”¨çš„è¡¥å…¨åŠŸèƒ½ï¼Œæ”¯æŒiterm2,vscodeå’Œjetbrainçš„å†…ç½®ç»ˆç«¯ï¼Œä¸è¿‡é—®é¢˜åŒæ ·æ˜¯åªç™»é™†äº†Macã€‚æ•ˆæœå¦‚ä¸‹ï¼Œç»å¤§å¤šæ•°çš„å‘½ä»¤éƒ½æœ‰æ”¯æŒã€‚ Shell oh-my-zshï¼Œmacå’Œlinuxä¸Šéƒ½æ˜¯ï¼Œè¿™ä¸ªæ²¡ä»€ä¹ˆå¥½è¯´çš„ã€‚\nåŒæ­¥ ç›®å‰éƒ½äº¤ç»™åšæœäº‘äº†ï¼Œè¢«åšæœäº‘æ¡ä½äº†å‘½è„‰\n","permalink":"https://fischer0522.github.io/en/posts/life/cs%E7%A7%91%E7%A0%94%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7%E9%93%BE%E5%88%86%E4%BA%AB/","summary":"å·®ç”Ÿæ–‡å…·å¤šç³»åˆ— CSæ–¹å‘ï¼Œä¸ªäººç§‘ç ” + å¼€å‘å·¥å…·é“¾åˆ†äº«ï¼Œä¸»è¦æ¶‰åŠåˆ°æ–‡çŒ®é˜…è¯»ã€ä»£ç ç¼–è¾‘ã€ç¬”è®°ç­‰å†…å®¹ æ–‡çŒ®é˜…è¯» Zotero é›†æ–‡ä»¶ç®¡ç†ã€é˜…è¯»ã€è®°å½•ä¸ºä¸€ä½“ï¼ŒåŸºæœ¬å¯ä»¥è§£","title":"æ„å»ºè‡ªå·±çš„çŸ¥è¯†åº“ï¼šç§‘ç ”/å¼€å‘å·¥å…·é“¾"},{"content":"åˆ†å¸ƒå¼ç³»ç»Ÿæ¨¡å‹ æ‹œå åº­å°†å†›é—®é¢˜ æ‹œå åº­å°†å†›ä¸»è¦ç”¨äºè§£å†³å…±è¯†é—®é¢˜ï¼Œä¸‰ä¸ªå°†å†›å†³å®šæ”»æ‰“æ‹œå åº­ï¼Œåªæœ‰ä¸‰ä¸ªäººä¸€åŒè¿›è¡Œæ”»æ‰“æ‰èƒ½å¤ŸæˆåŠŸï¼Œå¦åˆ™åˆ™ä¼šå¤±è´¥ï¼Œå› æ­¤éœ€è¦ä¸‰è€…ä¹‹é—´é€šè¿‡ä¿¡ä½¿æ¥è¿›è¡Œé€šä¿¡ï¼Œä»¥æ±‚è¾¾æˆå…±è¯†ï¼Œæ•´ä¸ªç³»ç»Ÿæ˜¯å¤„äºä¸ä¿¡ä»»çŠ¶æ€çš„ï¼Œå³å°†å†›å¯èƒ½ä¼šæ˜¯å›å¾’ï¼Œå‘å…¶ä»–çš„å°†å†›ä¼ é€’é”™è¯¯çš„ä¿¡æ¯ï¼Œä¿¡ä½¿ä¹Ÿæ˜¯ä¸å¯é çš„ï¼Œå¯èƒ½ä¼šè¢«ä¿˜è™æˆ–è€…æ•°æ®ä¸ºå‡ã€‚\nå°†å†›å³å¯¹åº”åˆ†å¸ƒå¼ç³»ç»Ÿå½“ä¸­çš„èŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹ä¸ä»…ä¼šå‘ç”Ÿæ•…éšœæˆ–è€…å®•æœºï¼Œå…¶ä¸­ä¼šæœ‰ä¸€äº›èŠ‚ç‚¹ä¸ºå›å¾’ï¼Œå¯èƒ½æ¶æ„ç¯¡æ”¹å’Œä¼ æ’­é”™è¯¯ä¿¡æ¯ï¼Œä¿¡ä½¿å³å¯¹åº”ç€ç½‘ç»œé€šä¿¡ï¼Œåœ¨æ­¤æ¡ä»¶ä¸‹ç½‘ç»œé€šä¿¡ä¹Ÿä¸ºä¸å¯é çš„ã€‚ ç³»ç»Ÿæ¨¡å‹åˆ†ç±» ç½‘ç»œé“¾è·¯æ¨¡å‹ å¯é é“¾è·¯ ï¼šå¯é ä¼ é€’ï¼Œæ²¡æœ‰é‡å¤ï¼Œä¸ä¼šæ— ä¸­ç”Ÿæœ‰ï¼Œä½†æ˜¯å¯¹äºæ¶ˆæ¯å¯èƒ½ä¼šå‡ºç°æ’åº å…¬å¹³æŸå¤±é“¾è·¯ï¼š å…¬å¹³æŸå¤±ï¼šå¦‚æœå‘é€æ–¹å’Œæ¥æ”¶æ–¹éƒ½æ­£å¸¸è¿è¡Œï¼Œå‘é€æ–¹ä¸æ–­è¿›è¡Œå°è¯•ï¼Œæ¶ˆæ¯æœ€ç»ˆä¼šé€è¾¾ æœ‰é™é‡å¤ï¼šæ¶ˆæ¯åªä¼šé‡å¤å‘é€æœ‰é™æ¬¡ ä¸ä¼šæ— ä¸­ç”Ÿæœ‰ ä»»æ„é“¾è·¯ï¼šæœ€å¼±çš„ç½‘ç»œæ¨¡å‹ï¼Œå…è®¸ä»»æ„çš„ç½‘ç»œé“¾è·¯æ‰§è¡Œä»»ä½•çš„æ“ä½œï¼Œå¯èƒ½ä¼šæœ‰è½¯ä»¶æ¶æ„ç¯¡æ”¹æ•°æ®åŒ… èŠ‚ç‚¹æ•…éšœæ¨¡å‹ å´©æºƒ-åœæ­¢(fail-stop) ï¼šä¸€ä¸ªèŠ‚ç‚¹åœæ­¢å·¥ä½œåå°±æ°¸è¿œä¸ä¼šæ¢å¤ å´©æºƒ-æ¢å¤(fail-recover):å…è®¸èŠ‚ç‚¹é‡å¯åç»§ç»­æ‰§è¡Œå‰©ä½™çš„æ­¥éª¤ï¼Œä¸€èˆ¬é€šè¿‡æŒä¹…åŒ–å­˜å‚¨çš„æ–¹å¼ æ‹œå åº­æ•…éšœï¼šæ•…éšœèŠ‚ç‚¹ä¸æ­¢ä¼šå½“æœºï¼Œè¿˜æœ‰å¯èƒ½ä»¥ä»»æ„æ–¹å¼åç¦»ç®—æ³•ï¼Œç”šè‡³æ¶æ„ç ´åç³»ç»Ÿ æ—¶é—´åˆ’åˆ† å¯ä»¥åˆ†ä¸ºåŒæ­¥å’Œå¼‚æ­¥ï¼š\nåŒæ­¥æŒ‡ä¸€ä¸ªæ¶ˆæ¯çš„å“åº”æ—¶é—´åœ¨æœ‰é™ä¸”å·²çŸ¥çš„ä¸€ä¸ªæ—¶é—´èŒƒå›´å†… å¼‚æ­¥çš„æ¶ˆæ¯çš„å“åº”æ—¶é—´ä¸ºæ— é™çš„ï¼Œä¸çŸ¥é“å…·ä½“çš„æ¶ˆæ¯åˆ°è¾¾æ—¶é—´ åˆ†å¸ƒå¼ç³»ç»Ÿæ•°æ®åŸºç¡€ æ°´å¹³åˆ†åŒºç®—æ³• èŒƒå›´åˆ†åŒº\næ ¹æ®æŒ‡å®šçš„å…³é”®å­—æ‹†åˆ†æˆè‹¥å¹²è¿ç»­èŒƒå›´ï¼Œé—®é¢˜æ˜¯æ— æ³•å¯¹äºåˆ†åŒºå…³é”®å­—ä»¥å¤–çš„å…³é”®å­—è¿›è¡ŒèŒƒå›´æŸ¥è¯¢ï¼Œæ•°æ®æœ¬èº«åˆ†å¸ƒä¸å‡æ—¶å®¹æ˜“é€ æˆæŸäº›èŠ‚ç‚¹è´Ÿè½½è¾ƒé«˜\nå“ˆå¸Œåˆ†åŒº\nå¯¹æŒ‡å®šå…³é”®å­—ä½¿ç”¨å“ˆå¸Œå‡½æ•°è¿›è¡Œåˆ†åŒºï¼Œä¼ ç»Ÿçš„å“ˆå¸Œå‡½æ•°çš„é—®é¢˜å¦‚æœæ·»åŠ æ–°çš„åˆ†åŒºåˆ™éœ€è¦å¯¹åŸæœ¬æ‰€æœ‰çš„æ•°æ®è¿›è¡Œå…¨éƒ¨rehashï¼Œå¯¹äºhashtableæ¥è¯´ï¼Œå¯ä»¥ä½¿ç”¨å¯æ‰©å±•å“ˆå¸Œè¡¨çš„æ–¹å¼é™ä½æ‰©å±•çš„è´Ÿè½½ã€‚ä½†æ˜¯æ­¤å¤„åªæ˜¯ä½¿ç”¨äº†å“ˆå¸Œå‡½æ•°ï¼Œå› æ­¤éœ€è¦å¯¹å“ˆå¸Œå‡½æ•°è¿›è¡Œæ”¹è¿›é‡‡ç”¨ä¸€è‡´æ€§å“ˆå¸Œ\nä¸€è‡´æ€§å“ˆå¸Œ\nå°†æ•´ä¸ªå“ˆå¸Œå€¼æŠ½è±¡æˆä¸€ä¸ªåœ†ç¯ï¼Œè€ŒèŠ‚ç‚¹åˆ†å¸ƒåœ¨åœ†ç¯ä¸Šï¼Œæ•°æ®å­˜å‚¨åœ¨æŒ‰ç…§é¡ºæ—¶é’ˆæ–¹å‘é‡åˆ°çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ä¸Šï¼Œæ­¤æ—¶å¦‚æœæ·»åŠ æˆ–è€…ç§»é™¤ä¸€ä¸ªèŠ‚ç‚¹ï¼Œåªä¼šæœ‰ç›¸é‚»çš„å¦å¤–ä¸€ä¸ªèŠ‚ç‚¹æ”¶åˆ°å½±å“ï¼Œé¿å…çš„å…¨å±€rehash ä¸€è‡´æ€§å“ˆå¸ŒåŒæ ·å­˜åœ¨æ•°æ®å€¾æ–œçš„é—®é¢˜ï¼Œå³å¦‚æœä¸€ä¸ªèŠ‚ç‚¹ä¸‹çº¿ï¼Œå…¶å­˜å‚¨çš„æ•°æ®ä¼šå…¨éƒ¨è½¬ç§»åˆ°ç›¸é‚»èŠ‚ç‚¹ï¼Œå¯¼è‡´è¯¥èŠ‚ç‚¹çš„è´Ÿè½½è¿‡é«˜ï¼Œè§£å†³æ–¹æ³•å³ä¸ºé‡‡ç”¨è™šæ‹ŸèŠ‚ç‚¹çš„æ–¹å¼ï¼Œä¸€ä¸ªç‰©ç†èŠ‚ç‚¹å¯¹åº”å¤šä¸ªè™šæ‹ŸèŠ‚ç‚¹ï¼Œä½¿æ•°æ®åˆ†å¸ƒæ›´åŠ å‡åŒ€ã€‚ å¤åˆ¶ å•ä¸»å¤åˆ¶ æ•°æ®é¦–å…ˆå†™å…¥åˆ°ä¸»èŠ‚ç‚¹ä¸Šï¼Œä¹‹åå†ç”±ä¸»èŠ‚ç‚¹å¤åˆ¶åˆ°ä»èŠ‚ç‚¹ä¸Šï¼Œè¿™ä¸ªè¿‡ç¨‹å¯ä»¥ä¸ºåŒæ­¥çš„ï¼Œä¹Ÿå¯ä»¥ä¸ºå¼‚æ­¥çš„ï¼ŒåŒæ­¥å¯ä»¥ä¿è¯ä»èŠ‚ç‚¹ä¸€å®šèƒ½å¤Ÿè¯»å–åˆ°æœ€æ–°çš„æ¶ˆæ¯ï¼Œä½†æ˜¯å¯¹å®¢æˆ·ç«¯çš„å“åº”é€Ÿåº¦å°±å‡æ…¢ï¼Œå³å½±å“å†™è¯·æ±‚çš„æ€§èƒ½ï¼Œå¼‚æ­¥åˆ™ä»¥ç‰ºç‰²æ•°æ®ä¸€è‡´æ€§å’ŒæŒä¹…æ€§æ¥æ¢å–å“åº”é€Ÿåº¦ã€‚\næ­¤å¤–è¿˜æœ‰åŠåŒæ­¥çš„æ–¹å¼ï¼Œå³å¯¹äºä¸€ä¸ªèŠ‚ç‚¹é‡‡ç”¨åŒæ­¥çš„æ–¹å¼ï¼Œå…¶ä»–çš„èŠ‚ç‚¹ä¸ºå¼‚æ­¥çš„æ–¹å¼ï¼Œè¿™æ ·å¯ä»¥ä¸€å®šç¨‹åº¦ä¸Šä¿è¯å“åº”é€Ÿåº¦ï¼Œå¹¶ä¸”åœ¨ä¸»èŠ‚ç‚¹å½“æœºä¹‹åä¸€å®šæœ‰ä¸€ä¸ªå’Œä¸»èŠ‚ç‚¹å®Œå…¨ä¸€è‡´çš„ä»èŠ‚ç‚¹èƒ½å¤Ÿç›´æ¥é¡¶æ›¿ä¸»èŠ‚ç‚¹ã€‚\nå•ä¸»å¤åˆ¶çš„æ€§èƒ½ç“¶é¢ˆä¸ºåªæœ‰ä¸€ä¸ªä¸»èŠ‚ç‚¹æ¥å“åº”å†™è¯·æ±‚ã€‚\nå¤šä¸»å¤åˆ¶ é€šè¿‡å¤šä¸ªä¸»èŠ‚ç‚¹æ¥æ¥å—å†™å…¥è¯·æ±‚ä»¥æå‡å†™æ€§èƒ½ï¼Œæ˜¾è€Œæ˜“è§ä¼šå¸¦æ¥å†²çªé—®é¢˜ï¼Œä¸»è¦è§£å†³æ–¹å¼æœ‰ï¼š\nå®¢æˆ·ç«¯è§£å†³ï¼Œäº§ç”Ÿå†²çªæ—¶ï¼Œå°†æ‰€æœ‰çš„å†²çªæ•°æ®è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œç”±å®¢æˆ·ç«¯é€‰æ‹©åˆé€‚çš„æ•°æ® æœ€åå†™å…¥èƒœåˆ©ï¼Œé€šè¿‡æ¯æ¡è¯·æ±‚ä¸Šæºå¸¦çš„æ—¶é—´æˆ³æˆ–è€…è‡ªå¢ID å› æœå…³ç³»è·Ÿè¸ªï¼šhappen - before æ— ä¸»å¤åˆ¶ å¹³ç­‰çš„å¯¹å¾…æ¯ä¸ªèŠ‚ç‚¹ï¼Œæ¯æ¬¡å†™å…¥å°è¯•å‘æ‰€æœ‰çš„èŠ‚ç‚¹è¿›è¡Œå†™å…¥ï¼Œè¯»å–ä¹Ÿå¯¹æ‰€æœ‰çš„èŠ‚ç‚¹è¿›è¡Œè¯»å–ã€‚åŸºäºå¤§å¤šæ•°åŸç†ï¼Œå³å¯¹äºNä¸ªèŠ‚ç‚¹çš„æƒ…å†µï¼Œå¦‚æœ$W + R \u0026gt; N$ åˆ™å¯ä»¥ä¿è¯è¯»ä¸å†™ä¹‹é—´å­˜åœ¨ä¸€ä¸ªäº¤é›†ï¼Œä»è€Œä¿è¯æ–°å†™å…¥çš„æ•°æ®ä¸€å®šèƒ½å¤Ÿè¢«è¯»å–åˆ°ã€‚\nåœ¨è¯¥é…ç½®ä¸‹ï¼Œå¦‚æœä¸€æ¬¡å†™å…¥æœ‰Wä¸ªèŠ‚ç‚¹ç»™äºˆå“åº”å³è®¤å®šå†™å…¥æˆåŠŸï¼Œè¯»å–ä¹Ÿå‘é€ç»™å¤šä¸ªèŠ‚ç‚¹ï¼Œç”±äºå­˜åœ¨å†²çªé—®é¢˜ï¼Œå®¢æˆ·ç«¯æ ¹æ®è¯»å–åˆ°çš„ç‰ˆæœ¬å·æ¥è§£å†³å†²çªï¼Œé‡‡ç”¨ç‰ˆæœ¬å·æœ€æ–°çš„æ•°æ®ä½œä¸ºç»“æœ\né™¤äº†$W + R \u0026gt; N$ä¹‹å¤–ï¼Œè¿˜éœ€è¦$W \u0026gt; N/2$ ,æ¥ä¿è¯æ•°æ®çš„ä¸²è¡ŒåŒ–ä¿®æ”¹ï¼Œå³ä¸¤ä¸ªä¸åŒçš„å†™è¯·æ±‚ä¸èƒ½å¤ŸåŒæ—¶æˆåŠŸä¿®æ”¹åŒä¸€ä»½æ•°æ®ã€‚æ¯æ¬¡å†™å…¥è¦æ±‚å†™å…¥å¤§å¤šæ•°å³å¯ä¿è¯ä¸¤æ¬¡å†™å…¥ä¹‹é—´å­˜åœ¨ä¸€ä¸ªäº¤é›†ï¼Œä»è€Œå‘ç°å†²çªã€‚ä½†æ˜¯å³ä¾¿$W \u0026lt; N/2$çš„è¯ï¼Œé‚£ä¹ˆå°±æ„å‘³ç€$R \u0026gt; N/2$ï¼Œé‚£ä¹ˆåœ¨ä¸€æ¬¡æ£€ç´¢è¿‡ç¨‹å½“ä¸­å°±ä¸€å®šèƒ½å¤Ÿå‘ç°å†²çªçš„æ•°æ®ï¼Œæ­¤æ—¶å¯ä»¥æ ¹æ®æ—¶é—´æˆ³æ¥è¿›è¡Œä¿®å¤ï¼Œä¿ç•™æœ€æ–°çš„æ•°æ®\nCAPå®šç† åœ¨ä¸€ä¸ªå¼‚æ­¥çš„ç½‘ç»œç¯å¢ƒä¸­ï¼Œå¯¹äºä¸€ä¸ªåˆ†å¸ƒå¼è¯»å†™å­˜å‚¨ç³»ç»Ÿï¼Œåªèƒ½æ»¡è¶³ä¸€ä¸‹ä¸‰ä¸ªç‰¹æ€§ä¹‹äºŒ\nä¸€è‡´æ€§(Consistency) å¯ç”¨æ€§(Availability) åˆ†åŒºå®¹é”™æ€§(Partition Tolerance) ä¸€è‡´æ€§ä¸ºå®¢æˆ·ç«¯è¿›è¡Œä¸€æ¬¡è¯»å–ï¼Œæ€»èƒ½ç»™è·å–åˆ°æœ€æ–°çš„æ•°æ®ï¼ˆä¸æ•°æ®åº“ä¸€è‡´æ€§è¿›è¡ŒåŒºåˆ†ï¼‰å¯ç”¨æ€§ä¸ºæ¯æ¬¡è¯·æ±‚éƒ½èƒ½è·å¾—ä¸€ä¸ªéé”™è¯¯çš„å“åº”ï¼Œä½†ä¸ä¿è¯è·å–çš„æ•°æ®ä¸ºæœ€æ–°çš„ã€‚åˆ†åŒºå®¹é”™æ€§ä¸ºèŠ‚ç‚¹ç”±äºç½‘ç»œåˆ†åŒºè€Œå¯¼è‡´æ¶ˆæ¯ä¸¢å¤±çš„æƒ…å†µä¸‹ï¼Œç³»ç»Ÿä»èƒ½æ­£å¸¸è¿è¡Œã€‚ CAPä¸‰è§’é€šå¸¸æŒ‡çš„æ˜¯ä¸‰è€…æ— æ³•å¾—å…¼ï¼Œåªèƒ½é€‰å…¶ä¸­ä¹‹äºŒï¼Œä½†æ˜¯å¯¹äºå®é™…çš„åº”ç”¨ï¼Œæ‰€æœŸå¾…çš„æ˜¯å…¶èƒ½å¤ŸæŠµæŠ—ç½‘ç»œåˆ†åŒºï¼Œå› æ­¤CAPåˆå¯ä»¥è¡¨è¿°ä¸ºåœ¨å‡ºç°ç½‘ç»œåˆ†åŒºæ—¶ä¿è¯åˆ†åŒºå®¹é”™æ€§æƒ…å†µä¸‹ï¼Œæ˜¯è¦æ±‚ä¸€è‡´æ€§è¿˜æ˜¯è¦æ±‚å¯ç”¨æ€§ã€‚\nåä¹‹åˆ™ä¸ºå¦‚æœä¸å‡ºç°ç½‘ç»œåˆ†åŒºï¼Œåˆ™å¯ä»¥åŒæ—¶ä¿è¯ä¸€è‡´æ€§å’Œå¯ç”¨æ€§\nä¸€è‡´æ€§æ¨¡å‹ ä¸€è‡´æ€§æ¨¡å‹é¦–å…ˆéœ€è¦ä¸æ•°æ®åº“çš„ä¸€è‡´æ€§çº¦æŸè¿›è¡ŒåŒºåˆ†ã€‚å…¶æ¬¡ï¼Œä¸€è‡´æ€§çš„æ¦‚å¿µä¹Ÿä¸æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿå½“ä¸­ç‹¬æœ‰çš„ï¼Œï¼ˆå†…å­˜ä¸€è‡´æ€§ï¼‰å…·ä½“æ¥è¯´æŒ‡çš„æ˜¯ï¼šåœ¨å¹¶å‘ç¼–ç¨‹ä¸­ï¼Œç³»ç»Ÿå’Œå¼€å‘è€…ä¹‹é—´çš„ä¸€ç§çº¦å®šï¼Œå¦‚æœåœ¨å¼€å‘è¿™éµå¾ªçº¦å®šï¼Œåˆ™æ‰§è¡Œè¯»æ“ä½œæˆ–æ–œæ“ä½œçš„ç»“æœæ˜¯å¯é¢„æµ‹çš„ã€‚\nçº¿æ€§ä¸€è‡´æ€§ æœ€å¼ºçš„ä¸€è‡´æ€§çº§åˆ«ï¼Œé€šå¸¸å¯ä»¥ä½¿ç”¨Linearizabilityè¡¨è¿°ï¼Œçº¿æ€§ä¸€è‡´æ€§çš„ç›´è§‚ç†è§£æˆ–è€…è¯´éä¸¥æ ¼å®šä¹‰å¯ä»¥è¡¨è¿°ä¸ºæ‰€æœ‰æ“ä½œçœ‹èµ·æ¥ä¸ºåŸå­çš„ï¼Œæ•´ä¸ªç³»ç»Ÿçœ‹èµ·æ¥åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹ã€‚\nçº¿æ€§ä¸€è‡´æ€§çš„ä¸¥æ ¼å®šä¹‰ä¸ºï¼šç»™å®šä¸€ä¸ªæ‰§è¡Œç†äº‹ï¼Œæ‰§è¡Œå†å²æ ¹æ®å¹¶å‘æ“ä½œå¯ä»¥æ‰©å±•ä¸ºå¤šä¸ªé¡ºåºå†å²ï¼Œåªè¦ä»å½“ä¸­æ‰¾åˆ°ä¸€ä¸ªåˆæ³•çš„é¡ºåºå†å²ï¼Œé‚£ä¹ˆè¯¥æ‰§è¡Œç†äº‹å°±æ˜¯çº¿æ€§ä¸€è‡´æ€§çš„ã€‚\nåœ¨æ‰§è¡Œå†å²å½“ä¸­åˆå¯ä»¥åˆ†ä¸ºé¡ºåºçš„å’Œå¹¶å‘çš„ï¼Œé¡ºåºåˆ™ä¸ºæ—¶é—´Açš„ç»“æŸæ—¶é—´æ—©äºæ—¶é—´Bçš„å¼€å§‹æ—¶é—´ï¼Œè€Œå¹¶å‘åˆ™æ˜¯ä¸¤ä¸ªæ—¶é—´å½“ä¸­å­˜åœ¨é‡å çš„éƒ¨åˆ†ã€‚åœ¨ç”Ÿæˆé¡ºåºå†å²æ—¶ï¼Œé¡ºåºå…³ç³»å¿…é¡»ç”±å…ˆå‘ç”Ÿçš„æŒ‡å‘åå‘ç”Ÿçš„ï¼Œè€Œå¹¶å‘çš„åˆ™å¯ä»¥è¿›è¡Œç¼–æ’ï¼Œæœ€åå¦‚æœèƒ½å¤Ÿè·å–åˆ°ä¸€ä¸ªè¯»å†™è¯·æ±‚éƒ½åˆæ³•çš„é¡ºåºå†å²ï¼Œåˆ™ç§°å…¶ä¸ºçº¿æ€§ä¸€è‡´æ€§çš„ã€‚\nçº¿æ€§ä¸€è‡´æ€§æœ€å›°éš¾çš„å°±æ˜¯éœ€è¦ä¸€ä¸ªå…¨å±€æ—¶é’Ÿï¼Œä»è€Œæ¥ç¡®å®šæ—¶é—´å‘ç”Ÿçš„æ—¶é—´é¡ºåº\né¡ºåºä¸€è‡´æ€§ åªè¦æ±‚ä¸€ä¸ªå®¢æˆ·ç«¯çš„æ“ä½œåœ¨æ’åºåä¿æŒé¡ºåºä¸å˜ï¼Œä¸åŒå®¢æˆ·ç«¯ä¹‹é—´çš„å…ˆåé¡ºåºå¯ä»¥ä»»æ„æ”¹å˜ã€‚é€šè¿‡æ”¹å˜é¡ºåºä¹‹åï¼Œå¯ä»¥å¾—åˆ°ä¸€ä¸ªåˆä¹é€»è¾‘çš„é¡ºåºå†å²ã€‚\nç”±äºå„ä¸ªå®¢æˆ·ç«¯ä¹‹é—´çš„é¡ºåºå¯ä»¥æ”¹å˜ï¼Œå› æ­¤æ²¡æœ‰å…¨å±€æ—¶é’Ÿçš„é™åˆ¶ã€‚\nåœ¨ä¸€ä¸ªç¤¾äº¤ç½‘ç»œåº”ç”¨å½“ä¸­ï¼Œé€šå¸¸ä¸å…³å¿ƒçœ‹åˆ°çš„æ‰€æœ‰æœ‹å‹çš„å¸–å­çš„é¡ºåºï¼Œä½†æ˜¯å¯¹äºæŸä¸ªå…·ä½“çš„æœ‹å‹ï¼Œä»¥æ­£ç¡®çš„é¡ºåºå»æ˜¾ç¤ºæ›´åŠ ç¬¦åˆé€»è¾‘æ€§ã€‚\nå› æœä¸€è‡´æ€§ è¦æ±‚å¿…é¡»ä»¥ç›¸åŒçš„é¡ºåºçœ‹åˆ°å› æœç›¸å…³çš„æ“ä½œï¼Œæ²¡æœ‰å› æœå…³ç³»çš„å¹¶å‘æ“ä½œå¯ä»¥è¢«ä¸åŒçš„è¿›ç¨‹ä»¥ä¸åŒçš„é¡ºåºè§‚å¯Ÿåˆ°ã€‚å¦‚å…ˆå‘å¸–æ‰èƒ½æœ‰è¯¥å¸–å­çš„è¯„è®ºä½“ç°äº†å‘ç”Ÿäº\u0026hellip;..ä¹‹å‰(Happens-Before)å…³ç³»ã€‚\næœ€ç»ˆä¸€è‡´æ€§ åœ¨æŸä¸ªé˜¶æ®µï¼Œç³»ç»Ÿä¸ªèŠ‚ç‚¹å¤„ç†å®¢æˆ·ç«¯çš„æ“ä½œé¡ºåºå¯ä»¥ä¸åŒï¼Œè¯»æ“ä½œä¹Ÿä¸éœ€è¦è¿”å›æœ€æ–°çš„å†™æ“ä½œçš„ç»“æœã€‚\nåªè¦åœ¨æœ€ç»ˆçš„çŠ¶æ€ä¸‹ï¼Œå³ä¸å†æ‰§è¡Œå†™æ“ä½œï¼Œè¯»æ“ä½œå°†è¿”å›ç›¸åŒçš„ï¼Œæœ€æ–°çš„ç»“æœã€‚\nä»¥å®¢æˆ·ç«¯ä¸ºä¸­å¿ƒçš„ä¸€è‡´æ€§æ¨¡å‹ å³ä¸å…³æ³¨å¤šä¸ªå®¢æˆ·ç«¯æ“ä½œçš„å¹¶å‘ç»“æœï¼Œåªç«™åœ¨å•ä¸€å®¢æˆ·ç«¯çš„è§’åº¦ä¸Šè¿›è¡Œåˆ†æï¼Œå¯ä»¥åˆ†ä¸ºï¼š\nå•è°ƒè¯»ï¼šå¦‚æœå®¢æˆ·ç«¯è¯»åˆ°å…³é”®å­—xçš„å€¼vï¼Œé‚£ä¹ˆä¹‹åçš„è¯»å–åªèƒ½å¤Ÿè¯»å–åˆ°æ¯”væ›´æ–°çš„å€¼ å•è°ƒå†™ï¼šåŒä¸€ä¸ªå®¢æˆ·ç«¯çš„å†™æ“ä½œåœ¨ä¸åŒçš„å‰¯æœ¬ä¸Šå¿…é¡»ä»¥åŒæ ·çš„é¡ºåºæ‰§è¡Œ è¯»ä½ æ‰€å†™(Read Your Write):å†™æ“ä½œå®Œæˆåï¼ŒåŒä¸€å‰¯æœ¬æˆ–è€…å…¶ä»–å‰¯æœ¬ä¸Šçš„è¯»æ“ä½œå¿…é¡»èƒ½å¤Ÿè¯»å–åˆ°å†™å…¥çš„å€¼ PRAM(Pipelined RAM):ä¹Ÿç§°ä¸ºFIFOä¸€è‡´æ€§ï¼ŒåŒä¸€ä¸ªå®¢æˆ·ç«¯çš„å¤šä¸ªå†™æ“ä½œï¼Œå°†è¢«æ‰€æœ‰çš„å‰¯æœ¬æŒ‰ç…§åŒæ ·çš„æ‰§è¡Œé¡ºåºè§‚å¯Ÿåˆ° è¯»åå†™(Write Follow Read)ï¼šå¦‚æœå…ˆè¯»åˆ°äº†å†™æ“ä½œw1çš„ç»“æœvï¼Œé‚£ä¹ˆä¸€å‘¨çš„å†™æ“ä½œw2ä¿è¯ç»™äºˆvæˆ–æ¯”væ›´æ–°çš„å€¼ åˆ†å¸ƒå¼å…±è¯† çŠ¶æ€æœº çŠ¶æ€æœºåŒ…å«ä¸€ç»„çŠ¶æ€ã€ä¸€ç»„è¾“å…¥ï¼Œä¸€ç»„è¾“å‡ºï¼Œä¸€ä¸ªè½¬æ¢å‡½æ•°å’Œä¸€ä¸ªè¾“å‡ºå‡½æ•°ï¼Œå’Œä¸€ä¸ªç‹¬ç‰¹çš„åˆå§‹çŠ¶æ€ã€‚çŠ¶æ€æœºä»åˆå§‹çŠ¶æ€å¼€å§‹ï¼Œæ¯ä¸ªè¾“å…¥éƒ½è¢«ä¼ å…¥è½¬æ¢å‡½æ•°å’Œè¾“å‡ºå‡½æ•°ï¼Œäº§ç”Ÿä¸€ä¸ªæ–°çš„çŠ¶æ€å’Œè¾“å‡ºï¼Œåœ¨æ”¶åˆ°æ–°çš„è¾“å…¥å‰ï¼ŒçŠ¶æ€æœºçš„çŠ¶æ€ä¿æŒä¸å˜ã€‚\nå¯¹äºå…±è¯†ï¼Œå°±æ˜¯åœ¨ä¸€ä¸ªå¯èƒ½å‡ºç°ä»»æ„æ•…éšœçš„åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„å¤šä¸ªèŠ‚ç‚¹å¯¹æŸä¸ªå€¼è¾¾æˆå…±è¯†ã€‚ç”±äºçŠ¶æ€æœºçš„ç‰¹æ€§ï¼Œè¿™ä¸ªé—®é¢˜å¯ä»¥å¾ˆå¥½çš„ä½¿ç”¨çŠ¶æ€è¿›è¡Œè§£å†³ï¼š\né‡‡ç”¨æ—¥å¿—ä½œä¸ºè¾“å…¥ï¼Œä»ç›¸åŒçš„ä½ç½®ä»¥ç›¸åŒçš„é¡ºåºè¯»å–æ—¥å¿—å†…å®¹å¹¶æ‰§è¡Œï¼Œåˆ™ä¼šäº§ç”Ÿç›¸åŒçš„è¾“å‡ºï¼Œç»“æŸåœ¨ç›¸åŒçš„çŠ¶æ€ä¸Šï¼Œå¤‡ä»½åˆ°ä¸åŒçš„èŠ‚ç‚¹ä¸Šå¹¶è¾“å…¥ç»™çŠ¶æ€æœºï¼Œä»è€Œå³å¯ä½¿ä»èŠ‚ç‚¹è¾¾åˆ°å’Œä¸»èŠ‚ç‚¹ä¸€æ ·çš„çŠ¶æ€ã€‚\nPaxos åŸºæœ¬æ¦‚å¿µ æ¯ä¸ªèŠ‚ç‚¹é€šè¿‡ææ¡ˆ(proposal)çš„æ–¹å¼æ¥æ¨è¿›çŠ¶æ€çš„æ”¹å˜ï¼Œå› æ­¤æ¯ä¸ªææ¡ˆéœ€è¦ææ¡ˆç¼–å·(proposal number)å’Œææ¡ˆå€¼(proposal value)\npaxosé€šè¿‡è½®æ¬¡+æœåŠ¡å™¨idçš„å½¢å¼æ¥ç»„æˆä¸€ä¸ªå”¯ä¸€çš„ææ¡ˆå€¼ï¼Œå³\u0026lt;n,server_id\u0026gt;ï¼Œpaxosè§£å†³å†²çªçš„æ–¹æ³•å³ä¸ºæ ¹æ®æè®®å·çš„å¤§å°ï¼Œå¯¹åŒä¸€ä¸ªå€¼åªæ¥å—ç¬¬ä¸€æ¬¡çš„æè®®\nç®—æ³•è§’è‰²ï¼š\nå®¢æˆ·ç«¯ï¼šå®¢æˆ·ç«¯å‘åˆ†å¸ƒå¼ç³»ç»Ÿå‘èµ·ä¸€ä¸ªè¯·æ±‚ï¼Œå¹¶ç­‰å¾…å›åº” æè®®è€…(Proposer)ï¼šæè®®è€…æ”¶åˆ°å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œæå‡ºç›¸å…³çš„ææ¡ˆï¼Œè¯•å›¾è®©æ¥æ”¶è€…å»æ¥å—ææ¡ˆ æ¥æ”¶è€…(Accepter)ï¼šä¹Ÿå«æŠ•ç¥¨è€…(Voters)ï¼ŒæŠ•ç¥¨æ¥å—æˆ–è€…æ‹’ç»æè®®è€…çš„ææ¡ˆï¼Œå¦‚æœè¶…è¿‡åŠæ•°æ¥å—ç€æ¥å—ï¼Œåˆ™ææ¡ˆæ‰¹å‡† å­¦ä¹ è€…ï¼šä¸å‚ä¸å†³è®®ææ¡ˆï¼Œåªå­¦ä¹ ææ¡ˆå€¼å¹¶æ‰§è¡Œ ç®—æ³•æµç¨‹ è¿™é‡Œè®¨è®ºBasic Paxosï¼Œåªé’ˆå¯¹ä¸€ä¸ªå€¼è¾¾æˆå…±è¯†ï¼Œè€Œä¸æ˜¯åƒrafté‚£æ ·è¿›è¡Œå®Œæ•´çš„æ—¥å¿—å¤åˆ¶ï¼Œå³æŒ‡å¯¹ä¸€ä¸ªæ—¥å¿—çš„entryè¿›è¡Œå…±è¯†ï¼Œå¦‚æœæƒ³è¦å®ç°å¦‚raftçš„æ•ˆæœï¼Œéœ€è¦ä½¿ç”¨multi paxosï¼Œä½†æ˜¯multi paxosä¸raftè¿˜å­˜åœ¨ç€ä¸€ç‚¹å·®åˆ«ã€‚\nç¬¬ä¸€é˜¶æ®µ\nç¬¬ä¸€é˜¶æ®µæè®®è€…å‘é€RPCç§°ä¸ºphase 1aï¼Œä¹Ÿå«åšprepareé˜¶æ®µï¼Œåœ¨è¿™ä¸ªé˜¶æ®µåªå‘é€æè®®å·ï¼Œè€Œä¸è®¾è®¡å…·ä½“å†…å®¹\n1 send Prepare(++n) å“åº”çš„è¿‡ç¨‹ç§°ä¸ºphase 1bï¼Œç§°ä¸ºpromiseé˜¶æ®µï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹å½“ä¸­ï¼Œä¸»è¦æ ¹æ®æè®®å·æ¥åˆ¤æ–­æ˜¯å¦å­˜åœ¨å†²çªï¼š\nå¦‚æœprepareå½“ä¸­çš„nå¤§äºä¹‹å‰æ¥å—çš„æ‰€æœ‰ææ¡ˆç¼–å·ï¼Œé‚£ä¹ˆè¿”å›promiseè¿›è¡Œå“åº”ï¼Œå¹¶ä¸”æ‰¿è¯ºä¹‹åä¸å†æ¥å—ä»»ä½•å°äºnçš„æè®®ï¼Œå¦‚æœå¯¹äºè¯¥å€¼æ¥å—äº†æŸä¸ªææ¡ˆï¼Œé‚£ä¹ˆå°±è¿”å›å‰ä¸€æ¬¡çš„ææ¡ˆå·ä¸ææ¡ˆå€¼ å¦åˆ™å¿½ç•¥è¯¥è¯·æ±‚ï¼Œæ¢å¤ä¸€ä¸ªæ‹’ç»å“åº” 1 2 3 4 5 6 7 8 9 10 if (n \u0026gt; max_n) { max_n = n if (proposal_accepted == true) { respond: PROMISE(n,accepted_N,accepted_VALUE) } else { respond:PROMISE(n) } } else { respond with fail message } ç¬¬äºŒé˜¶æ®µ\nç¬¬äºŒé˜¶æ®µå‘é€ rpc æ—¶ç§°ä¸º phase 2aï¼ŒAccept é˜¶æ®µï¼Œå¦‚æœæè®®è€…èƒ½å¤Ÿæ”¶åˆ°åŠæ•°ä»¥ä¸Šçš„ phase 1b çš„æ­£ç¡®å›åº”ï¼Œåˆ™è¿›è¡Œ phase 2a é˜¶æ®µï¼Œå¦‚æœ phase 1b çš„å“åº”å½“ä¸­å­˜åœ¨æè®®å€¼ï¼Œé‚£ä¹ˆå°±ä½¿ç”¨è¯¥æè®®å€¼ï¼Œå¦åˆ™æè®®è€…å¯ä»¥è‡ªç”±å†³å®šæè®®å€¼\n1 2 3 4 5 6 7 8 if (success \u0026gt; n/2) { if (contains_acc_val()) { val = accepted_VALUE } else { val = VALUE } send Accept(ID,val) } ç¬¬äºŒé˜¶æ®µçš„å“åº”è¢«ç§°ä¸ºphase 2bï¼Œå¦‚æœåœ¨æ­¤ä¹‹å‰æ²¡æœ‰æ¥å—è¿‡æ¯”nå¤§çš„ææ¡ˆï¼Œé‚£ä¹ˆä¹…æ¥å—nï¼Œä¿å­˜ææ¡ˆ\n1 2 3 4 5 6 7 8 9 if (n \u0026gt; max_n) { proposal_accepted = true max_n = n accepted_N = n accepted_VALUE = VALUE respond:Accepted(N,VALUE) to proposer and all learners } else { respond with fail message } å¯¹äºbasic paxosï¼Œå…¶è¿‡ç¨‹å’Œä¸¤é˜¶æ®µæäº¤æ¯”è¾ƒç›¸åƒï¼Œå³å‡å­˜åœ¨ä¸€ä¸ªprepareçš„è¿‡ç¨‹ï¼Œå…ˆå»è¯¢é—®ä»èŠ‚ç‚¹æ˜¯å¦èƒ½å¤Ÿæ‰§è¡Œå‘½ä»¤æˆ–è€…è¿›è¡Œå†™å…¥ï¼Œå½“æ”¶åˆ°è‚¯å®šçš„ç­”å¤ä¹‹åï¼Œè¿›è¡Œç¬¬äºŒè½®å»çœŸæ­£æ‰§è¡Œå‘½ä»¤ã€‚åªä¸è¿‡äºŒè€…çš„ç›®çš„ç•¥æœ‰ä¸åŒï¼Œåˆ†å¸ƒå¼äº‹åŠ¡çš„ä¸¤é˜¶æ®µæäº¤æ„åœ¨æ‰€æœ‰èŠ‚ç‚¹å…±åŒå‚ä¸ï¼Œå› æ­¤éœ€è¦æ‰€æœ‰çš„èŠ‚ç‚¹å‡ç»™äºˆåº”ç­”ï¼Œå› æ­¤å­˜åœ¨é˜»å¡çš„é—®é¢˜ï¼Œè€Œpaxosæ„åœ¨å½¢æˆå…±è¯†ï¼Œå› æ­¤åªéœ€è¦æœ‰è¶…è¿‡1/2çš„èŠ‚ç‚¹èƒ½å¤Ÿæ­£ç¡®å“åº”å³å¯ã€‚\næ´»é” ç³»ç»Ÿä¸­å¯èƒ½å­˜åœ¨ä¸¤ä¸ªæè®®è€…ä¸æ–­äº¤å‰è¿›è¡Œæè®®ï¼ŒAåœ¨proposalä¹‹åä»èŠ‚ç‚¹åˆæ”¶åˆ°äº†Bçš„proposalï¼Œä»è€ŒAçš„acceptè¯·æ±‚è¢«æ‹’ç»ï¼Œä¹‹åAå†è¿›è¡Œproposalï¼Œäº§ç”Ÿäº†æœ‰ä¸ªæ›´å¤§çš„proposal numberï¼Œä»è€ŒBçš„Acceptè¯·æ±‚ä¹Ÿä¼šè¢«æ‹’ç»ï¼Œå› æ­¤ç³»ç»Ÿäº§ç”Ÿä¸€ç§æ´»é”çš„çŠ¶æ€ï¼Œè§£å†³æ–¹æ³•å’Œraftä¸€æ ·ï¼Œå¼•å…¥éšæœºçš„è¶…æ—¶æ—¶é—´æ¥é¿å…äº’ç›¸ç«äº‰å¯¼è‡´çš„æ´»é”é—®é¢˜ã€‚\nMulti Paxos paxosåªæ˜¯ç”¨äºå®Œæˆä¸€æ¬¡å…±è¯†ï¼Œè€Œå¯¹äºåˆ†å¸ƒå¼å­˜å‚¨çš„å¤šæ¡æ—¥å¿—ï¼Œåˆ™éœ€è¦å¯¹äºæ¯æ¡æ—¥å¿—å‡è¿è¡Œä¸€æ¬¡paxosï¼Œä»è€Œè®©ä»èŠ‚ç‚¹èƒ½å¤Ÿæ‹¿åˆ°æ‰€æœ‰çš„æ—¥å¿—ï¼Œç§°ä¸ºmulti paxosã€‚ åç»­æœ‰ç©ºå†è¿›è¡Œè¡¥å……\nRaft raftå·²ç»æ¯”è¾ƒç†Ÿæ‚‰äº†ï¼Œè¿™é‡Œå°±è¿›è¡Œç®€å•çš„è¡¥å……\nå®‰å…¨æ€§ä¸æ´»æ€§ é€‰ä¸¾è¿‡ç¨‹ä¸­éœ€è¦ä¿è¯å®‰å…¨æ€§ä¸æ´»æ€§ï¼š\nå®‰å…¨æ€§åªåœ¨ä¸€ä¸ªä»»æœŸå½“ä¸­ï¼Œåªæœ‰ä¸€ä¸ªleaderèƒ½å¤Ÿè¢«é€‰ä¸¾å‡ºæ¥ï¼Œç›¸å…³ä¿è¯ä¸ºï¼š ä¸€ä¸ªèŠ‚ç‚¹åœ¨ä¸€ä¸ªä»»æœŸå½“ä¸­åªèƒ½å¤Ÿè¿›è¡Œä¸€æ¬¡æŠ•ç¥¨ï¼Œå¹¶ä¸”æŠ•ç¥¨ä¿¡æ¯éœ€è¦è¿›è¡ŒæŒä¹…åŒ–å­˜å‚¨ åªæœ‰è·å¾—è¶…è¿‡åŠæ•°çš„é€‰ç¥¨ä¹‹åæ‰èƒ½å¤Ÿç§°ä¸ºleaderï¼Œä»è€Œä¿è¯ä¸ä¼šåŒæ—¶æœ‰ä¸¤ä¸ªleaderå½“é€‰ æ´»æ€§æŒ‡çš„æ˜¯è¦ç¡®ä¿ç³»ç»Ÿæœ€ç»ˆèƒ½å¤Ÿé€‰ä¸¾å‡ºä¸€ä¸ªleaderï¼Œå› æ­¤éœ€è¦åœ¨é€‰ä¸å‡ºleaderæ—¶æœ‰çš„èŠ‚ç‚¹ä¼šè¶…æ—¶è§¦å‘æ–°çš„ä¸€è½®é€‰ä¸¾ï¼Œå¹¶ä¸”ä¸ºäº†é˜²æ­¢é™·å…¥æ´»é”é—®é¢˜ï¼ŒraftåŒæ ·éœ€è¦è®¾ç½®ä¸€ä¸ªéšæœºçš„è¶…æ—¶æ—¶é—´(150ms-300ms) å»¶è¿Ÿæäº¤ è€ƒè™‘ä»¥ä¸‹è¿™ç§æƒ…å†µï¼Œä¸Šä¸€ä»»æœŸçš„leaderä¸ºs1ï¼Œå¹¶ä¸”s1å·²ç»æäº¤äº†index = 3çš„æ—¥å¿—ï¼Œæ­¤æ—¶s1å®•æœºï¼Œé‡æ–°è¿›è¡Œleader electionï¼ŒS5å½“é€‰ä¸ºleaderï¼Œä¹‹åS5è¿›è¡Œæ—¥å¿—å¤åˆ¶æ—¶ï¼Œå°±ä¼šè¦†ç›–æ‰S2 S3å½“ä¸­index = 3çš„æ—¥å¿—ï¼Œä½†æ˜¯è¯¥æ—¥å¿—å·²ç»åœ¨s1ä¸ºleaderæ—¶è¿›è¡Œäº†æäº¤ï¼Œä»è€Œå¯¼è‡´å·²ç»æäº¤çš„æ—¥å¿—ä¸¢å¤±ã€‚ é’ˆå¯¹è¿™ç§æƒ…å†µï¼Œéœ€è¦è¿›è¡Œé¢å¤–çš„é™åˆ¶ï¼š\næ—¥å¿—å¿…é¡»å­˜å‚¨åœ¨è¶…è¿‡åŠæ•°çš„èŠ‚ç‚¹ä»¥ä¸Š Leader å¿…é¡»çœ‹åˆ°è¶…è¿‡åŠæ•°çš„èŠ‚ç‚¹ä¸Šè¿˜å­˜å‚¨ç€è‡³å°‘ä¸€æ¡è‡ªå·±ä»»æœŸå†…çš„æ—¥å¿— è¿™å°±æ˜¯æ‰€è°“çš„å»¶è¿Ÿæäº¤ï¼Œæ¢å¥è¯è¯´ï¼Œleaderä¸èƒ½å¤Ÿæäº¤ä¸å±äºè‡ªå·±ä»»æœŸçš„æ—¥å¿—ï¼Œå¯¹äºä¹‹å‰çš„æ—¥å¿—ï¼Œleaderåªèƒ½åœ¨æäº¤å½“å‰ä»»æœŸæ—¥å¿—æ—¶ï¼Œé¡ºå¸¦è¿›è¡Œæäº¤ã€‚å³åªæœ‰ä»¥ä¸‹çš„æƒ…å†µæ—¶ï¼Œleader S1æ‰èƒ½å¤Ÿå¯¹index = 3çš„æ—¥å¿—æäº¤ no-opç©ºæ—¥å¿—\né€šè¿‡å»¶è¿Ÿæäº¤çš„æ–¹å¼ï¼Œå¯ä»¥è§£å†³æ‰å·²æäº¤æ—¥å¿—è¢«è¦†ç›–çš„é—®é¢˜ï¼Œä½†æ˜¯å­˜åœ¨çš„é—®é¢˜æ˜¯leaderéœ€è¦ç­‰å¾…å®¢æˆ·ç«¯å‘æ¥ä¸€æ¡è¯·æ±‚æ‰èƒ½å¤Ÿç”Ÿæˆå¯¹åº”çš„æ—¥å¿—ï¼Œå¦åˆ™index = 3çš„æ—¥å¿—åˆ™ä¼šè¿Ÿè¿Ÿå¾—ä¸åˆ°æäº¤ï¼Œå¯¼è‡´å¯¹åº”çš„è¯·æ±‚é˜»å¡ï¼Œæ— æ³•æ”¶åˆ°å“åº”ã€‚\nè§£å†³æ–¹å¼å³ä¸ºå½“leaderä¸Šçº¿ä¹‹åï¼Œç«‹é©¬å‘è‡ªèº«å†™å…¥ä¸€æ¡æ²¡æœ‰å†…å®¹çš„ç©ºæ—¥å¿—ï¼Œå¹¶è¿›è¡Œå¤åˆ¶ä¸æäº¤ï¼Œé€šè¿‡æäº¤ç©ºæ—¥å¿—æ¥é¡ºå¸¦æäº¤ä¹‹å‰çš„æ—¥å¿—ï¼Œä»è€Œæ¨åŠ¨æ•´ä¸ªç³»ç»Ÿ\nå¤„ç†æ—§çš„é¢†å¯¼è€… åœ¨ä¸å­˜åœ¨ç½‘ç»œåˆ†åŒºçš„æƒ…å†µä¸‹ï¼Œå¯¹äºæ—§çš„é¢†å¯¼è€…å¤„ç†å¾ˆç®€å•ï¼Œåªéœ€è¦è¿›è¡Œä¸€æ¬¡rpcé€šä¿¡ï¼Œå³å¯é€šè¿‡æ¯”è¾ƒæºå¸¦çš„termæ¥å®Œæˆã€‚è€Œå¯¹äºç½‘ç»œåˆ†åŒºçš„æƒ…å†µï¼Œç”±äºraftåœ¨CAPå½“ä¸­é€‰æ‹©äº†CPï¼Œå› æ­¤å¤„äºè¾ƒå°‘åˆ†åŒºçš„leaderæ— æ³•å½¢æˆå¤§å¤šæ•°çš„å…±è¯†ï¼Œå› æ­¤æ— æ³•æäº¤æ—¥å¿—å’Œå“åº”å®¢æˆ·ç«¯ï¼Œä½†æ˜¯èº«ä»½ä¾æ—§ä¸ºleaderï¼Œå®¢æˆ·ç«¯å°±ä¼šç»§ç»­å’Œä»–è¿›è¡Œé€šä¿¡ï¼Œå› æ­¤æœ€å¥½è®©è¯¥leaderåŠæ—¶é€€ä½ã€‚\nç›¸å…³ä¼˜åŒ–å³ä¸ºcheck quorumï¼Œå¦‚æœleaderå‘ç°ä¸è‡ªå·±èƒ½ä¿æŒé€šä¿¡çš„follower\u0026lt;= n/2ï¼Œåˆ™ä¸»åŠ¨é€€ä½\nå®ç°çº¿æ€§ä¸€è‡´æ€§ çº¿æ€§ä¸€è‡´æ€§çš„å®ç°æ–¹æ¡ˆä¸»è¦æœ‰ä¸‰ç§ï¼Œæœ€ç®€å•çš„ä¸ºå°†è¯»è¯·æ±‚ä¹Ÿå†™å…¥åˆ°æ—¥å¿—å½“ä¸­ï¼Œä¹‹åå³å¯æŒ‰ç…§æ—¥å¿—çš„é¡ºåºæ¥ä¸¥æ ¼æ‰§è¡Œï¼Œä»è€Œä¿è¯é¡ºåºã€‚ä½†æ˜¯ä¼šäº§ç”Ÿå†™æ—¥å¿—å’Œå¤åˆ¶æ—¥å¿—çš„é¢å¤–å¼€é”€ã€‚ ç›¸å…³ä¼˜åŒ–æœ‰ä¸¤ç§ï¼Œåˆ†åˆ«ä¸ºread indexå’Œlease readï¼š\nReadIndex\nå°†å½“å‰è‡ªå·±çš„ commit index è®°å½•åˆ°ä¸€ä¸ª local å˜é‡ ReadIndex é‡Œé¢ã€‚ å‘å…¶ä»–èŠ‚ç‚¹å‘èµ·ä¸€æ¬¡ heartbeatï¼Œå¦‚æœå¤§å¤šæ•°èŠ‚ç‚¹è¿”å›äº†å¯¹åº”çš„ heartbeat responseï¼Œé‚£ä¹ˆ leader å°±èƒ½å¤Ÿç¡®å®šç°åœ¨è‡ªå·±ä»ç„¶æ˜¯ leaderã€‚ Leader ç­‰å¾…è‡ªå·±çš„çŠ¶æ€æœºæ‰§è¡Œï¼Œç›´åˆ° apply index è¶…è¿‡äº† ReadIndexï¼Œè¿™æ ·å°±èƒ½å¤Ÿå®‰å…¨çš„æä¾› linearizable read äº†ã€‚ Leader æ‰§è¡Œ read è¯·æ±‚ï¼Œå°†ç»“æœè¿”å›ç»™ clientã€‚ åœ¨è¿™ä¸ªè¿‡ç¨‹å½“ä¸­åŒæ ·éœ€è¦no-opæ¥ä¿è¯å½“å‰leaderçš„commitIndexä¸ºé›†ç¾¤å½“ä¸­æœ€æ–°ã€‚\nåªæœ‰commitäº†æ—¥å¿—æ‰èƒ½å¤Ÿè§†ä¸ºé¡ºåºå…³ç³»ï¼Œè€Œå¯¹äºé‚£äº›åœ¨commitIndexä¹‹åå†™è¯·æ±‚ï¼Œå°†å…¶è§†ä¸ºä¸å½“å‰çš„è¯»è¯·æ±‚ä¸ºå¹¶å‘å…³ç³»ï¼Œå› æ­¤å¯ä»¥ä¸è¯»å–åˆ°å…¶ä¸­çš„å†…å®¹ï¼Œè™½ç„¶ä¸Log Readè·å–åˆ°äº†ä¸ä¸€æ ·çš„ç»“æœï¼Œä½†æ˜¯ä¾æ—§æ˜¯æ»¡è¶³çº¿æ€§ä¸€è‡´æ€§çš„ã€‚\nåœ¨ä½¿ç”¨ReadIndexæ—¶ï¼Œå¯ä»¥é‡‡ç”¨åœ¨followerå‡ºè¿›è¡Œè¯»å–çš„æ–¹å¼æ¥æé«˜ååé‡ï¼Œå³followerå‘leaderå»ç´¢å–ä¸€ä¸ªReadIndexï¼Œåç»­ç­‰å¾…è‡ªèº«çš„appliedIndex == ReadIndexæ—¶ä»…å¯è¿›è¡Œè¯»å–ï¼Œå¯¹äºlocal readï¼Œè¿˜æœ‰å…¶ä»–çš„å®ç°æ–¹æ¡ˆï¼Œç•™åœ¨etcdå½“ä¸­è¿›è¡Œåˆ†æ\nLeaseRead\nLeaderä½¿ç”¨æ­£å¸¸çš„å¿ƒè·³æœºåˆ¶æ¥ä½äºä¸€ä¸ªleaseï¼Œå¿ƒè·³å¼€å§‹çš„æ—¶é—´æ ‡è®°ä¸ºstart,å¦‚æœleaderçš„å¿ƒè·³è¢«å¤šæ•°æ´¾ç¡®è®¤ï¼Œé‚£ä¹ˆåœ¨start+electionTimeout/clockDriftBoundçš„æ—¶é—´å†…ï¼ŒLeaderå‡ä¸ºæœ‰æ•ˆçš„leaderï¼Œä¸ä¼šå› ä¸ºå…¶ä»–èŠ‚ç‚¹è¿›è¡Œé€‰ä¸¾è€Œé€€ä½ï¼Œå› æ­¤å¯ä»¥å®‰å…¨çš„å¤„ç†åªè¯»æŸ¥è¯¢ï¼Œç»“æœå…¨éƒ¨æ»¡è¶³çº¿æ€§ä¸€è‡´æ€§ã€‚\næ€§èƒ½ä¼˜åŒ– raftæ¶‰åŠåˆ°çš„ä¸»è¦æ€§èƒ½ä¼˜åŒ–å³ä¸ºæ‰¹å¤„ç†å’Œæµæ°´çº¿ï¼Œè¿™ä¸¤ä¸ªéƒ½åœ¨etcdå½“ä¸­è¿›è¡Œäº†å®ç°ï¼Œè¿™é‡Œå°±ä¸é¢å¤–è¿›è¡Œåˆ†æäº†\nåˆ†å¸ƒå¼äº‹åŠ¡ åˆ†å¸ƒå¼äº‹åŠ¡å¯ä»¥ç†è§£ä¸ºå•æœºäº‹åŠ¡çš„å˜ä½“ï¼Œä¸»è¦åˆ†ä¸ºä¸¤ç§ç±»å‹ï¼Œä¸€ç§æ˜¯åŒä¸€ä»½æ•°æ®éœ€è¦åœ¨å¤šä¸ªå‰¯æœ¬ä¸Šæ›´æ–°ï¼Œä¸€ä¸ªäº‹åŠ¡éœ€è¦æ›´æ–°æ‰€æœ‰çš„å‰¯æœ¬ï¼Œè€Œå¦å¤–ä¸€ç§ä¸ºäº‹åŠ¡æ‰€éœ€è¦çš„æ•°æ®å­˜å‚¨åœ¨ä¸åŒçš„èŠ‚ç‚¹ä¸Šï¼Œä¸€æ¬¡äº‹åŠ¡æ“ä½œéœ€è¦è·¨è¶Šå¤šä¸ªäº‹åŠ¡ï¼Œä¿è¯åœ¨åˆ†å¸ƒå¼æƒ…å†µä¸‹ï¼ŒåŒæ ·èƒ½å¤Ÿä»¤äº‹åŠ¡éµå¾ªACIDï¼Œå…¶ä¸­æŒä¹…æ€§å¯ä»¥é€šè¿‡WALçš„å½¢å¼æ¥è§£å†³ï¼Œä¸€è‡´æ€§é€šå¸¸ä¸åœ¨è®¨è®ºèŒƒå›´å†…ï¼Œä¸»è¦éœ€è¦å…‹æœçš„å°±æ˜¯åŸå­æ€§ä¸éš”ç¦»æ€§ï¼Œéœ€è¦é€šè¿‡åŸå­æäº¤å’Œå¹¶å‘æ§åˆ¶æ¥è¿›è¡Œè§£å†³\nåŸå­æäº¤ åå®šæ€§ï¼šæ‰€æœ‰è¿›ç¨‹å†³å®šå‡ºåŒä¸€ä¸ªå€¼ï¼Œå³è¦ä¹ˆæ‰€æœ‰è¿›ç¨‹å…¨éƒ¨æäº¤ï¼Œè¦ä¹ˆæ‰€æœ‰è¿›ç¨‹ä¸€åŒä¸­æ­¢äº‹åŠ¡ æœ‰æ•ˆæ€§ï¼šåªè¦æœ‰ä¸€ä¸ªäº‹åŠ¡å†³å®šä¸­æ­¢äº‹åŠ¡ï¼Œç³»ç»Ÿæœ€ç»ˆå°†ä¸­æ­¢äº‹åŠ¡ ç»ˆæ­¢æ€§ï¼šå¯ä»¥åˆ†ä¸ºå¼±ä¸­æ­¢æ¡ä»¶å’Œå¼ºä¸­æ­¢æ¡ä»¶ å¼±ä¸­æ­¢æ¡ä»¶ï¼šå¦‚æœæ²¡æœ‰æ•…éšœå‘ç”Ÿï¼Œæ‰€æœ‰è¿›ç¨‹æœ€ç»ˆéƒ½ä¼šåšå‡ºå†³è®® å¼ºä¸­æ­¢æ¡ä»¶æ²¡æœ‰å‘ç”Ÿæ•…éšœçš„è¿›ç¨‹æœ€ç»ˆä¼šåšå‡ºå†³è®® ä¸¤é˜¶æ®µæäº¤ è§’è‰²ä¸Šåˆ†ä¸ºåè°ƒè€…(Coordinator)å’Œå‚ä¸è€…(Participants),åè°ƒè€…è´Ÿè´£è¿›è¡Œåè°ƒç®—æ³•çš„å„ä¸ªé˜¶æ®µï¼Œå‚ä¸è€…å‚ä¸åˆ°äº‹åŠ¡æ‰§è¡Œçš„å„ä¸ªéƒ¨åˆ†\né˜¶æ®µï¼š\nç¬¬ä¸€é˜¶æ®µç§°ä¸ºå‡†å¤‡é˜¶æ®µï¼š\nåè°ƒè€…å‘æ‰€æœ‰å‚ä¸è€…å‘èµ·ä¿¡æ¯ï¼Œè¯¢é—®æ˜¯å¦å¯ä»¥æäº¤äº‹åŠ¡ï¼Œç­‰å¾…å‚ä¸è€…å“åº”\nå‚ä¸è€…æ£€æŸ¥æ‰§è¡Œæ‰€éœ€çš„æ¡ä»¶ï¼Œå¦‚æœå‘ç°è‡ªèº«äº‹åŠ¡æ‰§è¡Œçš„éƒ½æˆåŠŸï¼Œåˆ™å›åº”yesï¼Œåä¹‹no ç¬¬äºŒé˜¶æ®µç§°ä¸ºæäº¤é˜¶æ®µï¼š\nå¦‚æœæ‰€æœ‰çš„å‚ä¸è€…ç¬¬ä¸€é˜¶æ®µéƒ½å›åº”äº†yesï¼Œåè°ƒè€…å‘æ‰€æœ‰çš„å‚ä¸è€…å‘é€ä¿¡æ¯ï¼Œè¯·æ±‚æäº¤äº‹åŠ¡\nå‚ä¸è€…æ”¶åˆ°ä¿¡æ¯åè¿›è¡Œäº‹åŠ¡çš„æäº¤ï¼Œå¹¶å“åº”åè°ƒè€…\nåè°ƒè€…å¦‚æœæ”¶åˆ°äº†å…¨éƒ¨çš„æ­£ç¡®å“åº”ï¼Œç¡®è®¤äº‹åŠ¡æˆåŠŸæäº¤\nå¦‚æœå…¶ä¸­ç¬¬ä¸€é˜¶æ®µæœ‰ä¸€ä¸ªå‚ä¸è€…å“åº”äº†noï¼Œåˆ™åè°ƒè€…æŒ‡ç¤ºå‚ä¸è€…ä¸­æ­¢äº‹åŠ¡\nå‚ä¸è€…åˆ©ç”¨ç¬¬ä¸€é˜¶æ®µæ‰§è¡Œæ—¶ä¿å­˜çš„ä¿¡æ¯è¿›è¡Œå›æ»š\nä¸­æ­¢å®Œæˆåå“åº”ç»™åè°ƒè€…ï¼Œæ”¶åˆ°æ‰€æœ‰å‚ä¸è€…çš„ä¿¡æ¯åï¼Œç¡®è®¤äº‹åŠ¡çš„ä¸­æ­¢ ç›¸å…³æ•…éšœ\nç¬¬ä¸€é˜¶æ®µå‚ä¸è€…å›å¤åè°ƒè€…æ—¶è¶…æ—¶ï¼Œä¼šå¯¼è‡´åè°ƒè€…ä¸€ç›´ç­‰å¾…ï¼Œè§£å†³æ–¹æ³•ä¸ºå¼•å…¥ä¸€ä¸ªè¶…æ—¶æ—¶é—´ï¼Œè¶…æ—¶åˆ™è®¤ä¸ºè¯¥å‚ä¸è€…æŠ•äº†åå¯¹ç¥¨ï¼ˆå¯è§£å†³ï¼‰ åè°ƒè€…åœ¨å‘å‚ä¸è€…å‘é€æ¶ˆæ¯åç«‹åˆ»å‘ç”Ÿäº†æ•…éšœï¼Œé™¤éåè°ƒè€…æ¢å¤ï¼Œå¦åˆ™ä¼šä¸€ç›´é˜»å¡ä¸‹å» åœ¨ç¬¬äºŒé˜¶æ®µå‘ç”Ÿäº†ç½‘ç»œåˆ†åŒºï¼Œåè°ƒè€…åªå‘ä¸€éƒ¨åˆ†çš„å‚ä¸è€…å‘é€äº†æäº¤ä¿¡æ¯ï¼Œæ­¤æ—¶è¿›è¡Œè¯»å–åˆ™ä¼šäº§ç”Ÿä¸ä¸€è‡´æ€§ åœ¨ç¬¬äºŒé˜¶æ®µï¼Œå¦‚æœåè°ƒè€…å‘é€ä¿¡æ¯ä¹‹åå®•æœºï¼Œè¯¥ä¿¡æ¯ä¹‹å‘é€ç»™äº†ä¸€ä¸ªå‚ä¸è€…ï¼Œè€Œè¯¥å‚ä¸è€…æ”¶åˆ°ä¿¡æ¯å¹¶æ‰§è¡Œåä¹Ÿå®•æœºï¼Œæ­¤æ—¶åˆ™ä¼šå®Œå…¨ä¸çŸ¥é“ç³»ç»Ÿçš„çŠ¶æ€ï¼Œå¦‚æœç›²ç›®æäº¤æˆ–ä¸­æ­¢ï¼Œå®•æœºçš„å‚ä¸è€…å¦‚æœæ¢å¤è¿‡æ¥å¹¶ä¸”çŠ¶æ€ä¸ä¸€æ ·åˆ™ä¼šå¼•å‘æ•°æ®ä¸ä¸€è‡´é—®é¢˜ åŸºæœ¬çš„2PCçš„æ ¹æœ¬é—®é¢˜æ˜¯æ— æ³•è§£å†³å•ç‚¹æ•…éšœé—®é¢˜ï¼Œä¸€æ—¦æœ‰æŸä¸ªèŠ‚ç‚¹å®•æœºå°±ä¼šå¼•å‘å¦‚é˜»å¡æˆ–è€…æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ï¼Œè§£å†³æ–¹æ³•ä¸ºé€šè¿‡raftç­‰æ–¹å¼å°†åŸæœ¬çš„å•ä¸ªèŠ‚ç‚¹è½¬æ¢ä¸ºé›†ç¾¤çš„å½¢å¼ï¼Œé¿å…å•ç‚¹æ•…éšœ\nä¸‰é˜¶æ®µæäº¤ ä¸‰é˜¶æ®µæäº¤çš„æå‡ºç”¨äºè§£å†³ä¸¤é˜¶æ®µæäº¤çš„é˜»å¡é—®é¢˜ï¼Œåœ¨åŸæœ¬ä¸¤ä¸ªé˜¶æ®µçš„ä¸­é—´æ·»åŠ äº†ä¸€ä¸ªé¢„æäº¤é˜¶æ®µ(Pre-Commit)ï¼Œåœ¨é¢„æäº¤é˜¶æ®µï¼Œå°†ç¬¬ä¸€é˜¶æ®µçš„ç»“æœå‘é€ç»™æ‰€æœ‰çš„å‚ä¸è€…ï¼Œè¿™æ ·åœ¨åè°ƒè€…å®•æœºä¹‹åï¼Œä¾æ—§å¯ä»¥è·å–é›†ç¾¤çš„çŠ¶æ€ï¼Œåˆ¤æ–­åº”è¯¥ä¸­æ­¢è¿˜æ˜¯æäº¤ã€‚\næµç¨‹\nå‡†å¤‡é˜¶æ®µï¼š\nåè°ƒè€…å‘å‚ä¸è€…å‘é€ä¿¡æ¯è¯¢é—®æ˜¯å¦èƒ½å¤Ÿæ‰§è¡Œæäº¤äº‹åŠ¡ å‚ä¸è€…åˆ¤æ–­è‡ªèº«æ˜¯å¦èƒ½å¤Ÿæ‰§è¡Œäº‹åŠ¡ï¼Œä½†æ˜¯å¹¶ä¸çœŸæ­£æ‰§è¡Œäº‹åŠ¡ï¼Œåªæ˜¯åˆ¤æ–­åŸºæœ¬æ¡ä»¶ï¼Œç»™äºˆå“åº” é¢„æäº¤é˜¶æ®µ åè°ƒè€…å‘é€é¢„æäº¤ä¿¡æ¯ å‚ä¸è€…å¦‚æœæ»¡è¶³æ¡ä»¶åˆ™æ‰§è¡Œäº‹åŠ¡ï¼Œå¹¶è®°å½•æ—¥å¿—ï¼Œå“åº”åè°ƒè€… æäº¤é˜¶æ®µ åè°ƒè€…å‘é€æäº¤ä¿¡æ¯ å‚ä¸è€…æäº¤äº‹åŠ¡å¹¶ç»™äºˆç›¸åº” é€šè¿‡é¢å¤–çš„é¢„æäº¤ï¼Œåœ¨æäº¤é˜¶æ®µæ—¶ï¼Œå¦‚æœåè°ƒè€…å‘ç”Ÿå®•æœºï¼Œåˆ™å¯ä»¥æ ¹æ®ä¹‹å‰çš„ä¿¡æ¯é‡æ–°é€‰ä¸¾å‡ºä¸€ä¸ªæ–°çš„åè°ƒè€…ï¼Œæ¥é¿å…åè°ƒè€…ç§°ä¸ºå•ç‚¹æ•…éšœé˜»å¡ç³»ç»Ÿï¼Œè€Œå¦‚æœåœ¨é¢„æäº¤é˜¶æ®µå‘ç”Ÿå®•æœºï¼Œåˆ™å¯ä»¥éšæ„é€‰å‡ºä¸€ä¸ªåè°ƒè€…ï¼Œç”±äºæ²¡æœ‰æ‰§è¡Œï¼Œä»è€Œä¸å­˜åœ¨æ•°æ®ä¸€è‡´æ€§çš„é—®é¢˜ã€‚\nä½†æ˜¯ä¸‰é˜¶æ®µæäº¤æ— æ³•è§£å†³æ‰€æœ‰é—®é¢˜ï¼Œä¼šæ”¶åˆ°ç½‘ç»œåˆ†åŒºçš„å½±å“ï¼šåœ¨ä¸¤ä¸ªåˆ†åŒºå†…ä¼šå„å­˜åœ¨ä¸€ä¸ªåè°ƒè€…ï¼Œä»è€Œå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ã€‚ paxosæäº¤ paxosæäº¤ä¸»è¦ç”¨äºè§£å†³åŸæœ¬ä¸‰é˜¶æ®µæäº¤åœ¨å‘ç”Ÿç½‘ç»œåˆ†åŒºæ—¶ï¼Œéšæ„é€‰ä¸¾åè°ƒè€…çš„é—®é¢˜ï¼Œé€šè¿‡å…±è¯†ç®—æ³•æ¥é€‰ä¸¾leaderï¼Œä»è€Œé¿å…æ•°æ®ä¸€è‡´æ€§é—®é¢˜ã€‚æ­¤å¤„ä»…æ˜¯å¯¹ä¸€ä¸ªå€¼æˆ–è€…ç»“æœæ¥å½¢æˆå…±è¯†ï¼Œå› æ­¤é‡‡ç”¨çš„ä¸ºbasic paxos\nä¸»è¦åˆ†ä¸ºä¸‰ä¸ªè§’è‰²ï¼š\nèµ„æºç®¡ç†è€…ï¼šç›¸å½“äº2PC 3PCå½“ä¸­çš„å‚ä¸è€…ï¼Œè´Ÿè´£äº‹åŠ¡çš„ä¸€éƒ¨åˆ†æ‰§è¡Œä¸æäº¤ï¼Œè€Œåœ¨paxoså½“ä¸­ï¼Œå……å½“æè®®è€…(éleader) é¢†å¯¼è€…ï¼šåè°ƒpaxosç®—æ³•çš„æ‰§è¡Œï¼Œå¯ä»¥è§†ä¸ºpaxoså’Œèµ„æºç®¡ç†è€…ä¹‹é—´çš„æ¡¥æ¢ï¼Œé¢†å¯¼è€…åŒæ—¶ä¹Ÿæ˜¯æ¥å—è€… æ¥å—è€…ï¼šä¸èµ„æºç®¡ç†è€…ç»„æˆpaxosé›†ç¾¤ï¼Œå­˜å‚¨ç»“æœï¼Œé€šè¿‡paxosæ¥é¿å…ç½‘ç»œåˆ†åŒº paxosç®—æ³•å¼€å§‹äºæŸä¸ªèµ„æºç®¡ç†è€…ï¼Œèµ„æºç®¡ç†è€…å†³å®šæäº¤äº‹åŠ¡ï¼Œå‘leaderå‘é€ä¸€ä¸ªBeginCommit leaderæ”¶åˆ°BeginCommitä¹‹åï¼Œå“åº”ä¸€ä¸ªprepareæ¶ˆæ¯ç»™æ‰€æœ‰çš„èµ„æºç®¡ç†è€… ä¹‹åæ‰€æœ‰çš„èµ„æºç®¡ç†è€…æ ¹æ®æ¡ä»¶å»åˆ¤æ–­è‡ªèº«æ˜¯å¦æäº¤äº‹åŠ¡ï¼Œå¦‚æœèƒ½å¤Ÿæäº¤äº‹åŠ¡ï¼Œåˆ™å‘èµ·ä¸€ä¸ªcommitçš„ææ¡ˆï¼Œå¦åˆ™ä¸ºabortçš„ææ¡ˆ Leader æ ¹æ®ææ¡ˆçš„ç»“æœï¼Œåˆ¤æ–­æ­¤æ¬¡äº‹åŠ¡æ˜¯å¦èƒ½å¤Ÿæäº¤ï¼Œä¹‹åå°†æ¶ˆæ¯å‘é€ç»™èµ„æºç®¡ç†è€…ï¼Œèµ„æºç®¡ç†è€…æ ¹æ® leader çš„ç»“æœè¿›è¡Œæäº¤æˆ–è€…å›æ»š ç›¸æ¯”raftï¼Œbasic paxosçš„ç»“æ„æ›´ä¸ºæ¾æ•£ä¸€äº›ï¼Œraftæ‰€è¿½æ±‚çš„å°±æ˜¯followerå®Œå…¨å¤åˆ¶leaderçš„æ—¥å¿—ï¼Œä»è€Œåœ¨çŠ¶æ€æœºä¸Šè¾¾æˆå…±è¯†ã€‚è€Œbasic paxosåªæ˜¯å¯¹äºæŸä¸ªå€¼è¾¾æˆå…±è¯†ï¼Œææ¡ˆè€…çš„æ¦‚å¿µå¹¶ä¸ç­‰åŒäºleaderï¼Œææ¡ˆè€…ä»…ä»…æ˜¯è¿›è¡Œææ¡ˆè€Œå·²ï¼Œæœ¬èº«å¯ä»¥ä¸å‚ä¸æ•°æ®çš„å†³ç­–ã€‚\npaxosæäº¤çš„ç»“æ„æ›´åƒæ˜¯åœ¨äº‹åŠ¡çš„æ‰§è¡Œè€…å¤–æ¥äº†ä¸€ä¸ªpaxos,paxosåªæ˜¯ç”¨æ¥å­˜å‚¨ç»“æœï¼Œå’Œé˜²æ­¢ç½‘ç»œåˆ†åŒºçš„é—®é¢˜ï¼Œå®é™…ä¸Šå¹¶ä¸å‚ä¸äº‹åŠ¡çš„æ‰§è¡Œæˆ–è€…åˆ¤æ–­çš„è¿‡ç¨‹ã€‚\nSagaäº‹åŠ¡ å®ç°åˆ†å¸ƒå¼äº‹åŠ¡çš„ä»£ä»·è¾ƒé«˜ï¼Œå¹¶ä¸”å¯èƒ½å­˜åœ¨ä¸€äº›é•¿äº‹åŠ¡ï¼Œå…¶ä¸­ç”šè‡³å¯èƒ½ä¼šæ¶‰åŠåˆ°æ‰‹åŠ¨è¾“å…¥ç­‰äººå·¥ä»‹å…¥ç­‰é—®é¢˜ã€‚ä½¿ç”¨å¸¸è§æ–¹å¼å¤„ç†ï¼Œé€šå¸¸æ€§èƒ½è¾ƒä½ã€‚è€Œå¯¹äºä¸€äº›ä¸éœ€è¦å®Œå…¨è¿›è¡Œéš”ç¦»çš„äº‹åŠ¡ï¼Œå¯ä»¥é‡‡ç”¨Sagaäº‹åŠ¡ã€‚\nSagaäº‹åŠ¡é€šè¿‡ä¸€äº›åˆ—çš„å­äº‹åŠ¡ç»„æˆï¼Œå­äº‹åŠ¡æŒ‰ç…§åŸæœ¬çš„æ–¹å¼è¿›è¡Œæ‰§è¡Œï¼Œä¿è¯ACIDï¼ŒSagaäº‹åŠ¡æ•´ä½“é€šè¿‡è¡¥å¿äº‹åŠ¡çš„æ–¹å¼æ¥ä¿è¯æ•´ä¸ªäº‹åŠ¡çš„åŸå­æ€§ã€‚å³å¦‚æœç”±T1,T2ç»„æˆï¼ŒT1æäº¤ä¹‹åï¼ŒT2éœ€è¦å›æ»šï¼Œåˆ™è¿è¡Œä¸€ä¸ªT1çš„è¡¥å¿äº‹åŠ¡ï¼Œæ¥æ’¤é”€æ‰T1åšå‡ºçš„æ“ä½œã€‚\nSagaäº‹åŠ¡æœ€å¤§çš„é—®é¢˜æ˜¯æ— æ³•ä¿è¯éš”ç¦»æ€§ã€‚\n","permalink":"https://fischer0522.github.io/en/posts/tech/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/","summary":"åˆ†å¸ƒå¼ç³»ç»Ÿæ¨¡å‹ æ‹œå åº­å°†å†›é—®é¢˜ æ‹œå åº­å°†å†›ä¸»è¦ç”¨äºè§£å†³å…±è¯†é—®é¢˜ï¼Œä¸‰ä¸ªå°†å†›å†³å®šæ”»æ‰“æ‹œå åº­ï¼Œåªæœ‰ä¸‰ä¸ªäººä¸€åŒè¿›è¡Œæ”»æ‰“æ‰èƒ½å¤ŸæˆåŠŸï¼Œå¦åˆ™åˆ™ä¼šå¤±è´¥ï¼Œå› æ­¤éœ€è¦","title":"æ·±å…¥ç†è§£åˆ†å¸ƒå¼ç³»ç»Ÿ"}]