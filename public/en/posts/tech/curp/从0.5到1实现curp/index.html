<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>02-ä»0.5å®ç°CURP | Fischer&#39;s Blog</title>
<meta name="keywords" content="">
<meta name="description" content="Intro ä»€ä¹ˆæ˜¯CURP Curpæ˜¯ä¸€ç§æ–°çš„åˆ†å¸ƒå¼å…±è¯†ç®—æ³•ï¼Œcurpçš„æå‡ºæ˜¯é’ˆå¯¹äºè·¨åŸŸç­‰é«˜ç½‘ç»œå»¶è¿Ÿåœºæ™¯ï¼Œä¼ ç»Ÿçš„raftå’Œpaxosç­‰å…±è¯†ç®—æ³•éœ€è¦ä¸¤ä¸ªR">
<meta name="author" content="Fischer">
<link rel="canonical" href="https://fischer0522.github.io/en/posts/tech/curp/%E4%BB%8E0.5%E5%88%B01%E5%AE%9E%E7%8E%B0curp/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css" integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z&#43;V9&#43;cO1A=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://fischer0522.github.io/img/Navigation.svg">
<link rel="icon" type="image/png" sizes="16x16" href="https://fischer0522.github.io/img/Navigation.svg">
<link rel="icon" type="image/png" sizes="32x32" href="https://fischer0522.github.io/img/Navigation.svg">
<link rel="apple-touch-icon" href="https://fischer0522.github.io/Navigation.svg">
<link rel="mask-icon" href="https://fischer0522.github.io/Navigation.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="02-ä»0.5å®ç°CURP" />
<meta property="og:description" content="Intro ä»€ä¹ˆæ˜¯CURP Curpæ˜¯ä¸€ç§æ–°çš„åˆ†å¸ƒå¼å…±è¯†ç®—æ³•ï¼Œcurpçš„æå‡ºæ˜¯é’ˆå¯¹äºè·¨åŸŸç­‰é«˜ç½‘ç»œå»¶è¿Ÿåœºæ™¯ï¼Œä¼ ç»Ÿçš„raftå’Œpaxosç­‰å…±è¯†ç®—æ³•éœ€è¦ä¸¤ä¸ªR" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://fischer0522.github.io/en/posts/tech/curp/%E4%BB%8E0.5%E5%88%B01%E5%AE%9E%E7%8E%B0curp/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-06-03T09:31:59+00:00" />
<meta property="article:modified_time" content="2024-06-03T09:31:59+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="02-ä»0.5å®ç°CURP"/>
<meta name="twitter:description" content="Intro ä»€ä¹ˆæ˜¯CURP Curpæ˜¯ä¸€ç§æ–°çš„åˆ†å¸ƒå¼å…±è¯†ç®—æ³•ï¼Œcurpçš„æå‡ºæ˜¯é’ˆå¯¹äºè·¨åŸŸç­‰é«˜ç½‘ç»œå»¶è¿Ÿåœºæ™¯ï¼Œä¼ ç»Ÿçš„raftå’Œpaxosç­‰å…±è¯†ç®—æ³•éœ€è¦ä¸¤ä¸ªR"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Blog",
      "item": "https://fischer0522.github.io/en/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Tech",
      "item": "https://fischer0522.github.io/en/posts/tech/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "CURP",
      "item": "https://fischer0522.github.io/en/posts/tech/curp/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "02-ä»0.5å®ç°CURP",
      "item": "https://fischer0522.github.io/en/posts/tech/curp/%E4%BB%8E0.5%E5%88%B01%E5%AE%9E%E7%8E%B0curp/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "02-ä»0.5å®ç°CURP",
  "name": "02-ä»0.5å®ç°CURP",
  "description": "Intro ä»€ä¹ˆæ˜¯CURP Curpæ˜¯ä¸€ç§æ–°çš„åˆ†å¸ƒå¼å…±è¯†ç®—æ³•ï¼Œcurpçš„æå‡ºæ˜¯é’ˆå¯¹äºè·¨åŸŸç­‰é«˜ç½‘ç»œå»¶è¿Ÿåœºæ™¯ï¼Œä¼ ç»Ÿçš„raftå’Œpaxosç­‰å…±è¯†ç®—æ³•éœ€è¦ä¸¤ä¸ªR",
  "keywords": [
    
  ],
  "articleBody": "Intro ä»€ä¹ˆæ˜¯CURP Curpæ˜¯ä¸€ç§æ–°çš„åˆ†å¸ƒå¼å…±è¯†ç®—æ³•ï¼Œcurpçš„æå‡ºæ˜¯é’ˆå¯¹äºè·¨åŸŸç­‰é«˜ç½‘ç»œå»¶è¿Ÿåœºæ™¯ï¼Œä¼ ç»Ÿçš„raftå’Œpaxosç­‰å…±è¯†ç®—æ³•éœ€è¦ä¸¤ä¸ªRTTï¼Œåœ¨é«˜ç½‘ç»œå»¶è¿Ÿçš„åœºæ™¯ä¸‹ï¼Œä¸¤ä¸ªRTTå¯¹ç³»ç»Ÿæ¥è¯´æ˜¯éš¾ä»¥å¿å—çš„ï¼Œç½‘ç»œé€šä¿¡ä¼šæˆä¸ºç³»ç»Ÿçš„ç“¶é¢ˆã€‚\nä¸ºäº†è§£å†³è¯¥é—®é¢˜ï¼ŒCURPæœŸæœ›åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œé€šè¿‡ä¸€ä¸ªRTTæ¥å®Œæˆï¼Œè¿™ä¸»è¦åŸºäºä¸¤ç‚¹èƒŒæ™¯ï¼š\nåœ¨è¯·æ±‚ä¸­ï¼Œå„ä¸ªè¯·æ±‚ä¹‹é—´é€šå¸¸æ˜¯äº’ä¸å†²çªçš„ï¼Œä¾‹å¦‚ set a =1 å’Œ set b = 2, å¯¹äºåŒä¸€ä¸ªkeyçš„é‡å¤æ€§è¯»å†™æ˜¯æ¯”è¾ƒå°‘è§çš„ ç³»ç»Ÿå¹¶ä¸éœ€è¦å¯¹æ‰€æœ‰è¯·æ±‚å»ºç«‹ä¸€ä¸ªå…¨å±€çš„é¡ºåºï¼Œç›¸å¯¹çš„ï¼Œåªéœ€è¦å¯¹äºäº’ç›¸å†²çªçš„keyå»ºç«‹èµ·ä¸€ä¸ªå±€éƒ¨é¡ºåºå³å¯ å¦‚æœæƒ³è¿›ä¸€æ­¥äº†è§£CURPï¼Œæ¬¢è¿é˜…è¯»ç¬”è€…çš„å¦ä¸€ç¯‡æ–‡ç« ï¼š zhuanlan.zhihu.com/p/692464275 ä¸ºä»€ä¹ˆæ˜¯ä» 0.5 åˆ° 1 CURPæ˜¯éä¾µå…¥æ€§çš„ï¼Œå³curpåªæ˜¯åœ¨åŸæœ¬çš„å…±è¯†ç³»ç»Ÿçš„åŸºç¡€ä¸Šï¼Œæä¾›ä¸€å¥—é¢å¤–çš„é€»è¾‘ï¼Œæ¥åŠ é€ŸåŸæœ¬çš„å…±è¯†ç®—æ³•ï¼Œåœ¨curpåŸæ–‡ä¸­ï¼Œé€‰æ‹©çš„æ˜¯ä½¿ç”¨primary-backupæ¶æ„æ¥ä½œä¸ºåŸºç¡€ï¼Œè€Œåœ¨CURPä½œè€…åœ¨phDè®ºæ–‡ä¸­ï¼Œæ‰©å±•äº†CURPï¼Œæå‡ºäº†CURP-Qï¼Œå…¶æ„å»ºäºå¦‚Raftï¼ŒPaxosç­‰Leader-Followerå…±è¯†ç®—æ³•ä¸Šã€‚\nè€Œetcd/raftæ˜¯ç›®å‰å·¥ä¸šç•Œæ¯”è¾ƒæˆç†Ÿçš„raftå®ç°ï¼Œå…¶å°†raftæŠ½è±¡æˆçŠ¶æ€æœºï¼Œéå¸¸åœ°ç®€å•æ˜“ç”¨ã€‚åŒæ—¶ï¼Œå…¶å®ç°äº†å¦‚check quorum, leader lease prevote æ‰¹å¤„ç†ï¼Œæµæ°´çº¿å‘é€äº†ç­‰ä¼˜åŒ–ï¼Œæ€§èƒ½æœ‰åŸºç¡€ä¿è¯ã€‚å› æ­¤ï¼Œåœ¨æœ¬æ–‡ä¸­ï¼Œç¬”è€…é€‰æ‹©äº†etcd/raftï¼Œå……å½“CURPçš„slow pathï¼Œå†æ¬¡åŸºç¡€ä¸Šï¼Œæ„å»ºäº†CURPã€‚\nCURP Server ectd/raftä»¥åŠå¦‚ä½•ä¸raftäº¤äº’å·²ç»åœ¨ä¸Šä¸€ç« é˜è¿°ï¼Œå› æ­¤åœ¨è¿™é‡Œå°†é‡ç‚¹æ”¾åœ¨CURP Serverçš„çŠ¶æ€æœºä¸Šã€‚CURPçŠ¶æ€æœºçš„è®¾è®¡å‚è€ƒäº† 6.824 å’Œ Xlineã€‚çŠ¶æ€æœºè´Ÿè´£æ¥æ”¶ç½‘ç»œè¯·æ±‚ï¼Œä¸clientå®Œæˆäº¤äº’ã€‚éšåå°†å…¶å‘é€ç»™raftå®Œæˆproposeï¼ŒåŒæ—¶CURPçŠ¶æ€æœºè¿˜è¦ç»´æŠ¤ä¸€ä¸ªkv storeï¼Œå­˜å‚¨å·²ç»commitçš„å†…å®¹ã€‚\nçŠ¶æ€æœºå®šä¹‰å¦‚ä¸‹ï¼Œä¸»è¦åŒ…æ‹¬ï¼š\nKVStoreï¼šå­˜å‚¨å·²ç»commitçš„å†…å®¹ï¼Œè¿™é‡Œé€‰æ‹©äº†boltdbä½œä¸ºæŒä¹…åŒ–å®ç° Witnessï¼šCURPçš„é‡è¦æœºåˆ¶ï¼Œåœ¨followerä¸Šè¿ä½œï¼Œç”¨äºæš‚å­˜æœªæäº¤çš„è¯·æ±‚ä»¥è¿›è¡Œå†²çªæ£€æµ‹ï¼Œç”±äºæ²¡æœ‰å®ç°recoveryï¼Œå› æ­¤è¿™é‡Œç›´æ¥ä½¿ç”¨mapå­˜å‚¨ CommandBoardï¼šè®°å½•ç›®å‰æ¥æ”¶åˆ°çš„è¯·æ±‚ï¼Œå¹¶åœ¨é€‚å½“çš„æ—¶æœºå“åº”Clientç»“æœ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 type StateMachine struct { NodeId int proposeC chan\u003c- string // channel for proposing updates mu sync.RWMutex // kvStore map[string]string // current committed key-value pairs KVStore *xkv.KVStore commandBoard *command.CommandBoard snapshotter *snap.Snapshotter raftState raft.StateType fastPath chan *curp_proto.CurpClientCommand slowPath chan *curp_proto.CurpClientCommand // both fast and slow path will execute commands,this set is used to avoid executing the same command twice commandSet map[command.ProposeId]struct{} witness witness.Witness stateChangeC chan raft.StateType } Witness Witnessæœºåˆ¶æ˜¯CURPçš„æ ¸å¿ƒï¼Œç”¨äºæä¾›å†²çªæ£€æµ‹åŠŸèƒ½ï¼Œè¿™é‡Œçš„å®ç°éå¸¸ç®€å•ï¼Œä»…ä»…åªä½¿ç”¨mapå­˜å‚¨+Mutexå¹¶å‘æ§åˆ¶ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š\n1 2 3 4 type Witness struct { mu sync.Mutex commandMap map[string]map[command.ProposeId]*curp_proto.CurpClientCommand } ç›®å‰å®ç°çš„å†²çªæ£€æµ‹çš„ç­–ç•¥éå¸¸ç®€å•ï¼Œä»…æ”¯æŒkvå±‚é¢ï¼Œå³å¯¹äºåŒä¸€æ¡keyï¼Œå†™-å†™å’Œè¯»-å†™è¿™ä¸¤ç§æƒ…å†µæ˜¯å†²çªçš„ï¼Œåœ¨æ’å…¥ä¸€æ¡è®°å½•æ—¶ï¼Œå¦‚æœæ£€æµ‹åˆ°å†²çªï¼Œé‚£ä¹ˆå°±ç›´æ¥è¿”å›falseï¼Œå¦åˆ™å°†å…¶ä¿å­˜åˆ°mapå½“ä¸­ã€‚\nWitnessä¸­çš„æ•°æ®åº”å½“è¿›è¡ŒæŒä¹…åŒ–ä¿å­˜ï¼Œä»¥ç”¨äºåœ¨å®•æœºåæ¢å¤æ•°æ®ï¼Œç”±äºWitnessä¸­æ•°æ®æ˜¯æš‚å­˜çš„ï¼Œåœ¨commitä¹‹åå°±ä¼šåˆ é™¤ï¼Œå› æ­¤curpåŸæ–‡ä¸­æå‡ºäº†å­˜å‚¨åœ¨NVMç­‰ç¡¬ä»¶ä¸Šä¼šæ›´åˆé€‚ã€‚è¿™é‡Œç”±äºæš‚æ—¶æ²¡æœ‰å®ç°recoveryæœºåˆ¶ï¼Œæ‰€ä»¥ç›®å‰æ˜¯ç›´æ¥ä½¿ç”¨mapå­˜å‚¨ã€‚\nCommandBoard CmdBoardçš„ä½œç”¨ä¸ºè®°å½•æ¥æ”¶åˆ°çš„è¯·æ±‚ï¼Œç­‰å¾…è¯·æ±‚æ‰§è¡Œå®Œæˆï¼Œè€Œå…·ä½“çš„æ‰§è¡Œåˆ™äº¤ç»™ CommandWorker æ¥å®Œæˆï¼Œå‰å°æ¥æ”¶è¯·æ±‚çš„çº¿ç¨‹åªéœ€è¦é€šè¿‡CommandBoardæ¥è·å–ç»“æœï¼Œå¹¶ç»“æœå“åº”ç»™å®¢æˆ·ç«¯ã€‚ä¸è¿‡ç”±äºCURPå­˜åœ¨fast pathå’Œslow pathçš„æ¦‚å¿µï¼Œå› æ­¤ä¼šç¨å¾®å¤æ‚ä¸€äº›ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 type CommandBoard struct { mu sync.Mutex // store all notifiers for execution results erNotifiers map[ProposeId]chan string // store all notifiers for after sync results asrNotifiers map[ProposeId]chan struct{} erBuffer map[ProposeId]string asrBuffer map[ProposeId]struct{} } er ä¸º execution resultï¼Œasr å³ä¸º async execution resultï¼Œåˆ†åˆ«ä»£è¡¨fast pathå’Œslow pathçš„æ‰§è¡Œç»“æœã€‚ è¯·æ±‚é€šè¿‡ ProposeId æ¥æ ‡è¯†ï¼ŒProposeId ä¸º ClientId å’Œ SeqId çš„ç»„åˆï¼Œä»¥åŒºåˆ†ä¸åŒClientçš„ä¸åŒè¯·æ±‚ï¼š\n1 2 3 4 type ProposeId struct { ClientId uint64 SeqId uint64 } leaderåœ¨é€šè¿‡fast pathæ‰§è¡Œè¯·æ±‚ï¼Œåœ¨æ¥æ”¶åˆ°è¯·æ±‚åï¼Œä¼šé€šè¿‡ WaitForEr() æ¥ç­‰å¾…fast pathçš„æ‰§è¡Œç»“æœï¼Œåœ¨ WaitForEr() ä¸­ï¼Œæ¶‰åŠåˆ°erBufferå’ŒerNotifiersã€‚erBufferç”¨äºç¼“å­˜å‘½ä»¤çš„æ‰§è¡Œç»“æœï¼Œç»fast pathå®Œæˆæ‰§è¡Œçš„å†…å®¹éƒ½ä¼šå­˜å‚¨åˆ°å…¶ä¸­ï¼Œè€ŒerNotifiersåˆ™å­˜å‚¨ä¸€ä¸ªchannelï¼Œå‰å°ç›‘å¬è¯¥channelï¼Œç­‰å¾…æ‰§è¡Œç»“æœã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 func (c *CommandBoard) WaitForEr(id ProposeId) string { c.mu.Lock() if result, ok := c.erBuffer[id]; ok { c.mu.Unlock() return result } if _, ok := c.erNotifiers[id]; !ok { c.erNotifiers[id] = make(chan string, 1) } notifyChan := c.erNotifiers[id] c.mu.Unlock() result := \u003c-notifyChan c.erBuffer[id] = result return result } WaitForAsr ç”¨äºç­‰å¾…commandåœ¨slow pathä¸­å®Œæˆå…±è¯†ï¼Œè¿”å›æ‰§è¡Œçš„ç»“æœã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 func (c *CommandBoard) WaitForAsr(id ProposeId) string { c.mu.Lock() defer c.mu.Unlock() //trace.Trace(trace.Client, \"Wait Synced [clientId: %d,seqId: %d]\", id.ClientId, id.SeqId) _, asrOk := c.asrBuffer[id] result, erOk := c.erBuffer[id] defer delete(c.asrBuffer, id) defer delete(c.erBuffer, id) // command has already been executed in both fast path and slow path if asrOk \u0026\u0026 erOk { return result } if _, ok := c.asrNotifiers[id]; !ok { c.asrNotifiers[id] = make(chan struct{}, 1) } notifyChan := c.asrNotifiers[id] // release lock and wait c.mu.Unlock() \u003c-notifyChan c.mu.Lock() if result, ok := c.erBuffer[id]; ok { return result } // UNREACHABLE return \"NOT FOUND IN BUFFER\" } Why Buffer åœ¨ 6.824 ä¸­ï¼Œæ‰§è¡Œç»“æœé€šè¿‡ä¸€ä¸ªchannelå³å¯ä¼ é€’ï¼Œä½†æ˜¯è¿™é‡Œé¢å¤–ä½¿ç”¨ä¸€ä¸ªBufferä¸»è¦æ˜¯ç”¨äºå…¼å®¹slow pathï¼Œæ¥ä¿è¯çº¿æ€§ä¸€è‡´æ€§ã€‚erå’Œasréƒ½å¼•å…¥äº†bufferï¼ŒäºŒè€…éœ€è¦åˆ†å¼€è®¨è®º\né¦–å…ˆè¯´æ˜ä¸€ä¸‹ä¸ºä»€ä¹ˆéœ€è¦ erBuffer ã€‚è®¾æƒ³è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼šclient1 å…ˆ cmd1 set a = 1ï¼Œéšåclient 1 å‘é€ cmd 2 get aï¼Œæ­¤æ—¶è¢«witnessæ£€æµ‹åˆ°å†²çªï¼Œéœ€ç­‰å¾…slow pathæ‰§è¡Œå®Œæ¯•ï¼Œæ­¤æ—¶ï¼Œclient 1 åˆå‘é€äº† cmd 3 set a = 3ï¼Œç”±äºleaderä¸ŠWitnessæ˜¯å…³é—­çš„ï¼Œset a = 3 å¯ä»¥ç›´æ¥æ‰§è¡Œï¼Œè¿™ä¼šå¯¼è‡´cmd3 åœ¨cmd2 ä¹‹å‰è¢«æ‰§è¡Œï¼Œå¯¹äºclientè€Œè¨€ï¼Œè§‚æµ‹åˆ°çš„ç»“æœä¸å‘é€é¡ºåºä¸ä¸€è‡´ã€‚\nå› æ­¤ï¼Œcmd2 ä¸èƒ½ç­‰å¾…ä»slow pathä¸­commitæ‰æ‰§è¡Œï¼Œè€Œæ˜¯åº”å½“åœ¨fast pathä¸­æ‰§è¡Œå®Œæˆï¼Œä¿å­˜ç»“æœï¼Œç­‰åˆ°å¯¹åº”çš„æ—¥å¿—commitä¹‹åï¼Œå†å°†è¯¥ç»“æœè¿”å›ç»™clientã€‚\nå¯¹äºä¸åŒçš„clientæ¥è¯´ï¼Œå³cmd1 cmd3 ç”±client 1 å‘é€ï¼Œcmd2 ç”±client 2 å‘é€ï¼Œæ­¤æ—¶cmd2 å’Œcmd3 å¤„äºä¸€ç§å¹¶å‘çš„çŠ¶æ€ï¼Œæ˜¯å…è®¸ä»¥ä»»æ„çš„ç»“æœå®Œæˆæ‰§è¡Œçš„ï¼Œä½†æ˜¯å¦‚æœåªæœ‰ä¸€ä¸ªclientï¼Œåˆ™ä¼šè¿èƒŒçº¿æ€§ä¸€è‡´æ€§ã€‚\nè€Œ AsrBuffer ä¸»è¦æ˜¯ç”¨äºè§£å†³slow pathçš„å¼‚æ­¥æ‰§è¡Œé—®é¢˜ï¼Œå¦‚æœåå°raft commitçš„æ•ˆç‡æ¯”è¾ƒé«˜ï¼Œé‚£ä¹ˆä¼šå¯¼è‡´åœ¨clientè°ƒç”¨WaitSyncedä¹‹å‰å°±å·²ç»commitå®Œæ¯•ï¼Œæ­¤æ—¶å¦‚æœåˆ›å»ºä¸€ä¸ªchannelå¹¶ç›‘å¬ï¼Œé‚£ä¹ˆåç»­å°±ä¼šæ°¸è¿œæ— æ³•æ¥æ”¶åˆ°ç»“æœã€‚\nå¯¹äºè¿™ä¸ªé—®é¢˜ï¼Œæœ‰ä¸¤ä¸ªè§£å†³æ–¹æ¡ˆï¼Œä¸€æ˜¯éå†å½“å‰commit idå‰æ‰€æœ‰å¯¹åº”çš„channelï¼Œå…¨éƒ¨é€šçŸ¥ä¸€éï¼ŒäºŒå°±æ˜¯æ·»åŠ ä¸€ä¸ªç¼“å­˜ï¼Œå¯ä»¥é€šè¿‡å…ˆæŸ¥è¯¢bufferæ¥åˆ¤æ–­æ˜¯å¦æ‰§è¡Œå®Œæˆï¼Œå¦‚æœæ²¡æœ‰ï¼Œåç»­å†é€šè¿‡channelç›‘å¬ç»“æœã€‚bufferå½“ä¸­åªéœ€è¦å­˜å‚¨ä¸€ä¸ªç©ºstruct{}ï¼Œèµ·åˆ°é€šçŸ¥ä½œç”¨å³å¯ã€‚ä¸ªäººè®¤ä¸ºç¬¬ä¸€ç§å®ç°æ–¹å¼ä¼˜é›…ä¸€äº›ï¼Œå› æ­¤å°±å¼•å…¥äº†bufferã€‚\nCommand Worker ä¸Command Boardç›¸å¯¹åº”çš„æ˜¯Command Workerï¼ŒCommand Boardè®°å½•è¯·æ±‚ï¼ŒWorkerè´Ÿè´£å…·ä½“çš„æ‰§è¡Œã€‚\nCommand Workerä¸­ä¼šåˆ†åˆ«ä»fast pathå’Œslow pathä¸­æ¥æ”¶è¯·æ±‚ï¼š\nleaderåœ¨æ¥æ”¶åˆ°è¯·æ±‚ä¹‹åï¼Œä¼šç›´æ¥å°†å…¶é€šè¿‡fast path channelå‘é€è‡³cmd workerå¤„ï¼Œfolloweråªè¿›è¡Œwitnessä¸æ‰§è¡Œï¼Œå› æ­¤ä¸ä¼šä»fast pathä¸­æ¥æ”¶ä»»ä½•å†…å®¹ã€‚leaderæ‰§è¡Œå®Œæˆä¹‹åå°±å¯ä»¥é€šè¿‡ InsertEr å°†ç»“æœæ·»åŠ åˆ°Command Boardå½“ä¸­ï¼Œé€šçŸ¥å‰å°è¿”å›ç»“æœç»™client\nraftä¼šå°†å·²ç»commitäº†çš„è¯·æ±‚é€šè¿‡slow pathå‘é€è‡³cmd workerã€‚ç”±äºleaderå·²ç»é€šè¿‡fast pathæ‰§è¡Œè¿‡ä¸€æ¬¡äº†ï¼Œå› æ­¤leaderåœ¨è¿™é‡Œåº”å½“å¿½ç•¥æ‰è¯¥è¯·æ±‚ï¼Œè€Œfolloweråº”å½“æ‰§è¡Œæ¥è·Ÿéšleaderçš„çŠ¶æ€ã€‚ è¿™ä¸€éƒ¨åˆ†ä¸ä¼ ç»Ÿraftæœ€å¤§çš„ä¸åŒå°±æ˜¯ï¼šleaderä¼šé€šè¿‡fast pathè¿›è¡Œâ€œæŠ¢è·‘â€ï¼Œä»è€Œç»™ç³»ç»Ÿå¼•å…¥äº†é¢å¤–çš„å¤æ‚åº¦ï¼š\nLeaderé€šè¿‡fast pathæå‰æ‰§è¡Œï¼Œä¿®æ”¹äº†çŠ¶æ€æœºï¼Œä½†æ˜¯ç”±äºwitnessæœºåˆ¶çš„å­˜åœ¨ï¼Œè¿™ä¸ªæ‰§è¡Œç»“æœåœ¨commitä¹‹å‰æ˜¯ä¸ä¼šæš´éœ²ç»™clientçš„ã€‚\nLeaderæå‰ä¿®æ”¹äº†çŠ¶æ€æœºï¼Œé‚£ä¹ˆslow pathä¸­çš„å†…å®¹å°±æ— éœ€å†æ‰§è¡Œä¸€éï¼Œé¢å¤–å†™ä¸€ékv storeçš„å¼€é”€æ¯”è¾ƒé«˜ã€‚å¦‚æœslow pathä¼šå†æ‰§è¡Œä¸€éï¼Œè™½ç„¶å¯èƒ½ä¼šå¯¼è‡´fast pathå’Œslow pathçš„å†…å®¹ç›¸äº’è¦†ç›–ï¼Œä½†æ˜¯ç”±äºå†²çªæ£€æµ‹çš„æœºåˆ¶å­˜åœ¨ï¼Œç›¸äº’è¦†ç›–çš„ä¸­é—´æ€ä¸ä¼šå¯¹å¤–æš´éœ²ï¼Œå› æ­¤æ‰§è¡Œä¸€éslowä¹Ÿä¸ä¼šå½±å“æ­£ç¡®æ€§ï¼Œç­‰åˆ°commitåï¼ŒçŠ¶æ€æœºä¸åªæ‰§è¡Œfastæ— å¼‚ã€‚Leaderé€šè¿‡fast pathå·²ç»å®Œæˆäº†æŒä¹…åŒ–ï¼Œå› æ­¤Leaderä¹Ÿä¸ä¼šä¾èµ–raft logæ¥å®Œæˆrecoveryã€‚\nFolloweræ²¡æœ‰é¢å¤–çš„åŠ¨ä½œï¼Œåªéœ€è¦witnessåˆ¤æ–­å†²çªï¼Œå¹¶ä¸”é€šè¿‡slow pathæ¥è·Ÿéšleaderçš„çŠ¶æ€å³å¯ã€‚\næ­¤å¤–è¿˜æœ‰ä¸€ä¸ªCommandSetï¼Œç”¨äºå¯¹å‘½ä»¤è¿›è¡Œå»é‡ï¼Œé˜²æ­¢å·²ç»æ‰§è¡Œè¿‡ä¸€éï¼Œä½†æ˜¯æ²¡æ¥åŠå“åº”clientï¼Œå®•æœºï¼Œéšåclientåˆé‡è¯•ï¼Œå¯¼è‡´å‘½ä»¤è¢«é‡å¤æ‰§è¡Œã€‚åœ¨ 6.824 çš„lab3 ä¸­ï¼Œéœ€è¦è¿™æ ·ä¸€ä¸ªè®¾è®¡æ˜¯å› ä¸ºå…¶ä¸­çš„appendå‘½ä»¤æ˜¯ä¸å¹‚ç­‰çš„ï¼Œå³ä¼šåœ¨åŸæœ‰valueçš„åŸºç¡€ä¸Šè¿½åŠ æ•°æ®ï¼Œè€Œå¦‚æœå°†å‘½ä»¤è®¾è®¡æˆå¹‚ç­‰çš„ï¼Œå°±ä¸éœ€è¦è¿™ä¸ªCommandSetäº†ï¼Œå‘½ä»¤é‡å¤æ‰§è¡Œä¹Ÿä¸ä¼šäº§ç”Ÿè´Ÿé¢å½±å“ã€‚\nCommand Workeræ˜¯å•çº¿ç¨‹æ‰§è¡Œçš„ï¼Œä»¥ç¡®ä¿çº¿æ€§ä¸€è‡´æ€§ã€‚ä½†å®é™…ä¸Šï¼Œæ­£å¦‚CURPæœ¬èº«çš„æ€æƒ³â€”â€”å…¨å±€é¡ºåºæ˜¯ä¸å¿…è¦çš„ï¼Œå¯ä»¥å°†å…¨å±€é¡ºåºç¼©å°èŒƒå›´åˆ°å­˜åœ¨å†²çªçš„keyä¹‹é—´ç»´æŠ¤ä¸€ä¸ªé¡ºåºã€‚åœ¨å®ç°ä¸Šå¯ä»¥ç»´æŠ¤å¤šä¸ªworkerï¼Œå°†å­˜åœ¨å†²çªçš„keyåˆ†é…è‡³åŒä¸€ä¸ªworkerå¤„ï¼Œç¡®ä¿èƒ½å¤ŸæŒ‰ç…§é¡ºåºæ¥æ‰§è¡Œã€‚ä¸åŒworkerä¹‹é—´ç”±äºä¸å­˜åœ¨å†²çªï¼Œå¯ä»¥å¹¶è¡Œæ‰§è¡Œã€‚\næ­¤å¤–ï¼Œç”±äºkvstoreå’ŒcommandSetåªä¼šåœ¨è¿™é‡Œä¿®æ”¹ï¼ŒåŠ ä¸Šå…¶ä¸ºå•çº¿ç¨‹ï¼Œå› æ­¤è¿™é‡Œå®Œå…¨å¯ä»¥ä¸åŠ é”æ‰§è¡Œï¼Œä¸´ç•ŒåŒºä»…ä»…åªæœ‰åˆ¤æ–­å½“å‰èŠ‚ç‚¹çŠ¶æ€\nè¿™é‡Œçš„å®ç°å¯ä»¥å‚è€ƒXlineï¼Œå…¶ä¸­å®ç°äº†ä¸€ä¸ªéå¸¸å®Œå¤‡çš„å†²çªæ£€æµ‹é˜Ÿåˆ— + workerï¼šzhuanlan.zhihu.com/p/662504235\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 func (s *StateMachine) cmdWorker() { for { select { case cmd := \u003c-s.fastPath: trace.Trace(trace.Fast, s.NodeId, \"got cmd from fast path %v\", cmd) proposeId := command.ProposeId{ ClientId: cmd.ClientId, SeqId: cmd.SeqId, } if _, ok := s.commandSet[proposeId]; ok { // command executed before,nothing to do trace.Trace(trace.Fast, s.NodeId, \"cmd already executed %v\", cmd) } else { s.commandSet[proposeId] = struct{}{} result := s.execute(cmd) trace.Trace(trace.Fast, s.NodeId, \"cmd %v executed,result is %v\", cmd, result) s.commandBoard.InsertEr(proposeId, result) } case cmd := \u003c-s.slowPath: s.mu.Lock() isLeader := s.raftState == raft.StateLeader s.mu.Unlock() trace.Trace(trace.Slow, s.NodeId, \"got cmd from slow path %v\", cmd) if _, ok := s.commandSet[cmd.ProposeId()]; ok || isLeader { // command executed before,nothing to do trace.Trace(trace.Slow, s.NodeId, \"cmd already executed %v\", cmd) } else { s.commandSet[cmd.ProposeId()] = struct{}{} s.execute(cmd) } trace.Trace(trace.Slow, s.NodeId, \"WAIT Notify result in slow path,proposeId:[clientId: %d,seqId: %d]\", cmd.ClientId, cmd.SeqId) s.commandBoard.NotifyAsr(cmd.ProposeId()) trace.Trace(trace.Slow, s.NodeId, \"Notify result in slow path,proposeId:[clientId: %d,seqId: %d]\", cmd.ClientId, cmd.SeqId) // when command is committed, it can be remove from witness and command set safely s.removeRecord(cmd.ProposeId()) } } } // we don't need to lock this function,because it's the only func which modifies KVStore func (s *StateMachine) execute(cmd *curp_proto.CurpClientCommand) string { if cmd.Op == command.PUT { s.KVStore.Put(cmd.Key, cmd.Value) } else if cmd.Op == command.DELETE { s.KVStore.Delete(cmd.Key) } else if cmd.Op == command.GET { result, err := s.KVStore.Get(cmd.Key) if err != nil { return \"NOT FOUND IN STATE\" } else { return result } } // unreachable! return \"\" } Fast Path åœ¨åˆ†æå®ŒCommand Boardå’ŒCommand Workerä¹‹åï¼Œå°±å¯ä»¥ä¸²é€šCURPçš„fast pathå’Œslow pathçš„å…¨æµç¨‹äº†ã€‚ fast pathé€šè¿‡ Propose () å®Œæˆï¼Œæ— è®ºè¯»å†™è¯·æ±‚éƒ½ä¼šè¢«å°è£…æˆä¸€ä¸ªClientCommandï¼Œéšåè°ƒç”¨ Propose() ï¼Œæµç¨‹å¦‚ä¸‹ï¼š\né¦–å…ˆè¿›è¡Œå†²çªæ£€æµ‹ï¼Œå°†è¯·æ±‚æ·»åŠ åˆ°Witnesså½“ä¸­ï¼Œå¹¶ä¸”è¿”å›æ˜¯å¦å†²çª followeråœ¨fast pathä¸­åªèµ·åˆ°witnessä½œç”¨ã€‚å¦‚æœå½“å‰èŠ‚ç‚¹éLeaderï¼Œé‚£ä¹ˆæ­¤æ—¶å°±å¯ä»¥è¿”å›äº†ï¼Œå“åº”CONFLICTæˆ–è€…ACCEPT å¯¹äºLeaderåç»­åº”å½“ç›´æ¥ç»§ç»­æ‰§è¡Œï¼Œé€šè¿‡fast pathçš„channelå°†cmdäº¤ç»™ cmd workerï¼Œå¹¶é€šè¿‡proposeCå°†cmdä¼ é€’ç»™raft é€šè¿‡CommandBoardç­‰å¾…ç»“æœï¼Œå“åº”ç»™Client 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 func (s *StateMachine) Propose(cmd *curp_proto.CurpClientCommand) *curp_proto.CurpReply { isConflict := s.witness.InsertIfNotConflict(cmd) s.mu.Lock() if s.raftState == raft.StateLeader { trace.Trace(trace.Leader, s.NodeId, \"propose command %s,type: %s,conflict: %v\", cmd.Key, command.OpFmt[cmd.Op], isConflict) } else { trace.Trace(trace.Follower, s.NodeId, \"propose command %s,type: %s,conflict: %v\", cmd.Key, command.OpFmt[cmd.Op], isConflict) } reply := \u0026curp_proto.CurpReply{ Content: \"\", } if s.raftState != raft.StateLeader { if isConflict { s.mu.Unlock() reply.StatusCode = curp_proto.CONFLICT return reply } else { s.mu.Unlock() reply.StatusCode = curp_proto.ACCEPTED return reply } } buf := cmd.Encode() go func() { s.fastPath \u003c- cmd }() // command will update the state machine or get command is conflict trace.Trace(trace.Leader, s.NodeId, \"send propose[clientId:%d seqId: %d] msg to raft node\", cmd.ClientId, cmd.SeqId) go func() { s.proposeC \u003c- buf }() s.mu.Unlock() proposeId := command.ProposeId{ ClientId: cmd.ClientId, SeqId: cmd.SeqId, } result := s.commandBoard.WaitForEr(proposeId) reply.Content = result if isConflict { reply.StatusCode = curp_proto.CONFLICT } else { reply.StatusCode = curp_proto.ACCEPTED } return reply } è¿™é‡Œæœ‰ä¸€ä¸ªç»†èŠ‚ï¼Œåœ¨CURP-Qçš„è®ºæ–‡å½“ä¸­æè¿°ï¼šLeaderçš„witnessåº”å½“æ˜¯å…³é—­çš„ï¼Œå³Leaderå¹¶ä¸è¿›è¡Œå†²çªæ£€æµ‹ï¼Œå¯¹äºæ‰€æœ‰è¯·æ±‚éƒ½ç›´æ¥æ‰§è¡Œï¼Œä½†æ˜¯åœ¨Xlineçš„å®ç°ä¸­ï¼ŒLeaderæ˜¯å¯åŠ¨äº†Witnesså¹¶è¿›è¡Œå†²çªæ£€æµ‹çš„ã€‚å¯¹äºè¿™ä¸ªç»†èŠ‚ï¼Œä¸ªäººè®¤ä¸ºå¹¶ä¸ä¼šå¯¹å¹¶ä¸ä¼šå¯¹ç³»ç»Ÿæ­£ç¡®æ€§äº§ç”Ÿå½±å“ï¼Œæš‚æ—¶æ²¡æœ‰æ·±ç©¶ã€‚\nWitnesses in leaders are inactive, and all client requests are serialized and logged in their command logs directly.\nSlow Path Slow Pathçš„å…¥å£å¾ˆç®€å•ï¼Œåªéœ€è¦è°ƒç”¨ WaitForAsr() æ¥ç­‰å¾…commitå³å¯ï¼Œé€šè¿‡ WaitSynced() æ¥å®ç°\n1 2 3 4 5 6 7 8 9 10 11 func (s *StateMachine) WaitSynced(id command.ProposeId) *curp_proto.CurpReply { // only send wait synced message to leader trace.Trace(trace.Leader, s.NodeId, \"got wait synced message: %v\", id) result := s.commandBoard.WaitForAsr(id) reply := \u0026curp_proto.CurpReply{ Content: result, StatusCode: curp_proto.ACCEPTED, } trace.Trace(trace.Leader, s.NodeId, \"wait synced finished,id: %v,result: %v\", id, result) return reply } åœ¨Fast Pathä¸­ï¼ŒLeaderä¼šé€šè¿‡proposeCå‘é€ç»™Raftï¼Œæ­¤æ—¶å°±ç›¸å½“äºè¿›å…¥äº†Slow Pathï¼Œåœ¨Raftä¸­ï¼Œå®Œæˆå…±è¯†çš„cmdä¼šé€šè¿‡Readyè¿”å›ï¼Œç»RaftNodeè½¬æ‰‹åˆé€šè¿‡commitCå‘é€ä¼šäº†çŠ¶æ€æœºï¼ŒçŠ¶æ€æœºæ”¶åˆ°ä¹‹åï¼Œå¯¹cmdè¿›è¡Œdecodeï¼Œéšæœºé€šè¿‡slow path channelåˆå°†è¯·æ±‚å‘é€ç»™äº†cmd worker\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 func (s *StateMachine) readCommits(commitC \u003c-chan *commit, errorC \u003c-chan error) { for commit := range commitC { if commit == nil { // signaled to load snapshot snapshot, err := s.loadSnapshot() if err != nil { log.Panic(err) } if snapshot != nil { log.Printf(\"loading snapshot at term %d and index %d\", snapshot.Metadata.Term, snapshot.Metadata.Index) if err := s.recoverFromSnapshot(snapshot.Data); err != nil { log.Panic(err) } } continue } for _, data := range commit.data { var cmd curp_proto.CurpClientCommand dec := gob.NewDecoder(bytes.NewBufferString(data)) if err := dec.Decode(\u0026cmd); err != nil { log.Fatalf(\"raftexample: could not decode message (%v)\", err) } s.slowPath \u003c- \u0026cmd } close(commit.applyDoneC) } if err, ok := \u003c-errorC; ok { log.Fatal(err) } } ä¹‹åå°±æ˜¯cmd workerçš„é€»è¾‘äº†ï¼Œåœ¨ä¸Šé¢å·²ç»åˆ†æè¿‡äº†ï¼Œè¿™é‡Œç®€è¦æ•´åˆä¸€ä¸‹ã€‚å¯¹äºleaderè€Œè¨€ï¼Œç›´æ¥å¿½ç•¥slow pathä¸­çš„å†…å®¹ï¼Œä»¥å…å†…å®¹è¦†ç›–å½±å“çº¿æ€§ä¸€è‡´æ€§ã€‚è€Œå¯¹äºfollowerè€Œè¨€ï¼Œç›´æ¥åº”ç”¨ä»¥è·ŸéšLeaderã€‚slow pathæ‰§è¡Œå®Œæˆï¼Œå³å¯è®¤å®šå…¶ä¸ºcommitï¼Œæ­¤æ—¶å¯ä»¥é€šè¿‡ NotifyAsr è·å–æ‰§è¡Œç»“æœï¼Œå¹¶é€šçŸ¥ WaitSynced ç»“æŸé˜»å¡ã€‚\nCURP Client å¯¹åº”åœ°ï¼Œåœ¨CURP Clientç«¯ä¹Ÿåˆ†ä¸ºäº†fast pathå’Œslow pathï¼Œå‡é€šè¿‡grpcå®ç°ï¼Œæ­¤å¤–ï¼Œè¿˜éœ€è¦ä¸€ä¸ªisLeaderæ¥ç¡®å®šserverä¸­çš„leaderï¼Œä»¥ç¡®å®šåº”å½“å‘è°å‘é€ WaitSynced()ã€‚\nFast path åœ¨fast pathä¸­ï¼Œclientéœ€è¦åšçš„å°±æ˜¯å°†è¯·æ±‚å¹¿æ’­ç»™æ‰€æœ‰çš„serverï¼Œç„¶åç›‘å¬ç»Ÿè®¡ç»“æœï¼š\nå¦‚æœå“åº”ç»“æœä¸­å­˜åœ¨å†²çªï¼Œé‚£ä¹ˆå°±è¿”å›å†²çªï¼Œåç»­è½¬å‘slow round å¦‚æœè¾¾åˆ°äº†superquorum (fä¸ªèŠ‚ç‚¹ï¼Œå¯¹åº”ä¸ºf + f / 2 + 1ï¼Œå³ 4 èŠ‚ç‚¹éœ€è¦ 3 ä¸ªï¼Œ3 èŠ‚ç‚¹éœ€è¦ 3ä¸ª )ï¼Œå°±è¿”å›è¯·æ±‚æˆåŠŸ è¶…æ—¶æ£€æµ‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 func (c *GrpcClient) fastRound(cmd *curp_proto.CurpClientCommand, notifyC []chan *curp_proto.CurpReply) (*curp_proto.CurpReply, error) { timeout := time.NewTicker(time.Second * 5) fastPathChan := make(chan *curp_proto.CurpReply) for i := 0; i \u003c len(c.grpc_servers); i++ { go func(i int) { c.sendC[i] \u003c- cmd result := \u003c-notifyC[i] fastPathChan \u003c- result }(i) } acceptedCount := 0 result := \u0026curp_proto.CurpReply{ StatusCode: curp_proto.TIMEOUT, Content: \"\", } for { select { case fastResult := \u003c-fastPathChan: trace.Trace(trace.Client, -1, \"client receive fast path result: %v\", fastResult) if fastResult.StatusCode == curp_proto.ACCEPTED { acceptedCount++ if fastResult.Content != \"\" { result = fastResult } } else { return fastResult, nil } if acceptedCount == c.superQuorum() { return result, nil } case \u003c-timeout.C: fmt.Printf(\"timeout !!\\n\") return result, fmt.Errorf(\"fast path time out\") } } } slow path slow pathæ¯”è¾ƒç®€å•ï¼Œåªéœ€è¦å°†è¯·æ±‚å‘é€ç»™Leaderå³å¯\n1 2 3 4 5 6 7 8 9 10 11 func (c *GrpcClient) slowRound(cmd *curp_proto.CurpClientCommand, notifyC []chan *curp_proto.CurpReply) (string, error) { sync_cmd := \u0026curp_proto.CurpClientCommand{ClientId: cmd.ClientId, SeqId: cmd.SeqId, Sync: 1} c.sendC[c.LeaderId] \u003c- sync_cmd reply := \u003c-notifyC[c.LeaderId] trace.Trace(trace.Client, -1, \"client wait synced finished, id: %v\", cmd.ProposeId) if reply.StatusCode == curp_proto.CONFLICT { return \"\", fmt.Errorf(\"command is still conflict after wait synced\") } return reply.Content, nil } éšåï¼Œå°†fast pathå’Œslow pathåšä¸€ä¸ªæ•´åˆï¼Œå°è£…æˆ Propose() ï¼Œåœ¨ Propose() ä¸­ï¼š\né¦–å…ˆè°ƒç”¨ fast_round() ï¼Œå°†è¯·æ±‚è¿›è¡Œå¹¿æ’­ï¼Œå¦‚æœä¸å­˜åœ¨å†²çªï¼Œé‚£ä¹ˆå°±å¯ä»¥ç›´æ¥è¿”å›ï¼Œä»£è¡¨æ­¤æ¬¡è¯·æ±‚åœ¨ 1 ä¸ªRTTå†…ç»“æŸ å¦‚æœ fast_round() ä¸­å­˜åœ¨å†²çªï¼Œé‚£ä¹ˆå†è°ƒç”¨ slow_round()ï¼Œé€šè¿‡ serverå¯¹ Waitsynced() æ¥ç­‰å¾…commitï¼Œè§£å†³å†²çª 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 func (c *GrpcClient) Propose(cmd *curp_proto.CurpClientCommand) (string, error) { ntfC := c.NewNotifyC(cmd.SeqId) defer c.DeleteNotifyC(cmd.SeqId) reply, err := c.fastRound(cmd, ntfC) if err != nil { return \"\", err } if reply.StatusCode == curp_proto.ACCEPTED { c.static.fast++ return reply.Content, nil } c.static.slow++ trace.Trace(trace.Client, -1, \"client receive conflict result, turn to slow path: %v\", reply) resultStr, err := c.slowRound(cmd, ntfC) return resultStr, err } è¿™é‡Œæœ‰ä¸€ä¸ªå°çš„ä¼˜åŒ–ï¼Œå³å¯ä»¥åŒæ—¶å‘é€fast roundå’Œslow roundè¯·æ±‚ï¼Œè¿™æ ·å¯ä»¥æ›´å¿«åœ°è·å–WaitSyncedçš„ç»“æœã€‚\nbenchmark è¿™é‡Œä½¿ç”¨benchmarkå¯¹curpçš„æ€§èƒ½åšäº†ä¸€ä¸ªç®€å•çš„æµ‹è¯•ï¼Œé€‰æ‹©çš„æ˜¯æ¯”è¾ƒé€šç”¨çš„go-ycsbï¼Œå€Ÿç”¨äº†ä¸€ä¸‹go-ycsbçš„åŠ è½½æ•°æ®å’Œç»Ÿè®¡ç»“æœçš„åŠŸèƒ½ï¼Œç„¶åè‡ªå·±é€šè¿‡tcpä¸ºcurpå®ç°äº†ä¸€ä¸ªserverï¼Œç„¶ååœ¨ycsbä¸­å®ç°äº†ä¸€ä¸ªclientï¼Œè¿™æ ·å°±å¯ä»¥æŠŠè¯·æ±‚ä»ycsbæˆåŠŸå‘é€åˆ°curpäº†ã€‚\nè¿™é‡Œå®ç°çš„ç¡®å®æ˜¯æ¯”è¾ƒè‰ç‡ï¼Œä½†æ˜¯ä½ å°±è¯´èƒ½ä¸èƒ½ç”¨å§ğŸ˜€\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 type GetResponse struct { Count int64 Kvs []*Command } func (r *GetResponse) Encode() []byte { buf := \u0026bytes.Buffer{} enc := gob.NewEncoder(buf) err := enc.Encode(r) if err != nil { fmt.Println(\"encode error:\", err) } return buf.Bytes() } const ( GET uint8 = iota PUT DELETE ) type Command struct { Op uint8 Key string Value string } func bench_server(port string, client *curp.GrpcClient) { listener, err := net.Listen(\"tcp\", port) if err != nil { fmt.Println(\"Error listening:\", err.Error()) os.Exit(1) } defer listener.Close() fmt.Printf(\"Server is listening on :%v\\n\", port) for { conn, err := listener.Accept() if err != nil { fmt.Println(\"Error accepting: \", err.Error()) os.Exit(1) } go handleRequest(conn, client) } } func handleRequest(conn net.Conn, client *curp.GrpcClient) { buf := make([]byte, 4096) n, _ := conn.Read(buf) aCmd := \u0026Command{} dec := gob.NewDecoder(bytes.NewReader(buf[:n])) err := dec.Decode(aCmd) if err != nil { fmt.Println(err) return } // fmt.Printf(\"Received: %+v\\n\", aCmd) if aCmd.Op == GET { // call client.get key := aCmd.Key // value := \"myValue\" value, _ := client.Get(aCmd.Key) cmd := Command{ Op: GET, Key: key, Value: value, } cmds := []*Command{\u0026cmd} resp := GetResponse{ Count: 1, Kvs: cmds, } buf := resp.Encode() conn.Write(buf) } else if aCmd.Op == PUT { // call client.put client.Put(aCmd.Key, aCmd.Value) conn.Write([]byte(\"Received PUT Response!\")) } else if aCmd.Op == DELETE { // call client.delete client.Del(aCmd.Key) conn.Write([]byte(\"Received DELETE Response!\")) } } è·‘äº†ä¸€ä¸ªç®€å•çš„benchmarkï¼Œç”±äºæ²¡æœ‰å®ç°scanæ“ä½œï¼Œå› æ­¤å°±åªé€‰æ‹©äº†ycsbä¸­çš„workload a-b-cï¼Œå…¶ä¸­workloadaä¸º 50%read 50%writeï¼Œworkloadbä¸º 95%read 5% writeï¼Œworkloadc 100% read,ã€‚\nå¯ä»¥çœ‹åˆ°æ— è®ºæ˜¯å“ªä¸ªworkloadï¼Œcurpçš„æ€§èƒ½å‡å¥½äºraftï¼Œå¯¹äºaï¼Œå¤§çº¦æ˜¯ä¸ª 20-30%çš„æå‡ï¼Œb, cç”±äºä¸»è¦æ˜¯è¯»è¯·æ±‚ä¸ºä¸»ï¼Œcurpä¸­åªéœ€è¦ä¸€è½®rttåŠ æŸ¥è¯¢çŠ¶æ€æœºå³å¯ï¼Œè€Œraftéœ€è¦èµ°ä¸€éæ—¥å¿—å¤åˆ¶+æŸ¥è¯¢çŠ¶æ€æœºï¼Œå› æ­¤å·®è·è¢«è¿›ä¸€æ­¥æ‹‰å¤§ï¼ˆè¿™é‡ŒäºŒè€…éƒ½æ²¡æœ‰å¼€å¯çº¿æ€§ä¸€è‡´æ€§è¯»ä¼˜åŒ–çš„ï¼Œå³lease readæˆ–read indexï¼‰\nè¿™ä¸ªbenchmarkæ˜¯åœ¨å•æœºä¸Šè·‘çš„ï¼Œå¦‚æœçœŸæ­£åˆ°äº†è·¨åŸŸçš„é«˜ç½‘ç»œå»¶è¿Ÿçš„åœºæ™¯ä¸‹ï¼Œå·®è·ä¼šè¢«è¿›ä¸€æ­¥çš„æ‹‰å¤§\ncurp raft workload a 5.2s 6.7s workload b 1.2s 4.4s wrokload c 0.6s 4.1s\ngo-ycsbçš„è¯¦ç»†ç»“æœå¦‚ä¸‹ï¼š\nCURP\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 workloada READ - Takes(s): 5.2, Count: 488, OPS: 94.2, Avg(us): 600, Min(us): 433, Max(us): 25103, 50th(us): 534, 90th(us): 612, 95th(us): 652, 99th(us): 948, 99.9th(us): 25103, 99.99th(us): 25103 TOTAL - Takes(s): 5.2, Count: 1000, OPS: 192.8, Avg(us): 5185, Min(us): 433, Max(us): 52991, 50th(us): 6859, 90th(us): 11503, 95th(us): 12847, 99th(us): 16559, 99.9th(us): 27471, 99.99th(us): 52991 UPDATE - Takes(s): 5.2, Count: 512, OPS: 98.7, Avg(us): 9556, Min(us): 5396, Max(us): 52991, 50th(us): 8703, 90th(us): 12823, 95th(us): 14599, 99th(us): 18991, 99.9th(us): 27471, 99.99th(us): 52991 workloadb Run finished, takes 1.198906187s READ - Takes(s): 1.2, Count: 950, OPS: 793.1, Avg(us): 567, Min(us): 304, Max(us): 43807, 50th(us): 507, 90th(us): 582, 95th(us): 640, 99th(us): 1156, 99.9th(us): 1788, 99.99th(us): 43807 TOTAL - Takes(s): 1.2, Count: 1000, OPS: 834.4, Avg(us): 1192, Min(us): 304, Max(us): 43807, 50th(us): 511, 90th(us): 631, 95th(us): 6403, 99th(us): 15151, 99.9th(us): 20879, 99.99th(us): 43807 UPDATE - Takes(s): 1.1, Count: 50, OPS: 43.9, Avg(us): 13067, Min(us): 6400, Max(us): 20879, 50th(us): 13175, 90th(us): 15527, 95th(us): 16767, 99th(us): 20879, 99.9th(us): 20879, 99.99th(us): 20879 workloadc Run finished, takes 596.022766ms READ - Takes(s): 0.6, Count: 1000, OPS: 1680.6, Avg(us): 590, Min(us): 313, Max(us): 60863, 50th(us): 511, 90th(us): 614, 95th(us): 682, 99th(us): 1099, 99.9th(us): 1634, 99.99th(us): 60863 TOTAL - Takes(s): 0.6, Count: 1000, OPS: 1680.0, Avg(us): 590, Min(us): 313, Max(us): 60863, 50th(us): 511, 90th(us): 614, 95th(us): 682, 99th(us): 1099, 99.9th(us): 1634, 99.99th(us): 60863 Raft\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 workloada Run finished, takes 6.741194029s READ - Takes(s): 6.7, Count: 490, OPS: 72.8, Avg(us): 4182, Min(us): 3188, Max(us): 25279, 50th(us): 3571, 90th(us): 4787, 95th(us): 7699, 99th(us): 12015, 99.9th(us): 25279, 99.99th(us): 25279 TOTAL - Takes(s): 6.7, Count: 1000, OPS: 148.7, Avg(us): 6733, Min(us): 3188, Max(us): 42047, 50th(us): 7979, 90th(us): 9599, 95th(us): 12111, 99th(us): 17407, 99.9th(us): 25279, 99.99th(us): 42047 UPDATE - Takes(s): 6.7, Count: 510, OPS: 76.0, Avg(us): 9183, Min(us): 6908, Max(us): 42047, 50th(us): 8295, 90th(us): 11175, 95th(us): 15455, 99th(us): 18591, 99.9th(us): 20079, 99.99th(us): 42047 workloadb Run finished, takes 4.386455138s READ - Takes(s): 4.4, Count: 952, OPS: 217.6, Avg(us): 4152, Min(us): 3196, Max(us): 27407, 50th(us): 3553, 90th(us): 5947, 95th(us): 10591, 99th(us): 11487, 99.9th(us): 18127, 99.99th(us): 27407 TOTAL - Takes(s): 4.4, Count: 1000, OPS: 228.6, Avg(us): 4380, Min(us): 3196, Max(us): 27407, 50th(us): 3559, 90th(us): 7479, 95th(us): 10799, 99th(us): 11599, 99.9th(us): 18127, 99.99th(us): 27407 UPDATE - Takes(s): 4.3, Count: 48, OPS: 11.1, Avg(us): 8898, Min(us): 7096, Max(us): 15031, 50th(us): 8271, 90th(us): 10735, 95th(us): 14975, 99th(us): 15031, 99.9th(us): 15031, 99.99th(us): 15031 workloadc Run finished, takes 4.143589849s READ - Takes(s): 4.1, Count: 1000, OPS: 242.1, Avg(us): 4138, Min(us): 3272, Max(us): 44351, 50th(us): 3575, 90th(us): 5939, 95th(us): 7511, 99th(us): 11207, 99.9th(us): 13191, 99.99th(us): 44351 TOTAL - Takes(s): 4.1, Count: 1000, OPS: 242.1, Avg(us): 4138, Min(us): 3272, Max(us): 44351, 50th(us): 3575, 90th(us): 5939, 95th(us): 7511, 99th(us): 11207, 99.9th(us): 13191, 99.99th(us): 44351 TODO ç›®å‰çš„CURPåªå®ç°äº†åŸºç¡€çš„è¿è¡Œï¼Œå¹¶æ²¡æœ‰è€ƒè™‘crash-recoveryï¼Œè¿™å¯¹äºä¸€ä¸ªå…±è¯†æ¥è¯´æ˜¾ç„¶æ˜¯ä¸è¶³çš„ï¼Œä¸è¿‡ç¢äºæ—¶é—´å’Œç²¾åŠ›ï¼ŒçŸ­æ—¶é—´ç¬”è€…æ˜¯æ— æ³•è¡¥å…¨è¿™ä¸€éƒ¨åˆ†äº†ï¼Œåœ¨è¿™é‡Œç®€å•è¯´ä¸€ä¸‹æ€è·¯ã€‚\nVersion é¦–å…ˆï¼Œå¯¹äºæŒ‚æ‰å’Œå›å¤çš„èŠ‚ç‚¹ï¼Œæ•´ä¸ªé›†ç¾¤åº”å½“èƒ½å¤Ÿæ„ŸçŸ¥ï¼Œè®ºæ–‡ä¸­ä¸­ç»™å‡ºçš„æ–¹æ¡ˆæ˜¯ç»´æŠ¤ä¸€ä¸ªé›†ç¾¤åˆ—è¡¨+versionï¼Œclienté¦–æ¬¡ä»é…ç½®ä¸­å¿ƒå¤„æŒæœ‰è¯¥åˆ—è¡¨å’Œversionï¼Œä¹‹åæ¯æ¬¡è¯·æ±‚æ˜¯æºå¸¦ä¸Šversionï¼Œéšåé…ç½®ä¸­å¿ƒæ¥æ”¶åˆ°è¯·æ±‚åä¼šæ ¡éªŒversionï¼Œæ¥åˆ¤æ–­clientæŒæœ‰çš„é…ç½®æ˜¯å¦è¿‡æœŸ, å¦‚æœè¿‡æœŸå°±æ‹’ç»æ‰æ­¤æ¬¡è¯·æ±‚ï¼Œå¹¶å‘ŠçŸ¥Client\nåœ¨å®ç°ä¸Šï¼Œé…ç½®ä¸­å¿ƒå¯ä»¥å®ç°åœ¨Leaderä¸Šï¼ŒClientåœ¨è°ƒç”¨ isLeader () ç¡®å®šé›†ç¾¤Leaderæ—¶é¡ºä¾¿è·å–åˆ°versionå’Œé…ç½®ï¼Œå¹¶åœ¨clientç«¯ç»´æŠ¤ï¼Œéšåæ‰©å±•ä¸€ä¸‹protobufçš„ç»“æ„ä½“ï¼Œæ¯æ¬¡è¯·æ±‚æºå¸¦ä¸Šversionã€‚serverç«¯ï¼Œserverç«¯åœ¨ä»raftå¤„æ£€æµ‹åˆ°èº«ä»½å˜æ›´æ—¶ï¼Œå°±åº”å½“ç”±æ–°çš„leaderå»ç”Ÿæˆä¸€ä»½æ–°çš„é…ç½®+versionã€‚å°†å…¶è¿”å›ç»™client\n1 2 3 4 5 6 7 8 9 10 func (s *StateMachine) listenRaftState() { for state := range s.stateChangeC { s.mu.Lock() trace.Trace(trace.Vote, s.NodeId, \"raft state update: before: %s,current: %s\", stmap[s.raftState], stmap[state]) // å¦‚æœæ˜¯Leaderï¼Œé‚£ä¹ˆå°±ç”Ÿæˆæ–°é…ç½® s.raftState = state s.mu.Unlock() } } Witness ç”±äºLeaderè¿›è¡Œäº†æŠ¢è·‘ï¼Œå› æ­¤ä¼šæœ‰ä¸€äº›è¯·æ±‚è¿˜æœªcommitï¼Œä½†ä¹Ÿå·²ç»è¿”å›ç»™clientäº†ï¼Œè¿™äº›è¯·æ±‚çš„ç»“æœï¼Œæˆ–è€…è¯´è¿™äº›è¯·æ±‚å¯¹çŠ¶æ€æœºçš„å½±å“æš‚æ—¶ä¸ä¼šæš´éœ²å‡ºæ¥ï¼ˆåç»­å¦‚æœæƒ³è¦è·å–ç»“æœï¼Œæˆ–è€…è¯´å¯¹å…¶ä¿®æ”¹ï¼Œéƒ½ä¼šå› å†²çªè€Œè¢«æ‹’ç»ï¼‰ä½†æ˜¯è¯·æ±‚æˆåŠŸä¹Ÿç¡®å®æ˜¯å®æ‰“å®çš„å“åº”ç»™clientäº†ã€‚å› æ­¤è¿™ä¸€éƒ¨åˆ†çš„è¯·æ±‚ç»“æœä¸èƒ½ä¸¢å¤±ï¼Œä½†æ˜¯åˆæ²¡æœ‰é€šè¿‡logå‘é€ç»™followerï¼Œå› æ­¤å°±éœ€è¦é€šè¿‡Witnessä¸­çš„å­˜å‚¨æ¥å®Œæˆæ¢å¤ã€‚\nå…·ä½“æ¥è¯´ï¼Œéœ€è¦æ·»åŠ ä¸€æ¡rpcï¼Œä½¿å¾—æ–°çš„Leaderèƒ½å¤Ÿè·å–åˆ°followerçš„witnessä¸­çš„æ•°æ®ï¼Œç„¶åå†leaderå¤„æŒ‰ç…§é¡ºåºæ‰§è¡Œå¹¶å†™å…¥logã€‚ä»è€Œè§£å†³å†²çªå¹¶ç¡®å®šé¡ºåºã€‚å½“log commitæ—¶ï¼Œå³å¯è‡ªåŠ¨åˆ é™¤æ‰witnessä¸­çš„å†…å®¹ã€‚\nSummary æœ¬æ–‡åŸºäºetcd/raftï¼Œå®ç°äº†ä¸€ä¸ªç®€æ˜“çš„CURPï¼Œæä¾›äº†fast path + slow pathçš„é€»è¾‘ï¼Œä½¿å¾—ä¸å†²çªçš„è¯·æ±‚å¯ä»¥åœ¨ä¸€ä¸ªRTTå®Œæˆã€‚ç›®å‰è¿˜æ¬ ç¼ºrecoveryçš„é€»è¾‘ï¼Œä½†ä¸´è¿‘æ¯•ä¸šï¼Œç¬”è€…ç²¾åŠ›å®åœ¨æœ‰é™ï¼ŒçŸ­æ—¶é—´å†…åº”è¯¥æ˜¯æ²¡æœ‰ç²¾åŠ›å»è¡¥å®Œäº†ã€‚å¦‚æœæƒ³å­¦ä¹ å·¥ä¸šçº§CURPçš„å®ç°ï¼Œå¯ä»¥å»çœ‹Xlineï¼šGitHub - xline-kv/Xline: A geo-distributed KV store for metadata management\nç›®å‰çš„curpå’Œç»„é‡Œçš„ä¸€ä¸ªé¡¹ç›®ä»£ç æ··åœ¨ä¸€èµ·ï¼Œä¸å¤ªæ–¹ä¾¿å…¨éƒ¨å¼€æºï¼Œç­‰åç»­æœ‰ç©ºäº†ç»™åˆ†ç¦»å‡ºæ¥æ‰”åˆ°githubä¸Šã€‚\nå¯¹äºCURPè€Œè¨€ï¼Œè™½ç„¶å…¶åœ¨æ€§èƒ½ä¸Šé¢†å…ˆRaftä¸å°‘ï¼Œä½†æ˜¯åœ¨ç¬”è€…æµ‹è¯•çš„è¿‡ç¨‹ä¸­ï¼Œå‘ç°slow pathå¯¹äºç³»ç»Ÿæ€§èƒ½å½±å“è¾ƒå¤§ï¼Œectd/raftä¸­ï¼Œlogæ˜¯ç”±wal + å†…å­˜å®ç°å­˜å‚¨çš„ï¼Œå…³é—­walä¹‹åï¼Œworkloadaå¯ä»¥ä» 5sç¼©çŸ­è‡³ 3så·¦å³ï¼Œé‚£ä¹ˆæ˜¯å¦æœ‰ä¸€ç§åŠæ³•åœ¨ä¸å­˜åœ¨å†²çªæ—¶å½»åº•ç»•è¿‡slow pathå‘¢ï¼Ÿ\n",
  "wordCount" : "8743",
  "inLanguage": "en",
  "datePublished": "2024-06-03T09:31:59Z",
  "dateModified": "2024-06-03T09:31:59Z",
  "author":{
    "@type": "Person",
    "name": "Fischer"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://fischer0522.github.io/en/posts/tech/curp/%E4%BB%8E0.5%E5%88%B01%E5%AE%9E%E7%8E%B0curp/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Fischer's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://fischer0522.github.io/img/Navigation.svg"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://fischer0522.github.io/en/" accesskey="h" title="Fischer&#39;s Blog (Alt + H)">
                <img src="https://fischer0522.github.io/img/Navigation.svg" alt="" aria-label="logo"
                    height="35">Fischer&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://fischer0522.github.io/en/search" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://fischer0522.github.io/en/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://fischer0522.github.io/en/posts" title="Posts">
                    <span>Posts</span>
                </a>
            </li>
            <li>
                <a href="https://fischer0522.github.io/en/archives/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="https://fischer0522.github.io/en/tags" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://fischer0522.github.io/en/about" title="About">
                    <span>About</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://fischer0522.github.io/en/">Home</a>&nbsp;Â»&nbsp;<a href="https://fischer0522.github.io/en/posts/">Blog</a>&nbsp;Â»&nbsp;<a href="https://fischer0522.github.io/en/posts/tech/">Tech</a>&nbsp;Â»&nbsp;<a href="https://fischer0522.github.io/en/posts/tech/curp/">CURP</a></div>
    <h1 class="post-title entry-hint-parent">
      02-ä»0.5å®ç°CURP
    </h1>
    <div class="post-meta"><span title='2024-06-03 09:31:59 +0000 UTC'>2024-06-03</span>&nbsp;Â·&nbsp;18 min&nbsp;Â·&nbsp;Fischer

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#intro" aria-label="Intro">Intro</a><ul>
                        
                <li>
                    <a href="#%e4%bb%80%e4%b9%88%e6%98%afcurp" aria-label="ä»€ä¹ˆæ˜¯CURP">ä»€ä¹ˆæ˜¯CURP</a></li>
                <li>
                    <a href="#%e4%b8%ba%e4%bb%80%e4%b9%88%e6%98%af%e4%bb%8e-05-%e5%88%b0-1" aria-label="ä¸ºä»€ä¹ˆæ˜¯ä» 0.5 åˆ° 1">ä¸ºä»€ä¹ˆæ˜¯ä» 0.5 åˆ° 1</a></li></ul>
                </li>
                <li>
                    <a href="#curp-server" aria-label="CURP Server">CURP Server</a><ul>
                        
                <li>
                    <a href="#witness" aria-label="Witness">Witness</a></li>
                <li>
                    <a href="#commandboard" aria-label="CommandBoard">CommandBoard</a><ul>
                        
                <li>
                    <a href="#why-buffer" aria-label="Why Buffer">Why Buffer</a></li></ul>
                </li>
                <li>
                    <a href="#command-worker" aria-label="Command Worker">Command Worker</a></li>
                <li>
                    <a href="#fast-path" aria-label="Fast Path">Fast Path</a></li>
                <li>
                    <a href="#slow-path" aria-label="Slow Path">Slow Path</a></li></ul>
                </li>
                <li>
                    <a href="#curp-client" aria-label="CURP Client">CURP Client</a><ul>
                        
                <li>
                    <a href="#fast-path-1" aria-label="Fast path">Fast path</a></li>
                <li>
                    <a href="#slow-path-1" aria-label="slow path">slow path</a></li></ul>
                </li>
                <li>
                    <a href="#benchmark" aria-label="benchmark">benchmark</a></li>
                <li>
                    <a href="#todo" aria-label="TODO">TODO</a><ul>
                        
                <li>
                    <a href="#version" aria-label="Version">Version</a></li>
                <li>
                    <a href="#witness-1" aria-label="Witness">Witness</a></li></ul>
                </li>
                <li>
                    <a href="#summary" aria-label="Summary">Summary</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="intro">Intro<a hidden class="anchor" aria-hidden="true" href="#intro">#</a></h2>
<h3 id="ä»€ä¹ˆæ˜¯curp">ä»€ä¹ˆæ˜¯CURP<a hidden class="anchor" aria-hidden="true" href="#ä»€ä¹ˆæ˜¯curp">#</a></h3>
<p>Curpæ˜¯ä¸€ç§æ–°çš„åˆ†å¸ƒå¼å…±è¯†ç®—æ³•ï¼Œcurpçš„æå‡ºæ˜¯é’ˆå¯¹äºè·¨åŸŸç­‰é«˜ç½‘ç»œå»¶è¿Ÿåœºæ™¯ï¼Œä¼ ç»Ÿçš„raftå’Œpaxosç­‰å…±è¯†ç®—æ³•éœ€è¦ä¸¤ä¸ªRTTï¼Œåœ¨é«˜ç½‘ç»œå»¶è¿Ÿçš„åœºæ™¯ä¸‹ï¼Œä¸¤ä¸ªRTTå¯¹ç³»ç»Ÿæ¥è¯´æ˜¯éš¾ä»¥å¿å—çš„ï¼Œç½‘ç»œé€šä¿¡ä¼šæˆä¸ºç³»ç»Ÿçš„ç“¶é¢ˆã€‚</p>
<p>ä¸ºäº†è§£å†³è¯¥é—®é¢˜ï¼ŒCURPæœŸæœ›åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œé€šè¿‡ä¸€ä¸ªRTTæ¥å®Œæˆï¼Œè¿™ä¸»è¦åŸºäºä¸¤ç‚¹èƒŒæ™¯ï¼š</p>
<ul>
<li>åœ¨è¯·æ±‚ä¸­ï¼Œå„ä¸ªè¯·æ±‚ä¹‹é—´é€šå¸¸æ˜¯äº’ä¸å†²çªçš„ï¼Œä¾‹å¦‚ set a =1 å’Œ set b = 2, å¯¹äºåŒä¸€ä¸ªkeyçš„é‡å¤æ€§è¯»å†™æ˜¯æ¯”è¾ƒå°‘è§çš„</li>
<li>ç³»ç»Ÿå¹¶ä¸éœ€è¦å¯¹æ‰€æœ‰è¯·æ±‚å»ºç«‹ä¸€ä¸ªå…¨å±€çš„é¡ºåºï¼Œç›¸å¯¹çš„ï¼Œåªéœ€è¦å¯¹äºäº’ç›¸å†²çªçš„keyå»ºç«‹èµ·ä¸€ä¸ªå±€éƒ¨é¡ºåºå³å¯
å¦‚æœæƒ³è¿›ä¸€æ­¥äº†è§£CURPï¼Œæ¬¢è¿é˜…è¯»ç¬”è€…çš„å¦ä¸€ç¯‡æ–‡ç« ï¼š
<a href="https://zhuanlan.zhihu.com/p/692464275">zhuanlan.zhihu.com/p/692464275</a></li>
</ul>
<h3 id="ä¸ºä»€ä¹ˆæ˜¯ä»-05-åˆ°-1">ä¸ºä»€ä¹ˆæ˜¯ä» 0.5 åˆ° 1<a hidden class="anchor" aria-hidden="true" href="#ä¸ºä»€ä¹ˆæ˜¯ä»-05-åˆ°-1">#</a></h3>
<p>CURPæ˜¯éä¾µå…¥æ€§çš„ï¼Œå³curpåªæ˜¯åœ¨åŸæœ¬çš„å…±è¯†ç³»ç»Ÿçš„åŸºç¡€ä¸Šï¼Œæä¾›ä¸€å¥—é¢å¤–çš„é€»è¾‘ï¼Œæ¥åŠ é€ŸåŸæœ¬çš„å…±è¯†ç®—æ³•ï¼Œåœ¨curpåŸæ–‡ä¸­ï¼Œé€‰æ‹©çš„æ˜¯ä½¿ç”¨primary-backupæ¶æ„æ¥ä½œä¸ºåŸºç¡€ï¼Œè€Œåœ¨CURPä½œè€…åœ¨phDè®ºæ–‡ä¸­ï¼Œæ‰©å±•äº†CURPï¼Œæå‡ºäº†CURP-Qï¼Œå…¶æ„å»ºäºå¦‚Raftï¼ŒPaxosç­‰Leader-Followerå…±è¯†ç®—æ³•ä¸Šã€‚</p>
<p>è€Œetcd/raftæ˜¯ç›®å‰å·¥ä¸šç•Œæ¯”è¾ƒæˆç†Ÿçš„raftå®ç°ï¼Œå…¶å°†raftæŠ½è±¡æˆçŠ¶æ€æœºï¼Œéå¸¸åœ°ç®€å•æ˜“ç”¨ã€‚åŒæ—¶ï¼Œå…¶å®ç°äº†å¦‚check quorum, leader lease prevote æ‰¹å¤„ç†ï¼Œæµæ°´çº¿å‘é€äº†ç­‰ä¼˜åŒ–ï¼Œæ€§èƒ½æœ‰åŸºç¡€ä¿è¯ã€‚å› æ­¤ï¼Œåœ¨æœ¬æ–‡ä¸­ï¼Œç¬”è€…é€‰æ‹©äº†etcd/raftï¼Œå……å½“CURPçš„slow pathï¼Œå†æ¬¡åŸºç¡€ä¸Šï¼Œæ„å»ºäº†CURPã€‚</p>
<h2 id="curp-server">CURP Server<a hidden class="anchor" aria-hidden="true" href="#curp-server">#</a></h2>
<p>ectd/raftä»¥åŠå¦‚ä½•ä¸raftäº¤äº’å·²ç»åœ¨ä¸Šä¸€ç« é˜è¿°ï¼Œå› æ­¤åœ¨è¿™é‡Œå°†é‡ç‚¹æ”¾åœ¨CURP Serverçš„çŠ¶æ€æœºä¸Šã€‚CURPçŠ¶æ€æœºçš„è®¾è®¡å‚è€ƒäº† 6.824 å’Œ Xlineã€‚çŠ¶æ€æœºè´Ÿè´£æ¥æ”¶ç½‘ç»œè¯·æ±‚ï¼Œä¸clientå®Œæˆäº¤äº’ã€‚éšåå°†å…¶å‘é€ç»™raftå®Œæˆproposeï¼ŒåŒæ—¶CURPçŠ¶æ€æœºè¿˜è¦ç»´æŠ¤ä¸€ä¸ªkv storeï¼Œå­˜å‚¨å·²ç»commitçš„å†…å®¹ã€‚</p>
<p>çŠ¶æ€æœºå®šä¹‰å¦‚ä¸‹ï¼Œä¸»è¦åŒ…æ‹¬ï¼š</p>
<ul>
<li>KVStoreï¼šå­˜å‚¨å·²ç»commitçš„å†…å®¹ï¼Œè¿™é‡Œé€‰æ‹©äº†boltdbä½œä¸ºæŒä¹…åŒ–å®ç°</li>
<li>Witnessï¼šCURPçš„é‡è¦æœºåˆ¶ï¼Œåœ¨followerä¸Šè¿ä½œï¼Œç”¨äºæš‚å­˜æœªæäº¤çš„è¯·æ±‚ä»¥è¿›è¡Œå†²çªæ£€æµ‹ï¼Œç”±äºæ²¡æœ‰å®ç°recoveryï¼Œå› æ­¤è¿™é‡Œç›´æ¥ä½¿ç”¨mapå­˜å‚¨</li>
<li>CommandBoardï¼šè®°å½•ç›®å‰æ¥æ”¶åˆ°çš„è¯·æ±‚ï¼Œå¹¶åœ¨é€‚å½“çš„æ—¶æœºå“åº”Clientç»“æœ</li>
</ul>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">StateMachine</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">NodeId</span>   <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">proposeC</span> <span style="color:#66d9ef">chan</span><span style="color:#f92672">&lt;-</span> <span style="color:#66d9ef">string</span> <span style="color:#75715e">// channel for proposing updates
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">mu</span>       <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">RWMutex</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// kvStore      map[string]string // current committed key-value pairs
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">KVStore</span>      <span style="color:#f92672">*</span><span style="color:#a6e22e">xkv</span>.<span style="color:#a6e22e">KVStore</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">commandBoard</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">command</span>.<span style="color:#a6e22e">CommandBoard</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">snapshotter</span>  <span style="color:#f92672">*</span><span style="color:#a6e22e">snap</span>.<span style="color:#a6e22e">Snapshotter</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">raftState</span>    <span style="color:#a6e22e">raft</span>.<span style="color:#a6e22e">StateType</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fastPath</span>     <span style="color:#66d9ef">chan</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">curp_proto</span>.<span style="color:#a6e22e">CurpClientCommand</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">slowPath</span>     <span style="color:#66d9ef">chan</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">curp_proto</span>.<span style="color:#a6e22e">CurpClientCommand</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// both fast and slow path will execute commands,this set is used to avoid executing the same command twice
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">commandSet</span>   <span style="color:#66d9ef">map</span>[<span style="color:#a6e22e">command</span>.<span style="color:#a6e22e">ProposeId</span>]<span style="color:#66d9ef">struct</span>{}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">witness</span>      <span style="color:#a6e22e">witness</span>.<span style="color:#a6e22e">Witness</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">stateChangeC</span> <span style="color:#66d9ef">chan</span> <span style="color:#a6e22e">raft</span>.<span style="color:#a6e22e">StateType</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="witness">Witness<a hidden class="anchor" aria-hidden="true" href="#witness">#</a></h3>
<p>Witnessæœºåˆ¶æ˜¯CURPçš„æ ¸å¿ƒï¼Œç”¨äºæä¾›å†²çªæ£€æµ‹åŠŸèƒ½ï¼Œè¿™é‡Œçš„å®ç°éå¸¸ç®€å•ï¼Œä»…ä»…åªä½¿ç”¨mapå­˜å‚¨+Mutexå¹¶å‘æ§åˆ¶ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Witness</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">mu</span>         <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Mutex</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">commandMap</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">map</span>[<span style="color:#a6e22e">command</span>.<span style="color:#a6e22e">ProposeId</span>]<span style="color:#f92672">*</span><span style="color:#a6e22e">curp_proto</span>.<span style="color:#a6e22e">CurpClientCommand</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç›®å‰å®ç°çš„å†²çªæ£€æµ‹çš„ç­–ç•¥éå¸¸ç®€å•ï¼Œä»…æ”¯æŒkvå±‚é¢ï¼Œå³å¯¹äºåŒä¸€æ¡keyï¼Œå†™-å†™å’Œè¯»-å†™è¿™ä¸¤ç§æƒ…å†µæ˜¯å†²çªçš„ï¼Œåœ¨æ’å…¥ä¸€æ¡è®°å½•æ—¶ï¼Œå¦‚æœæ£€æµ‹åˆ°å†²çªï¼Œé‚£ä¹ˆå°±ç›´æ¥è¿”å›falseï¼Œå¦åˆ™å°†å…¶ä¿å­˜åˆ°mapå½“ä¸­ã€‚</p>
<p>Witnessä¸­çš„æ•°æ®åº”å½“è¿›è¡ŒæŒä¹…åŒ–ä¿å­˜ï¼Œä»¥ç”¨äºåœ¨å®•æœºåæ¢å¤æ•°æ®ï¼Œç”±äºWitnessä¸­æ•°æ®æ˜¯æš‚å­˜çš„ï¼Œåœ¨commitä¹‹åå°±ä¼šåˆ é™¤ï¼Œå› æ­¤curpåŸæ–‡ä¸­æå‡ºäº†å­˜å‚¨åœ¨NVMç­‰ç¡¬ä»¶ä¸Šä¼šæ›´åˆé€‚ã€‚è¿™é‡Œç”±äºæš‚æ—¶æ²¡æœ‰å®ç°recoveryæœºåˆ¶ï¼Œæ‰€ä»¥ç›®å‰æ˜¯ç›´æ¥ä½¿ç”¨mapå­˜å‚¨ã€‚</p>
<h3 id="commandboard">CommandBoard<a hidden class="anchor" aria-hidden="true" href="#commandboard">#</a></h3>
<p>CmdBoardçš„ä½œç”¨ä¸ºè®°å½•æ¥æ”¶åˆ°çš„è¯·æ±‚ï¼Œç­‰å¾…è¯·æ±‚æ‰§è¡Œå®Œæˆï¼Œè€Œå…·ä½“çš„æ‰§è¡Œåˆ™äº¤ç»™ <code>CommandWorker</code> æ¥å®Œæˆï¼Œå‰å°æ¥æ”¶è¯·æ±‚çš„çº¿ç¨‹åªéœ€è¦é€šè¿‡CommandBoardæ¥è·å–ç»“æœï¼Œå¹¶ç»“æœå“åº”ç»™å®¢æˆ·ç«¯ã€‚ä¸è¿‡ç”±äºCURPå­˜åœ¨fast pathå’Œslow pathçš„æ¦‚å¿µï¼Œå› æ­¤ä¼šç¨å¾®å¤æ‚ä¸€äº›ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">CommandBoard</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">mu</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Mutex</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// store all notifiers for execution results
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">erNotifiers</span> <span style="color:#66d9ef">map</span>[<span style="color:#a6e22e">ProposeId</span>]<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// store all notifiers for after sync results
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">asrNotifiers</span> <span style="color:#66d9ef">map</span>[<span style="color:#a6e22e">ProposeId</span>]<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">struct</span>{}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">erBuffer</span> <span style="color:#66d9ef">map</span>[<span style="color:#a6e22e">ProposeId</span>]<span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">asrBuffer</span> <span style="color:#66d9ef">map</span>[<span style="color:#a6e22e">ProposeId</span>]<span style="color:#66d9ef">struct</span>{}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>er</code> ä¸º <code>execution result</code>ï¼Œ<code>asr</code> å³ä¸º <code>async execution result</code>ï¼Œåˆ†åˆ«ä»£è¡¨fast pathå’Œslow pathçš„æ‰§è¡Œç»“æœã€‚
è¯·æ±‚é€šè¿‡ <code>ProposeId</code> æ¥æ ‡è¯†ï¼Œ<code>ProposeId</code> ä¸º <code>ClientId</code> å’Œ <code>SeqId</code> çš„ç»„åˆï¼Œä»¥åŒºåˆ†ä¸åŒClientçš„ä¸åŒè¯·æ±‚ï¼š</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ProposeId</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">ClientId</span> <span style="color:#66d9ef">uint64</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">SeqId</span>    <span style="color:#66d9ef">uint64</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>leaderåœ¨é€šè¿‡fast pathæ‰§è¡Œè¯·æ±‚ï¼Œåœ¨æ¥æ”¶åˆ°è¯·æ±‚åï¼Œä¼šé€šè¿‡ <code>WaitForEr()</code> æ¥ç­‰å¾…fast pathçš„æ‰§è¡Œç»“æœï¼Œåœ¨ <code>WaitForEr()</code> ä¸­ï¼Œæ¶‰åŠåˆ°erBufferå’ŒerNotifiersã€‚erBufferç”¨äºç¼“å­˜å‘½ä»¤çš„æ‰§è¡Œç»“æœï¼Œç»fast pathå®Œæˆæ‰§è¡Œçš„å†…å®¹éƒ½ä¼šå­˜å‚¨åˆ°å…¶ä¸­ï¼Œè€ŒerNotifiersåˆ™å­˜å‚¨ä¸€ä¸ªchannelï¼Œå‰å°ç›‘å¬è¯¥channelï¼Œç­‰å¾…æ‰§è¡Œç»“æœã€‚</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">CommandBoard</span>) <span style="color:#a6e22e">WaitForEr</span>(<span style="color:#a6e22e">id</span> <span style="color:#a6e22e">ProposeId</span>) <span style="color:#66d9ef">string</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Lock</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">result</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">erBuffer</span>[<span style="color:#a6e22e">id</span>]; <span style="color:#a6e22e">ok</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">result</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">erNotifiers</span>[<span style="color:#a6e22e">id</span>]; !<span style="color:#a6e22e">ok</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">erNotifiers</span>[<span style="color:#a6e22e">id</span>] = make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">string</span>, <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">notifyChan</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">erNotifiers</span>[<span style="color:#a6e22e">id</span>]
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">result</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">notifyChan</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">erBuffer</span>[<span style="color:#a6e22e">id</span>] = <span style="color:#a6e22e">result</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">result</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>WaitForAsr</code> ç”¨äºç­‰å¾…commandåœ¨slow pathä¸­å®Œæˆå…±è¯†ï¼Œè¿”å›æ‰§è¡Œçš„ç»“æœã€‚</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">CommandBoard</span>) <span style="color:#a6e22e">WaitForAsr</span>(<span style="color:#a6e22e">id</span> <span style="color:#a6e22e">ProposeId</span>) <span style="color:#66d9ef">string</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Lock</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//trace.Trace(trace.Client, &#34;Wait Synced [clientId: %d,seqId: %d]&#34;, id.ClientId, id.SeqId)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">asrOk</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">asrBuffer</span>[<span style="color:#a6e22e">id</span>]
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">result</span>, <span style="color:#a6e22e">erOk</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">erBuffer</span>[<span style="color:#a6e22e">id</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> delete(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">asrBuffer</span>, <span style="color:#a6e22e">id</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> delete(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">erBuffer</span>, <span style="color:#a6e22e">id</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// command has already been executed in both fast path and slow path
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">asrOk</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">erOk</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">result</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">asrNotifiers</span>[<span style="color:#a6e22e">id</span>]; !<span style="color:#a6e22e">ok</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">asrNotifiers</span>[<span style="color:#a6e22e">id</span>] = make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">struct</span>{}, <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">notifyChan</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">asrNotifiers</span>[<span style="color:#a6e22e">id</span>]
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// release lock and wait
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">notifyChan</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Lock</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">result</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">erBuffer</span>[<span style="color:#a6e22e">id</span>]; <span style="color:#a6e22e">ok</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">result</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// UNREACHABLE
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;NOT FOUND IN BUFFER&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="why-buffer">Why Buffer<a hidden class="anchor" aria-hidden="true" href="#why-buffer">#</a></h4>
<p>åœ¨ 6.824 ä¸­ï¼Œæ‰§è¡Œç»“æœé€šè¿‡ä¸€ä¸ªchannelå³å¯ä¼ é€’ï¼Œä½†æ˜¯è¿™é‡Œé¢å¤–ä½¿ç”¨ä¸€ä¸ªBufferä¸»è¦æ˜¯ç”¨äºå…¼å®¹slow pathï¼Œæ¥ä¿è¯çº¿æ€§ä¸€è‡´æ€§ã€‚erå’Œasréƒ½å¼•å…¥äº†bufferï¼ŒäºŒè€…éœ€è¦åˆ†å¼€è®¨è®º</p>
<p>é¦–å…ˆè¯´æ˜ä¸€ä¸‹ä¸ºä»€ä¹ˆéœ€è¦ <code>erBuffer</code> ã€‚è®¾æƒ³è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼šclient1 å…ˆ cmd1 <code>set a = 1</code>ï¼Œéšåclient 1 å‘é€ cmd 2 <code>get a</code>ï¼Œæ­¤æ—¶è¢«witnessæ£€æµ‹åˆ°å†²çªï¼Œéœ€ç­‰å¾…slow pathæ‰§è¡Œå®Œæ¯•ï¼Œæ­¤æ—¶ï¼Œclient 1 åˆå‘é€äº† cmd 3 <code>set a = 3</code>ï¼Œç”±äºleaderä¸ŠWitnessæ˜¯å…³é—­çš„ï¼Œset a = 3 å¯ä»¥ç›´æ¥æ‰§è¡Œï¼Œè¿™ä¼šå¯¼è‡´cmd3 åœ¨cmd2 ä¹‹å‰è¢«æ‰§è¡Œï¼Œå¯¹äºclientè€Œè¨€ï¼Œè§‚æµ‹åˆ°çš„ç»“æœä¸å‘é€é¡ºåºä¸ä¸€è‡´ã€‚</p>
<p><img loading="lazy" src="https://pic-bed-1309931445.cos.ap-nanjing.myqcloud.com/blog/20240607003628.png" alt="image.png"  />
</p>
<p>å› æ­¤ï¼Œcmd2 ä¸èƒ½ç­‰å¾…ä»slow pathä¸­commitæ‰æ‰§è¡Œï¼Œè€Œæ˜¯åº”å½“åœ¨fast pathä¸­æ‰§è¡Œå®Œæˆï¼Œä¿å­˜ç»“æœï¼Œç­‰åˆ°å¯¹åº”çš„æ—¥å¿—commitä¹‹åï¼Œå†å°†è¯¥ç»“æœè¿”å›ç»™clientã€‚</p>
<p>å¯¹äºä¸åŒçš„clientæ¥è¯´ï¼Œå³cmd1 cmd3 ç”±client 1 å‘é€ï¼Œcmd2 ç”±client 2 å‘é€ï¼Œæ­¤æ—¶cmd2 å’Œcmd3 å¤„äºä¸€ç§å¹¶å‘çš„çŠ¶æ€ï¼Œæ˜¯å…è®¸ä»¥ä»»æ„çš„ç»“æœå®Œæˆæ‰§è¡Œçš„ï¼Œä½†æ˜¯å¦‚æœåªæœ‰ä¸€ä¸ªclientï¼Œåˆ™ä¼šè¿èƒŒçº¿æ€§ä¸€è‡´æ€§ã€‚</p>
<p>è€Œ <code>AsrBuffer</code> ä¸»è¦æ˜¯ç”¨äºè§£å†³slow pathçš„å¼‚æ­¥æ‰§è¡Œé—®é¢˜ï¼Œå¦‚æœåå°raft commitçš„æ•ˆç‡æ¯”è¾ƒé«˜ï¼Œé‚£ä¹ˆä¼šå¯¼è‡´åœ¨clientè°ƒç”¨WaitSyncedä¹‹å‰å°±å·²ç»commitå®Œæ¯•ï¼Œæ­¤æ—¶å¦‚æœåˆ›å»ºä¸€ä¸ªchannelå¹¶ç›‘å¬ï¼Œé‚£ä¹ˆåç»­å°±ä¼šæ°¸è¿œæ— æ³•æ¥æ”¶åˆ°ç»“æœã€‚</p>
<p>å¯¹äºè¿™ä¸ªé—®é¢˜ï¼Œæœ‰ä¸¤ä¸ªè§£å†³æ–¹æ¡ˆï¼Œä¸€æ˜¯éå†å½“å‰commit idå‰æ‰€æœ‰å¯¹åº”çš„channelï¼Œå…¨éƒ¨é€šçŸ¥ä¸€éï¼ŒäºŒå°±æ˜¯æ·»åŠ ä¸€ä¸ªç¼“å­˜ï¼Œå¯ä»¥é€šè¿‡å…ˆæŸ¥è¯¢bufferæ¥åˆ¤æ–­æ˜¯å¦æ‰§è¡Œå®Œæˆï¼Œå¦‚æœæ²¡æœ‰ï¼Œåç»­å†é€šè¿‡channelç›‘å¬ç»“æœã€‚bufferå½“ä¸­åªéœ€è¦å­˜å‚¨ä¸€ä¸ªç©ºstruct{}ï¼Œèµ·åˆ°é€šçŸ¥ä½œç”¨å³å¯ã€‚ä¸ªäººè®¤ä¸ºç¬¬ä¸€ç§å®ç°æ–¹å¼ä¼˜é›…ä¸€äº›ï¼Œå› æ­¤å°±å¼•å…¥äº†bufferã€‚</p>
<h3 id="command-worker">Command Worker<a hidden class="anchor" aria-hidden="true" href="#command-worker">#</a></h3>
<p>ä¸Command Boardç›¸å¯¹åº”çš„æ˜¯Command Workerï¼ŒCommand Boardè®°å½•è¯·æ±‚ï¼ŒWorkerè´Ÿè´£å…·ä½“çš„æ‰§è¡Œã€‚</p>
<p>Command Workerä¸­ä¼šåˆ†åˆ«ä»fast pathå’Œslow pathä¸­æ¥æ”¶è¯·æ±‚ï¼š</p>
<ul>
<li>
<p>leaderåœ¨æ¥æ”¶åˆ°è¯·æ±‚ä¹‹åï¼Œä¼šç›´æ¥å°†å…¶é€šè¿‡fast path channelå‘é€è‡³cmd workerå¤„ï¼Œfolloweråªè¿›è¡Œwitnessä¸æ‰§è¡Œï¼Œå› æ­¤ä¸ä¼šä»fast pathä¸­æ¥æ”¶ä»»ä½•å†…å®¹ã€‚leaderæ‰§è¡Œå®Œæˆä¹‹åå°±å¯ä»¥é€šè¿‡ <code>InsertEr</code> å°†ç»“æœæ·»åŠ åˆ°Command Boardå½“ä¸­ï¼Œé€šçŸ¥å‰å°è¿”å›ç»“æœç»™client</p>
</li>
<li>
<p>raftä¼šå°†å·²ç»commitäº†çš„è¯·æ±‚é€šè¿‡slow pathå‘é€è‡³cmd workerã€‚ç”±äºleaderå·²ç»é€šè¿‡fast pathæ‰§è¡Œè¿‡ä¸€æ¬¡äº†ï¼Œå› æ­¤leaderåœ¨è¿™é‡Œåº”å½“å¿½ç•¥æ‰è¯¥è¯·æ±‚ï¼Œè€Œfolloweråº”å½“æ‰§è¡Œæ¥è·Ÿéšleaderçš„çŠ¶æ€ã€‚
è¿™ä¸€éƒ¨åˆ†ä¸ä¼ ç»Ÿraftæœ€å¤§çš„ä¸åŒå°±æ˜¯ï¼šleaderä¼šé€šè¿‡fast pathè¿›è¡Œâ€œæŠ¢è·‘â€ï¼Œä»è€Œç»™ç³»ç»Ÿå¼•å…¥äº†é¢å¤–çš„å¤æ‚åº¦ï¼š</p>
</li>
<li>
<p>Leaderé€šè¿‡fast pathæå‰æ‰§è¡Œï¼Œä¿®æ”¹äº†çŠ¶æ€æœºï¼Œä½†æ˜¯ç”±äºwitnessæœºåˆ¶çš„å­˜åœ¨ï¼Œè¿™ä¸ªæ‰§è¡Œç»“æœåœ¨commitä¹‹å‰æ˜¯ä¸ä¼šæš´éœ²ç»™clientçš„ã€‚</p>
</li>
<li>
<p>Leaderæå‰ä¿®æ”¹äº†çŠ¶æ€æœºï¼Œé‚£ä¹ˆslow pathä¸­çš„å†…å®¹å°±æ— éœ€å†æ‰§è¡Œä¸€éï¼Œé¢å¤–å†™ä¸€ékv storeçš„å¼€é”€æ¯”è¾ƒé«˜ã€‚å¦‚æœslow pathä¼šå†æ‰§è¡Œä¸€éï¼Œè™½ç„¶å¯èƒ½ä¼šå¯¼è‡´fast pathå’Œslow pathçš„å†…å®¹ç›¸äº’è¦†ç›–ï¼Œä½†æ˜¯ç”±äºå†²çªæ£€æµ‹çš„æœºåˆ¶å­˜åœ¨ï¼Œç›¸äº’è¦†ç›–çš„ä¸­é—´æ€ä¸ä¼šå¯¹å¤–æš´éœ²ï¼Œå› æ­¤æ‰§è¡Œä¸€éslowä¹Ÿä¸ä¼šå½±å“æ­£ç¡®æ€§ï¼Œç­‰åˆ°commitåï¼ŒçŠ¶æ€æœºä¸åªæ‰§è¡Œfastæ— å¼‚ã€‚Leaderé€šè¿‡fast pathå·²ç»å®Œæˆäº†æŒä¹…åŒ–ï¼Œå› æ­¤Leaderä¹Ÿä¸ä¼šä¾èµ–raft logæ¥å®Œæˆrecoveryã€‚</p>
</li>
<li>
<p>Followeræ²¡æœ‰é¢å¤–çš„åŠ¨ä½œï¼Œåªéœ€è¦witnessåˆ¤æ–­å†²çªï¼Œå¹¶ä¸”é€šè¿‡slow pathæ¥è·Ÿéšleaderçš„çŠ¶æ€å³å¯ã€‚</p>
</li>
</ul>
<p>æ­¤å¤–è¿˜æœ‰ä¸€ä¸ªCommandSetï¼Œç”¨äºå¯¹å‘½ä»¤è¿›è¡Œå»é‡ï¼Œé˜²æ­¢å·²ç»æ‰§è¡Œè¿‡ä¸€éï¼Œä½†æ˜¯æ²¡æ¥åŠå“åº”clientï¼Œå®•æœºï¼Œéšåclientåˆé‡è¯•ï¼Œå¯¼è‡´å‘½ä»¤è¢«é‡å¤æ‰§è¡Œã€‚åœ¨ 6.824 çš„lab3 ä¸­ï¼Œéœ€è¦è¿™æ ·ä¸€ä¸ªè®¾è®¡æ˜¯å› ä¸ºå…¶ä¸­çš„appendå‘½ä»¤æ˜¯ä¸å¹‚ç­‰çš„ï¼Œå³ä¼šåœ¨åŸæœ‰valueçš„åŸºç¡€ä¸Šè¿½åŠ æ•°æ®ï¼Œè€Œå¦‚æœå°†å‘½ä»¤è®¾è®¡æˆå¹‚ç­‰çš„ï¼Œå°±ä¸éœ€è¦è¿™ä¸ªCommandSetäº†ï¼Œå‘½ä»¤é‡å¤æ‰§è¡Œä¹Ÿä¸ä¼šäº§ç”Ÿè´Ÿé¢å½±å“ã€‚</p>
<p>Command Workeræ˜¯å•çº¿ç¨‹æ‰§è¡Œçš„ï¼Œä»¥ç¡®ä¿çº¿æ€§ä¸€è‡´æ€§ã€‚ä½†å®é™…ä¸Šï¼Œæ­£å¦‚CURPæœ¬èº«çš„æ€æƒ³â€”â€”å…¨å±€é¡ºåºæ˜¯ä¸å¿…è¦çš„ï¼Œå¯ä»¥å°†å…¨å±€é¡ºåºç¼©å°èŒƒå›´åˆ°å­˜åœ¨å†²çªçš„keyä¹‹é—´ç»´æŠ¤ä¸€ä¸ªé¡ºåºã€‚åœ¨å®ç°ä¸Šå¯ä»¥ç»´æŠ¤å¤šä¸ªworkerï¼Œå°†å­˜åœ¨å†²çªçš„keyåˆ†é…è‡³åŒä¸€ä¸ªworkerå¤„ï¼Œç¡®ä¿èƒ½å¤ŸæŒ‰ç…§é¡ºåºæ¥æ‰§è¡Œã€‚ä¸åŒworkerä¹‹é—´ç”±äºä¸å­˜åœ¨å†²çªï¼Œå¯ä»¥å¹¶è¡Œæ‰§è¡Œã€‚</p>
<p>æ­¤å¤–ï¼Œç”±äºkvstoreå’ŒcommandSetåªä¼šåœ¨è¿™é‡Œä¿®æ”¹ï¼ŒåŠ ä¸Šå…¶ä¸ºå•çº¿ç¨‹ï¼Œå› æ­¤è¿™é‡Œå®Œå…¨å¯ä»¥ä¸åŠ é”æ‰§è¡Œï¼Œä¸´ç•ŒåŒºä»…ä»…åªæœ‰åˆ¤æ–­å½“å‰èŠ‚ç‚¹çŠ¶æ€</p>
<p>è¿™é‡Œçš„å®ç°å¯ä»¥å‚è€ƒXlineï¼Œå…¶ä¸­å®ç°äº†ä¸€ä¸ªéå¸¸å®Œå¤‡çš„å†²çªæ£€æµ‹é˜Ÿåˆ— + workerï¼š<a href="https://zhuanlan.zhihu.com/p/662504235">zhuanlan.zhihu.com/p/662504235</a></p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">StateMachine</span>) <span style="color:#a6e22e">cmdWorker</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">select</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">cmd</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">fastPath</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Trace</span>(<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Fast</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">NodeId</span>, <span style="color:#e6db74">&#34;got cmd from fast path %v&#34;</span>, <span style="color:#a6e22e">cmd</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">proposeId</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">command</span>.<span style="color:#a6e22e">ProposeId</span>{
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">ClientId</span>: <span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">ClientId</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">SeqId</span>:    <span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">SeqId</span>,
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">commandSet</span>[<span style="color:#a6e22e">proposeId</span>]; <span style="color:#a6e22e">ok</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// command executed before,nothing to do
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Trace</span>(<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Fast</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">NodeId</span>, <span style="color:#e6db74">&#34;cmd already executed %v&#34;</span>, <span style="color:#a6e22e">cmd</span>)
</span></span><span style="display:flex;"><span>			} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">commandSet</span>[<span style="color:#a6e22e">proposeId</span>] = <span style="color:#66d9ef">struct</span>{}{}
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">result</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">execute</span>(<span style="color:#a6e22e">cmd</span>)
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Trace</span>(<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Fast</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">NodeId</span>, <span style="color:#e6db74">&#34;cmd %v executed,result is %v&#34;</span>, <span style="color:#a6e22e">cmd</span>, <span style="color:#a6e22e">result</span>)
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">commandBoard</span>.<span style="color:#a6e22e">InsertEr</span>(<span style="color:#a6e22e">proposeId</span>, <span style="color:#a6e22e">result</span>)
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">cmd</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">slowPath</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Lock</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">isLeader</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">raftState</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">raft</span>.<span style="color:#a6e22e">StateLeader</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Trace</span>(<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Slow</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">NodeId</span>, <span style="color:#e6db74">&#34;got cmd from slow path %v&#34;</span>, <span style="color:#a6e22e">cmd</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">commandSet</span>[<span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">ProposeId</span>()]; <span style="color:#a6e22e">ok</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">isLeader</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// command executed before,nothing to do
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Trace</span>(<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Slow</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">NodeId</span>, <span style="color:#e6db74">&#34;cmd already executed %v&#34;</span>, <span style="color:#a6e22e">cmd</span>)
</span></span><span style="display:flex;"><span>			} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">commandSet</span>[<span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">ProposeId</span>()] = <span style="color:#66d9ef">struct</span>{}{}
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">execute</span>(<span style="color:#a6e22e">cmd</span>)
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Trace</span>(<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Slow</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">NodeId</span>, <span style="color:#e6db74">&#34;WAIT Notify result in slow path,proposeId:[clientId: %d,seqId: %d]&#34;</span>, <span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">ClientId</span>, <span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">SeqId</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">commandBoard</span>.<span style="color:#a6e22e">NotifyAsr</span>(<span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">ProposeId</span>())
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Trace</span>(<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Slow</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">NodeId</span>, <span style="color:#e6db74">&#34;Notify result in slow path,proposeId:[clientId: %d,seqId: %d]&#34;</span>, <span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">ClientId</span>, <span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">SeqId</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// when command is committed, it can be remove from witness and command set safely
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">removeRecord</span>(<span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">ProposeId</span>())
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// we don&#39;t need to lock this function,because it&#39;s the only func which modifies KVStore
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">StateMachine</span>) <span style="color:#a6e22e">execute</span>(<span style="color:#a6e22e">cmd</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">curp_proto</span>.<span style="color:#a6e22e">CurpClientCommand</span>) <span style="color:#66d9ef">string</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Op</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">command</span>.<span style="color:#a6e22e">PUT</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">KVStore</span>.<span style="color:#a6e22e">Put</span>(<span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Key</span>, <span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Value</span>)
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Op</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">command</span>.<span style="color:#a6e22e">DELETE</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">KVStore</span>.<span style="color:#a6e22e">Delete</span>(<span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Key</span>)
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Op</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">command</span>.<span style="color:#a6e22e">GET</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">result</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">KVStore</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Key</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;NOT FOUND IN STATE&#34;</span>
</span></span><span style="display:flex;"><span>		} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">result</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// unreachable!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="fast-path">Fast Path<a hidden class="anchor" aria-hidden="true" href="#fast-path">#</a></h3>
<p>åœ¨åˆ†æå®ŒCommand Boardå’ŒCommand Workerä¹‹åï¼Œå°±å¯ä»¥ä¸²é€šCURPçš„fast pathå’Œslow pathçš„å…¨æµç¨‹äº†ã€‚
fast pathé€šè¿‡ <code>Propose ()</code> å®Œæˆï¼Œæ— è®ºè¯»å†™è¯·æ±‚éƒ½ä¼šè¢«å°è£…æˆä¸€ä¸ªClientCommandï¼Œéšåè°ƒç”¨ <code>Propose()</code> ï¼Œæµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>é¦–å…ˆè¿›è¡Œå†²çªæ£€æµ‹ï¼Œå°†è¯·æ±‚æ·»åŠ åˆ°Witnesså½“ä¸­ï¼Œå¹¶ä¸”è¿”å›æ˜¯å¦å†²çª</li>
<li>followeråœ¨fast pathä¸­åªèµ·åˆ°witnessä½œç”¨ã€‚å¦‚æœå½“å‰èŠ‚ç‚¹éLeaderï¼Œé‚£ä¹ˆæ­¤æ—¶å°±å¯ä»¥è¿”å›äº†ï¼Œå“åº”CONFLICTæˆ–è€…ACCEPT</li>
<li>å¯¹äºLeaderåç»­åº”å½“ç›´æ¥ç»§ç»­æ‰§è¡Œï¼Œé€šè¿‡fast pathçš„channelå°†cmdäº¤ç»™ cmd workerï¼Œå¹¶é€šè¿‡proposeCå°†cmdä¼ é€’ç»™raft</li>
<li>é€šè¿‡CommandBoardç­‰å¾…ç»“æœï¼Œå“åº”ç»™Client</li>
</ol>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">StateMachine</span>) <span style="color:#a6e22e">Propose</span>(<span style="color:#a6e22e">cmd</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">curp_proto</span>.<span style="color:#a6e22e">CurpClientCommand</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">curp_proto</span>.<span style="color:#a6e22e">CurpReply</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">isConflict</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">witness</span>.<span style="color:#a6e22e">InsertIfNotConflict</span>(<span style="color:#a6e22e">cmd</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Lock</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">raftState</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">raft</span>.<span style="color:#a6e22e">StateLeader</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Trace</span>(<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Leader</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">NodeId</span>, <span style="color:#e6db74">&#34;propose command %s,type: %s,conflict: %v&#34;</span>, <span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Key</span>, <span style="color:#a6e22e">command</span>.<span style="color:#a6e22e">OpFmt</span>[<span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Op</span>], <span style="color:#a6e22e">isConflict</span>)
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Trace</span>(<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Follower</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">NodeId</span>, <span style="color:#e6db74">&#34;propose command %s,type: %s,conflict: %v&#34;</span>, <span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Key</span>, <span style="color:#a6e22e">command</span>.<span style="color:#a6e22e">OpFmt</span>[<span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Op</span>], <span style="color:#a6e22e">isConflict</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">reply</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">curp_proto</span>.<span style="color:#a6e22e">CurpReply</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Content</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">raftState</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">raft</span>.<span style="color:#a6e22e">StateLeader</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">isConflict</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">reply</span>.<span style="color:#a6e22e">StatusCode</span> = <span style="color:#a6e22e">curp_proto</span>.<span style="color:#a6e22e">CONFLICT</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">reply</span>
</span></span><span style="display:flex;"><span>		} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">reply</span>.<span style="color:#a6e22e">StatusCode</span> = <span style="color:#a6e22e">curp_proto</span>.<span style="color:#a6e22e">ACCEPTED</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">reply</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">buf</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Encode</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">fastPath</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">cmd</span>
</span></span><span style="display:flex;"><span>	}()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// command will update the state machine or get command is conflict
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Trace</span>(<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Leader</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">NodeId</span>, <span style="color:#e6db74">&#34;send propose[clientId:%d seqId: %d] msg to raft node&#34;</span>, <span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">ClientId</span>, <span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">SeqId</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">proposeC</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">buf</span>
</span></span><span style="display:flex;"><span>	}()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">proposeId</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">command</span>.<span style="color:#a6e22e">ProposeId</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">ClientId</span>: <span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">ClientId</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">SeqId</span>:    <span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">SeqId</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">result</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">commandBoard</span>.<span style="color:#a6e22e">WaitForEr</span>(<span style="color:#a6e22e">proposeId</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">reply</span>.<span style="color:#a6e22e">Content</span> = <span style="color:#a6e22e">result</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">isConflict</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">reply</span>.<span style="color:#a6e22e">StatusCode</span> = <span style="color:#a6e22e">curp_proto</span>.<span style="color:#a6e22e">CONFLICT</span>
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">reply</span>.<span style="color:#a6e22e">StatusCode</span> = <span style="color:#a6e22e">curp_proto</span>.<span style="color:#a6e22e">ACCEPTED</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">reply</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™é‡Œæœ‰ä¸€ä¸ªç»†èŠ‚ï¼Œåœ¨CURP-Qçš„è®ºæ–‡å½“ä¸­æè¿°ï¼šLeaderçš„witnessåº”å½“æ˜¯å…³é—­çš„ï¼Œå³Leaderå¹¶ä¸è¿›è¡Œå†²çªæ£€æµ‹ï¼Œå¯¹äºæ‰€æœ‰è¯·æ±‚éƒ½ç›´æ¥æ‰§è¡Œï¼Œä½†æ˜¯åœ¨Xlineçš„å®ç°ä¸­ï¼ŒLeaderæ˜¯å¯åŠ¨äº†Witnesså¹¶è¿›è¡Œå†²çªæ£€æµ‹çš„ã€‚å¯¹äºè¿™ä¸ªç»†èŠ‚ï¼Œä¸ªäººè®¤ä¸ºå¹¶ä¸ä¼šå¯¹å¹¶ä¸ä¼šå¯¹ç³»ç»Ÿæ­£ç¡®æ€§äº§ç”Ÿå½±å“ï¼Œæš‚æ—¶æ²¡æœ‰æ·±ç©¶ã€‚</p>
<blockquote>
<p>Witnesses in leaders are inactive, and all client requests are serialized and logged in their command logs directly.</p>
</blockquote>
<p><img loading="lazy" src="https://pic-bed-1309931445.cos.ap-nanjing.myqcloud.com/blog/20240607000134.png" alt="image.png"  />
</p>
<h3 id="slow-path">Slow Path<a hidden class="anchor" aria-hidden="true" href="#slow-path">#</a></h3>
<p>Slow Pathçš„å…¥å£å¾ˆç®€å•ï¼Œåªéœ€è¦è°ƒç”¨ <code>WaitForAsr()</code> æ¥ç­‰å¾…commitå³å¯ï¼Œé€šè¿‡ <code>WaitSynced()</code> æ¥å®ç°</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">StateMachine</span>) <span style="color:#a6e22e">WaitSynced</span>(<span style="color:#a6e22e">id</span> <span style="color:#a6e22e">command</span>.<span style="color:#a6e22e">ProposeId</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">curp_proto</span>.<span style="color:#a6e22e">CurpReply</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// only send wait synced message to leader
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Trace</span>(<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Leader</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">NodeId</span>, <span style="color:#e6db74">&#34;got wait synced message: %v&#34;</span>, <span style="color:#a6e22e">id</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">result</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">commandBoard</span>.<span style="color:#a6e22e">WaitForAsr</span>(<span style="color:#a6e22e">id</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">reply</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">curp_proto</span>.<span style="color:#a6e22e">CurpReply</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Content</span>:    <span style="color:#a6e22e">result</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">StatusCode</span>: <span style="color:#a6e22e">curp_proto</span>.<span style="color:#a6e22e">ACCEPTED</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Trace</span>(<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Leader</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">NodeId</span>, <span style="color:#e6db74">&#34;wait synced finished,id: %v,result: %v&#34;</span>, <span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">result</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">reply</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨Fast Pathä¸­ï¼ŒLeaderä¼šé€šè¿‡proposeCå‘é€ç»™Raftï¼Œæ­¤æ—¶å°±ç›¸å½“äºè¿›å…¥äº†Slow Pathï¼Œåœ¨Raftä¸­ï¼Œå®Œæˆå…±è¯†çš„cmdä¼šé€šè¿‡Readyè¿”å›ï¼Œç»RaftNodeè½¬æ‰‹åˆé€šè¿‡commitCå‘é€ä¼šäº†çŠ¶æ€æœºï¼ŒçŠ¶æ€æœºæ”¶åˆ°ä¹‹åï¼Œå¯¹cmdè¿›è¡Œdecodeï¼Œéšæœºé€šè¿‡slow path channelåˆå°†è¯·æ±‚å‘é€ç»™äº†cmd worker</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">StateMachine</span>) <span style="color:#a6e22e">readCommits</span>(<span style="color:#a6e22e">commitC</span> <span style="color:#f92672">&lt;-</span><span style="color:#66d9ef">chan</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">commit</span>, <span style="color:#a6e22e">errorC</span> <span style="color:#f92672">&lt;-</span><span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">commit</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">commitC</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">commit</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// signaled to load snapshot
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#a6e22e">snapshot</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">loadSnapshot</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Panic</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">snapshot</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;loading snapshot at term %d and index %d&#34;</span>, <span style="color:#a6e22e">snapshot</span>.<span style="color:#a6e22e">Metadata</span>.<span style="color:#a6e22e">Term</span>, <span style="color:#a6e22e">snapshot</span>.<span style="color:#a6e22e">Metadata</span>.<span style="color:#a6e22e">Index</span>)
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">recoverFromSnapshot</span>(<span style="color:#a6e22e">snapshot</span>.<span style="color:#a6e22e">Data</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>					<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Panic</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">data</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">commit</span>.<span style="color:#a6e22e">data</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">cmd</span> <span style="color:#a6e22e">curp_proto</span>.<span style="color:#a6e22e">CurpClientCommand</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">dec</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">gob</span>.<span style="color:#a6e22e">NewDecoder</span>(<span style="color:#a6e22e">bytes</span>.<span style="color:#a6e22e">NewBufferString</span>(<span style="color:#a6e22e">data</span>))
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dec</span>.<span style="color:#a6e22e">Decode</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">cmd</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalf</span>(<span style="color:#e6db74">&#34;raftexample: could not decode message (%v)&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">slowPath</span> <span style="color:#f92672">&lt;-</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">cmd</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		close(<span style="color:#a6e22e">commit</span>.<span style="color:#a6e22e">applyDoneC</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">errorC</span>; <span style="color:#a6e22e">ok</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¹‹åå°±æ˜¯cmd workerçš„é€»è¾‘äº†ï¼Œåœ¨ä¸Šé¢å·²ç»åˆ†æè¿‡äº†ï¼Œè¿™é‡Œç®€è¦æ•´åˆä¸€ä¸‹ã€‚å¯¹äºleaderè€Œè¨€ï¼Œç›´æ¥å¿½ç•¥slow pathä¸­çš„å†…å®¹ï¼Œä»¥å…å†…å®¹è¦†ç›–å½±å“çº¿æ€§ä¸€è‡´æ€§ã€‚è€Œå¯¹äºfollowerè€Œè¨€ï¼Œç›´æ¥åº”ç”¨ä»¥è·ŸéšLeaderã€‚slow pathæ‰§è¡Œå®Œæˆï¼Œå³å¯è®¤å®šå…¶ä¸ºcommitï¼Œæ­¤æ—¶å¯ä»¥é€šè¿‡ <code>NotifyAsr</code> è·å–æ‰§è¡Œç»“æœï¼Œå¹¶é€šçŸ¥ <code>WaitSynced</code> ç»“æŸé˜»å¡ã€‚</p>
<p><img loading="lazy" src="https://pic-bed-1309931445.cos.ap-nanjing.myqcloud.com/blog/20240607000719.png" alt="image.png"  />
</p>
<h2 id="curp-client">CURP Client<a hidden class="anchor" aria-hidden="true" href="#curp-client">#</a></h2>
<p>å¯¹åº”åœ°ï¼Œåœ¨CURP Clientç«¯ä¹Ÿåˆ†ä¸ºäº†fast pathå’Œslow pathï¼Œå‡é€šè¿‡grpcå®ç°ï¼Œæ­¤å¤–ï¼Œè¿˜éœ€è¦ä¸€ä¸ªisLeaderæ¥ç¡®å®šserverä¸­çš„leaderï¼Œä»¥ç¡®å®šåº”å½“å‘è°å‘é€ <code>WaitSynced()</code>ã€‚</p>
<h3 id="fast-path-1">Fast path<a hidden class="anchor" aria-hidden="true" href="#fast-path-1">#</a></h3>
<p>åœ¨fast pathä¸­ï¼Œclientéœ€è¦åšçš„å°±æ˜¯å°†è¯·æ±‚å¹¿æ’­ç»™æ‰€æœ‰çš„serverï¼Œç„¶åç›‘å¬ç»Ÿè®¡ç»“æœï¼š</p>
<ul>
<li>å¦‚æœå“åº”ç»“æœä¸­å­˜åœ¨å†²çªï¼Œé‚£ä¹ˆå°±è¿”å›å†²çªï¼Œåç»­è½¬å‘slow round</li>
<li>å¦‚æœè¾¾åˆ°äº†superquorum (fä¸ªèŠ‚ç‚¹ï¼Œå¯¹åº”ä¸ºf + f / 2 + 1ï¼Œå³ 4 èŠ‚ç‚¹éœ€è¦ 3 ä¸ªï¼Œ3 èŠ‚ç‚¹éœ€è¦ 3ä¸ª )ï¼Œå°±è¿”å›è¯·æ±‚æˆåŠŸ</li>
<li>è¶…æ—¶æ£€æµ‹</li>
</ul>
<p><img loading="lazy" src="https://pic-bed-1309931445.cos.ap-nanjing.myqcloud.com/blog/20240527235816.png" alt="image.png"  />
</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">GrpcClient</span>) <span style="color:#a6e22e">fastRound</span>(<span style="color:#a6e22e">cmd</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">curp_proto</span>.<span style="color:#a6e22e">CurpClientCommand</span>, <span style="color:#a6e22e">notifyC</span> []<span style="color:#66d9ef">chan</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">curp_proto</span>.<span style="color:#a6e22e">CurpReply</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">curp_proto</span>.<span style="color:#a6e22e">CurpReply</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">timeout</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">NewTicker</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">5</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fastPathChan</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">curp_proto</span>.<span style="color:#a6e22e">CurpReply</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; len(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">grpc_servers</span>); <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">i</span> <span style="color:#66d9ef">int</span>) {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">sendC</span>[<span style="color:#a6e22e">i</span>] <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">cmd</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">result</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">notifyC</span>[<span style="color:#a6e22e">i</span>]
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">fastPathChan</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">result</span>
</span></span><span style="display:flex;"><span>		}(<span style="color:#a6e22e">i</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">acceptedCount</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">result</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">curp_proto</span>.<span style="color:#a6e22e">CurpReply</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">StatusCode</span>: <span style="color:#a6e22e">curp_proto</span>.<span style="color:#a6e22e">TIMEOUT</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Content</span>:    <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">select</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">fastResult</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">fastPathChan</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Trace</span>(<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;client receive fast path result: %v&#34;</span>, <span style="color:#a6e22e">fastResult</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">fastResult</span>.<span style="color:#a6e22e">StatusCode</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">curp_proto</span>.<span style="color:#a6e22e">ACCEPTED</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">acceptedCount</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">fastResult</span>.<span style="color:#a6e22e">Content</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>					<span style="color:#a6e22e">result</span> = <span style="color:#a6e22e">fastResult</span>
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fastResult</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">acceptedCount</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">superQuorum</span>() {
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">result</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">timeout</span>.<span style="color:#a6e22e">C</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;timeout !!\n&#34;</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">result</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;fast path time out&#34;</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="slow-path-1">slow path<a hidden class="anchor" aria-hidden="true" href="#slow-path-1">#</a></h3>
<p>slow pathæ¯”è¾ƒç®€å•ï¼Œåªéœ€è¦å°†è¯·æ±‚å‘é€ç»™Leaderå³å¯</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">GrpcClient</span>) <span style="color:#a6e22e">slowRound</span>(<span style="color:#a6e22e">cmd</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">curp_proto</span>.<span style="color:#a6e22e">CurpClientCommand</span>, <span style="color:#a6e22e">notifyC</span> []<span style="color:#66d9ef">chan</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">curp_proto</span>.<span style="color:#a6e22e">CurpReply</span>) (<span style="color:#66d9ef">string</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">sync_cmd</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">curp_proto</span>.<span style="color:#a6e22e">CurpClientCommand</span>{<span style="color:#a6e22e">ClientId</span>: <span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">ClientId</span>, <span style="color:#a6e22e">SeqId</span>: <span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">SeqId</span>, <span style="color:#a6e22e">Sync</span>: <span style="color:#ae81ff">1</span>}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">sendC</span>[<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">LeaderId</span>] <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">sync_cmd</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">reply</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">notifyC</span>[<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">LeaderId</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Trace</span>(<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;client wait synced finished, id: %v&#34;</span>, <span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">ProposeId</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">reply</span>.<span style="color:#a6e22e">StatusCode</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">curp_proto</span>.<span style="color:#a6e22e">CONFLICT</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;command is still conflict after wait synced&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">reply</span>.<span style="color:#a6e22e">Content</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>éšåï¼Œå°†fast pathå’Œslow pathåšä¸€ä¸ªæ•´åˆï¼Œå°è£…æˆ <code>Propose()</code> ï¼Œåœ¨ <code>Propose()</code> ä¸­ï¼š</p>
<ol>
<li>é¦–å…ˆè°ƒç”¨ <code>fast_round()</code> ï¼Œå°†è¯·æ±‚è¿›è¡Œå¹¿æ’­ï¼Œå¦‚æœä¸å­˜åœ¨å†²çªï¼Œé‚£ä¹ˆå°±å¯ä»¥ç›´æ¥è¿”å›ï¼Œä»£è¡¨æ­¤æ¬¡è¯·æ±‚åœ¨ 1 ä¸ªRTTå†…ç»“æŸ</li>
<li>å¦‚æœ <code>fast_round()</code> ä¸­å­˜åœ¨å†²çªï¼Œé‚£ä¹ˆå†è°ƒç”¨ <code>slow_round()</code>ï¼Œé€šè¿‡ serverå¯¹ <code>Waitsynced()</code> æ¥ç­‰å¾…commitï¼Œè§£å†³å†²çª</li>
</ol>
<p><img loading="lazy" src="https://pic-bed-1309931445.cos.ap-nanjing.myqcloud.com/blog/20240606230028.png" alt="image.png"  />
</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">GrpcClient</span>) <span style="color:#a6e22e">Propose</span>(<span style="color:#a6e22e">cmd</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">curp_proto</span>.<span style="color:#a6e22e">CurpClientCommand</span>) (<span style="color:#66d9ef">string</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">ntfC</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">NewNotifyC</span>(<span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">SeqId</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">DeleteNotifyC</span>(<span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">SeqId</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">reply</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">fastRound</span>(<span style="color:#a6e22e">cmd</span>, <span style="color:#a6e22e">ntfC</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">reply</span>.<span style="color:#a6e22e">StatusCode</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">curp_proto</span>.<span style="color:#a6e22e">ACCEPTED</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">static</span>.<span style="color:#a6e22e">fast</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">reply</span>.<span style="color:#a6e22e">Content</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">static</span>.<span style="color:#a6e22e">slow</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Trace</span>(<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;client receive conflict result, turn to slow path: %v&#34;</span>, <span style="color:#a6e22e">reply</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">resultStr</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">slowRound</span>(<span style="color:#a6e22e">cmd</span>, <span style="color:#a6e22e">ntfC</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">resultStr</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™é‡Œæœ‰ä¸€ä¸ªå°çš„ä¼˜åŒ–ï¼Œå³å¯ä»¥åŒæ—¶å‘é€fast roundå’Œslow roundè¯·æ±‚ï¼Œè¿™æ ·å¯ä»¥æ›´å¿«åœ°è·å–WaitSyncedçš„ç»“æœã€‚</p>
<h2 id="benchmark">benchmark<a hidden class="anchor" aria-hidden="true" href="#benchmark">#</a></h2>
<p>è¿™é‡Œä½¿ç”¨benchmarkå¯¹curpçš„æ€§èƒ½åšäº†ä¸€ä¸ªç®€å•çš„æµ‹è¯•ï¼Œé€‰æ‹©çš„æ˜¯æ¯”è¾ƒé€šç”¨çš„go-ycsbï¼Œå€Ÿç”¨äº†ä¸€ä¸‹go-ycsbçš„åŠ è½½æ•°æ®å’Œç»Ÿè®¡ç»“æœçš„åŠŸèƒ½ï¼Œç„¶åè‡ªå·±é€šè¿‡tcpä¸ºcurpå®ç°äº†ä¸€ä¸ªserverï¼Œç„¶ååœ¨ycsbä¸­å®ç°äº†ä¸€ä¸ªclientï¼Œè¿™æ ·å°±å¯ä»¥æŠŠè¯·æ±‚ä»ycsbæˆåŠŸå‘é€åˆ°curpäº†ã€‚</p>
<p>è¿™é‡Œå®ç°çš„ç¡®å®æ˜¯æ¯”è¾ƒè‰ç‡ï¼Œä½†æ˜¯ä½ å°±è¯´èƒ½ä¸èƒ½ç”¨å§ğŸ˜€</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">87
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">GetResponse</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Count</span> <span style="color:#66d9ef">int64</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Kvs</span>   []<span style="color:#f92672">*</span><span style="color:#a6e22e">Command</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">GetResponse</span>) <span style="color:#a6e22e">Encode</span>() []<span style="color:#66d9ef">byte</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">buf</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">bytes</span>.<span style="color:#a6e22e">Buffer</span>{}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">enc</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">gob</span>.<span style="color:#a6e22e">NewEncoder</span>(<span style="color:#a6e22e">buf</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">enc</span>.<span style="color:#a6e22e">Encode</span>(<span style="color:#a6e22e">r</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;encode error:&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">buf</span>.<span style="color:#a6e22e">Bytes</span>()
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">GET</span> <span style="color:#66d9ef">uint8</span> = <span style="color:#66d9ef">iota</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">PUT</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">DELETE</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Command</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Op</span>    <span style="color:#66d9ef">uint8</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Key</span>   <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Value</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">bench_server</span>(<span style="color:#a6e22e">port</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">client</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">curp</span>.<span style="color:#a6e22e">GrpcClient</span>) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">listener</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Listen</span>(<span style="color:#e6db74">&#34;tcp&#34;</span>, <span style="color:#a6e22e">port</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Error listening:&#34;</span>, <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Exit</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">listener</span>.<span style="color:#a6e22e">Close</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Server is listening on :%v\n&#34;</span>, <span style="color:#a6e22e">port</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">listener</span>.<span style="color:#a6e22e">Accept</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Error accepting: &#34;</span>, <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Exit</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">handleRequest</span>(<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">client</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">handleRequest</span>(<span style="color:#a6e22e">conn</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Conn</span>, <span style="color:#a6e22e">client</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">curp</span>.<span style="color:#a6e22e">GrpcClient</span>) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">buf</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, <span style="color:#ae81ff">4096</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">n</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Read</span>(<span style="color:#a6e22e">buf</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">aCmd</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Command</span>{}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">dec</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">gob</span>.<span style="color:#a6e22e">NewDecoder</span>(<span style="color:#a6e22e">bytes</span>.<span style="color:#a6e22e">NewReader</span>(<span style="color:#a6e22e">buf</span>[:<span style="color:#a6e22e">n</span>]))
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dec</span>.<span style="color:#a6e22e">Decode</span>(<span style="color:#a6e22e">aCmd</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// fmt.Printf(&#34;Received: %+v\n&#34;, aCmd)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">aCmd</span>.<span style="color:#a6e22e">Op</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">GET</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// call client.get
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">key</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">aCmd</span>.<span style="color:#a6e22e">Key</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// value := &#34;myValue&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">value</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">aCmd</span>.<span style="color:#a6e22e">Key</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">cmd</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Command</span>{
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Op</span>:    <span style="color:#a6e22e">GET</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Key</span>:   <span style="color:#a6e22e">key</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Value</span>: <span style="color:#a6e22e">value</span>,
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">cmds</span> <span style="color:#f92672">:=</span> []<span style="color:#f92672">*</span><span style="color:#a6e22e">Command</span>{<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">cmd</span>}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">resp</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">GetResponse</span>{
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Count</span>: <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Kvs</span>:   <span style="color:#a6e22e">cmds</span>,
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">buf</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">resp</span>.<span style="color:#a6e22e">Encode</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">buf</span>)
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">aCmd</span>.<span style="color:#a6e22e">Op</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">PUT</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// call client.put
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Put</span>(<span style="color:#a6e22e">aCmd</span>.<span style="color:#a6e22e">Key</span>, <span style="color:#a6e22e">aCmd</span>.<span style="color:#a6e22e">Value</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Write</span>([]byte(<span style="color:#e6db74">&#34;Received PUT Response!&#34;</span>))
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">aCmd</span>.<span style="color:#a6e22e">Op</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">DELETE</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// call client.delete
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Del</span>(<span style="color:#a6e22e">aCmd</span>.<span style="color:#a6e22e">Key</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Write</span>([]byte(<span style="color:#e6db74">&#34;Received DELETE Response!&#34;</span>))
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è·‘äº†ä¸€ä¸ªç®€å•çš„benchmarkï¼Œç”±äºæ²¡æœ‰å®ç°scanæ“ä½œï¼Œå› æ­¤å°±åªé€‰æ‹©äº†ycsbä¸­çš„workload a-b-cï¼Œå…¶ä¸­workloadaä¸º 50%read 50%writeï¼Œworkloadbä¸º 95%read 5% writeï¼Œworkloadc 100% read,ã€‚</p>
<p>å¯ä»¥çœ‹åˆ°æ— è®ºæ˜¯å“ªä¸ªworkloadï¼Œcurpçš„æ€§èƒ½å‡å¥½äºraftï¼Œå¯¹äºaï¼Œå¤§çº¦æ˜¯ä¸ª 20-30%çš„æå‡ï¼Œb, cç”±äºä¸»è¦æ˜¯è¯»è¯·æ±‚ä¸ºä¸»ï¼Œcurpä¸­åªéœ€è¦ä¸€è½®rttåŠ æŸ¥è¯¢çŠ¶æ€æœºå³å¯ï¼Œè€Œraftéœ€è¦èµ°ä¸€éæ—¥å¿—å¤åˆ¶+æŸ¥è¯¢çŠ¶æ€æœºï¼Œå› æ­¤å·®è·è¢«è¿›ä¸€æ­¥æ‹‰å¤§ï¼ˆè¿™é‡ŒäºŒè€…éƒ½æ²¡æœ‰å¼€å¯çº¿æ€§ä¸€è‡´æ€§è¯»ä¼˜åŒ–çš„ï¼Œå³lease readæˆ–read indexï¼‰</p>
<p>è¿™ä¸ªbenchmarkæ˜¯åœ¨å•æœºä¸Šè·‘çš„ï¼Œå¦‚æœçœŸæ­£åˆ°äº†è·¨åŸŸçš„é«˜ç½‘ç»œå»¶è¿Ÿçš„åœºæ™¯ä¸‹ï¼Œå·®è·ä¼šè¢«è¿›ä¸€æ­¥çš„æ‹‰å¤§</p>
<table>
<thead>
<tr>
<th></th>
<th>curp</th>
<th>raft</th>
</tr>
</thead>
<tbody>
<tr>
<td>workload a</td>
<td>5.2s</td>
<td>6.7s</td>
</tr>
<tr>
<td>workload b</td>
<td>1.2s</td>
<td>4.4s</td>
</tr>
<tr>
<td>wrokload c</td>
<td>0.6s</td>
<td>4.1s<br></td>
</tr>
</tbody>
</table>
<p>go-ycsbçš„è¯¦ç»†ç»“æœå¦‚ä¸‹ï¼š</p>
<p><strong>CURP</strong></p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>workloada
</span></span><span style="display:flex;"><span>READ   - Takes(s): 5.2, Count: 488, OPS: 94.2, Avg(us): 600, Min(us): 433, Max(us): 25103, 50th(us): 534, 90th(us): 612, 95th(us): 652, 99th(us): 948, 99.9th(us): 25103, 99.99th(us): 25103
</span></span><span style="display:flex;"><span>TOTAL  - Takes(s): 5.2, Count: 1000, OPS: 192.8, Avg(us): 5185, Min(us): 433, Max(us): 52991, 50th(us): 6859, 90th(us): 11503, 95th(us): 12847, 99th(us): 16559, 99.9th(us): 27471, 99.99th(us): 52991
</span></span><span style="display:flex;"><span>UPDATE - Takes(s): 5.2, Count: 512, OPS: 98.7, Avg(us): 9556, Min(us): 5396, Max(us): 52991, 50th(us): 8703, 90th(us): 12823, 95th(us): 14599, 99th(us): 18991, 99.9th(us): 27471, 99.99th(us): 52991
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>workloadb
</span></span><span style="display:flex;"><span>Run finished, takes 1.198906187s
</span></span><span style="display:flex;"><span>READ   - Takes(s): 1.2, Count: 950, OPS: 793.1, Avg(us): 567, Min(us): 304, Max(us): 43807, 50th(us): 507, 90th(us): 582, 95th(us): 640, 99th(us): 1156, 99.9th(us): 1788, 99.99th(us): 43807
</span></span><span style="display:flex;"><span>TOTAL  - Takes(s): 1.2, Count: 1000, OPS: 834.4, Avg(us): 1192, Min(us): 304, Max(us): 43807, 50th(us): 511, 90th(us): 631, 95th(us): 6403, 99th(us): 15151, 99.9th(us): 20879, 99.99th(us): 43807
</span></span><span style="display:flex;"><span>UPDATE - Takes(s): 1.1, Count: 50, OPS: 43.9, Avg(us): 13067, Min(us): 6400, Max(us): 20879, 50th(us): 13175, 90th(us): 15527, 95th(us): 16767, 99th(us): 20879, 99.9th(us): 20879, 99.99th(us): 20879
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>workloadc
</span></span><span style="display:flex;"><span>Run finished, takes 596.022766ms
</span></span><span style="display:flex;"><span>READ   - Takes(s): 0.6, Count: 1000, OPS: 1680.6, Avg(us): 590, Min(us): 313, Max(us): 60863, 50th(us): 511, 90th(us): 614, 95th(us): 682, 99th(us): 1099, 99.9th(us): 1634, 99.99th(us): 60863
</span></span><span style="display:flex;"><span>TOTAL  - Takes(s): 0.6, Count: 1000, OPS: 1680.0, Avg(us): 590, Min(us): 313, Max(us): 60863, 50th(us): 511, 90th(us): 614, 95th(us): 682, 99th(us): 1099, 99.9th(us): 1634, 99.99th(us): 60863
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Raft</strong></p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>workloada
</span></span><span style="display:flex;"><span>Run finished, takes 6.741194029s
</span></span><span style="display:flex;"><span>READ   - Takes(s): 6.7, Count: 490, OPS: 72.8, Avg(us): 4182, Min(us): 3188, Max(us): 25279, 50th(us): 3571, 90th(us): 4787, 95th(us): 7699, 99th(us): 12015, 99.9th(us): 25279, 99.99th(us): 25279
</span></span><span style="display:flex;"><span>TOTAL  - Takes(s): 6.7, Count: 1000, OPS: 148.7, Avg(us): 6733, Min(us): 3188, Max(us): 42047, 50th(us): 7979, 90th(us): 9599, 95th(us): 12111, 99th(us): 17407, 99.9th(us): 25279, 99.99th(us): 42047
</span></span><span style="display:flex;"><span>UPDATE - Takes(s): 6.7, Count: 510, OPS: 76.0, Avg(us): 9183, Min(us): 6908, Max(us): 42047, 50th(us): 8295, 90th(us): 11175, 95th(us): 15455, 99th(us): 18591, 99.9th(us): 20079, 99.99th(us): 42047
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>workloadb
</span></span><span style="display:flex;"><span>Run finished, takes 4.386455138s
</span></span><span style="display:flex;"><span>READ   - Takes(s): 4.4, Count: 952, OPS: 217.6, Avg(us): 4152, Min(us): 3196, Max(us): 27407, 50th(us): 3553, 90th(us): 5947, 95th(us): 10591, 99th(us): 11487, 99.9th(us): 18127, 99.99th(us): 27407
</span></span><span style="display:flex;"><span>TOTAL  - Takes(s): 4.4, Count: 1000, OPS: 228.6, Avg(us): 4380, Min(us): 3196, Max(us): 27407, 50th(us): 3559, 90th(us): 7479, 95th(us): 10799, 99th(us): 11599, 99.9th(us): 18127, 99.99th(us): 27407
</span></span><span style="display:flex;"><span>UPDATE - Takes(s): 4.3, Count: 48, OPS: 11.1, Avg(us): 8898, Min(us): 7096, Max(us): 15031, 50th(us): 8271, 90th(us): 10735, 95th(us): 14975, 99th(us): 15031, 99.9th(us): 15031, 99.99th(us): 15031
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>workloadc
</span></span><span style="display:flex;"><span>Run finished, takes 4.143589849s
</span></span><span style="display:flex;"><span>READ   - Takes(s): 4.1, Count: 1000, OPS: 242.1, Avg(us): 4138, Min(us): 3272, Max(us): 44351, 50th(us): 3575, 90th(us): 5939, 95th(us): 7511, 99th(us): 11207, 99.9th(us): 13191, 99.99th(us): 44351
</span></span><span style="display:flex;"><span>TOTAL  - Takes(s): 4.1, Count: 1000, OPS: 242.1, Avg(us): 4138, Min(us): 3272, Max(us): 44351, 50th(us): 3575, 90th(us): 5939, 95th(us): 7511, 99th(us): 11207, 99.9th(us): 13191, 99.99th(us): 44351
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="todo">TODO<a hidden class="anchor" aria-hidden="true" href="#todo">#</a></h2>
<p>ç›®å‰çš„CURPåªå®ç°äº†åŸºç¡€çš„è¿è¡Œï¼Œå¹¶æ²¡æœ‰è€ƒè™‘crash-recoveryï¼Œè¿™å¯¹äºä¸€ä¸ªå…±è¯†æ¥è¯´æ˜¾ç„¶æ˜¯ä¸è¶³çš„ï¼Œä¸è¿‡ç¢äºæ—¶é—´å’Œç²¾åŠ›ï¼ŒçŸ­æ—¶é—´ç¬”è€…æ˜¯æ— æ³•è¡¥å…¨è¿™ä¸€éƒ¨åˆ†äº†ï¼Œåœ¨è¿™é‡Œç®€å•è¯´ä¸€ä¸‹æ€è·¯ã€‚</p>
<h3 id="version">Version<a hidden class="anchor" aria-hidden="true" href="#version">#</a></h3>
<p>é¦–å…ˆï¼Œå¯¹äºæŒ‚æ‰å’Œå›å¤çš„èŠ‚ç‚¹ï¼Œæ•´ä¸ªé›†ç¾¤åº”å½“èƒ½å¤Ÿæ„ŸçŸ¥ï¼Œè®ºæ–‡ä¸­ä¸­ç»™å‡ºçš„æ–¹æ¡ˆæ˜¯ç»´æŠ¤ä¸€ä¸ªé›†ç¾¤åˆ—è¡¨+versionï¼Œclienté¦–æ¬¡ä»é…ç½®ä¸­å¿ƒå¤„æŒæœ‰è¯¥åˆ—è¡¨å’Œversionï¼Œä¹‹åæ¯æ¬¡è¯·æ±‚æ˜¯æºå¸¦ä¸Šversionï¼Œéšåé…ç½®ä¸­å¿ƒæ¥æ”¶åˆ°è¯·æ±‚åä¼šæ ¡éªŒversionï¼Œæ¥åˆ¤æ–­clientæŒæœ‰çš„é…ç½®æ˜¯å¦è¿‡æœŸ, å¦‚æœè¿‡æœŸå°±æ‹’ç»æ‰æ­¤æ¬¡è¯·æ±‚ï¼Œå¹¶å‘ŠçŸ¥Client</p>
<p>åœ¨å®ç°ä¸Šï¼Œé…ç½®ä¸­å¿ƒå¯ä»¥å®ç°åœ¨Leaderä¸Šï¼ŒClientåœ¨è°ƒç”¨ <code>isLeader ()</code> ç¡®å®šé›†ç¾¤Leaderæ—¶é¡ºä¾¿è·å–åˆ°versionå’Œé…ç½®ï¼Œå¹¶åœ¨clientç«¯ç»´æŠ¤ï¼Œéšåæ‰©å±•ä¸€ä¸‹protobufçš„ç»“æ„ä½“ï¼Œæ¯æ¬¡è¯·æ±‚æºå¸¦ä¸Šversionã€‚serverç«¯ï¼Œserverç«¯åœ¨ä»raftå¤„æ£€æµ‹åˆ°èº«ä»½å˜æ›´æ—¶ï¼Œå°±åº”å½“ç”±æ–°çš„leaderå»ç”Ÿæˆä¸€ä»½æ–°çš„é…ç½®+versionã€‚å°†å…¶è¿”å›ç»™client</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">StateMachine</span>) <span style="color:#a6e22e">listenRaftState</span>() {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">state</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">stateChangeC</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Lock</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Trace</span>(<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Vote</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">NodeId</span>, <span style="color:#e6db74">&#34;raft state update: before: %s,current: %s&#34;</span>, <span style="color:#a6e22e">stmap</span>[<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">raftState</span>], <span style="color:#a6e22e">stmap</span>[<span style="color:#a6e22e">state</span>])
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// å¦‚æœæ˜¯Leaderï¼Œé‚£ä¹ˆå°±ç”Ÿæˆæ–°é…ç½®
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">raftState</span> = <span style="color:#a6e22e">state</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="witness-1">Witness<a hidden class="anchor" aria-hidden="true" href="#witness-1">#</a></h3>
<p>ç”±äºLeaderè¿›è¡Œäº†æŠ¢è·‘ï¼Œå› æ­¤ä¼šæœ‰ä¸€äº›è¯·æ±‚è¿˜æœªcommitï¼Œä½†ä¹Ÿå·²ç»è¿”å›ç»™clientäº†ï¼Œè¿™äº›è¯·æ±‚çš„ç»“æœï¼Œæˆ–è€…è¯´è¿™äº›è¯·æ±‚å¯¹çŠ¶æ€æœºçš„å½±å“æš‚æ—¶ä¸ä¼šæš´éœ²å‡ºæ¥ï¼ˆåç»­å¦‚æœæƒ³è¦è·å–ç»“æœï¼Œæˆ–è€…è¯´å¯¹å…¶ä¿®æ”¹ï¼Œéƒ½ä¼šå› å†²çªè€Œè¢«æ‹’ç»ï¼‰ä½†æ˜¯è¯·æ±‚æˆåŠŸä¹Ÿç¡®å®æ˜¯å®æ‰“å®çš„å“åº”ç»™clientäº†ã€‚å› æ­¤è¿™ä¸€éƒ¨åˆ†çš„è¯·æ±‚ç»“æœä¸èƒ½ä¸¢å¤±ï¼Œä½†æ˜¯åˆæ²¡æœ‰é€šè¿‡logå‘é€ç»™followerï¼Œå› æ­¤å°±éœ€è¦é€šè¿‡Witnessä¸­çš„å­˜å‚¨æ¥å®Œæˆæ¢å¤ã€‚</p>
<p>å…·ä½“æ¥è¯´ï¼Œéœ€è¦æ·»åŠ ä¸€æ¡rpcï¼Œä½¿å¾—æ–°çš„Leaderèƒ½å¤Ÿè·å–åˆ°followerçš„witnessä¸­çš„æ•°æ®ï¼Œç„¶åå†leaderå¤„æŒ‰ç…§é¡ºåºæ‰§è¡Œå¹¶å†™å…¥logã€‚ä»è€Œè§£å†³å†²çªå¹¶ç¡®å®šé¡ºåºã€‚å½“log commitæ—¶ï¼Œå³å¯è‡ªåŠ¨åˆ é™¤æ‰witnessä¸­çš„å†…å®¹ã€‚</p>
<h2 id="summary">Summary<a hidden class="anchor" aria-hidden="true" href="#summary">#</a></h2>
<p>æœ¬æ–‡åŸºäºetcd/raftï¼Œå®ç°äº†ä¸€ä¸ªç®€æ˜“çš„CURPï¼Œæä¾›äº†fast path + slow pathçš„é€»è¾‘ï¼Œä½¿å¾—ä¸å†²çªçš„è¯·æ±‚å¯ä»¥åœ¨ä¸€ä¸ªRTTå®Œæˆã€‚ç›®å‰è¿˜æ¬ ç¼ºrecoveryçš„é€»è¾‘ï¼Œä½†ä¸´è¿‘æ¯•ä¸šï¼Œç¬”è€…ç²¾åŠ›å®åœ¨æœ‰é™ï¼ŒçŸ­æ—¶é—´å†…åº”è¯¥æ˜¯æ²¡æœ‰ç²¾åŠ›å»è¡¥å®Œäº†ã€‚å¦‚æœæƒ³å­¦ä¹ å·¥ä¸šçº§CURPçš„å®ç°ï¼Œå¯ä»¥å»çœ‹Xlineï¼š<a href="https://github.com/xline-kv/Xline.git">GitHub - xline-kv/Xline: A geo-distributed KV store for metadata management</a></p>
<p>ç›®å‰çš„curpå’Œç»„é‡Œçš„ä¸€ä¸ªé¡¹ç›®ä»£ç æ··åœ¨ä¸€èµ·ï¼Œä¸å¤ªæ–¹ä¾¿å…¨éƒ¨å¼€æºï¼Œç­‰åç»­æœ‰ç©ºäº†ç»™åˆ†ç¦»å‡ºæ¥æ‰”åˆ°githubä¸Šã€‚</p>
<p>å¯¹äºCURPè€Œè¨€ï¼Œè™½ç„¶å…¶åœ¨æ€§èƒ½ä¸Šé¢†å…ˆRaftä¸å°‘ï¼Œä½†æ˜¯åœ¨ç¬”è€…æµ‹è¯•çš„è¿‡ç¨‹ä¸­ï¼Œå‘ç°slow pathå¯¹äºç³»ç»Ÿæ€§èƒ½å½±å“è¾ƒå¤§ï¼Œectd/raftä¸­ï¼Œlogæ˜¯ç”±wal + å†…å­˜å®ç°å­˜å‚¨çš„ï¼Œå…³é—­walä¹‹åï¼Œworkloadaå¯ä»¥ä» 5sç¼©çŸ­è‡³ 3så·¦å³ï¼Œé‚£ä¹ˆæ˜¯å¦æœ‰ä¸€ç§åŠæ³•åœ¨ä¸å­˜åœ¨å†²çªæ—¶å½»åº•ç»•è¿‡slow pathå‘¢ï¼Ÿ</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="next" href="https://fischer0522.github.io/en/posts/tech/curp/curp-exploiting-commutativity-for-practical-fast-replication/">
    <span class="title">Next Â»</span>
    <br>
    <span>01-CURP: å…±è¯†ç®—æ³•çš„é‡æ–°æ€è€ƒ</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 02-ä»0.5å®ç°CURP on x"
            href="https://x.com/intent/tweet/?text=02-%e4%bb%8e0.5%e5%ae%9e%e7%8e%b0CURP&amp;url=https%3a%2f%2ffischer0522.github.io%2fen%2fposts%2ftech%2fcurp%2f%25E4%25BB%258E0.5%25E5%2588%25B01%25E5%25AE%259E%25E7%258E%25B0curp%2f&amp;hashtags=">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 02-ä»0.5å®ç°CURP on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2ffischer0522.github.io%2fen%2fposts%2ftech%2fcurp%2f%25E4%25BB%258E0.5%25E5%2588%25B01%25E5%25AE%259E%25E7%258E%25B0curp%2f&amp;title=02-%e4%bb%8e0.5%e5%ae%9e%e7%8e%b0CURP&amp;summary=02-%e4%bb%8e0.5%e5%ae%9e%e7%8e%b0CURP&amp;source=https%3a%2f%2ffischer0522.github.io%2fen%2fposts%2ftech%2fcurp%2f%25E4%25BB%258E0.5%25E5%2588%25B01%25E5%25AE%259E%25E7%258E%25B0curp%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 02-ä»0.5å®ç°CURP on reddit"
            href="https://reddit.com/submit?url=https%3a%2f%2ffischer0522.github.io%2fen%2fposts%2ftech%2fcurp%2f%25E4%25BB%258E0.5%25E5%2588%25B01%25E5%25AE%259E%25E7%258E%25B0curp%2f&title=02-%e4%bb%8e0.5%e5%ae%9e%e7%8e%b0CURP">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 02-ä»0.5å®ç°CURP on facebook"
            href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2ffischer0522.github.io%2fen%2fposts%2ftech%2fcurp%2f%25E4%25BB%258E0.5%25E5%2588%25B01%25E5%25AE%259E%25E7%258E%25B0curp%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 02-ä»0.5å®ç°CURP on whatsapp"
            href="https://api.whatsapp.com/send?text=02-%e4%bb%8e0.5%e5%ae%9e%e7%8e%b0CURP%20-%20https%3a%2f%2ffischer0522.github.io%2fen%2fposts%2ftech%2fcurp%2f%25E4%25BB%258E0.5%25E5%2588%25B01%25E5%25AE%259E%25E7%258E%25B0curp%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 02-ä»0.5å®ç°CURP on telegram"
            href="https://telegram.me/share/url?text=02-%e4%bb%8e0.5%e5%ae%9e%e7%8e%b0CURP&amp;url=https%3a%2f%2ffischer0522.github.io%2fen%2fposts%2ftech%2fcurp%2f%25E4%25BB%258E0.5%25E5%2588%25B01%25E5%25AE%259E%25E7%258E%25B0curp%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 02-ä»0.5å®ç°CURP on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=02-%e4%bb%8e0.5%e5%ae%9e%e7%8e%b0CURP&u=https%3a%2f%2ffischer0522.github.io%2fen%2fposts%2ftech%2fcurp%2f%25E4%25BB%258E0.5%25E5%2588%25B01%25E5%25AE%259E%25E7%258E%25B0curp%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2025 <a href="https://fischer0522.github.io/en/">Fischer&#39;s Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
