<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>02-从0.5实现CURP | Fischer&#39;s Blog</title>
<meta name="keywords" content="">
<meta name="description" content="Intro 什么是CURP Curp是一种新的分布式共识算法，curp的提出是针对于跨域等高网络延迟场景，传统的raft和paxos等共识算法需要两个R">
<meta name="author" content="Fischer">
<link rel="canonical" href="https://fischer0522.github.io/en/posts/tech/curp/%E4%BB%8E0.5%E5%88%B01%E5%AE%9E%E7%8E%B0curp/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css" integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z&#43;V9&#43;cO1A=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://fischer0522.github.io/img/Navigation.svg">
<link rel="icon" type="image/png" sizes="16x16" href="https://fischer0522.github.io/img/Navigation.svg">
<link rel="icon" type="image/png" sizes="32x32" href="https://fischer0522.github.io/img/Navigation.svg">
<link rel="apple-touch-icon" href="https://fischer0522.github.io/Navigation.svg">
<link rel="mask-icon" href="https://fischer0522.github.io/Navigation.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="02-从0.5实现CURP" />
<meta property="og:description" content="Intro 什么是CURP Curp是一种新的分布式共识算法，curp的提出是针对于跨域等高网络延迟场景，传统的raft和paxos等共识算法需要两个R" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://fischer0522.github.io/en/posts/tech/curp/%E4%BB%8E0.5%E5%88%B01%E5%AE%9E%E7%8E%B0curp/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-06-03T09:31:59+00:00" />
<meta property="article:modified_time" content="2024-06-03T09:31:59+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="02-从0.5实现CURP"/>
<meta name="twitter:description" content="Intro 什么是CURP Curp是一种新的分布式共识算法，curp的提出是针对于跨域等高网络延迟场景，传统的raft和paxos等共识算法需要两个R"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Blog",
      "item": "https://fischer0522.github.io/en/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Tech",
      "item": "https://fischer0522.github.io/en/posts/tech/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "CURP",
      "item": "https://fischer0522.github.io/en/posts/tech/curp/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "02-从0.5实现CURP",
      "item": "https://fischer0522.github.io/en/posts/tech/curp/%E4%BB%8E0.5%E5%88%B01%E5%AE%9E%E7%8E%B0curp/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "02-从0.5实现CURP",
  "name": "02-从0.5实现CURP",
  "description": "Intro 什么是CURP Curp是一种新的分布式共识算法，curp的提出是针对于跨域等高网络延迟场景，传统的raft和paxos等共识算法需要两个R",
  "keywords": [
    
  ],
  "articleBody": "Intro 什么是CURP Curp是一种新的分布式共识算法，curp的提出是针对于跨域等高网络延迟场景，传统的raft和paxos等共识算法需要两个RTT，在高网络延迟的场景下，两个RTT对系统来说是难以忍受的，网络通信会成为系统的瓶颈。\n为了解决该问题，CURP期望在大多数情况下，通过一个RTT来完成，这主要基于两点背景：\n在请求中，各个请求之间通常是互不冲突的，例如 set a =1 和 set b = 2, 对于同一个key的重复性读写是比较少见的 系统并不需要对所有请求建立一个全局的顺序，相对的，只需要对于互相冲突的key建立起一个局部顺序即可 如果想进一步了解CURP，欢迎阅读笔者的另一篇文章： zhuanlan.zhihu.com/p/692464275 为什么是从 0.5 到 1 CURP是非侵入性的，即curp只是在原本的共识系统的基础上，提供一套额外的逻辑，来加速原本的共识算法，在curp原文中，选择的是使用primary-backup架构来作为基础，而在CURP作者在phD论文中，扩展了CURP，提出了CURP-Q，其构建于如Raft，Paxos等Leader-Follower共识算法上。\n而etcd/raft是目前工业界比较成熟的raft实现，其将raft抽象成状态机，非常地简单易用。同时，其实现了如check quorum, leader lease prevote 批处理，流水线发送了等优化，性能有基础保证。因此，在本文中，笔者选择了etcd/raft，充当CURP的slow path，再次基础上，构建了CURP。\nCURP Server ectd/raft以及如何与raft交互已经在上一章阐述，因此在这里将重点放在CURP Server的状态机上。CURP状态机的设计参考了 6.824 和 Xline。状态机负责接收网络请求，与client完成交互。随后将其发送给raft完成propose，同时CURP状态机还要维护一个kv store，存储已经commit的内容。\n状态机定义如下，主要包括：\nKVStore：存储已经commit的内容，这里选择了boltdb作为持久化实现 Witness：CURP的重要机制，在follower上运作，用于暂存未提交的请求以进行冲突检测，由于没有实现recovery，因此这里直接使用map存储 CommandBoard：记录目前接收到的请求，并在适当的时机响应Client结果 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 type StateMachine struct { NodeId int proposeC chan\u003c- string // channel for proposing updates mu sync.RWMutex // kvStore map[string]string // current committed key-value pairs KVStore *xkv.KVStore commandBoard *command.CommandBoard snapshotter *snap.Snapshotter raftState raft.StateType fastPath chan *curp_proto.CurpClientCommand slowPath chan *curp_proto.CurpClientCommand // both fast and slow path will execute commands,this set is used to avoid executing the same command twice commandSet map[command.ProposeId]struct{} witness witness.Witness stateChangeC chan raft.StateType } Witness Witness机制是CURP的核心，用于提供冲突检测功能，这里的实现非常简单，仅仅只使用map存储+Mutex并发控制，定义如下：\n1 2 3 4 type Witness struct { mu sync.Mutex commandMap map[string]map[command.ProposeId]*curp_proto.CurpClientCommand } 目前实现的冲突检测的策略非常简单，仅支持kv层面，即对于同一条key，写-写和读-写这两种情况是冲突的，在插入一条记录时，如果检测到冲突，那么就直接返回false，否则将其保存到map当中。\nWitness中的数据应当进行持久化保存，以用于在宕机后恢复数据，由于Witness中数据是暂存的，在commit之后就会删除，因此curp原文中提出了存储在NVM等硬件上会更合适。这里由于暂时没有实现recovery机制，所以目前是直接使用map存储。\nCommandBoard CmdBoard的作用为记录接收到的请求，等待请求执行完成，而具体的执行则交给 CommandWorker 来完成，前台接收请求的线程只需要通过CommandBoard来获取结果，并结果响应给客户端。不过由于CURP存在fast path和slow path的概念，因此会稍微复杂一些，定义如下：\n1 2 3 4 5 6 7 8 9 10 11 type CommandBoard struct { mu sync.Mutex // store all notifiers for execution results erNotifiers map[ProposeId]chan string // store all notifiers for after sync results asrNotifiers map[ProposeId]chan struct{} erBuffer map[ProposeId]string asrBuffer map[ProposeId]struct{} } er 为 execution result，asr 即为 async execution result，分别代表fast path和slow path的执行结果。 请求通过 ProposeId 来标识，ProposeId 为 ClientId 和 SeqId 的组合，以区分不同Client的不同请求：\n1 2 3 4 type ProposeId struct { ClientId uint64 SeqId uint64 } leader在通过fast path执行请求，在接收到请求后，会通过 WaitForEr() 来等待fast path的执行结果，在 WaitForEr() 中，涉及到erBuffer和erNotifiers。erBuffer用于缓存命令的执行结果，经fast path完成执行的内容都会存储到其中，而erNotifiers则存储一个channel，前台监听该channel，等待执行结果。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 func (c *CommandBoard) WaitForEr(id ProposeId) string { c.mu.Lock() if result, ok := c.erBuffer[id]; ok { c.mu.Unlock() return result } if _, ok := c.erNotifiers[id]; !ok { c.erNotifiers[id] = make(chan string, 1) } notifyChan := c.erNotifiers[id] c.mu.Unlock() result := \u003c-notifyChan c.erBuffer[id] = result return result } WaitForAsr 用于等待command在slow path中完成共识，返回执行的结果。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 func (c *CommandBoard) WaitForAsr(id ProposeId) string { c.mu.Lock() defer c.mu.Unlock() //trace.Trace(trace.Client, \"Wait Synced [clientId: %d,seqId: %d]\", id.ClientId, id.SeqId) _, asrOk := c.asrBuffer[id] result, erOk := c.erBuffer[id] defer delete(c.asrBuffer, id) defer delete(c.erBuffer, id) // command has already been executed in both fast path and slow path if asrOk \u0026\u0026 erOk { return result } if _, ok := c.asrNotifiers[id]; !ok { c.asrNotifiers[id] = make(chan struct{}, 1) } notifyChan := c.asrNotifiers[id] // release lock and wait c.mu.Unlock() \u003c-notifyChan c.mu.Lock() if result, ok := c.erBuffer[id]; ok { return result } // UNREACHABLE return \"NOT FOUND IN BUFFER\" } Why Buffer 在 6.824 中，执行结果通过一个channel即可传递，但是这里额外使用一个Buffer主要是用于兼容slow path，来保证线性一致性。er和asr都引入了buffer，二者需要分开讨论\n首先说明一下为什么需要 erBuffer 。设想这样一个场景：client1 先 cmd1 set a = 1，随后client 1 发送 cmd 2 get a，此时被witness检测到冲突，需等待slow path执行完毕，此时，client 1 又发送了 cmd 3 set a = 3，由于leader上Witness是关闭的，set a = 3 可以直接执行，这会导致cmd3 在cmd2 之前被执行，对于client而言，观测到的结果与发送顺序不一致。\n因此，cmd2 不能等待从slow path中commit才执行，而是应当在fast path中执行完成，保存结果，等到对应的日志commit之后，再将该结果返回给client。\n对于不同的client来说，即cmd1 cmd3 由client 1 发送，cmd2 由client 2 发送，此时cmd2 和cmd3 处于一种并发的状态，是允许以任意的结果完成执行的，但是如果只有一个client，则会违背线性一致性。\n而 AsrBuffer 主要是用于解决slow path的异步执行问题，如果后台raft commit的效率比较高，那么会导致在client调用WaitSynced之前就已经commit完毕，此时如果创建一个channel并监听，那么后续就会永远无法接收到结果。\n对于这个问题，有两个解决方案，一是遍历当前commit id前所有对应的channel，全部通知一遍，二就是添加一个缓存，可以通过先查询buffer来判断是否执行完成，如果没有，后续再通过channel监听结果。buffer当中只需要存储一个空struct{}，起到通知作用即可。个人认为第一种实现方式优雅一些，因此就引入了buffer。\nCommand Worker 与Command Board相对应的是Command Worker，Command Board记录请求，Worker负责具体的执行。\nCommand Worker中会分别从fast path和slow path中接收请求：\nleader在接收到请求之后，会直接将其通过fast path channel发送至cmd worker处，follower只进行witness不执行，因此不会从fast path中接收任何内容。leader执行完成之后就可以通过 InsertEr 将结果添加到Command Board当中，通知前台返回结果给client\nraft会将已经commit了的请求通过slow path发送至cmd worker。由于leader已经通过fast path执行过一次了，因此leader在这里应当忽略掉该请求，而follower应当执行来跟随leader的状态。 这一部分与传统raft最大的不同就是：leader会通过fast path进行“抢跑”，从而给系统引入了额外的复杂度：\nLeader通过fast path提前执行，修改了状态机，但是由于witness机制的存在，这个执行结果在commit之前是不会暴露给client的。\nLeader提前修改了状态机，那么slow path中的内容就无需再执行一遍，额外写一遍kv store的开销比较高。如果slow path会再执行一遍，虽然可能会导致fast path和slow path的内容相互覆盖，但是由于冲突检测的机制存在，相互覆盖的中间态不会对外暴露，因此执行一遍slow也不会影响正确性，等到commit后，状态机与只执行fast无异。Leader通过fast path已经完成了持久化，因此Leader也不会依赖raft log来完成recovery。\nFollower没有额外的动作，只需要witness判断冲突，并且通过slow path来跟随leader的状态即可。\n此外还有一个CommandSet，用于对命令进行去重，防止已经执行过一遍，但是没来及响应client，宕机，随后client又重试，导致命令被重复执行。在 6.824 的lab3 中，需要这样一个设计是因为其中的append命令是不幂等的，即会在原有value的基础上追加数据，而如果将命令设计成幂等的，就不需要这个CommandSet了，命令重复执行也不会产生负面影响。\nCommand Worker是单线程执行的，以确保线性一致性。但实际上，正如CURP本身的思想——全局顺序是不必要的，可以将全局顺序缩小范围到存在冲突的key之间维护一个顺序。在实现上可以维护多个worker，将存在冲突的key分配至同一个worker处，确保能够按照顺序来执行。不同worker之间由于不存在冲突，可以并行执行。\n此外，由于kvstore和commandSet只会在这里修改，加上其为单线程，因此这里完全可以不加锁执行，临界区仅仅只有判断当前节点状态\n这里的实现可以参考Xline，其中实现了一个非常完备的冲突检测队列 + worker：zhuanlan.zhihu.com/p/662504235\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 func (s *StateMachine) cmdWorker() { for { select { case cmd := \u003c-s.fastPath: trace.Trace(trace.Fast, s.NodeId, \"got cmd from fast path %v\", cmd) proposeId := command.ProposeId{ ClientId: cmd.ClientId, SeqId: cmd.SeqId, } if _, ok := s.commandSet[proposeId]; ok { // command executed before,nothing to do trace.Trace(trace.Fast, s.NodeId, \"cmd already executed %v\", cmd) } else { s.commandSet[proposeId] = struct{}{} result := s.execute(cmd) trace.Trace(trace.Fast, s.NodeId, \"cmd %v executed,result is %v\", cmd, result) s.commandBoard.InsertEr(proposeId, result) } case cmd := \u003c-s.slowPath: s.mu.Lock() isLeader := s.raftState == raft.StateLeader s.mu.Unlock() trace.Trace(trace.Slow, s.NodeId, \"got cmd from slow path %v\", cmd) if _, ok := s.commandSet[cmd.ProposeId()]; ok || isLeader { // command executed before,nothing to do trace.Trace(trace.Slow, s.NodeId, \"cmd already executed %v\", cmd) } else { s.commandSet[cmd.ProposeId()] = struct{}{} s.execute(cmd) } trace.Trace(trace.Slow, s.NodeId, \"WAIT Notify result in slow path,proposeId:[clientId: %d,seqId: %d]\", cmd.ClientId, cmd.SeqId) s.commandBoard.NotifyAsr(cmd.ProposeId()) trace.Trace(trace.Slow, s.NodeId, \"Notify result in slow path,proposeId:[clientId: %d,seqId: %d]\", cmd.ClientId, cmd.SeqId) // when command is committed, it can be remove from witness and command set safely s.removeRecord(cmd.ProposeId()) } } } // we don't need to lock this function,because it's the only func which modifies KVStore func (s *StateMachine) execute(cmd *curp_proto.CurpClientCommand) string { if cmd.Op == command.PUT { s.KVStore.Put(cmd.Key, cmd.Value) } else if cmd.Op == command.DELETE { s.KVStore.Delete(cmd.Key) } else if cmd.Op == command.GET { result, err := s.KVStore.Get(cmd.Key) if err != nil { return \"NOT FOUND IN STATE\" } else { return result } } // unreachable! return \"\" } Fast Path 在分析完Command Board和Command Worker之后，就可以串通CURP的fast path和slow path的全流程了。 fast path通过 Propose () 完成，无论读写请求都会被封装成一个ClientCommand，随后调用 Propose() ，流程如下：\n首先进行冲突检测，将请求添加到Witness当中，并且返回是否冲突 follower在fast path中只起到witness作用。如果当前节点非Leader，那么此时就可以返回了，响应CONFLICT或者ACCEPT 对于Leader后续应当直接继续执行，通过fast path的channel将cmd交给 cmd worker，并通过proposeC将cmd传递给raft 通过CommandBoard等待结果，响应给Client 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 func (s *StateMachine) Propose(cmd *curp_proto.CurpClientCommand) *curp_proto.CurpReply { isConflict := s.witness.InsertIfNotConflict(cmd) s.mu.Lock() if s.raftState == raft.StateLeader { trace.Trace(trace.Leader, s.NodeId, \"propose command %s,type: %s,conflict: %v\", cmd.Key, command.OpFmt[cmd.Op], isConflict) } else { trace.Trace(trace.Follower, s.NodeId, \"propose command %s,type: %s,conflict: %v\", cmd.Key, command.OpFmt[cmd.Op], isConflict) } reply := \u0026curp_proto.CurpReply{ Content: \"\", } if s.raftState != raft.StateLeader { if isConflict { s.mu.Unlock() reply.StatusCode = curp_proto.CONFLICT return reply } else { s.mu.Unlock() reply.StatusCode = curp_proto.ACCEPTED return reply } } buf := cmd.Encode() go func() { s.fastPath \u003c- cmd }() // command will update the state machine or get command is conflict trace.Trace(trace.Leader, s.NodeId, \"send propose[clientId:%d seqId: %d] msg to raft node\", cmd.ClientId, cmd.SeqId) go func() { s.proposeC \u003c- buf }() s.mu.Unlock() proposeId := command.ProposeId{ ClientId: cmd.ClientId, SeqId: cmd.SeqId, } result := s.commandBoard.WaitForEr(proposeId) reply.Content = result if isConflict { reply.StatusCode = curp_proto.CONFLICT } else { reply.StatusCode = curp_proto.ACCEPTED } return reply } 这里有一个细节，在CURP-Q的论文当中描述：Leader的witness应当是关闭的，即Leader并不进行冲突检测，对于所有请求都直接执行，但是在Xline的实现中，Leader是启动了Witness并进行冲突检测的。对于这个细节，个人认为并不会对并不会对系统正确性产生影响，暂时没有深究。\nWitnesses in leaders are inactive, and all client requests are serialized and logged in their command logs directly.\nSlow Path Slow Path的入口很简单，只需要调用 WaitForAsr() 来等待commit即可，通过 WaitSynced() 来实现\n1 2 3 4 5 6 7 8 9 10 11 func (s *StateMachine) WaitSynced(id command.ProposeId) *curp_proto.CurpReply { // only send wait synced message to leader trace.Trace(trace.Leader, s.NodeId, \"got wait synced message: %v\", id) result := s.commandBoard.WaitForAsr(id) reply := \u0026curp_proto.CurpReply{ Content: result, StatusCode: curp_proto.ACCEPTED, } trace.Trace(trace.Leader, s.NodeId, \"wait synced finished,id: %v,result: %v\", id, result) return reply } 在Fast Path中，Leader会通过proposeC发送给Raft，此时就相当于进入了Slow Path，在Raft中，完成共识的cmd会通过Ready返回，经RaftNode转手又通过commitC发送会了状态机，状态机收到之后，对cmd进行decode，随机通过slow path channel又将请求发送给了cmd worker\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 func (s *StateMachine) readCommits(commitC \u003c-chan *commit, errorC \u003c-chan error) { for commit := range commitC { if commit == nil { // signaled to load snapshot snapshot, err := s.loadSnapshot() if err != nil { log.Panic(err) } if snapshot != nil { log.Printf(\"loading snapshot at term %d and index %d\", snapshot.Metadata.Term, snapshot.Metadata.Index) if err := s.recoverFromSnapshot(snapshot.Data); err != nil { log.Panic(err) } } continue } for _, data := range commit.data { var cmd curp_proto.CurpClientCommand dec := gob.NewDecoder(bytes.NewBufferString(data)) if err := dec.Decode(\u0026cmd); err != nil { log.Fatalf(\"raftexample: could not decode message (%v)\", err) } s.slowPath \u003c- \u0026cmd } close(commit.applyDoneC) } if err, ok := \u003c-errorC; ok { log.Fatal(err) } } 之后就是cmd worker的逻辑了，在上面已经分析过了，这里简要整合一下。对于leader而言，直接忽略slow path中的内容，以免内容覆盖影响线性一致性。而对于follower而言，直接应用以跟随Leader。slow path执行完成，即可认定其为commit，此时可以通过 NotifyAsr 获取执行结果，并通知 WaitSynced 结束阻塞。\nCURP Client 对应地，在CURP Client端也分为了fast path和slow path，均通过grpc实现，此外，还需要一个isLeader来确定server中的leader，以确定应当向谁发送 WaitSynced()。\nFast path 在fast path中，client需要做的就是将请求广播给所有的server，然后监听统计结果：\n如果响应结果中存在冲突，那么就返回冲突，后续转向slow round 如果达到了superquorum (f个节点，对应为f + f / 2 + 1，即 4 节点需要 3 个，3 节点需要 3个 )，就返回请求成功 超时检测 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 func (c *GrpcClient) fastRound(cmd *curp_proto.CurpClientCommand, notifyC []chan *curp_proto.CurpReply) (*curp_proto.CurpReply, error) { timeout := time.NewTicker(time.Second * 5) fastPathChan := make(chan *curp_proto.CurpReply) for i := 0; i \u003c len(c.grpc_servers); i++ { go func(i int) { c.sendC[i] \u003c- cmd result := \u003c-notifyC[i] fastPathChan \u003c- result }(i) } acceptedCount := 0 result := \u0026curp_proto.CurpReply{ StatusCode: curp_proto.TIMEOUT, Content: \"\", } for { select { case fastResult := \u003c-fastPathChan: trace.Trace(trace.Client, -1, \"client receive fast path result: %v\", fastResult) if fastResult.StatusCode == curp_proto.ACCEPTED { acceptedCount++ if fastResult.Content != \"\" { result = fastResult } } else { return fastResult, nil } if acceptedCount == c.superQuorum() { return result, nil } case \u003c-timeout.C: fmt.Printf(\"timeout !!\\n\") return result, fmt.Errorf(\"fast path time out\") } } } slow path slow path比较简单，只需要将请求发送给Leader即可\n1 2 3 4 5 6 7 8 9 10 11 func (c *GrpcClient) slowRound(cmd *curp_proto.CurpClientCommand, notifyC []chan *curp_proto.CurpReply) (string, error) { sync_cmd := \u0026curp_proto.CurpClientCommand{ClientId: cmd.ClientId, SeqId: cmd.SeqId, Sync: 1} c.sendC[c.LeaderId] \u003c- sync_cmd reply := \u003c-notifyC[c.LeaderId] trace.Trace(trace.Client, -1, \"client wait synced finished, id: %v\", cmd.ProposeId) if reply.StatusCode == curp_proto.CONFLICT { return \"\", fmt.Errorf(\"command is still conflict after wait synced\") } return reply.Content, nil } 随后，将fast path和slow path做一个整合，封装成 Propose() ，在 Propose() 中：\n首先调用 fast_round() ，将请求进行广播，如果不存在冲突，那么就可以直接返回，代表此次请求在 1 个RTT内结束 如果 fast_round() 中存在冲突，那么再调用 slow_round()，通过 server对 Waitsynced() 来等待commit，解决冲突 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 func (c *GrpcClient) Propose(cmd *curp_proto.CurpClientCommand) (string, error) { ntfC := c.NewNotifyC(cmd.SeqId) defer c.DeleteNotifyC(cmd.SeqId) reply, err := c.fastRound(cmd, ntfC) if err != nil { return \"\", err } if reply.StatusCode == curp_proto.ACCEPTED { c.static.fast++ return reply.Content, nil } c.static.slow++ trace.Trace(trace.Client, -1, \"client receive conflict result, turn to slow path: %v\", reply) resultStr, err := c.slowRound(cmd, ntfC) return resultStr, err } 这里有一个小的优化，即可以同时发送fast round和slow round请求，这样可以更快地获取WaitSynced的结果。\nbenchmark 这里使用benchmark对curp的性能做了一个简单的测试，选择的是比较通用的go-ycsb，借用了一下go-ycsb的加载数据和统计结果的功能，然后自己通过tcp为curp实现了一个server，然后在ycsb中实现了一个client，这样就可以把请求从ycsb成功发送到curp了。\n这里实现的确实是比较草率，但是你就说能不能用吧😀\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 type GetResponse struct { Count int64 Kvs []*Command } func (r *GetResponse) Encode() []byte { buf := \u0026bytes.Buffer{} enc := gob.NewEncoder(buf) err := enc.Encode(r) if err != nil { fmt.Println(\"encode error:\", err) } return buf.Bytes() } const ( GET uint8 = iota PUT DELETE ) type Command struct { Op uint8 Key string Value string } func bench_server(port string, client *curp.GrpcClient) { listener, err := net.Listen(\"tcp\", port) if err != nil { fmt.Println(\"Error listening:\", err.Error()) os.Exit(1) } defer listener.Close() fmt.Printf(\"Server is listening on :%v\\n\", port) for { conn, err := listener.Accept() if err != nil { fmt.Println(\"Error accepting: \", err.Error()) os.Exit(1) } go handleRequest(conn, client) } } func handleRequest(conn net.Conn, client *curp.GrpcClient) { buf := make([]byte, 4096) n, _ := conn.Read(buf) aCmd := \u0026Command{} dec := gob.NewDecoder(bytes.NewReader(buf[:n])) err := dec.Decode(aCmd) if err != nil { fmt.Println(err) return } // fmt.Printf(\"Received: %+v\\n\", aCmd) if aCmd.Op == GET { // call client.get key := aCmd.Key // value := \"myValue\" value, _ := client.Get(aCmd.Key) cmd := Command{ Op: GET, Key: key, Value: value, } cmds := []*Command{\u0026cmd} resp := GetResponse{ Count: 1, Kvs: cmds, } buf := resp.Encode() conn.Write(buf) } else if aCmd.Op == PUT { // call client.put client.Put(aCmd.Key, aCmd.Value) conn.Write([]byte(\"Received PUT Response!\")) } else if aCmd.Op == DELETE { // call client.delete client.Del(aCmd.Key) conn.Write([]byte(\"Received DELETE Response!\")) } } 跑了一个简单的benchmark，由于没有实现scan操作，因此就只选择了ycsb中的workload a-b-c，其中workloada为 50%read 50%write，workloadb为 95%read 5% write，workloadc 100% read,。\n可以看到无论是哪个workload，curp的性能均好于raft，对于a，大约是个 20-30%的提升，b, c由于主要是读请求为主，curp中只需要一轮rtt加查询状态机即可，而raft需要走一遍日志复制+查询状态机，因此差距被进一步拉大（这里二者都没有开启线性一致性读优化的，即lease read或read index）\n这个benchmark是在单机上跑的，如果真正到了跨域的高网络延迟的场景下，差距会被进一步的拉大\ncurp raft workload a 5.2s 6.7s workload b 1.2s 4.4s wrokload c 0.6s 4.1s\ngo-ycsb的详细结果如下：\nCURP\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 workloada READ - Takes(s): 5.2, Count: 488, OPS: 94.2, Avg(us): 600, Min(us): 433, Max(us): 25103, 50th(us): 534, 90th(us): 612, 95th(us): 652, 99th(us): 948, 99.9th(us): 25103, 99.99th(us): 25103 TOTAL - Takes(s): 5.2, Count: 1000, OPS: 192.8, Avg(us): 5185, Min(us): 433, Max(us): 52991, 50th(us): 6859, 90th(us): 11503, 95th(us): 12847, 99th(us): 16559, 99.9th(us): 27471, 99.99th(us): 52991 UPDATE - Takes(s): 5.2, Count: 512, OPS: 98.7, Avg(us): 9556, Min(us): 5396, Max(us): 52991, 50th(us): 8703, 90th(us): 12823, 95th(us): 14599, 99th(us): 18991, 99.9th(us): 27471, 99.99th(us): 52991 workloadb Run finished, takes 1.198906187s READ - Takes(s): 1.2, Count: 950, OPS: 793.1, Avg(us): 567, Min(us): 304, Max(us): 43807, 50th(us): 507, 90th(us): 582, 95th(us): 640, 99th(us): 1156, 99.9th(us): 1788, 99.99th(us): 43807 TOTAL - Takes(s): 1.2, Count: 1000, OPS: 834.4, Avg(us): 1192, Min(us): 304, Max(us): 43807, 50th(us): 511, 90th(us): 631, 95th(us): 6403, 99th(us): 15151, 99.9th(us): 20879, 99.99th(us): 43807 UPDATE - Takes(s): 1.1, Count: 50, OPS: 43.9, Avg(us): 13067, Min(us): 6400, Max(us): 20879, 50th(us): 13175, 90th(us): 15527, 95th(us): 16767, 99th(us): 20879, 99.9th(us): 20879, 99.99th(us): 20879 workloadc Run finished, takes 596.022766ms READ - Takes(s): 0.6, Count: 1000, OPS: 1680.6, Avg(us): 590, Min(us): 313, Max(us): 60863, 50th(us): 511, 90th(us): 614, 95th(us): 682, 99th(us): 1099, 99.9th(us): 1634, 99.99th(us): 60863 TOTAL - Takes(s): 0.6, Count: 1000, OPS: 1680.0, Avg(us): 590, Min(us): 313, Max(us): 60863, 50th(us): 511, 90th(us): 614, 95th(us): 682, 99th(us): 1099, 99.9th(us): 1634, 99.99th(us): 60863 Raft\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 workloada Run finished, takes 6.741194029s READ - Takes(s): 6.7, Count: 490, OPS: 72.8, Avg(us): 4182, Min(us): 3188, Max(us): 25279, 50th(us): 3571, 90th(us): 4787, 95th(us): 7699, 99th(us): 12015, 99.9th(us): 25279, 99.99th(us): 25279 TOTAL - Takes(s): 6.7, Count: 1000, OPS: 148.7, Avg(us): 6733, Min(us): 3188, Max(us): 42047, 50th(us): 7979, 90th(us): 9599, 95th(us): 12111, 99th(us): 17407, 99.9th(us): 25279, 99.99th(us): 42047 UPDATE - Takes(s): 6.7, Count: 510, OPS: 76.0, Avg(us): 9183, Min(us): 6908, Max(us): 42047, 50th(us): 8295, 90th(us): 11175, 95th(us): 15455, 99th(us): 18591, 99.9th(us): 20079, 99.99th(us): 42047 workloadb Run finished, takes 4.386455138s READ - Takes(s): 4.4, Count: 952, OPS: 217.6, Avg(us): 4152, Min(us): 3196, Max(us): 27407, 50th(us): 3553, 90th(us): 5947, 95th(us): 10591, 99th(us): 11487, 99.9th(us): 18127, 99.99th(us): 27407 TOTAL - Takes(s): 4.4, Count: 1000, OPS: 228.6, Avg(us): 4380, Min(us): 3196, Max(us): 27407, 50th(us): 3559, 90th(us): 7479, 95th(us): 10799, 99th(us): 11599, 99.9th(us): 18127, 99.99th(us): 27407 UPDATE - Takes(s): 4.3, Count: 48, OPS: 11.1, Avg(us): 8898, Min(us): 7096, Max(us): 15031, 50th(us): 8271, 90th(us): 10735, 95th(us): 14975, 99th(us): 15031, 99.9th(us): 15031, 99.99th(us): 15031 workloadc Run finished, takes 4.143589849s READ - Takes(s): 4.1, Count: 1000, OPS: 242.1, Avg(us): 4138, Min(us): 3272, Max(us): 44351, 50th(us): 3575, 90th(us): 5939, 95th(us): 7511, 99th(us): 11207, 99.9th(us): 13191, 99.99th(us): 44351 TOTAL - Takes(s): 4.1, Count: 1000, OPS: 242.1, Avg(us): 4138, Min(us): 3272, Max(us): 44351, 50th(us): 3575, 90th(us): 5939, 95th(us): 7511, 99th(us): 11207, 99.9th(us): 13191, 99.99th(us): 44351 TODO 目前的CURP只实现了基础的运行，并没有考虑crash-recovery，这对于一个共识来说显然是不足的，不过碍于时间和精力，短时间笔者是无法补全这一部分了，在这里简单说一下思路。\nVersion 首先，对于挂掉和回复的节点，整个集群应当能够感知，论文中中给出的方案是维护一个集群列表+version，client首次从配置中心处持有该列表和version，之后每次请求是携带上version，随后配置中心接收到请求后会校验version，来判断client持有的配置是否过期, 如果过期就拒绝掉此次请求，并告知Client\n在实现上，配置中心可以实现在Leader上，Client在调用 isLeader () 确定集群Leader时顺便获取到version和配置，并在client端维护，随后扩展一下protobuf的结构体，每次请求携带上version。server端，server端在从raft处检测到身份变更时，就应当由新的leader去生成一份新的配置+version。将其返回给client\n1 2 3 4 5 6 7 8 9 10 func (s *StateMachine) listenRaftState() { for state := range s.stateChangeC { s.mu.Lock() trace.Trace(trace.Vote, s.NodeId, \"raft state update: before: %s,current: %s\", stmap[s.raftState], stmap[state]) // 如果是Leader，那么就生成新配置 s.raftState = state s.mu.Unlock() } } Witness 由于Leader进行了抢跑，因此会有一些请求还未commit，但也已经返回给client了，这些请求的结果，或者说这些请求对状态机的影响暂时不会暴露出来（后续如果想要获取结果，或者说对其修改，都会因冲突而被拒绝）但是请求成功也确实是实打实的响应给client了。因此这一部分的请求结果不能丢失，但是又没有通过log发送给follower，因此就需要通过Witness中的存储来完成恢复。\n具体来说，需要添加一条rpc，使得新的Leader能够获取到follower的witness中的数据，然后再leader处按照顺序执行并写入log。从而解决冲突并确定顺序。当log commit时，即可自动删除掉witness中的内容。\nSummary 本文基于etcd/raft，实现了一个简易的CURP，提供了fast path + slow path的逻辑，使得不冲突的请求可以在一个RTT完成。目前还欠缺recovery的逻辑，但临近毕业，笔者精力实在有限，短时间内应该是没有精力去补完了。如果想学习工业级CURP的实现，可以去看Xline：GitHub - xline-kv/Xline: A geo-distributed KV store for metadata management\n目前的curp和组里的一个项目代码混在一起，不太方便全部开源，等后续有空了给分离出来扔到github上。\n对于CURP而言，虽然其在性能上领先Raft不少，但是在笔者测试的过程中，发现slow path对于系统性能影响较大，ectd/raft中，log是由wal + 内存实现存储的，关闭wal之后，workloada可以从 5s缩短至 3s左右，那么是否有一种办法在不存在冲突时彻底绕过slow path呢？\n",
  "wordCount" : "8743",
  "inLanguage": "en",
  "datePublished": "2024-06-03T09:31:59Z",
  "dateModified": "2024-06-03T09:31:59Z",
  "author":{
    "@type": "Person",
    "name": "Fischer"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://fischer0522.github.io/en/posts/tech/curp/%E4%BB%8E0.5%E5%88%B01%E5%AE%9E%E7%8E%B0curp/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Fischer's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://fischer0522.github.io/img/Navigation.svg"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://fischer0522.github.io/en/" accesskey="h" title="Fischer&#39;s Blog (Alt + H)">
                <img src="https://fischer0522.github.io/img/Navigation.svg" alt="" aria-label="logo"
                    height="35">Fischer&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://fischer0522.github.io/en/search" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://fischer0522.github.io/en/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://fischer0522.github.io/en/posts" title="Posts">
                    <span>Posts</span>
                </a>
            </li>
            <li>
                <a href="https://fischer0522.github.io/en/archives/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="https://fischer0522.github.io/en/tags" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://fischer0522.github.io/en/about" title="About">
                    <span>About</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://fischer0522.github.io/en/">Home</a>&nbsp;»&nbsp;<a href="https://fischer0522.github.io/en/posts/">Blog</a>&nbsp;»&nbsp;<a href="https://fischer0522.github.io/en/posts/tech/">Tech</a>&nbsp;»&nbsp;<a href="https://fischer0522.github.io/en/posts/tech/curp/">CURP</a></div>
    <h1 class="post-title entry-hint-parent">
      02-从0.5实现CURP
    </h1>
    <div class="post-meta"><span title='2024-06-03 09:31:59 +0000 UTC'>2024-06-03</span>&nbsp;·&nbsp;18 min&nbsp;·&nbsp;Fischer

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#intro" aria-label="Intro">Intro</a><ul>
                        
                <li>
                    <a href="#%e4%bb%80%e4%b9%88%e6%98%afcurp" aria-label="什么是CURP">什么是CURP</a></li>
                <li>
                    <a href="#%e4%b8%ba%e4%bb%80%e4%b9%88%e6%98%af%e4%bb%8e-05-%e5%88%b0-1" aria-label="为什么是从 0.5 到 1">为什么是从 0.5 到 1</a></li></ul>
                </li>
                <li>
                    <a href="#curp-server" aria-label="CURP Server">CURP Server</a><ul>
                        
                <li>
                    <a href="#witness" aria-label="Witness">Witness</a></li>
                <li>
                    <a href="#commandboard" aria-label="CommandBoard">CommandBoard</a><ul>
                        
                <li>
                    <a href="#why-buffer" aria-label="Why Buffer">Why Buffer</a></li></ul>
                </li>
                <li>
                    <a href="#command-worker" aria-label="Command Worker">Command Worker</a></li>
                <li>
                    <a href="#fast-path" aria-label="Fast Path">Fast Path</a></li>
                <li>
                    <a href="#slow-path" aria-label="Slow Path">Slow Path</a></li></ul>
                </li>
                <li>
                    <a href="#curp-client" aria-label="CURP Client">CURP Client</a><ul>
                        
                <li>
                    <a href="#fast-path-1" aria-label="Fast path">Fast path</a></li>
                <li>
                    <a href="#slow-path-1" aria-label="slow path">slow path</a></li></ul>
                </li>
                <li>
                    <a href="#benchmark" aria-label="benchmark">benchmark</a></li>
                <li>
                    <a href="#todo" aria-label="TODO">TODO</a><ul>
                        
                <li>
                    <a href="#version" aria-label="Version">Version</a></li>
                <li>
                    <a href="#witness-1" aria-label="Witness">Witness</a></li></ul>
                </li>
                <li>
                    <a href="#summary" aria-label="Summary">Summary</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="intro">Intro<a hidden class="anchor" aria-hidden="true" href="#intro">#</a></h2>
<h3 id="什么是curp">什么是CURP<a hidden class="anchor" aria-hidden="true" href="#什么是curp">#</a></h3>
<p>Curp是一种新的分布式共识算法，curp的提出是针对于跨域等高网络延迟场景，传统的raft和paxos等共识算法需要两个RTT，在高网络延迟的场景下，两个RTT对系统来说是难以忍受的，网络通信会成为系统的瓶颈。</p>
<p>为了解决该问题，CURP期望在大多数情况下，通过一个RTT来完成，这主要基于两点背景：</p>
<ul>
<li>在请求中，各个请求之间通常是互不冲突的，例如 set a =1 和 set b = 2, 对于同一个key的重复性读写是比较少见的</li>
<li>系统并不需要对所有请求建立一个全局的顺序，相对的，只需要对于互相冲突的key建立起一个局部顺序即可
如果想进一步了解CURP，欢迎阅读笔者的另一篇文章：
<a href="https://zhuanlan.zhihu.com/p/692464275">zhuanlan.zhihu.com/p/692464275</a></li>
</ul>
<h3 id="为什么是从-05-到-1">为什么是从 0.5 到 1<a hidden class="anchor" aria-hidden="true" href="#为什么是从-05-到-1">#</a></h3>
<p>CURP是非侵入性的，即curp只是在原本的共识系统的基础上，提供一套额外的逻辑，来加速原本的共识算法，在curp原文中，选择的是使用primary-backup架构来作为基础，而在CURP作者在phD论文中，扩展了CURP，提出了CURP-Q，其构建于如Raft，Paxos等Leader-Follower共识算法上。</p>
<p>而etcd/raft是目前工业界比较成熟的raft实现，其将raft抽象成状态机，非常地简单易用。同时，其实现了如check quorum, leader lease prevote 批处理，流水线发送了等优化，性能有基础保证。因此，在本文中，笔者选择了etcd/raft，充当CURP的slow path，再次基础上，构建了CURP。</p>
<h2 id="curp-server">CURP Server<a hidden class="anchor" aria-hidden="true" href="#curp-server">#</a></h2>
<p>ectd/raft以及如何与raft交互已经在上一章阐述，因此在这里将重点放在CURP Server的状态机上。CURP状态机的设计参考了 6.824 和 Xline。状态机负责接收网络请求，与client完成交互。随后将其发送给raft完成propose，同时CURP状态机还要维护一个kv store，存储已经commit的内容。</p>
<p>状态机定义如下，主要包括：</p>
<ul>
<li>KVStore：存储已经commit的内容，这里选择了boltdb作为持久化实现</li>
<li>Witness：CURP的重要机制，在follower上运作，用于暂存未提交的请求以进行冲突检测，由于没有实现recovery，因此这里直接使用map存储</li>
<li>CommandBoard：记录目前接收到的请求，并在适当的时机响应Client结果</li>
</ul>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">StateMachine</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">NodeId</span>   <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">proposeC</span> <span style="color:#66d9ef">chan</span><span style="color:#f92672">&lt;-</span> <span style="color:#66d9ef">string</span> <span style="color:#75715e">// channel for proposing updates
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">mu</span>       <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">RWMutex</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// kvStore      map[string]string // current committed key-value pairs
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">KVStore</span>      <span style="color:#f92672">*</span><span style="color:#a6e22e">xkv</span>.<span style="color:#a6e22e">KVStore</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">commandBoard</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">command</span>.<span style="color:#a6e22e">CommandBoard</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">snapshotter</span>  <span style="color:#f92672">*</span><span style="color:#a6e22e">snap</span>.<span style="color:#a6e22e">Snapshotter</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">raftState</span>    <span style="color:#a6e22e">raft</span>.<span style="color:#a6e22e">StateType</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fastPath</span>     <span style="color:#66d9ef">chan</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">curp_proto</span>.<span style="color:#a6e22e">CurpClientCommand</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">slowPath</span>     <span style="color:#66d9ef">chan</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">curp_proto</span>.<span style="color:#a6e22e">CurpClientCommand</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// both fast and slow path will execute commands,this set is used to avoid executing the same command twice
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">commandSet</span>   <span style="color:#66d9ef">map</span>[<span style="color:#a6e22e">command</span>.<span style="color:#a6e22e">ProposeId</span>]<span style="color:#66d9ef">struct</span>{}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">witness</span>      <span style="color:#a6e22e">witness</span>.<span style="color:#a6e22e">Witness</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">stateChangeC</span> <span style="color:#66d9ef">chan</span> <span style="color:#a6e22e">raft</span>.<span style="color:#a6e22e">StateType</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="witness">Witness<a hidden class="anchor" aria-hidden="true" href="#witness">#</a></h3>
<p>Witness机制是CURP的核心，用于提供冲突检测功能，这里的实现非常简单，仅仅只使用map存储+Mutex并发控制，定义如下：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Witness</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">mu</span>         <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Mutex</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">commandMap</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">map</span>[<span style="color:#a6e22e">command</span>.<span style="color:#a6e22e">ProposeId</span>]<span style="color:#f92672">*</span><span style="color:#a6e22e">curp_proto</span>.<span style="color:#a6e22e">CurpClientCommand</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>目前实现的冲突检测的策略非常简单，仅支持kv层面，即对于同一条key，写-写和读-写这两种情况是冲突的，在插入一条记录时，如果检测到冲突，那么就直接返回false，否则将其保存到map当中。</p>
<p>Witness中的数据应当进行持久化保存，以用于在宕机后恢复数据，由于Witness中数据是暂存的，在commit之后就会删除，因此curp原文中提出了存储在NVM等硬件上会更合适。这里由于暂时没有实现recovery机制，所以目前是直接使用map存储。</p>
<h3 id="commandboard">CommandBoard<a hidden class="anchor" aria-hidden="true" href="#commandboard">#</a></h3>
<p>CmdBoard的作用为记录接收到的请求，等待请求执行完成，而具体的执行则交给 <code>CommandWorker</code> 来完成，前台接收请求的线程只需要通过CommandBoard来获取结果，并结果响应给客户端。不过由于CURP存在fast path和slow path的概念，因此会稍微复杂一些，定义如下：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">CommandBoard</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">mu</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Mutex</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// store all notifiers for execution results
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">erNotifiers</span> <span style="color:#66d9ef">map</span>[<span style="color:#a6e22e">ProposeId</span>]<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// store all notifiers for after sync results
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">asrNotifiers</span> <span style="color:#66d9ef">map</span>[<span style="color:#a6e22e">ProposeId</span>]<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">struct</span>{}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">erBuffer</span> <span style="color:#66d9ef">map</span>[<span style="color:#a6e22e">ProposeId</span>]<span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">asrBuffer</span> <span style="color:#66d9ef">map</span>[<span style="color:#a6e22e">ProposeId</span>]<span style="color:#66d9ef">struct</span>{}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>er</code> 为 <code>execution result</code>，<code>asr</code> 即为 <code>async execution result</code>，分别代表fast path和slow path的执行结果。
请求通过 <code>ProposeId</code> 来标识，<code>ProposeId</code> 为 <code>ClientId</code> 和 <code>SeqId</code> 的组合，以区分不同Client的不同请求：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ProposeId</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">ClientId</span> <span style="color:#66d9ef">uint64</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">SeqId</span>    <span style="color:#66d9ef">uint64</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>leader在通过fast path执行请求，在接收到请求后，会通过 <code>WaitForEr()</code> 来等待fast path的执行结果，在 <code>WaitForEr()</code> 中，涉及到erBuffer和erNotifiers。erBuffer用于缓存命令的执行结果，经fast path完成执行的内容都会存储到其中，而erNotifiers则存储一个channel，前台监听该channel，等待执行结果。</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">CommandBoard</span>) <span style="color:#a6e22e">WaitForEr</span>(<span style="color:#a6e22e">id</span> <span style="color:#a6e22e">ProposeId</span>) <span style="color:#66d9ef">string</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Lock</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">result</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">erBuffer</span>[<span style="color:#a6e22e">id</span>]; <span style="color:#a6e22e">ok</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">result</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">erNotifiers</span>[<span style="color:#a6e22e">id</span>]; !<span style="color:#a6e22e">ok</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">erNotifiers</span>[<span style="color:#a6e22e">id</span>] = make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">string</span>, <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">notifyChan</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">erNotifiers</span>[<span style="color:#a6e22e">id</span>]
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">result</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">notifyChan</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">erBuffer</span>[<span style="color:#a6e22e">id</span>] = <span style="color:#a6e22e">result</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">result</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>WaitForAsr</code> 用于等待command在slow path中完成共识，返回执行的结果。</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">CommandBoard</span>) <span style="color:#a6e22e">WaitForAsr</span>(<span style="color:#a6e22e">id</span> <span style="color:#a6e22e">ProposeId</span>) <span style="color:#66d9ef">string</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Lock</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//trace.Trace(trace.Client, &#34;Wait Synced [clientId: %d,seqId: %d]&#34;, id.ClientId, id.SeqId)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">asrOk</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">asrBuffer</span>[<span style="color:#a6e22e">id</span>]
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">result</span>, <span style="color:#a6e22e">erOk</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">erBuffer</span>[<span style="color:#a6e22e">id</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> delete(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">asrBuffer</span>, <span style="color:#a6e22e">id</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> delete(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">erBuffer</span>, <span style="color:#a6e22e">id</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// command has already been executed in both fast path and slow path
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">asrOk</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">erOk</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">result</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">asrNotifiers</span>[<span style="color:#a6e22e">id</span>]; !<span style="color:#a6e22e">ok</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">asrNotifiers</span>[<span style="color:#a6e22e">id</span>] = make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">struct</span>{}, <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">notifyChan</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">asrNotifiers</span>[<span style="color:#a6e22e">id</span>]
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// release lock and wait
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">notifyChan</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Lock</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">result</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">erBuffer</span>[<span style="color:#a6e22e">id</span>]; <span style="color:#a6e22e">ok</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">result</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// UNREACHABLE
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;NOT FOUND IN BUFFER&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="why-buffer">Why Buffer<a hidden class="anchor" aria-hidden="true" href="#why-buffer">#</a></h4>
<p>在 6.824 中，执行结果通过一个channel即可传递，但是这里额外使用一个Buffer主要是用于兼容slow path，来保证线性一致性。er和asr都引入了buffer，二者需要分开讨论</p>
<p>首先说明一下为什么需要 <code>erBuffer</code> 。设想这样一个场景：client1 先 cmd1 <code>set a = 1</code>，随后client 1 发送 cmd 2 <code>get a</code>，此时被witness检测到冲突，需等待slow path执行完毕，此时，client 1 又发送了 cmd 3 <code>set a = 3</code>，由于leader上Witness是关闭的，set a = 3 可以直接执行，这会导致cmd3 在cmd2 之前被执行，对于client而言，观测到的结果与发送顺序不一致。</p>
<p><img loading="lazy" src="https://pic-bed-1309931445.cos.ap-nanjing.myqcloud.com/blog/20240607003628.png" alt="image.png"  />
</p>
<p>因此，cmd2 不能等待从slow path中commit才执行，而是应当在fast path中执行完成，保存结果，等到对应的日志commit之后，再将该结果返回给client。</p>
<p>对于不同的client来说，即cmd1 cmd3 由client 1 发送，cmd2 由client 2 发送，此时cmd2 和cmd3 处于一种并发的状态，是允许以任意的结果完成执行的，但是如果只有一个client，则会违背线性一致性。</p>
<p>而 <code>AsrBuffer</code> 主要是用于解决slow path的异步执行问题，如果后台raft commit的效率比较高，那么会导致在client调用WaitSynced之前就已经commit完毕，此时如果创建一个channel并监听，那么后续就会永远无法接收到结果。</p>
<p>对于这个问题，有两个解决方案，一是遍历当前commit id前所有对应的channel，全部通知一遍，二就是添加一个缓存，可以通过先查询buffer来判断是否执行完成，如果没有，后续再通过channel监听结果。buffer当中只需要存储一个空struct{}，起到通知作用即可。个人认为第一种实现方式优雅一些，因此就引入了buffer。</p>
<h3 id="command-worker">Command Worker<a hidden class="anchor" aria-hidden="true" href="#command-worker">#</a></h3>
<p>与Command Board相对应的是Command Worker，Command Board记录请求，Worker负责具体的执行。</p>
<p>Command Worker中会分别从fast path和slow path中接收请求：</p>
<ul>
<li>
<p>leader在接收到请求之后，会直接将其通过fast path channel发送至cmd worker处，follower只进行witness不执行，因此不会从fast path中接收任何内容。leader执行完成之后就可以通过 <code>InsertEr</code> 将结果添加到Command Board当中，通知前台返回结果给client</p>
</li>
<li>
<p>raft会将已经commit了的请求通过slow path发送至cmd worker。由于leader已经通过fast path执行过一次了，因此leader在这里应当忽略掉该请求，而follower应当执行来跟随leader的状态。
这一部分与传统raft最大的不同就是：leader会通过fast path进行“抢跑”，从而给系统引入了额外的复杂度：</p>
</li>
<li>
<p>Leader通过fast path提前执行，修改了状态机，但是由于witness机制的存在，这个执行结果在commit之前是不会暴露给client的。</p>
</li>
<li>
<p>Leader提前修改了状态机，那么slow path中的内容就无需再执行一遍，额外写一遍kv store的开销比较高。如果slow path会再执行一遍，虽然可能会导致fast path和slow path的内容相互覆盖，但是由于冲突检测的机制存在，相互覆盖的中间态不会对外暴露，因此执行一遍slow也不会影响正确性，等到commit后，状态机与只执行fast无异。Leader通过fast path已经完成了持久化，因此Leader也不会依赖raft log来完成recovery。</p>
</li>
<li>
<p>Follower没有额外的动作，只需要witness判断冲突，并且通过slow path来跟随leader的状态即可。</p>
</li>
</ul>
<p>此外还有一个CommandSet，用于对命令进行去重，防止已经执行过一遍，但是没来及响应client，宕机，随后client又重试，导致命令被重复执行。在 6.824 的lab3 中，需要这样一个设计是因为其中的append命令是不幂等的，即会在原有value的基础上追加数据，而如果将命令设计成幂等的，就不需要这个CommandSet了，命令重复执行也不会产生负面影响。</p>
<p>Command Worker是单线程执行的，以确保线性一致性。但实际上，正如CURP本身的思想——全局顺序是不必要的，可以将全局顺序缩小范围到存在冲突的key之间维护一个顺序。在实现上可以维护多个worker，将存在冲突的key分配至同一个worker处，确保能够按照顺序来执行。不同worker之间由于不存在冲突，可以并行执行。</p>
<p>此外，由于kvstore和commandSet只会在这里修改，加上其为单线程，因此这里完全可以不加锁执行，临界区仅仅只有判断当前节点状态</p>
<p>这里的实现可以参考Xline，其中实现了一个非常完备的冲突检测队列 + worker：<a href="https://zhuanlan.zhihu.com/p/662504235">zhuanlan.zhihu.com/p/662504235</a></p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">StateMachine</span>) <span style="color:#a6e22e">cmdWorker</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">select</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">cmd</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">fastPath</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Trace</span>(<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Fast</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">NodeId</span>, <span style="color:#e6db74">&#34;got cmd from fast path %v&#34;</span>, <span style="color:#a6e22e">cmd</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">proposeId</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">command</span>.<span style="color:#a6e22e">ProposeId</span>{
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">ClientId</span>: <span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">ClientId</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">SeqId</span>:    <span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">SeqId</span>,
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">commandSet</span>[<span style="color:#a6e22e">proposeId</span>]; <span style="color:#a6e22e">ok</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// command executed before,nothing to do
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Trace</span>(<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Fast</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">NodeId</span>, <span style="color:#e6db74">&#34;cmd already executed %v&#34;</span>, <span style="color:#a6e22e">cmd</span>)
</span></span><span style="display:flex;"><span>			} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">commandSet</span>[<span style="color:#a6e22e">proposeId</span>] = <span style="color:#66d9ef">struct</span>{}{}
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">result</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">execute</span>(<span style="color:#a6e22e">cmd</span>)
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Trace</span>(<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Fast</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">NodeId</span>, <span style="color:#e6db74">&#34;cmd %v executed,result is %v&#34;</span>, <span style="color:#a6e22e">cmd</span>, <span style="color:#a6e22e">result</span>)
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">commandBoard</span>.<span style="color:#a6e22e">InsertEr</span>(<span style="color:#a6e22e">proposeId</span>, <span style="color:#a6e22e">result</span>)
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">cmd</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">slowPath</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Lock</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">isLeader</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">raftState</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">raft</span>.<span style="color:#a6e22e">StateLeader</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Trace</span>(<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Slow</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">NodeId</span>, <span style="color:#e6db74">&#34;got cmd from slow path %v&#34;</span>, <span style="color:#a6e22e">cmd</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">commandSet</span>[<span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">ProposeId</span>()]; <span style="color:#a6e22e">ok</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">isLeader</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// command executed before,nothing to do
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Trace</span>(<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Slow</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">NodeId</span>, <span style="color:#e6db74">&#34;cmd already executed %v&#34;</span>, <span style="color:#a6e22e">cmd</span>)
</span></span><span style="display:flex;"><span>			} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">commandSet</span>[<span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">ProposeId</span>()] = <span style="color:#66d9ef">struct</span>{}{}
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">execute</span>(<span style="color:#a6e22e">cmd</span>)
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Trace</span>(<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Slow</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">NodeId</span>, <span style="color:#e6db74">&#34;WAIT Notify result in slow path,proposeId:[clientId: %d,seqId: %d]&#34;</span>, <span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">ClientId</span>, <span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">SeqId</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">commandBoard</span>.<span style="color:#a6e22e">NotifyAsr</span>(<span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">ProposeId</span>())
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Trace</span>(<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Slow</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">NodeId</span>, <span style="color:#e6db74">&#34;Notify result in slow path,proposeId:[clientId: %d,seqId: %d]&#34;</span>, <span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">ClientId</span>, <span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">SeqId</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// when command is committed, it can be remove from witness and command set safely
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">removeRecord</span>(<span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">ProposeId</span>())
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// we don&#39;t need to lock this function,because it&#39;s the only func which modifies KVStore
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">StateMachine</span>) <span style="color:#a6e22e">execute</span>(<span style="color:#a6e22e">cmd</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">curp_proto</span>.<span style="color:#a6e22e">CurpClientCommand</span>) <span style="color:#66d9ef">string</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Op</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">command</span>.<span style="color:#a6e22e">PUT</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">KVStore</span>.<span style="color:#a6e22e">Put</span>(<span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Key</span>, <span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Value</span>)
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Op</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">command</span>.<span style="color:#a6e22e">DELETE</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">KVStore</span>.<span style="color:#a6e22e">Delete</span>(<span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Key</span>)
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Op</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">command</span>.<span style="color:#a6e22e">GET</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">result</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">KVStore</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Key</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;NOT FOUND IN STATE&#34;</span>
</span></span><span style="display:flex;"><span>		} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">result</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// unreachable!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="fast-path">Fast Path<a hidden class="anchor" aria-hidden="true" href="#fast-path">#</a></h3>
<p>在分析完Command Board和Command Worker之后，就可以串通CURP的fast path和slow path的全流程了。
fast path通过 <code>Propose ()</code> 完成，无论读写请求都会被封装成一个ClientCommand，随后调用 <code>Propose()</code> ，流程如下：</p>
<ol>
<li>首先进行冲突检测，将请求添加到Witness当中，并且返回是否冲突</li>
<li>follower在fast path中只起到witness作用。如果当前节点非Leader，那么此时就可以返回了，响应CONFLICT或者ACCEPT</li>
<li>对于Leader后续应当直接继续执行，通过fast path的channel将cmd交给 cmd worker，并通过proposeC将cmd传递给raft</li>
<li>通过CommandBoard等待结果，响应给Client</li>
</ol>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">StateMachine</span>) <span style="color:#a6e22e">Propose</span>(<span style="color:#a6e22e">cmd</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">curp_proto</span>.<span style="color:#a6e22e">CurpClientCommand</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">curp_proto</span>.<span style="color:#a6e22e">CurpReply</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">isConflict</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">witness</span>.<span style="color:#a6e22e">InsertIfNotConflict</span>(<span style="color:#a6e22e">cmd</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Lock</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">raftState</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">raft</span>.<span style="color:#a6e22e">StateLeader</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Trace</span>(<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Leader</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">NodeId</span>, <span style="color:#e6db74">&#34;propose command %s,type: %s,conflict: %v&#34;</span>, <span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Key</span>, <span style="color:#a6e22e">command</span>.<span style="color:#a6e22e">OpFmt</span>[<span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Op</span>], <span style="color:#a6e22e">isConflict</span>)
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Trace</span>(<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Follower</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">NodeId</span>, <span style="color:#e6db74">&#34;propose command %s,type: %s,conflict: %v&#34;</span>, <span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Key</span>, <span style="color:#a6e22e">command</span>.<span style="color:#a6e22e">OpFmt</span>[<span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Op</span>], <span style="color:#a6e22e">isConflict</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">reply</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">curp_proto</span>.<span style="color:#a6e22e">CurpReply</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Content</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">raftState</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">raft</span>.<span style="color:#a6e22e">StateLeader</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">isConflict</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">reply</span>.<span style="color:#a6e22e">StatusCode</span> = <span style="color:#a6e22e">curp_proto</span>.<span style="color:#a6e22e">CONFLICT</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">reply</span>
</span></span><span style="display:flex;"><span>		} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">reply</span>.<span style="color:#a6e22e">StatusCode</span> = <span style="color:#a6e22e">curp_proto</span>.<span style="color:#a6e22e">ACCEPTED</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">reply</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">buf</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Encode</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">fastPath</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">cmd</span>
</span></span><span style="display:flex;"><span>	}()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// command will update the state machine or get command is conflict
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Trace</span>(<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Leader</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">NodeId</span>, <span style="color:#e6db74">&#34;send propose[clientId:%d seqId: %d] msg to raft node&#34;</span>, <span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">ClientId</span>, <span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">SeqId</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">proposeC</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">buf</span>
</span></span><span style="display:flex;"><span>	}()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">proposeId</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">command</span>.<span style="color:#a6e22e">ProposeId</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">ClientId</span>: <span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">ClientId</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">SeqId</span>:    <span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">SeqId</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">result</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">commandBoard</span>.<span style="color:#a6e22e">WaitForEr</span>(<span style="color:#a6e22e">proposeId</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">reply</span>.<span style="color:#a6e22e">Content</span> = <span style="color:#a6e22e">result</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">isConflict</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">reply</span>.<span style="color:#a6e22e">StatusCode</span> = <span style="color:#a6e22e">curp_proto</span>.<span style="color:#a6e22e">CONFLICT</span>
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">reply</span>.<span style="color:#a6e22e">StatusCode</span> = <span style="color:#a6e22e">curp_proto</span>.<span style="color:#a6e22e">ACCEPTED</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">reply</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里有一个细节，在CURP-Q的论文当中描述：Leader的witness应当是关闭的，即Leader并不进行冲突检测，对于所有请求都直接执行，但是在Xline的实现中，Leader是启动了Witness并进行冲突检测的。对于这个细节，个人认为并不会对并不会对系统正确性产生影响，暂时没有深究。</p>
<blockquote>
<p>Witnesses in leaders are inactive, and all client requests are serialized and logged in their command logs directly.</p>
</blockquote>
<p><img loading="lazy" src="https://pic-bed-1309931445.cos.ap-nanjing.myqcloud.com/blog/20240607000134.png" alt="image.png"  />
</p>
<h3 id="slow-path">Slow Path<a hidden class="anchor" aria-hidden="true" href="#slow-path">#</a></h3>
<p>Slow Path的入口很简单，只需要调用 <code>WaitForAsr()</code> 来等待commit即可，通过 <code>WaitSynced()</code> 来实现</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">StateMachine</span>) <span style="color:#a6e22e">WaitSynced</span>(<span style="color:#a6e22e">id</span> <span style="color:#a6e22e">command</span>.<span style="color:#a6e22e">ProposeId</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">curp_proto</span>.<span style="color:#a6e22e">CurpReply</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// only send wait synced message to leader
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Trace</span>(<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Leader</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">NodeId</span>, <span style="color:#e6db74">&#34;got wait synced message: %v&#34;</span>, <span style="color:#a6e22e">id</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">result</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">commandBoard</span>.<span style="color:#a6e22e">WaitForAsr</span>(<span style="color:#a6e22e">id</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">reply</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">curp_proto</span>.<span style="color:#a6e22e">CurpReply</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Content</span>:    <span style="color:#a6e22e">result</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">StatusCode</span>: <span style="color:#a6e22e">curp_proto</span>.<span style="color:#a6e22e">ACCEPTED</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Trace</span>(<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Leader</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">NodeId</span>, <span style="color:#e6db74">&#34;wait synced finished,id: %v,result: %v&#34;</span>, <span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">result</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">reply</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>在Fast Path中，Leader会通过proposeC发送给Raft，此时就相当于进入了Slow Path，在Raft中，完成共识的cmd会通过Ready返回，经RaftNode转手又通过commitC发送会了状态机，状态机收到之后，对cmd进行decode，随机通过slow path channel又将请求发送给了cmd worker</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">StateMachine</span>) <span style="color:#a6e22e">readCommits</span>(<span style="color:#a6e22e">commitC</span> <span style="color:#f92672">&lt;-</span><span style="color:#66d9ef">chan</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">commit</span>, <span style="color:#a6e22e">errorC</span> <span style="color:#f92672">&lt;-</span><span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">commit</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">commitC</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">commit</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// signaled to load snapshot
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#a6e22e">snapshot</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">loadSnapshot</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Panic</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">snapshot</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;loading snapshot at term %d and index %d&#34;</span>, <span style="color:#a6e22e">snapshot</span>.<span style="color:#a6e22e">Metadata</span>.<span style="color:#a6e22e">Term</span>, <span style="color:#a6e22e">snapshot</span>.<span style="color:#a6e22e">Metadata</span>.<span style="color:#a6e22e">Index</span>)
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">recoverFromSnapshot</span>(<span style="color:#a6e22e">snapshot</span>.<span style="color:#a6e22e">Data</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>					<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Panic</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">data</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">commit</span>.<span style="color:#a6e22e">data</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">cmd</span> <span style="color:#a6e22e">curp_proto</span>.<span style="color:#a6e22e">CurpClientCommand</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">dec</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">gob</span>.<span style="color:#a6e22e">NewDecoder</span>(<span style="color:#a6e22e">bytes</span>.<span style="color:#a6e22e">NewBufferString</span>(<span style="color:#a6e22e">data</span>))
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dec</span>.<span style="color:#a6e22e">Decode</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">cmd</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalf</span>(<span style="color:#e6db74">&#34;raftexample: could not decode message (%v)&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">slowPath</span> <span style="color:#f92672">&lt;-</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">cmd</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		close(<span style="color:#a6e22e">commit</span>.<span style="color:#a6e22e">applyDoneC</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">errorC</span>; <span style="color:#a6e22e">ok</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>之后就是cmd worker的逻辑了，在上面已经分析过了，这里简要整合一下。对于leader而言，直接忽略slow path中的内容，以免内容覆盖影响线性一致性。而对于follower而言，直接应用以跟随Leader。slow path执行完成，即可认定其为commit，此时可以通过 <code>NotifyAsr</code> 获取执行结果，并通知 <code>WaitSynced</code> 结束阻塞。</p>
<p><img loading="lazy" src="https://pic-bed-1309931445.cos.ap-nanjing.myqcloud.com/blog/20240607000719.png" alt="image.png"  />
</p>
<h2 id="curp-client">CURP Client<a hidden class="anchor" aria-hidden="true" href="#curp-client">#</a></h2>
<p>对应地，在CURP Client端也分为了fast path和slow path，均通过grpc实现，此外，还需要一个isLeader来确定server中的leader，以确定应当向谁发送 <code>WaitSynced()</code>。</p>
<h3 id="fast-path-1">Fast path<a hidden class="anchor" aria-hidden="true" href="#fast-path-1">#</a></h3>
<p>在fast path中，client需要做的就是将请求广播给所有的server，然后监听统计结果：</p>
<ul>
<li>如果响应结果中存在冲突，那么就返回冲突，后续转向slow round</li>
<li>如果达到了superquorum (f个节点，对应为f + f / 2 + 1，即 4 节点需要 3 个，3 节点需要 3个 )，就返回请求成功</li>
<li>超时检测</li>
</ul>
<p><img loading="lazy" src="https://pic-bed-1309931445.cos.ap-nanjing.myqcloud.com/blog/20240527235816.png" alt="image.png"  />
</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">GrpcClient</span>) <span style="color:#a6e22e">fastRound</span>(<span style="color:#a6e22e">cmd</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">curp_proto</span>.<span style="color:#a6e22e">CurpClientCommand</span>, <span style="color:#a6e22e">notifyC</span> []<span style="color:#66d9ef">chan</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">curp_proto</span>.<span style="color:#a6e22e">CurpReply</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">curp_proto</span>.<span style="color:#a6e22e">CurpReply</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">timeout</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">NewTicker</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">5</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fastPathChan</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">curp_proto</span>.<span style="color:#a6e22e">CurpReply</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; len(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">grpc_servers</span>); <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">i</span> <span style="color:#66d9ef">int</span>) {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">sendC</span>[<span style="color:#a6e22e">i</span>] <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">cmd</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">result</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">notifyC</span>[<span style="color:#a6e22e">i</span>]
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">fastPathChan</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">result</span>
</span></span><span style="display:flex;"><span>		}(<span style="color:#a6e22e">i</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">acceptedCount</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">result</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">curp_proto</span>.<span style="color:#a6e22e">CurpReply</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">StatusCode</span>: <span style="color:#a6e22e">curp_proto</span>.<span style="color:#a6e22e">TIMEOUT</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Content</span>:    <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">select</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">fastResult</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">fastPathChan</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Trace</span>(<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;client receive fast path result: %v&#34;</span>, <span style="color:#a6e22e">fastResult</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">fastResult</span>.<span style="color:#a6e22e">StatusCode</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">curp_proto</span>.<span style="color:#a6e22e">ACCEPTED</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">acceptedCount</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">fastResult</span>.<span style="color:#a6e22e">Content</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>					<span style="color:#a6e22e">result</span> = <span style="color:#a6e22e">fastResult</span>
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fastResult</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">acceptedCount</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">superQuorum</span>() {
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">result</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">timeout</span>.<span style="color:#a6e22e">C</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;timeout !!\n&#34;</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">result</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;fast path time out&#34;</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="slow-path-1">slow path<a hidden class="anchor" aria-hidden="true" href="#slow-path-1">#</a></h3>
<p>slow path比较简单，只需要将请求发送给Leader即可</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">GrpcClient</span>) <span style="color:#a6e22e">slowRound</span>(<span style="color:#a6e22e">cmd</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">curp_proto</span>.<span style="color:#a6e22e">CurpClientCommand</span>, <span style="color:#a6e22e">notifyC</span> []<span style="color:#66d9ef">chan</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">curp_proto</span>.<span style="color:#a6e22e">CurpReply</span>) (<span style="color:#66d9ef">string</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">sync_cmd</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">curp_proto</span>.<span style="color:#a6e22e">CurpClientCommand</span>{<span style="color:#a6e22e">ClientId</span>: <span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">ClientId</span>, <span style="color:#a6e22e">SeqId</span>: <span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">SeqId</span>, <span style="color:#a6e22e">Sync</span>: <span style="color:#ae81ff">1</span>}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">sendC</span>[<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">LeaderId</span>] <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">sync_cmd</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">reply</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">notifyC</span>[<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">LeaderId</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Trace</span>(<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;client wait synced finished, id: %v&#34;</span>, <span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">ProposeId</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">reply</span>.<span style="color:#a6e22e">StatusCode</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">curp_proto</span>.<span style="color:#a6e22e">CONFLICT</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;command is still conflict after wait synced&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">reply</span>.<span style="color:#a6e22e">Content</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>随后，将fast path和slow path做一个整合，封装成 <code>Propose()</code> ，在 <code>Propose()</code> 中：</p>
<ol>
<li>首先调用 <code>fast_round()</code> ，将请求进行广播，如果不存在冲突，那么就可以直接返回，代表此次请求在 1 个RTT内结束</li>
<li>如果 <code>fast_round()</code> 中存在冲突，那么再调用 <code>slow_round()</code>，通过 server对 <code>Waitsynced()</code> 来等待commit，解决冲突</li>
</ol>
<p><img loading="lazy" src="https://pic-bed-1309931445.cos.ap-nanjing.myqcloud.com/blog/20240606230028.png" alt="image.png"  />
</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">GrpcClient</span>) <span style="color:#a6e22e">Propose</span>(<span style="color:#a6e22e">cmd</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">curp_proto</span>.<span style="color:#a6e22e">CurpClientCommand</span>) (<span style="color:#66d9ef">string</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">ntfC</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">NewNotifyC</span>(<span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">SeqId</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">DeleteNotifyC</span>(<span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">SeqId</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">reply</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">fastRound</span>(<span style="color:#a6e22e">cmd</span>, <span style="color:#a6e22e">ntfC</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">reply</span>.<span style="color:#a6e22e">StatusCode</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">curp_proto</span>.<span style="color:#a6e22e">ACCEPTED</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">static</span>.<span style="color:#a6e22e">fast</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">reply</span>.<span style="color:#a6e22e">Content</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">static</span>.<span style="color:#a6e22e">slow</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Trace</span>(<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;client receive conflict result, turn to slow path: %v&#34;</span>, <span style="color:#a6e22e">reply</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">resultStr</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">slowRound</span>(<span style="color:#a6e22e">cmd</span>, <span style="color:#a6e22e">ntfC</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">resultStr</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里有一个小的优化，即可以同时发送fast round和slow round请求，这样可以更快地获取WaitSynced的结果。</p>
<h2 id="benchmark">benchmark<a hidden class="anchor" aria-hidden="true" href="#benchmark">#</a></h2>
<p>这里使用benchmark对curp的性能做了一个简单的测试，选择的是比较通用的go-ycsb，借用了一下go-ycsb的加载数据和统计结果的功能，然后自己通过tcp为curp实现了一个server，然后在ycsb中实现了一个client，这样就可以把请求从ycsb成功发送到curp了。</p>
<p>这里实现的确实是比较草率，但是你就说能不能用吧😀</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">87
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">GetResponse</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Count</span> <span style="color:#66d9ef">int64</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Kvs</span>   []<span style="color:#f92672">*</span><span style="color:#a6e22e">Command</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">GetResponse</span>) <span style="color:#a6e22e">Encode</span>() []<span style="color:#66d9ef">byte</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">buf</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">bytes</span>.<span style="color:#a6e22e">Buffer</span>{}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">enc</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">gob</span>.<span style="color:#a6e22e">NewEncoder</span>(<span style="color:#a6e22e">buf</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">enc</span>.<span style="color:#a6e22e">Encode</span>(<span style="color:#a6e22e">r</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;encode error:&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">buf</span>.<span style="color:#a6e22e">Bytes</span>()
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">GET</span> <span style="color:#66d9ef">uint8</span> = <span style="color:#66d9ef">iota</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">PUT</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">DELETE</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Command</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Op</span>    <span style="color:#66d9ef">uint8</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Key</span>   <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Value</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">bench_server</span>(<span style="color:#a6e22e">port</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">client</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">curp</span>.<span style="color:#a6e22e">GrpcClient</span>) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">listener</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Listen</span>(<span style="color:#e6db74">&#34;tcp&#34;</span>, <span style="color:#a6e22e">port</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Error listening:&#34;</span>, <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Exit</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">listener</span>.<span style="color:#a6e22e">Close</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Server is listening on :%v\n&#34;</span>, <span style="color:#a6e22e">port</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">listener</span>.<span style="color:#a6e22e">Accept</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Error accepting: &#34;</span>, <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Exit</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">handleRequest</span>(<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">client</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">handleRequest</span>(<span style="color:#a6e22e">conn</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Conn</span>, <span style="color:#a6e22e">client</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">curp</span>.<span style="color:#a6e22e">GrpcClient</span>) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">buf</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, <span style="color:#ae81ff">4096</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">n</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Read</span>(<span style="color:#a6e22e">buf</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">aCmd</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Command</span>{}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">dec</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">gob</span>.<span style="color:#a6e22e">NewDecoder</span>(<span style="color:#a6e22e">bytes</span>.<span style="color:#a6e22e">NewReader</span>(<span style="color:#a6e22e">buf</span>[:<span style="color:#a6e22e">n</span>]))
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dec</span>.<span style="color:#a6e22e">Decode</span>(<span style="color:#a6e22e">aCmd</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// fmt.Printf(&#34;Received: %+v\n&#34;, aCmd)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">aCmd</span>.<span style="color:#a6e22e">Op</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">GET</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// call client.get
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">key</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">aCmd</span>.<span style="color:#a6e22e">Key</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// value := &#34;myValue&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">value</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">aCmd</span>.<span style="color:#a6e22e">Key</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">cmd</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Command</span>{
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Op</span>:    <span style="color:#a6e22e">GET</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Key</span>:   <span style="color:#a6e22e">key</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Value</span>: <span style="color:#a6e22e">value</span>,
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">cmds</span> <span style="color:#f92672">:=</span> []<span style="color:#f92672">*</span><span style="color:#a6e22e">Command</span>{<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">cmd</span>}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">resp</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">GetResponse</span>{
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Count</span>: <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Kvs</span>:   <span style="color:#a6e22e">cmds</span>,
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">buf</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">resp</span>.<span style="color:#a6e22e">Encode</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">buf</span>)
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">aCmd</span>.<span style="color:#a6e22e">Op</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">PUT</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// call client.put
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Put</span>(<span style="color:#a6e22e">aCmd</span>.<span style="color:#a6e22e">Key</span>, <span style="color:#a6e22e">aCmd</span>.<span style="color:#a6e22e">Value</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Write</span>([]byte(<span style="color:#e6db74">&#34;Received PUT Response!&#34;</span>))
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">aCmd</span>.<span style="color:#a6e22e">Op</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">DELETE</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// call client.delete
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Del</span>(<span style="color:#a6e22e">aCmd</span>.<span style="color:#a6e22e">Key</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Write</span>([]byte(<span style="color:#e6db74">&#34;Received DELETE Response!&#34;</span>))
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>跑了一个简单的benchmark，由于没有实现scan操作，因此就只选择了ycsb中的workload a-b-c，其中workloada为 50%read 50%write，workloadb为 95%read 5% write，workloadc 100% read,。</p>
<p>可以看到无论是哪个workload，curp的性能均好于raft，对于a，大约是个 20-30%的提升，b, c由于主要是读请求为主，curp中只需要一轮rtt加查询状态机即可，而raft需要走一遍日志复制+查询状态机，因此差距被进一步拉大（这里二者都没有开启线性一致性读优化的，即lease read或read index）</p>
<p>这个benchmark是在单机上跑的，如果真正到了跨域的高网络延迟的场景下，差距会被进一步的拉大</p>
<table>
<thead>
<tr>
<th></th>
<th>curp</th>
<th>raft</th>
</tr>
</thead>
<tbody>
<tr>
<td>workload a</td>
<td>5.2s</td>
<td>6.7s</td>
</tr>
<tr>
<td>workload b</td>
<td>1.2s</td>
<td>4.4s</td>
</tr>
<tr>
<td>wrokload c</td>
<td>0.6s</td>
<td>4.1s<br></td>
</tr>
</tbody>
</table>
<p>go-ycsb的详细结果如下：</p>
<p><strong>CURP</strong></p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>workloada
</span></span><span style="display:flex;"><span>READ   - Takes(s): 5.2, Count: 488, OPS: 94.2, Avg(us): 600, Min(us): 433, Max(us): 25103, 50th(us): 534, 90th(us): 612, 95th(us): 652, 99th(us): 948, 99.9th(us): 25103, 99.99th(us): 25103
</span></span><span style="display:flex;"><span>TOTAL  - Takes(s): 5.2, Count: 1000, OPS: 192.8, Avg(us): 5185, Min(us): 433, Max(us): 52991, 50th(us): 6859, 90th(us): 11503, 95th(us): 12847, 99th(us): 16559, 99.9th(us): 27471, 99.99th(us): 52991
</span></span><span style="display:flex;"><span>UPDATE - Takes(s): 5.2, Count: 512, OPS: 98.7, Avg(us): 9556, Min(us): 5396, Max(us): 52991, 50th(us): 8703, 90th(us): 12823, 95th(us): 14599, 99th(us): 18991, 99.9th(us): 27471, 99.99th(us): 52991
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>workloadb
</span></span><span style="display:flex;"><span>Run finished, takes 1.198906187s
</span></span><span style="display:flex;"><span>READ   - Takes(s): 1.2, Count: 950, OPS: 793.1, Avg(us): 567, Min(us): 304, Max(us): 43807, 50th(us): 507, 90th(us): 582, 95th(us): 640, 99th(us): 1156, 99.9th(us): 1788, 99.99th(us): 43807
</span></span><span style="display:flex;"><span>TOTAL  - Takes(s): 1.2, Count: 1000, OPS: 834.4, Avg(us): 1192, Min(us): 304, Max(us): 43807, 50th(us): 511, 90th(us): 631, 95th(us): 6403, 99th(us): 15151, 99.9th(us): 20879, 99.99th(us): 43807
</span></span><span style="display:flex;"><span>UPDATE - Takes(s): 1.1, Count: 50, OPS: 43.9, Avg(us): 13067, Min(us): 6400, Max(us): 20879, 50th(us): 13175, 90th(us): 15527, 95th(us): 16767, 99th(us): 20879, 99.9th(us): 20879, 99.99th(us): 20879
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>workloadc
</span></span><span style="display:flex;"><span>Run finished, takes 596.022766ms
</span></span><span style="display:flex;"><span>READ   - Takes(s): 0.6, Count: 1000, OPS: 1680.6, Avg(us): 590, Min(us): 313, Max(us): 60863, 50th(us): 511, 90th(us): 614, 95th(us): 682, 99th(us): 1099, 99.9th(us): 1634, 99.99th(us): 60863
</span></span><span style="display:flex;"><span>TOTAL  - Takes(s): 0.6, Count: 1000, OPS: 1680.0, Avg(us): 590, Min(us): 313, Max(us): 60863, 50th(us): 511, 90th(us): 614, 95th(us): 682, 99th(us): 1099, 99.9th(us): 1634, 99.99th(us): 60863
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Raft</strong></p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>workloada
</span></span><span style="display:flex;"><span>Run finished, takes 6.741194029s
</span></span><span style="display:flex;"><span>READ   - Takes(s): 6.7, Count: 490, OPS: 72.8, Avg(us): 4182, Min(us): 3188, Max(us): 25279, 50th(us): 3571, 90th(us): 4787, 95th(us): 7699, 99th(us): 12015, 99.9th(us): 25279, 99.99th(us): 25279
</span></span><span style="display:flex;"><span>TOTAL  - Takes(s): 6.7, Count: 1000, OPS: 148.7, Avg(us): 6733, Min(us): 3188, Max(us): 42047, 50th(us): 7979, 90th(us): 9599, 95th(us): 12111, 99th(us): 17407, 99.9th(us): 25279, 99.99th(us): 42047
</span></span><span style="display:flex;"><span>UPDATE - Takes(s): 6.7, Count: 510, OPS: 76.0, Avg(us): 9183, Min(us): 6908, Max(us): 42047, 50th(us): 8295, 90th(us): 11175, 95th(us): 15455, 99th(us): 18591, 99.9th(us): 20079, 99.99th(us): 42047
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>workloadb
</span></span><span style="display:flex;"><span>Run finished, takes 4.386455138s
</span></span><span style="display:flex;"><span>READ   - Takes(s): 4.4, Count: 952, OPS: 217.6, Avg(us): 4152, Min(us): 3196, Max(us): 27407, 50th(us): 3553, 90th(us): 5947, 95th(us): 10591, 99th(us): 11487, 99.9th(us): 18127, 99.99th(us): 27407
</span></span><span style="display:flex;"><span>TOTAL  - Takes(s): 4.4, Count: 1000, OPS: 228.6, Avg(us): 4380, Min(us): 3196, Max(us): 27407, 50th(us): 3559, 90th(us): 7479, 95th(us): 10799, 99th(us): 11599, 99.9th(us): 18127, 99.99th(us): 27407
</span></span><span style="display:flex;"><span>UPDATE - Takes(s): 4.3, Count: 48, OPS: 11.1, Avg(us): 8898, Min(us): 7096, Max(us): 15031, 50th(us): 8271, 90th(us): 10735, 95th(us): 14975, 99th(us): 15031, 99.9th(us): 15031, 99.99th(us): 15031
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>workloadc
</span></span><span style="display:flex;"><span>Run finished, takes 4.143589849s
</span></span><span style="display:flex;"><span>READ   - Takes(s): 4.1, Count: 1000, OPS: 242.1, Avg(us): 4138, Min(us): 3272, Max(us): 44351, 50th(us): 3575, 90th(us): 5939, 95th(us): 7511, 99th(us): 11207, 99.9th(us): 13191, 99.99th(us): 44351
</span></span><span style="display:flex;"><span>TOTAL  - Takes(s): 4.1, Count: 1000, OPS: 242.1, Avg(us): 4138, Min(us): 3272, Max(us): 44351, 50th(us): 3575, 90th(us): 5939, 95th(us): 7511, 99th(us): 11207, 99.9th(us): 13191, 99.99th(us): 44351
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="todo">TODO<a hidden class="anchor" aria-hidden="true" href="#todo">#</a></h2>
<p>目前的CURP只实现了基础的运行，并没有考虑crash-recovery，这对于一个共识来说显然是不足的，不过碍于时间和精力，短时间笔者是无法补全这一部分了，在这里简单说一下思路。</p>
<h3 id="version">Version<a hidden class="anchor" aria-hidden="true" href="#version">#</a></h3>
<p>首先，对于挂掉和回复的节点，整个集群应当能够感知，论文中中给出的方案是维护一个集群列表+version，client首次从配置中心处持有该列表和version，之后每次请求是携带上version，随后配置中心接收到请求后会校验version，来判断client持有的配置是否过期, 如果过期就拒绝掉此次请求，并告知Client</p>
<p>在实现上，配置中心可以实现在Leader上，Client在调用 <code>isLeader ()</code> 确定集群Leader时顺便获取到version和配置，并在client端维护，随后扩展一下protobuf的结构体，每次请求携带上version。server端，server端在从raft处检测到身份变更时，就应当由新的leader去生成一份新的配置+version。将其返回给client</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">StateMachine</span>) <span style="color:#a6e22e">listenRaftState</span>() {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">state</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">stateChangeC</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Lock</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Trace</span>(<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Vote</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">NodeId</span>, <span style="color:#e6db74">&#34;raft state update: before: %s,current: %s&#34;</span>, <span style="color:#a6e22e">stmap</span>[<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">raftState</span>], <span style="color:#a6e22e">stmap</span>[<span style="color:#a6e22e">state</span>])
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 如果是Leader，那么就生成新配置
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">raftState</span> = <span style="color:#a6e22e">state</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="witness-1">Witness<a hidden class="anchor" aria-hidden="true" href="#witness-1">#</a></h3>
<p>由于Leader进行了抢跑，因此会有一些请求还未commit，但也已经返回给client了，这些请求的结果，或者说这些请求对状态机的影响暂时不会暴露出来（后续如果想要获取结果，或者说对其修改，都会因冲突而被拒绝）但是请求成功也确实是实打实的响应给client了。因此这一部分的请求结果不能丢失，但是又没有通过log发送给follower，因此就需要通过Witness中的存储来完成恢复。</p>
<p>具体来说，需要添加一条rpc，使得新的Leader能够获取到follower的witness中的数据，然后再leader处按照顺序执行并写入log。从而解决冲突并确定顺序。当log commit时，即可自动删除掉witness中的内容。</p>
<h2 id="summary">Summary<a hidden class="anchor" aria-hidden="true" href="#summary">#</a></h2>
<p>本文基于etcd/raft，实现了一个简易的CURP，提供了fast path + slow path的逻辑，使得不冲突的请求可以在一个RTT完成。目前还欠缺recovery的逻辑，但临近毕业，笔者精力实在有限，短时间内应该是没有精力去补完了。如果想学习工业级CURP的实现，可以去看Xline：<a href="https://github.com/xline-kv/Xline.git">GitHub - xline-kv/Xline: A geo-distributed KV store for metadata management</a></p>
<p>目前的curp和组里的一个项目代码混在一起，不太方便全部开源，等后续有空了给分离出来扔到github上。</p>
<p>对于CURP而言，虽然其在性能上领先Raft不少，但是在笔者测试的过程中，发现slow path对于系统性能影响较大，ectd/raft中，log是由wal + 内存实现存储的，关闭wal之后，workloada可以从 5s缩短至 3s左右，那么是否有一种办法在不存在冲突时彻底绕过slow path呢？</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="next" href="https://fischer0522.github.io/en/posts/tech/curp/curp-exploiting-commutativity-for-practical-fast-replication/">
    <span class="title">Next »</span>
    <br>
    <span>01-CURP: 共识算法的重新思考</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 02-从0.5实现CURP on x"
            href="https://x.com/intent/tweet/?text=02-%e4%bb%8e0.5%e5%ae%9e%e7%8e%b0CURP&amp;url=https%3a%2f%2ffischer0522.github.io%2fen%2fposts%2ftech%2fcurp%2f%25E4%25BB%258E0.5%25E5%2588%25B01%25E5%25AE%259E%25E7%258E%25B0curp%2f&amp;hashtags=">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 02-从0.5实现CURP on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2ffischer0522.github.io%2fen%2fposts%2ftech%2fcurp%2f%25E4%25BB%258E0.5%25E5%2588%25B01%25E5%25AE%259E%25E7%258E%25B0curp%2f&amp;title=02-%e4%bb%8e0.5%e5%ae%9e%e7%8e%b0CURP&amp;summary=02-%e4%bb%8e0.5%e5%ae%9e%e7%8e%b0CURP&amp;source=https%3a%2f%2ffischer0522.github.io%2fen%2fposts%2ftech%2fcurp%2f%25E4%25BB%258E0.5%25E5%2588%25B01%25E5%25AE%259E%25E7%258E%25B0curp%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 02-从0.5实现CURP on reddit"
            href="https://reddit.com/submit?url=https%3a%2f%2ffischer0522.github.io%2fen%2fposts%2ftech%2fcurp%2f%25E4%25BB%258E0.5%25E5%2588%25B01%25E5%25AE%259E%25E7%258E%25B0curp%2f&title=02-%e4%bb%8e0.5%e5%ae%9e%e7%8e%b0CURP">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 02-从0.5实现CURP on facebook"
            href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2ffischer0522.github.io%2fen%2fposts%2ftech%2fcurp%2f%25E4%25BB%258E0.5%25E5%2588%25B01%25E5%25AE%259E%25E7%258E%25B0curp%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 02-从0.5实现CURP on whatsapp"
            href="https://api.whatsapp.com/send?text=02-%e4%bb%8e0.5%e5%ae%9e%e7%8e%b0CURP%20-%20https%3a%2f%2ffischer0522.github.io%2fen%2fposts%2ftech%2fcurp%2f%25E4%25BB%258E0.5%25E5%2588%25B01%25E5%25AE%259E%25E7%258E%25B0curp%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 02-从0.5实现CURP on telegram"
            href="https://telegram.me/share/url?text=02-%e4%bb%8e0.5%e5%ae%9e%e7%8e%b0CURP&amp;url=https%3a%2f%2ffischer0522.github.io%2fen%2fposts%2ftech%2fcurp%2f%25E4%25BB%258E0.5%25E5%2588%25B01%25E5%25AE%259E%25E7%258E%25B0curp%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 02-从0.5实现CURP on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=02-%e4%bb%8e0.5%e5%ae%9e%e7%8e%b0CURP&u=https%3a%2f%2ffischer0522.github.io%2fen%2fposts%2ftech%2fcurp%2f%25E4%25BB%258E0.5%25E5%2588%25B01%25E5%25AE%259E%25E7%258E%25B0curp%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2025 <a href="https://fischer0522.github.io/en/">Fischer&#39;s Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
