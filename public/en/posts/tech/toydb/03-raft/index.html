<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>03-Raft | Fischer&#39;s Blog</title>
<meta name="keywords" content="">
<meta name="description" content="toydb的Raft实现，相比于6.824更接近于生产级别的，和etcd/raft在结构上比较相似，但是并没有实现Raft大论文当中的优化，">
<meta name="author" content="Fischer">
<link rel="canonical" href="https://fischer0522.github.io/en/posts/tech/toydb/03-raft/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css" integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z&#43;V9&#43;cO1A=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://fischer0522.github.io/img/Navigation.svg">
<link rel="icon" type="image/png" sizes="16x16" href="https://fischer0522.github.io/img/Navigation.svg">
<link rel="icon" type="image/png" sizes="32x32" href="https://fischer0522.github.io/img/Navigation.svg">
<link rel="apple-touch-icon" href="https://fischer0522.github.io/Navigation.svg">
<link rel="mask-icon" href="https://fischer0522.github.io/Navigation.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="03-Raft" />
<meta property="og:description" content="toydb的Raft实现，相比于6.824更接近于生产级别的，和etcd/raft在结构上比较相似，但是并没有实现Raft大论文当中的优化，" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://fischer0522.github.io/en/posts/tech/toydb/03-raft/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-28T09:31:59+00:00" />
<meta property="article:modified_time" content="2023-12-28T09:31:59+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="03-Raft"/>
<meta name="twitter:description" content="toydb的Raft实现，相比于6.824更接近于生产级别的，和etcd/raft在结构上比较相似，但是并没有实现Raft大论文当中的优化，"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Blog",
      "item": "https://fischer0522.github.io/en/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Tech",
      "item": "https://fischer0522.github.io/en/posts/tech/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "toydb",
      "item": "https://fischer0522.github.io/en/posts/tech/toydb/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "03-Raft",
      "item": "https://fischer0522.github.io/en/posts/tech/toydb/03-raft/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "03-Raft",
  "name": "03-Raft",
  "description": "toydb的Raft实现，相比于6.824更接近于生产级别的，和etcd/raft在结构上比较相似，但是并没有实现Raft大论文当中的优化，",
  "keywords": [
    
  ],
  "articleBody": "toydb的Raft实现，相比于6.824更接近于生产级别的，和etcd/raft在结构上比较相似，但是并没有实现Raft大论文当中的优化，并且相比Raft小论文也砍掉了一些优化，比如fast backup,snapshot等。不过在写法上还是很有rust的味道的。可以分为一下几个模块：\nNode：分别定义Leader、Candidate、Follower各自的行为和通用的行为(定义在mod.rs当中) log：以kv engine作为底层，持久化存储Raft的log，同时也会用于持久化存储元数据，所有需要进行持久化存储的都会使用log模块 State：Raft状态机，构建于Raft之上，相当于6.824当中的Lab3 Server：通信模块，负责与其他Raft节点之间进行通信，基于tcp实现 在本章当中，笔者会首先分析toydb当中的Raft的一些基础模块，之后再按照选举和日志复制的逻辑来进行分析Raft的逻辑。对于Raft本身，笔者不会做过多介绍，如果想了解Raft本身建议看Raft小论文/大论文，6.824 raft.pdf web.stanford.edu/~ouster/cgi-bin/papers/OngaroPhD.pdf Message 在toydb当中，Raft模块使用Event作为事件的载体，而Message为Event的封装，整个Raft的执行过程就是不断处理Message的过程，这与etcd当中的设计非常相似，所以先来看一下Message相关内容，定义在src/raft/message.rs当中。\nMessage的发送目标采用一个枚举来表示\nBroadcast：为广播类型，需要发送给所有的节点 Node：为单独发送，指定NodeID，在上层网络模块再转换成ip进行发送 Client：用于回复Client 1 2 3 4 5 6 7 8 9 10 11 #[derive(Clone, Copy, Debug, Eq, Hash, PartialEq, Serialize, Deserialize)] pub enum Address { /// Broadcast to all peers. Only valid as an outbound recipient (to). Broadcast, /// A node with the specified node ID (local or remote). Valid both as /// sender and recipient. Node(NodeID), /// A local client. Can only send ClientRequest messages, and receive /// ClientResponse messages. Client, } Message定义为一个结构体,其中包含发送Message时的Term，发送方与接收方，以及Event\n1 2 3 4 5 6 7 8 9 10 11 12 13 /// A message passed between Raft nodes. #[derive(Clone, Debug, PartialEq, Serialize, Deserialize)] pub struct Message { /// The current term of the sender. Must be set, unless the sender is /// Address::Client, in which case it must be 0. pub term: Term, /// The sender address. pub from: Address, /// The recipient address. pub to: Address, /// The message payload. pub event: Event, } Message的主体是Event，Event定义为一个枚举类型，在其中表示了Raft当中的所有事件，如果需要额外的信息，就封装成一个结构体，否则设置成一个枚举字段即可。如心跳信息，candidate开启选举等等，在代码当中每一种类型都给出了详细的注释，读者可自行阅读\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 #[derive(Clone, Debug, PartialEq, Serialize, Deserialize)] pub enum Event { /// Leaders send periodic heartbeats to its followers. Heartbeat { /// The index of the leader's last committed log entry. commit_index: Index, /// The term of the leader's last committed log entry. commit_term: Term, }, /// Followers confirm loyalty to leader after heartbeats. ConfirmLeader { /// The commit_index of the original leader heartbeat, to confirm /// read requests. commit_index: Index, /// If false, the follower does not have the entry at commit_index /// and would like the leader to replicate it. has_committed: bool, }, /// Candidates solicit votes from all peers when campaigning for leadership. SolicitVote { // The index of the candidate's last stored log entry last_index: Index, // The term of the candidate's last stored log entry last_term: Term, }, /// Followers may grant a single vote to a candidate per term, on a /// first-come basis. Candidates implicitly vote for themselves. GrantVote, /// Leaders replicate log entries to followers by appending it to their log. AppendEntries { /// The index of the log entry immediately preceding the submitted commands. base_index: Index, /// The term of the log entry immediately preceding the submitted commands. base_term: Term, /// Commands to replicate. entries: Vec\u003cEntry\u003e, }, /// Followers may accept a set of log entries from a leader. AcceptEntries { /// The index of the last log entry. last_index: Index, }, /// Followers may also reject a set of log entries from a leader. RejectEntries, /// A client request. This can be submitted to the leader, or to a follower /// which will forward it to its leader. If there is no leader, or the /// leader or term changes, the request is aborted with an Error::Abort /// ClientResponse and the client must retry. ClientRequest { /// The request ID. This is arbitrary, but must be globally unique for /// the duration of the request. id: RequestID, /// The request. request: Request, }, /// A client response. ClientResponse { /// The response ID. This matches the ID of the ClientRequest. id: RequestID, /// The response, or an error. response: Result\u003cResponse\u003e, }, } 对比一下etcd当中的Message类型,在rust当中使用enum Event进行封装是不是简洁很多呢，event同一事件只会有一种类型和数据，避免携带不必要的数据。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 type Message struct { Type MessageType `protobuf:\"varint,1,opt,name=type,enum=raftpb.MessageType\" json:\"type\"` To uint64 `protobuf:\"varint,2,opt,name=to\" json:\"to\"` From uint64 `protobuf:\"varint,3,opt,name=from\" json:\"from\"` Term uint64 `protobuf:\"varint,4,opt,name=term\" json:\"term\"` // logTerm is generally used for appending Raft logs to followers. For example, // (type=MsgApp,index=100,logTerm=5) means leader appends entries starting at // index=101, and the term of entry at index 100 is 5. // (type=MsgAppResp,reject=true,index=100,logTerm=5) means follower rejects some // entries from its leader as it already has an entry with term 5 at index 100. LogTerm uint64 `protobuf:\"varint,5,opt,name=logTerm\" json:\"logTerm\"` Index uint64 `protobuf:\"varint,6,opt,name=index\" json:\"index\"` Entries []Entry `protobuf:\"bytes,7,rep,name=entries\" json:\"entries\"` Commit uint64 `protobuf:\"varint,8,opt,name=commit\" json:\"commit\"` Snapshot Snapshot `protobuf:\"bytes,9,opt,name=snapshot\" json:\"snapshot\"` Reject bool `protobuf:\"varint,10,opt,name=reject\" json:\"reject\"` RejectHint uint64 `protobuf:\"varint,11,opt,name=rejectHint\" json:\"rejectHint\"` Context []byte `protobuf:\"bytes,12,opt,name=context\" json:\"context,omitempty\"` } Node Node这一部分表示在Raft运行过程中，Raft节点的角色和执行动作，在这一部分仅简单介绍涉及到的结构体，而执行逻辑分为选举和日志复制两部分进行分析。\ntoydb当中使用RoleNode来表示节点的状态和角色,其中:\nlog为一个与kv engine交互的模块，负责所有持久化存储的工作 node_tx用于进行节点之间的通信(节点之间真实传输使用的是tcp，这个mpsc更像是一个信箱，将Message添加到其中，等待之后发送，这一部分的设计也与etcd相同，不过etcd是一个批处理的形式，会攒一波消息一同发送) state_tx用于与上层状态机进行通信 1 2 3 4 5 6 7 8 9 10 // A Raft node with role R pub struct RoleNode\u003cR\u003e { id: NodeID, peers: HashSet\u003cNodeID\u003e, term: Term, log: Log, node_tx: mpsc::UnboundedSender\u003cMessage\u003e, state_tx: mpsc::UnboundedSender\u003cInstruction\u003e, role: R, } Role代表当前节点的角色，分别有Leader、Candidate、Follower，封装了一些每种不同角色特有的内容：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 pub struct Leader { /// Peer replication progress. progress: HashMap\u003cNodeID, Progress\u003e, /// Number of ticks since last periodic heartbeat. since_heartbeat: Ticks, } pub struct Follower { /// The leader, or None if just initialized. leader: Option\u003cNodeID\u003e, /// The number of ticks since the last message from the leader. leader_seen: Ticks, /// The leader_seen timeout before triggering an election. election_timeout: Ticks, /// The node we voted for in the current term, if any. voted_for: Option\u003cNodeID\u003e, // Local client requests that have been forwarded to the leader. These are // aborted on leader/term changes. pub(super) forwarded: HashSet\u003cRequestID\u003e, } pub struct Candidate { /// Votes received (including ourself). votes: HashSet\u003cNodeID\u003e, /// Ticks elapsed since election start. election_duration: Ticks, /// Election timeout, in ticks. election_timeout: Ticks, } 在RoleNode当中，配备了几个基础的函数，后面流程中可能用到，先提一下，都比较简单：\nbecome_role():切换角色，更新role quorum():计算集群“大多数”的数量 send():将Message塞入信箱当中，之后会被读取并发送 assert_node():检查当前的term与持久化存储的term是否相同 assert_step():在step函数处理Message之前先对Message进行校验 检查Message的接收方：判断是否应该由当前节点处理，step函数不应该处理发送给client的Message和不属于自己的Message 检查Message的发送方：不应该有Broadcast类型的发送方，Broadcast只应该作为接收方存在；对client发送的Message进行检查；检查由其他节点发送而来的消息，该节点是妇女存在于集群当中，以及需要携带term 角色切换 Leader\nLeader只有一种角色切换，即接收到更高的term从而退位，转换成follower，定义在RoleNode.become_follower()当中,由于因为检测到更高的term，因此需要更新自身的term并进行持久化的工作：\n1 2 3 4 5 6 7 8 9 10 11 12 /// Transforms the leader into a follower. This can only happen if we find a /// new term, so we become a leaderless follower. fn become_follower(mut self, term: Term) -\u003e Result\u003cRoleNode\u003cFollower\u003e\u003e { assert!(term \u003e= self.term, \"Term regression {} -\u003e {}\", self.term, term); assert!(term \u003e self.term, \"Can only become follower in later term\"); info!(\"Discovered new term {}\", term); self.term = term; self.log.set_term(term, None)?; self.state_tx.send(Instruction::Abort)?; Ok(self.become_role(Follower::new(None, None))) } Candidate\ncandidate在输掉选举之后或者接收到更高的Term就会转换为Follower：\n在输掉选举时，会接收到新的Leader的Heartbeat，因此可以知道新的Leader是谁，更新自身状态时将当前的Leader保存 接收到更高Term时，有可能只是其他进度更新的Follower给予的回应，因此无法得知Leader是谁 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 /// Transforms the node into a follower. We either lost the election /// and follow the winner, or we discovered a new term in which case /// we step into it as a leaderless follower. fn become_follower(mut self, term: Term, leader: Option\u003cNodeID\u003e) -\u003e Result\u003cRoleNode\u003cFollower\u003e\u003e { assert!(term \u003e= self.term, \"Term regression {} -\u003e {}\", self.term, term); if let Some(leader) = leader { // We lost the election, follow the winner. assert_eq!(term, self.term, \"Can't follow leader in different term\"); info!(\"Lost election, following leader {} in term {}\", leader, term); let voted_for = Some(self.id); // by definition Ok(self.become_role(Follower::new(Some(leader), voted_for))) } else { // We found a new term, but we don't necessarily know who the leader // is yet. We'll find out when we step a message from it. assert_ne!(term, self.term, \"Can't become leaderless follower in current term\"); info!(\"Discovered new term {}\", term); self.term = term; self.log.set_term(term, None)?; Ok(self.become_role(Follower::new(None, None))) } } candidate如果能够成功当选，那么就可以转换为Leader，上线之后发送心跳信息并且追加一条non-op，，追加的non-op的原因在raft论文当中作出了解释，这里简单提一下，Raft不能够提交自己任期以外的日志，只能够在提交当前任期的日志时顺带提交之前的日志，否则会出现提交日志被覆盖的安全性问题(具体样例见论文figure 8)，如果开启read index线性一致性读优化的情况下，系统如果不收到写请求就无法提交之前的日志，从而阻塞系统状态(读写都会被阻塞，read index 需要Leader在当前任期提交过日志之后才能执行)，non-op可以尽快恢复系统状态。\n1 2 3 4 5 6 7 8 9 10 11 12 13 /// Transition to leader role. fn become_leader(self) -\u003e Result\u003cRoleNode\u003cLeader\u003e\u003e { info!(\"Won election for term {}, becoming leader\", self.term); let peers = self.peers.clone(); let (last_index, _) = self.log.get_last_index(); let mut node = self.become_role(Leader::new(peers, last_index)); node.heartbeat()?; // Propose an empty command when assuming leadership, to disambiguate // previous entries in the log. See section 8 in the Raft paper. node.propose(None)?; Ok(node) } Follower\nFollower在选举超时时会转换为Candidate，并且调用compaign()开始选举。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 fn become_candidate(mut self) -\u003e Result\u003cRoleNode\u003cCandidate\u003e\u003e { // Abort any forwarded requests. These must be retried with new leader. self.abort_forwarded()?; let mut node = self.become_role(Candidate::new()); node.campaign()?; Ok(node) } /// Processes a logical clock tick. pub fn tick(mut self) -\u003e Result\u003cNode\u003e { self.assert()?; self.role.leader_seen += 1; if self.role.leader_seen \u003e= self.role.election_timeout { return Ok(self.become_candidate()?.into()); } Ok(self.into()) } Follower在接受到Leader的Heartbeat、AppendEntries时，或者更高的Term的消息时，都会更新自身状态进行跟随\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 /// Transforms the node into a follower, either a leaderless follower in a /// new term or following a leader in the current term. fn become_follower(mut self, leader: Option\u003cNodeID\u003e, term: Term) -\u003e Result\u003cRoleNode\u003cFollower\u003e\u003e { assert!(term \u003e= self.term, \"Term regression {} -\u003e {}\", self.term, term); // Abort any forwarded requests. These must be retried with new leader. self.abort_forwarded()?; if let Some(leader) = leader { // We found a leader in the current term. assert_eq!(self.role.leader, None, \"Already have leader in term\"); assert_eq!(term, self.term, \"Can't follow leader in different term\"); info!(\"Following leader {} in term {}\", leader, term); self.role = Follower::new(Some(leader), self.role.voted_for); } else { // We found a new term, but we don't necessarily know who the leader // is yet. We'll find out when we step a message from it. assert_ne!(term, self.term, \"Can't become leaderless follower in current term\"); info!(\"Discovered new term {}\", term); self.term = term; self.log.set_term(term, None)?; self.role = Follower::new(None, None); } Ok(self) } 消息转发 在toydb当中，Follower是允许和Client通信的，但是不能够处理信息，Follower需要将消息转发给Leader，Leader处理完之后再由Follower响应Client,这一部分的逻辑在follower.step()当中：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 // Forward client requests to the leader, or abort them if there is // none (the client must retry). Event::ClientRequest { ref id, .. } =\u003e { if msg.from != Address::Client { error!(\"Received client request from non-client {:?}\", msg.from); return Ok(self.into()); } let id = id.clone(); if let Some(leader) = self.role.leader { debug!(\"Forwarding request to leader {}: {:?}\", leader, msg); self.role.forwarded.insert(id); self.send(Address::Node(leader), msg.event)? } else { self.send(msg.from, Event::ClientResponse { id, response: Err(Error::Abort) })? } } // Returns client responses for forwarded requests. // 接收到client的消息之后，转发给leader，leader处理完之后再回应follower // 之后继续由follower去响应给client，这里为什么不告知client 真正的Leader是什么？ Event::ClientResponse { id, mut response } =\u003e { if !self.is_leader(\u0026msg.from) { error!(\"Received client response from non-leader {:?}\", msg.from); return Ok(self.into()); } // TODO: Get rid of this field, it should be returned at the RPC // server level instead. if let Ok(Response::Status(ref mut status)) = response { status.server = self.id; } // 处理完就可以从请求队列当中移除，并且响应Client // 请求队列是用于记录Follower接收到并且未处理完的ClientRequest，用于在通知Leader时，就可以将这些未处理的请求全部告知Client,让其找到Leader再去重新执行 if self.role.forwarded.remove(\u0026id) { self.send(Address::Client, Event::ClientResponse { id, response })?; } } 不过Follower既然已经转发给Leader并且正确得到回应，那么就说明Follower知道Leader是谁了，此时回复Client时可以告知Client当前节点不是Leader，之后Client就可以找Leader去通信，但是toydb并没有这样实现，告知Client当前身份这个过程在toydb当中进行了单独的封装：\n在Follower能够确认Leader时，如从Leader处接收到Heartbeat和AppendEntries时，就会调用上文的follower.become_follower()重置状态，在这个函数里面，会调用一个abort_forwarded()，在其中，会使用std::mem::take将role.forwarded给重置，并且遍历其中未处理的消息，依次告知Error，之后Client再进行重试。\n1 2 3 4 5 6 7 8 /// Aborts all forwarded requests. fn abort_forwarded(\u0026mut self) -\u003e Result\u003c()\u003e { for id in std::mem::take(\u0026mut self.role.forwarded) { debug!(\"Aborting forwarded request {:x?}\", id); self.send(Address::Client, Event::ClientResponse { id, response: Err(Error::Abort) })?; } Ok(()) } 初始化 在toydb启动时，会调用Server::new()来创建一个server节点，在其中，一部分初始化与client进行通信，而另一部分则是初始化raft节点,初始化完成之后就会调用serve来提供网络服务，其中会调用到raft.serve()来启动raft节点：\n1 2 3 4 5 6 7 // toydb.rs main Server::new(cfg.id, cfg.peers, raft_log, raft_state) .await? .listen(\u0026cfg.listen_sql, \u0026cfg.listen_raft) .await? .serve() .await 在raft.serve()当中，就会调用raft.eventloop()正式启动raft接收和处理事件，在eventloop当中，传入了一个channel的发送端，创建了三个channel：\ntcp_tx:raft节点之间相互交流的发送端，用于将底层node塞入信箱当中的Message发送给其他的节点 node_rx:node Message消息的接收端，用于从下层的raft当中接收Message，然后交给tcp_tx去发送 tcp_rx:raft节点之间相互交流的接收端，接收其他节点传来的Message，然后交给自身的Raft去执行 Client_rx: 接收 client 发送的 Message，交给自身的 Raft 去执行，这里的 client 并不是用户的 client，而是要执行命令的 sql 端，sql 端对于要执行的命令，首先会交给 Raft 来进行共识，这个过程是以 client-server 结构来执行的，sql 端充当 client，raft-server 充当 server。 这一部分的逻辑主体是通过tokio::select!来实现的，在逻辑上与go当中的select是差不多的，只不过go的select是监听同步channel，而tokio::select!是等待异步任务的执行完成，分别从上述的三个channel当中获取Message，推动Raft节点。\n除了channel的通信之外，select当中还有一个Ticker，以100ms的间隔运行，用于将物理时钟转换为逻辑时钟，提供给下层，驱动Raft。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 /// Runs the event loop. async fn eventloop( mut node: Node, node_rx: mpsc::UnboundedReceiver\u003cMessage\u003e, client_rx: mpsc::UnboundedReceiver\u003c(Request, oneshot::Sender\u003cResult\u003cResponse\u003e\u003e)\u003e, tcp_rx: mpsc::UnboundedReceiver\u003cMessage\u003e, tcp_tx: mpsc::UnboundedSender\u003cMessage\u003e, ) -\u003e Result\u003c()\u003e { let mut node_rx = UnboundedReceiverStream::new(node_rx); let mut tcp_rx = UnboundedReceiverStream::new(tcp_rx); let mut client_rx = UnboundedReceiverStream::new(client_rx); let mut ticker = tokio::time::interval(TICK_INTERVAL); let mut requests = HashMap::\u003cVec\u003cu8\u003e, oneshot::Sender\u003cResult\u003cResponse\u003e\u003e\u003e::new(); loop { tokio::select! { // 监听ticker，驱动下层Raft，间隔为100ms _ = ticker.tick() =\u003e node = node.tick()?, // 获取从其他raft节点发送而来的Message，交给下层的Raft去处理 Some(msg) = tcp_rx.next() =\u003e node = node.step(msg)?, // 获取下层Raft放入信箱的Message，发送给对应的节点 Some(msg) = node_rx.next() =\u003e { match msg { Message{to: Address::Node(_), ..} =\u003e tcp_tx.send(msg)?, Message{to: Address::Broadcast, ..} =\u003e tcp_tx.send(msg)?, Message{to: Address::Client, event: Event::ClientResponse{ id, response }, ..} =\u003e { if let Some(response_tx) = requests.remove(\u0026id) { response_tx .send(response) .map_err(|e| Error::Internal(format!(\"Failed to send response {:?}\", e)))?; } } _ =\u003e return Err(Error::Internal(format!(\"Unexpected message {:?}\", msg))), } } // 获取client发送的消息，交给下层去处理，这里的client并不是用户的client，而是要执行命令的sql端 Some((request, response_tx)) = client_rx.next() =\u003e { let id = Uuid::new_v4().as_bytes().to_vec(); let msg = Message{ from: Address::Client, to: Address::Node(node.id()), term: 0, event: Event::ClientRequest{id: id.clone(), request}, }; node = node.step(msg)?; requests.insert(id, response_tx); } } } } Leader Election Raft的选举过程受到Ticker的驱动，如上面所展示的，上层server层会以100ms为间隔将物理时钟转换为逻辑时钟，下层的tick()定义在mod.rs当中,对于不同角色的节点，分别调用对应的tick()，在选举当中，对应的就是Follower的tick()：\n1 2 3 4 5 6 7 8 9 /// Moves time forward by a tick. pub fn tick(self) -\u003e Result\u003cSelf\u003e { match self { Node::Candidate(n) =\u003e n.tick(), Node::Follower(n) =\u003e n.tick(), Node::Leader(n) =\u003e n.tick(), } } 在Follower的tick()当中,增大election_duration，如果超出了限制，就转换为candidate，开启选举，选举的入口为self.compaign(),这与etcd/raft的实现是一致的。\n在toydb当中设置的是10-20个逻辑时钟，即1-2s的随机时间，这里比论文当中(150ms-300ms)设置的长很多，和etcd设置一致。但是toydb的heartbeat为3个逻辑时钟，所以其实也不会有太大的问题\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 /// The interval between leader heartbeats, in ticks. const HEARTBEAT_INTERVAL: Ticks = 3; /// The randomized election timeout range (min-max), in ticks. This is /// randomized per node to avoid ties. const ELECTION_TIMEOUT_RANGE: std::ops::Range\u003cu8\u003e = 10..20; // Follower.tick，转换为candidate pub fn tick(mut self) -\u003e Result\u003cNode\u003e { self.assert()?; self.role.leader_seen += 1; if self.role.leader_seen \u003e= self.role.election_timeout { return Ok(self.become_candidate()?.into()); } Ok(self.into()) } // 转换为candidate之后会立刻开始选举 /// Transforms the node into a candidate, by campaigning for leadership in a /// new term. fn become_candidate(mut self) -\u003e Result\u003cRoleNode\u003cCandidate\u003e\u003e { // Abort any forwarded requests. These must be retried with new leader. self.abort_forwarded()?; let mut node = self.become_role(Candidate::new()); node.campaign()?; Ok(node) } // Candidate.tick，在第一次选举失败之后会调用到 /// Processes a logical clock tick. pub fn tick(mut self) -\u003e Result\u003cNode\u003e { self.assert()?; self.role.election_duration += 1; if self.role.election_duration \u003e= self.role.election_timeout { self.campaign()?; } Ok(self.into()) } compaign\n在compaign当中，逻辑按照小论文当中实现：\n自增term 为自己投一票 持久化保存term 发送Message，向其他的节点请求投票，发送一条Event类型为SolicitVote类型的Message 1 2 3 4 5 6 7 8 9 10 11 12 13 14 /// Campaign for leadership by increasing the term, voting for ourself, and /// soliciting votes from all peers. pub(super) fn campaign(\u0026mut self) -\u003e Result\u003c()\u003e { let term = self.term + 1; info!(\"Starting new election for term {}\", term); self.role = Candidate::new(); self.role.votes.insert(self.id); // vote for ourself self.term = term; self.log.set_term(term, Some(self.id))?; let (last_index, last_term) = self.log.get_last_index(); self.send(Address::Broadcast, Event::SolicitVote { last_index, last_term })?; Ok(()) } SolicitVote\nSolicitVote类型的Message由其他的Follower来处理，对于所有Message的处理，都定义在step()当中，这里逻辑和上面一样，根据节点角色再去进行调用，SolicitVote在follower.step()当中:\n如果当前term投过票了就忽略 做安全性检查，只会给日志状态最新的节点投票 检查通过则投票，并做持久化记录，存储vote for 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 Event::SolicitVote { last_index, last_term } =\u003e { let from = msg.from.unwrap(); // If we already voted for someone else in this term, ignore it. if let Some(voted_for) = self.role.voted_for { if from != voted_for { return Ok(self.into()); } } // Only vote if the candidate's log is at least as up-to-date as // our log. let (log_index, log_term) = self.log.get_last_index(); if last_term \u003e log_term || last_term == log_term \u0026\u0026 last_index \u003e= log_index { info!(\"Voting for {} in term {} election\", from, self.term); self.send(Address::Node(from), Event::GrantVote)?; self.log.set_term(self.term, Some(from))?; self.role.voted_for = Some(from); } } /// 定义在log当中，用于对term和vote_for进行持久化存储 /// Sets the most recent term, and cast vote (if any). pub fn set_term(\u0026mut self, term: Term, voted_for: Option\u003cNodeID\u003e) -\u003e Result\u003c()\u003e { self.engine.set(\u0026Key::TermVote.encode()?, bincode::serialize(\u0026(term, voted_for))?)?; self.maybe_flush() } BecomeLeader\n当candidate接收到Follower的投票回复之后，会记录票数，如果达到了quorum，那么就转换为leader，这一部分的逻辑同样是定义在step当中\n当选为Leader之后，更新一些信息之后，会发送心跳信息告知其他的节点Leader已经当选。 之后会追加一条no-op，non-op的作用已经在上文角色切换部分解释了。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 Event::GrantVote =\u003e { self.role.votes.insert(msg.from.unwrap()); if self.role.votes.len() as u64 \u003e= self.quorum() { return Ok(self.become_leader()?.into()); } } fn become_leader(self) -\u003e Result\u003cRoleNode\u003cLeader\u003e\u003e { info!(\"Won election for term {}, becoming leader\", self.term); let peers = self.peers.clone(); let (last_index, _) = self.log.get_last_index(); let mut node = self.become_role(Leader::new(peers, last_index)); node.heartbeat()?; // Propose an empty command when assuming leadership, to disambiguate // previous entries in the log. See section 8 in the Raft paper. node.propose(None)?; Ok(node) } toydb当中Leader Election的实现非常简单，基本上完全按照raft小论文当中的描述，像是PreVote，Check Quorum，Leader Lease一概没有，不过这也很符合其toy的定位。\nLog Replication Log 在看日志复制之前，先看一下Log的实现： Log模块并不只存储LogEntry，这里其实是对底层kv存储引擎的封装，所有需要进行持久化的数据都丢到存储引擎当中，包括current_term和vote_for，这里还额外存储了一个commit_index用于在commit时做一个安全校验,Entry是log的基本单位，实现同样是借助枚举来实现的：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 /// A log key, encoded using KeyCode. #[derive(Clone, Debug, PartialEq, Serialize, Deserialize)] pub enum Key { /// A log entry, storing the term and command. Entry(Index), /// Stores the current term and vote (if any). TermVote, /// Stores the current commit index (if any). CommitIndex, } /// A log entry. #[derive(Clone, Debug, PartialEq, Serialize, Deserialize)] pub struct Entry { /// The entry index. pub index: Index, /// The term in which the entry was added. pub term: Term, /// The state machine command. None is used to commit noops during leader election. pub command: Option\u003cVec\u003cu8\u003e\u003e, } Log本体定义如下，包括一个engine用于进行存储，和一些元数据，在初始化时，会从engine当中把元数据给加载出来：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 pub struct Log { /// The underlying storage engine. engine: Box\u003cdyn Engine\u003e, /// The index of the last stored entry. last_index: Index, /// The term of the last stored entry. last_term: Term, /// The index of the last committed entry. commit_index: Index, /// The term of the last committed entry. commit_term: Term, /// Whether to sync writes to disk. sync: bool, } 其中的函数实现，逻辑都比较简单，并且也都提供了丰富的注释，这里就不展开。\nHeartbeat 与6.824当中使用heartbeat来携带日志不同，在toydb当中，heartbeat就仅仅是用于维护leader身份，以及推动follower的commit_index，不会携带log entry。heartbeat的发送逻辑在leader.tick()当中，heartbeat的处理在follower.step()当中：\n接收到了heartbeat就不断将自己转换为follower 根据leader传来到commit_index和自身log的情况，推动commit的进度 1 2 3 4 5 6 7 8 9 10 11 12 13 14 // leader.tick() /// Processes a logical clock tick. pub fn tick(mut self) -\u003e Result\u003cNode\u003e { self.assert()?; self.role.since_heartbeat += 1; if self.role.since_heartbeat \u003e= HEARTBEAT_INTERVAL { self.heartbeat()?; self.role.since_heartbeat = 0; } Ok(self.into()) } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 pub enum Event { /// Leaders send periodic heartbeats to its followers. Heartbeat { /// The index of the leader's last committed log entry. commit_index: Index, /// The term of the leader's last committed log entry. commit_term: Term, }, /// ...... /// ...... } // follower.step()当中处理心跳信息 // The leader will send periodic heartbeats. If we don't have a // leader in this term yet, follow it. If the commit_index advances, // apply state transitions. Event::Heartbeat { commit_index, commit_term } =\u003e { // Check that the heartbeat is from our leader. let from = msg.from.unwrap(); match self.role.leader { Some(leader) =\u003e assert_eq!(from, leader, \"Multiple leaders in term\"), None =\u003e self = self.become_follower(Some(from), msg.term)?, } // Advance commit index and apply entries if possible. let has_committed = self.log.has(commit_index, commit_term)?; let (old_commit_index, _) = self.log.get_commit_index(); if has_committed \u0026\u0026 commit_index \u003e old_commit_index { self.log.commit(commit_index)?; let mut scan = self.log.scan((old_commit_index + 1)..=commit_index)?; // 与状态机进行交互 while let Some(entry) = scan.next().transpose()? { self.state_tx.send(Instruction::Apply { entry })?; } } self.send(msg.from, Event::ConfirmLeader { commit_index, has_committed })?; } Log Replication Log Replication的入口在Leader.step()当中，Leader会处理由Client发送而来的请求，在这里会调用propose()，在propose当中，真正开始进行日志复制，将命令转换为日志存储到本地，之后再发送给其他的节点：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 // leader.step() 接受客户端请求 Event::ClientRequest { id, request: Request::Mutate(command) } =\u003e { let index = self.propose(Some(command))?; self.state_tx.send(Instruction::Notify { id, address: msg.from, index })?; if self.peers.is_empty() { self.maybe_commit()?; } } // propose，真正开始日志复制的逻辑 /// Proposes a command for consensus by appending it to our log and /// replicating it to peers. If successful, it will eventually be committed /// and applied to the state machine. pub(super) fn propose(\u0026mut self, command: Option\u003cVec\u003cu8\u003e\u003e) -\u003e Result\u003cIndex\u003e { let index = self.log.append(self.term, command)?; for peer in self.peers.clone() { self.send_log(peer)?; } Ok(index) } Progress Progress的含义是，站在Leader的角度，观察到的follower的复制进度，定义了next_index和match_index，之后使用一个HashMap来管理各个节点的进度,由于和etcd相比少了流水线发送和滑动窗口流量控制等，Progress的实现简单了很多：\n1 2 3 4 5 6 7 8 9 10 11 12 13 struct Progress { /// The next index to replicate to the peer. next: Index, /// The last index known to be replicated to the peer. last: Index, } pub struct Leader { /// Peer replication progress. progress: HashMap\u003cNodeID, Progress\u003e, /// Number of ticks since last periodic heartbeat. since_heartbeat: Ticks, } propose 在propose当中，会首先将日志持久化到本地，之后调用send_log()进行发送，在send_log()当中，会根据Progress找到需要发送的日志，之后从本地进行读取。\n根据progress获取到next之后，先从本地读取next - 1的Entry，next - 1的Entry是用于检测日志冲突的，理应存在于Leader本地 扫描出next之后的所有Entry，连同base_index和base_term封装成一条AppendEntries发送给follower 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 /// Sends pending log entries to a peer. fn send_log(\u0026mut self, peer: NodeID) -\u003e Result\u003c()\u003e { let (base_index, base_term) = match self.role.progress.get(\u0026peer) { Some(Progress { next, .. }) if *next \u003e 1 =\u003e match self.log.get(next - 1)? { Some(entry) =\u003e (entry.index, entry.term), None =\u003e panic!(\"Missing base entry {}\", next - 1), }, Some(_) =\u003e (0, 0), None =\u003e panic!(\"Unknown peer {}\", peer), }; let entries = self.log.scan((base_index + 1)..)?.collect::\u003cResult\u003cVec\u003c_\u003e\u003e\u003e()?; debug!(\"Replicating {} entries at base {} to {}\", entries.len(), base_index, peer); self.send(Address::Node(peer), Event::AppendEntries { base_index, base_term, entries })?; Ok(()) } AppendEntries Leader封装了一条AppendEntries发送给Follower，相对应的就在Follower.step()当中进行处理：\n能够接收到AppendEntries证明能够确认Leader，因此就调用become_follower()更新自身状态，对Leader进行跟随 尝试匹配日志，并将其应用于自身，如果不匹配则返回一条Reject，让Leader再去做backup，找到正确的日志 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 // Replicate entries from the leader. If we don't have a leader in // this term yet, follow it. Event::AppendEntries { base_index, base_term, entries } =\u003e { // Check that the entries are from our leader. let from = msg.from.unwrap(); match self.role.leader { Some(leader) =\u003e assert_eq!(from, leader, \"Multiple leaders in term\"), None =\u003e self = self.become_follower(Some(from), msg.term)?, } // Append the entries, if possible. if base_index \u003e 0 \u0026\u0026 !self.log.has(base_index, base_term)? { debug!(\"Rejecting log entries at base {}\", base_index); self.send(msg.from, Event::RejectEntries)? } else { let last_index = self.log.splice(entries)?; self.send(msg.from, Event::AcceptEntries { last_index })? } } 在Leader端的处理分为两种，分别是成功响应的Event::AppendEntries和EventRejectEntries：\n如果Follower能够成功匹配日志，那么Leader就会去更新进度，并且计算quorum，尝试进行commit 如果匹配失败，在Leader端progress向前回退一个，再尝试发送日志，进行探测，直至找到找到正确的位置，这里是没有实现的fast backup的，在效率上会存在一定的问题 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 Event::AcceptEntries { last_index } =\u003e { assert!( last_index \u003c= self.log.get_last_index().0, \"Follower accepted entries after last index\" ); let from = msg.from.unwrap(); self.role.progress.entry(from).and_modify(|p| { p.last = last_index; p.next = last_index + 1; }); self.maybe_commit()?; } // A follower rejected log entries we sent it, typically because it // does not have the base index in its log. Try to replicate from // the previous entry. // // This linear probing, as described in the Raft paper, can be very // slow with long divergent logs, but we keep it simple. Event::RejectEntries =\u003e { let from = msg.from.unwrap(); self.role.progress.entry(from).and_modify(|p| { if p.next \u003e 1 { p.next -= 1 } }); self.send_log(from)?; } Commit 每次Leader确定了有follower保存了日志之后就会尝试进行commit，在rust当中，借助函数式编程，能将这个过程写的很优雅(没接触过函数式编程看了想骂娘)：\n首先获取到progress的HashMap，之后获取到HashMap的所有value(value是一个next_index和last_index组成的元组) 再做一个转换，获取last_index，这一步会得到一个由所有last_index组成的迭代器 之后使用chain将leader的last_index追加进去，最后转换为Vec 排序并反转之后第quorum大的last_index就是与follower达成共识的index 在vscode当中，rust-analyzer能够很清楚的显示出每一步都得到了什么： 获取到commit_index之后做一些校验：\n此次计算出的commit_index要大于上一次的commit_index 获取出 commit_index 对应的 entry，判断是不是当前的 Term，Leader 只能提交属于自己任期的日志 (见 raft 小论文 figure 8) 如果是新的commit_index，就在本地进行记录，并且扫描出从上一次commit到新commit_index之间的所有的日志，向上层状态机进行apply，即向state_tx channel当中发送一条信息\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 // Make sure the commit index does not regress. let (prev_commit_index, _) = self.log.get_commit_index(); assert!( commit_index \u003e= prev_commit_index, \"Commit index regression {} -\u003e {}\", prev_commit_index, commit_index ); // We can only safely commit up to an entry from our own term, see // figure 8 in Raft paper. match self.log.get(commit_index)? { Some(entry) if entry.term == self.term =\u003e {} Some(_) =\u003e return Ok(prev_commit_index), None =\u003e panic!(\"Commit index {} missing\", commit_index), }; // Commit and apply the new entries. if commit_index \u003e prev_commit_index { self.log.commit(commit_index)?; // TODO: Move application elsewhere, but needs access to applied index. let mut scan = self.log.scan((prev_commit_index + 1)..=commit_index)?; while let Some(entry) = scan.next().transpose()? { self.state_tx.send(Instruction::Apply { entry })?; } } Summary 以上就是toydb当中Raft模块的全部内容，这里的Raft模块指的是Raft本身的逻辑部分，不包括上层的状态机和发送命令的Client，这一部分笔者留到下一章的sql engine当中进行分析，最后以toydb与MIT6.824以及etcd进行一个简单的对比，来结束这一章\nMIT-6.824\n在MIT-6.824的Lab2当中，实现了一个基础的Raft模块，在其中几乎完整的复现了《In Search of an Understandable Consensus Algorithm (Extended Version)》一文，但没有实现集群配置变更，并且在持久化和snapshot上做了简化。\n但是MIT6.824当中的实现并不是那么工程化，或者说接近生产环境，虽然每个人的实现方式不同，但是至少初始框架是这样的，相比于Tinykv来说。在6.824当中，在需要通信的时候就直接发送rpc调用对应的函数，以一种很直观的方式复现了Raft，当中定义的函数也都遵循论文当中figure2，基本上把figure2翻译成golang就能实现出来。\netcd/raft\netcd/raft作为一个投入生产环境的raft package，代码结构自然是清晰严谨的。\n在基础结构上，etcd/raft将raft视为一个状态机，上层给予Raft一些输入，如tick或者message，Raft就会根据输入作出一些响应，更改自身状态，最后提供一些输出，上层处理完输出之后再调用Advance来继续推进Raft去更新状态。\n在etcd当中，raft package仅提供raft的逻辑，如如何进行选举和发送日志，但是如持久化存储，网络通信都由上层应用负责，raft package通过Ready将需要存储的日志，快照，以及需要发送的消息交给上层。\n在结构上，etcd/raft以Message为主体和驱动，整个Raft的执行流程就是在tick的驱动下，不断的执行和发送Message的过程，并不会像MIT6.824当中那样在一个函数当中能看到完整的rpc调用和处理流程，每个Message只会负责整体逻辑的一部分，执行完自己的内容就生成一个新的Message发送，其他拿到这条Message的来完成这个事件的剩余逻辑，举个例子，在进行选举时：\ncandidate首先会向其他节点发送一个请求投票的Message，此时candidate目前负责的逻辑已经执行结束，candidate可以去执行其他内容 follower受到candidate发送的Message就会进行处理，投票或者忽略，同样将结果封装成一条Message再发送给candidate Candidate 再收到 Message 之后继续完成剩余的逻辑，统计投票，决定是否当选 整个执行过程是松散、非连续的。但是主体逻辑全部使用 Message 来承载的话，整体结构就会非常清晰，raft 只需要不断的处理 Message 即可，并在适当的时候产生新的 Message\n在实现上，etcd/raft完整的实现了Raft小论文当中的内容，包括在MIT-6.824当中没有实现的集群变更，并且对于Raft大论文《CONSENSUS: BRIDGING THEORY AND PRACTICE》当中的优化也进行了实现：\n在结构上：采用了批处理的形式，即Ready会向上层返回一批需要处理数据，上层用户进行集中处理，在Raft运行的过程中，只需要把log添加到对应的位置，将需要发送的Message放入“信箱”，届时一并通过Ready返回(这个其实和Raft大论文没什么关系，只不过都是优化就一并提一下了) 在选举部分：ectd/raft实现了PreVote、Check Quorum、Leader Lease的优化 在日志复制上，ectd/raft采用了流水线设计，会在阻塞探测模式，流水线发送，快照发送三种模式下切换，在流水线模式下，etcd/raft可以在未接收到上次发送日志响应的情况下继续发送日志，并且使用滑动窗口来进行流量控制。并且在日志发送时，采用并行发送的方式，即存储与发送并行，可以在本地还未进行持久化存储的情况下就发送，某些情况下，follower可能在leader存储日志之前就接收到日志。在日志不匹配时，follower会返回一个hint，从而Leader可以快速进行回退，找到正确的位置。 在线性一致性读上，提供了 ReadIndex 和 Lease Read 两种方式，以绕过 Log Read，提高系统吞吐量 如果想进一步了解etcd/raft的话，推荐看这一系列，就像其名字一样，深入浅出：深入浅出etcd/raft —— 0x00 引言 - 叉鸽 MrCroxx 的博客 toydb 内容上，toydb相比于Raft小论文和MIT-6.824有所删减，同样没有实现集群成员变更，此外，没有实现日志的快速回退，和快照功能。而etcd当中的种种优化就更没有了(toydb通过Raft状态机实现了一个ReadIndex的功能，其他的就都没有了)\n在结构上toydb基本上与etcd/raft一致，使用逻辑时钟+Message进行驱动，上面对etcd的分析对toydb基本上都适用。只不过toydb的持久化是由Raft自己负责的，所有与持久化相关的内容都扔进kv存储引擎当中，无论是元数据还是日志。但是网络模块是在上层实现的，在Raft当中也是和etcd一样，只需要把Message塞入信箱即可。\n总的来说，toydb做了一个很好的取舍，用非常工程化的结构实现了一个几乎没有任何优化的，简单的Raft模块，代码逻辑非常的清晰，当然代价就是会损失一定的性能，如同步进行持久化，和日志出现不匹配时需要一条条进行回退。不过作为一个Learning Project，个人认为还是实现的非常优雅的，很值得用来学习。\n对于Raft上层状态机和Client的相关内容，涉及到比较复杂的通信和异步编程，限于篇幅就不再本章当中进行分析，会留在下一章的kv engine当中一并进行分析。\n由于分布式系统比较复杂，在toydb当中，在client，Raft，以及Raft状态机之间的逻辑比较复杂，涉及到大量的异步编程和信息交换，笔者水平有限，难免会出现错误，欢迎读者进行批评指正，再完成了Raft状态机部分，我也会重新校验整理这篇文章，以求达到一个更好的效果。\n",
  "wordCount" : "12965",
  "inLanguage": "en",
  "datePublished": "2023-12-28T09:31:59Z",
  "dateModified": "2023-12-28T09:31:59Z",
  "author":{
    "@type": "Person",
    "name": "Fischer"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://fischer0522.github.io/en/posts/tech/toydb/03-raft/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Fischer's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://fischer0522.github.io/img/Navigation.svg"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://fischer0522.github.io/en/" accesskey="h" title="Fischer&#39;s Blog (Alt + H)">
                <img src="https://fischer0522.github.io/img/Navigation.svg" alt="" aria-label="logo"
                    height="35">Fischer&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://fischer0522.github.io/en/search" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://fischer0522.github.io/en/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://fischer0522.github.io/en/posts" title="Posts">
                    <span>Posts</span>
                </a>
            </li>
            <li>
                <a href="https://fischer0522.github.io/en/archives/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="https://fischer0522.github.io/en/tags" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://fischer0522.github.io/en/about" title="About">
                    <span>About</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://fischer0522.github.io/en/">Home</a>&nbsp;»&nbsp;<a href="https://fischer0522.github.io/en/posts/">Blog</a>&nbsp;»&nbsp;<a href="https://fischer0522.github.io/en/posts/tech/">Tech</a>&nbsp;»&nbsp;<a href="https://fischer0522.github.io/en/posts/tech/toydb/">toydb</a></div>
    <h1 class="post-title entry-hint-parent">
      03-Raft
    </h1>
    <div class="post-meta"><span title='2023-12-28 09:31:59 +0000 UTC'>2023-12-28</span>&nbsp;·&nbsp;26 min&nbsp;·&nbsp;Fischer

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#message" aria-label="Message">Message</a></li>
                <li>
                    <a href="#node" aria-label="Node">Node</a><ul>
                        
                <li>
                    <a href="#%e8%a7%92%e8%89%b2%e5%88%87%e6%8d%a2" aria-label="角色切换">角色切换</a></li>
                <li>
                    <a href="#%e6%b6%88%e6%81%af%e8%bd%ac%e5%8f%91" aria-label="消息转发">消息转发</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%88%9d%e5%a7%8b%e5%8c%96" aria-label="初始化">初始化</a></li>
                <li>
                    <a href="#leader-election" aria-label="Leader Election">Leader Election</a></li>
                <li>
                    <a href="#log-replication" aria-label="Log Replication">Log Replication</a><ul>
                        
                <li>
                    <a href="#log" aria-label="Log">Log</a></li>
                <li>
                    <a href="#heartbeat" aria-label="Heartbeat">Heartbeat</a></li>
                <li>
                    <a href="#log-replication-1" aria-label="Log Replication">Log Replication</a><ul>
                        
                <li>
                    <a href="#propose" aria-label="propose">propose</a></li>
                <li>
                    <a href="#appendentries" aria-label="AppendEntries">AppendEntries</a></li>
                <li>
                    <a href="#commit" aria-label="Commit">Commit</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#summary" aria-label="Summary">Summary</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>toydb的Raft实现，相比于6.824更接近于生产级别的，和etcd/raft在结构上比较相似，但是并没有实现Raft大论文当中的优化，并且相比Raft小论文也砍掉了一些优化，比如fast backup,snapshot等。不过在写法上还是很有rust的味道的。可以分为一下几个模块：</p>
<ul>
<li>Node：分别定义Leader、Candidate、Follower各自的行为和通用的行为(定义在mod.rs当中)</li>
<li>log：以kv engine作为底层，持久化存储Raft的log，同时也会用于持久化存储元数据，所有需要进行持久化存储的都会使用log模块</li>
<li>State：Raft状态机，构建于Raft之上，相当于6.824当中的Lab3</li>
<li>Server：通信模块，负责与其他Raft节点之间进行通信，基于tcp实现
在本章当中，笔者会首先分析toydb当中的Raft的一些基础模块，之后再按照选举和日志复制的逻辑来进行分析Raft的逻辑。对于Raft本身，笔者不会做过多介绍，如果想了解Raft本身建议看Raft小论文/大论文，6.824</li>
<li><a href="https://raft.github.io/raft.pdf">raft.pdf</a></li>
<li><a href="https://web.stanford.edu/~ouster/cgi-bin/papers/OngaroPhD.pdf">web.stanford.edu/~ouster/cgi-bin/papers/OngaroPhD.pdf</a></li>
</ul>
<h2 id="message">Message<a hidden class="anchor" aria-hidden="true" href="#message">#</a></h2>
<p>在toydb当中，Raft模块使用Event作为事件的载体，而Message为Event的封装，整个Raft的执行过程就是不断处理Message的过程，这与etcd当中的设计非常相似，所以先来看一下Message相关内容，定义在<code>src/raft/message.rs</code>当中。</p>
<p>Message的发送目标采用一个枚举来表示</p>
<ul>
<li>Broadcast：为广播类型，需要发送给所有的节点</li>
<li>Node：为单独发送，指定NodeID，在上层网络模块再转换成ip进行发送</li>
<li>Client：用于回复Client</li>
</ul>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">#[derive(Clone, Copy, Debug, Eq, Hash, PartialEq, Serialize, Deserialize)]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">enum</span> <span style="color:#a6e22e">Address</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// Broadcast to all peers. Only valid as an outbound recipient (to).
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    Broadcast,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// A node with the specified node ID (local or remote). Valid both as
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#e6db74">/// sender and recipient.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    Node(NodeID),
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// A local client. Can only send ClientRequest messages, and receive
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#e6db74">/// ClientResponse messages.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    Client,
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Message定义为一个结构体,其中包含发送Message时的Term，发送方与接收方，以及Event</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#e6db74">/// A message passed between Raft nodes.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span><span style="color:#75715e">#[derive(Clone, Debug, PartialEq, Serialize, Deserialize)]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Message</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// The current term of the sender. Must be set, unless the sender is
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#e6db74">/// Address::Client, in which case it must be 0.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#66d9ef">pub</span> term: <span style="color:#a6e22e">Term</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// The sender address.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#66d9ef">pub</span> from: <span style="color:#a6e22e">Address</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// The recipient address.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#66d9ef">pub</span> to: <span style="color:#a6e22e">Address</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// The message payload.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#66d9ef">pub</span> event: <span style="color:#a6e22e">Event</span>,
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Message的主体是<code>Event</code>，<code>Event</code>定义为一个枚举类型，在其中表示了Raft当中的所有事件，如果需要额外的信息，就封装成一个结构体，否则设置成一个枚举字段即可。如心跳信息，candidate开启选举等等，在代码当中每一种类型都给出了详细的注释，读者可自行阅读</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">#[derive(Clone, Debug, PartialEq, Serialize, Deserialize)]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">enum</span> <span style="color:#a6e22e">Event</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// Leaders send periodic heartbeats to its followers.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    Heartbeat {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">/// The index of the leader&#39;s last committed log entry.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>        commit_index: <span style="color:#a6e22e">Index</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">/// The term of the leader&#39;s last committed log entry.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>        commit_term: <span style="color:#a6e22e">Term</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// Followers confirm loyalty to leader after heartbeats.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    ConfirmLeader {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">/// The commit_index of the original leader heartbeat, to confirm
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>        <span style="color:#e6db74">/// read requests.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>        commit_index: <span style="color:#a6e22e">Index</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">/// If false, the follower does not have the entry at commit_index
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>        <span style="color:#e6db74">/// and would like the leader to replicate it.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>        has_committed: <span style="color:#66d9ef">bool</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// Candidates solicit votes from all peers when campaigning for leadership.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    SolicitVote {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// The index of the candidate&#39;s last stored log entry
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        last_index: <span style="color:#a6e22e">Index</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// The term of the candidate&#39;s last stored log entry
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        last_term: <span style="color:#a6e22e">Term</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// Followers may grant a single vote to a candidate per term, on a
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#e6db74">/// first-come basis. Candidates implicitly vote for themselves.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    GrantVote,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// Leaders replicate log entries to followers by appending it to their log.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    AppendEntries {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">/// The index of the log entry immediately preceding the submitted commands.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>        base_index: <span style="color:#a6e22e">Index</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">/// The term of the log entry immediately preceding the submitted commands.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>        base_term: <span style="color:#a6e22e">Term</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">/// Commands to replicate.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>        entries: Vec<span style="color:#f92672">&lt;</span>Entry<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// Followers may accept a set of log entries from a leader.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    AcceptEntries {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">/// The index of the last log entry.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>        last_index: <span style="color:#a6e22e">Index</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// Followers may also reject a set of log entries from a leader.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    RejectEntries,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// A client request. This can be submitted to the leader, or to a follower
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#e6db74">/// which will forward it to its leader. If there is no leader, or the
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#e6db74">/// leader or term changes, the request is aborted with an Error::Abort
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#e6db74">/// ClientResponse and the client must retry.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    ClientRequest {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">/// The request ID. This is arbitrary, but must be globally unique for
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>        <span style="color:#e6db74">/// the duration of the request.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>        id: <span style="color:#a6e22e">RequestID</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">/// The request.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>        request: <span style="color:#a6e22e">Request</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// A client response.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    ClientResponse {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">/// The response ID. This matches the ID of the ClientRequest.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>        id: <span style="color:#a6e22e">RequestID</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">/// The response, or an error.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>        response: Result<span style="color:#f92672">&lt;</span>Response<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>对比一下etcd当中的Message类型,在rust当中使用enum Event进行封装是不是简洁很多呢，event同一事件只会有一种类型和数据，避免携带不必要的数据。</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Message</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Type</span> <span style="color:#a6e22e">MessageType</span> <span style="color:#e6db74">`protobuf:&#34;varint,1,opt,name=type,enum=raftpb.MessageType&#34; json:&#34;type&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">To</span>   <span style="color:#66d9ef">uint64</span>      <span style="color:#e6db74">`protobuf:&#34;varint,2,opt,name=to&#34; json:&#34;to&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">From</span> <span style="color:#66d9ef">uint64</span>      <span style="color:#e6db74">`protobuf:&#34;varint,3,opt,name=from&#34; json:&#34;from&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Term</span> <span style="color:#66d9ef">uint64</span>      <span style="color:#e6db74">`protobuf:&#34;varint,4,opt,name=term&#34; json:&#34;term&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// logTerm is generally used for appending Raft logs to followers. For example,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// (type=MsgApp,index=100,logTerm=5) means leader appends entries starting at
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// index=101, and the term of entry at index 100 is 5.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// (type=MsgAppResp,reject=true,index=100,logTerm=5) means follower rejects some
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// entries from its leader as it already has an entry with term 5 at index 100.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">LogTerm</span>    <span style="color:#66d9ef">uint64</span>   <span style="color:#e6db74">`protobuf:&#34;varint,5,opt,name=logTerm&#34; json:&#34;logTerm&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Index</span>      <span style="color:#66d9ef">uint64</span>   <span style="color:#e6db74">`protobuf:&#34;varint,6,opt,name=index&#34; json:&#34;index&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Entries</span>    []<span style="color:#a6e22e">Entry</span>  <span style="color:#e6db74">`protobuf:&#34;bytes,7,rep,name=entries&#34; json:&#34;entries&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Commit</span>     <span style="color:#66d9ef">uint64</span>   <span style="color:#e6db74">`protobuf:&#34;varint,8,opt,name=commit&#34; json:&#34;commit&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Snapshot</span>   <span style="color:#a6e22e">Snapshot</span> <span style="color:#e6db74">`protobuf:&#34;bytes,9,opt,name=snapshot&#34; json:&#34;snapshot&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Reject</span>     <span style="color:#66d9ef">bool</span>     <span style="color:#e6db74">`protobuf:&#34;varint,10,opt,name=reject&#34; json:&#34;reject&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">RejectHint</span> <span style="color:#66d9ef">uint64</span>   <span style="color:#e6db74">`protobuf:&#34;varint,11,opt,name=rejectHint&#34; json:&#34;rejectHint&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Context</span>    []<span style="color:#66d9ef">byte</span>   <span style="color:#e6db74">`protobuf:&#34;bytes,12,opt,name=context&#34; json:&#34;context,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="node">Node<a hidden class="anchor" aria-hidden="true" href="#node">#</a></h2>
<p>Node这一部分表示在Raft运行过程中，Raft节点的角色和执行动作，在这一部分仅简单介绍涉及到的结构体，而执行逻辑分为选举和日志复制两部分进行分析。</p>
<p>toydb当中使用RoleNode来表示节点的状态和角色,其中:</p>
<ul>
<li>log为一个与kv engine交互的模块，负责所有持久化存储的工作</li>
<li>node_tx用于进行节点之间的通信(节点之间真实传输使用的是tcp，这个mpsc更像是一个信箱，将Message添加到其中，等待之后发送，这一部分的设计也与etcd相同，不过etcd是一个批处理的形式，会攒一波消息一同发送)</li>
<li>state_tx用于与上层状态机进行通信</li>
</ul>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">// A Raft node with role R
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">RoleNode</span><span style="color:#f92672">&lt;</span>R<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>    id: <span style="color:#a6e22e">NodeID</span>,
</span></span><span style="display:flex;"><span>    peers: <span style="color:#a6e22e">HashSet</span><span style="color:#f92672">&lt;</span>NodeID<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>    term: <span style="color:#a6e22e">Term</span>,
</span></span><span style="display:flex;"><span>    log: <span style="color:#a6e22e">Log</span>,
</span></span><span style="display:flex;"><span>    node_tx: <span style="color:#a6e22e">mpsc</span>::UnboundedSender<span style="color:#f92672">&lt;</span>Message<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>    state_tx: <span style="color:#a6e22e">mpsc</span>::UnboundedSender<span style="color:#f92672">&lt;</span>Instruction<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>    role: <span style="color:#a6e22e">R</span>,
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Role代表当前节点的角色，分别有<code>Leader</code>、<code>Candidate</code>、<code>Follower</code>，封装了一些每种不同角色特有的内容：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Leader</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// Peer replication progress.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    progress: <span style="color:#a6e22e">HashMap</span><span style="color:#f92672">&lt;</span>NodeID, Progress<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// Number of ticks since last periodic heartbeat.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    since_heartbeat: <span style="color:#a6e22e">Ticks</span>,
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Follower</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// The leader, or None if just initialized.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    leader: Option<span style="color:#f92672">&lt;</span>NodeID<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// The number of ticks since the last message from the leader.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    leader_seen: <span style="color:#a6e22e">Ticks</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// The leader_seen timeout before triggering an election.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    election_timeout: <span style="color:#a6e22e">Ticks</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// The node we voted for in the current term, if any.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    voted_for: Option<span style="color:#f92672">&lt;</span>NodeID<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Local client requests that have been forwarded to the leader. These are
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// aborted on leader/term changes.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">pub</span>(<span style="color:#66d9ef">super</span>) forwarded: <span style="color:#a6e22e">HashSet</span><span style="color:#f92672">&lt;</span>RequestID<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Candidate</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// Votes received (including ourself).
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    votes: <span style="color:#a6e22e">HashSet</span><span style="color:#f92672">&lt;</span>NodeID<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// Ticks elapsed since election start.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    election_duration: <span style="color:#a6e22e">Ticks</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// Election timeout, in ticks.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    election_timeout: <span style="color:#a6e22e">Ticks</span>,
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>在RoleNode当中，配备了几个基础的函数，后面流程中可能用到，先提一下，都比较简单：</p>
<ul>
<li><code>become_role()</code>:切换角色，更新role</li>
<li><code>quorum()</code>:计算集群“大多数”的数量</li>
<li><code>send()</code>:将Message塞入信箱当中，之后会被读取并发送</li>
<li><code>assert_node()</code>:检查当前的term与持久化存储的term是否相同</li>
<li><code>assert_step()</code>:在step函数处理Message之前先对Message进行校验
<ol>
<li>检查Message的接收方：判断是否应该由当前节点处理，step函数不应该处理发送给client的Message和不属于自己的Message</li>
<li>检查Message的发送方：不应该有Broadcast类型的发送方，Broadcast只应该作为接收方存在；对client发送的Message进行检查；检查由其他节点发送而来的消息，该节点是妇女存在于集群当中，以及需要携带term</li>
</ol>
</li>
</ul>
<h3 id="角色切换">角色切换<a hidden class="anchor" aria-hidden="true" href="#角色切换">#</a></h3>
<p><strong>Leader</strong></p>
<p>Leader只有一种角色切换，即接收到更高的term从而退位，转换成follower，定义在<code>RoleNode&lt;Leader&gt;.become_follower()</code>当中,由于因为检测到更高的term，因此需要更新自身的term并进行持久化的工作：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>    <span style="color:#e6db74">/// Transforms the leader into a follower. This can only happen if we find a
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#e6db74">/// new term, so we become a leaderless follower.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">become_follower</span>(<span style="color:#66d9ef">mut</span> self, term: <span style="color:#a6e22e">Term</span>) -&gt; Result<span style="color:#f92672">&lt;</span>RoleNode<span style="color:#f92672">&lt;</span>Follower<span style="color:#f92672">&gt;&gt;</span> {
</span></span><span style="display:flex;"><span>        assert!(term <span style="color:#f92672">&gt;=</span> self.term, <span style="color:#e6db74">&#34;Term regression {} -&gt; {}&#34;</span>, self.term, term);
</span></span><span style="display:flex;"><span>        assert!(term <span style="color:#f92672">&gt;</span> self.term, <span style="color:#e6db74">&#34;Can only become follower in later term&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        info!(<span style="color:#e6db74">&#34;Discovered new term {}&#34;</span>, term);
</span></span><span style="display:flex;"><span>        self.term <span style="color:#f92672">=</span> term;
</span></span><span style="display:flex;"><span>        self.log.set_term(term, None)<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>        self.state_tx.send(Instruction::Abort)<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>        Ok(self.become_role(Follower::new(None, None)))
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Candidate</strong></p>
<p>candidate在输掉选举之后或者接收到更高的Term就会转换为Follower：</p>
<ul>
<li>在输掉选举时，会接收到新的Leader的Heartbeat，因此可以知道新的Leader是谁，更新自身状态时将当前的Leader保存</li>
<li>接收到更高Term时，有可能只是其他进度更新的Follower给予的回应，因此无法得知Leader是谁</li>
</ul>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>    <span style="color:#e6db74">/// Transforms the node into a follower. We either lost the election
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#e6db74">/// and follow the winner, or we discovered a new term in which case
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#e6db74">/// we step into it as a leaderless follower.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">become_follower</span>(<span style="color:#66d9ef">mut</span> self, term: <span style="color:#a6e22e">Term</span>, leader: Option<span style="color:#f92672">&lt;</span>NodeID<span style="color:#f92672">&gt;</span>) -&gt; Result<span style="color:#f92672">&lt;</span>RoleNode<span style="color:#f92672">&lt;</span>Follower<span style="color:#f92672">&gt;&gt;</span> {
</span></span><span style="display:flex;"><span>        assert!(term <span style="color:#f92672">&gt;=</span> self.term, <span style="color:#e6db74">&#34;Term regression {} -&gt; {}&#34;</span>, self.term, term);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> Some(leader) <span style="color:#f92672">=</span> leader {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// We lost the election, follow the winner.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            assert_eq!(term, self.term, <span style="color:#e6db74">&#34;Can&#39;t follow leader in different term&#34;</span>);
</span></span><span style="display:flex;"><span>            info!(<span style="color:#e6db74">&#34;Lost election, following leader {} in term {}&#34;</span>, leader, term);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> voted_for <span style="color:#f92672">=</span> Some(self.id); <span style="color:#75715e">// by definition
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            Ok(self.become_role(Follower::new(Some(leader), voted_for)))
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// We found a new term, but we don&#39;t necessarily know who the leader
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#75715e">// is yet. We&#39;ll find out when we step a message from it.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            assert_ne!(term, self.term, <span style="color:#e6db74">&#34;Can&#39;t become leaderless follower in current term&#34;</span>);
</span></span><span style="display:flex;"><span>            info!(<span style="color:#e6db74">&#34;Discovered new term {}&#34;</span>, term);
</span></span><span style="display:flex;"><span>            self.term <span style="color:#f92672">=</span> term;
</span></span><span style="display:flex;"><span>            self.log.set_term(term, None)<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>            Ok(self.become_role(Follower::new(None, None)))
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></td></tr></table>
</div>
</div><p>candidate如果能够成功当选，那么就可以转换为Leader，上线之后发送心跳信息并且追加一条non-op，，追加的non-op的原因在raft论文当中作出了解释，这里简单提一下，Raft不能够提交自己任期以外的日志，只能够在提交当前任期的日志时顺带提交之前的日志，否则会出现提交日志被覆盖的安全性问题(具体样例见论文figure 8)，如果开启read index线性一致性读优化的情况下，系统如果不收到写请求就无法提交之前的日志，从而阻塞系统状态(读写都会被阻塞，read index 需要Leader在当前任期提交过日志之后才能执行)，non-op可以尽快恢复系统状态。</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>    <span style="color:#e6db74">/// Transition to leader role.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">become_leader</span>(self) -&gt; Result<span style="color:#f92672">&lt;</span>RoleNode<span style="color:#f92672">&lt;</span>Leader<span style="color:#f92672">&gt;&gt;</span> {
</span></span><span style="display:flex;"><span>        info!(<span style="color:#e6db74">&#34;Won election for term {}, becoming leader&#34;</span>, self.term);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> peers <span style="color:#f92672">=</span> self.peers.clone();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> (last_index, _) <span style="color:#f92672">=</span> self.log.get_last_index();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> node <span style="color:#f92672">=</span> self.become_role(Leader::new(peers, last_index));
</span></span><span style="display:flex;"><span>        node.heartbeat()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Propose an empty command when assuming leadership, to disambiguate
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// previous entries in the log. See section 8 in the Raft paper.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        node.propose(None)<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>        Ok(node)
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Follower</strong></p>
<p>Follower在选举超时时会转换为Candidate，并且调用<code>compaign()</code>开始选举。</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">become_candidate</span>(<span style="color:#66d9ef">mut</span> self) -&gt; Result<span style="color:#f92672">&lt;</span>RoleNode<span style="color:#f92672">&lt;</span>Candidate<span style="color:#f92672">&gt;&gt;</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Abort any forwarded requests. These must be retried with new leader.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        self.abort_forwarded()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> node <span style="color:#f92672">=</span> self.become_role(Candidate::new());
</span></span><span style="display:flex;"><span>        node.campaign()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>        Ok(node)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// Processes a logical clock tick.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">tick</span>(<span style="color:#66d9ef">mut</span> self) -&gt; Result<span style="color:#f92672">&lt;</span>Node<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>        self.assert()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self.role.leader_seen <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self.role.leader_seen <span style="color:#f92672">&gt;=</span> self.role.election_timeout {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> Ok(self.become_candidate()<span style="color:#f92672">?</span>.into());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        Ok(self.into())
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></td></tr></table>
</div>
</div><p>Follower在接受到Leader的Heartbeat、AppendEntries时，或者更高的Term的消息时，都会更新自身状态进行跟随</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>    <span style="color:#e6db74">/// Transforms the node into a follower, either a leaderless follower in a
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#e6db74">/// new term or following a leader in the current term.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">become_follower</span>(<span style="color:#66d9ef">mut</span> self, leader: Option<span style="color:#f92672">&lt;</span>NodeID<span style="color:#f92672">&gt;</span>, term: <span style="color:#a6e22e">Term</span>) -&gt; Result<span style="color:#f92672">&lt;</span>RoleNode<span style="color:#f92672">&lt;</span>Follower<span style="color:#f92672">&gt;&gt;</span> {
</span></span><span style="display:flex;"><span>        assert!(term <span style="color:#f92672">&gt;=</span> self.term, <span style="color:#e6db74">&#34;Term regression {} -&gt; {}&#34;</span>, self.term, term);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Abort any forwarded requests. These must be retried with new leader.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        self.abort_forwarded()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> Some(leader) <span style="color:#f92672">=</span> leader {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// We found a leader in the current term.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            assert_eq!(self.role.leader, None, <span style="color:#e6db74">&#34;Already have leader in term&#34;</span>);
</span></span><span style="display:flex;"><span>            assert_eq!(term, self.term, <span style="color:#e6db74">&#34;Can&#39;t follow leader in different term&#34;</span>);
</span></span><span style="display:flex;"><span>            info!(<span style="color:#e6db74">&#34;Following leader {} in term {}&#34;</span>, leader, term);
</span></span><span style="display:flex;"><span>            self.role <span style="color:#f92672">=</span> Follower::new(Some(leader), self.role.voted_for);
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// We found a new term, but we don&#39;t necessarily know who the leader
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#75715e">// is yet. We&#39;ll find out when we step a message from it.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            assert_ne!(term, self.term, <span style="color:#e6db74">&#34;Can&#39;t become leaderless follower in current term&#34;</span>);
</span></span><span style="display:flex;"><span>            info!(<span style="color:#e6db74">&#34;Discovered new term {}&#34;</span>, term);
</span></span><span style="display:flex;"><span>            self.term <span style="color:#f92672">=</span> term;
</span></span><span style="display:flex;"><span>            self.log.set_term(term, None)<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>            self.role <span style="color:#f92672">=</span> Follower::new(None, None);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        Ok(self)
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="消息转发">消息转发<a hidden class="anchor" aria-hidden="true" href="#消息转发">#</a></h3>
<p>在toydb当中，Follower是允许和Client通信的，但是不能够处理信息，Follower需要将消息转发给Leader，Leader处理完之后再由Follower响应Client,这一部分的逻辑在<code>follower.step()</code>当中：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>           <span style="color:#75715e">// Forward client requests to the leader, or abort them if there is
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#75715e">// none (the client must retry).
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            Event::ClientRequest { <span style="color:#66d9ef">ref</span> id, <span style="color:#f92672">..</span> } <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> msg.from <span style="color:#f92672">!=</span> Address::Client {
</span></span><span style="display:flex;"><span>                    error!(<span style="color:#e6db74">&#34;Received client request from non-client {:?}&#34;</span>, msg.from);
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span> Ok(self.into());
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">let</span> id <span style="color:#f92672">=</span> id.clone();
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> Some(leader) <span style="color:#f92672">=</span> self.role.leader {
</span></span><span style="display:flex;"><span>                    debug!(<span style="color:#e6db74">&#34;Forwarding request to leader {}: {:?}&#34;</span>, leader, msg);
</span></span><span style="display:flex;"><span>                    self.role.forwarded.insert(id);
</span></span><span style="display:flex;"><span>                    self.send(Address::Node(leader), msg.event)<span style="color:#f92672">?</span>
</span></span><span style="display:flex;"><span>                } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                    self.send(msg.from, Event::ClientResponse { id, response: Err(Error::Abort) })<span style="color:#f92672">?</span>
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Returns client responses for forwarded requests.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// 接收到client的消息之后，转发给leader，leader处理完之后再回应follower
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// 之后继续由follower去响应给client，这里为什么不告知client 真正的Leader是什么？
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	Event::ClientResponse { id, <span style="color:#66d9ef">mut</span> response } <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">!</span>self.is_leader(<span style="color:#f92672">&amp;</span>msg.from) {
</span></span><span style="display:flex;"><span>			error!(<span style="color:#e6db74">&#34;Received client response from non-leader {:?}&#34;</span>, msg.from);
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> Ok(self.into());
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// TODO: Get rid of this field, it should be returned at the RPC
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// server level instead.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> Ok(Response::Status(<span style="color:#66d9ef">ref</span> <span style="color:#66d9ef">mut</span> status)) <span style="color:#f92672">=</span> response {
</span></span><span style="display:flex;"><span>			status.server <span style="color:#f92672">=</span> self.id;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 处理完就可以从请求队列当中移除，并且响应Client
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// 请求队列是用于记录Follower接收到并且未处理完的ClientRequest，用于在通知Leader时，就可以将这些未处理的请求全部告知Client,让其找到Leader再去重新执行
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> self.role.forwarded.remove(<span style="color:#f92672">&amp;</span>id) {
</span></span><span style="display:flex;"><span>			self.send(Address::Client, Event::ClientResponse { id, response })<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span></code></pre></td></tr></table>
</div>
</div><p>不过Follower既然已经转发给Leader并且正确得到回应，那么就说明Follower知道Leader是谁了，此时回复Client时可以告知Client当前节点不是Leader，之后Client就可以找Leader去通信，但是toydb并没有这样实现，告知Client当前身份这个过程在toydb当中进行了单独的封装：</p>
<p>在Follower能够确认Leader时，如从Leader处接收到Heartbeat和AppendEntries时，就会调用上文的<code>follower.become_follower()</code>重置状态，在这个函数里面，会调用一个<code>abort_forwarded()</code>，在其中，会使用<code>std::mem::take</code>将<code>role.forwarded</code>给重置，并且遍历其中未处理的消息，依次告知Error，之后Client再进行重试。</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>    <span style="color:#e6db74">/// Aborts all forwarded requests.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">abort_forwarded</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self) -&gt; Result<span style="color:#f92672">&lt;</span>()<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> id <span style="color:#66d9ef">in</span> std::mem::take(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self.role.forwarded) {
</span></span><span style="display:flex;"><span>            debug!(<span style="color:#e6db74">&#34;Aborting forwarded request {:x?}&#34;</span>, id);
</span></span><span style="display:flex;"><span>            self.send(Address::Client, Event::ClientResponse { id, response: Err(Error::Abort) })<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        Ok(())
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="初始化">初始化<a hidden class="anchor" aria-hidden="true" href="#初始化">#</a></h2>
<p>在toydb启动时，会调用<code>Server::new()</code>来创建一个server节点，在其中，一部分初始化与client进行通信，而另一部分则是初始化raft节点,初始化完成之后就会调用serve来提供网络服务，其中会调用到<code>raft.serve()</code>来启动raft节点：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>    <span style="color:#75715e">// toydb.rs main
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    Server::new(cfg.id, cfg.peers, raft_log, raft_state)
</span></span><span style="display:flex;"><span>        .<span style="color:#66d9ef">await</span><span style="color:#f92672">?</span>
</span></span><span style="display:flex;"><span>        .listen(<span style="color:#f92672">&amp;</span>cfg.listen_sql, <span style="color:#f92672">&amp;</span>cfg.listen_raft)
</span></span><span style="display:flex;"><span>        .<span style="color:#66d9ef">await</span><span style="color:#f92672">?</span>
</span></span><span style="display:flex;"><span>        .serve()
</span></span><span style="display:flex;"><span>        .<span style="color:#66d9ef">await</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在<code>raft.serve()</code>当中，就会调用<code>raft.eventloop()</code>正式启动raft接收和处理事件，在eventloop当中，传入了一个channel的发送端，创建了三个channel：</p>
<ul>
<li>tcp_tx:raft节点之间相互交流的发送端，用于将底层node塞入信箱当中的Message发送给其他的节点</li>
<li>node_rx:node Message消息的接收端，用于从下层的raft当中接收Message，然后交给tcp_tx去发送</li>
<li>tcp_rx:raft节点之间相互交流的接收端，接收其他节点传来的Message，然后交给自身的Raft去执行</li>
<li>Client_rx: 接收 client 发送的 Message，交给自身的 Raft 去执行，这里的 client 并不是用户的 client，而是要执行命令的 sql 端，sql 端对于要执行的命令，首先会交给 Raft 来进行共识，这个过程是以 client-server 结构来执行的，sql 端充当 client，raft-server 充当 server。</li>
</ul>
<p>这一部分的逻辑主体是通过<code>tokio::select!</code>来实现的，在逻辑上与go当中的select是差不多的，只不过go的select是监听同步channel，而tokio::select!是等待异步任务的执行完成，分别从上述的三个channel当中获取Message，推动Raft节点。</p>
<p>除了channel的通信之外，select当中还有一个Ticker，以100ms的间隔运行，用于将物理时钟转换为逻辑时钟，提供给下层，驱动Raft。</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>    <span style="color:#e6db74">/// Runs the event loop.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">eventloop</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">mut</span> node: <span style="color:#a6e22e">Node</span>,
</span></span><span style="display:flex;"><span>        node_rx: <span style="color:#a6e22e">mpsc</span>::UnboundedReceiver<span style="color:#f92672">&lt;</span>Message<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>        client_rx: <span style="color:#a6e22e">mpsc</span>::UnboundedReceiver<span style="color:#f92672">&lt;</span>(Request, oneshot::Sender<span style="color:#f92672">&lt;</span>Result<span style="color:#f92672">&lt;</span>Response<span style="color:#f92672">&gt;&gt;</span>)<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>        tcp_rx: <span style="color:#a6e22e">mpsc</span>::UnboundedReceiver<span style="color:#f92672">&lt;</span>Message<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>        tcp_tx: <span style="color:#a6e22e">mpsc</span>::UnboundedSender<span style="color:#f92672">&lt;</span>Message<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>    ) -&gt; Result<span style="color:#f92672">&lt;</span>()<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> node_rx <span style="color:#f92672">=</span> UnboundedReceiverStream::new(node_rx);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> tcp_rx <span style="color:#f92672">=</span> UnboundedReceiverStream::new(tcp_rx);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> client_rx <span style="color:#f92672">=</span> UnboundedReceiverStream::new(client_rx);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> ticker <span style="color:#f92672">=</span> tokio::time::interval(<span style="color:#66d9ef">TICK_INTERVAL</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> requests <span style="color:#f92672">=</span> HashMap::<span style="color:#f92672">&lt;</span>Vec<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">u8</span><span style="color:#f92672">&gt;</span>, oneshot::Sender<span style="color:#f92672">&lt;</span>Result<span style="color:#f92672">&lt;</span>Response<span style="color:#f92672">&gt;&gt;&gt;</span>::new();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">loop</span> {
</span></span><span style="display:flex;"><span>            tokio::select! {
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 监听ticker，驱动下层Raft，间隔为100ms
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                _ <span style="color:#f92672">=</span> ticker.tick() <span style="color:#f92672">=&gt;</span> node <span style="color:#f92672">=</span> node.tick()<span style="color:#f92672">?</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 获取从其他raft节点发送而来的Message，交给下层的Raft去处理
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                Some(msg) <span style="color:#f92672">=</span> tcp_rx.next() <span style="color:#f92672">=&gt;</span> node <span style="color:#f92672">=</span> node.step(msg)<span style="color:#f92672">?</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 获取下层Raft放入信箱的Message，发送给对应的节点
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                Some(msg) <span style="color:#f92672">=</span> node_rx.next() <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">match</span> msg {
</span></span><span style="display:flex;"><span>                        Message{to: <span style="color:#a6e22e">Address</span>::Node(_), <span style="color:#f92672">..</span>} <span style="color:#f92672">=&gt;</span> tcp_tx.send(msg)<span style="color:#f92672">?</span>,
</span></span><span style="display:flex;"><span>                        Message{to: <span style="color:#a6e22e">Address</span>::Broadcast, <span style="color:#f92672">..</span>} <span style="color:#f92672">=&gt;</span> tcp_tx.send(msg)<span style="color:#f92672">?</span>,
</span></span><span style="display:flex;"><span>                        Message{to: <span style="color:#a6e22e">Address</span>::Client, event: <span style="color:#a6e22e">Event</span>::ClientResponse{ id, response }, <span style="color:#f92672">..</span>} <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>                            <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> Some(response_tx) <span style="color:#f92672">=</span> requests.remove(<span style="color:#f92672">&amp;</span>id) {
</span></span><span style="display:flex;"><span>                                response_tx
</span></span><span style="display:flex;"><span>                                    .send(response)
</span></span><span style="display:flex;"><span>                                    .map_err(<span style="color:#f92672">|</span>e<span style="color:#f92672">|</span> Error::Internal(format!(<span style="color:#e6db74">&#34;Failed to send response </span><span style="color:#e6db74">{:?}</span><span style="color:#e6db74">&#34;</span>, e)))<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>                            }
</span></span><span style="display:flex;"><span>                        }
</span></span><span style="display:flex;"><span>                        _ <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">return</span> Err(Error::Internal(format!(<span style="color:#e6db74">&#34;Unexpected message </span><span style="color:#e6db74">{:?}</span><span style="color:#e6db74">&#34;</span>, msg))),
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 获取client发送的消息，交给下层去处理，这里的client并不是用户的client，而是要执行命令的sql端
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                Some((request, response_tx)) <span style="color:#f92672">=</span> client_rx.next() <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">let</span> id <span style="color:#f92672">=</span> Uuid::new_v4().as_bytes().to_vec();
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">let</span> msg <span style="color:#f92672">=</span> Message{
</span></span><span style="display:flex;"><span>                        from: <span style="color:#a6e22e">Address</span>::Client,
</span></span><span style="display:flex;"><span>                        to: <span style="color:#a6e22e">Address</span>::Node(node.id()),
</span></span><span style="display:flex;"><span>                        term: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>                        event: <span style="color:#a6e22e">Event</span>::ClientRequest{id: <span style="color:#a6e22e">id</span>.clone(), request},
</span></span><span style="display:flex;"><span>                    };
</span></span><span style="display:flex;"><span>                    node <span style="color:#f92672">=</span> node.step(msg)<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>                    requests.insert(id, response_tx);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="leader-election">Leader Election<a hidden class="anchor" aria-hidden="true" href="#leader-election">#</a></h2>
<p>Raft的选举过程受到Ticker的驱动，如上面所展示的，上层server层会以100ms为间隔将物理时钟转换为逻辑时钟，下层的<code>tick()</code>定义在<code>mod.rs</code>当中,对于不同角色的节点，分别调用对应的<code>tick()</code>，在选举当中，对应的就是<code>Follower</code>的<code>tick()</code>：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>    <span style="color:#e6db74">/// Moves time forward by a tick.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">tick</span>(self) -&gt; Result<span style="color:#f92672">&lt;</span>Self<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">match</span> self {
</span></span><span style="display:flex;"><span>            Node::Candidate(n) <span style="color:#f92672">=&gt;</span> n.tick(),
</span></span><span style="display:flex;"><span>            Node::Follower(n) <span style="color:#f92672">=&gt;</span> n.tick(),
</span></span><span style="display:flex;"><span>            Node::Leader(n) <span style="color:#f92672">=&gt;</span> n.tick(),
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span></code></pre></td></tr></table>
</div>
</div><p>在<code>Follower</code>的<code>tick()</code>当中,增大<code>election_duration</code>，如果超出了限制，就转换为candidate，开启选举，选举的入口为<code>self.compaign()</code>,这与<code>etcd/raft</code>的实现是一致的。</p>
<p>在toydb当中设置的是10-20个逻辑时钟，即1-2s的随机时间，这里比论文当中(150ms-300ms)设置的长很多，和etcd设置一致。但是toydb的heartbeat为3个逻辑时钟，所以其实也不会有太大的问题</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#e6db74">/// The interval between leader heartbeats, in ticks.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">HEARTBEAT_INTERVAL</span>: <span style="color:#a6e22e">Ticks</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">/// The randomized election timeout range (min-max), in ticks. This is
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/// randomized per node to avoid ties.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">ELECTION_TIMEOUT_RANGE</span>: <span style="color:#a6e22e">std</span>::ops::Range<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">u8</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span><span style="color:#f92672">..</span><span style="color:#ae81ff">20</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Follower.tick，转换为candidate
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">tick</span>(<span style="color:#66d9ef">mut</span> self) -&gt; Result<span style="color:#f92672">&lt;</span>Node<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>        self.assert()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self.role.leader_seen <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self.role.leader_seen <span style="color:#f92672">&gt;=</span> self.role.election_timeout {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> Ok(self.become_candidate()<span style="color:#f92672">?</span>.into());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        Ok(self.into())
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 转换为candidate之后会立刻开始选举
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#e6db74">/// Transforms the node into a candidate, by campaigning for leadership in a
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#e6db74">/// new term.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">become_candidate</span>(<span style="color:#66d9ef">mut</span> self) -&gt; Result<span style="color:#f92672">&lt;</span>RoleNode<span style="color:#f92672">&lt;</span>Candidate<span style="color:#f92672">&gt;&gt;</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Abort any forwarded requests. These must be retried with new leader.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        self.abort_forwarded()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> node <span style="color:#f92672">=</span> self.become_role(Candidate::new());
</span></span><span style="display:flex;"><span>        node.campaign()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>        Ok(node)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Candidate.tick，在第一次选举失败之后会调用到
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#e6db74">/// Processes a logical clock tick.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">tick</span>(<span style="color:#66d9ef">mut</span> self) -&gt; Result<span style="color:#f92672">&lt;</span>Node<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>        self.assert()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self.role.election_duration <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self.role.election_duration <span style="color:#f92672">&gt;=</span> self.role.election_timeout {
</span></span><span style="display:flex;"><span>            self.campaign()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        Ok(self.into())
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>compaign</strong></p>
<p>在compaign当中，逻辑按照小论文当中实现：</p>
<ol>
<li>自增term</li>
<li>为自己投一票</li>
<li>持久化保存term</li>
<li>发送Message，向其他的节点请求投票，发送一条Event类型为SolicitVote类型的Message</li>
</ol>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>    <span style="color:#e6db74">/// Campaign for leadership by increasing the term, voting for ourself, and
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#e6db74">/// soliciting votes from all peers.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#66d9ef">pub</span>(<span style="color:#66d9ef">super</span>) <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">campaign</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self) -&gt; Result<span style="color:#f92672">&lt;</span>()<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> term <span style="color:#f92672">=</span> self.term <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>        info!(<span style="color:#e6db74">&#34;Starting new election for term {}&#34;</span>, term);
</span></span><span style="display:flex;"><span>        self.role <span style="color:#f92672">=</span> Candidate::new();
</span></span><span style="display:flex;"><span>        self.role.votes.insert(self.id); <span style="color:#75715e">// vote for ourself
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        self.term <span style="color:#f92672">=</span> term;
</span></span><span style="display:flex;"><span>        self.log.set_term(term, Some(self.id))<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> (last_index, last_term) <span style="color:#f92672">=</span> self.log.get_last_index();
</span></span><span style="display:flex;"><span>        self.send(Address::Broadcast, Event::SolicitVote { last_index, last_term })<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>        Ok(())
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>SolicitVote</strong></p>
<p>SolicitVote类型的Message由其他的Follower来处理，对于所有Message的处理，都定义在<code>step()</code>当中，这里逻辑和上面一样，根据节点角色再去进行调用，SolicitVote在<code>follower.step()</code>当中:</p>
<ol>
<li>如果当前term投过票了就忽略</li>
<li>做安全性检查，只会给日志状态最新的节点投票</li>
<li>检查通过则投票，并做持久化记录，存储vote for</li>
</ol>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>	Event::SolicitVote { last_index, last_term } <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">let</span> from <span style="color:#f92672">=</span> msg.from.unwrap();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// If we already voted for someone else in this term, ignore it.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> Some(voted_for) <span style="color:#f92672">=</span> self.role.voted_for {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> from <span style="color:#f92672">!=</span> voted_for {
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">return</span> Ok(self.into());
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Only vote if the candidate&#39;s log is at least as up-to-date as
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// our log.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">let</span> (log_index, log_term) <span style="color:#f92672">=</span> self.log.get_last_index();
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> last_term <span style="color:#f92672">&gt;</span> log_term <span style="color:#f92672">||</span> last_term <span style="color:#f92672">==</span> log_term <span style="color:#f92672">&amp;&amp;</span> last_index <span style="color:#f92672">&gt;=</span> log_index {
</span></span><span style="display:flex;"><span>			info!(<span style="color:#e6db74">&#34;Voting for {} in term {} election&#34;</span>, from, self.term);
</span></span><span style="display:flex;"><span>			self.send(Address::Node(from), Event::GrantVote)<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>			self.log.set_term(self.term, Some(from))<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>			self.role.voted_for <span style="color:#f92672">=</span> Some(from);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">/// 定义在log当中，用于对term和vote_for进行持久化存储
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#e6db74">/// Sets the most recent term, and cast vote (if any).
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">set_term</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self, term: <span style="color:#a6e22e">Term</span>, voted_for: Option<span style="color:#f92672">&lt;</span>NodeID<span style="color:#f92672">&gt;</span>) -&gt; Result<span style="color:#f92672">&lt;</span>()<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>        self.engine.set(<span style="color:#f92672">&amp;</span>Key::TermVote.encode()<span style="color:#f92672">?</span>, bincode::serialize(<span style="color:#f92672">&amp;</span>(term, voted_for))<span style="color:#f92672">?</span>)<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>        self.maybe_flush()
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>BecomeLeader</strong></p>
<p>当candidate接收到Follower的投票回复之后，会记录票数，如果达到了quorum，那么就转换为leader，这一部分的逻辑同样是定义在step当中</p>
<p>当选为Leader之后，更新一些信息之后，会发送心跳信息告知其他的节点Leader已经当选。
之后会追加一条no-op，non-op的作用已经在上文角色切换部分解释了。</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>	Event::GrantVote <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>		self.role.votes.insert(msg.from.unwrap());
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> self.role.votes.len() <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">u64</span> <span style="color:#f92672">&gt;=</span> self.quorum() {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> Ok(self.become_leader()<span style="color:#f92672">?</span>.into());
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">become_leader</span>(self) -&gt; Result<span style="color:#f92672">&lt;</span>RoleNode<span style="color:#f92672">&lt;</span>Leader<span style="color:#f92672">&gt;&gt;</span> {
</span></span><span style="display:flex;"><span>        info!(<span style="color:#e6db74">&#34;Won election for term {}, becoming leader&#34;</span>, self.term);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> peers <span style="color:#f92672">=</span> self.peers.clone();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> (last_index, _) <span style="color:#f92672">=</span> self.log.get_last_index();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> node <span style="color:#f92672">=</span> self.become_role(Leader::new(peers, last_index));
</span></span><span style="display:flex;"><span>        node.heartbeat()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Propose an empty command when assuming leadership, to disambiguate
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// previous entries in the log. See section 8 in the Raft paper.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        node.propose(None)<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>        Ok(node)
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></td></tr></table>
</div>
</div><p>toydb当中Leader Election的实现非常简单，基本上完全按照raft小论文当中的描述，像是PreVote，Check Quorum，Leader Lease一概没有，不过这也很符合其toy的定位。</p>
<h2 id="log-replication">Log Replication<a hidden class="anchor" aria-hidden="true" href="#log-replication">#</a></h2>
<h3 id="log">Log<a hidden class="anchor" aria-hidden="true" href="#log">#</a></h3>
<p>在看日志复制之前，先看一下Log的实现：
Log模块并不只存储LogEntry，这里其实是对底层kv存储引擎的封装，所有需要进行持久化的数据都丢到存储引擎当中，包括<code>current_term</code>和<code>vote_for</code>，这里还额外存储了一个<code>commit_index</code>用于在commit时做一个安全校验,<code>Entry</code>是log的基本单位，实现同样是借助枚举来实现的：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#e6db74">/// A log key, encoded using KeyCode.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span><span style="color:#75715e">#[derive(Clone, Debug, PartialEq, Serialize, Deserialize)]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">enum</span> <span style="color:#a6e22e">Key</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// A log entry, storing the term and command.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    Entry(Index),
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// Stores the current term and vote (if any).
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    TermVote,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// Stores the current commit index (if any).
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    CommitIndex,
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">/// A log entry.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span><span style="color:#75715e">#[derive(Clone, Debug, PartialEq, Serialize, Deserialize)]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Entry</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// The entry index.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#66d9ef">pub</span> index: <span style="color:#a6e22e">Index</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// The term in which the entry was added.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#66d9ef">pub</span> term: <span style="color:#a6e22e">Term</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// The state machine command. None is used to commit noops during leader election.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#66d9ef">pub</span> command: Option<span style="color:#f92672">&lt;</span>Vec<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">u8</span><span style="color:#f92672">&gt;&gt;</span>,
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Log本体定义如下，包括一个engine用于进行存储，和一些元数据，在初始化时，会从engine当中把元数据给加载出来：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Log</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// The underlying storage engine.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    engine: Box<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">dyn</span> Engine<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// The index of the last stored entry.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    last_index: <span style="color:#a6e22e">Index</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// The term of the last stored entry.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    last_term: <span style="color:#a6e22e">Term</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// The index of the last committed entry.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    commit_index: <span style="color:#a6e22e">Index</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// The term of the last committed entry.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    commit_term: <span style="color:#a6e22e">Term</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// Whether to sync writes to disk.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    sync: <span style="color:#66d9ef">bool</span>,
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>其中的函数实现，逻辑都比较简单，并且也都提供了丰富的注释，这里就不展开。</p>
<h3 id="heartbeat">Heartbeat<a hidden class="anchor" aria-hidden="true" href="#heartbeat">#</a></h3>
<p>与6.824当中使用heartbeat来携带日志不同，在toydb当中，heartbeat就仅仅是用于维护leader身份，以及推动follower的commit_index，不会携带log entry。heartbeat的发送逻辑在<code>leader.tick()</code>当中，heartbeat的处理在<code>follower.step()</code>当中：</p>
<ol>
<li>接收到了heartbeat就不断将自己转换为follower</li>
<li>根据leader传来到commit_index和自身log的情况，推动commit的进度</li>
</ol>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>	<span style="color:#75715e">// leader.tick()
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// Processes a logical clock tick.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">tick</span>(<span style="color:#66d9ef">mut</span> self) -&gt; Result<span style="color:#f92672">&lt;</span>Node<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>        self.assert()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self.role.since_heartbeat <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self.role.since_heartbeat <span style="color:#f92672">&gt;=</span> <span style="color:#66d9ef">HEARTBEAT_INTERVAL</span> {
</span></span><span style="display:flex;"><span>            self.heartbeat()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>            self.role.since_heartbeat <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        Ok(self.into())
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>	<span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">enum</span> <span style="color:#a6e22e">Event</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// Leaders send periodic heartbeats to its followers.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    Heartbeat {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">/// The index of the leader&#39;s last committed log entry.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>        commit_index: <span style="color:#a6e22e">Index</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">/// The term of the leader&#39;s last committed log entry.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>        commit_term: <span style="color:#a6e22e">Term</span>,
</span></span><span style="display:flex;"><span>	    },
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// ......
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#e6db74">/// ......
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// follower.step()当中处理心跳信息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// The leader will send periodic heartbeats. If we don&#39;t have a
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// leader in this term yet, follow it. If the commit_index advances,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// apply state transitions.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	Event::Heartbeat { commit_index, commit_term } <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Check that the heartbeat is from our leader.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">let</span> from <span style="color:#f92672">=</span> msg.from.unwrap();
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">match</span> self.role.leader {
</span></span><span style="display:flex;"><span>			Some(leader) <span style="color:#f92672">=&gt;</span> assert_eq!(from, leader, <span style="color:#e6db74">&#34;Multiple leaders in term&#34;</span>),
</span></span><span style="display:flex;"><span>			None <span style="color:#f92672">=&gt;</span> self <span style="color:#f92672">=</span> self.become_follower(Some(from), msg.term)<span style="color:#f92672">?</span>,
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Advance commit index and apply entries if possible.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">let</span> has_committed <span style="color:#f92672">=</span> self.log.has(commit_index, commit_term)<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">let</span> (old_commit_index, _) <span style="color:#f92672">=</span> self.log.get_commit_index();
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> has_committed <span style="color:#f92672">&amp;&amp;</span> commit_index <span style="color:#f92672">&gt;</span> old_commit_index {
</span></span><span style="display:flex;"><span>			self.log.commit(commit_index)<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> scan <span style="color:#f92672">=</span> self.log.scan((old_commit_index <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>)<span style="color:#f92672">..=</span>commit_index)<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 与状态机进行交互
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#66d9ef">while</span> <span style="color:#66d9ef">let</span> Some(entry) <span style="color:#f92672">=</span> scan.next().transpose()<span style="color:#f92672">?</span> {
</span></span><span style="display:flex;"><span>				self.state_tx.send(Instruction::Apply { entry })<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		self.send(msg.from, Event::ConfirmLeader { commit_index, has_committed })<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>	}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="log-replication-1">Log Replication<a hidden class="anchor" aria-hidden="true" href="#log-replication-1">#</a></h3>
<p>Log Replication的入口在<code>Leader.step()</code>当中，Leader会处理由Client发送而来的请求，在这里会调用<code>propose()</code>，在propose当中，真正开始进行日志复制，将命令转换为日志存储到本地，之后再发送给其他的节点：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>	<span style="color:#75715e">// leader.step() 接受客户端请求
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	
</span></span><span style="display:flex;"><span>	Event::ClientRequest { id, request: <span style="color:#a6e22e">Request</span>::Mutate(command) } <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> index <span style="color:#f92672">=</span> self.propose(Some(command))<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>	self.state_tx.send(Instruction::Notify { id, address: <span style="color:#a6e22e">msg</span>.from, index })<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> self.peers.is_empty() {
</span></span><span style="display:flex;"><span>		self.maybe_commit()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// propose，真正开始日志复制的逻辑
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// Proposes a command for consensus by appending it to our log and
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#e6db74">/// replicating it to peers. If successful, it will eventually be committed
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#e6db74">/// and applied to the state machine.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#66d9ef">pub</span>(<span style="color:#66d9ef">super</span>) <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">propose</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self, command: Option<span style="color:#f92672">&lt;</span>Vec<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">u8</span><span style="color:#f92672">&gt;&gt;</span>) -&gt; Result<span style="color:#f92672">&lt;</span>Index<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> index <span style="color:#f92672">=</span> self.log.append(self.term, command)<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> peer <span style="color:#66d9ef">in</span> self.peers.clone() {
</span></span><span style="display:flex;"><span>            self.send_log(peer)<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        Ok(index)
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Progress</strong>
Progress的含义是，站在Leader的角度，观察到的follower的复制进度，定义了<code>next_index</code>和<code>match_index</code>，之后使用一个HashMap来管理各个节点的进度,由于和etcd相比少了流水线发送和滑动窗口流量控制等，Progress的实现简单了很多：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Progress</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// The next index to replicate to the peer.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    next: <span style="color:#a6e22e">Index</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// The last index known to be replicated to the peer.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    last: <span style="color:#a6e22e">Index</span>,
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Leader</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// Peer replication progress.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    progress: <span style="color:#a6e22e">HashMap</span><span style="color:#f92672">&lt;</span>NodeID, Progress<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">/// Number of ticks since last periodic heartbeat.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    since_heartbeat: <span style="color:#a6e22e">Ticks</span>,
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="propose">propose<a hidden class="anchor" aria-hidden="true" href="#propose">#</a></h4>
<p>在propose当中，会首先将日志持久化到本地，之后调用<code>send_log()</code>进行发送，在<code>send_log()</code>当中，会根据Progress找到需要发送的日志，之后从本地进行读取。</p>
<ol>
<li>根据progress获取到next之后，先从本地读取next - 1的Entry，next - 1的Entry是用于检测日志冲突的，理应存在于Leader本地</li>
<li>扫描出next之后的所有Entry，连同base_index和base_term封装成一条<code>AppendEntries</code>发送给follower</li>
</ol>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>    <span style="color:#e6db74">/// Sends pending log entries to a peer.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">send_log</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self, peer: <span style="color:#a6e22e">NodeID</span>) -&gt; Result<span style="color:#f92672">&lt;</span>()<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> (base_index, base_term) <span style="color:#f92672">=</span> <span style="color:#66d9ef">match</span> self.role.progress.get(<span style="color:#f92672">&amp;</span>peer) {
</span></span><span style="display:flex;"><span>            Some(Progress { next, <span style="color:#f92672">..</span> }) <span style="color:#66d9ef">if</span> <span style="color:#f92672">*</span>next <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">match</span> self.log.get(next <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>)<span style="color:#f92672">?</span> {
</span></span><span style="display:flex;"><span>                Some(entry) <span style="color:#f92672">=&gt;</span> (entry.index, entry.term),
</span></span><span style="display:flex;"><span>                None <span style="color:#f92672">=&gt;</span> panic!(<span style="color:#e6db74">&#34;Missing base entry </span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span>, next <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>),
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>            Some(_) <span style="color:#f92672">=&gt;</span> (<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>            None <span style="color:#f92672">=&gt;</span> panic!(<span style="color:#e6db74">&#34;Unknown peer </span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span>, peer),
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> entries <span style="color:#f92672">=</span> self.log.scan((base_index <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>)<span style="color:#f92672">..</span>)<span style="color:#f92672">?</span>.collect::<span style="color:#f92672">&lt;</span>Result<span style="color:#f92672">&lt;</span>Vec<span style="color:#f92672">&lt;</span>_<span style="color:#f92672">&gt;&gt;&gt;</span>()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>        debug!(<span style="color:#e6db74">&#34;Replicating {} entries at base {} to {}&#34;</span>, entries.len(), base_index, peer);
</span></span><span style="display:flex;"><span>        self.send(Address::Node(peer), Event::AppendEntries { base_index, base_term, entries })<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>        Ok(())
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="appendentries">AppendEntries<a hidden class="anchor" aria-hidden="true" href="#appendentries">#</a></h4>
<p>Leader封装了一条AppendEntries发送给Follower，相对应的就在<code>Follower.step()</code>当中进行处理：</p>
<ol>
<li>能够接收到AppendEntries证明能够确认Leader，因此就调用<code>become_follower()</code>更新自身状态，对Leader进行跟随</li>
<li>尝试匹配日志，并将其应用于自身，如果不匹配则返回一条Reject，让Leader再去做backup，找到正确的日志</li>
</ol>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>	<span style="color:#75715e">// Replicate entries from the leader. If we don&#39;t have a leader in
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// this term yet, follow it.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	Event::AppendEntries { base_index, base_term, entries } <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Check that the entries are from our leader.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">let</span> from <span style="color:#f92672">=</span> msg.from.unwrap();
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">match</span> self.role.leader {
</span></span><span style="display:flex;"><span>			Some(leader) <span style="color:#f92672">=&gt;</span> assert_eq!(from, leader, <span style="color:#e6db74">&#34;Multiple leaders in term&#34;</span>),
</span></span><span style="display:flex;"><span>			None <span style="color:#f92672">=&gt;</span> self <span style="color:#f92672">=</span> self.become_follower(Some(from), msg.term)<span style="color:#f92672">?</span>,
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Append the entries, if possible.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> base_index <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>self.log.has(base_index, base_term)<span style="color:#f92672">?</span> {
</span></span><span style="display:flex;"><span>			debug!(<span style="color:#e6db74">&#34;Rejecting log entries at base {}&#34;</span>, base_index);
</span></span><span style="display:flex;"><span>			self.send(msg.from, Event::RejectEntries)<span style="color:#f92672">?</span>
</span></span><span style="display:flex;"><span>		} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">let</span> last_index <span style="color:#f92672">=</span> self.log.splice(entries)<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>			self.send(msg.from, Event::AcceptEntries { last_index })<span style="color:#f92672">?</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span></code></pre></td></tr></table>
</div>
</div><p>在Leader端的处理分为两种，分别是成功响应的<code>Event::AppendEntries</code>和<code>EventRejectEntries</code>：</p>
<ul>
<li>如果Follower能够成功匹配日志，那么Leader就会去更新进度，并且计算quorum，尝试进行commit</li>
<li>如果匹配失败，在Leader端progress向前回退一个，再尝试发送日志，进行探测，直至找到找到正确的位置，这里是没有实现的fast backup的，在效率上会存在一定的问题</li>
</ul>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>	Event::AcceptEntries { last_index } <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>		assert!(
</span></span><span style="display:flex;"><span>			last_index <span style="color:#f92672">&lt;=</span> self.log.get_last_index().<span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#e6db74">&#34;Follower accepted entries after last index&#34;</span>
</span></span><span style="display:flex;"><span>		);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">let</span> from <span style="color:#f92672">=</span> msg.from.unwrap();
</span></span><span style="display:flex;"><span>		self.role.progress.entry(from).and_modify(<span style="color:#f92672">|</span>p<span style="color:#f92672">|</span> {
</span></span><span style="display:flex;"><span>			p.last <span style="color:#f92672">=</span> last_index;
</span></span><span style="display:flex;"><span>			p.next <span style="color:#f92672">=</span> last_index <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>		});
</span></span><span style="display:flex;"><span>		self.maybe_commit()<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// A follower rejected log entries we sent it, typically because it
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// does not have the base index in its log. Try to replicate from
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// the previous entry.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// This linear probing, as described in the Raft paper, can be very
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// slow with long divergent logs, but we keep it simple.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	Event::RejectEntries <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">let</span> from <span style="color:#f92672">=</span> msg.from.unwrap();
</span></span><span style="display:flex;"><span>		self.role.progress.entry(from).and_modify(<span style="color:#f92672">|</span>p<span style="color:#f92672">|</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> p.next <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span> {
</span></span><span style="display:flex;"><span>				p.next <span style="color:#f92672">-=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		});
</span></span><span style="display:flex;"><span>		self.send_log(from)<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>	}
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="commit">Commit<a hidden class="anchor" aria-hidden="true" href="#commit">#</a></h4>
<p>每次Leader确定了有follower保存了日志之后就会尝试进行commit，在rust当中，借助函数式编程，能将这个过程写的很优雅(没接触过函数式编程看了想骂娘)：</p>
<ol>
<li>首先获取到progress的HashMap，之后获取到HashMap的所有value(value是一个next_index和last_index组成的元组)</li>
<li>再做一个转换，获取last_index，这一步会得到一个由所有last_index组成的迭代器</li>
<li>之后使用chain将leader的last_index追加进去，最后转换为Vec</li>
<li>排序并反转之后第quorum大的last_index就是与follower达成共识的index
在vscode当中，rust-analyzer能够很清楚的显示出每一步都得到了什么：
<img loading="lazy" src="https://pic-bed-1309931445.cos.ap-nanjing.myqcloud.com/blog/20231225210450.png" alt="image.png"  />
</li>
</ol>
<p>获取到commit_index之后做一些校验：</p>
<ol>
<li>此次计算出的commit_index要大于上一次的commit_index</li>
<li>获取出 commit_index 对应的 entry，判断是不是当前的 Term，Leader 只能提交属于自己任期的日志 (见 raft 小论文 figure 8)</li>
</ol>
<p>如果是新的commit_index，就在本地进行记录，并且扫描出从上一次commit到新commit_index之间的所有的日志，向上层状态机进行apply，即向<code>state_tx</code> channel当中发送一条信息</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>        <span style="color:#75715e">// Make sure the commit index does not regress.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">let</span> (prev_commit_index, _) <span style="color:#f92672">=</span> self.log.get_commit_index();
</span></span><span style="display:flex;"><span>        assert!(
</span></span><span style="display:flex;"><span>            commit_index <span style="color:#f92672">&gt;=</span> prev_commit_index,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Commit index regression {} -&gt; {}&#34;</span>,
</span></span><span style="display:flex;"><span>            prev_commit_index,
</span></span><span style="display:flex;"><span>            commit_index
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// We can only safely commit up to an entry from our own term, see
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// figure 8 in Raft paper.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">match</span> self.log.get(commit_index)<span style="color:#f92672">?</span> {
</span></span><span style="display:flex;"><span>            Some(entry) <span style="color:#66d9ef">if</span> entry.term <span style="color:#f92672">==</span> self.term <span style="color:#f92672">=&gt;</span> {}
</span></span><span style="display:flex;"><span>            Some(_) <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">return</span> Ok(prev_commit_index),
</span></span><span style="display:flex;"><span>            None <span style="color:#f92672">=&gt;</span> panic!(<span style="color:#e6db74">&#34;Commit index </span><span style="color:#e6db74">{}</span><span style="color:#e6db74"> missing&#34;</span>, commit_index),
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Commit and apply the new entries.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> commit_index <span style="color:#f92672">&gt;</span> prev_commit_index {
</span></span><span style="display:flex;"><span>            self.log.commit(commit_index)<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// TODO: Move application elsewhere, but needs access to applied index.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> scan <span style="color:#f92672">=</span> self.log.scan((prev_commit_index <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>)<span style="color:#f92672">..=</span>commit_index)<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">let</span> Some(entry) <span style="color:#f92672">=</span> scan.next().transpose()<span style="color:#f92672">?</span> {
</span></span><span style="display:flex;"><span>                self.state_tx.send(Instruction::Apply { entry })<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="summary">Summary<a hidden class="anchor" aria-hidden="true" href="#summary">#</a></h2>
<p>以上就是toydb当中Raft模块的全部内容，这里的Raft模块指的是Raft本身的逻辑部分，不包括上层的状态机和发送命令的Client，这一部分笔者留到下一章的sql engine当中进行分析，最后以toydb与MIT6.824以及etcd进行一个简单的对比，来结束这一章</p>
<p><strong>MIT-6.824</strong></p>
<p>在MIT-6.824的Lab2当中，实现了一个基础的Raft模块，在其中几乎完整的复现了《In Search of an Understandable Consensus Algorithm (Extended Version)》一文，但没有实现集群配置变更，并且在持久化和snapshot上做了简化。</p>
<p>但是MIT6.824当中的实现并不是那么工程化，或者说接近生产环境，虽然每个人的实现方式不同，但是至少初始框架是这样的，相比于Tinykv来说。在6.824当中，在需要通信的时候就直接发送rpc调用对应的函数，以一种很直观的方式复现了Raft，当中定义的函数也都遵循论文当中figure2，基本上把figure2翻译成golang就能实现出来。</p>
<p><strong>etcd/raft</strong></p>
<p>etcd/raft作为一个投入生产环境的raft package，代码结构自然是清晰严谨的。</p>
<p>在基础结构上，etcd/raft将raft视为一个状态机，上层给予Raft一些输入，如tick或者message，Raft就会根据输入作出一些响应，更改自身状态，最后提供一些输出，上层处理完输出之后再调用Advance来继续推进Raft去更新状态。</p>
<p>在etcd当中，raft package仅提供raft的逻辑，如如何进行选举和发送日志，但是如持久化存储，网络通信都由上层应用负责，raft package通过<code>Ready</code>将需要存储的日志，快照，以及需要发送的消息交给上层。</p>
<p>在结构上，etcd/raft以Message为主体和驱动，整个Raft的执行流程就是在tick的驱动下，不断的执行和发送Message的过程，并不会像MIT6.824当中那样在一个函数当中能看到完整的rpc调用和处理流程，每个Message只会负责整体逻辑的一部分，执行完自己的内容就生成一个新的Message发送，其他拿到这条Message的来完成这个事件的剩余逻辑，举个例子，在进行选举时：</p>
<ol>
<li>candidate首先会向其他节点发送一个请求投票的Message，此时candidate目前负责的逻辑已经执行结束，candidate可以去执行其他内容</li>
<li>follower受到candidate发送的Message就会进行处理，投票或者忽略，同样将结果封装成一条Message再发送给candidate</li>
<li>Candidate 再收到 Message 之后继续完成剩余的逻辑，统计投票，决定是否当选</li>
</ol>
<p>整个执行过程是松散、非连续的。但是主体逻辑全部使用 Message 来承载的话，整体结构就会非常清晰，raft 只需要不断的处理 Message 即可，并在适当的时候产生新的 Message</p>
<p>在实现上，etcd/raft完整的实现了Raft小论文当中的内容，包括在MIT-6.824当中没有实现的集群变更，并且对于Raft大论文《CONSENSUS: BRIDGING THEORY AND PRACTICE》当中的优化也进行了实现：</p>
<ul>
<li>在结构上：采用了批处理的形式，即<code>Ready</code>会向上层返回一批需要处理数据，上层用户进行集中处理，在Raft运行的过程中，只需要把log添加到对应的位置，将需要发送的Message放入“信箱”，届时一并通过<code>Ready</code>返回(这个其实和Raft大论文没什么关系，只不过都是优化就一并提一下了)</li>
<li>在选举部分：ectd/raft实现了PreVote、Check Quorum、Leader Lease的优化</li>
<li>在日志复制上，ectd/raft采用了流水线设计，会在阻塞探测模式，流水线发送，快照发送三种模式下切换，在流水线模式下，etcd/raft可以在未接收到上次发送日志响应的情况下继续发送日志，并且使用滑动窗口来进行流量控制。并且在日志发送时，采用并行发送的方式，即存储与发送并行，可以在本地还未进行持久化存储的情况下就发送，某些情况下，follower可能在leader存储日志之前就接收到日志。在日志不匹配时，follower会返回一个hint，从而Leader可以快速进行回退，找到正确的位置。</li>
<li>在线性一致性读上，提供了 ReadIndex 和 Lease Read 两种方式，以绕过 Log Read，提高系统吞吐量</li>
</ul>
<p>如果想进一步了解etcd/raft的话，推荐看这一系列，就像其名字一样，深入浅出：<a href="http://blog.mrcroxx.com/posts/code-reading/etcdraft-made-simple/0-introduction/">深入浅出etcd/raft —— 0x00 引言 - 叉鸽 MrCroxx 的博客</a>
<strong>toydb</strong>
内容上，toydb相比于Raft小论文和MIT-6.824有所删减，同样没有实现集群成员变更，此外，没有实现日志的快速回退，和快照功能。而etcd当中的种种优化就更没有了(toydb通过Raft状态机实现了一个ReadIndex的功能，其他的就都没有了)</p>
<p>在结构上toydb基本上与etcd/raft一致，使用逻辑时钟+Message进行驱动，上面对etcd的分析对toydb基本上都适用。只不过toydb的持久化是由Raft自己负责的，所有与持久化相关的内容都扔进kv存储引擎当中，无论是元数据还是日志。但是网络模块是在上层实现的，在Raft当中也是和etcd一样，只需要把Message塞入信箱即可。</p>
<p>总的来说，toydb做了一个很好的取舍，用非常工程化的结构实现了一个几乎没有任何优化的，简单的Raft模块，代码逻辑非常的清晰，当然代价就是会损失一定的性能，如同步进行持久化，和日志出现不匹配时需要一条条进行回退。不过作为一个Learning Project，个人认为还是实现的非常优雅的，很值得用来学习。</p>
<p>对于Raft上层状态机和Client的相关内容，涉及到比较复杂的通信和异步编程，限于篇幅就不再本章当中进行分析，会留在下一章的kv engine当中一并进行分析。</p>
<p>由于分布式系统比较复杂，在toydb当中，在client，Raft，以及Raft状态机之间的逻辑比较复杂，涉及到大量的异步编程和信息交换，笔者水平有限，难免会出现错误，欢迎读者进行批评指正，再完成了Raft状态机部分，我也会重新校验整理这篇文章，以求达到一个更好的效果。</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="https://fischer0522.github.io/en/posts/tech/toydb/04-raft-state-machine/">
    <span class="title">« Prev</span>
    <br>
    <span>04-Raft State Machine</span>
  </a>
  <a class="next" href="https://fischer0522.github.io/en/posts/tech/toydb/02-mvcc/">
    <span class="title">Next »</span>
    <br>
    <span>02-MVCC</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 03-Raft on x"
            href="https://x.com/intent/tweet/?text=03-Raft&amp;url=https%3a%2f%2ffischer0522.github.io%2fen%2fposts%2ftech%2ftoydb%2f03-raft%2f&amp;hashtags=">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 03-Raft on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2ffischer0522.github.io%2fen%2fposts%2ftech%2ftoydb%2f03-raft%2f&amp;title=03-Raft&amp;summary=03-Raft&amp;source=https%3a%2f%2ffischer0522.github.io%2fen%2fposts%2ftech%2ftoydb%2f03-raft%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 03-Raft on reddit"
            href="https://reddit.com/submit?url=https%3a%2f%2ffischer0522.github.io%2fen%2fposts%2ftech%2ftoydb%2f03-raft%2f&title=03-Raft">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 03-Raft on facebook"
            href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2ffischer0522.github.io%2fen%2fposts%2ftech%2ftoydb%2f03-raft%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 03-Raft on whatsapp"
            href="https://api.whatsapp.com/send?text=03-Raft%20-%20https%3a%2f%2ffischer0522.github.io%2fen%2fposts%2ftech%2ftoydb%2f03-raft%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 03-Raft on telegram"
            href="https://telegram.me/share/url?text=03-Raft&amp;url=https%3a%2f%2ffischer0522.github.io%2fen%2fposts%2ftech%2ftoydb%2f03-raft%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 03-Raft on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=03-Raft&u=https%3a%2f%2ffischer0522.github.io%2fen%2fposts%2ftech%2ftoydb%2f03-raft%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2024 <a href="https://fischer0522.github.io/en/">Fischer&#39;s Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
