<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>06-SQL Execution | Fischer&#39;s Blog</title>
<meta name="keywords" content="">
<meta name="description" content="本系列的第一章00-Architecture以SQL执行流程为整个系列做了一个引子，目前本系列通过六篇文章，已经将toydb的各个模块都分析">
<meta name="author" content="Sulv">
<link rel="canonical" href="http://itfischer.space/en/posts/tech/toydb/06-sql-execution/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css" integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z&#43;V9&#43;cO1A=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://itfischer.space/img/Navigation.svg">
<link rel="icon" type="image/png" sizes="16x16" href="http://itfischer.space/img/Q.gif">
<link rel="icon" type="image/png" sizes="32x32" href="http://itfischer.space/img/Q.gif">
<link rel="apple-touch-icon" href="http://itfischer.space/Q.gif">
<link rel="mask-icon" href="http://itfischer.space/Q.gif">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="06-SQL Execution" />
<meta property="og:description" content="本系列的第一章00-Architecture以SQL执行流程为整个系列做了一个引子，目前本系列通过六篇文章，已经将toydb的各个模块都分析" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://itfischer.space/en/posts/tech/toydb/06-sql-execution/" /><meta property="article:section" content="posts" />



<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="06-SQL Execution"/>
<meta name="twitter:description" content="本系列的第一章00-Architecture以SQL执行流程为整个系列做了一个引子，目前本系列通过六篇文章，已经将toydb的各个模块都分析"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Blog",
      "item": "http://itfischer.space/en/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Tech",
      "item": "http://itfischer.space/en/posts/tech/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "toydb",
      "item": "http://itfischer.space/en/posts/tech/toydb/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "06-SQL Execution",
      "item": "http://itfischer.space/en/posts/tech/toydb/06-sql-execution/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "06-SQL Execution",
  "name": "06-SQL Execution",
  "description": "本系列的第一章00-Architecture以SQL执行流程为整个系列做了一个引子，目前本系列通过六篇文章，已经将toydb的各个模块都分析",
  "keywords": [
    
  ],
  "articleBody": "本系列的第一章00-Architecture以SQL执行流程为整个系列做了一个引子，目前本系列通过六篇文章，已经将toydb的各个模块都分析完毕，在本章中，不妨在了解了各个模块的基础上，补全SQL执行的全流程，为整个系列收尾。\n笔者会先补全Schema部分，介绍一下在toydb中如何构建起关系模型，之后是SQL执行的全流程，大致可以分为两部分：\n一是在SQL层中，完成Parse -\u003e Optimize -\u003e Execute的过程 二是在SQL Engine中，完成分布式 + 存储的过程 由于调用链比较长，并且每一步都会处理多种类型，从而代码量非常庞大，如果一味全部复制粘贴的话会导致逻辑非常不连贯，观感非常不好，因此在这一章当中，对于近似类型的处理，笔者只会保留其中的几个，如果想了解全部实现的话，还请读者自行拉取源码阅读。\nSchema 数据类型 toydb中提供了四种数据类型的支持，分别是Boolean、Integer、Float、String，定义在src/sql/types/mod.rs中：\n1 2 3 4 5 6 7 8 /// A datatype #[derive(Clone, Debug, Hash, PartialEq, Serialize, Deserialize)] pub enum DataType { Boolean, Integer, Float, String, } Value使用一个enum来实现，表示不同类型的值，除了上面的四种数据类型，还允许值为Null，然后提供了一些hash和数据类型转换的支持：\n1 2 3 4 5 6 7 8 9 /// A specific value of a data type #[derive(Clone, Debug, PartialEq, Serialize, Deserialize)] pub enum Value { Null, Boolean(bool), Integer(i64), Float(f64), String(String), } toydb的Schema非常简单，只有两级，分别是table和column，定义在src/schema.rs当中，而Row只是一个Vec,没有封装其他逻辑。\nTable 由于底层toydb采用的是kv存储，不需要在Table当中定义存储的行为，Table的结构和实现 都非常简洁，结构体中只有两个字段，分别用于表示表名和包含的字段，然后定义了一个迭代器，表示多个Table，用于扫描当前所有的Table：\n1 2 3 4 5 6 7 8 9 /// A table scan iterator pub type Tables = Box\u003cdyn DoubleEndedIterator",
  "wordCount" : "8746",
  "inLanguage": "en",
  "datePublished": "0001-01-01T00:00:00Z",
  "dateModified": "0001-01-01T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "Sulv"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://itfischer.space/en/posts/tech/toydb/06-sql-execution/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Fischer's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "http://itfischer.space/img/Navigation.svg"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://itfischer.space/en/" accesskey="h" title="Fischer&#39;s Blog (Alt + H)">
                <img src="http://itfischer.space/img/Navigation.svg" alt="" aria-label="logo"
                    height="35">Fischer&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://itfischer.space/en/search" title="Search">
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="http://itfischer.space/en/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="http://itfischer.space/en/posts" title="Posts">
                    <span>Posts</span>
                </a>
            </li>
            <li>
                <a href="http://itfischer.space/en/archives/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="http://itfischer.space/en/tags" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="http://itfischer.space/en/about" title="About">
                    <span>About</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://itfischer.space/en/">Home</a>&nbsp;»&nbsp;<a href="http://itfischer.space/en/posts/">Blog</a>&nbsp;»&nbsp;<a href="http://itfischer.space/en/posts/tech/">Tech</a>&nbsp;»&nbsp;<a href="http://itfischer.space/en/posts/tech/toydb/">toydb</a></div>
    <h1 class="post-title entry-hint-parent">
      06-SQL Execution
    </h1>
    <div class="post-meta">18 min&nbsp;·&nbsp;Sulv

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#schema" aria-label="Schema">Schema</a><ul>
                        
                <li>
                    <a href="#%e6%95%b0%e6%8d%ae%e7%b1%bb%e5%9e%8b" aria-label="数据类型">数据类型</a></li>
                <li>
                    <a href="#table" aria-label="Table">Table</a></li>
                <li>
                    <a href="#column" aria-label="Column">Column</a></li>
                <li>
                    <a href="#%e5%88%9d%e5%a7%8b%e5%8c%96" aria-label="初始化">初始化</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%89%a7%e8%a1%8c%e6%b5%81%e7%a8%8b" aria-label="执行流程">执行流程</a><ul>
                        
                <li>
                    <a href="#sql%e6%89%a7%e8%a1%8c" aria-label="SQL执行">SQL执行</a><ul>
                        
                <li>
                    <a href="#parser" aria-label="Parser">Parser</a></li>
                <li>
                    <a href="#plan" aria-label="Plan">Plan</a></li>
                <li>
                    <a href="#executor" aria-label="Executor">Executor</a></li></ul>
                </li>
                <li>
                    <a href="#sql-engine" aria-label="SQL Engine">SQL Engine</a><ul>
                        
                <li>
                    <a href="#read" aria-label="Read">Read</a></li>
                <li>
                    <a href="#write" aria-label="Write">Write</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e5%90%8e%e8%ae%b0" aria-label="后记">后记</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>本系列的第一章<em>00-Architecture</em>以SQL执行流程为整个系列做了一个引子，目前本系列通过六篇文章，已经将toydb的各个模块都分析完毕，在本章中，不妨在了解了各个模块的基础上，补全SQL执行的全流程，为整个系列收尾。</p>
<p>笔者会先补全Schema部分，介绍一下在toydb中如何构建起关系模型，之后是SQL执行的全流程，大致可以分为两部分：</p>
<ul>
<li>一是在SQL层中，完成Parse -&gt; Optimize -&gt; Execute的过程</li>
<li>二是在SQL Engine中，完成分布式 + 存储的过程</li>
</ul>
<p>由于调用链比较长，并且每一步都会处理多种类型，从而代码量非常庞大，如果一味全部复制粘贴的话会导致逻辑非常不连贯，观感非常不好，因此在这一章当中，对于近似类型的处理，笔者只会保留其中的几个，如果想了解全部实现的话，还请读者自行拉取源码阅读。</p>
<h2 id="schema">Schema<a hidden class="anchor" aria-hidden="true" href="#schema">#</a></h2>
<h3 id="数据类型">数据类型<a hidden class="anchor" aria-hidden="true" href="#数据类型">#</a></h3>
<p>toydb中提供了四种数据类型的支持，分别是<code>Boolean</code>、<code>Integer</code>、<code>Float</code>、<code>String</code>，定义在<code>src/sql/types/mod.rs</code>中：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">/// A datatype
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span><span style="color:#0f0;font-weight:bold">#[derive(Clone, Debug, Hash, PartialEq, Serialize, Deserialize)]</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">pub</span> <span style="color:#fff;font-weight:bold">enum</span> DataType {
</span></span><span style="display:flex;"><span>    Boolean,
</span></span><span style="display:flex;"><span>    Integer,
</span></span><span style="display:flex;"><span>    Float,
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">String</span>,
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Value使用一个enum来实现，表示不同类型的值，除了上面的四种数据类型，还允许值为Null，然后提供了一些hash和数据类型转换的支持：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">/// A specific value of a data type
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span><span style="color:#0f0;font-weight:bold">#[derive(Clone, Debug, PartialEq, Serialize, Deserialize)]</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">pub</span> <span style="color:#fff;font-weight:bold">enum</span> Value {
</span></span><span style="display:flex;"><span>    Null,
</span></span><span style="display:flex;"><span>    Boolean(<span style="color:#fff;font-weight:bold">bool</span>),
</span></span><span style="display:flex;"><span>    Integer(<span style="color:#fff;font-weight:bold">i64</span>),
</span></span><span style="display:flex;"><span>    Float(<span style="color:#fff;font-weight:bold">f64</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">String</span>(<span style="color:#fff;font-weight:bold">String</span>),
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>toydb的Schema非常简单，只有两级，分别是table和column，定义在<code>src/schema.rs</code>当中，而Row只是一个<code>Vec&lt;Value&gt;</code>,没有封装其他逻辑。</p>
<h3 id="table">Table<a hidden class="anchor" aria-hidden="true" href="#table">#</a></h3>
<p>由于底层toydb采用的是kv存储，不需要在Table当中定义存储的行为，Table的结构和实现
都非常简洁，结构体中只有两个字段，分别用于表示表名和包含的字段，然后定义了一个迭代器，表示多个Table，用于扫描当前所有的Table：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">/// A table scan iterator
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span><span style="color:#fff;font-weight:bold">pub</span> <span style="color:#fff;font-weight:bold">type</span> Tables = <span style="color:#fff;font-weight:bold">Box</span>&lt;<span style="color:#fff;font-weight:bold">dyn</span> <span style="color:#fff;font-weight:bold">DoubleEndedIterator</span>&lt;Item = Table&gt; + <span style="color:#fff;font-weight:bold">Send</span>&gt;;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">/// A table schema
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span><span style="color:#0f0;font-weight:bold">#[derive(Clone, Debug, PartialEq, Deserialize, Serialize)]</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">pub</span> <span style="color:#fff;font-weight:bold">struct</span> Table {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">pub</span> name: <span style="color:#fff;font-weight:bold">String</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">pub</span> columns: <span style="color:#fff;font-weight:bold">Vec</span>&lt;Column&gt;,
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><table>
<thead>
<tr>
<th style="text-align:left">方法</th>
<th style="text-align:left">功能</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">pub fn get_column(&amp;self, name: &amp;str)</td>
<td style="text-align:left">根据名称获取列</td>
</tr>
<tr>
<td style="text-align:left">pub fn get_column_index(&amp;self, name: &amp;str)</td>
<td style="text-align:left">根据名称获取列索引</td>
</tr>
<tr>
<td style="text-align:left">pub fn get_primary_key(&amp;self)</td>
<td style="text-align:left">获取主键的列</td>
</tr>
<tr>
<td style="text-align:left">pub fn get_row_key(&amp;self, row: &amp;[Value])</td>
<td style="text-align:left">获取一行中主键的值</td>
</tr>
<tr>
<td style="text-align:left">pub fn validate(&amp;self, txn: &amp;mut dyn Transaction)</td>
<td style="text-align:left">验证表结构</td>
</tr>
<tr>
<td style="text-align:left">pub fn validate_row(&amp;self, row: &amp;[Value], txn: &amp;mut dyn Transaction)</td>
<td style="text-align:left">验证行结构</td>
</tr>
</tbody>
</table>
<p>各个方法的实现逻辑都很简单：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">69
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">impl</span> Table {
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">/// Creates a new table schema
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    <span style="color:#fff;font-weight:bold">pub</span> <span style="color:#fff;font-weight:bold">fn</span> new(name: <span style="color:#fff;font-weight:bold">String</span>, columns: <span style="color:#fff;font-weight:bold">Vec</span>&lt;Column&gt;) -&gt; <span style="color:#fff;font-weight:bold">Result</span>&lt;Self&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">let</span> table = Self { name, columns };
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">Ok</span>(table)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">/// Fetches a column by name
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    <span style="color:#fff;font-weight:bold">pub</span> <span style="color:#fff;font-weight:bold">fn</span> get_column(&amp;self, name: <span style="color:#fff;font-weight:bold">&amp;</span><span style="color:#fff;font-weight:bold">str</span>) -&gt; <span style="color:#fff;font-weight:bold">Result</span>&lt;&amp;Column&gt; {
</span></span><span style="display:flex;"><span>        self.columns.iter().find(|c| c.name == name).ok_or_else(|| {
</span></span><span style="display:flex;"><span>            Error::Value(format!(<span style="color:#0ff;font-weight:bold">&#34;Column </span><span style="color:#0ff;font-weight:bold">{}</span><span style="color:#0ff;font-weight:bold"> not found in table </span><span style="color:#0ff;font-weight:bold">{}</span><span style="color:#0ff;font-weight:bold">&#34;</span>, name, self.name))
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">/// Fetches a column index by name
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    <span style="color:#fff;font-weight:bold">pub</span> <span style="color:#fff;font-weight:bold">fn</span> get_column_index(&amp;self, name: <span style="color:#fff;font-weight:bold">&amp;</span><span style="color:#fff;font-weight:bold">str</span>) -&gt; <span style="color:#fff;font-weight:bold">Result</span>&lt;<span style="color:#fff;font-weight:bold">usize</span>&gt; {
</span></span><span style="display:flex;"><span>        self.columns.iter().position(|c| c.name == name).ok_or_else(|| {
</span></span><span style="display:flex;"><span>            Error::Value(format!(<span style="color:#0ff;font-weight:bold">&#34;Column </span><span style="color:#0ff;font-weight:bold">{}</span><span style="color:#0ff;font-weight:bold"> not found in table </span><span style="color:#0ff;font-weight:bold">{}</span><span style="color:#0ff;font-weight:bold">&#34;</span>, name, self.name))
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">/// Returns the primary key column of the table
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    <span style="color:#fff;font-weight:bold">pub</span> <span style="color:#fff;font-weight:bold">fn</span> get_primary_key(&amp;self) -&gt; <span style="color:#fff;font-weight:bold">Result</span>&lt;&amp;Column&gt; {
</span></span><span style="display:flex;"><span>        self.columns
</span></span><span style="display:flex;"><span>            .iter()
</span></span><span style="display:flex;"><span>            .find(|c| c.primary_key)
</span></span><span style="display:flex;"><span>            .ok_or_else(|| Error::Value(format!(<span style="color:#0ff;font-weight:bold">&#34;Primary key not found in table </span><span style="color:#0ff;font-weight:bold">{}</span><span style="color:#0ff;font-weight:bold">&#34;</span>, self.name)))
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">/// Returns the primary key value of a row
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    <span style="color:#fff;font-weight:bold">pub</span> <span style="color:#fff;font-weight:bold">fn</span> get_row_key(&amp;self, row: <span style="color:#fff;font-weight:bold">&amp;</span>[Value]) -&gt; <span style="color:#fff;font-weight:bold">Result</span>&lt;Value&gt; {
</span></span><span style="display:flex;"><span>        row.get(
</span></span><span style="display:flex;"><span>            self.columns
</span></span><span style="display:flex;"><span>                .iter()
</span></span><span style="display:flex;"><span>                .position(|c| c.primary_key)
</span></span><span style="display:flex;"><span>                .ok_or_else(|| Error::Value(<span style="color:#0ff;font-weight:bold">&#34;Primary key not found&#34;</span>.into()))?,
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        .cloned()
</span></span><span style="display:flex;"><span>        .ok_or_else(|| Error::Value(<span style="color:#0ff;font-weight:bold">&#34;Primary key value not found for row&#34;</span>.into()))
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">/// Validates the table schema
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    <span style="color:#fff;font-weight:bold">pub</span> <span style="color:#fff;font-weight:bold">fn</span> validate(&amp;self, txn: <span style="color:#fff;font-weight:bold">&amp;</span>mut <span style="color:#fff;font-weight:bold">dyn</span> Transaction) -&gt; <span style="color:#fff;font-weight:bold">Result</span>&lt;()&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> self.columns.is_empty() {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">Err</span>(Error::Value(format!(<span style="color:#0ff;font-weight:bold">&#34;Table </span><span style="color:#0ff;font-weight:bold">{}</span><span style="color:#0ff;font-weight:bold"> has no columns&#34;</span>, self.name)));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">match</span> self.columns.iter().filter(|c| c.primary_key).count() {
</span></span><span style="display:flex;"><span>            <span style="color:#ff0;font-weight:bold">1</span> =&gt; {}
</span></span><span style="display:flex;"><span>            <span style="color:#ff0;font-weight:bold">0</span> =&gt; <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">Err</span>(Error::Value(format!(<span style="color:#0ff;font-weight:bold">&#34;No primary key in table </span><span style="color:#0ff;font-weight:bold">{}</span><span style="color:#0ff;font-weight:bold">&#34;</span>, self.name))),
</span></span><span style="display:flex;"><span>            _ =&gt; <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">Err</span>(Error::Value(format!(<span style="color:#0ff;font-weight:bold">&#34;Multiple primary keys in table </span><span style="color:#0ff;font-weight:bold">{}</span><span style="color:#0ff;font-weight:bold">&#34;</span>, self.name))),
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> column <span style="color:#fff;font-weight:bold">in</span> &amp;self.columns {
</span></span><span style="display:flex;"><span>            column.validate(self, txn)?;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">Ok</span>(())
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">/// Validates a row
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    <span style="color:#fff;font-weight:bold">pub</span> <span style="color:#fff;font-weight:bold">fn</span> validate_row(&amp;self, row: <span style="color:#fff;font-weight:bold">&amp;</span>[Value], txn: <span style="color:#fff;font-weight:bold">&amp;</span>mut <span style="color:#fff;font-weight:bold">dyn</span> Transaction) -&gt; <span style="color:#fff;font-weight:bold">Result</span>&lt;()&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> row.len() != self.columns.len() {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">Err</span>(Error::Value(format!(<span style="color:#0ff;font-weight:bold">&#34;Invalid row size for table </span><span style="color:#0ff;font-weight:bold">{}</span><span style="color:#0ff;font-weight:bold">&#34;</span>, self.name)));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">let</span> pk = self.get_row_key(row)?;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> (column, value) <span style="color:#fff;font-weight:bold">in</span> self.columns.iter().zip(row.iter()) {
</span></span><span style="display:flex;"><span>            column.validate_value(self, &amp;pk, value, txn)?;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">Ok</span>(())
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="column">Column<a hidden class="anchor" aria-hidden="true" href="#column">#</a></h3>
<p>Column同样很简洁，定义如下，均以给出注释：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">/// A table column schema
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span><span style="color:#0f0;font-weight:bold">#[derive(Clone, Debug, PartialEq, Deserialize, Serialize)]</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">pub</span> <span style="color:#fff;font-weight:bold">struct</span> Column {
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">/// Column name
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    <span style="color:#fff;font-weight:bold">pub</span> name: <span style="color:#fff;font-weight:bold">String</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">/// Column datatype
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    <span style="color:#fff;font-weight:bold">pub</span> datatype: DataType,
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">/// Whether the column is a primary key
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    <span style="color:#fff;font-weight:bold">pub</span> primary_key: <span style="color:#fff;font-weight:bold">bool</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">/// Whether the column allows null values
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    <span style="color:#fff;font-weight:bold">pub</span> nullable: <span style="color:#fff;font-weight:bold">bool</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">/// The default value of the column
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    <span style="color:#fff;font-weight:bold">pub</span> default: <span style="color:#fff;font-weight:bold">Option</span>&lt;Value&gt;,
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">/// Whether the column should only take unique values
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    <span style="color:#fff;font-weight:bold">pub</span> unique: <span style="color:#fff;font-weight:bold">bool</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">/// The table which is referenced by this foreign key
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    <span style="color:#fff;font-weight:bold">pub</span> references: <span style="color:#fff;font-weight:bold">Option</span>&lt;<span style="color:#fff;font-weight:bold">String</span>&gt;,
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">/// Whether the column should be indexed
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    <span style="color:#fff;font-weight:bold">pub</span> index: <span style="color:#fff;font-weight:bold">bool</span>,
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>在column当中，定义了<code>validate</code>和<code>validate_column</code>分别验证列和列当中的值是否合法：
在<code>validate</code>中做了如下检查：</p>
<ol>
<li>主键不能设置为null</li>
<li>主键必须是唯一的，其中的值不允许重复，因为要用于生成key来存储</li>
<li>验证默认值：默认值的类型必须与column的类型相同；不允许将null设置为非null column的默认值；允许为null的column必须设置默认值。</li>
<li>检查外键引用</li>
</ol>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">/// Validates the column schema
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    <span style="color:#fff;font-weight:bold">pub</span> <span style="color:#fff;font-weight:bold">fn</span> validate(&amp;self, table: <span style="color:#fff;font-weight:bold">&amp;</span>Table, txn: <span style="color:#fff;font-weight:bold">&amp;</span>mut <span style="color:#fff;font-weight:bold">dyn</span> Transaction) -&gt; <span style="color:#fff;font-weight:bold">Result</span>&lt;()&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// Validate primary key
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> self.primary_key &amp;&amp; self.nullable {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">Err</span>(Error::Value(format!(<span style="color:#0ff;font-weight:bold">&#34;Primary key </span><span style="color:#0ff;font-weight:bold">{}</span><span style="color:#0ff;font-weight:bold"> cannot be nullable&#34;</span>, self.name)));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> self.primary_key &amp;&amp; !self.unique {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">Err</span>(Error::Value(format!(<span style="color:#0ff;font-weight:bold">&#34;Primary key </span><span style="color:#0ff;font-weight:bold">{}</span><span style="color:#0ff;font-weight:bold"> must be unique&#34;</span>, self.name)));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// Validate default value
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> <span style="color:#fff;font-weight:bold">let</span> <span style="color:#fff;font-weight:bold">Some</span>(default) = &amp;self.default {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> <span style="color:#fff;font-weight:bold">let</span> <span style="color:#fff;font-weight:bold">Some</span>(datatype) = default.datatype() {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span> datatype != self.datatype {
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">Err</span>(Error::Value(format!(
</span></span><span style="display:flex;"><span>                        <span style="color:#0ff;font-weight:bold">&#34;Default value for column </span><span style="color:#0ff;font-weight:bold">{}</span><span style="color:#0ff;font-weight:bold"> has datatype </span><span style="color:#0ff;font-weight:bold">{}</span><span style="color:#0ff;font-weight:bold">, must be </span><span style="color:#0ff;font-weight:bold">{}</span><span style="color:#0ff;font-weight:bold">&#34;</span>,
</span></span><span style="display:flex;"><span>                        self.name, datatype, self.datatype
</span></span><span style="display:flex;"><span>                    )));
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            } <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> !self.nullable {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">Err</span>(Error::Value(format!(
</span></span><span style="display:flex;"><span>                    <span style="color:#0ff;font-weight:bold">&#34;Can&#39;t use NULL as default value for non-nullable column </span><span style="color:#0ff;font-weight:bold">{}</span><span style="color:#0ff;font-weight:bold">&#34;</span>,
</span></span><span style="display:flex;"><span>                    self.name
</span></span><span style="display:flex;"><span>                )));
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> self.nullable {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">Err</span>(Error::Value(format!(
</span></span><span style="display:flex;"><span>                <span style="color:#0ff;font-weight:bold">&#34;Nullable column </span><span style="color:#0ff;font-weight:bold">{}</span><span style="color:#0ff;font-weight:bold"> must have a default value&#34;</span>,
</span></span><span style="display:flex;"><span>                self.name
</span></span><span style="display:flex;"><span>            )));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// Validate references
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> <span style="color:#fff;font-weight:bold">let</span> <span style="color:#fff;font-weight:bold">Some</span>(reference) = &amp;self.references {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">let</span> target = <span style="color:#fff;font-weight:bold">if</span> reference == &amp;table.name {
</span></span><span style="display:flex;"><span>                table.clone()
</span></span><span style="display:flex;"><span>            } <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> <span style="color:#fff;font-weight:bold">let</span> <span style="color:#fff;font-weight:bold">Some</span>(table) = txn.read_table(reference)? {
</span></span><span style="display:flex;"><span>                table
</span></span><span style="display:flex;"><span>            } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">Err</span>(Error::Value(format!(
</span></span><span style="display:flex;"><span>                    <span style="color:#0ff;font-weight:bold">&#34;Table </span><span style="color:#0ff;font-weight:bold">{}</span><span style="color:#0ff;font-weight:bold"> referenced by column </span><span style="color:#0ff;font-weight:bold">{}</span><span style="color:#0ff;font-weight:bold"> does not exist&#34;</span>,
</span></span><span style="display:flex;"><span>                    reference, self.name
</span></span><span style="display:flex;"><span>                )));
</span></span><span style="display:flex;"><span>            };
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> self.datatype != target.get_primary_key()?.datatype {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">Err</span>(Error::Value(format!(
</span></span><span style="display:flex;"><span>                    <span style="color:#0ff;font-weight:bold">&#34;Can&#39;t reference </span><span style="color:#0ff;font-weight:bold">{}</span><span style="color:#0ff;font-weight:bold"> primary key of table </span><span style="color:#0ff;font-weight:bold">{}</span><span style="color:#0ff;font-weight:bold"> from </span><span style="color:#0ff;font-weight:bold">{}</span><span style="color:#0ff;font-weight:bold"> column </span><span style="color:#0ff;font-weight:bold">{}</span><span style="color:#0ff;font-weight:bold">&#34;</span>,
</span></span><span style="display:flex;"><span>                    target.get_primary_key()?.datatype,
</span></span><span style="display:flex;"><span>                    target.name,
</span></span><span style="display:flex;"><span>                    self.datatype,
</span></span><span style="display:flex;"><span>                    self.name
</span></span><span style="display:flex;"><span>                )));
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">Ok</span>(())
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></td></tr></table>
</div>
</div><p>在<code>validate_value</code>中做了如下检查：</p>
<ol>
<li>检验数据类型是否与column的数据类型匹配</li>
<li>String类型不能过长，最大为1024个字节</li>
<li>检查外键</li>
<li>检查unique，处理方法是全表遍历检测是否有相同的值</li>
</ol>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">/// Validates a column value
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    <span style="color:#fff;font-weight:bold">pub</span> <span style="color:#fff;font-weight:bold">fn</span> validate_value(
</span></span><span style="display:flex;"><span>        &amp;self,
</span></span><span style="display:flex;"><span>        table: <span style="color:#fff;font-weight:bold">&amp;</span>Table,
</span></span><span style="display:flex;"><span>        pk: <span style="color:#fff;font-weight:bold">&amp;</span>Value,
</span></span><span style="display:flex;"><span>        value: <span style="color:#fff;font-weight:bold">&amp;</span>Value,
</span></span><span style="display:flex;"><span>        txn: <span style="color:#fff;font-weight:bold">&amp;</span>mut <span style="color:#fff;font-weight:bold">dyn</span> Transaction,
</span></span><span style="display:flex;"><span>    ) -&gt; <span style="color:#fff;font-weight:bold">Result</span>&lt;()&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// Validate datatype
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">match</span> value.datatype() {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">None</span> <span style="color:#fff;font-weight:bold">if</span> self.nullable =&gt; <span style="color:#fff;font-weight:bold">Ok</span>(()),
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">None</span> =&gt; <span style="color:#fff;font-weight:bold">Err</span>(Error::Value(format!(<span style="color:#0ff;font-weight:bold">&#34;NULL value not allowed for column </span><span style="color:#0ff;font-weight:bold">{}</span><span style="color:#0ff;font-weight:bold">&#34;</span>, self.name))),
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">Some</span>(<span style="color:#fff;font-weight:bold">ref</span> datatype) <span style="color:#fff;font-weight:bold">if</span> datatype != &amp;self.datatype =&gt; <span style="color:#fff;font-weight:bold">Err</span>(Error::Value(format!(
</span></span><span style="display:flex;"><span>                <span style="color:#0ff;font-weight:bold">&#34;Invalid datatype </span><span style="color:#0ff;font-weight:bold">{}</span><span style="color:#0ff;font-weight:bold"> for </span><span style="color:#0ff;font-weight:bold">{}</span><span style="color:#0ff;font-weight:bold"> column </span><span style="color:#0ff;font-weight:bold">{}</span><span style="color:#0ff;font-weight:bold">&#34;</span>,
</span></span><span style="display:flex;"><span>                datatype, self.datatype, self.name
</span></span><span style="display:flex;"><span>            ))),
</span></span><span style="display:flex;"><span>            _ =&gt; <span style="color:#fff;font-weight:bold">Ok</span>(()),
</span></span><span style="display:flex;"><span>        }?;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// Validate value
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">match</span> value {
</span></span><span style="display:flex;"><span>            Value::<span style="color:#fff;font-weight:bold">String</span>(s) <span style="color:#fff;font-weight:bold">if</span> s.len() &gt; <span style="color:#ff0;font-weight:bold">1024</span> =&gt; {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">Err</span>(Error::Value(<span style="color:#0ff;font-weight:bold">&#34;Strings cannot be more than 1024 bytes&#34;</span>.into()))
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            _ =&gt; <span style="color:#fff;font-weight:bold">Ok</span>(()),
</span></span><span style="display:flex;"><span>        }?;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// Validate outgoing references
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> <span style="color:#fff;font-weight:bold">let</span> <span style="color:#fff;font-weight:bold">Some</span>(target) = &amp;self.references {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">match</span> value {
</span></span><span style="display:flex;"><span>                Value::Null =&gt; <span style="color:#fff;font-weight:bold">Ok</span>(()),
</span></span><span style="display:flex;"><span>                Value::Float(f) <span style="color:#fff;font-weight:bold">if</span> f.is_nan() =&gt; <span style="color:#fff;font-weight:bold">Ok</span>(()),
</span></span><span style="display:flex;"><span>                v <span style="color:#fff;font-weight:bold">if</span> target == &amp;table.name &amp;&amp; v == pk =&gt; <span style="color:#fff;font-weight:bold">Ok</span>(()),
</span></span><span style="display:flex;"><span>                v <span style="color:#fff;font-weight:bold">if</span> txn.read(target, v)?.is_none() =&gt; <span style="color:#fff;font-weight:bold">Err</span>(Error::Value(format!(
</span></span><span style="display:flex;"><span>                    <span style="color:#0ff;font-weight:bold">&#34;Referenced primary key </span><span style="color:#0ff;font-weight:bold">{}</span><span style="color:#0ff;font-weight:bold"> in table </span><span style="color:#0ff;font-weight:bold">{}</span><span style="color:#0ff;font-weight:bold"> does not exist&#34;</span>,
</span></span><span style="display:flex;"><span>                    v, target,
</span></span><span style="display:flex;"><span>                ))),
</span></span><span style="display:flex;"><span>                _ =&gt; <span style="color:#fff;font-weight:bold">Ok</span>(()),
</span></span><span style="display:flex;"><span>            }?;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// Validate uniqueness constraints
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> self.unique &amp;&amp; !self.primary_key &amp;&amp; value != &amp;Value::Null {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">let</span> index = table.get_column_index(&amp;self.name)?;
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">let</span> <span style="color:#fff;font-weight:bold">mut</span> scan = txn.scan(&amp;table.name, <span style="color:#fff;font-weight:bold">None</span>)?;
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">while</span> <span style="color:#fff;font-weight:bold">let</span> <span style="color:#fff;font-weight:bold">Some</span>(row) = scan.next().transpose()? {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span> row.get(index).unwrap_or(&amp;Value::Null) == value
</span></span><span style="display:flex;"><span>                    &amp;&amp; &amp;table.get_row_key(&amp;row)? != pk
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">Err</span>(Error::Value(format!(
</span></span><span style="display:flex;"><span>                        <span style="color:#0ff;font-weight:bold">&#34;Unique value </span><span style="color:#0ff;font-weight:bold">{}</span><span style="color:#0ff;font-weight:bold"> already exists for column </span><span style="color:#0ff;font-weight:bold">{}</span><span style="color:#0ff;font-weight:bold">&#34;</span>,
</span></span><span style="display:flex;"><span>                        value, self.name
</span></span><span style="display:flex;"><span>                    )));
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">Ok</span>(())
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="初始化">初始化<a hidden class="anchor" aria-hidden="true" href="#初始化">#</a></h3>
<p>在main函数当中，会调用<code>serve</code>启动服务：</p>
<ol>
<li>在<code>serve</code>当中会首先创建一个sql_engine，这里可以看到，sql_engine对应的是<code>sql::engine::Raft</code>,这也是SQL Engine的入口，executor会首先将命令发送给Raft</li>
<li>调用<code>raft.serve()</code>启动Raft，创建用于节点之间交互的tcp sender和receiver，创建一个eventloop处理Message，eventloop如何处理Message，在上一章中已经介绍过。</li>
<li>调用<code>serve_sql()</code>启动server，处理client发送而来的请求。</li>
</ol>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>        <span style="color:#0ff;font-weight:bold">/// Serves Raft and SQL requests until the returned future is dropped. Consumes the server.
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    <span style="color:#fff;font-weight:bold">pub</span> <span style="color:#fff;font-weight:bold">async</span> <span style="color:#fff;font-weight:bold">fn</span> serve(self) -&gt; <span style="color:#fff;font-weight:bold">Result</span>&lt;()&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">let</span> sql_listener = self
</span></span><span style="display:flex;"><span>            .sql_listener
</span></span><span style="display:flex;"><span>            .ok_or_else(|| Error::Internal(<span style="color:#0ff;font-weight:bold">&#34;Must listen before serving&#34;</span>.into()))?;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">let</span> raft_listener = self
</span></span><span style="display:flex;"><span>            .raft_listener
</span></span><span style="display:flex;"><span>            .ok_or_else(|| Error::Internal(<span style="color:#0ff;font-weight:bold">&#34;Must listen before serving&#34;</span>.into()))?;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">let</span> (raft_tx, raft_rx) = mpsc::unbounded_channel();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">let</span> sql_engine = sql::engine::Raft::new(raft_tx);
</span></span><span style="display:flex;"><span>		<span style="color:#007f7f">// 分别启动Raft server和Sql server
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        tokio::try_join!(
</span></span><span style="display:flex;"><span>            self.raft.serve(raft_listener, raft_rx),
</span></span><span style="display:flex;"><span>            Self::serve_sql(sql_listener, sql_engine),
</span></span><span style="display:flex;"><span>        )?;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">Ok</span>(())
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">pub</span> <span style="color:#fff;font-weight:bold">async</span> <span style="color:#fff;font-weight:bold">fn</span> serve(
</span></span><span style="display:flex;"><span>        self,
</span></span><span style="display:flex;"><span>        listener: TcpListener,
</span></span><span style="display:flex;"><span>        client_rx: mpsc::UnboundedReceiver&lt;(Request, oneshot::Sender&lt;<span style="color:#fff;font-weight:bold">Result</span>&lt;Response&gt;&gt;)&gt;,
</span></span><span style="display:flex;"><span>    ) -&gt; <span style="color:#fff;font-weight:bold">Result</span>&lt;()&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">let</span> (tcp_in_tx, tcp_in_rx) = mpsc::unbounded_channel::&lt;Message&gt;();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">let</span> (tcp_out_tx, tcp_out_rx) = mpsc::unbounded_channel::&lt;Message&gt;();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">let</span> (task, tcp_receiver) = Self::tcp_receive(listener, tcp_in_tx).remote_handle();
</span></span><span style="display:flex;"><span>        tokio::spawn(task);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">let</span> (task, tcp_sender) = Self::tcp_send(self.peers, tcp_out_rx).remote_handle();
</span></span><span style="display:flex;"><span>        tokio::spawn(task);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">let</span> (task, eventloop) =
</span></span><span style="display:flex;"><span>            Self::eventloop(self.node, self.node_rx, client_rx, tcp_in_rx, tcp_out_tx)
</span></span><span style="display:flex;"><span>                .remote_handle();
</span></span><span style="display:flex;"><span>        tokio::spawn(task);
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>        tokio::try_join!(tcp_receiver, tcp_sender, eventloop)?;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">Ok</span>(())
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">/// Serves SQL clients.
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    <span style="color:#fff;font-weight:bold">async</span> <span style="color:#fff;font-weight:bold">fn</span> serve_sql(listener: TcpListener, engine: sql::engine::Raft) -&gt; <span style="color:#fff;font-weight:bold">Result</span>&lt;()&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">let</span> <span style="color:#fff;font-weight:bold">mut</span> listener = TcpListenerStream::new(listener);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">while</span> <span style="color:#fff;font-weight:bold">let</span> <span style="color:#fff;font-weight:bold">Some</span>(socket) = listener.try_next().<span style="color:#fff;font-weight:bold">await</span>? {
</span></span><span style="display:flex;"><span>	        <span style="color:#007f7f">// 处理单个请求
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">let</span> peer = socket.peer_addr()?;
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">let</span> session = Session::new(engine.clone())?;
</span></span><span style="display:flex;"><span>            tokio::spawn(<span style="color:#fff;font-weight:bold">async</span> <span style="color:#fff;font-weight:bold">move</span> {
</span></span><span style="display:flex;"><span>                info!(<span style="color:#0ff;font-weight:bold">&#34;Client {} connected&#34;</span>, peer);
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">match</span> session.handle(socket).<span style="color:#fff;font-weight:bold">await</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">Ok</span>(()) =&gt; info!(<span style="color:#0ff;font-weight:bold">&#34;Client {} disconnected&#34;</span>, peer),
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">Err</span>(err) =&gt; error!(<span style="color:#0ff;font-weight:bold">&#34;Client {} error: {}&#34;</span>, peer, err),
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            });
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">Ok</span>(())
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="执行流程">执行流程<a hidden class="anchor" aria-hidden="true" href="#执行流程">#</a></h2>
<h3 id="sql执行">SQL执行<a hidden class="anchor" aria-hidden="true" href="#sql执行">#</a></h3>
<p>SQL执行的入口在<code>serve_sql()</code>当中，从listener当中获取到单个请求之后，就会创建一个<code>Session</code>，然后把传下来的raft engine交给<code>Session</code>，一个<code>Session</code>用于负责一条SQL，在处理完网络连接之后，会调用到<code>Session.execute()</code>来从解析SQL的过程开始，执行一条SQL。</p>
<p>在execute中，会先使用Parser进行sql解析，然后根据生成的AST Statement去生成一个执行计划，然后再通过Optimizer进行优化，得到一个最终的执行计划，最后根据执行计划构建一个Executor，调用Executor的execute开始执行。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">/// Executes a query, managing transaction status for the session
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    <span style="color:#fff;font-weight:bold">pub</span> <span style="color:#fff;font-weight:bold">fn</span> execute(&amp;<span style="color:#fff;font-weight:bold">mut</span> self, query: <span style="color:#fff;font-weight:bold">&amp;</span><span style="color:#fff;font-weight:bold">str</span>) -&gt; <span style="color:#fff;font-weight:bold">Result</span>&lt;ResultSet&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// FIXME We should match on self.txn as well, but get this error:
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#007f7f">// error[E0009]: cannot bind by-move and by-ref in the same pattern
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#007f7f">// ...which seems like an arbitrary compiler limitation
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">match</span> Parser::new(query).parse()? {
</span></span><span style="display:flex;"><span>            ast::Statement::Begin { .. } <span style="color:#fff;font-weight:bold">if</span> self.txn.is_some() =&gt; {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">Err</span>(Error::Value(<span style="color:#0ff;font-weight:bold">&#34;Already in a transaction&#34;</span>.into()))
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#007f7f">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            statement =&gt; {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">let</span> <span style="color:#fff;font-weight:bold">mut</span> txn = self.engine.begin()?;
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">match</span> Plan::build(statement, &amp;<span style="color:#fff;font-weight:bold">mut</span> txn)?.optimize(&amp;<span style="color:#fff;font-weight:bold">mut</span> txn)?.execute(&amp;<span style="color:#fff;font-weight:bold">mut</span> txn) {
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">Ok</span>(result) =&gt; {
</span></span><span style="display:flex;"><span>                        txn.commit()?;
</span></span><span style="display:flex;"><span>                        <span style="color:#fff;font-weight:bold">Ok</span>(result)
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">Err</span>(error) =&gt; {
</span></span><span style="display:flex;"><span>                        txn.rollback()?;
</span></span><span style="display:flex;"><span>                        <span style="color:#fff;font-weight:bold">Err</span>(error)
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="https://pic-bed-1309931445.cos.ap-nanjing.myqcloud.com/blog/20231231184847.png" alt="image.png"  />
</p>
<h4 id="parser">Parser<a hidden class="anchor" aria-hidden="true" href="#parser">#</a></h4>
<p>在toydb当中，通过Parser会生成一个Statement，对于parser如何解析sql的过程，由于笔者没有系统学过编译原理，也几乎不懂编译原理，这里就不分析了，感兴趣的读者可自行阅读，这一部分定义在<code>src/parser</code>下。</p>
<p>在<code>Statement</code>当中，包含了SQL执行所需要的所有信息，使用<code>enum</code>进行表示：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">pub</span> <span style="color:#fff;font-weight:bold">enum</span> Statement {
</span></span><span style="display:flex;"><span>    Begin {
</span></span><span style="display:flex;"><span>        read_only: <span style="color:#fff;font-weight:bold">bool</span>,
</span></span><span style="display:flex;"><span>        as_of: <span style="color:#fff;font-weight:bold">Option</span>&lt;<span style="color:#fff;font-weight:bold">u64</span>&gt;,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    Commit,
</span></span><span style="display:flex;"><span>    Rollback,
</span></span><span style="display:flex;"><span>    Select {
</span></span><span style="display:flex;"><span>        select: <span style="color:#fff;font-weight:bold">Vec</span>&lt;(Expression, <span style="color:#fff;font-weight:bold">Option</span>&lt;<span style="color:#fff;font-weight:bold">String</span>&gt;)&gt;,
</span></span><span style="display:flex;"><span>        from: <span style="color:#fff;font-weight:bold">Vec</span>&lt;FromItem&gt;,
</span></span><span style="display:flex;"><span>        r#where: <span style="color:#fff;font-weight:bold">Option</span>&lt;Expression&gt;,
</span></span><span style="display:flex;"><span>        group_by: <span style="color:#fff;font-weight:bold">Vec</span>&lt;Expression&gt;,
</span></span><span style="display:flex;"><span>        having: <span style="color:#fff;font-weight:bold">Option</span>&lt;Expression&gt;,
</span></span><span style="display:flex;"><span>        order: <span style="color:#fff;font-weight:bold">Vec</span>&lt;(Expression, Order)&gt;,
</span></span><span style="display:flex;"><span>        offset: <span style="color:#fff;font-weight:bold">Option</span>&lt;Expression&gt;,
</span></span><span style="display:flex;"><span>        limit: <span style="color:#fff;font-weight:bold">Option</span>&lt;Expression&gt;,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="plan">Plan<a hidden class="anchor" aria-hidden="true" href="#plan">#</a></h4>
<p>在拿到了<code>Statement</code>之后，就可以根据<code>Statement</code>去生成一个基础的执行计划了，toydb中没有区分逻辑计划和物理计划，只定义了<code>plan</code>和对应的<code>plan node</code>。<code>Plan node</code>是使用<code>enum</code>进行定义的，结构上与<code>Executor</code>是一一对应的。</p>
<p><code>Plan</code>作为<code>Plan Node</code>的Wrapper，为其封装了一些方法：</p>
<ul>
<li><code>build</code>:根据Statement的类型，构建一个<code>Plan Node</code></li>
<li><code>optimize</code>:对<code>plan</code>进行优化生成一个最终的执行计划，</li>
<li><code>execute</code>:执行一个<code>plan</code>，会先根据自身的<code>Plan Node</code>去创建一个<code>Executor</code>，然后会调用到<code>Executor</code>的<code>execute</code></li>
</ul>
<p>在<code>optimize</code>当中，共涉及到了五种类型的优化：</p>
<ul>
<li><code>ConstantFolder</code>:提前计算一些常量表达式，如 where a &gt; 5 - 3优化为where a &gt; 2。</li>
<li><code>FilterPushdown</code>:谓词下推，为了让底层算子尽可能多的过滤数据，从而减少上层的计算量</li>
<li><code>IndexLookup</code>:如果当前Table上要查询的column存在索引，就将TableScan转换为IndexScan</li>
<li><code>NoopCleaner</code>:Noop意味No Operation，在这一部分清除掉一些没有意义的Node和Filter，例如where 1 = 1这类恒为true的</li>
<li><code>JoinType</code>:优化Join类型，目前会将NestedLoopJoin优化为HashJoin。</li>
</ul>
<p><code>build</code>和<code>execute</code>都会返回一个Self，从而进行链式调用，按照build -&gt; optimize -&gt; execute的流程来执行。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">/// A plan node
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span><span style="color:#0f0;font-weight:bold">#[derive(Debug, PartialEq, Serialize, Deserialize)]</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">pub</span> <span style="color:#fff;font-weight:bold">enum</span> Node {
</span></span><span style="display:flex;"><span>    Aggregation {
</span></span><span style="display:flex;"><span>        source: <span style="color:#fff;font-weight:bold">Box</span>&lt;Node&gt;,
</span></span><span style="display:flex;"><span>        aggregates: <span style="color:#fff;font-weight:bold">Vec</span>&lt;Aggregate&gt;,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    HashJoin {
</span></span><span style="display:flex;"><span>        left: <span style="color:#fff;font-weight:bold">Box</span>&lt;Node&gt;,
</span></span><span style="display:flex;"><span>        left_field: (<span style="color:#fff;font-weight:bold">usize</span>, <span style="color:#fff;font-weight:bold">Option</span>&lt;(<span style="color:#fff;font-weight:bold">Option</span>&lt;<span style="color:#fff;font-weight:bold">String</span>&gt;, <span style="color:#fff;font-weight:bold">String</span>)&gt;),
</span></span><span style="display:flex;"><span>        right: <span style="color:#fff;font-weight:bold">Box</span>&lt;Node&gt;,
</span></span><span style="display:flex;"><span>        right_field: (<span style="color:#fff;font-weight:bold">usize</span>, <span style="color:#fff;font-weight:bold">Option</span>&lt;(<span style="color:#fff;font-weight:bold">Option</span>&lt;<span style="color:#fff;font-weight:bold">String</span>&gt;, <span style="color:#fff;font-weight:bold">String</span>)&gt;),
</span></span><span style="display:flex;"><span>        outer: <span style="color:#fff;font-weight:bold">bool</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#007f7f">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    NestedLoopJoin {
</span></span><span style="display:flex;"><span>        left: <span style="color:#fff;font-weight:bold">Box</span>&lt;Node&gt;,
</span></span><span style="display:flex;"><span>        left_size: <span style="color:#fff;font-weight:bold">usize</span>,
</span></span><span style="display:flex;"><span>        right: <span style="color:#fff;font-weight:bold">Box</span>&lt;Node&gt;,
</span></span><span style="display:flex;"><span>        predicate: <span style="color:#fff;font-weight:bold">Option</span>&lt;Expression&gt;,
</span></span><span style="display:flex;"><span>        outer: <span style="color:#fff;font-weight:bold">bool</span>,
</span></span><span style="display:flex;"><span>    Update {
</span></span><span style="display:flex;"><span>        table: <span style="color:#fff;font-weight:bold">String</span>,
</span></span><span style="display:flex;"><span>        source: <span style="color:#fff;font-weight:bold">Box</span>&lt;Node&gt;,
</span></span><span style="display:flex;"><span>        expressions: <span style="color:#fff;font-weight:bold">Vec</span>&lt;(<span style="color:#fff;font-weight:bold">usize</span>, <span style="color:#fff;font-weight:bold">Option</span>&lt;<span style="color:#fff;font-weight:bold">String</span>&gt;, Expression)&gt;,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">pub</span> <span style="color:#fff;font-weight:bold">struct</span> Plan(<span style="color:#fff;font-weight:bold">pub</span> Node);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">impl</span> Plan {
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">/// Builds a plan from an AST statement.
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    <span style="color:#fff;font-weight:bold">pub</span> <span style="color:#fff;font-weight:bold">fn</span> build&lt;C: Catalog&gt;(statement: ast::Statement, catalog: <span style="color:#fff;font-weight:bold">&amp;</span>mut C) -&gt; <span style="color:#fff;font-weight:bold">Result</span>&lt;Self&gt; {
</span></span><span style="display:flex;"><span>        Planner::new(catalog).build(statement)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">/// Executes the plan, consuming it.
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    <span style="color:#fff;font-weight:bold">pub</span> <span style="color:#fff;font-weight:bold">fn</span> execute&lt;T: Transaction + <span style="color:#fff;font-weight:bold">&#39;static</span>&gt;(self, txn: <span style="color:#fff;font-weight:bold">&amp;</span>mut T) -&gt; <span style="color:#fff;font-weight:bold">Result</span>&lt;ResultSet&gt; {
</span></span><span style="display:flex;"><span>        &lt;<span style="color:#fff;font-weight:bold">dyn</span> Executor&lt;T&gt;&gt;::build(self.<span style="color:#ff0;font-weight:bold">0</span>).execute(txn)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">/// Optimizes the plan, consuming it.
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    <span style="color:#fff;font-weight:bold">pub</span> <span style="color:#fff;font-weight:bold">fn</span> optimize&lt;C: Catalog&gt;(self, catalog: <span style="color:#fff;font-weight:bold">&amp;</span>mut C) -&gt; <span style="color:#fff;font-weight:bold">Result</span>&lt;Self&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">let</span> <span style="color:#fff;font-weight:bold">mut</span> root = self.<span style="color:#ff0;font-weight:bold">0</span>;
</span></span><span style="display:flex;"><span>        root = optimizer::ConstantFolder.optimize(root)?;
</span></span><span style="display:flex;"><span>        root = optimizer::FilterPushdown.optimize(root)?;
</span></span><span style="display:flex;"><span>        root = optimizer::IndexLookup::new(catalog).optimize(root)?;
</span></span><span style="display:flex;"><span>        root = optimizer::NoopCleaner.optimize(root)?;
</span></span><span style="display:flex;"><span>        root = optimizer::JoinType.optimize(root)?;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">Ok</span>(Plan(root))
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="executor">Executor<a hidden class="anchor" aria-hidden="true" href="#executor">#</a></h4>
<p>在执行这一部分，toydb定义了一个trait，其中只有<code>execute</code>一个方法，只要实现了这个trait，就可以作为<code>Executor</code>被调用。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">pub</span> <span style="color:#fff;font-weight:bold">trait</span> Executor&lt;T: Transaction&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">/// Executes the executor, consuming it and returning a result set
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    <span style="color:#fff;font-weight:bold">fn</span> execute(self: <span style="color:#fff;font-weight:bold">Box</span>&lt;Self&gt;, txn: <span style="color:#fff;font-weight:bold">&amp;</span>mut T) -&gt; <span style="color:#fff;font-weight:bold">Result</span>&lt;ResultSet&gt;;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">pub</span> <span style="color:#fff;font-weight:bold">struct</span> Insert {
</span></span><span style="display:flex;"><span>    table: <span style="color:#fff;font-weight:bold">String</span>,
</span></span><span style="display:flex;"><span>    columns: <span style="color:#fff;font-weight:bold">Vec</span>&lt;<span style="color:#fff;font-weight:bold">String</span>&gt;,
</span></span><span style="display:flex;"><span>    rows: <span style="color:#fff;font-weight:bold">Vec</span>&lt;<span style="color:#fff;font-weight:bold">Vec</span>&lt;Expression&gt;&gt;,
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">impl</span>&lt;T: Transaction&gt; Executor&lt;T&gt; <span style="color:#fff;font-weight:bold">for</span> Insert {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">fn</span> execute(self: <span style="color:#fff;font-weight:bold">Box</span>&lt;Self&gt;, txn: <span style="color:#fff;font-weight:bold">&amp;</span>mut T) -&gt; <span style="color:#fff;font-weight:bold">Result</span>&lt;ResultSet&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">let</span> table = txn.must_read_table(&amp;self.table)?;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">let</span> <span style="color:#fff;font-weight:bold">mut</span> count = <span style="color:#ff0;font-weight:bold">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> expressions <span style="color:#fff;font-weight:bold">in</span> self.rows {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">let</span> <span style="color:#fff;font-weight:bold">mut</span> row =
</span></span><span style="display:flex;"><span>                expressions.into_iter().map(|expr| expr.evaluate(<span style="color:#fff;font-weight:bold">None</span>)).collect::&lt;<span style="color:#fff;font-weight:bold">Result</span>&lt;_&gt;&gt;()?;
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> self.columns.is_empty() {
</span></span><span style="display:flex;"><span>                row = Self::pad_row(&amp;table, row)?;
</span></span><span style="display:flex;"><span>            } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>                row = Self::make_row(&amp;table, &amp;self.columns, row)?;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            txn.create(&amp;table.name, row)?;
</span></span><span style="display:flex;"><span>            count += <span style="color:#ff0;font-weight:bold">1</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">Ok</span>(ResultSet::Create { count })
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>以Insert为例，首先定义一个Insert结构体，然后为Insert实现Executor trait。后续就是利用SQL Engine来先共识后存储了。</p>
<h3 id="sql-engine">SQL Engine<a hidden class="anchor" aria-hidden="true" href="#sql-engine">#</a></h3>
<p><img loading="lazy" src="https://pic-bed-1309931445.cos.ap-nanjing.myqcloud.com/blog/20231231155959.png" alt="image.png"  />
</p>
<h4 id="read">Read<a hidden class="anchor" aria-hidden="true" href="#read">#</a></h4>
<p>这里继续以Insert为例，走完SQL Engine的整个流程。Insert中需要先读取到对应的Table，之后再添加多条Row，分为一次读请求和多次写请求，刚好可以用来分析读写请求的执行流程。
<img loading="lazy" src="https://pic-bed-1309931445.cos.ap-nanjing.myqcloud.com/blog/20231231163657.png" alt="通信"  />

Insert时需要首先读取到对应的Table，这里就会调用SQL Engine的<code>txn.must_read_table()</code>，在该函数内，最终会调用到<code>sql::engine::raft::Transaction</code>的<code>read_table()</code>，在这里，会通过Raft Client向Raft Server去发送一条类型为<code>Query::ReadTable</code>的请求。</p>
<p><code>self.client.query()</code>，会调用到<code>execute()</code>。在<code>execute()</code>当中，会调用<code>oneshot::channel()</code>创建一个一次性的channel，将channel的消息发送端<code>response_tx</code>和<code>request</code>一同发送给Raft Server。</p>
<p>之后，Client就会监听这个channel，获取Server端发送回来了执行结果,Server接收并执行完之后，会使用传过去的发送端再将响应发送回来，Client等待从接收端获取消息，拿到Raft Server对request的执行结果向上返回。此时，创建的oneshot channel就可以销毁了。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// (1)
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">fn</span> read_table(&amp;self, table: <span style="color:#fff;font-weight:bold">&amp;</span><span style="color:#fff;font-weight:bold">str</span>) -&gt; <span style="color:#fff;font-weight:bold">Result</span>&lt;<span style="color:#fff;font-weight:bold">Option</span>&lt;Table&gt;&gt; {
</span></span><span style="display:flex;"><span>        self.client.query(Query::ReadTable { txn: self.state.clone(), table: table.to_string() })
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// (2)
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#0ff;font-weight:bold">/// Queries the Raft state machine, deserializing the response into the
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    <span style="color:#0ff;font-weight:bold">/// return type.
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    <span style="color:#fff;font-weight:bold">fn</span> query&lt;V: DeserializeOwned&gt;(&amp;self, query: Query) -&gt; <span style="color:#fff;font-weight:bold">Result</span>&lt;V&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">match</span> self.execute(raft::Request::Query(bincode::serialize(&amp;query)?))? {
</span></span><span style="display:flex;"><span>            raft::Response::Query(response) =&gt; <span style="color:#fff;font-weight:bold">Ok</span>(bincode::deserialize(&amp;response)?),
</span></span><span style="display:flex;"><span>            resp =&gt; <span style="color:#fff;font-weight:bold">Err</span>(Error::Internal(format!(<span style="color:#0ff;font-weight:bold">&#34;Unexpected Raft query response </span><span style="color:#0ff;font-weight:bold">{:?}</span><span style="color:#0ff;font-weight:bold">&#34;</span>, resp))),
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">// (3)
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	<span style="color:#fff;font-weight:bold">fn</span> execute(&amp;self, request: raft::Request) -&gt; <span style="color:#fff;font-weight:bold">Result</span>&lt;raft::Response&gt; {
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">let</span> (response_tx, response_rx) = oneshot::channel();
</span></span><span style="display:flex;"><span>	self.tx.send((request, response_tx))?;
</span></span><span style="display:flex;"><span>	futures::executor::block_on(response_rx)?
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Server端的接收逻辑就在server的<code>eventloop</code>当中，从<code>client_rx</code>(上面传来的<code>raft_rx</code>)接收到Client发送的<code>request</code>和<code>response_tx</code>。</p>
<p>请求需要先通过Raft完成共识，通过<code>step()</code>将Message交给Leader(通常是Leader，如果不是Leader也会转发给Leader，后面全部假设请求发送给了Leader)，之后Apply了才能够执行，这里先使用一个HashMap保存请求，等到Apply并执行完之后再从HashMap中获取出暂存的<code>response_rx</code>，响应Client。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>	<span style="color:#007f7f">// 获取client发送的消息，交给Raft模块去处理，这里的client并不是用户的client，而是要执行命令的sql端
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	<span style="color:#007f7f">// 暂存命令，等到日志Apply并执行完之后再响应客户端
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	<span style="color:#fff;font-weight:bold">Some</span>((request, response_tx)) = client_rx.next() =&gt; {
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">let</span> id = Uuid::new_v4().as_bytes().to_vec();
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">let</span> msg = Message{
</span></span><span style="display:flex;"><span>			from: Address::Client,
</span></span><span style="display:flex;"><span>			to: Address::Node(node.id()),
</span></span><span style="display:flex;"><span>			term: <span style="color:#ff0;font-weight:bold">0</span>,
</span></span><span style="display:flex;"><span>			event: Event::ClientRequest{id: id.clone(), request},
</span></span><span style="display:flex;"><span>		};
</span></span><span style="display:flex;"><span>		node = node.step(msg)?;
</span></span><span style="display:flex;"><span>		requests.insert(id, response_tx);
</span></span><span style="display:flex;"><span>	}
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Leader</strong></p>
<p>在toydb中，只读请求会通过ReadIndex来优化，因此不会创建日志。</p>
<p>调用了<code>step()</code>之后会再调用到<code>Leader.step()</code>，在这其中会完成对<code>Message::ClientRequest</code>的处理，这里的request类型为<code>request::Query</code>，因此Leader就会先向状态机发送一条<code>Instruction::Query</code>，让状态机先记录这一次只读请求，之后再发送一条<code>Instruction::Vote</code>，表示Leader对此次的只读请求投票，让状态机记录。</p>
<p>同时，Leader会发送一次heartbeat，请求其他节点也对其投票。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>	Event::ClientRequest { id, request: Request::Query(command) } =&gt; {
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">let</span> (commit_index, _) = self.log.get_commit_index();
</span></span><span style="display:flex;"><span>		self.state_tx.send(Instruction::Query {
</span></span><span style="display:flex;"><span>			id,
</span></span><span style="display:flex;"><span>			address: msg.from,
</span></span><span style="display:flex;"><span>			command,
</span></span><span style="display:flex;"><span>			term: self.term,
</span></span><span style="display:flex;"><span>			index: commit_index,
</span></span><span style="display:flex;"><span>			quorum: self.quorum(),
</span></span><span style="display:flex;"><span>		})?;
</span></span><span style="display:flex;"><span>		self.state_tx.send(Instruction::Vote {
</span></span><span style="display:flex;"><span>			term: self.term,
</span></span><span style="display:flex;"><span>			index: commit_index,
</span></span><span style="display:flex;"><span>			address: Address::Node(self.id),
</span></span><span style="display:flex;"><span>		})?;
</span></span><span style="display:flex;"><span>		self.heartbeat()?;
</span></span><span style="display:flex;"><span>	}
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Follower</strong></p>
<p>Follower在接收到了Leader发送的<code>Message::Heartbeat</code>之后，首先会根据Leader的进度和自身拥有的日志来更新commit进度，回应Leader一条<code>Message::ConfirmLeader</code>，表示接收到了Leader的心跳信息。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>	Event::Heartbeat { commit_index, commit_term } =&gt; {
</span></span><span style="display:flex;"><span>		<span style="color:#007f7f">// Check that the heartbeat is from our leader.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>		<span style="color:#fff;font-weight:bold">let</span> from = msg.from.unwrap();
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">match</span> self.role.leader {
</span></span><span style="display:flex;"><span>			<span style="color:#fff;font-weight:bold">Some</span>(leader) =&gt; assert_eq!(from, leader, <span style="color:#0ff;font-weight:bold">&#34;Multiple leaders in term&#34;</span>),
</span></span><span style="display:flex;"><span>			<span style="color:#fff;font-weight:bold">None</span> =&gt; self = self.become_follower(<span style="color:#fff;font-weight:bold">Some</span>(from), msg.term)?,
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#007f7f">// Advance commit index and apply entries if possible.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>		<span style="color:#fff;font-weight:bold">let</span> has_committed = self.log.has(commit_index, commit_term)?;
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">let</span> (old_commit_index, _) = self.log.get_commit_index();
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">if</span> has_committed &amp;&amp; commit_index &gt; old_commit_index {
</span></span><span style="display:flex;"><span>			self.log.commit(commit_index)?;
</span></span><span style="display:flex;"><span>			<span style="color:#fff;font-weight:bold">let</span> <span style="color:#fff;font-weight:bold">mut</span> scan = self.log.scan((old_commit_index + <span style="color:#ff0;font-weight:bold">1</span>)..=commit_index)?;
</span></span><span style="display:flex;"><span>			<span style="color:#fff;font-weight:bold">while</span> <span style="color:#fff;font-weight:bold">let</span> <span style="color:#fff;font-weight:bold">Some</span>(entry) = scan.next().transpose()? {
</span></span><span style="display:flex;"><span>				self.state_tx.send(Instruction::Apply { entry })?;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		self.send(msg.from, Event::ConfirmLeader { commit_index, has_committed })?;
</span></span><span style="display:flex;"><span>	}
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Leader</strong></p>
<p>Leader在接收到Follower响应的<code>Message::ConfirmLeader</code>之后，Leader再将Follower的commit进度封装成一条<code>Instruction::Vote</code>发送给状态机。此外，如果follower发现自身进度落后于Leader，此时Leader还会向Follower去发送Log，补齐进度。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>	<span style="color:#007f7f">// A follower received one of our heartbeats and confirms that we
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	<span style="color:#007f7f">// are its leader. If it doesn&#39;t have the commit index in its local
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	<span style="color:#007f7f">// log, replicate the log to it.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	Event::ConfirmLeader { commit_index, has_committed } =&gt; {
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">let</span> from = msg.from.unwrap();
</span></span><span style="display:flex;"><span>		<span style="color:#007f7f">// 与上层状态机进行交互
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>		self.state_tx.send(Instruction::Vote {
</span></span><span style="display:flex;"><span>			term: msg.term,
</span></span><span style="display:flex;"><span>			index: commit_index,
</span></span><span style="display:flex;"><span>			address: msg.from,
</span></span><span style="display:flex;"><span>		})?;
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">if</span> !has_committed {
</span></span><span style="display:flex;"><span>			self.send_log(from)?;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>状态机</strong></p>
<p>状态机是通过<code>Driver.drive()</code>来驱动的，在其中不断处理由下层Raft模块的发送而来的<code>Instruction</code>执行，状态机这一部分是和上一部分同时执行的。</p>
<p>对于上面发送而来的<code>Instruction::Query</code>，状态机会将其记录，而发送而来的<code>Instrcution::Vote</code>，会先调用<code>self.query_vote()</code>，然后调用<code>self.query_execute()</code></p>
<ul>
<li>在<code>self.query_vote()</code>中，简单记录投票</li>
<li>在<code>self.query_execute()</code>中,会遍历还未执行的，并且index &lt;= last_apply_index的所有请求，获取出当前的投票数，如果达到了quorum，就交给状态机的实现去执行，然后向Leader发送一条<code>Message::ClientResponse</code>，告知Leader状态机已经执行结束。</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>        <span style="color:#0ff;font-weight:bold">/// Votes for queries up to and including a given commit index for a term by an address.
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    <span style="color:#fff;font-weight:bold">fn</span> query_vote(&amp;<span style="color:#fff;font-weight:bold">mut</span> self, term: Term, commit_index: Index, address: Address) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> (_, queries) <span style="color:#fff;font-weight:bold">in</span> self.queries.range_mut(..=commit_index) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">for</span> (_, query) <span style="color:#fff;font-weight:bold">in</span> queries.iter_mut() {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span> term &gt;= query.term {
</span></span><span style="display:flex;"><span>                    query.votes.insert(address);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">/// Executes any queries that are ready.
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"></span>    <span style="color:#fff;font-weight:bold">fn</span> query_execute(&amp;<span style="color:#fff;font-weight:bold">mut</span> self, state: <span style="color:#fff;font-weight:bold">&amp;</span>mut <span style="color:#fff;font-weight:bold">dyn</span> State) -&gt; <span style="color:#fff;font-weight:bold">Result</span>&lt;()&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span> query <span style="color:#fff;font-weight:bold">in</span> self.query_ready(state.get_applied_index()) {
</span></span><span style="display:flex;"><span>            debug!(<span style="color:#0ff;font-weight:bold">&#34;Executing query {:?}&#34;</span>, query.command);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">let</span> result = state.query(query.command);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> <span style="color:#fff;font-weight:bold">let</span> <span style="color:#fff;font-weight:bold">Err</span>(error @ Error::Internal(_)) = result {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">Err</span>(error);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            self.send(
</span></span><span style="display:flex;"><span>                query.address,
</span></span><span style="display:flex;"><span>                Event::ClientResponse { id: query.id, response: result.map(Response::Query) },
</span></span><span style="display:flex;"><span>            )?
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">Ok</span>(())
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>单机存储</strong></p>
<p>在<code>state.query()</code>中，就会找到状态机的实现，而状态机的实现是一个MVCC的Wrapper,在query当中，根据请求类型进行分类，恢复当前事务的状态，然后会调用到</p>
<p><code>Transaction&lt;storage::engine::Engine&gt;.read_table()</code>,在这里，终于脱离了分布式的部分，转为单机执行了。构建一个table.name的key去存储引擎中查询：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>	<span style="color:#007f7f">// 状态机中的query
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	<span style="color:#fff;font-weight:bold">fn</span> query(&amp;self, command: <span style="color:#fff;font-weight:bold">Vec</span>&lt;<span style="color:#fff;font-weight:bold">u8</span>&gt;) -&gt; <span style="color:#fff;font-weight:bold">Result</span>&lt;<span style="color:#fff;font-weight:bold">Vec</span>&lt;<span style="color:#fff;font-weight:bold">u8</span>&gt;&gt; {
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">match</span> bincode::deserialize(&amp;command)? {
</span></span><span style="display:flex;"><span>		<span style="color:#007f7f">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>		Query::ReadTable { txn, table } =&gt; {
</span></span><span style="display:flex;"><span>			bincode::serialize(&amp;self.engine.resume(txn)?.read_table(&amp;table)?)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#007f7f">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// 单机存储引擎的读取操作
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">fn</span> read_table(&amp;self, table: <span style="color:#fff;font-weight:bold">&amp;</span><span style="color:#fff;font-weight:bold">str</span>) -&gt; <span style="color:#fff;font-weight:bold">Result</span>&lt;<span style="color:#fff;font-weight:bold">Option</span>&lt;Table&gt;&gt; {
</span></span><span style="display:flex;"><span>        self.txn.get(&amp;Key::Table(table.into()).encode()?)?.map(|v| deserialize(&amp;v)).transpose()
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></td></tr></table>
</div>
</div><p>再往下走就是MVCC了，MVCC又封装了storage trait(Bitcask或者Memory),MVCC调用了storage 的scan，对以user_key为前缀的key进行扫描，找到对当前事务能见的版本，从磁盘中读取到数据，完成了执行，剩下的就是返回结果了</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>    <span style="color:#007f7f">// MVCC
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">pub</span> <span style="color:#fff;font-weight:bold">fn</span> get(&amp;self, key: <span style="color:#fff;font-weight:bold">&amp;</span>[<span style="color:#fff;font-weight:bold">u8</span>]) -&gt; <span style="color:#fff;font-weight:bold">Result</span>&lt;<span style="color:#fff;font-weight:bold">Option</span>&lt;<span style="color:#fff;font-weight:bold">Vec</span>&lt;<span style="color:#fff;font-weight:bold">u8</span>&gt;&gt;&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">let</span> <span style="color:#fff;font-weight:bold">mut</span> session = self.engine.lock()?;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">let</span> from = Key::Version(key.into(), <span style="color:#ff0;font-weight:bold">0</span>).encode()?;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">let</span> to = Key::Version(key.into(), self.st.version).encode()?;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">let</span> <span style="color:#fff;font-weight:bold">mut</span> scan = session.scan(from..=to).rev();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">while</span> <span style="color:#fff;font-weight:bold">let</span> <span style="color:#fff;font-weight:bold">Some</span>((key, value)) = scan.next().transpose()? {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">match</span> Key::decode(&amp;key)? {
</span></span><span style="display:flex;"><span>                Key::Version(_, version) =&gt; {
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">if</span> self.st.is_visible(version) {
</span></span><span style="display:flex;"><span>                        <span style="color:#fff;font-weight:bold">return</span> bincode::deserialize(&amp;value);
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                key =&gt; <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">Err</span>(Error::Internal(format!(<span style="color:#0ff;font-weight:bold">&#34;Expected Key::Version got </span><span style="color:#0ff;font-weight:bold">{:?}</span><span style="color:#0ff;font-weight:bold">&#34;</span>, key))),
</span></span><span style="display:flex;"><span>            };
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">Ok</span>(<span style="color:#fff;font-weight:bold">None</span>)
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Leader回应</strong></p>
<p>当单机存储执行完，并且状态机也向Leader发送了<code>Message::ClientResponse</code>之后，Leader就会将<code>Message::ClientResponse</code>通过接收请求时一同接受的oneshot channel的发送端，响应给Client，Client接收到响应，完成执行，继续Executor的执行。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>	Event::ClientResponse { id, <span style="color:#fff;font-weight:bold">mut</span> response } =&gt; {
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">if</span> <span style="color:#fff;font-weight:bold">let</span> <span style="color:#fff;font-weight:bold">Ok</span>(Response::Status(<span style="color:#fff;font-weight:bold">ref</span> <span style="color:#fff;font-weight:bold">mut</span> status)) = response {
</span></span><span style="display:flex;"><span>			status.server = self.id;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		self.send(Address::Client, Event::ClientResponse { id, response })?;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">Some</span>(msg) = node_rx.next() =&gt; {
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">match</span> msg {
</span></span><span style="display:flex;"><span>			Message{to: Address::Node(_), ..} =&gt; tcp_tx.send(msg)?,
</span></span><span style="display:flex;"><span>			Message{to: Address::Broadcast, ..} =&gt; tcp_tx.send(msg)?,
</span></span><span style="display:flex;"><span>			<span style="color:#007f7f">// 响应Raft Client
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>			Message{to: Address::Client, event: Event::ClientResponse{ id, response }, ..} =&gt; {
</span></span><span style="display:flex;"><span>				<span style="color:#fff;font-weight:bold">if</span> <span style="color:#fff;font-weight:bold">let</span> <span style="color:#fff;font-weight:bold">Some</span>(response_tx) = requests.remove(&amp;id) {
</span></span><span style="display:flex;"><span>					response_tx
</span></span><span style="display:flex;"><span>						.send(response)
</span></span><span style="display:flex;"><span>						.map_err(|e| Error::Internal(format!(<span style="color:#0ff;font-weight:bold">&#34;Failed to send response </span><span style="color:#0ff;font-weight:bold">{:?}</span><span style="color:#0ff;font-weight:bold">&#34;</span>, e)))?;
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			_ =&gt; <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">Err</span>(Error::Internal(format!(<span style="color:#0ff;font-weight:bold">&#34;Unexpected message </span><span style="color:#0ff;font-weight:bold">{:?}</span><span style="color:#0ff;font-weight:bold">&#34;</span>, msg))),
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="write">Write<a hidden class="anchor" aria-hidden="true" href="#write">#</a></h4>
<p>再后面，会调用<code>txn.create</code>发送写请求，大致逻辑和流程都是一样的，只不过由于是写请求，需要通过日志来进行共识(读请求的ReadIndex优化可以不创建日志)，在Raft行为和与状态机上的交互会略有不同，但是整体上是一致的，这里只简单写一下不同的部分，读者可以按照这个流程，去自行分析。</p>
<p><strong>Leader</strong></p>
<p>在<code>Leader.step()</code>中，如果是<code>Request::Mutate</code>类型的请求，就会调用<code>propose()</code>来创建日志并向Follower去发送日志。并且向状态机中发送一条<code>Instruction::Notify</code>类型的信息，用于记录一次写请求的开始：</p>
<p><strong>Follower</strong></p>
<p>Follower接收到的为<code>Message::AppendEntries</code>，Follower会根据自身的情况，决定是拒绝还是将日志追加到自身，同时响应Leader。</p>
<p><strong>Leader</strong></p>
<p>Leader接收到Follower响应的<code>Message::AcceptEntries</code>时，就会计算是否有日志在大多数节点上达到了大多数，尝试进行commit与apply，如果达到了大多数就会更新commit_index，并且向状态机发送commit了的log entry。</p>
<p><strong>状态机</strong></p>
<p>状态机拿到了commit了的log entry，首先会通过状态机的实现(KV Engine)去执行该条日志，日志被执行会导致last_applied_index被更新，从而一些读请求也有可能达到执行的条件，因此调用<code>self.query_execute()</code>来执行读请求。</p>
<p>最后移除请求记录，通知Leader已经执行完成。</p>
<p><strong>Leader</strong></p>
<p>Leader将由状态机发送而来的<code>ClientResponse</code>经过几次channel通信，转发给Client。回到Executor中继续执行。</p>
<h2 id="后记">后记<a hidden class="anchor" aria-hidden="true" href="#后记">#</a></h2>
<p>至此，toydb的源码分析已经全部结束。起初开这个系列的主要原因是自己想尝试使用Rust作为毕业设计的技术栈，用来恶补一下自己的Rust。就目前而言感觉是可以用Rust写下来的，不至于中途逃跑到c++去。</p>
<p>toydb代码规模很小，并且结构很完善，可以作为一个很好的分布式数据库的学习项目，较为直观的展示了如何将SQL、分布式、存储引擎相结合，以及如何使用kv存储引擎来构建关系模型，这也是像Bustub，Miniob没有能够做到的(二者均是heap file)。</p>
<p>toydb作为一个学习项目，性能不是很好，后续如果有时间的话，可能考虑再补一期toydb的性能分析的文章，如果懒或者没时间的话就摸了。</p>
<p>后续一段时间内估计应该是不会再更新这种源码阅读类型的文章了，大概会发一些看过的paper。如果后面毕设写的比较有意思的话，也会考虑把毕设给分享出来。</p>
<p>最后，希望该系列文章能够对想学习Rust和入门分布式数据库的读者有所帮助，笔者水平有限，如果出现错误，也希望读者能够进行批评指正。</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="http://itfischer.space/en/posts/tech/toydb/05-sql-engine/">
    <span class="title">« Prev</span>
    <br>
    <span>05-SQL Engine</span>
  </a>
  <a class="next" href="http://itfischer.space/en/posts/tech/%E6%89%80%E6%9C%89%E6%9D%83%E4%B8%8E%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/">
    <span class="title">Next »</span>
    <br>
    <span>Rust内存管理</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 06-SQL Execution on x"
            href="https://x.com/intent/tweet/?text=06-SQL%20Execution&amp;url=http%3a%2f%2fitfischer.space%2fen%2fposts%2ftech%2ftoydb%2f06-sql-execution%2f&amp;hashtags=">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 06-SQL Execution on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http%3a%2f%2fitfischer.space%2fen%2fposts%2ftech%2ftoydb%2f06-sql-execution%2f&amp;title=06-SQL%20Execution&amp;summary=06-SQL%20Execution&amp;source=http%3a%2f%2fitfischer.space%2fen%2fposts%2ftech%2ftoydb%2f06-sql-execution%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 06-SQL Execution on reddit"
            href="https://reddit.com/submit?url=http%3a%2f%2fitfischer.space%2fen%2fposts%2ftech%2ftoydb%2f06-sql-execution%2f&title=06-SQL%20Execution">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 06-SQL Execution on facebook"
            href="https://facebook.com/sharer/sharer.php?u=http%3a%2f%2fitfischer.space%2fen%2fposts%2ftech%2ftoydb%2f06-sql-execution%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 06-SQL Execution on whatsapp"
            href="https://api.whatsapp.com/send?text=06-SQL%20Execution%20-%20http%3a%2f%2fitfischer.space%2fen%2fposts%2ftech%2ftoydb%2f06-sql-execution%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 06-SQL Execution on telegram"
            href="https://telegram.me/share/url?text=06-SQL%20Execution&amp;url=http%3a%2f%2fitfischer.space%2fen%2fposts%2ftech%2ftoydb%2f06-sql-execution%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share 06-SQL Execution on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=06-SQL%20Execution&u=http%3a%2f%2fitfischer.space%2fen%2fposts%2ftech%2ftoydb%2f06-sql-execution%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2024 <a href="http://itfischer.space/en/">Fischer&#39;s Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
